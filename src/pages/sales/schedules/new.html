@layout('layouts.base')
@json('data/meta/sales_schedules_new_title.json', $title)
@json('data/meta/sales_schedules_new_body_class.json', $body_class)
@json('data/clients.json', clients_data)
@json('data/service_items.json', service_items_data)

<!-- AWS Services API -->
<script src="/js/aws-services-api.js"></script>

<main id="main" class="container sales-schedules-new">
  <div class="page-header">
    <a href="/sales/schedule.html" class="back-btn">
      <i class="fas fa-chevron-left"></i>
    </a>
    <h1 class="page-title">スケジュール作成</h1>
  </div>

  <form id="schedule-form" class="schedule-form">
    <!-- 基本情報 -->
    <div class="form-section">
      <h2 class="section-title">
        <i class="fas fa-calendar-alt"></i>
        基本情報
      </h2>
      <div class="form-grid">
        <div class="form-group">
          <label class="form-label">日付 <span class="required">必須</span></label>
          <input type="date" class="form-input" name="date" id="schedule-date" required />
          <p class="form-hint">清掃予定日を選択してください</p>
        </div>
        <div class="form-group">
          <label class="form-label">時間帯 <span class="required">必須</span></label>
          <div class="time-slot-inputs">
            <input type="time" class="form-input" name="start_time" id="start-time" required />
            <span class="time-separator">〜</span>
            <input type="time" class="form-input" name="end_time" id="end-time" required />
          </div>
          <p class="form-hint">作業開始時刻と終了時刻を入力してください</p>
        </div>
        <div class="form-group full-width">
          <label class="form-label">案件タイプ <span class="required">必須</span></label>
          <select class="form-select" name="order_type" id="order-type" required>
            <option value="">選択してください</option>
            <option value="regular">定期清掃</option>
            <option value="spot">スポット清掃</option>
            <option value="emergency">緊急対応</option>
          </select>
          <p class="form-hint">案件の種類を選択してください</p>
        </div>
      </div>
    </div>

    <!-- 顧客・店舗情報 -->
    <div class="form-section">
      <h2 class="section-title">
        <i class="fas fa-building"></i>
        顧客・店舗情報
      </h2>
      <div class="form-grid">
        <div class="form-group full-width">
          <label class="form-label">顧客・店舗 <span class="required">必須</span></label>
          <select class="form-select" name="client_id" id="client-select" required>
            <option value="">顧客・店舗を選択</option>
          </select>
          <p class="form-hint">既存の顧客・店舗から選択してください</p>
        </div>
        <div class="form-group full-width" id="client-info-display" style="display: none;">
          <div class="client-info-card">
            <div class="client-info-item">
              <span class="client-info-label">会社名:</span>
              <span class="client-info-value" id="display-company-name">-</span>
            </div>
            <div class="client-info-item">
              <span class="client-info-label">ブランド名:</span>
              <span class="client-info-value" id="display-brand-name">-</span>
            </div>
            <div class="client-info-item">
              <span class="client-info-label">店舗名:</span>
              <span class="client-info-value" id="display-store-name">-</span>
            </div>
            <div class="client-info-item">
              <span class="client-info-label">担当者:</span>
              <span class="client-info-value" id="display-contact-person">-</span>
            </div>
            <div class="client-info-item">
              <span class="client-info-label">メール:</span>
              <span class="client-info-value" id="display-email">-</span>
            </div>
          </div>
        </div>
        <input type="hidden" name="client_name" id="client-name">
        <input type="hidden" name="store_name" id="store-name">
        <input type="hidden" name="address" id="address">
        <input type="hidden" name="phone" id="phone">
        <input type="hidden" name="email" id="email">
      </div>
    </div>

    <!-- 作業内容・見積もり -->
    <div class="form-section">
      <div class="section-header">
        <h2 class="section-title">
          <i class="fas fa-tasks"></i>
          作業内容・見積もり
        </h2>
        <button type="button" class="btn btn-outline btn-sm" id="add-cleaning-item">
          <i class="fas fa-plus"></i>
          項目を追加
        </button>
      </div>
      <div id="cleaning-items-container">
        <!-- 作業項目が動的に追加される -->
      </div>
      
      <!-- 見積もり合計表示 -->
      <div class="estimate-summary" id="estimate-summary" style="display: none;">
        <div class="estimate-summary-header">
          <h3 class="estimate-summary-title">
            <i class="fas fa-calculator"></i>
            見積もり合計
          </h3>
        </div>
        <div class="estimate-summary-content">
          <div class="estimate-total-row">
            <span class="estimate-total-label">合計金額</span>
            <span class="estimate-total-value" id="estimate-total-display">¥0</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 見積もりメモ -->
    <div class="form-section">
      <h2 class="section-title">
        <i class="fas fa-file-invoice-dollar"></i>
        見積もりメモ
      </h2>
      <div class="form-grid">
        <div class="form-group full-width">
          <label class="form-label">見積もりに関する補足事項</label>
          <textarea class="form-textarea" name="estimate_notes" id="estimate-notes" rows="3" placeholder="見積もりに関する補足事項があれば入力してください"></textarea>
          <p class="form-hint">価格やサービス内容に関する特記事項があれば入力してください</p>
        </div>
      </div>
    </div>

    <!-- 備考 -->
    <div class="form-section">
      <h2 class="section-title">
        <i class="fas fa-sticky-note"></i>
        備考
      </h2>
      <div class="form-grid">
        <div class="form-group full-width">
          <label class="form-label">備考・特記事項</label>
          <textarea class="form-textarea" name="notes" rows="4" placeholder="スケジュールに関する備考や特記事項を入力してください"></textarea>
          <p class="form-hint">管理者や清掃員への伝達事項があれば入力してください</p>
        </div>
      </div>
    </div>

    <!-- フォームアクション -->
    <div class="form-actions">
      <button type="button" class="btn btn-outline" onclick="window.location.href='/sales/schedule.html'">
        <i class="fas fa-times"></i>
        キャンセル
      </button>
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-save"></i>
        スケジュールを作成
      </button>
    </div>
  </form>

  <style>
    .sales-schedules-new {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px;
      background: #f9fafb;
      min-height: 100vh;
    }
    .page-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #374151;
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover {
      background: #f9fafb;
      border-color: var(--primary);
      color: var(--primary);
    }
    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    .schedule-form {
      background: #ffffff;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .form-section {
      margin-bottom: 32px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 24px 0;
    }
    .section-title i {
      color: var(--primary);
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    .form-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
    }
    .required {
      color: #ef4444;
      font-size: 0.75rem;
      margin-left: 4px;
    }
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: all 0.2s;
      font-family: inherit;
      box-sizing: border-box;
    }
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 103, 156, 0.1);
    }
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    .form-hint {
      font-size: 0.75rem;
      color: #6b7280;
      margin: 0;
    }
    .time-slot-inputs {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .time-slot-inputs .form-input {
      flex: 1;
    }
    .time-separator {
      color: #6b7280;
      font-weight: 600;
    }
    .client-info-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .client-info-item {
      display: flex;
      gap: 12px;
    }
    .client-info-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #6b7280;
      min-width: 80px;
    }
    .client-info-value {
      font-size: 0.875rem;
      color: #111827;
    }
    .cleaning-item {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .cleaning-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .cleaning-item-title {
      font-size: 0.95rem;
      font-weight: 600;
      color: #111827;
    }
    .cleaning-item-remove {
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .cleaning-item-remove:hover {
      background: #dc2626;
    }
    .cleaning-item-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .cleaning-item-detail {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .cleaning-item-detail label {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .cleaning-item-detail input,
    .cleaning-item-detail textarea {
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .cleaning-item-detail textarea {
      resize: vertical;
      min-height: 60px;
    }
    .cleaning-item-detail.full-width {
      grid-column: 1 / -1;
    }
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 32px;
      padding-top: 32px;
      border-top: 1px solid #f3f4f6;
    }
    .form-actions .btn {
      min-width: 140px;
    }
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background: var(--primary, #FF6BA6);
      color: #ffffff;
    }
    .btn-primary:hover {
      background: var(--primary-dark, #FF5A9A);
    }
    .btn-outline {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    .btn-outline:hover {
      background: #f9fafb;
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.875rem;
    }
    /* 見積もり合計表示 */
    .estimate-summary {
      margin-top: 24px;
      padding: 20px;
      background: #f9fafb;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }
    .estimate-summary-header {
      margin-bottom: 16px;
    }
    .estimate-summary-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }
    .estimate-summary-title i {
      color: var(--primary, #FF6BA6);
    }
    .estimate-summary-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .estimate-total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      background: #ffffff;
      border-radius: 8px;
      border: 2px solid var(--primary, #FF6BA6);
    }
    .estimate-total-label {
      font-size: 1rem;
      font-weight: 600;
      color: #374151;
    }
    .estimate-total-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary, #FF6BA6);
    }
    /* 作業項目の価格入力フィールド */
    .service-price-input,
    .service-quantity-input,
    .service-subtotal-input {
      text-align: right;
    }
    .service-subtotal-input {
      font-weight: 600;
      color: var(--primary, #FF6BA6);
    }
    @media (max-width: 768px) {
      .sales-schedules-new {
        padding: 16px;
      }
      .schedule-form {
        padding: 24px;
      }
      .form-grid {
        grid-template-columns: 1fr;
      }
      .time-slot-inputs {
        flex-direction: column;
      }
      .time-separator {
        display: none;
      }
      .cleaning-item-details {
        grid-template-columns: 1fr;
      }
      .form-actions {
        flex-direction: column-reverse;
      }
      .form-actions .btn {
        width: 100%;
      }
    }
  </style>

  <script>
    (function() {
      // グローバル変数
      let clients = [];       // 営業画面で使う「顧客・店舗」リスト
      let serviceItems = [];  // サービスマスタ
      let cleaningItems = []; // 画面上の作業項目

      // 管理画面と共通のAPIエンドポイント
      const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';

      // サービスマスタの読み込み
      // AWS APIからサービス一覧を取得し、失敗した場合はローカルの service_items_data をフォールバックとして使用
      async function loadServicesFromApi() {
        // まずローカルの service_items_data をデフォルトとしてセット（フォールバック用）
        let fallbackServices = [];
        if (typeof service_items_data !== 'undefined' && Array.isArray(service_items_data)) {
          fallbackServices = service_items_data;
        }

        try {
          // AWSServicesAPI が読み込まれるまで待機（最大3秒）
          let retries = 30;
          while (!window.AWSServicesAPI && retries > 0) {
            await new Promise(resolve => setTimeout(resolve, 100));
            retries--;
          }

          if (!window.AWSServicesAPI || !window.AWSServicesAPI.loadServices) {
            throw new Error('AWSServicesAPI が利用できません。ローカルデータを使用します。');
          }

          console.log('[sales/schedules/new] Loading services from AWS API...');
          const data = await window.AWSServicesAPI.loadServices();
          
          // APIの戻り値が配列または { items: [] } のどちらでも対応
          if (Array.isArray(data) && data.length > 0) {
            serviceItems = data;
            console.log(`[sales/schedules/new] Loaded ${serviceItems.length} services from AWS API`);
          } else if (data && Array.isArray(data.items) && data.items.length > 0) {
            serviceItems = data.items;
            console.log(`[sales/schedules/new] Loaded ${serviceItems.length} services from AWS API (nested format)`);
          } else {
            // APIから空の配列が返された場合は、フォールバックを使用
            console.warn('[sales/schedules/new] AWS API returned empty data, using fallback');
            serviceItems = fallbackServices;
          }
        } catch (error) {
          console.warn('[sales/schedules/new] Failed to load services from AWS API, using local fallback:', error);
          serviceItems = fallbackServices;
        }

        // 最終的に serviceItems が空の場合は警告
        if (serviceItems.length === 0) {
          console.error('[sales/schedules/new] No services available (neither from API nor local data)');
        } else {
          console.log(`[sales/schedules/new] Using ${serviceItems.length} services (${serviceItems.length === fallbackServices.length ? 'local fallback' : 'AWS API'})`);
        }
      }

      // 顧客・店舗データは、可能であればバックエンドAPIから取得し、
      // 失敗した場合のみ既存の clients_data（スタブ）をフォールバックとして使用する
      async function loadClientsFromApi() {
        try {
          const [storesRes, rawClientsRes, rawBrandsRes] = await Promise.all([
            fetch(`${API_BASE}/stores`),
            fetch(`${API_BASE}/clients`).catch(() => ({ ok: false })),
            fetch(`${API_BASE}/brands`).catch(() => ({ ok: false }))
          ]);

          const stores = await storesRes.json();
          const allClients = rawClientsRes && rawClientsRes.ok ? await rawClientsRes.json() : [];
          const allBrands  = rawBrandsRes && rawBrandsRes.ok ? await rawBrandsRes.json() : [];

          function getClientName(clientId) {
            const c = allClients.find(x => x.id === clientId);
            return c ? c.name : '';
          }

          function getBrandName(brandId) {
            const b = allBrands.find(x => x.id === brandId);
            return b ? b.name : '';
          }

          // stores から営業画面用の clients 配列を組み立てる
          clients = stores.map(store => ({
            id: store.id,
            company_name: getClientName(store.client_id) || store.group_id || store.name || '',
            brand_name: getBrandName(store.brand_id) || '',
            store_name: store.name || '',
            contact_person: store.contact_person || '',
            email: store.email || store.report_email || '',
          }));
        } catch (error) {
          console.warn('[sales/schedules/new] Failed to load clients from API, using local clients_data if available:', error);
          if (typeof clients_data !== 'undefined' && clients_data.clients) {
            clients = clients_data.clients;
          } else {
            clients = [];
          }
        }
      }

      // 顧客選択ドロップダウンを初期化
      function initClientSelect() {
        const select = document.getElementById('client-select');
        if (!select) return;

        // 顧客リストを追加
        clients.forEach(client => {
          const option = document.createElement('option');
          option.value = client.id;
          option.textContent = `${client.company_name} - ${client.store_name}`;
          if (client.brand_name) {
            option.textContent = `${client.company_name} (${client.brand_name}) - ${client.store_name}`;
          }
          option.dataset.client = JSON.stringify(client);
          select.appendChild(option);
        });

        // 顧客選択時の処理
        select.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          if (selectedOption.value) {
            const client = JSON.parse(selectedOption.dataset.client);
            displayClientInfo(client);
          } else {
            hideClientInfo();
          }
        });
      }

      // 顧客情報を表示
      function displayClientInfo(client) {
        document.getElementById('display-company-name').textContent = client.company_name || '-';
        document.getElementById('display-brand-name').textContent = client.brand_name || '-';
        document.getElementById('display-store-name').textContent = client.store_name || '-';
        document.getElementById('display-contact-person').textContent = client.contact_person || '-';
        document.getElementById('display-email').textContent = client.email || '-';

        // 隠しフィールドに値を設定
        document.getElementById('client-name').value = client.company_name || '';
        document.getElementById('store-name').value = client.store_name || '';
        document.getElementById('email').value = client.email || '';
        // 住所と電話番号はclients.jsonにないため、空文字列
        document.getElementById('address').value = '';
        document.getElementById('phone').value = '';

        document.getElementById('client-info-display').style.display = 'block';
      }

      // 顧客情報を非表示
      function hideClientInfo() {
        document.getElementById('client-info-display').style.display = 'none';
      }

      // 作業項目を追加
      function addCleaningItem(serviceItem = null) {
        const container = document.getElementById('cleaning-items-container');
        if (!container) return;

        const itemId = `item-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        const item = document.createElement('div');
        item.className = 'cleaning-item';
        item.dataset.itemId = itemId;

        // サービスオプションを生成
        let serviceOptions = '';
        if (serviceItems && serviceItems.length > 0) {
          serviceOptions = serviceItems.map(service => {
            const title = service.title || service.name || '';
            const category = service.category || '';
            const selected = serviceItem && serviceItem.name === title ? 'selected' : '';
            return `<option value="${title}" ${selected}>${title}${category ? ` (${category})` : ''}</option>`;
          }).join('');
        } else {
          // サービスが読み込まれていない場合の警告
          serviceOptions = '<option value="" disabled>サービスを読み込み中...</option>';
          console.warn('[sales/schedules/new] serviceItems is empty when adding cleaning item');
        }

        item.innerHTML = `
          <div class="cleaning-item-header">
            <span class="cleaning-item-title">作業項目 ${cleaningItems.length + 1}</span>
            <button type="button" class="cleaning-item-remove" onclick="removeCleaningItem('${itemId}')">
              <i class="fas fa-times"></i> 削除
            </button>
          </div>
          <div class="cleaning-item-details">
            <div class="cleaning-item-detail full-width">
              <label>作業内容 <span class="required">必須</span></label>
              <select class="form-select service-select" name="cleaning_items[${cleaningItems.length}][name]" data-service-price="0" required>
                <option value="">作業内容を選択</option>
                ${serviceOptions}
                <option value="その他">その他（自由入力）</option>
              </select>
            </div>
            <div class="cleaning-item-detail">
              <label>単価</label>
              <input type="number" class="form-input service-price-input" name="cleaning_items[${cleaningItems.length}][base_price]" min="0" step="1" value="0" placeholder="¥0" readonly>
            </div>
            <div class="cleaning-item-detail">
              <label>数量</label>
              <input type="number" class="form-input service-quantity-input" name="cleaning_items[${cleaningItems.length}][quantity]" min="1" step="1" value="1" placeholder="例: 1">
            </div>
            <div class="cleaning-item-detail">
              <label>小計</label>
              <input type="number" class="form-input service-subtotal-input" name="cleaning_items[${cleaningItems.length}][price]" min="0" step="1" value="0" placeholder="¥0" readonly>
            </div>
            <div class="cleaning-item-detail full-width">
              <label>備考・特記事項</label>
              <textarea name="cleaning_items[${cleaningItems.length}][notes]" placeholder="例: 分解洗浄あり、床置き型など">${serviceItem && serviceItem.notes ? serviceItem.notes.join('\n') : ''}</textarea>
            </div>
            <div class="cleaning-item-detail">
              <label>単位</label>
              <input type="text" name="cleaning_items[${cleaningItems.length}][unit]" value="${serviceItem && serviceItem.unit ? serviceItem.unit : ''}" placeholder="例: 個、台">
            </div>
          </div>
        `;

        container.appendChild(item);
        cleaningItems.push({ id: itemId });

        // サービス選択時の処理（価格を設定）
        const serviceSelect = item.querySelector('.service-select');
        const priceInput = item.querySelector('.service-price-input');
        const quantityInput = item.querySelector('.service-quantity-input');
        const subtotalInput = item.querySelector('.service-subtotal-input');

        serviceSelect.addEventListener('change', function() {
          if (this.value === 'その他') {
            // 自由入力フィールドに変更
            const customInput = document.createElement('input');
            customInput.type = 'text';
            customInput.className = 'form-input';
            customInput.name = this.name;
            customInput.placeholder = '作業内容を入力';
            customInput.required = true;
            this.parentNode.replaceChild(customInput, this);
            // 価格は手動入力可能にする
            priceInput.readOnly = false;
            priceInput.value = '';
            updateItemSubtotal(item);
          } else {
            // サービスを選択した場合、価格を設定
            const selectedService = serviceItems.find(s => (s.title || s.name) === this.value);
            if (selectedService) {
              const price = selectedService.price || 0;
              priceInput.value = price;
              this.dataset.servicePrice = price;
              updateItemSubtotal(item);
            }
          }
          updateEstimateTotal();
        });

        // 数量変更時の処理
        if (quantityInput) {
          quantityInput.addEventListener('input', function() {
            updateItemSubtotal(item);
            updateEstimateTotal();
          });
        }

        // 価格変更時の処理（手動入力の場合）
        if (priceInput) {
          priceInput.addEventListener('input', function() {
            updateItemSubtotal(item);
            updateEstimateTotal();
          });
        }
      }

      // 項目の小計を更新
      function updateItemSubtotal(item) {
        const priceInput = item.querySelector('.service-price-input');
        const quantityInput = item.querySelector('.service-quantity-input');
        const subtotalInput = item.querySelector('.service-subtotal-input');
        
        if (priceInput && quantityInput && subtotalInput) {
          const price = parseFloat(priceInput.value) || 0;
          const quantity = parseFloat(quantityInput.value) || 1;
          const subtotal = Math.round(price * quantity);
          subtotalInput.value = subtotal;
        }
      }

      // 見積もり合計を更新
      function updateEstimateTotal() {
        const summary = document.getElementById('estimate-summary');
        const totalDisplay = document.getElementById('estimate-total-display');
        
        if (!summary || !totalDisplay) return;

        let total = 0;
        const itemElements = document.querySelectorAll('.cleaning-item');
        itemElements.forEach(item => {
          const subtotalInput = item.querySelector('.service-subtotal-input');
          if (subtotalInput) {
            total += parseFloat(subtotalInput.value) || 0;
          }
        });

        totalDisplay.textContent = `¥${total.toLocaleString()}`;
        
        // 合計が0より大きい場合のみ表示
        if (total > 0) {
          summary.style.display = 'block';
        } else {
          summary.style.display = 'none';
        }
      }

      // 作業項目を削除
      window.removeCleaningItem = function(itemId) {
        const item = document.querySelector(`[data-item-id="${itemId}"]`);
        if (item) {
          item.remove();
          cleaningItems = cleaningItems.filter(item => item.id !== itemId);
        }
      };

      // フォーム送信
      const form = document.getElementById('schedule-form');
      if (form) {
        // 管理画面と同じAPIエンドポイント
        const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';

        form.addEventListener('submit', async function(e) {
          e.preventDefault();

          const formData = new FormData(form);
          
          // 時間帯を結合
          const startTime = formData.get('start_time');
          const endTime = formData.get('end_time');
          const timeSlot = `${startTime}-${endTime}`;

          // 作業項目を取得
          const cleaningItemsData = [];
          const estimateItems = [];
          let estimateTotal = 0;
          
          const itemElements = document.querySelectorAll('.cleaning-item');
          itemElements.forEach((item, index) => {
            const nameInput = item.querySelector('[name*="[name]"]');
            const notesTextarea = item.querySelector('[name*="[notes]"]');
            const quantityInput = item.querySelector('[name*="[quantity]"]');
            const unitInput = item.querySelector('[name*="[unit]"]');
            const priceInput = item.querySelector('.service-price-input');
            const subtotalInput = item.querySelector('.service-subtotal-input');

            if (nameInput && nameInput.value) {
              const basePrice = parseFloat(priceInput?.value) || 0;
              const quantity = parseFloat(quantityInput?.value) || 1;
              const price = parseFloat(subtotalInput?.value) || (basePrice * quantity);
              
              const itemData = {
                name: nameInput.value,
                notes: notesTextarea && notesTextarea.value ? notesTextarea.value.split('\n').filter(n => n.trim()) : [],
                quantity: quantityInput && quantityInput.value ? parseInt(quantityInput.value) : null,
                unit: unitInput && unitInput.value ? unitInput.value : null
              };
              cleaningItemsData.push(itemData);

              // 見積もり用のアイテムデータ
              if (price > 0) {
                estimateItems.push({
                  id: `service-${index}`,
                  name: nameInput.value,
                  base_price: basePrice,
                  multiplier: quantity,
                  price: Math.round(price)
                });
                estimateTotal += Math.round(price);
              }
            }
          });

          // スケジュールデータを作成
          const scheduleData = {
            date: formData.get('date'),
            time_slot: timeSlot,
            order_type: formData.get('order_type'),
            client_id: formData.get('client_id') || null,
            client_name: formData.get('client_name') || '',
            store_name: formData.get('store_name') || '',
            address: formData.get('address') || '',
            phone: formData.get('phone') || '',
            email: formData.get('email') || '',
            cleaning_items: cleaningItemsData,
            notes: formData.get('notes') || '',
            // ステータス: 仮押さえ（管理画面側では draft を仮押さえとして扱う）
            status: 'draft',
            created_by: 'sales'
          };

          // 見積もり情報が存在する場合は追加
          if (estimateItems.length > 0) {
            scheduleData.estimate = {
              items: estimateItems,
              total: estimateTotal,
              notes: formData.get('estimate_notes') || ''
            };
          }

          console.log('Schedule data (to POST):', scheduleData);

          try {
            const response = await fetch(`${API_BASE}/schedules`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(scheduleData)
            });

            if (!response.ok) {
              const text = await response.text().catch(() => '');
              console.error('Failed to create schedule:', response.status, text);
              alert('スケジュールの作成に失敗しました。\n時間をおいて再度お試しください。');
              return;
            }

            alert('スケジュール（仮押さえ）を作成しました。');
            // スケジュール一覧にリダイレクト
            window.location.href = '/sales/schedule.html';
          } catch (error) {
            console.error('Error while creating schedule:', error);
            alert('スケジュールの作成中にエラーが発生しました。');
          }
        });
      }

      // 初期化
      (async function initPage() {
        // 顧客・店舗データをAPI（またはローカルJSON）から読み込み
        await loadClientsFromApi();
        initClientSelect();

        // サービスマスタをAPI（またはローカルJSON）から読み込み
        await loadServicesFromApi();

        // 最初の作業項目を追加（serviceItems を使ってプルダウンを生成）
        addCleaningItem();

        // 「項目を追加」ボタン
        const addButton = document.getElementById('add-cleaning-item');
        if (addButton) {
          addButton.addEventListener('click', function() {
            addCleaningItem();
          });
        }

        // 今日の日付をデフォルトに設定
        const dateInput = document.getElementById('schedule-date');
        if (dateInput) {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          dateInput.value = `${year}-${month}-${day}`;
        }
      })();
    })();
  </script>
</main>










