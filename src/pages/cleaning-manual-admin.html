<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸…æƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç®¡ç†ç”»é¢ - MISESAPO</title>
    <script>
        // baseã‚¿ã‚°ã¯ä½¿ç”¨ã—ãªã„ï¼ˆã™ã¹ã¦ã®ãƒ‘ã‚¹ã‚’çµ¶å¯¾URLã§è§£æ±ºã™ã‚‹ï¼‰
        // baseã‚¿ã‚°ãŒã‚ã‚‹ã¨ã€çµ¶å¯¾URLã‚‚ç›¸å¯¾ãƒ‘ã‚¹ã¨ã—ã¦è§£é‡ˆã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚
    </script>
    <link rel="stylesheet" href="https://unpkg.com/ress@4.0.0/dist/ress.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- AWS API -->
    <script src="/js/aws-s3-upload.js"></script>
    <script src="/js/aws-cleaning-manual-api.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        body {
            font-family: 'Noto Sans JP', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .page-header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .page-header h1 {
            margin: 0;
            color: #ff008c;
            font-size: 24px;
        }
        .page-header .back-link {
            display: inline-block;
            margin-bottom: 10px;
            color: #666;
            text-decoration: none;
        }
        .page-header .back-link:hover {
            color: #ff008c;
        }
        .category-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .category-tabs::-webkit-scrollbar {
            height: 4px;
        }
        .category-tabs::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .category-tabs::-webkit-scrollbar-thumb {
            background: #ff008c;
            border-radius: 2px;
        }
        .category-tab {
            background: white;
            border: 2px solid #ddd;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .category-tab:hover {
            border-color: #ff008c;
        }
        .category-tab.active {
            background: #ff008c;
            color: white;
            border-color: #ff008c;
        }
        .items-list {
            display: grid;
            gap: 15px;
        }
        .item-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }
        .item-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .item-card h3 {
            margin: 0 0 10px 0;
            color: #ff008c;
        }
        .item-card .item-preview {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        .edit-modal.active {
            display: block;
        }
        .edit-modal-content {
            background: white;
            margin: 20px auto;
            max-width: 800px;
            padding: 30px;
            border-radius: 8px;
            position: relative;
        }
        .edit-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }
        .edit-modal-header h2 {
            margin: 0;
            color: #ff008c;
        }
        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        .close-btn:hover {
            color: #ff008c;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-group input[type="text"],
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-group .image-preview {
            margin-top: 10px;
            max-width: 300px;
        }
        .form-group .image-preview img {
            width: 100%;
            height: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .image-upload-btn {
            background: #ff008c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        .image-upload-btn:hover {
            background: #e6007a;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #ff008c;
            color: white;
        }
        .btn-primary:hover {
            background: #e6007a;
        }
        .btn-secondary {
            background: #666;
            color: white;
        }
        .btn-secondary:hover {
            background: #555;
        }
        .message {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .message.active {
            display: block;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .operation-guide {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .operation-guide h2 {
            margin-top: 0;
            color: #1976D2;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .operation-guide h2 i {
            font-size: 20px;
        }
        .operation-guide ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .operation-guide li {
            margin: 8px 0;
            line-height: 1.6;
        }
        .operation-guide .guide-section {
            margin-top: 15px;
        }
        .operation-guide .guide-section:first-child {
            margin-top: 0;
        }
        .operation-guide strong {
            color: #1976D2;
        }
        .operation-guide-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        .operation-guide-header h2 {
            margin: 0;
            flex: 1;
        }
        .operation-guide-toggle {
            background: none;
            border: none;
            color: #1976D2;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }
        .operation-guide-toggle:hover {
            color: #1565C0;
        }
        .operation-guide.collapsed .operation-guide-toggle {
            transform: rotate(-90deg);
        }
        .operation-guide-content {
            margin-top: 15px;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            overflow: hidden;
        }
        .operation-guide.collapsed .operation-guide-content {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="page-header">
            <a href="#" id="back-to-manual-link" class="back-link">
                <i class="fas fa-arrow-left"></i> æ¸…æƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã«æˆ»ã‚‹
            </a>
            <h1><i class="fas fa-edit"></i> æ¸…æƒãƒãƒ‹ãƒ¥ã‚¢ãƒ«ç®¡ç†ç”»é¢</h1>
        </div>

        <div class="operation-guide collapsed" id="operation-guide">
            <div class="operation-guide-header" onclick="toggleOperationGuide()">
                <h2><i class="fas fa-book"></i> æ“ä½œè£œå‰‡</h2>
                <button class="operation-guide-toggle" type="button" aria-label="æ“ä½œè£œå‰‡ã‚’é–‹é–‰">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="operation-guide-content">
            <div class="guide-section">
                <strong>ğŸ“ é …ç›®ã®ç·¨é›†</strong>
                <ul>
                    <li>å„é …ç›®ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãã¾ã™</li>
                    <li>ã‚¿ã‚¤ãƒˆãƒ«ã€ã‚«ãƒ†ã‚´ãƒªã€ãƒªã‚¹ã‚¯èª¬æ˜ã€è‰¯ããªã„ä¾‹ã€è‰¯ã„ä¾‹ã€Q&Aã‚’ç·¨é›†ã§ãã¾ã™</li>
                    <li>ç”»åƒã¯è¤‡æ•°æšã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ï¼ˆã‚¹ãƒãƒ›ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠå¯ï¼‰</li>
                </ul>
            </div>
            <div class="guide-section">
                <strong>â• æ–°è¦é …ç›®ã®è¿½åŠ </strong>
                <ul>
                    <li>å„ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã®ä¸‹ã«ã‚ã‚‹ã€Œæ–°è¦è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã§ãã¾ã™</li>
                    <li>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ã‹ã‚‰é …ç›®ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</li>
                </ul>
            </div>
            <div class="guide-section">
                <strong>ğŸ’¾ ä¿å­˜ã«ã¤ã„ã¦</strong>
                <ul>
                    <li><strong>ä¸‹æ›¸ãä¿å­˜:</strong> ç·¨é›†å†…å®¹ã‚’ä¸€æ™‚ä¿å­˜ã—ã¾ã™ã€‚å¾Œã§ç¢ºèªãƒ»ç¢ºå®šã§ãã¾ã™</li>
                    <li><strong>ç¢ºå®šä¿å­˜:</strong> ç·¨é›†å†…å®¹ã‚’æœ¬ç•ªç’°å¢ƒã«åæ˜ ã—ã¾ã™ã€‚ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™</li>
                    <li>ä¸‹æ›¸ããŒã‚ã‚‹å ´åˆã¯ã€ç”»é¢ä¸Šéƒ¨ã«é€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                </ul>
            </div>
            <div class="guide-section">
                <strong>ğŸ–¼ï¸ ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</strong>
                <ul>
                    <li>ã€Œç”»åƒã‚’é¸æŠã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ã‚¹ãƒãƒ›ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¾ãŸã¯ã‚«ãƒ¡ãƒ©ã§æ’®å½±ã—ãŸç”»åƒã‚’é¸æŠã§ãã¾ã™</li>
                    <li>è¤‡æ•°ã®ç”»åƒã‚’ä¸€åº¦ã«é¸æŠãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™</li>
                    <li>å„ç”»åƒã«ã¯å‰Šé™¤ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                </ul>
            </div>
            <div class="guide-section">
                <strong>ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã®åˆ‡ã‚Šæ›¿ãˆ</strong>
                <ul>
                    <li>ä¸Šéƒ¨ã®ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€è¡¨ç¤ºã™ã‚‹é …ç›®ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ãã¾ã™</li>
                    <li>ã€Œã™ã¹ã¦ã€ã‚’é¸æŠã™ã‚‹ã¨å…¨ã‚«ãƒ†ã‚´ãƒªã®é …ç›®ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</li>
                </ul>
            </div>
            </div>
        </div>

        <div id="message" class="message"></div>
        
        <div id="auth-required" style="display: none; background: #f8d7da; border: 1px solid #f5c6cb; padding: 20px; border-radius: 4px; margin-bottom: 20px; color: #721c24; text-align: center;">
            <h2>ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™</h2>
            <p>ã“ã®ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€ç®¡ç†è€…ãƒ»æ¸…æƒå“¡ãƒ»ã‚³ãƒ³ã‚·ã‚§ãƒ«ã‚¸ãƒ¥ãƒ»é–‹ç™ºè€…ãƒ»ãƒã‚¹ã‚¿ãƒ¼ã®ã„ãšã‚Œã‹ã®æ¨©é™ãŒå¿…è¦ã§ã™ã€‚</p>
            <p id="auth-debug-info" style="margin-top: 10px; font-size: 12px; color: #856404;"></p>
            <a href="signin.html" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background: #ff008c; color: white; text-decoration: none; border-radius: 4px;">ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸</a>
        </div>
        
        <div id="loading-screen" style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
            <div style="text-align: center;">
                <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #ff008c;"></i>
                <p style="margin-top: 20px;">èª­ã¿è¾¼ã¿ä¸­...</p>
            </div>
        </div>
        
        <div id="admin-content" style="display: none;">
            <div class="category-tabs">
                <button class="category-tab active" data-category="all">ã™ã¹ã¦</button>
                <button class="category-tab" data-category="kitchen">å¨æˆ¿è¨­å‚™</button>
                <button class="category-tab" data-category="aircon">ç©ºèª¿è¨­å‚™</button>
                <button class="category-tab" data-category="floor">ãƒ•ãƒ­ã‚¢</button>
                <button class="category-tab" data-category="other">ãã®ä»–</button>
            </div>

            <div id="items-list" class="items-list">
                <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
            
            <div id="draft-section" style="display: none; margin-top: 30px; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                <h3 style="margin-top: 0; color: #856404;">
                    <i class="fas fa-file-alt"></i> ä¸‹æ›¸ããŒã‚ã‚Šã¾ã™
                </h3>
                <p style="margin-bottom: 15px;">
                    ä¸‹æ›¸ãä¿å­˜ã•ã‚ŒãŸå†…å®¹ãŒã‚ã‚Šã¾ã™ã€‚ç¢ºèªã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ã€‚
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="loadDraft()" class="btn" style="background: #ffc107; color: #000;">
                        <i class="fas fa-eye"></i> ä¸‹æ›¸ãã‚’ç¢ºèª
                    </button>
                    <button onclick="applyDraft()" class="btn btn-primary">
                        <i class="fas fa-check-circle"></i> ä¸‹æ›¸ãã‚’ç¢ºå®š
                    </button>
                    <button onclick="discardDraft()" class="btn btn-secondary">
                        <i class="fas fa-trash"></i> ä¸‹æ›¸ãã‚’å‰Šé™¤
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #e7f3ff; border-left: 4px solid #2196F3; border-radius: 4px;">
                <h3 style="margin-top: 0; color: #1976D2;">
                    <i class="fas fa-info-circle"></i> ä¿å­˜ã«ã¤ã„ã¦
                </h3>
                <p style="margin-bottom: 10px;">
                    <strong>ä¸‹æ›¸ãä¿å­˜:</strong> ç·¨é›†å†…å®¹ã‚’ä¸€æ™‚ä¿å­˜ã—ã¾ã™ã€‚å¾Œã§ç¢ºèªãƒ»ç¢ºå®šã§ãã¾ã™ã€‚
                </p>
                <p style="margin-bottom: 0;">
                    <strong>ç¢ºå®šä¿å­˜:</strong> ç·¨é›†å†…å®¹ã‚’æœ¬ç•ªç’°å¢ƒã«åæ˜ ã—ã¾ã™ã€‚ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </p>
            </div>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="edit-modal" class="edit-modal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h2>é …ç›®ã‚’ç·¨é›†</h2>
                <button class="close-btn" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-form">
                <input type="hidden" id="edit-category" />
                <input type="hidden" id="edit-index" />
                
                <div class="form-group">
                    <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="edit-title" required />
                </div>

                <div class="form-group">
                    <label>ãƒªã‚¹ã‚¯</label>
                    <input type="text" id="edit-risk" required />
                </div>

                <div class="form-group">
                    <label>ãƒ€ãƒ¡ãªä¾‹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
                    <textarea id="edit-bad" required></textarea>
                </div>

                <div class="form-group">
                    <label>ãƒ€ãƒ¡ãªä¾‹ï¼ˆç”»åƒãƒ‘ã‚¹ï¼‰</label>
                    <input type="text" id="edit-badImage" />
                    <button type="button" class="image-upload-btn" onclick="uploadImage('badImage')">
                        <i class="fas fa-upload"></i> ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <div class="image-preview" id="preview-badImage"></div>
                </div>

                <div class="form-group">
                    <label>æ¨¡ç¯„ä¾‹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
                    <textarea id="edit-good" required></textarea>
                </div>

                <div class="form-group">
                    <label>æ¨¡ç¯„ä¾‹ï¼ˆç”»åƒãƒ‘ã‚¹ï¼‰</label>
                    <input type="text" id="edit-goodImage" />
                    <button type="button" class="image-upload-btn" onclick="uploadImage('goodImage')">
                        <i class="fas fa-upload"></i> ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </button>
                    <div class="image-preview" id="preview-goodImage"></div>
                </div>

                <div class="form-group">
                    <label>Q&A è³ªå•1</label>
                    <input type="text" id="edit-qa1q" required />
                </div>

                <div class="form-group">
                    <label>Q&A å›ç­”1</label>
                    <textarea id="edit-qa1a" required></textarea>
                </div>

                <div class="form-group">
                    <label>Q&A è³ªå•2</label>
                    <input type="text" id="edit-qa2q" required />
                </div>

                <div class="form-group">
                    <label>Q&A å›ç­”2</label>
                    <textarea id="edit-qa2a" required></textarea>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="saveDraft()" style="background: #6c757d;">
                        <i class="fas fa-file-alt"></i> ä¸‹æ›¸ãä¿å­˜
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check-circle"></i> ç¢ºå®šä¿å­˜
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ãƒ‘ã‚¹ã‚’è§£æ±ºï¼ˆGitHub Pageså¯¾å¿œï¼‰
        // baseã‚¿ã‚°ã‚’ä½¿ç”¨ã—ãªã„ãŸã‚ã€å¸¸ã«çµ¶å¯¾URLã‚’è¿”ã™
        function resolvePath(path) {
            if (!path || path.startsWith('http://') || path.startsWith('https://') || path.startsWith('//')) {
                return path;
            }
            
            const hostname = window.location.hostname;
            const isLocalDev = hostname === 'localhost' || 
                              hostname === '127.0.0.1' ||
                              hostname === '';
            
            const isCustomDomain = hostname === 'misesapo.co.jp' || hostname === 'www.misesapo.co.jp';
                
                if (isLocalDev || isCustomDomain) {
                return path.startsWith('/') ? path : '/' + path;
            }
            
            // GitHub Pagesï¼ˆsakurada-masaru.github.ioï¼‰ã§ã¯/misesapo/ã‚’è¿½åŠ 
            let resolvedPath;
            if (path.startsWith('/misesapo/')) {
                // æ—¢ã«/misesapo/ã§å§‹ã¾ã‚‹å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
                resolvedPath = path;
            } else if (path.startsWith('/')) {
                // /ã§å§‹ã¾ã‚‹å ´åˆã¯/misesapo/ã‚’è¿½åŠ 
                resolvedPath = '/misesapo' + path;
            } else {
                // ç›¸å¯¾ãƒ‘ã‚¹ã®å ´åˆã¯/misesapo/ã‚’è¿½åŠ 
                resolvedPath = '/misesapo/' + path;
            }
            
            // å¸¸ã«çµ¶å¯¾URLã‚’è¿”ã™
            return window.location.origin + resolvedPath;
        }
        
        // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ãƒªãƒ³ã‚¯ã‚’è¨­å®š
        function setBackLink() {
            const backLink = document.getElementById('back-to-manual-link');
            if (backLink) {
                backLink.href = resolvePath('/cleaning-manual.html');
            }
        }
        
        let manualData = {
            kitchen: [],
            aircon: [],
            floor: [],
            other: []
        };
        let currentCategory = 'all';

        // é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        function isDevelopmentServer() {
            return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        }
        
        // AWS APIãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function isAWSAvailable() {
            return window.AWSCleaningManualAPI && window.AWSCleaningManualAPI.isAvailable();
        }
        
        // èªè¨¼ãƒã‚§ãƒƒã‚¯ã¨åˆæœŸåŒ–ï¼ˆAWSç§»è¡Œã«ã‚ˆã‚Šèªè¨¼ã¯ä¸è¦ï¼‰
        async function initAuth() {
            // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®ãƒªãƒ³ã‚¯ã‚’è¨­å®š
            setBackLink();
            
            // AWS APIãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
            if (!isAWSAvailable()) {
                console.warn('[CleaningManualAdmin] AWS API not available');
                // é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®å ´åˆã¯è¡¨ç¤ºã‚’è¨±å¯
                if (isDevelopmentServer()) {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('admin-content').style.display = 'block';
                    return true;
                } else {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('auth-required').style.display = 'block';
                    const debugInfo = document.getElementById('auth-debug-info');
                    debugInfo.textContent = 'AWS APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚';
                    return false;
                }
            }
            
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('admin-content').style.display = 'block';
            return true;
        }
        
        // ä¸‹æ›¸ããƒã‚§ãƒƒã‚¯
        async function checkDraft() {
            if (!isAWSAvailable()) return;
            
            try {
                const draft = await window.AWSCleaningManualAPI.loadDraft();
                if (draft && (draft.kitchen?.length > 0 || draft.aircon?.length > 0 || draft.floor?.length > 0 || draft.other?.length > 0)) {
                    document.getElementById('draft-section').style.display = 'block';
                }
            } catch (error) {
                console.error('Draft check error:', error);
            }
        }
        
        // ä¸‹æ›¸ãã‚’èª­ã¿è¾¼ã‚€
        async function loadDraft() {
            if (!isAWSAvailable()) {
                showMessage('âš ï¸ AWS APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            try {
                const draft = await window.AWSCleaningManualAPI.loadDraft();
                if (draft && (draft.kitchen?.length > 0 || draft.aircon?.length > 0 || draft.floor?.length > 0 || draft.other?.length > 0)) {
                    manualData = draft;
                    renderItems();
                    showMessage('ä¸‹æ›¸ãã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚ç¢ºèªã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ã€‚', 'success');
                } else {
                    showMessage('ä¸‹æ›¸ããŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                }
            } catch (error) {
                console.error('Load draft error:', error);
                showMessage('ä¸‹æ›¸ãã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }
        
        // ä¸‹æ›¸ãã‚’ç¢ºå®š
        async function applyDraft() {
            if (!isAWSAvailable()) {
                showMessage('âš ï¸ AWS APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            if (!confirm('ä¸‹æ›¸ãã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚')) {
                return;
            }
            
            try {
                const draft = await window.AWSCleaningManualAPI.loadDraft();
                if (draft && (draft.kitchen?.length > 0 || draft.aircon?.length > 0 || draft.floor?.length > 0 || draft.other?.length > 0)) {
                    // ä¸‹æ›¸ãã‚’ç¢ºå®šç‰ˆã«ä¿å­˜
                    await window.AWSCleaningManualAPI.publishDraft(draft);
                    // ä¸‹æ›¸ãã‚’å‰Šé™¤ï¼ˆç©ºã®ãƒ‡ãƒ¼ã‚¿ã§ä¸Šæ›¸ãï¼‰
                    const emptyDraft = { kitchen: [], aircon: [], floor: [], other: [] };
                    await window.AWSCleaningManualAPI.saveDraft(emptyDraft);
                    
                    manualData = draft;
                    renderItems();
                    document.getElementById('draft-section').style.display = 'none';
                    showMessage('ä¸‹æ›¸ãã‚’ç¢ºå®šã—ã¾ã—ãŸã€‚ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚', 'success');
                } else {
                    showMessage('ä¸‹æ›¸ããŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', 'error');
                }
            } catch (error) {
                console.error('Apply draft error:', error);
                showMessage('ä¸‹æ›¸ãã®ç¢ºå®šã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }
        
        // ä¸‹æ›¸ãã‚’å‰Šé™¤
        async function discardDraft() {
            if (!isAWSAvailable()) {
                showMessage('âš ï¸ AWS APIãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'error');
                return;
            }
            
            if (!confirm('ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                const emptyDraft = { kitchen: [], aircon: [], floor: [], other: [] };
                await window.AWSCleaningManualAPI.saveDraft(emptyDraft);
                document.getElementById('draft-section').style.display = 'none';
                showMessage('ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', 'success');
            } catch (error) {
                console.error('Discard draft error:', error);
                showMessage('ä¸‹æ›¸ãã®å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData() {
            try {
                // AWS APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯AWSã‹ã‚‰èª­ã¿è¾¼ã‚€
                if (isAWSAvailable()) {
                    try {
                        manualData = await window.AWSCleaningManualAPI.loadData();
                        renderItems();
                        // ä¸‹æ›¸ãã‚’ãƒã‚§ãƒƒã‚¯
                        await checkDraft();
                        return;
                    } catch (error) {
                        console.error('AWS API load error:', error);
                        showMessage('AWS APIã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è©¦è¡Œã—ã¾ã™...', 'error');
                    }
                }
                
                // é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®å ´åˆã¯APIã‚’è©¦ã™
                let response = null;
                if (isDevelopmentServer()) {
                    try {
                        response = await fetch(resolvePath('/api/cleaning-manual'));
                    } catch (e) {
                        response = null;
                    }
                }
                
                // APIãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯é™çš„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                if (!response || !response.ok) {
                    response = await fetch(resolvePath('/data/cleaning-manual.json'));
                }
                
                if (response && response.ok) {
                    manualData = await response.json();
                    renderItems();
                } else {
                    showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // é …ç›®ã‚’è¡¨ç¤º
        function renderItems() {
            const container = document.getElementById('items-list');
            let items = [];

            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª
            console.log('[CleaningManualAdmin] manualData:', manualData);
            console.log('[CleaningManualAdmin] currentCategory:', currentCategory);

            // manualDataãŒæ­£ã—ã„æ§‹é€ ã§ãªã„å ´åˆã€åˆæœŸåŒ–
            if (!manualData || typeof manualData !== 'object') {
                console.warn('[CleaningManualAdmin] manualData is invalid, initializing...');
                manualData = {
                    kitchen: [],
                    aircon: [],
                    floor: [],
                    other: []
                };
            }

            // å„ã‚«ãƒ†ã‚´ãƒªãŒé…åˆ—ã§ãªã„å ´åˆã€åˆæœŸåŒ–
            if (!Array.isArray(manualData.kitchen)) manualData.kitchen = [];
            if (!Array.isArray(manualData.aircon)) manualData.aircon = [];
            if (!Array.isArray(manualData.floor)) manualData.floor = [];
            if (!Array.isArray(manualData.other)) manualData.other = [];

            if (currentCategory === 'all') {
                items = [
                    ...manualData.kitchen.map((item, idx) => ({ ...item, category: 'kitchen', index: idx })),
                    ...manualData.aircon.map((item, idx) => ({ ...item, category: 'aircon', index: idx })),
                    ...manualData.floor.map((item, idx) => ({ ...item, category: 'floor', index: idx })),
                    ...manualData.other.map((item, idx) => ({ ...item, category: 'other', index: idx }))
                ];
            } else {
                items = (manualData[currentCategory] || []).map((item, idx) => ({
                    ...item,
                    category: currentCategory,
                    index: idx
                }));
            }

            console.log('[CleaningManualAdmin] Total items:', items.length);

            if (items.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="font-size: 18px; color: #666; margin-bottom: 20px;">é …ç›®ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <button onclick="openEditModal('${currentCategory === 'all' ? 'kitchen' : currentCategory}', -1)" class="btn btn-primary" style="padding: 12px 24px; font-size: 16px;">
                            <i class="fas fa-plus"></i> æ–°è¦é …ç›®ã‚’è¿½åŠ 
                        </button>
                        <p style="margin-top: 20px; font-size: 14px; color: #999;">
                            ã¾ãŸã¯ã€<a href="#" onclick="importInitialData(); return false;" style="color: #ff008c; text-decoration: underline;">åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</a>
                        </p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <button onclick="openEditModal('${currentCategory === 'all' ? 'kitchen' : currentCategory}', -1)" class="btn btn-primary">
                        <i class="fas fa-plus"></i> æ–°è¦é …ç›®ã‚’è¿½åŠ 
                    </button>
                </div>
                ${items.map(item => `
                    <div class="item-card" onclick="openEditModal('${item.category}', ${item.index})">
                        <h3>${item.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</h3>
                        <div class="item-preview">
                            <strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ${getCategoryName(item.category)}<br>
                            <strong>ãƒªã‚¹ã‚¯:</strong> ${item.risk || 'æœªè¨­å®š'}<br>
                            <strong>ãƒ€ãƒ¡ãªä¾‹:</strong> ${item.bad ? item.bad.substring(0, 50) + '...' : 'æœªè¨­å®š'}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function getCategoryName(category) {
            const names = {
                kitchen: 'å¨æˆ¿è¨­å‚™',
                aircon: 'ç©ºèª¿è¨­å‚™',
                floor: 'ãƒ•ãƒ­ã‚¢',
                other: 'ãã®ä»–'
            };
            return names[category] || category;
        }

        // ã‚«ãƒ†ã‚´ãƒªã‚¿ãƒ–ã®åˆ‡ã‚Šæ›¿ãˆ
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentCategory = tab.dataset.category;
                renderItems();
            });
        });

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEditModal(category, index) {
            console.log('[CleaningManualAdmin] openEditModal called:', { category, index });
            
            // ã‚«ãƒ†ã‚´ãƒªãŒ'all'ã®å ´åˆã¯'kitchen'ã«å¤‰æ›´
            if (category === 'all') {
                category = 'kitchen';
            }

            // æ–°è¦è¿½åŠ ã®å ´åˆï¼ˆindex === -1ï¼‰
            const isNew = index === -1;
            
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’ç¢ºèª
            console.log('[CleaningManualAdmin] manualData:', manualData);
            console.log('[CleaningManualAdmin] manualData[category]:', manualData[category]);
            
            // æ—¢å­˜é …ç›®ã‚’å–å¾—
            let item = null;
            if (!isNew) {
                if (manualData[category] && Array.isArray(manualData[category]) && manualData[category][index]) {
                    item = manualData[category][index];
                    console.log('[CleaningManualAdmin] Found item:', item);
                } else {
                    console.warn('[CleaningManualAdmin] Item not found:', { category, index, arrayLength: manualData[category]?.length });
                    showMessage('é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'error');
                    return;
                }
            }

            document.getElementById('edit-category').value = category;
            document.getElementById('edit-index').value = index;
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
            const modalTitle = document.querySelector('#edit-modal h2');
            if (modalTitle) {
                modalTitle.textContent = isNew ? 'æ–°è¦é …ç›®ã‚’è¿½åŠ ' : 'é …ç›®ã‚’ç·¨é›†';
            }

            // æ—¢å­˜é …ç›®ã®å ´åˆã¯å€¤ã‚’è¨­å®šã€æ–°è¦ã®å ´åˆã¯ç©º
            document.getElementById('edit-title').value = item ? (item.title || '') : '';
            document.getElementById('edit-risk').value = item ? (item.risk || '') : '';
            document.getElementById('edit-bad').value = item ? (item.bad || '') : '';
            
            // ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’å‡¦ç†ï¼ˆé…åˆ—å½¢å¼ã«ã‚‚å¯¾å¿œï¼‰
            const processImageValueForInput = (imageValue) => {
                if (!imageValue) return '';
                // é…åˆ—ã®å ´åˆã¯JSONæ–‡å­—åˆ—ã«å¤‰æ›ã€æ–‡å­—åˆ—ã®å ´åˆã¯ãã®ã¾ã¾
                if (Array.isArray(imageValue)) {
                    return imageValue.length > 0 ? JSON.stringify(imageValue) : '';
                }
                return imageValue;
            };
            
            const badImageValue = item ? processImageValueForInput(item.badImage) : '';
            document.getElementById('edit-badImage').value = badImageValue;
            document.getElementById('edit-good').value = item ? (item.good || '') : '';
            const goodImageValue = item ? processImageValueForInput(item.goodImage) : '';
            document.getElementById('edit-goodImage').value = goodImageValue;
            document.getElementById('edit-qa1q').value = item ? (item.qa1q || '') : '';
            document.getElementById('edit-qa1a').value = item ? (item.qa1a || '') : '';
            document.getElementById('edit-qa2q').value = item ? (item.qa2q || '') : '';
            document.getElementById('edit-qa2a').value = item ? (item.qa2a || '') : '';

            // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ï¼ˆé…åˆ—å½¢å¼ã«ã‚‚å¯¾å¿œï¼‰
            updateImagePreview('badImage', item ? item.badImage : '');
            updateImagePreview('goodImage', item ? item.goodImage : '');

            document.getElementById('edit-modal').classList.add('active');
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ï¼ˆè¤‡æ•°ç”»åƒå¯¾å¿œï¼‰
        function updateImagePreview(field, path) {
            const preview = document.getElementById(`preview-${field}`);
            
            // pathãŒundefinedã€nullã€ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (!path || path === 'undefined' || path === 'null' || (typeof path === 'string' && path.trim() === '')) {
                preview.innerHTML = '';
                return;
            }
            
            // é…åˆ—ã®å ´åˆã¯è¤‡æ•°ç”»åƒã‚’è¡¨ç¤º
            let images = [];
            if (Array.isArray(path)) {
                images = path;
            } else if (typeof path === 'string') {
                // æ–‡å­—åˆ—ã®å ´åˆã€JSONé…åˆ—ã‹ã©ã†ã‹ç¢ºèª
                try {
                    const parsed = JSON.parse(path);
                    if (Array.isArray(parsed)) {
                        images = parsed;
            } else {
                        images = [path];
                    }
                } catch (e) {
                    // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
                    images = [path];
                }
            } else {
                images = [path];
            }
            
            // ç©ºã®é…åˆ—ã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (images.length === 0) {
                preview.innerHTML = '';
                return;
            }
            
            // ç”»åƒURLã‚’è§£æ±ºã™ã‚‹é–¢æ•°
            const resolveImageUrl = (imgPath) => {
                if (!imgPath || imgPath === 'undefined' || imgPath === 'null' || imgPath.trim() === '') {
                    return null;
                }
                
                // æ—¢ã«URLã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
                if (imgPath.startsWith('http://') || imgPath.startsWith('https://')) {
                    return imgPath;
                }
                
                // ç›¸å¯¾ãƒ‘ã‚¹ã®å ´åˆã¯è§£æ±º
                const pathToResolve = imgPath.startsWith('/') ? imgPath : '/' + imgPath;
                return resolvePath(pathToResolve);
            };
            
            // è¤‡æ•°ç”»åƒã‚’è¡¨ç¤º
            const imageHtml = images.map((imgPath, index) => {
                const imageUrl = resolveImageUrl(imgPath);
                if (!imageUrl) return '';
                
                return `
                    <div style="position: relative; display: inline-block; margin: 5px; max-width: 200px;">
                        <img src="${imageUrl}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ${index + 1}" 
                             style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px;"
                             onerror="console.error('[ImagePreview] Failed to load image:', '${imageUrl}'); this.onerror=null; this.style.display='none';" />
                        <button type="button" 
                                onclick="removeImage('${field}', ${index})" 
                                style="position: absolute; top: 5px; right: 5px; background: rgba(255,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 14px; line-height: 1;"
                                title="ã“ã®ç”»åƒã‚’å‰Šé™¤">Ã—</button>
                    </div>
                `;
            }).filter(html => html !== '').join('');
            
            preview.innerHTML = imageHtml || '<span style="color:#999;font-size:12px;">ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>';
            console.log('[ImagePreview] Updated preview for field:', field, 'Images:', images.length);
        }
        
        // ç”»åƒã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«é…ç½®ï¼‰
        window.removeImage = function(field, index) {
            const input = document.getElementById(`edit-${field}`);
            const currentValue = input.value.trim();
            
            if (!currentValue) return;
            
            let images = [];
            try {
                const parsed = JSON.parse(currentValue);
                if (Array.isArray(parsed)) {
                    images = parsed;
                } else {
                    images = [currentValue];
                }
            } catch (e) {
                images = [currentValue];
            }
            
            // æŒ‡å®šã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®ç”»åƒã‚’å‰Šé™¤
            if (index >= 0 && index < images.length) {
                images.splice(index, 1);
                
                // ç”»åƒãŒ1æšã«ãªã£ãŸå ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜ã€è¤‡æ•°æšã®å ´åˆã¯é…åˆ—ã¨ã—ã¦ä¿å­˜
                if (images.length === 0) {
                    input.value = '';
                    updateImagePreview(field, '');
                } else if (images.length === 1) {
                    input.value = images[0];
                    updateImagePreview(field, images[0]);
                } else {
                    input.value = JSON.stringify(images);
                    updateImagePreview(field, images);
                }
                
                showMessage('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            }
        };

        // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºï¼ˆã‚¹ãƒãƒ›ã®å¤§ããªç”»åƒã‚’åœ§ç¸®ï¼‰
        function resizeImage(file, maxWidth = 1920, maxHeight = 1920, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // ãƒªã‚µã‚¤ã‚ºãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
                        if (width > maxWidth || height > maxHeight) {
                            if (width > height) {
                                if (width > maxWidth) {
                                    height = (height * maxWidth) / width;
                                    width = maxWidth;
                                }
                            } else {
                                if (height > maxHeight) {
                                    width = (width * maxHeight) / height;
                                    height = maxHeight;
                                }
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob) {
                                // å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ä¿æŒ
                                const resizedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                resolve(resizedFile);
                            } else {
                                resolve(file); // ãƒªã‚µã‚¤ã‚ºå¤±æ•—æ™‚ã¯å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”ã™
                            }
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = () => {
                        resolve(file); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”ã™
                    };
                    img.src = e.target.result;
                };
                reader.onerror = () => {
                    resolve(file); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿”ã™
                };
                reader.readAsDataURL(file);
            });
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè¤‡æ•°é¸æŠå¯¾å¿œï¼‰
        async function uploadImage(field) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/jpeg,image/png,image/webp,image/heic,image/heif';
            input.multiple = true; // è¤‡æ•°é¸æŠã‚’å¯èƒ½ã«ã™ã‚‹
            // captureå±æ€§ã¯å‰Šé™¤ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰ã‚‚é¸æŠã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼‰
            // ã‚«ãƒ¡ãƒ©ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«ã€Œã‚«ãƒ¡ãƒ©ã€ã‚’é¸æŠã§ãã‚‹
            input.onchange = async (e) => {
                const files = Array.from(e.target.files);
                if (!files || files.length === 0) return;

                try {
                    showMessage(`${files.length}æšã®ç”»åƒã‚’å‡¦ç†ä¸­...`, 'success');
                    
                    const uploadedImages = []; // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸã—ãŸç”»åƒã®ãƒ‘ã‚¹ã‚’ä¿å­˜
                    const maxSize = 10 * 1024 * 1024; // 10MB
                    
                    // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †ç•ªã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        
                        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
                    if (file.size > maxSize) {
                            console.warn(`[ImageUpload] File ${i + 1} is too large: ${file.size} bytes`);
                            showMessage(`âš ï¸ ç”»åƒ${i + 1}ã®ã‚µã‚¤ã‚ºãŒå¤§ãã™ãã¾ã™ï¼ˆæœ€å¤§10MBï¼‰ã€‚ãƒªã‚µã‚¤ã‚ºã—ã¦ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™...`, 'warning');
                    }

                    // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºï¼ˆã‚¹ãƒãƒ›ã®å¤§ããªç”»åƒã‚’åœ§ç¸®ï¼‰
                    let fileToUpload = file;
                    if (file.type.startsWith('image/')) {
                        try {
                            fileToUpload = await resizeImage(file, 1920, 1920, 0.85);
                                console.log(`[ImageUpload] File ${i + 1} resized: ${file.size} -> ${fileToUpload.size} bytes`);
                        } catch (resizeError) {
                                console.warn(`[ImageUpload] File ${i + 1} resize failed, using original:`, resizeError);
                            // ãƒªã‚µã‚¤ã‚ºå¤±æ•—æ™‚ã¯å…ƒã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨
                        }
                    }

                    let imagePath = null;
                    
                        // AWS S3ã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å„ªå…ˆ
                    if (window.AWSS3Upload && window.AWSS3Upload.isAvailable()) {
                        try {
                                showMessage(`ç”»åƒ${i + 1}/${files.length}ã‚’S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`, 'success');
                            const result = await window.AWSS3Upload.uploadImage(fileToUpload, field);
                                console.log(`[ImageUpload] File ${i + 1} upload result:`, result);
                            imagePath = result.path || result.url;
                                uploadedImages.push(imagePath);
                                console.log(`[ImageUpload] File ${i + 1} uploaded:`, imagePath);
                        } catch (s3Error) {
                                console.error(`[ImageUpload] File ${i + 1} S3 upload error:`, s3Error);
                                showMessage(`ç”»åƒ${i + 1}ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${s3Error.message}`, 'error');
                                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚æ¬¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã‚’ç¶šã‘ã‚‹
                                continue;
                        }
                    } else if (isDevelopmentServer()) {
                        // é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯ã€ç›´æ¥APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                            try {
                                showMessage(`ç”»åƒ${i + 1}/${files.length}ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...`, 'success');
                        const formData = new FormData();
                        formData.append('image', fileToUpload);
                        
                        const response = await fetch(resolvePath('/api/cleaning-manual/upload-image'), {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const result = await response.json();
                            imagePath = result.path || result.url;
                                    uploadedImages.push(imagePath);
                                    console.log(`[ImageUpload] File ${i + 1} uploaded:`, imagePath);
                        } else {
                            const errorText = await response.text();
                                    console.error(`[ImageUpload] File ${i + 1} upload error:`, errorText);
                                    showMessage(`ç”»åƒ${i + 1}ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ${errorText}`, 'error');
                                    continue;
                                }
                            } catch (error) {
                                console.error(`[ImageUpload] File ${i + 1} upload error:`, error);
                                showMessage(`ç”»åƒ${i + 1}ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                                continue;
                        }
                    } else {
                            showMessage('âš ï¸ ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«ã¯é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã¾ãŸã¯AWS S3ãŒå¿…è¦ã§ã™ã€‚', 'error');
                        return;
                    }
                    }
                    
                    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸã—ãŸç”»åƒã‚’å‡¦ç†
                    if (uploadedImages.length > 0) {
                        // æ—¢å­˜ã®ç”»åƒãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆé…åˆ—ã¾ãŸã¯æ–‡å­—åˆ—ï¼‰
                        const currentValue = document.getElementById(`edit-${field}`).value.trim();
                        let existingImages = [];
                        
                        // æ—¢å­˜ã®å€¤ãŒé…åˆ—å½¢å¼ï¼ˆJSONï¼‰ã‹ã©ã†ã‹ç¢ºèª
                        if (currentValue) {
                            try {
                                const parsed = JSON.parse(currentValue);
                                if (Array.isArray(parsed)) {
                                    existingImages = parsed;
                                } else {
                                    // æ–‡å­—åˆ—ã®å ´åˆã¯é…åˆ—ã«å¤‰æ›
                                    existingImages = [currentValue];
                                }
                            } catch (e) {
                                // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†
                                existingImages = [currentValue];
                            }
                        }
                        
                        // æ–°ã—ã„ç”»åƒã‚’æ—¢å­˜ã®ç”»åƒã«è¿½åŠ 
                        const allImages = [...existingImages, ...uploadedImages];
                        
                        // è¤‡æ•°æšã®å ´åˆã¯é…åˆ—ã¨ã—ã¦ä¿å­˜ã€1æšã®å ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ï¼‰
                        if (allImages.length === 1) {
                            document.getElementById(`edit-${field}`).value = allImages[0];
                            updateImagePreview(field, allImages[0]);
                        } else {
                            // è¤‡æ•°æšã®å ´åˆã¯é…åˆ—ã¨ã—ã¦ä¿å­˜
                            document.getElementById(`edit-${field}`).value = JSON.stringify(allImages);
                            updateImagePreview(field, allImages); // è¤‡æ•°ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
                        }
                        
                        showMessage(`${uploadedImages.length}æšã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`, 'success');
                    } else {
                        showMessage('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    showMessage('ç”»åƒã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ' + (error.message || error.toString()), 'error');
                }
            };
            input.click();
        }
        
        // ä¸‹æ›¸ãä¿å­˜ï¼ˆFirebaseå‰Šé™¤ã«ã‚ˆã‚Šç„¡åŠ¹åŒ–ï¼‰
        async function saveDraft() {
            showMessage('âš ï¸ ä¸‹æ›¸ãä¿å­˜æ©Ÿèƒ½ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚', 'error');
            return;
            
            const category = document.getElementById('edit-category').value;
            const index = parseInt(document.getElementById('edit-index').value);
            const isNew = index === -1;

            // ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’å‡¦ç†ï¼ˆé…åˆ—å½¢å¼ã«ã‚‚å¯¾å¿œï¼‰
            const processImageField = (fieldId) => {
                const value = (document.getElementById(fieldId).value || '').trim();
                if (!value) return undefined;
                
                // JSONé…åˆ—ã‹ã©ã†ã‹ç¢ºèª
                try {
                    const parsed = JSON.parse(value);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        // é…åˆ—ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™ï¼ˆè¤‡æ•°ç”»åƒï¼‰
                        return parsed;
                    } else if (Array.isArray(parsed) && parsed.length === 0) {
                        return undefined;
                    }
                } catch (e) {
                    // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†ï¼ˆå˜ä¸€ç”»åƒï¼‰
                }
                
                // æ–‡å­—åˆ—ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
                return value;
            };

            const updatedItem = {
                title: document.getElementById('edit-title').value,
                category: getCategoryName(category),
                risk: document.getElementById('edit-risk').value,
                bad: document.getElementById('edit-bad').value,
                badImage: processImageField('edit-badImage'),
                good: document.getElementById('edit-good').value,
                goodImage: processImageField('edit-goodImage'),
                qa1q: document.getElementById('edit-qa1q').value,
                qa1a: document.getElementById('edit-qa1a').value,
                qa2q: document.getElementById('edit-qa2q').value,
                qa2a: document.getElementById('edit-qa2a').value
            };

            // ã‚«ãƒ†ã‚´ãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!manualData[category]) {
                manualData[category] = [];
            }

            // æ–°è¦è¿½åŠ ã®å ´åˆã¯pushã€æ—¢å­˜ã®å ´åˆã¯æ›´æ–°
            if (isNew) {
                manualData[category].push(updatedItem);
                console.log('[CleaningManualAdmin] Added new item to category:', category);
            } else {
                // æ—¢å­˜é …ç›®ã®æ›´æ–°
                if (manualData[category] && Array.isArray(manualData[category]) && manualData[category][index]) {
                    manualData[category][index] = updatedItem;
                    console.log('[CleaningManualAdmin] Updated item at index:', index, 'in category:', category);
                } else {
                    console.error('[CleaningManualAdmin] Cannot update item - not found:', { category, index });
                    showMessage('é …ç›®ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
            }

            try {
                if (isAWSAvailable()) {
                    await window.AWSCleaningManualAPI.saveDraft(manualData);
                showMessage('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚å¾Œã§ç¢ºèªã—ã¦ç¢ºå®šã§ãã¾ã™ã€‚', 'success');
                } else if (isDevelopmentServer()) {
                    // é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®å ´åˆã¯APIçµŒç”±ã§ä¿å­˜
                    const response = await fetch(resolvePath('/api/cleaning-manual/draft'), {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(manualData)
                    });
                    if (!response.ok) {
                        throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    showMessage('ä¸‹æ›¸ãã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚å¾Œã§ç¢ºèªã—ã¦ç¢ºå®šã§ãã¾ã™ã€‚', 'success');
                } else {
                    showMessage('âš ï¸ ä¸‹æ›¸ãä¿å­˜ã«ã¯AWS APIã¾ãŸã¯é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™ã€‚', 'error');
                    return;
                }
                closeEditModal();
                renderItems();
            } catch (error) {
                console.error('Save draft error:', error);
                showMessage('ä¸‹æ›¸ãä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ï¼ˆç¢ºå®šä¿å­˜ï¼‰
        document.getElementById('edit-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const category = document.getElementById('edit-category').value;
            const index = parseInt(document.getElementById('edit-index').value);
            const isNew = index === -1;

            // ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’å‡¦ç†ï¼ˆé…åˆ—å½¢å¼ã«ã‚‚å¯¾å¿œï¼‰
            const processImageField = (fieldId) => {
                const value = (document.getElementById(fieldId).value || '').trim();
                if (!value) return undefined;
                
                // JSONé…åˆ—ã‹ã©ã†ã‹ç¢ºèª
                try {
                    const parsed = JSON.parse(value);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        // é…åˆ—ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™ï¼ˆè¤‡æ•°ç”»åƒï¼‰
                        return parsed;
                    } else if (Array.isArray(parsed) && parsed.length === 0) {
                        return undefined;
                    }
                } catch (e) {
                    // JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ãŸå ´åˆã¯æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã†ï¼ˆå˜ä¸€ç”»åƒï¼‰
                }
                
                // æ–‡å­—åˆ—ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
                return value;
            };

            const updatedItem = {
                title: document.getElementById('edit-title').value,
                category: getCategoryName(category),
                risk: document.getElementById('edit-risk').value,
                bad: document.getElementById('edit-bad').value,
                badImage: processImageField('edit-badImage'),
                good: document.getElementById('edit-good').value,
                goodImage: processImageField('edit-goodImage'),
                qa1q: document.getElementById('edit-qa1q').value,
                qa1a: document.getElementById('edit-qa1a').value,
                qa2q: document.getElementById('edit-qa2q').value,
                qa2a: document.getElementById('edit-qa2a').value
            };

            // ã‚«ãƒ†ã‚´ãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!manualData[category]) {
                manualData[category] = [];
            }

            // æ–°è¦è¿½åŠ ã®å ´åˆã¯pushã€æ—¢å­˜ã®å ´åˆã¯æ›´æ–°
            if (isNew) {
                manualData[category].push(updatedItem);
                console.log('[CleaningManualAdmin] Added new item to category:', category);
            } else {
                // æ—¢å­˜é …ç›®ã®æ›´æ–°
                if (manualData[category] && Array.isArray(manualData[category]) && manualData[category][index]) {
                    manualData[category][index] = updatedItem;
                    console.log('[CleaningManualAdmin] Updated item at index:', index, 'in category:', category);
                } else {
                    console.error('[CleaningManualAdmin] Cannot update item - not found:', { category, index });
                    showMessage('é …ç›®ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é …ç›®ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
                    return;
                }
            }

            try {
                // AWS APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯AWSã«ä¿å­˜
                if (isAWSAvailable()) {
                    await window.AWSCleaningManualAPI.saveData(manualData, false);
                    showMessage('ç¢ºå®šä¿å­˜ã—ã¾ã—ãŸã€‚ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚', 'success');
                    closeEditModal();
                    renderItems();
                } else if (isDevelopmentServer()) {
                    // é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®å ´åˆã¯APIçµŒç”±ã§ä¿å­˜
                    const response = await fetch(resolvePath('/api/cleaning-manual'), {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(manualData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        showMessage(result.message || 'ä¿å­˜ã—ã¾ã—ãŸã€‚å¤‰æ›´ã‚’ç¢ºèªã—ã¦ã‹ã‚‰Gitã«ã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚', 'success');
                        closeEditModal();
                        renderItems();
                    } else {
                        showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                    }
                } else {
                    showMessage('âš ï¸ ä¿å­˜ã«ã¯AWS APIã¾ãŸã¯é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™ã€‚', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showMessage('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        });

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type} active`;
            setTimeout(() => {
                messageEl.classList.remove('active');
            }, 3000);
        }

        // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        async function importInitialData() {
            if (!confirm('åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã‹ï¼Ÿæ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) {
                return;
            }

            try {
                // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                // ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ç›´æ¥ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã€æœ¬ç•ªç’°å¢ƒã§ã¯resolvePathã‚’ä½¿ç”¨
                const hostname = window.location.hostname;
                const isLocalDev = hostname === 'localhost' || 
                                  hostname === '127.0.0.1' ||
                                  hostname === '';
                
                const jsonUrl = isLocalDev ? '/data/cleaning-manual.json' : resolvePath('/data/cleaning-manual.json');
                console.log('[CleaningManualAdmin] Importing initial data from:', jsonUrl, '(isLocalDev:', isLocalDev, ')');
                
                const response = await fetch(jsonUrl);
                if (!response.ok) {
                    throw new Error(`åˆæœŸãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (Status: ${response.status}, URL: ${response.url})`);
                }

                const initialData = await response.json();
                
                // AWS APIãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯AWSã«ä¿å­˜
                if (isAWSAvailable()) {
                    await window.AWSCleaningManualAPI.saveData(initialData, false);
                    showMessage('åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼ˆç¢ºå®šä¿å­˜ï¼‰', 'success');
                } else if (isDevelopmentServer()) {
                    // é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®å ´åˆã¯APIçµŒç”±ã§ä¿å­˜
                    const saveResponse = await fetch(resolvePath('/api/cleaning-manual'), {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(initialData)
                    });

                    if (saveResponse.ok) {
                        showMessage('åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ', 'success');
                    } else {
                        throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } else {
                    showMessage('âš ï¸ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«ã¯AWS APIã¾ãŸã¯é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™ã€‚', 'error');
                    return;
                }

                // ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿
                manualData = initialData;
                renderItems();
            } catch (error) {
                console.error('Import error:', error);
                showMessage('åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ï¼‰
        window.loadDraft = loadDraft;
        window.applyDraft = applyDraft;
        window.discardDraft = discardDraft;
        window.toggleOperationGuide = toggleOperationGuide;
        window.importInitialData = importInitialData;
        window.openEditModal = openEditModal;

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªã¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ã—ã¦ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEditModalFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            const index = urlParams.get('index');
            
            if (category && index !== null) {
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
                const checkInterval = setInterval(() => {
                    if (manualData && manualData[category] && manualData[category][parseInt(index)]) {
                        clearInterval(checkInterval);
                        openEditModal(category, parseInt(index));
                        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }, 100);
                
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ5ç§’ï¼‰
                setTimeout(() => {
                    clearInterval(checkInterval);
                }, 5000);
            }
        }

        // æ“ä½œè£œå‰‡ã®é–‹é–‰
        function toggleOperationGuide() {
            const guide = document.getElementById('operation-guide');
            if (guide) {
                guide.classList.toggle('collapsed');
            }
        }

        // åˆæœŸåŒ–
        (async function() {
            const authOk = await initAuth();
            if (authOk) {
                await loadData();
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯
                setTimeout(() => {
                    openEditModalFromURL();
                }, 500);
            }
        })();
    </script>
</body>
</html>

