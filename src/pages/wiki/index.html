@layout('layouts.admin')
@json('data/meta/wiki_title.json', $title)
@json('data/meta/wiki_body_class.json', $body_class)
@json('data/wiki_entries.json', $wikiData)

<link rel="stylesheet" href="/css/admin-sidebar.css">
<!-- AWS SDKの読み込み -->
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1000.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.0/dist/amazon-cognito-identity.min.js"></script>
<script src="/js/cognito_config.js"></script>
<script src="/js/cognito_auth.js"></script>
<script src="/js/client_auth.js"></script>
<script src="/js/admin-sidebar.js"></script>

<!-- AWS API -->
<script src="/js/aws-wiki-api.js">
  // マイページリンクを設定（AWS Cognito認証のみ使用）
  async function setupMypageLink() {
    const mypageLink = document.getElementById('sidebar-mypage-link');
    if (!mypageLink) return;

    try {
      let userId = null;
      let email = null;

      // まずローカルストレージのcognito_userからIDを取得（最優先）
      try {
        const storedCognitoUser = localStorage.getItem('cognito_user');
        if (storedCognitoUser) {
          const parsedUser = JSON.parse(storedCognitoUser);
          if (parsedUser.id) {
            userId = parsedUser.id;
            console.log('[Wiki] Using ID from stored cognito_user:', userId);
          } else if (parsedUser.email) {
            email = parsedUser.email;
            console.log('[Wiki] Using email from stored cognito_user:', email);
          }
        }
      } catch (e) {
        console.warn('[Wiki] Error parsing stored cognito_user:', e);
      }

      // Cognito認証からIDまたはメールアドレスを取得
      if (!userId && !email && window.CognitoAuth && window.CognitoAuth.isAuthenticated()) {
        const cognitoUser = await window.CognitoAuth.getCurrentUser();
        if (cognitoUser) {
          if (cognitoUser.id) {
            userId = cognitoUser.id;
            console.log('[Wiki] Using ID from Cognito:', userId);
          } else if (cognitoUser.email) {
            email = cognitoUser.email;
            console.log('[Wiki] Using email from Cognito:', email);
          }
        }
      }

      // メールアドレスからIDを取得（IDが取得できなかった場合）
      if (!userId && email) {
        try {
          // キャッシュを無効化するためにタイムスタンプを追加
          const timestamp = new Date().getTime();
          const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
          
          // まずAWS APIから最新データを取得
          const apiResponse = await fetch(`${API_BASE}/workers?email=${encodeURIComponent(email)}&t=${timestamp}&_=${Date.now()}`, {
            cache: 'no-store'
          });
          if (apiResponse.ok) {
            const workers = await apiResponse.json();
            const workersArray = Array.isArray(workers) ? workers : (workers.items || workers.workers || []);
            if (workersArray.length > 0) {
              const matchingUser = workersArray.find(u => u.email && u.email.toLowerCase() === email.toLowerCase());
              if (matchingUser && matchingUser.id) {
                userId = matchingUser.id;
                console.log('[Wiki] Found ID from API:', userId);
              }
            }
          }
          
          // APIで取得できない場合のみ、ローカルのworkers.jsonをフォールバックとして使用
          if (!userId) {
            console.warn('[Wiki] API取得に失敗、ローカルのworkers.jsonを試行');
            try {
              const localResponse = await fetch(`/data/workers.json?t=${timestamp}&_=${Date.now()}`, {
                cache: 'no-store'
              });
          if (localResponse.ok) {
            const localWorkers = await localResponse.json();
            if (Array.isArray(localWorkers) && localWorkers.length > 0) {
              const matchingUser = localWorkers.find(u => u.email && u.email.toLowerCase() === email.toLowerCase());
              if (matchingUser && matchingUser.id) {
                userId = matchingUser.id;
                    console.log('[Wiki] Found ID from local workers.json (fallback):', userId);
              }
            }
          }
        } catch (e) {
              console.log('[Wiki] Local workers.json also not available');
            }
          }
        } catch (e) {
          console.log('[Wiki] Error fetching user ID:', e);
        }
      }

      // リンクを設定（IDを優先、なければメールアドレス）
      if (userId) {
        mypageLink.href = `/staff/mypage?id=${encodeURIComponent(userId)}`;
        mypageLink.style.display = 'flex';
        console.log('[Wiki] Mypage link set with ID:', userId);
      } else if (email) {
        mypageLink.href = `/staff/mypage?email=${encodeURIComponent(email)}`;
        mypageLink.style.display = 'flex';
        console.log('[Wiki] Mypage link set with email:', email);
      }
    } catch (error) {
      console.error('Error setting up mypage link:', error);
    }
  }

</script>

<script>
  // WIKIデータをJavaScript変数として設定
  window.wikiData = @jsonvar $wikiData;
</script>

<!-- モバイルメニューボタン -->
<div class="mobile-menu-area">
<button class="mobile-menu-button" id="mobile-menu-button" aria-label="メニューを開く">
  <i class="fas fa-bars"></i>
</button>
</div>

<!-- サイドバーオーバーレイ -->
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<!-- サイドバー -->
<aside class="sidebar" id="admin-sidebar">
  <div class="sidebar-header">
    <a href="/staff/mypage" class="logo-link">
      <img src="/images/logo_144x144.png" alt="ミセサポ" class="logo-img" />
      <span class="logo-text">ミセサポ</span>
    </a>
  </div>

  <!-- ロール表示 -->
  <div class="sidebar-role">
    <span class="role-badge" id="sidebar-role-badge">清掃員</span>
  </div>

  <nav class="sidebar-nav">
    <a href="/admin/dashboard" class="nav-item nav-item-admin" data-page="dashboard" data-role-required="admin,operation,general_affairs" style="display: none;">
      <i class="fas fa-tachometer-alt"></i>
      <span class="nav-label">管理ダッシュボード</span>
    </a>
    <div class="nav-divider" data-role-required="admin,operation,general_affairs" style="display: none;"></div>
    <a href="/staff/mypage" class="nav-item" data-page="mypage">
      <i class="fas fa-user-circle"></i>
      <span class="nav-label">マイページ</span>
    </a>
    <a href="/staff/attendance-history" class="nav-item" data-page="attendance-history">
      <i class="fas fa-history"></i>
      <span class="nav-label">出勤履歴</span>
    </a>
    <a href="/staff/daily-reports" class="nav-item" data-page="daily-reports">
      <i class="fas fa-edit"></i>
      <span class="nav-label">日報</span>
    </a>
    <a href="/staff/schedule" class="nav-item" data-page="schedule">
      <i class="fas fa-calendar-alt"></i>
      <span class="nav-label">スケジュール</span>
    </a>
    <a href="/staff/work-history" class="nav-item" data-page="work-history">
      <i class="fas fa-clipboard-list"></i>
      <span class="nav-label">作業履歴</span>
    </a>
    <a href="/staff/reports/new" class="nav-item" data-page="reports">
      <i class="fas fa-file-alt"></i>
      <span class="nav-label">レポート</span>
    </a>
    <a href="/wiki" class="nav-item active" data-page="wiki">
      <i class="fas fa-book-open"></i>
      <span class="nav-label">WIKI</span>
    </a>
    <a href="/cleaning-manual" class="nav-item" data-page="cleaning-manual">
      <i class="fas fa-book"></i>
      <span class="nav-label">清掃マニュアル</span>
    </a>
    <a href="/staff/announcements" class="nav-item" data-page="announcements">
      <i class="fas fa-bullhorn"></i>
      <span class="nav-label">業務連絡</span>
    </a>
    <div class="nav-divider"></div>
    <a href="/staff/mypage/settings" class="nav-item" data-page="settings">
      <i class="fas fa-cog"></i>
      <span class="nav-label">設定</span>
    </a>
    <a href="/signin" class="nav-item" data-page="signin">
      <i class="fas fa-sign-in-alt"></i>
      <span class="nav-label">ログイン</span>
    </a>
    <button class="nav-item nav-item-button" onclick="staffLogout()">
      <i class="fas fa-sign-out-alt"></i>
      <span class="nav-label">ログアウト</span>
    </button>
    
    <!-- マイページ編集用ボタン -->
    <div class="nav-divider"></div>
    <div class="sidebar-mypage-actions">
    </div>
  </nav>

  <!-- トグルボタン -->
  <button class="sidebar-toggle" id="sidebar-toggle" aria-label="サイドバーを開閉">
    <i class="fas fa-chevron-left"></i>
  </button>
</aside>

<main id="main" class="wiki-page">

  <!-- メインコンテンツ -->
  <div class="main-content">
    <!-- ヘッダー -->
    <header class="wiki-page-header">
      <div class="wiki-header-content">
        <div>
          <h1>ミセサポ システム用語辞典</h1>
          <p class="wiki-subtitle">開発者ではない事務の方でも理解できるよう、システムの要点と専門用語をわかりやすく説明します。</p>
        </div>
        <button class="btn-new-wiki" id="btn-new-wiki" title="新しいWIKIを追加">
          <i class="fas fa-plus"></i>
          <span>新規追加</span>
        </button>
      </div>
    </header>

    <!-- 検索・フィルター -->
    <div class="wiki-filters">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="wiki-search" placeholder="WIKIを検索..." />
        <button class="search-clear" id="search-clear" style="display: none;">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="filter-group">
        <div class="category-filters" id="category-filters">
          <button class="filter-chip active" data-category="all">
            <i class="fas fa-th"></i>
            <span>すべて</span>
          </button>
        </div>
      </div>

      <!-- アクティブなフィルター表示 -->
      <div class="active-filters" id="active-filters" style="display: none;">
        <span class="active-filters-label">適用中のフィルター:</span>
        <div class="active-filters-list" id="active-filters-list"></div>
        <button class="clear-all-filters" id="clear-all-filters">
          <i class="fas fa-times"></i>
          <span>すべてクリア</span>
        </button>
      </div>

      <!-- タグクラウド -->
      <div class="tag-cloud-section">
        <h3 class="tag-cloud-title">
          <i class="fas fa-tags"></i>
          <span>タグで絞り込む</span>
        </h3>
        <div class="tag-cloud" id="tag-cloud">
          <!-- タグクラウドはJavaScriptで動的に生成 -->
        </div>
      </div>
    </div>

    <!-- パンくずリスト -->
    <nav class="breadcrumb" id="breadcrumb" style="display: none;">
      <a href="#" class="breadcrumb-item" data-action="home">
        <i class="fas fa-home"></i>
        <span>ホーム</span>
      </a>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-current" id="breadcrumb-current"></span>
    </nav>

    <!-- コンテンツエリア -->
    <div class="wiki-content-area">
      <!-- グリッドビュー -->
      <div class="wiki-grid-view" id="wiki-grid-view">
        <div class="wiki-grid" id="wiki-grid">
          <!-- カードはJavaScriptで動的に生成 -->
        </div>
        <div class="wiki-empty" id="wiki-empty" style="display: none;">
          <i class="fas fa-search"></i>
          <p>検索結果が見つかりませんでした</p>
        </div>
      </div>

      <!-- 詳細ビュー -->
      <div class="wiki-detail-view" id="wiki-detail-view" style="display: none;">
        <div class="wiki-detail-content" id="wiki-detail-content">
          <!-- 詳細コンテンツはJavaScriptで動的に生成 -->
        </div>
      </div>
    </div>
  </div>
</main>

<!-- 新規作成モーダル -->
<div class="wiki-modal" id="wiki-new-modal" style="display: none;">
  <div class="wiki-modal-overlay" id="wiki-modal-overlay"></div>
  <div class="wiki-modal-content">
    <div class="wiki-modal-header">
      <h2>新しいWIKIを追加</h2>
      <button class="wiki-modal-close" id="wiki-modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form id="wiki-new-form" class="wiki-form">
      <div class="form-group">
        <label for="wiki-title">タイトル <span class="required">*</span></label>
        <input type="text" id="wiki-title" name="title" required placeholder="例: システム概要" />
      </div>

      <div class="form-group">
        <label for="wiki-description">説明</label>
        <textarea id="wiki-description" name="description" rows="3" placeholder="このWIKIの説明を入力してください"></textarea>
      </div>

      <div class="form-group">
        <label for="wiki-category">カテゴリ <span class="required">*</span></label>
        <select id="wiki-category" name="category" required>
          <option value="">選択してください</option>
        </select>
      </div>

      <div class="form-group">
        <label for="wiki-icon">アイコン</label>
        <div class="icon-selector">
          <input type="text" id="wiki-icon" name="icon" placeholder="fas fa-book" value="fas fa-book" />
          <div class="icon-preview">
            <i id="icon-preview" class="fas fa-book"></i>
          </div>
        </div>
        <small class="form-hint">Font Awesomeのアイコンクラスを入力（例: fas fa-book）</small>
      </div>

      <div class="form-group">
        <label for="wiki-tags">タグ</label>
        <input type="text" id="wiki-tags" name="tags" placeholder="用語, 辞典, 専門（カンマ区切り）" />
        <small class="form-hint">カンマ区切りで複数のタグを入力できます</small>
      </div>

      <div class="form-group">
        <label for="wiki-content-section">コンテンツセクションID</label>
        <input type="text" id="wiki-content-section" name="content" required placeholder="例: new-glossary-term" />
        <small class="form-hint">このWIKIのコンテンツを識別するID（英数字とハイフンのみ）</small>
      </div>

      <div class="form-group">
        <label for="wiki-content-body">コンテンツ本文 <span class="required">*</span></label>
        <textarea id="wiki-content-body" name="contentBody" rows="15" required placeholder="WIKIの内容を入力してください（Markdown形式対応）&#10;&#10;例:&#10;# 見出し1&#10;## 見出し2&#10;**太字** *斜体*&#10;- リスト項目1&#10;- リスト項目2"></textarea>
        <small class="form-hint">
          Markdown形式で記述できます。<br>
          <strong>#</strong> 見出し1、<strong>##</strong> 見出し2、<strong>**太字**</strong>、<strong>*斜体*</strong>、<strong>-</strong> リスト
        </small>
      </div>

      <div class="form-group">
        <label class="checkbox-label">
          <input type="checkbox" id="wiki-featured" name="featured" />
          <span>おすすめとして表示</span>
        </label>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancel" id="wiki-form-cancel">キャンセル</button>
        <button type="submit" class="btn-submit">作成</button>
      </div>
    </form>
  </div>
</div>

<!-- データテンプレート（非表示） -->
<div id="wiki-data" style="display: none;">
  <!-- システム概要 -->
  <div data-section="overview" class="wiki-section-content">
    <h2>1. システム概要</h2>
    <div class="wiki-card">
      <h3>ミセサポとは</h3>
      <p>ミセサポは、店舗清掃サービスを管理するためのWebアプリケーション（ウェブサイト）です。お客様、清掃員、営業担当、管理者など、それぞれの立場の人が使える機能を提供しています。</p>
      
      <h4>主な機能</h4>
      <ul>
        <li><strong>お客様向け</strong>: サービスを注文したり、清掃レポートを確認したりできます</li>
        <li><strong>清掃員向け</strong>: 作業予定を確認したり、作業レポートを作成したりできます</li>
        <li><strong>営業担当向け</strong>: お客様を管理したり、見積もりを作成したりできます</li>
        <li><strong>管理者向け</strong>: システム全体を管理し、すべての情報を確認できます</li>
      </ul>
    </div>
  </div>

  <!-- ロールについて -->
  <div data-section="roles" class="wiki-section-content">
    <h2>2. ロール（役割）について</h2>
    <p class="wiki-intro">ロールとは、システムを使う人の「役割」のことです。ロールによって、見られるページや使える機能が変わります。</p>

    <div class="roles-grid">
      <div class="role-card">
        <div class="role-badge customer">顧客</div>
        <h3>customer（顧客・お客様）</h3>
        <p><strong>誰のこと？</strong> 清掃サービスを利用するお客様（個人・法人）</p>
        <p><strong>できること</strong></p>
        <ul>
          <li>サービスを注文する</li>
          <li>清掃レポートを確認する</li>
          <li>スケジュールを確認する</li>
          <li>マイページで情報を管理する</li>
        </ul>
      </div>

      <div class="role-card">
        <div class="role-badge staff">清掃員</div>
        <h3>staff（清掃員）</h3>
        <p><strong>誰のこと？</strong> 実際に清掃作業を行うスタッフ</p>
        <p><strong>できること</strong></p>
        <ul>
          <li>作業予定を確認する</li>
          <li>作業レポートを作成する</li>
          <li>作業前後の写真をアップロードする</li>
          <li>研修動画を見る</li>
        </ul>
      </div>

      <div class="role-card">
        <div class="role-badge concierge">コンシェルジュ</div>
        <h3>concierge（コンシェルジュ・営業担当）</h3>
        <p><strong>誰のこと？</strong> お客様対応や営業を行う担当者</p>
        <p><strong>できること</strong></p>
        <ul>
          <li>お客様情報を管理する</li>
          <li>見積もりを作成する</li>
          <li>スケジュールを管理する</li>
          <li>発注を管理する</li>
        </ul>
      </div>

      <div class="role-card">
        <div class="role-badge admin">管理者</div>
        <h3>admin（管理者）</h3>
        <p><strong>誰のこと？</strong> システム全体を管理する人</p>
        <p><strong>できること</strong></p>
        <ul>
          <li>すべてのユーザーを管理する</li>
          <li>サービス内容を管理する</li>
          <li>発注を管理する</li>
          <li>レポートを確認・管理する</li>
          <li>システムの設定を変更する</li>
        </ul>
      </div>

      <div class="role-card">
        <div class="role-badge developer">開発者</div>
        <h3>developer（開発者）</h3>
        <p><strong>誰のこと？</strong> システムを作ったり、修正したりする技術者</p>
        <p><strong>できること</strong></p>
        <ul>
          <li>管理者のすべての機能</li>
          <li>サービス変更のレビュー（確認）</li>
          <li>画像の管理</li>
          <li>システムの技術的な設定</li>
        </ul>
      </div>

      <div class="role-card">
        <div class="role-badge master">マスター</div>
        <h3>master（マスター）</h3>
        <p><strong>誰のこと？</strong> システムの最上位権限を持つ人</p>
        <p><strong>できること</strong></p>
        <ul>
          <li>すべての機能にアクセスできる</li>
          <li>システム全体を完全に管理できる</li>
          <li>他のロールのユーザーを作成できる</li>
        </ul>
      </div>
    </div>

    <div class="wiki-note">
      <h4>ロールの階層</h4>
      <p>ロールには階層があり、上位のロールは下位のロールの機能も使えます。</p>
      <div class="hierarchy">
        <div class="hierarchy-item">マスター（最上位）</div>
        <div class="hierarchy-arrow">↓</div>
        <div class="hierarchy-item">開発者</div>
        <div class="hierarchy-arrow">↓</div>
        <div class="hierarchy-item">管理者</div>
        <div class="hierarchy-arrow">↓</div>
        <div class="hierarchy-item">コンシェルジュ</div>
        <div class="hierarchy-arrow">↓</div>
        <div class="hierarchy-item">清掃員・顧客（同レベル）</div>
      </div>
    </div>
  </div>

  <!-- 認証・セキュリティ用語 -->
  <div data-section="glossary-auth" class="wiki-section-content">
    <h2>認証・セキュリティ用語</h2>
    <p class="wiki-intro">ログインや権限管理に関する用語を説明します。</p>

    <div class="glossary-list">
      <div class="glossary-item">
        <h3>認証（にんしょう）</h3>
        <p><strong>読み方</strong>: にんしょう</p>
        <p><strong>意味</strong>: 「あなたは本当にこの人ですか？」を確認すること。ログインするときに、メールアドレスとパスワードで本人確認をします。</p>
        <p><strong>関連用語</strong>: ログイン、パスワード</p>
      </div>

      <div class="glossary-item">
        <h3>権限（けんげん）</h3>
        <p><strong>読み方</strong>: けんげん</p>
        <p><strong>意味</strong>: その人が「何をできるか」を決めるもの。ロールによって権限が変わります。</p>
        <p><strong>例</strong>: 管理者はすべての情報を見られますが、清掃員は自分の作業に関係する情報だけ見られます。</p>
      </div>

      <div class="glossary-item">
        <h3>ログイン（Login）</h3>
        <p><strong>読み方</strong>: ログイン</p>
        <p><strong>意味</strong>: システムを使うために、メールアドレスとパスワードを入力して本人確認をすること。</p>
        <p><strong>関連用語</strong>: 認証、ログアウト</p>
      </div>

      <div class="glossary-item">
        <h3>ログアウト（Logout）</h3>
        <p><strong>読み方</strong>: ログアウト</p>
        <p><strong>意味</strong>: システムの使用を終了すること。セキュリティのため、使い終わったらログアウトしましょう。</p>
      </div>

      <div class="glossary-item">
        <h3>ロール（Role）</h3>
        <p><strong>読み方</strong>: ロール</p>
        <p><strong>意味</strong>: システムを使う人の「役割」。顧客、清掃員、管理者など、それぞれの役割によって使える機能が変わります。</p>
        <p><strong>関連用語</strong>: 権限</p>
      </div>
    </div>
  </div>

  <!-- クラウド・インフラ用語 -->
  <div data-section="glossary-cloud" class="wiki-section-content">
    <h2>クラウド・インフラ用語</h2>
    <p class="wiki-intro">クラウドサービスやインフラに関する用語を説明します。</p>

    <div class="glossary-list">
      <div class="glossary-item">
        <h3>クラウド（Cloud）</h3>
        <p><strong>読み方</strong>: クラウド</p>
        <p><strong>意味</strong>: インターネット上にあるコンピューターやサービス。自分のパソコンではなく、インターネット上でデータを保存したり、処理したりします。</p>
        <p><strong>例</strong>: AWS（アマゾンのクラウドサービス）、Azure（マイクロソフトのクラウドサービス）</p>
      </div>

      <div class="glossary-item">
        <h3>AWS（エーダブリューエス）</h3>
        <p><strong>読み方</strong>: エーダブリューエス</p>
        <p><strong>意味</strong>: Amazon Web Servicesの略。アマゾンが提供するクラウドサービス。データベース、ファイル保存、サーバーなど、さまざまなサービスを提供します。</p>
        <p><strong>関連用語</strong>: S3、Lambda、DynamoDB、API Gateway</p>
      </div>

      <div class="glossary-item">
        <h3>S3（エススリー）</h3>
        <p><strong>読み方</strong>: エススリー</p>
        <p><strong>意味</strong>: AWSが提供するファイル保存サービス。画像やPDFなどのファイルを保存します。</p>
        <p><strong>例</strong>: 清掃レポートの写真はS3に保存されます。</p>
      </div>

      <div class="glossary-item">
        <h3>Lambda（ラムダ）</h3>
        <p><strong>読み方</strong>: ラムダ</p>
        <p><strong>意味</strong>: AWSが提供するサービス。プログラムを実行するための「関数」のようなもの。データを処理したり、APIの処理を行ったりします。</p>
        <p><strong>例</strong>: レポートを保存するとき、Lambda関数がデータを処理してデータベースに保存します。</p>
      </div>

      <div class="glossary-item">
        <h3>DynamoDB（ダイナモディービー）</h3>
        <p><strong>読み方</strong>: ダイナモディービー</p>
        <p><strong>意味</strong>: AWSが提供するデータベースサービス。お客様情報やレポートなどのデータを保存します。</p>
      </div>

      <div class="glossary-item">
        <h3>API Gateway（エーピーアイゲートウェイ）</h3>
        <p><strong>読み方</strong>: エーピーアイゲートウェイ</p>
        <p><strong>意味</strong>: APIへのアクセスを管理する「門番」のようなもの。誰がアクセスできるか、どのような情報をやり取りできるかを制御します。</p>
      </div>

      <div class="glossary-item">
        <h3>Firebase（ファイアベース）</h3>
        <p><strong>読み方</strong>: ファイアベース</p>
        <p><strong>意味</strong>: Googleが提供するサービス。認証（ログイン機能）やデータベースなど、さまざまな機能を提供します。</p>
        <p><strong>関連用語</strong>: Firebase Authentication（認証機能）、Firestore（データベース機能）</p>
      </div>

      <div class="glossary-item">
        <h3>Firestore（ファイアストア）</h3>
        <p><strong>読み方</strong>: ファイアストア</p>
        <p><strong>意味</strong>: Firebaseが提供するデータベースサービス。現在はAWSのDynamoDBに移行中です。</p>
      </div>
    </div>
  </div>

  <!-- データ管理用語 -->
  <div data-section="glossary-data" class="wiki-section-content">
    <h2>データ管理用語</h2>
    <p class="wiki-intro">データの保存や管理に関する用語を説明します。</p>

    <div class="glossary-list">
      <div class="glossary-item">
        <h3>データベース（Database）</h3>
        <p><strong>読み方</strong>: データベース</p>
        <p><strong>意味</strong>: 情報を整理して保存しておく場所。Excelの表のようなものですが、もっと大量のデータを効率的に管理できます。</p>
        <p><strong>例</strong>: DynamoDB（AWSのデータベース）、Firestore（Googleのデータベース）</p>
        <p><strong>データの変更の流れ</strong>: ブラウザでユーザー情報を変更した場合、まずAPIに申告（リクエスト）し、APIがデータベースに保存します。APIからの認可（成功レスポンス）が降りるまで、ブラウザの表示は変更されません。認可が降りたら、APIから最新データを取得して画面を更新します。</p>
      </div>

      <div class="glossary-item">
        <h3>JSON（ジェイソン）</h3>
        <p><strong>読み方</strong>: ジェイソン</p>
        <p><strong>意味</strong>: データを保存する形式の一つ。テキストファイルで、人間が読める形式でデータを保存します。</p>
        <p><strong>例</strong>: お客様情報をJSON形式で保存すると、{ "name": "山田太郎", "email": "yamada@example.com" } のような形式になります。</p>
      </div>

      <div class="glossary-item">
        <h3>マスターデータ</h3>
        <p><strong>読み方</strong>: マスターデータ</p>
        <p><strong>意味</strong>: 基本的な情報で、あまり変更されないデータ。お客様の店舗情報やサービス一覧などが該当します。</p>
        <p><strong>例</strong>: 店舗情報、サービス一覧、清掃員の基本情報</p>
      </div>

      <div class="glossary-item">
        <h3>トランザクションデータ</h3>
        <p><strong>読み方</strong>: トランザクションデータ</p>
        <p><strong>意味</strong>: 頻繁に追加・更新されるデータ。作業予定やレポートなど、日々増えていくデータです。</p>
        <p><strong>例</strong>: 作業予定、清掃レポート、メッセージ</p>
      </div>
    </div>
  </div>

  <!-- 開発・運用用語 -->
  <div data-section="glossary-dev" class="wiki-section-content">
    <h2>開発・運用用語</h2>
    <p class="wiki-intro">システム開発や運用に関する用語を説明します。</p>

    <div class="glossary-list">
      <div class="glossary-item">
        <h3>API（エーピーアイ）</h3>
        <p><strong>読み方</strong>: エーピーアイ</p>
        <p><strong>意味</strong>: アプリケーション同士が情報をやり取りするための仕組み。システムの「窓口」のようなもの。</p>
        <p><strong>例</strong>: 清掃レポートのデータを取得するとき、APIを通じてデータを取得します。</p>
        <p><strong>わかりやすい例え</strong>: APIは「貯蔵庫の受付」のようなものです。データは貯蔵庫（DynamoDB）に保管されていますが、データを取り出すにも、データを格納するにも、必ず受付（API）を通らなければなりません。直接貯蔵庫にアクセスすることはできません。</p>
      </div>

      <div class="glossary-item">
        <h3>CORS（コース）</h3>
        <p><strong>読み方</strong>: コース</p>
        <p><strong>意味</strong>: 異なるウェブサイト間でデータをやり取りするためのセキュリティの仕組み。安全にデータを共有するためのルールです。</p>
      </div>

      <div class="glossary-item">
        <h3>GitHub（ギットハブ）</h3>
        <p><strong>読み方</strong>: ギットハブ</p>
        <p><strong>意味</strong>: プログラムのコードを保存・管理するサービス。複数の人が協力してシステムを作るときに使います。</p>
      </div>

      <div class="glossary-item">
        <h3>デプロイ（Deploy）</h3>
        <p><strong>読み方</strong>: デプロイ</p>
        <p><strong>意味</strong>: 作ったシステムを実際に使えるように公開すること。「本番環境に反映する」という意味です。</p>
        <p><strong>例</strong>: 新しい機能を追加したら、デプロイして実際のサイトに反映します。</p>
      </div>
    </div>
  </div>

  <!-- システム機能用語 -->
  <div data-section="glossary-system" class="wiki-section-content">
    <h2>システム機能用語</h2>
    <p class="wiki-intro">システムの機能や操作に関する用語を説明します。</p>

    <div class="glossary-list">
      <div class="glossary-item">
        <h3>スケジュール（Schedule）</h3>
        <p><strong>読み方</strong>: スケジュール</p>
        <p><strong>意味</strong>: 作業予定のこと。いつ、どこで、誰が清掃作業を行うかを管理します。</p>
      </div>

      <div class="glossary-item">
        <h3>レポート（Report）</h3>
        <p><strong>読み方</strong>: レポート</p>
        <p><strong>意味</strong>: 清掃作業の報告書。作業内容や作業前後の写真が含まれます。</p>
      </div>

      <div class="glossary-item">
        <h3>UI（ユーアイ）</h3>
        <p><strong>読み方</strong>: ユーアイ</p>
        <p><strong>意味</strong>: ユーザーインターフェースの略。システムの画面や操作の見た目のことです。</p>
        <p><strong>例</strong>: ボタンのデザイン、メニューの配置など</p>
      </div>
    </div>
  </div>

  <!-- 旧専門用語辞典（削除予定） -->
  <div data-section="glossary" class="wiki-section-content" style="display: none;">
    <h2>3. 専門用語辞典</h2>
    <p class="wiki-intro">システムで使われる専門用語を、わかりやすく説明します。</p>

    <div class="glossary-list">
    </div>
  </div>

  <!-- 主要機能の説明 -->
  <div data-section="features" class="wiki-section-content">
    <h2>4. 主要機能の説明</h2>

    <div class="feature-card">
      <h3>ダッシュボード</h3>
      <p>システムにログインしたときに最初に表示される画面。重要な情報や統計が一目でわかるように表示されます。</p>
      <p><strong>例</strong>: 今日の清掃予定数、今月の清掃件数、通知など</p>
    </div>

    <div class="feature-card">
      <h3>顧客管理</h3>
      <p>お客様の情報を管理する機能。店舗情報、連絡先、契約情報などを登録・編集・確認できます。</p>
    </div>

    <div class="feature-card">
      <h3>スケジュール管理</h3>
      <p>清掃作業の予定を管理する機能。いつ、どこで、誰が作業するかを登録し、カレンダー形式で確認できます。</p>
    </div>

    <div class="feature-card">
      <h3>レポート管理</h3>
      <p>清掃作業の報告書を管理する機能。清掃員が作成したレポートを確認したり、お客様に公開したりできます。</p>
    </div>

    <div class="feature-card">
      <h3>発注管理</h3>
      <p>お客様からのサービス注文を管理する機能。注文内容を確認し、処理状況を管理します。</p>
    </div>

    <div class="feature-card">
      <h3>ユーザー管理</h3>
      <p>システムを使う人（ユーザー）を管理する機能。新しいユーザーを追加したり、権限を変更したりできます。</p>
    </div>

    <div class="feature-card">
      <h3>サービス管理</h3>
      <p>提供する清掃サービスの内容を管理する機能。サービス名、料金、説明などを登録・編集できます。</p>
    </div>
  </div>

  <!-- データ構造の説明 -->
  <div data-section="data" class="wiki-section-content">
    <h2>5. データ構造の簡単な説明</h2>
    <p class="wiki-intro">システムで管理しているデータの種類と、どこに保存されているかを説明します。</p>

    <div class="data-card">
      <h3>マスターデータ（基本情報）</h3>
      <p>あまり変更されない基本的な情報です。</p>
      <ul>
        <li><strong>店舗情報</strong>: お客様の店舗名、住所、連絡先など</li>
        <li><strong>サービス一覧</strong>: 提供する清掃サービスの内容</li>
        <li><strong>ユーザー情報</strong>: システムを使う人の基本情報</li>
        <li><strong>清掃員情報</strong>: 清掃スタッフの基本情報</li>
      </ul>
      <p><strong>保存場所</strong>: データベース（DynamoDB）またはJSONファイル</p>
    </div>

    <div class="data-card">
      <h3>トランザクションデータ（日々のデータ）</h3>
      <p>日々追加・更新されるデータです。</p>
      <ul>
        <li><strong>スケジュール</strong>: 作業予定（年間10,000件以上）</li>
        <li><strong>レポート</strong>: 作業報告書（年間10,000件以上）</li>
        <li><strong>契約</strong>: お客様との契約情報（500件以上）</li>
        <li><strong>メッセージ</strong>: 通知や連絡（年間50,000件以上）</li>
      </ul>
      <p><strong>保存場所</strong>: データベース（DynamoDB）</p>
    </div>

    <div class="data-card">
      <h3>ファイルデータ（画像・文書）</h3>
      <p>画像やPDFなどのファイルです。</p>
      <ul>
        <li><strong>レポート画像</strong>: 作業前後の写真</li>
        <li><strong>契約書類</strong>: PDFなどの文書</li>
        <li><strong>研修動画</strong>: 清掃員向けの動画</li>
      </ul>
      <p><strong>保存場所</strong>: S3（ファイル保存サービス）</p>
    </div>
  </div>
</div>

<style>
  :root {
    --sidebar-width: 240px;
    --sidebar-width-collapsed: 64px;
    --wiki-primary: #3b82f6;
    --wiki-primary-hover: #2563eb;
    --wiki-bg: #f9fafb;
    --wiki-card-bg: #ffffff;
    --wiki-border: #e5e7eb;
    --wiki-text: #111827;
    --wiki-text-light: #6b7280;
  }

  .wiki-page {
    display: flex;
    min-height: 100vh;
    background: var(--wiki-bg);
  }

  /* サイドバー（管理画面と同じスタイル） */
  .sidebar {
    width: var(--sidebar-width);
    background: #fff;
    border-right: 1px solid var(--wiki-border);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: 100;
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    transition: width 0.3s ease;
    overflow: hidden;
  }
  .sidebar.collapsed {
    width: var(--sidebar-width-collapsed);
  }
  .sidebar.collapsed .nav-label,
  .sidebar.collapsed .logo-text,
  .sidebar.collapsed .sidebar-role {
    opacity: 0;
    width: 0;
    overflow: hidden;
  }
  .sidebar.collapsed .sidebar-toggle i {
    transform: rotate(180deg);
  }
        padding: 16px;
    border-bottom: 1px solid var(--wiki-border);
    min-height: 64px;
    display: flex;
    align-items: center;
  }
  .logo-link {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: inherit;
  }
  .logo-img {
    width: 32px;
    height: 32px;
    object-fit: contain;
    flex-shrink: 0;
  }
  .logo-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--wiki-text);
    white-space: nowrap;
    transition: opacity 0.3s ease;
  }
        padding: 6px 16px;
    border-bottom: 1px solid var(--wiki-border);
    transition: opacity 0.3s ease;
  }
        padding: 3px 10px;
    background: #e0e7ff;
    color: #3730a3;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
  }
        gap: 1px;
    overflow-y: auto;
  }
        padding: 8px 10px;
    color: #6b7280;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .nav-item-button {
    background: none;
    border: none;
    cursor: pointer;
    width: 100%;
    text-align: left;
  }
  .nav-item:hover {
    background: #f3f4f6;
    color: var(--wiki-text);
  }
  .nav-item.active {
    background: var(--primary);
    color: #fff;
  }
        width: 18px;
    text-align: center;
    flex-shrink: 0;
  }
  .nav-label {
    transition: opacity 0.3s ease;
    white-space: nowrap;
      font-size: 0.8125rem;
  }
  .sidebar-toggle {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 28px;
    height: 28px;
    border: 1px solid var(--wiki-border);
    border-radius: 50%;
    background: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    transition: all 0.2s;
    z-index: 200;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .sidebar-toggle:hover {
    background: #f3f4f6;
    border-color: var(--primary);
    color: var(--primary);
  }
  .sidebar-toggle i {
    transition: transform 0.3s ease;
  }
  .sidebar.collapsed .sidebar-toggle {
    right: 18px;
  }
  .nav-divider {
    height: 1px;
    background: var(--wiki-border);
    margin: 8px 12px;
  }

  /* メインコンテンツ */
  .main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: 0;
    background: var(--wiki-bg);
    transition: margin-left 0.3s ease;
  }
  .sidebar.collapsed ~ .main-content {
    margin-left: var(--sidebar-width-collapsed);
  }

  /* ページヘッダー */
  .wiki-page-header {
    background: var(--wiki-card-bg);
    border-bottom: 1px solid var(--wiki-border);
    padding: 32px 40px;
    margin-bottom: 0;
  }
  .wiki-header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 24px;
  }
  .wiki-page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--wiki-text);
    margin: 0 0 8px 0;
  }
  .wiki-subtitle {
    font-size: 1rem;
    color: var(--wiki-text-light);
    margin: 0;
    line-height: 1.6;
  }
  .btn-new-wiki {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    background: var(--wiki-primary);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .btn-new-wiki:hover {
    background: var(--wiki-primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }

  /* フィルター */
  .wiki-filters {
    background: var(--wiki-card-bg);
    border-bottom: 1px solid var(--wiki-border);
    padding: 24px 40px;
  }
  .search-box {
    position: relative;
    max-width: 600px;
    margin-bottom: 20px;
  }
  .search-box i {
    position: absolute;
    left: 16px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--wiki-text-light);
  }
  .search-box input {
    width: 100%;
    padding: 12px 16px 12px 48px;
    border: 2px solid var(--wiki-border);
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.2s;
  }
  .search-box input:focus {
    outline: none;
    border-color: var(--wiki-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  .search-clear {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--wiki-text-light);
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .search-clear:hover {
    color: var(--wiki-text);
  }
  .filter-group {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: center;
  }
  .category-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }
  .filter-chip {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: var(--wiki-bg);
    border: 1px solid var(--wiki-border);
    border-radius: 20px;
    font-size: 0.875rem;
    color: var(--wiki-text);
    cursor: pointer;
    transition: all 0.2s;
  }
  .filter-chip:hover {
    background: #f3f4f6;
    border-color: var(--wiki-primary);
  }
  .filter-chip.active {
    background: var(--wiki-primary);
    color: #fff;
    border-color: var(--wiki-primary);
  }
  .filter-chip i {
    font-size: 0.75rem;
  }

  /* アクティブフィルター */
  .active-filters {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 12px;
    margin-top: 16px;
    padding: 12px 16px;
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    border-radius: 8px;
  }
  .active-filters-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--wiki-primary);
  }
  .active-filters-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .active-filter-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: var(--wiki-primary);
    color: #fff;
    border-radius: 16px;
    font-size: 0.875rem;
    font-weight: 500;
  }
  .active-filter-badge .remove {
    cursor: pointer;
    padding: 2px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: background 0.2s;
  }
  .active-filter-badge .remove:hover {
    background: rgba(255, 255, 255, 0.2);
  }
  .clear-all-filters {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: transparent;
    border: 1px solid var(--wiki-primary);
    color: var(--wiki-primary);
    border-radius: 16px;
    font-size: 0.875rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: auto;
  }
  .clear-all-filters:hover {
    background: var(--wiki-primary);
    color: #fff;
  }

  /* タグクラウド */
  .tag-cloud-section {
    margin-top: 24px;
    padding-top: 24px;
    border-top: 1px solid var(--wiki-border);
  }
  .tag-cloud-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 1rem;
    font-weight: 600;
    color: var(--wiki-text);
    margin: 0 0 16px 0;
  }
  .tag-cloud-title i {
    color: var(--wiki-primary);
  }
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    align-items: center;
  }
  .tag-cloud-item {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: #fff;
    border: 2px solid var(--wiki-border);
    border-radius: 20px;
    font-size: 0.875rem;
    color: var(--wiki-text);
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
  }
  .tag-cloud-item:hover {
    border-color: var(--wiki-primary);
    background: #eff6ff;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
  }
  .tag-cloud-item.active {
    background: var(--wiki-primary);
    color: #fff;
    border-color: var(--wiki-primary);
    font-weight: 500;
  }
  .tag-cloud-item .tag-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 20px;
    height: 20px;
    padding: 0 6px;
    background: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .tag-cloud-item.active .tag-count {
    background: rgba(255, 255, 255, 0.3);
  }
  .tag-cloud-item.tag-size-1 { font-size: 0.75rem; }
  .tag-cloud-item.tag-size-2 { font-size: 0.875rem; }
  .tag-cloud-item.tag-size-3 { font-size: 1rem; font-weight: 500; }
  .tag-cloud-item.tag-size-4 { font-size: 1.125rem; font-weight: 600; }
  .tag-cloud-item.tag-size-5 { font-size: 1.25rem; font-weight: 600; }

  /* パンくずリスト */
  .breadcrumb {
    background: var(--wiki-card-bg);
    border-bottom: 1px solid var(--wiki-border);
    padding: 16px 40px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 6px;
    color: var(--wiki-primary);
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.2s;
  }
  .breadcrumb-item:hover {
    color: var(--wiki-primary-hover);
    text-decoration: underline;
  }
  .breadcrumb-separator {
    color: var(--wiki-text-light);
  }
  .breadcrumb-current {
    color: var(--wiki-text);
    font-size: 0.875rem;
    font-weight: 500;
  }

  /* コンテンツエリア */
  .wiki-content-area {
    max-width: 1400px;
    margin: 0 auto;
    padding: 40px;
  }

  /* グリッドビュー */
  .wiki-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 24px;
  }
  .wiki-card-item {
    background: var(--wiki-card-bg);
    border: 1px solid var(--wiki-border);
    border-radius: 12px;
    padding: 24px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
  }
  .wiki-card-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--wiki-primary);
    transform: scaleX(0);
    transition: transform 0.3s;
  }
  .wiki-card-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    border-color: var(--wiki-primary);
  }
  .wiki-card-item:hover::before {
    transform: scaleX(1);
  }
  .wiki-card-item.featured {
    border-color: var(--wiki-primary);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
  }
  .wiki-card-item.featured::before {
    transform: scaleX(1);
  }
  .wiki-card-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .wiki-card-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--wiki-primary), var(--wiki-primary-hover));
    color: #fff;
    border-radius: 10px;
    font-size: 1.5rem;
    flex-shrink: 0;
  }
  .wiki-card-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: #fef3c7;
    color: #92400e;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
  }
  .wiki-card-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--wiki-text);
    margin: 0 0 8px 0;
    line-height: 1.4;
  }
  .wiki-card-description {
    font-size: 0.9375rem;
    color: var(--wiki-text-light);
    line-height: 1.6;
    margin: 0 0 16px 0;
  }
  .wiki-card-footer {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    padding-top: 16px;
    border-top: 1px solid var(--wiki-border);
  }
  .wiki-card-tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--wiki-bg);
    color: var(--wiki-text-light);
    border-radius: 12px;
    font-size: 0.75rem;
    border: 1px solid var(--wiki-border);
    cursor: pointer;
    transition: all 0.2s;
  }
  .wiki-card-tag:hover {
    background: #eff6ff;
    border-color: var(--wiki-primary);
    color: var(--wiki-primary);
    transform: translateY(-1px);
  }
  .wiki-card-category {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    background: var(--wiki-bg);
    color: var(--wiki-text-light);
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
    margin-left: auto;
  }

  .wiki-empty {
    text-align: center;
    padding: 80px 20px;
    color: var(--wiki-text-light);
  }
  .wiki-empty i {
    font-size: 4rem;
    margin-bottom: 16px;
    opacity: 0.3;
  }
  .wiki-empty p {
    font-size: 1.125rem;
    margin: 0;
  }

  /* 詳細ビュー */
  .wiki-detail-view {
    background: var(--wiki-card-bg);
    border-radius: 12px;
    padding: 40px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .wiki-detail-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 32px;
    padding-bottom: 24px;
    border-bottom: 2px solid var(--wiki-border);
  }
  .wiki-detail-back {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--wiki-bg);
    border: 1px solid var(--wiki-border);
    border-radius: 8px;
    color: var(--wiki-text);
    text-decoration: none;
    font-size: 0.9375rem;
    transition: all 0.2s;
  }
  .wiki-detail-back:hover {
    background: #f3f4f6;
    border-color: var(--wiki-primary);
    color: var(--wiki-primary);
  }
  .wiki-detail-content {
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* セクションコンテンツ */
  .wiki-section-content {
    animation: fadeIn 0.3s ease;
  }
  .wiki-section-content h2 {
    font-size: 2rem;
    color: var(--wiki-text);
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--wiki-border);
  }
  .wiki-intro {
    font-size: 1.125rem;
    color: var(--wiki-text-light);
    margin-bottom: 24px;
    line-height: 1.6;
  }
  .wiki-card,
  .feature-card,
  .data-card {
    background: var(--wiki-bg);
    padding: 24px;
    border-radius: 8px;
    margin-bottom: 24px;
    border-left: 4px solid var(--wiki-primary);
  }
  .wiki-card h3,
  .feature-card h3,
  .data-card h3 {
    font-size: 1.5rem;
    color: var(--wiki-text);
    margin-bottom: 12px;
  }
  .wiki-card h4 {
    font-size: 1.25rem;
    color: #374151;
    margin-top: 20px;
    margin-bottom: 12px;
  }
  .wiki-card ul,
  .feature-card ul,
  .data-card ul {
    margin-left: 20px;
    line-height: 1.8;
  }
  .wiki-card li,
  .feature-card li,
  .data-card li {
    margin-bottom: 8px;
  }
  .roles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
  }
  .role-card {
    background: #fff;
    border: 1px solid var(--wiki-border);
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .role-badge {
    display: inline-block;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 12px;
  }
  .role-badge.customer {
    background: #dbeafe;
    color: #1e40af;
  }
  .role-badge.staff {
    background: #dcfce7;
    color: #166534;
  }
  .role-badge.concierge {
    background: #fef3c7;
    color: #92400e;
  }
  .role-badge.admin {
    background: #e0e7ff;
    color: #3730a3;
  }
  .role-badge.developer {
    background: #fce7f3;
    color: #831843;
  }
  .role-badge.master {
    background: #fef2f2;
    color: #991b1b;
  }
  .role-card h3 {
    font-size: 1.25rem;
    color: var(--wiki-text);
    margin-bottom: 12px;
  }
  .role-card p {
    margin-bottom: 12px;
    line-height: 1.6;
  }
  .role-card ul {
    margin-left: 20px;
    line-height: 1.8;
  }
  .wiki-note {
    background: #fef3c7;
    border-left: 4px solid #f59e0b;
    padding: 20px;
    border-radius: 8px;
    margin-top: 32px;
  }
  .wiki-note h4 {
    font-size: 1.125rem;
    color: #92400e;
    margin-bottom: 12px;
  }
  .hierarchy {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
  }
  .hierarchy-item {
    background: #fff;
    padding: 12px 24px;
    border-radius: 6px;
    border: 1px solid var(--wiki-border);
    font-weight: 500;
  }
  .hierarchy-arrow {
    color: var(--wiki-text-light);
    font-size: 1.5rem;
  }
  .glossary-list {
    display: flex;
    flex-direction: column;
    gap: 24px;
  }
  .glossary-item {
    background: #fff;
    border: 1px solid var(--wiki-border);
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .glossary-item h3 {
    font-size: 1.5rem;
    color: var(--wiki-primary);
    margin-bottom: 12px;
  }
  .glossary-item p {
    margin-bottom: 8px;
    line-height: 1.6;
  }
  .glossary-item strong {
    color: var(--wiki-text);
    font-weight: 600;
  }

  /* モーダル */
  .wiki-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .wiki-modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
  }
  .wiki-modal-content {
    position: relative;
    background: var(--wiki-card-bg);
    border-radius: 12px;
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    z-index: 1001;
  }
  .wiki-modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 24px 32px;
    border-bottom: 1px solid var(--wiki-border);
  }
  .wiki-modal-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--wiki-text);
    margin: 0;
  }
  .wiki-modal-close {
    width: 36px;
    height: 36px;
    border: none;
    background: var(--wiki-bg);
    border-radius: 8px;
    color: var(--wiki-text-light);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .wiki-modal-close:hover {
    background: #f3f4f6;
    color: var(--wiki-text);
  }
  .wiki-form {
    padding: 32px;
  }
  .form-group {
    margin-bottom: 24px;
  }
  .form-group label {
    display: block;
    font-size: 0.9375rem;
    font-weight: 500;
    color: var(--wiki-text);
    margin-bottom: 8px;
  }
  .form-group .required {
    color: #ef4444;
  }
  .form-group input[type="text"],
  .form-group input[type="email"],
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--wiki-border);
    border-radius: 8px;
    font-size: 0.9375rem;
    color: var(--wiki-text);
    transition: all 0.2s;
    font-family: inherit;
  }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--wiki-primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }
  .form-hint {
    display: block;
    font-size: 0.875rem;
    color: var(--wiki-text-light);
    margin-top: 6px;
  }
  .icon-selector {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .icon-selector input {
    flex: 1;
  }
  .icon-preview {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--wiki-bg);
    border: 2px solid var(--wiki-border);
    border-radius: 8px;
    font-size: 1.5rem;
    color: var(--wiki-primary);
  }
  .checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
  }
  .checkbox-label input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
  }
  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding-top: 24px;
    border-top: 1px solid var(--wiki-border);
    margin-top: 32px;
  }
  .btn-cancel,
  .btn-submit {
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 0.9375rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
  }
  .btn-cancel {
    background: var(--wiki-bg);
    color: var(--wiki-text);
    border: 2px solid var(--wiki-border);
  }
  .btn-cancel:hover {
    background: #f3f4f6;
  }
  .btn-submit {
    background: var(--wiki-primary);
    color: #fff;
  }
  .btn-submit:hover {
    background: var(--wiki-primary-hover);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
  }
  .btn-submit:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* レスポンシブ */
  @media (max-width: 1200px) {
    .wiki-grid {
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    }
  }

  @media (max-width: 768px) {
    .main-content {
      margin-left: 0;
    }
    .sidebar {
      transform: translateX(-100%);
    }
    .sidebar.collapsed {
      transform: translateX(0);
      width: var(--sidebar-width-collapsed);
    }
    .sidebar.collapsed ~ .main-content {
      margin-left: var(--sidebar-width-collapsed);
    }
    .wiki-page-header {
      padding: 24px 20px;
    }
    .wiki-header-content {
      flex-direction: column;
      align-items: stretch;
    }
    .wiki-filters {
      padding: 20px;
    }
    .wiki-content-area {
      padding: 24px 20px;
    }
    .wiki-grid {
      grid-template-columns: 1fr;
    }
    .wiki-detail-view {
      padding: 24px;
    }
    .roles-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
(function() {
  // サイドバー開閉機能
  const sidebar = document.getElementById('admin-sidebar');
  const sidebarToggle = document.getElementById('sidebar-toggle');
  
  if (sidebar && sidebarToggle) {
    const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
    if (isCollapsed) {
      sidebar.classList.add('collapsed');
    }
    
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      const collapsed = sidebar.classList.contains('collapsed');
      localStorage.setItem('sidebar-collapsed', collapsed);
    });
  }

  // ロール表示の更新
  function updateRoleBadge() {
    const roleBadge = document.getElementById('sidebar-role-badge');
    if (!roleBadge) return;
    
    if (window.Auth && window.Auth.getCurrentUser) {
      const user = window.Auth.getCurrentUser();
      if (user && user.role) {
        const roleConfig = window.RoleConfig?.ROLE_CONFIG;
        const roleInfo = roleConfig?.roles?.[user.role];
        if (roleInfo) {
          roleBadge.textContent = roleInfo.displayName || roleInfo.name || user.role;
          
          const badgeColors = {
            'guest': { bg: '#e5e7eb', color: '#6b7280' },
            'customer': { bg: '#dbeafe', color: '#1e40af' },
            'staff': { bg: '#dcfce7', color: '#166534' },
            'concierge': { bg: '#fef3c7', color: '#92400e' },
            'admin': { bg: '#e0e7ff', color: '#3730a3' },
            'developer': { bg: '#fce7f3', color: '#831843' },
            'master': { bg: '#fef2f2', color: '#991b1b' }
          };
          
          const colors = badgeColors[user.role] || badgeColors['admin'];
          roleBadge.style.background = colors.bg;
          roleBadge.style.color = colors.color;
        }
      }
    } else {
      roleBadge.textContent = '管理者';
    }
  }
  
  updateRoleBadge();
  
  if (window.Auth && window.Auth.onAuthStateChanged) {
    window.Auth.onAuthStateChanged(() => {
      updateRoleBadge();
    });
  }

  // WIKIデータの管理
  let wikiData = window.wikiData || { entries: [], categories: [] };
  let currentView = 'grid'; // 'grid' or 'detail'
  let currentEntry = null;
  let activeCategory = 'all';
  let activeTags = new Set();
  let searchQuery = '';

  // AWSからWIKIデータを読み込む
  async function loadWikiData() {
    if (window.AWSWikiAPI && window.AWSWikiAPI.isAvailable()) {
      try {
        const data = await window.AWSWikiAPI.loadData();
        if (data && data.entries) {
          wikiData = data;
          window.wikiData = wikiData;
          return true;
        }
      } catch (error) {
        console.warn('[Wiki] Failed to load from AWS, using local data:', error);
      }
    }
    return false;
  }

  // カテゴリフィルターの生成
  function renderCategoryFilters() {
    const container = document.getElementById('category-filters');
    if (!container) return;

    // "すべて"ボタンは既にあるので、カテゴリを追加
    wikiData.categories.forEach(category => {
      const button = document.createElement('button');
      button.className = 'filter-chip';
      button.setAttribute('data-category', category.id);
      button.innerHTML = `<i class="${category.icon}"></i><span>${category.name}</span>`;
      button.style.borderLeftColor = category.color;
        button.addEventListener('click', () => {
        document.querySelectorAll('.category-filters .filter-chip').forEach(chip => {
          chip.classList.remove('active');
        });
        button.classList.add('active');
        activeCategory = category.id;
        updateActiveFilters();
        renderWikiGrid();
      });
      container.appendChild(button);
    });
  }

  // MarkdownをHTMLに変換（簡易版）
  function convertMarkdownToHTML(markdown) {
    if (!markdown) return '';
    
    let html = markdown;
    
    // 見出し
    html = html.replace(/^### (.*$)/gim, '<h4>$1</h4>');
    html = html.replace(/^## (.*$)/gim, '<h3>$1</h3>');
    html = html.replace(/^# (.*$)/gim, '<h2>$1</h2>');
    
    // 太字・斜体
    html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // リスト
    html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
    html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    
    // 段落（空行で区切る）
    const paragraphs = html.split(/\n\n+/);
    html = paragraphs.map(p => {
      p = p.trim();
      if (!p) return '';
      // 既にHTMLタグが含まれている場合はそのまま
      if (p.startsWith('<')) return p;
      // リストの場合はそのまま
      if (p.startsWith('<ul>')) return p;
      return '<p>' + p.replace(/\n/g, '<br>') + '</p>';
    }).filter(p => p).join('\n');
    
    return html;
  }

  // タグの使用頻度を計算
  function getTagCounts() {
    const tagCounts = new Map();
    wikiData.entries.forEach(entry => {
      entry.tags.forEach(tag => {
        tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
      });
    });
    return tagCounts;
  }

  // タグクラウドの生成
  function renderTagCloud() {
    const container = document.getElementById('tag-cloud');
    if (!container) return;

    const tagCounts = getTagCounts();
    const sortedTags = Array.from(tagCounts.entries()).sort((a, b) => b[1] - a[1]);
    
    if (sortedTags.length === 0) {
      container.innerHTML = '<p style="color: var(--wiki-text-light);">タグがありません</p>';
      return;
    }

    const maxCount = Math.max(...sortedTags.map(([_, count]) => count));
    const minCount = Math.min(...sortedTags.map(([_, count]) => count));
    const sizeRange = maxCount - minCount || 1;

    container.innerHTML = sortedTags.map(([tag, count]) => {
      // 使用頻度に応じてサイズを決定（1-5の5段階）
      const normalizedCount = (count - minCount) / sizeRange;
      const size = Math.max(1, Math.min(5, Math.ceil(normalizedCount * 4) + 1));
      
      const isActive = activeTags.has(tag);
      
      return `
        <span class="tag-cloud-item ${isActive ? 'active' : ''} tag-size-${size}" data-tag="${tag}">
          <span>${tag}</span>
          <span class="tag-count">${count}</span>
        </span>
      `;
    }).join('');

    // タグクリックイベント
    container.querySelectorAll('.tag-cloud-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.stopPropagation();
        const tag = item.getAttribute('data-tag');
        toggleTag(tag);
      });
    });
  }

  // タグのトグル
  function toggleTag(tag) {
    if (activeTags.has(tag)) {
      activeTags.delete(tag);
    } else {
      activeTags.add(tag);
    }
    updateActiveFilters();
    renderTagCloud();
    renderWikiGrid();
  }

  // アクティブフィルターの表示更新
  function updateActiveFilters() {
    const container = document.getElementById('active-filters');
    const list = document.getElementById('active-filters-list');
    if (!container || !list) return;

    const hasActiveFilters = activeCategory !== 'all' || activeTags.size > 0 || searchQuery;

    if (!hasActiveFilters) {
      container.style.display = 'none';
      return;
    }

    container.style.display = 'flex';
    list.innerHTML = '';

    // カテゴリフィルター
    if (activeCategory !== 'all') {
      const category = wikiData.categories.find(c => c.id === activeCategory);
      if (category) {
        const badge = document.createElement('span');
        badge.className = 'active-filter-badge';
        badge.innerHTML = `
          <i class="${category.icon}"></i>
          <span>${category.name}</span>
          <span class="remove" data-type="category" data-value="${activeCategory}">
            <i class="fas fa-times"></i>
          </span>
        `;
        list.appendChild(badge);
      }
    }

    // タグフィルター
    activeTags.forEach(tag => {
      const badge = document.createElement('span');
      badge.className = 'active-filter-badge';
      badge.innerHTML = `
        <i class="fas fa-tag"></i>
        <span>${tag}</span>
        <span class="remove" data-type="tag" data-value="${tag}">
          <i class="fas fa-times"></i>
        </span>
      `;
      list.appendChild(badge);
    });

    // 検索フィルター
    if (searchQuery) {
      const badge = document.createElement('span');
      badge.className = 'active-filter-badge';
      badge.innerHTML = `
        <i class="fas fa-search"></i>
        <span>検索: "${searchQuery}"</span>
        <span class="remove" data-type="search">
          <i class="fas fa-times"></i>
        </span>
      `;
      list.appendChild(badge);
    }

    // 削除ボタンのイベント
    list.querySelectorAll('.remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const type = btn.getAttribute('data-type');
        const value = btn.getAttribute('data-value');
        
        if (type === 'category') {
          document.querySelector('.category-filters .filter-chip[data-category="all"]')?.click();
        } else if (type === 'tag') {
          toggleTag(value);
        } else if (type === 'search') {
          const searchInput = document.getElementById('wiki-search');
          if (searchInput) {
            searchInput.value = '';
            searchQuery = '';
            const searchClear = document.getElementById('search-clear');
            if (searchClear) searchClear.style.display = 'none';
            updateActiveFilters();
            renderWikiGrid();
          }
        }
      });
    });
  }

  // すべてのフィルターをクリア
  function clearAllFilters() {
    activeCategory = 'all';
    activeTags.clear();
    searchQuery = '';
    
    // UIのリセット
    document.querySelectorAll('.category-filters .filter-chip').forEach(chip => {
      chip.classList.remove('active');
    });
    document.querySelector('.category-filters .filter-chip[data-category="all"]')?.classList.add('active');
    
    const searchInput = document.getElementById('wiki-search');
    if (searchInput) searchInput.value = '';
    const searchClear = document.getElementById('search-clear');
    if (searchClear) searchClear.style.display = 'none';
    
    updateActiveFilters();
    renderTagCloud();
    renderWikiGrid();
  }

  // フィルタリングされたエントリを取得
  function getFilteredEntries() {
    return wikiData.entries.filter(entry => {
      // カテゴリフィルター
      if (activeCategory !== 'all' && entry.category !== activeCategory) {
        return false;
      }

      // タグフィルター
      if (activeTags.size > 0) {
        const hasActiveTag = entry.tags.some(tag => activeTags.has(tag));
        if (!hasActiveTag) return false;
      }

      // 検索フィルター
      if (searchQuery) {
        const query = searchQuery.toLowerCase();
        const matchesTitle = entry.title.toLowerCase().includes(query);
        const matchesDescription = entry.description.toLowerCase().includes(query);
        const matchesTags = entry.tags.some(tag => tag.toLowerCase().includes(query));
        if (!matchesTitle && !matchesDescription && !matchesTags) {
          return false;
        }
      }

      return true;
    });
  }

  // WIKIグリッドのレンダリング
  function renderWikiGrid() {
    const grid = document.getElementById('wiki-grid');
    const empty = document.getElementById('wiki-empty');
    if (!grid || !empty) return;

    const entries = getFilteredEntries();

    if (entries.length === 0) {
      grid.style.display = 'none';
      empty.style.display = 'block';
      return;
    }

    grid.style.display = 'grid';
    empty.style.display = 'none';

    grid.innerHTML = entries.map(entry => {
      const category = wikiData.categories.find(c => c.id === entry.category) || {};
      const categoryColor = category.color || '#6b7280';
      
      return `
        <div class="wiki-card-item ${entry.featured ? 'featured' : ''}" data-entry-id="${entry.id}">
          <div class="wiki-card-header">
            <div class="wiki-card-icon" style="background: linear-gradient(135deg, ${categoryColor}, ${categoryColor}dd);">
              <i class="${entry.icon}"></i>
            </div>
            ${entry.featured ? '<span class="wiki-card-badge"><i class="fas fa-star"></i> おすすめ</span>' : ''}
          </div>
          <h3 class="wiki-card-title">${entry.title}</h3>
          <p class="wiki-card-description">${entry.description}</p>
          <div class="wiki-card-footer">
            ${entry.tags.map(tag => `<span class="wiki-card-tag" data-tag="${tag}">${tag}</span>`).join('')}
            <span class="wiki-card-category" style="color: ${categoryColor};">
              <i class="${category.icon || 'fas fa-folder'}"></i>
              ${entry.category}
            </span>
          </div>
        </div>
      `;
    }).join('');

    // カードクリックイベント
    grid.querySelectorAll('.wiki-card-item').forEach(card => {
      card.addEventListener('click', (e) => {
        // タグクリック時はフィルター処理
        if (e.target.classList.contains('wiki-card-tag') || e.target.closest('.wiki-card-tag')) {
          e.stopPropagation();
          const tag = e.target.closest('.wiki-card-tag')?.getAttribute('data-tag');
          if (tag) {
            toggleTag(tag);
          }
          return;
        }
        
        const entryId = card.getAttribute('data-entry-id');
        showWikiDetail(entryId);
      });
    });
  }

  // WIKI詳細の表示
  function showWikiDetail(entryId) {
    const entry = wikiData.entries.find(e => e.id === entryId);
    if (!entry) return;

    currentEntry = entry;
    currentView = 'detail';

    // ビューの切り替え
    document.getElementById('wiki-grid-view').style.display = 'none';
    document.getElementById('wiki-detail-view').style.display = 'block';

    // パンくずリスト
    const breadcrumb = document.getElementById('breadcrumb');
    const breadcrumbCurrent = document.getElementById('breadcrumb-current');
    if (breadcrumb && breadcrumbCurrent) {
      breadcrumb.style.display = 'flex';
      breadcrumbCurrent.textContent = entry.title;
    }

    // 詳細コンテンツの取得
    const dataContainer = document.getElementById('wiki-data');
    const sectionContent = dataContainer.querySelector(`[data-section="${entry.content}"]`);
    
    const detailContent = document.getElementById('wiki-detail-content');
    if (detailContent && sectionContent) {
      detailContent.innerHTML = `
        <div class="wiki-detail-header">
          <a href="#" class="wiki-detail-back" id="wiki-detail-back">
            <i class="fas fa-arrow-left"></i>
            <span>一覧に戻る</span>
          </a>
        </div>
        ${sectionContent.innerHTML}
      `;

      // 戻るボタンのイベント
      const backButton = document.getElementById('wiki-detail-back');
      if (backButton) {
        backButton.addEventListener('click', (e) => {
          e.preventDefault();
          showWikiGrid();
        });
      }
    }

    // URLハッシュを更新
    window.history.pushState({ entryId }, '', `#${entryId}`);
  }

  // WIKIグリッドの表示
  function showWikiGrid() {
    currentView = 'grid';
    currentEntry = null;

    // ビューの切り替え
    document.getElementById('wiki-grid-view').style.display = 'block';
    document.getElementById('wiki-detail-view').style.display = 'none';

    // パンくずリストを非表示
    const breadcrumb = document.getElementById('breadcrumb');
    if (breadcrumb) {
      breadcrumb.style.display = 'none';
    }

    // URLハッシュをクリア
    window.history.pushState({}, '', window.location.pathname);
  }

  // 検索機能
  const searchInput = document.getElementById('wiki-search');
  const searchClear = document.getElementById('search-clear');
  
  if (searchInput) {
    let searchTimeout;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        searchQuery = e.target.value;
        if (searchQuery) {
          searchClear.style.display = 'block';
        } else {
          searchClear.style.display = 'none';
        }
        updateActiveFilters();
        renderWikiGrid();
      }, 300);
    });
  }

  if (searchClear) {
    searchClear.addEventListener('click', () => {
      searchInput.value = '';
      searchQuery = '';
      searchClear.style.display = 'none';
      updateActiveFilters();
      renderWikiGrid();
    });
  }

  // すべてクリアボタン
  const clearAllBtn = document.getElementById('clear-all-filters');
  if (clearAllBtn) {
    clearAllBtn.addEventListener('click', clearAllFilters);
  }

  // 新規追加モーダル
  const btnNewWiki = document.getElementById('btn-new-wiki');
  const modal = document.getElementById('wiki-new-modal');
  const modalOverlay = document.getElementById('wiki-modal-overlay');
  const modalClose = document.getElementById('wiki-modal-close');
  const formCancel = document.getElementById('wiki-form-cancel');
  const wikiForm = document.getElementById('wiki-new-form');
  const iconInput = document.getElementById('wiki-icon');
  const iconPreview = document.getElementById('icon-preview');
  const categorySelect = document.getElementById('wiki-category');

  // カテゴリ選択肢を生成
  if (categorySelect) {
    wikiData.categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category.id;
      option.textContent = category.name;
      categorySelect.appendChild(option);
    });
  }

  // アイコンフィールドの変更時にプレビューを更新
  if (iconInput && iconPreview) {
    iconInput.addEventListener('input', (e) => {
      const iconClass = e.target.value || 'fas fa-book';
      iconPreview.className = iconClass;
    });
  }

  // モーダルを開く
  function openModal() {
    if (modal) {
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
  }

  // モーダルを閉じる
  function closeModal() {
    if (modal) {
      modal.style.display = 'none';
      document.body.style.overflow = '';
      if (wikiForm) {
        wikiForm.reset();
        if (iconPreview) {
          iconPreview.className = 'fas fa-book';
        }
      }
    }
  }

  // モーダル開閉イベント
  if (btnNewWiki) {
    btnNewWiki.addEventListener('click', openModal);
  }
  if (modalOverlay) {
    modalOverlay.addEventListener('click', closeModal);
  }
  if (modalClose) {
    modalClose.addEventListener('click', closeModal);
  }
  if (formCancel) {
    formCancel.addEventListener('click', closeModal);
  }

  // ESCキーでモーダルを閉じる
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
      closeModal();
    }
  });

  // フォーム送信
  if (wikiForm) {
    wikiForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const submitBtn = wikiForm.querySelector('.btn-submit');
      const originalText = submitBtn.textContent;
      
      try {
        submitBtn.disabled = true;
        submitBtn.textContent = '作成中...';

        // フォームデータを取得
        const formData = new FormData(wikiForm);
        const title = formData.get('title');
        const description = formData.get('description') || '';
        const category = formData.get('category');
        const icon = formData.get('icon') || 'fas fa-book';
        const tagsStr = formData.get('tags') || '';
        const contentSection = formData.get('content');
        const contentBody = formData.get('contentBody');
        const featured = formData.get('featured') === 'on';

        // タグを配列に変換
        const tags = tagsStr.split(',').map(tag => tag.trim()).filter(tag => tag);

        // IDを生成（タイトルから英数字とハイフンに変換）
        const id = contentSection || title.toLowerCase()
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .trim();

        // 新しいエントリを作成
        const newEntry = {
          id: id,
          title: title,
          category: category,
          tags: tags,
          description: description,
          icon: icon,
          content: contentSection,
          createdAt: new Date().toISOString().split('T')[0],
          updatedAt: new Date().toISOString().split('T')[0],
          featured: featured
        };

        // データを読み込み
        let currentData = wikiData;
        if (window.AWSWikiAPI && window.AWSWikiAPI.isAvailable()) {
          try {
            currentData = await window.AWSWikiAPI.loadData();
          } catch (error) {
            console.warn('[Wiki] Failed to load from API, using local data:', error);
          }
        }

        // エントリを追加
        if (!currentData.entries) {
          currentData.entries = [];
        }
        currentData.entries.push(newEntry);

        // データを保存
        if (window.AWSWikiAPI && window.AWSWikiAPI.isAvailable()) {
          await window.AWSWikiAPI.saveData(currentData);
        } else {
          // 開発環境の場合はローカルストレージに保存（フォールバック）
          localStorage.setItem('wiki_data_fallback', JSON.stringify(currentData));
          console.warn('[Wiki] API not available, saved to localStorage');
        }

        // wikiDataを更新
        wikiData = currentData;
        window.wikiData = wikiData;

        // コンテンツをデータテンプレートに追加
        const dataContainer = document.getElementById('wiki-data');
        if (dataContainer && contentBody) {
          // 既存のセクションをチェック
          let existingSection = dataContainer.querySelector(`[data-section="${contentSection}"]`);
          if (existingSection) {
            // 既存のセクションを更新
            existingSection.innerHTML = convertMarkdownToHTML(contentBody);
          } else {
            // 新しいセクションを作成
            const contentDiv = document.createElement('div');
            contentDiv.setAttribute('data-section', contentSection);
            contentDiv.className = 'wiki-section-content';
            contentDiv.innerHTML = convertMarkdownToHTML(contentBody);
            dataContainer.appendChild(contentDiv);
          }
        }

        // グリッドを再描画
        renderTagCloud();
        updateActiveFilters();
        renderWikiGrid();

        // モーダルを閉じる
        closeModal();

        // 成功メッセージ
        alert('WIKIを追加しました！');

      } catch (error) {
        console.error('[Wiki] Error creating entry:', error);
        alert('エラーが発生しました: ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  }

  // パンくずリストのホームボタン
  const breadcrumbHome = document.querySelector('.breadcrumb-item[data-action="home"]');
  if (breadcrumbHome) {
    breadcrumbHome.addEventListener('click', (e) => {
      e.preventDefault();
      showWikiGrid();
    });
  }

  // URLハッシュから初期表示
  window.addEventListener('popstate', () => {
    const hash = window.location.hash.replace('#', '');
    if (hash) {
      const entry = wikiData.entries.find(e => e.id === hash);
      if (entry) {
        showWikiDetail(hash);
        return;
      }
    }
    showWikiGrid();
  });

  // 初期化
  (async function() {
    // AWSからデータを読み込む（フォールバック付き）
    await loadWikiData();
    
    renderCategoryFilters();
    renderTagCloud();
    updateActiveFilters();
    renderWikiGrid();
  })();

  // URLハッシュから初期表示
  const hash = window.location.hash.replace('#', '');
  if (hash) {
    const entry = wikiData.entries.find(e => e.id === hash);
    if (entry) {
      showWikiDetail(hash);
    }
  }
  setupMypageLink();
})();
</script>
