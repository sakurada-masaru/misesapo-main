@layout('layouts.base')
@json('data/meta/concierge_title.json', $title)
@json('data/meta/concierge_body_class.json', $body_class)
@json('data/clients.json', clients_data)
@json('data/sales_schedule.json', schedule_data)
@json('data/new_inquiries.json', inquiries_data)
@json('data/estimates.json', estimates_data)
@json('data/service_items.json', service_items_data)

<main id="main" class="concierge-page">
  <!-- 横スライドコンテナ -->
  <div class="concierge-slider-container">
    <div class="concierge-slider" id="concierge-slider">
      
      <!-- 画面1: アクティビティ画面（デフォルト） -->
      <div class="concierge-screen active" data-screen="activity">
        <div class="screen-header">
          <a href="/sales/dashboard.html" class="dashboard-link">
            <i class="fas fa-tachometer-alt"></i>
            <span>ダッシュボード</span>
          </a>
          <h1 class="screen-title">アクティビティ</h1>
  </div>

        <!-- 緊急対応が必要な顧客 -->
        <section class="activity-section urgent-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-exclamation-triangle"></i>
        緊急対応が必要な顧客
      </h2>
      <span class="urgent-badge" id="urgent-count">0</span>
    </div>
    <div class="urgent-list" id="urgent-list">
      <!-- Urgent items will be rendered by JavaScript -->
    </div>
  </section>

        <!-- 本日のスケジュール -->
        <section class="activity-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-calendar-day"></i>
        本日のスケジュール
      </h2>
    </div>
    <div class="schedule-list" id="schedule-list">
      <!-- Schedules will be rendered by JavaScript -->
    </div>
  </section>

        <!-- 新規問い合わせ -->
        <section class="activity-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-bell"></i>
        新規問い合わせ
        <span class="notification-badge" id="inquiry-count">0</span>
      </h2>
    </div>
    <div class="inquiry-list" id="inquiry-list">
      <!-- Inquiries will be rendered by JavaScript -->
    </div>
  </section>
      </div>

      <!-- 画面2: 顧客情報画面 -->
      <div class="concierge-screen" data-screen="client">
        <div class="screen-header">
          <h1 class="screen-title">顧客情報</h1>
    </div>
        <div class="client-info-container" id="client-info-container">
          <!-- Client info will be rendered by JavaScript -->
        </div>
        </div>

      <!-- 画面3: サービス・価格画面 -->
      <div class="concierge-screen" data-screen="services">
        <div class="screen-header">
          <h1 class="screen-title">サービス・価格</h1>
      </div>
        <div class="services-container" id="services-container">
          <!-- Services will be rendered by JavaScript -->
        </div>
        </div>

      <!-- 画面4: 仮見積もり作成画面 -->
      <div class="concierge-screen" data-screen="estimate">
        <div class="screen-header">
          <h1 class="screen-title">仮見積もり作成</h1>
      </div>
        <div class="estimate-form-container" id="estimate-form-container">
          <!-- 合計見積もりを最上部に配置 -->
          <div class="estimate-total">
            <span class="total-label">合計見積もり</span>
            <span class="total-value" id="estimate-total">¥0</span>
        </div>
          <!-- 追加されたサービス一覧 -->
          <div class="selected-services" id="selected-services">
            <div class="empty-state">
              <i class="fas fa-shopping-cart"></i>
              <p>サービスを選択してください</p>
        </div>
      </div>
          <div class="estimate-photos" id="estimate-photos">
            <div class="photos-header">
              <h3>写真</h3>
              <button class="btn-photo-add" id="btn-photo-add">
                <i class="fas fa-camera"></i> 追加
              </button>
        </div>
            <div class="photos-grid" id="photos-grid">
              <!-- Photos will be added here -->
        </div>
      </div>
          <div class="estimate-notes">
            <label for="estimate-notes-input">メモ</label>
            <textarea id="estimate-notes-input" class="notes-input" placeholder="メモを入力してください"></textarea>
    </div>
          <div class="estimate-actions">
            <button class="btn-save" id="btn-save-estimate">
              <i class="fas fa-save"></i> 保存
            </button>
            <button class="btn-create" id="btn-create-estimate">
              <i class="fas fa-file-invoice"></i> 作成
            </button>
    </div>
        </div>
      </div>

      <!-- 画面5: 地図画面 -->
      <div class="concierge-screen" data-screen="map">
        <div class="screen-header">
          <h1 class="screen-title">地図</h1>
    </div>
        <div class="map-container" id="map-container">
          <div class="map-placeholder" id="map-placeholder">
            <i class="fas fa-map-marked-alt"></i>
            <p>地図を読み込んでいます...</p>
          </div>
        </div>
        <div class="map-schedule-list" id="map-schedule-list">
          <!-- Schedule items will be rendered by JavaScript -->
        </div>
      </div>

      <!-- 画面6: スケジュール画面 -->
      <div class="concierge-screen" data-screen="schedule">
        <div class="screen-header">
          <h1 class="screen-title">スケジュール</h1>
        </div>
        <div class="schedule-container" id="schedule-container">
          <!-- Schedule will be rendered by JavaScript -->
        </div>
      </div>

      <!-- 画面7: TODOリスト画面 -->
      <div class="concierge-screen" data-screen="todo">
        <div class="screen-header">
          <h1 class="screen-title">TODOリスト</h1>
        </div>
        <div class="todo-container" id="todo-container">
          <div class="todo-input-section">
            <input type="text" id="todo-input" class="todo-input" placeholder="新しいTODOを追加..." />
            <button class="btn-todo-add" id="btn-todo-add">
              <i class="fas fa-plus"></i>
            </button>
          </div>
          <div class="todo-list" id="todo-list">
            <!-- TODO items will be rendered by JavaScript -->
          </div>
        </div>
      </div>

      <!-- 画面8: メモ帳画面 -->
      <div class="concierge-screen" data-screen="notes">
        <div class="screen-header">
          <h1 class="screen-title">メモ帳</h1>
        </div>
        <div class="notes-container" id="notes-container">
          <div class="notes-input-section">
            <textarea id="notes-input" class="notes-textarea" placeholder="メモを入力してください..."></textarea>
            <button class="btn-notes-save" id="btn-notes-save">
              <i class="fas fa-save"></i> 保存
            </button>
          </div>
          <div class="notes-list" id="notes-list">
            <!-- Notes will be rendered by JavaScript -->
          </div>
        </div>
      </div>

      <!-- 画面9: カメラ画面 -->
      <div class="concierge-screen" data-screen="camera">
        <div class="screen-header">
          <h1 class="screen-title">カメラ</h1>
        </div>
        <div class="camera-container" id="camera-container">
          <div class="camera-preview" id="camera-preview">
            <video id="camera-video" autoplay playsinline style="display: none;"></video>
            <canvas id="camera-canvas" style="display: none;"></canvas>
            <div class="camera-placeholder">
              <i class="fas fa-camera"></i>
              <p>カメラを起動してください</p>
            </div>
          </div>
          <div class="camera-controls">
            <button class="btn-camera-capture" id="btn-camera-capture">
              <i class="fas fa-circle"></i>
            </button>
            <button class="btn-camera-switch" id="btn-camera-switch">
              <i class="fas fa-sync-alt"></i>
            </button>
          </div>
          <div class="camera-gallery" id="camera-gallery">
            <!-- Captured photos will be displayed here -->
          </div>
        </div>
      </div>

      <!-- 画面10: 仮見積もり概算画面 -->
      <div class="concierge-screen" data-screen="estimate-preview">
        <div class="screen-header">
          <h1 class="screen-title">仮見積もり（概算）</h1>
        </div>
        <div class="estimate-preview-container" id="estimate-preview-container">
          <div class="estimate-preview-content" id="estimate-preview-content">
            <!-- 概算内容はJavaScriptで動的に生成されます -->
          </div>
          <div class="estimate-preview-actions">
            <button class="btn-save" id="btn-save-preview">
              <i class="fas fa-save"></i> 保存
            </button>
            <button class="btn-send" id="btn-send-preview">
              <i class="fas fa-paper-plane"></i> 送信
            </button>
          </div>
        </div>
      </div>

      <!-- 画面11: ログアウト画面 -->
      <div class="concierge-screen" data-screen="logout">
        <div class="screen-header">
          <h1 class="screen-title">ログアウト</h1>
        </div>
        <div class="logout-container" id="logout-container">
          <div class="logout-content">
            <i class="fas fa-sign-out-alt"></i>
            <h2>ログアウトしますか？</h2>
            <p>ログアウトすると、このアプリケーションから退出します。</p>
            <div class="logout-actions">
              <button class="btn-logout-cancel" id="btn-logout-cancel">
                キャンセル
              </button>
              <button class="btn-logout-confirm" id="btn-logout-confirm">
                <i class="fas fa-sign-out-alt"></i> ログアウト
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- 画面下部固定クイックメニュー（一段目） -->
  <div class="concierge-quick-menu">
    <button class="quick-menu-btn" data-screen="activity" title="アクティビティ">
      <i class="fas fa-bolt"></i>
      <span>アクティビティ</span>
    </button>
    <button class="quick-menu-btn" data-screen="schedule" title="スケジュール">
        <i class="fas fa-calendar"></i>
      <span>スケジュール</span>
    </button>
    <button class="quick-menu-btn" data-screen="client" title="顧客情報">
      <i class="fas fa-user"></i>
      <span>顧客</span>
    </button>
    <button class="quick-menu-btn" data-screen="services" title="サービス一覧">
      <i class="fas fa-list"></i>
      <span>サービス</span>
    </button>
    <button class="quick-menu-btn" data-screen="estimate" title="仮見積もり">
      <i class="fas fa-file-invoice"></i>
      <span>見積</span>
    </button>
    </div>
  
  <!-- 二段目のメニュー -->
  <div class="concierge-quick-menu-second" id="quick-menu-second">
    <button class="quick-menu-btn-second" data-screen="todo" title="TODOリスト">
      <i class="fas fa-tasks"></i>
      <span>TODO</span>
    </button>
    <button class="quick-menu-btn-second" data-screen="notes" title="メモ帳">
      <i class="fas fa-sticky-note"></i>
      <span>メモ帳</span>
    </button>
    <button class="quick-menu-btn-second" data-screen="camera" title="カメラ">
      <i class="fas fa-camera"></i>
      <span>カメラ</span>
    </button>
    <button class="quick-menu-btn-second" data-screen="map" title="地図">
      <i class="fas fa-map-marked-alt"></i>
      <span>地図</span>
    </button>
    <button class="quick-menu-btn-second" data-screen="logout" title="ログアウト">
      <i class="fas fa-sign-out-alt"></i>
      <span>ログアウト</span>
    </button>
  </div>


  <!-- Data Scripts -->
  <script type="application/json" id="clients-data">
    @jsonvar $clients_data
  </script>
  <script type="application/json" id="schedule-data">
    @jsonvar $schedule_data
  </script>
  <script type="application/json" id="inquiries-data">
    @jsonvar $inquiries_data
  </script>
  <script type="application/json" id="estimates-data">
    @jsonvar $estimates_data
  </script>
  <script type="application/json" id="service-items-data">
    @jsonvar $service_items_data
  </script>

  <!-- html2canvasライブラリ（スクリーンショット撮影用） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* 基本レイアウト */
    .concierge-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      background: #f9fafb;
      padding-bottom: 80px; /* クイックメニューの高さ分 */
    }

    /* 横スライドコンテナ */
    .concierge-slider-container {
      width: 100%;
      height: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
    }

    .concierge-slider {
      display: flex;
      width: 500vw; /* 5画面分（メニューに応じて切り替え） */
      height: 100%;
    }

    /* 各画面 */
    .concierge-screen {
      width: 100vw;
      height: 100%;
      flex-shrink: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      scroll-snap-align: start;
      scroll-snap-stop: always;
      -webkit-overflow-scrolling: touch;
    }

    .screen-header {
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dashboard-link {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--primary);
      color: #ffffff;
      border-radius: 8px;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s;
    }

    .dashboard-link:hover {
      background: #ff6b9d;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(255, 107, 157, 0.3);
    }

    .dashboard-link i {
      font-size: 1rem;
    }

    .screen-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
      flex: 1;
    }

    /* アクティビティ画面 */
    .activity-section {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .urgent-section {
      border: 2px solid #ef4444;
      background: #fef2f2;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title i {
      color: var(--primary);
    }

    .urgent-badge,
    .notification-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      padding: 0 8px;
      background: #ef4444;
      color: #ffffff;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .urgent-list,
    .schedule-list,
    .inquiry-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .urgent-item,
    .schedule-card,
    .inquiry-card {
      padding: 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-left: 4px solid var(--primary);
      border-radius: 8px;
      transition: all 0.2s;
    }

    .urgent-item {
      border-left-color: #ef4444;
      background: #ffffff;
    }

    .urgent-item:active,
    .schedule-card:active,
    .inquiry-card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .urgent-title,
    .schedule-client,
    .inquiry-company {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .urgent-description,
    .schedule-store,
    .inquiry-meta {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0;
    }

    .schedule-time {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .schedule-time-hour {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
    }

    .schedule-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .schedule-action-btn {
      flex: 1;
      padding: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      color: #6b7280;
      text-decoration: none;
      text-align: center;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .schedule-action-btn:active {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }

    /* 顧客情報画面 */
    .client-info-container {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .client-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }

    .client-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0 0 8px 0;
    }

    .client-store {
      font-size: 1rem;
      color: #6b7280;
      margin: 0;
    }

    .client-contact {
      margin-bottom: 20px;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
      text-decoration: none;
      color: #111827;
    }

    .contact-item:active {
      background: #e5e7eb;
    }

    .contact-item i {
      width: 24px;
      color: var(--primary);
    }

    .client-address {
      margin-bottom: 20px;
    }

    .address-text {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0 0 12px 0;
    }

    .btn-map {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-map:active {
      background: #ff6b9d;
      transform: scale(0.98);
    }

    .client-estimates {
      margin-top: 20px;
    }

    .estimates-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 12px 0;
    }

    .estimate-history-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .estimate-history-date {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0 0 4px 0;
    }

    .estimate-history-service {
      font-size: 0.875rem;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .estimate-history-price {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    /* サービス・価格画面 */
    .services-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .service-category {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .category-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: #111827;
      margin: 0 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    .service-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .service-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border: 2px solid transparent;
      transition: all 0.2s;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .service-item:active {
      background: #e5e7eb;
      border-color: var(--primary);
      transform: scale(0.98);
    }
    
    .service-item.double-tap-hint {
      position: relative;
    }
    
    .service-item.double-tap-hint::after {
      content: 'ダブルタップで追加';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.625rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 10;
    }
    
    .service-item.double-tap-hint:hover::after {
      opacity: 1;
    }

    .service-item-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 8px;
      background: #ffffff;
    }

    .service-item-name {
      font-size: 0.8125rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
      text-align: center;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .service-item-price {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 767.98px) {
      .service-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }
      .service-item {
        padding: 6px 4px;
      }
      .service-item-image {
        margin-bottom: 4px;
      }
      .service-item-name {
        font-size: 0.625rem;
        line-height: 1.2;
        margin: 0 0 2px 0;
        -webkit-line-clamp: 2;
      }
      .service-item-price {
        font-size: 0.6875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }
    }

    /* 仮見積もり作成画面 */
    .estimate-form-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .selected-services {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .selected-service-item {
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      overflow: hidden;
      transition: all 0.2s;
    }

    .selected-service-item.expanded {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(255, 107, 157, 0.15);
    }

    .selected-service-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .selected-service-header:hover {
      background: #f9fafb;
    }

    .selected-service-info {
      flex: 1;
      min-width: 0;
    }

    .selected-service-name {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .selected-service-price {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0;
    }

    .selected-service-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-service-memo {
      padding: 8px 12px;
      background: #f3f4f6;
      color: #6b7280;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      position: relative;
    }

    .btn-service-memo:hover {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-service-memo.active {
      background: var(--primary);
      color: #ffffff;
    }

    .btn-service-memo i {
      font-size: 0.75rem;
    }

    .memo-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      border: 2px solid #ffffff;
    }

    .memo-badge i {
      display: none;
    }

    .btn-remove-service {
      padding: 8px 16px;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-remove-service:hover {
      background: #dc2626;
    }

    .btn-remove-service:active {
      transform: scale(0.98);
    }

    .selected-service-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .selected-service-item.expanded .selected-service-content {
      max-height: 500px;
      transition: max-height 0.3s ease-in;
    }

    .selected-service-multiplier {
      padding: 16px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .selected-service-multiplier label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .multiplier-buttons {
      display: flex;
      gap: 8px;
    }

    .multiplier-btn {
      flex: 1;
      padding: 8px 12px;
      background: #ffffff;
      border: 2px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .multiplier-btn:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .multiplier-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: #ffffff;
    }

    .multiplier-btn:active {
      transform: scale(0.98);
    }

    .selected-service-memo {
      padding: 0 16px 16px 16px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .selected-service-memo label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .selected-service-memo textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .selected-service-memo textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
    }

    .estimate-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, #ff6b9d 100%);
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
      color: #ffffff;
    }

    .total-label {
      font-size: 1rem;
      font-weight: 600;
    }

    .total-value {
      font-size: 1.75rem;
      font-weight: 700;
    }

    .estimate-photos {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .photos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .photos-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }

    .btn-photo-add {
      padding: 8px 16px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-photo-add:active {
      background: #ff6b9d;
    }

    .photos-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-item .btn-remove-photo {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0,0,0,0.6);
      color: #ffffff;
      border: none;
      border-radius: 50%;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .estimate-notes {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .estimate-notes label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }

    .notes-input {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.875rem;
      font-family: inherit;
      resize: vertical;
    }

    .estimate-actions {
      display: flex;
      gap: 12px;
    }

    .btn-save,
    .btn-send {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-save {
      background: #f9fafb;
      color: #111827;
      border: 1px solid #e5e7eb;
    }

    .btn-save:active {
      background: #e5e7eb;
    }

    .btn-send {
      background: var(--primary);
      color: #ffffff;
    }

    .btn-send:active {
      background: #ff6b9d;
      transform: scale(0.98);
    }

    /* 地図画面 */
    .map-container {
      width: 100%;
      height: 300px;
      background: #e5e7eb;
      border-radius: 12px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .map-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6b7280;
    }

    .map-placeholder i {
      font-size: 3rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .map-placeholder p {
      font-size: 0.875rem;
      margin: 0;
    }

    .map-schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .map-schedule-item {
      padding: 16px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .map-schedule-time {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0 0 8px 0;
    }

    .map-schedule-client {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .map-schedule-store {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0 0 12px 0;
    }

    .map-schedule-actions {
      display: flex;
      gap: 8px;
    }

    .btn-map-route {
      flex: 1;
      padding: 10px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-map-route:active {
      background: #ff6b9d;
    }

    /* 画面下部固定クイックメニュー */
    .concierge-quick-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      padding: 8px 0;
      transition: transform 0.3s ease-out;
      will-change: transform;
      transform-style: preserve-3d;
      perspective: 1000px;
    }

    /* スライド＆フェードアニメーション */
    .concierge-quick-menu.sliding-fade {
      animation: slideFadeMenu 0.5s ease-in-out;
    }

    @keyframes slideFadeMenu {
      0% {
        transform: translateY(0);
        opacity: 1;
      }
      50% {
        transform: translateY(-20px);
        opacity: 0.3;
      }
      100% {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .quick-menu-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px;
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .quick-menu-btn i {
      font-size: 1.5rem;
    }

    .quick-menu-btn.active {
      color: var(--primary);
    }

    .quick-menu-btn:active {
      transform: scale(0.95);
    }

    /* 二段目のメニュー（非表示） */
    .concierge-quick-menu-second {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      z-index: 1001;
      padding: 8px 0;
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      will-change: transform;
      visibility: hidden;
      transform-style: preserve-3d;
      perspective: 1000px;
    }

    /* スライド＆フェードアニメーション */
    .concierge-quick-menu-second.sliding-fade {
      animation: slideFadeMenuSecond 0.5s ease-in-out;
    }

    @keyframes slideFadeMenuSecond {
      0% {
        transform: translateY(100%);
        opacity: 0;
      }
      50% {
        transform: translateY(calc(100% - 10px));
        opacity: 0.5;
      }
      100% {
        transform: translateY(100%);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .quick-menu-btn-second {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px;
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .quick-menu-btn-second i {
      font-size: 1.5rem;
    }

    .quick-menu-btn-second.active {
      color: var(--primary);
    }

    .quick-menu-btn-second:active {
      transform: scale(0.95);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 0.95rem;
      margin: 0;
    }

    /* スケジュール画面 */
    .schedule-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .schedule-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .schedule-time {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .schedule-time-hour {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
    }

    .schedule-time-date {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .schedule-client {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 4px;
    }

    .schedule-store {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 12px;
    }

    .schedule-actions {
      display: flex;
      gap: 8px;
    }

    .schedule-action-btn {
      padding: 8px 12px;
      background: #f3f4f6;
      color: #6b7280;
      border-radius: 6px;
      text-decoration: none;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .schedule-action-btn:hover {
      background: var(--primary);
      color: #ffffff;
    }

    /* TODOリスト画面 */
    .todo-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .todo-input-section {
      display: flex;
      gap: 8px;
    }

    .todo-input {
      flex: 1;
        padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.875rem;
    }

    .btn-todo-add {
      padding: 12px 20px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-todo-add:hover {
      background: #ff6b9d;
    }

    .todo-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .todo-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .todo-item.completed .todo-text {
      text-decoration: line-through;
      color: #9ca3af;
    }

    .todo-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .todo-text {
      flex: 1;
      font-size: 0.875rem;
      color: #111827;
    }

    .btn-todo-delete {
      padding: 8px;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-todo-delete:hover {
      background: #dc2626;
    }

    /* メモ帳画面 */
    .notes-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .notes-input-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .notes-textarea {
      width: 100%;
      min-height: 150px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.875rem;
      font-family: inherit;
      resize: vertical;
      box-sizing: border-box;
    }

    .btn-notes-save {
      padding: 12px 20px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-notes-save:hover {
      background: #ff6b9d;
    }

    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .note-item {
      background: #ffffff;
      border-radius: 8px;
        padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .note-date {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .btn-note-delete {
      padding: 6px 10px;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-note-delete:hover {
      background: #dc2626;
    }

    .note-content {
      font-size: 0.875rem;
      color: #111827;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* カメラ画面 */
    .camera-container {
      display: flex;
        flex-direction: column;
      gap: 16px;
    }

    .camera-preview {
      width: 100%;
      aspect-ratio: 4/3;
      background: #000000;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
        flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #ffffff;
    }

    .camera-placeholder i {
      font-size: 3rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .camera-placeholder p {
      font-size: 0.875rem;
      margin: 0;
    }

    .camera-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 24px;
    }

    .btn-camera-capture {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: #ffffff;
      border: 4px solid var(--primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-camera-capture:hover {
      transform: scale(1.1);
    }

    .btn-camera-capture i {
      font-size: 1.5rem;
      color: var(--primary);
    }

    .btn-camera-switch {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #f3f4f6;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .btn-camera-switch:hover {
      background: #e5e7eb;
    }

    .btn-camera-switch i {
      font-size: 1.25rem;
      color: #6b7280;
    }

    .camera-gallery {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .camera-gallery-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
    }

    .camera-gallery-item img {
        width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .btn-gallery-delete {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0,0,0,0.6);
      color: #ffffff;
      border: none;
      border-radius: 50%;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ログアウト画面 */
    .logout-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 400px;
    }

    .logout-content {
      text-align: center;
      padding: 40px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 100%;
    }

    .logout-content i {
      font-size: 3rem;
      color: var(--primary);
      margin-bottom: 16px;
    }

    .logout-content h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0 0 12px 0;
    }

    .logout-content p {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0 0 24px 0;
    }

    .logout-actions {
      display: flex;
      gap: 12px;
    }

    .btn-logout-cancel {
      flex: 1;
      padding: 12px;
      background: #f3f4f6;
      color: #6b7280;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-logout-cancel:hover {
      background: #e5e7eb;
    }

    .btn-logout-confirm {
      flex: 1;
      padding: 12px;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-logout-confirm:hover {
      background: #dc2626;
    }

    /* 仮見積もり概算画面 */
    .estimate-preview-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      padding: 16px;
      gap: 16px;
    }

    .estimate-preview-content {
      flex: 1;
      overflow-y: auto;
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .estimate-preview-header {
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }

    .estimate-preview-header h2 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      color: #111827;
    }

    .estimate-date {
      margin: 0;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .estimate-preview-services {
      margin-bottom: 24px;
    }

    .estimate-preview-services h3 {
      margin: 0 0 12px 0;
      font-size: 1.125rem;
      color: #111827;
    }

    .estimate-services-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }

    .estimate-services-table th,
    .estimate-services-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }

    .estimate-services-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
    }

    .estimate-services-table tfoot {
      font-weight: 600;
    }

    .estimate-services-table .total-label {
      text-align: right;
      padding-right: 16px;
    }

    .estimate-services-table .total-value {
      color: var(--primary);
      font-size: 1.125rem;
    }

    .estimate-preview-photos {
      margin-bottom: 24px;
    }

    .estimate-preview-photos h3 {
      margin: 0 0 12px 0;
      font-size: 1.125rem;
      color: #111827;
    }

    .estimate-preview-photos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }

    .preview-photo {
      width: 100%;
      height: auto;
      border-radius: 8px;
      object-fit: cover;
      aspect-ratio: 1;
    }

    .estimate-preview-notes {
      margin-bottom: 24px;
    }

    .estimate-preview-notes h3 {
      margin: 0 0 12px 0;
      font-size: 1.125rem;
      color: #111827;
    }

    .estimate-preview-notes p {
      margin: 0;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .estimate-preview-actions {
      display: flex;
      gap: 12px;
      padding: 16px;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      position: sticky;
      bottom: 0;
    }

    .btn-create {
      padding: 12px 24px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-create:hover {
      background: #ff6b9d;
    }

    /* SP版のヘッダーとロゴを非表示 */
    @media (max-width: 767.98px) {
      body:has(.concierge-page) header.site-header,
      body:has(.concierge-page) header.site-header .brand-logo,
      body:has(.concierge-page) header.site-header .nav-left,
      body:has(.concierge-page) header.site-header .nav-right,
      body:has(.concierge-page) header.site-header .hamburger-btn,
      body:has(.concierge-page) header.site-header .mobile-nav {
        display: none !important;
      }
      
      /* ヘッダーが非表示になるので、ページの上部余白を調整 */
      .concierge-page {
        top: 0;
      }
    }

    /* PC対応（縦並び表示） */
    @media (min-width: 768px) {
      .concierge-slider {
        width: 100vw;
        flex-direction: column;
      }

      .concierge-screen {
        width: 100%;
        height: auto;
        min-height: calc(100vh - 80px);
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 160px; /* 二段メニュー分の余白を追加 */
      }

      .concierge-slider-container {
        scroll-snap-type: none;
        overflow-y: auto;
        overflow-x: hidden;
      }
      
      /* PC版では最初の画面のみ表示 */
      .concierge-screen:not(.active) {
        display: none;
      }
    }
  </style>

  <script>
    // データ読み込み
    (function() {
      const clientsData = JSON.parse(document.getElementById('clients-data').textContent);
      const scheduleData = JSON.parse(document.getElementById('schedule-data').textContent);
      const inquiriesData = JSON.parse(document.getElementById('inquiries-data').textContent);
      const estimatesData = JSON.parse(document.getElementById('estimates-data').textContent);
      const serviceItemsData = JSON.parse(document.getElementById('service-items-data').textContent);
      
      const clients = clientsData.clients || [];
      const schedules = scheduleData.schedules || [];
      const inquiries = inquiriesData.inquiries || [];
      const estimates = estimatesData.estimates || [];
      const serviceItems = serviceItemsData || [];

      // 横スライド機能
      const slider = document.getElementById('concierge-slider');
      const screens = document.querySelectorAll('.concierge-screen');
      const quickMenuBtns = document.querySelectorAll('.quick-menu-btn[data-screen]');
      let currentScreen = 0;
      let isScrolling = false;

      // 画面切り替え
      function switchScreen(index) {
        if (index < 0 || index >= screens.length) return;
        
        // 表示中の画面のみを対象にする
        const visibleScreens = currentMenuTier === 'first' ? firstTierScreens : secondTierScreens;
        const visibleScreenElements = Array.from(screens).filter(s => visibleScreens.includes(s.dataset.screen));
        
        if (index >= visibleScreenElements.length) return;
        
        const targetScreen = visibleScreenElements[index];
        const screenName = targetScreen.dataset.screen;
        const actualIndex = Array.from(screens).indexOf(targetScreen);
        
        currentScreen = actualIndex;
        
        // PC版とSP版で異なる処理
        const isMobile = window.innerWidth <= 767.98;
        
        if (isMobile) {
          // SP版: 横スライドで切り替え（表示中の画面の中でのインデックスを使用）
          // 表示中の画面のみを対象にする
          const visibleScreens = currentMenuTier === 'first' ? firstTierScreens : secondTierScreens;
          const visibleScreenElements = Array.from(screens).filter(s => visibleScreens.includes(s.dataset.screen));
          
          if (index >= 0 && index < visibleScreenElements.length) {
            slider.scrollTo({
              left: index * window.innerWidth,
              behavior: 'smooth'
            });
          }
        } else {
          // PC版: 直接表示（横スライドなし）
          // 各画面を縦に並べて表示
          screens.forEach((s, i) => {
            if (i === actualIndex) {
              s.style.display = 'block';
            } else {
              s.style.display = 'none';
            }
          });
        }

        // アクティブ状態を更新
        screens.forEach(s => s.classList.remove('active'));
        targetScreen.classList.add('active');
        
        // 一段目のメニューボタンのアクティブ状態を更新
        quickMenuBtns.forEach(btn => {
          if (btn.dataset.screen === screenName) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        // 二段目のメニューボタンのアクティブ状態も更新
        const quickMenuBtnsSecond = document.querySelectorAll('.quick-menu-btn-second[data-screen]');
        quickMenuBtnsSecond.forEach(btn => {
          if (btn.dataset.screen === screenName) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // 画面固有の処理
        if (screenName === 'client') {
          renderClientInfo();
        } else if (screenName === 'services') {
          renderServices();
        } else if (screenName === 'map') {
          renderMap();
        } else if (screenName === 'schedule') {
          renderSchedule();
        } else if (screenName === 'todo') {
          renderTodo();
        } else if (screenName === 'notes') {
          renderNotes();
        } else if (screenName === 'camera') {
          initCamera();
        } else if (screenName === 'estimate-preview') {
          // 概算画面は既にレンダリング済み
        } else if (screenName === 'logout') {
          // ログアウト画面は静的表示
        }
      }
      
      // リサイズ時に画面表示を調整
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          const isMobile = window.innerWidth <= 767.98;
          if (!isMobile) {
            // PC版: 現在の画面のみ表示
            screens.forEach((s, i) => {
              if (i === currentScreen) {
                s.style.display = 'block';
              } else {
                s.style.display = 'none';
              }
            });
          } else {
            // SP版: 表示中の画面のみ表示
            updateVisibleScreens();
          }
        }, 100);
      });

      // クイックメニューボタンクリック（一段目）
      // このイベントリスナーは setupMenuEventListeners で動的に設定されるため、ここでは削除

      // スワイプ検出
      let touchStartX = 0;
      let touchEndX = 0;

      slider.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      slider.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
          // 表示中の画面のみを対象にする
          const visibleScreens = currentMenuTier === 'first' ? firstTierScreens : secondTierScreens;
          const visibleScreenElements = Array.from(screens).filter(s => visibleScreens.includes(s.dataset.screen));
          const currentVisibleIndex = visibleScreenElements.findIndex(s => s.classList.contains('active'));
          
          if (diff > 0) {
            // 左スワイプ（次の画面）
            if (currentVisibleIndex < visibleScreenElements.length - 1) {
              const nextScreen = visibleScreenElements[currentVisibleIndex + 1];
              const nextIndex = visibleScreenElements.indexOf(nextScreen);
              switchScreen(nextIndex);
            }
          } else {
            // 右スワイプ（前の画面）
            if (currentVisibleIndex > 0) {
              const prevScreen = visibleScreenElements[currentVisibleIndex - 1];
              const prevIndex = visibleScreenElements.indexOf(prevScreen);
              switchScreen(prevIndex);
            }
          }
        }
      }

      // スクロール位置の監視
      slider.addEventListener('scroll', () => {
        if (isScrolling) return;
        const scrollLeft = slider.scrollLeft;
        const screenIndex = Math.round(scrollLeft / window.innerWidth);
        
        // 表示中の画面のみを対象にする
        const visibleScreens = currentMenuTier === 'first' ? firstTierScreens : secondTierScreens;
        const visibleScreenElements = Array.from(screens).filter(s => visibleScreens.includes(s.dataset.screen));
        
        if (screenIndex >= 0 && screenIndex < visibleScreenElements.length) {
          const screen = visibleScreenElements[screenIndex];
          const screenName = screen.dataset.screen;
          const actualIndex = Array.from(screens).indexOf(screen);
          
          if (actualIndex !== currentScreen) {
            currentScreen = actualIndex;
            
            screens.forEach(s => s.classList.remove('active'));
            screen.classList.add('active');
            
            quickMenuBtns.forEach(btn => {
              if (btn.dataset.screen === screenName) {
                btn.classList.add('active');
              } else {
                btn.classList.remove('active');
              }
            });
            
            // 二段目のメニューボタンのアクティブ状態も更新
            const quickMenuBtnsSecond = document.querySelectorAll('.quick-menu-btn-second[data-screen]');
            quickMenuBtnsSecond.forEach(btn => {
              if (btn.dataset.screen === screenName) {
                btn.classList.add('active');
              } else {
                btn.classList.remove('active');
              }
            });
          }
        }
      }, { passive: true });

      // アクティビティ画面のレンダリング
      function renderActivity() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
      const todaySchedules = schedules.filter(s => s.date === todayStr);
      
        // 緊急対応
      const urgentItems = [];
      const threeDaysAgo = new Date();
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      threeDaysAgo.setHours(0, 0, 0, 0);
      
      estimates.filter(e => e.status === 'sent' && e.sent_date).forEach(estimate => {
        try {
          const dateStr = estimate.sent_date.replace(/年/g, '-').replace(/月/g, '-').replace(/日/g, '');
          const parts = dateStr.split('-');
          if (parts.length === 3) {
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            const sentDate = new Date(year, month - 1, day);
            sentDate.setHours(0, 0, 0, 0);
            
            if (sentDate < threeDaysAgo) {
              urgentItems.push({
                type: 'estimate',
                title: `見積もり承認待ち: ${estimate.client_name} ${estimate.store_name}`,
                description: `${estimate.sent_date}送付済み（${estimate.total}）`,
                  link: `/sales/estimates/${estimate.id}.html`
              });
            }
          }
        } catch (e) {
          console.error('Error parsing date:', estimate.sent_date, e);
        }
      });
      
      inquiries.filter(i => i.status === 'pending').forEach(inquiry => {
        urgentItems.push({
          type: 'inquiry',
          title: `新規問い合わせ: ${inquiry.company_name}`,
          description: `${inquiry.date} ${inquiry.time} - ${inquiry.message}`,
            link: `/sales/clients/new.html?inquiry=${inquiry.id}`
        });
      });
      
        // 緊急対応レンダリング
        const urgentListEl = document.getElementById('urgent-list');
        const urgentCountEl = document.getElementById('urgent-count');
        if (urgentListEl) {
        urgentCountEl.textContent = urgentItems.length;
        if (urgentItems.length === 0) {
            urgentListEl.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>緊急対応が必要な項目はありません</p></div>';
          } else {
            urgentListEl.innerHTML = urgentItems.map(item => `
            <div class="urgent-item" onclick="window.location.href='${item.link}'">
                <div class="urgent-title">${item.title}</div>
                <div class="urgent-description">${item.description}</div>
              </div>
            `).join('');
          }
        }

        // スケジュールレンダリング
        const scheduleListEl = document.getElementById('schedule-list');
        if (scheduleListEl) {
        if (todaySchedules.length === 0) {
            scheduleListEl.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>本日の予定はありません</p></div>';
          } else {
        scheduleListEl.innerHTML = todaySchedules.map(schedule => {
          const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(schedule.address)}`;
          return `
            <div class="schedule-card">
              <div class="schedule-time">
                    <span class="schedule-time-hour">${schedule.time}</span>
              </div>
                <div class="schedule-client">${schedule.client_name}</div>
                  <div class="schedule-store">${schedule.store_name} - ${schedule.purpose}</div>
              <div class="schedule-actions">
                    ${schedule.phone ? `<a href="tel:${schedule.phone}" class="schedule-action-btn"><i class="fas fa-phone"></i> 電話</a>` : ''}
                    ${schedule.email ? `<a href="mailto:${schedule.email}" class="schedule-action-btn"><i class="fas fa-envelope"></i> メール</a>` : ''}
                    <a href="${mapUrl}" target="_blank" class="schedule-action-btn"><i class="fas fa-map-marker-alt"></i> 地図</a>
              </div>
            </div>
          `;
        }).join('');
          }
      }
      
        // 問い合わせレンダリング
        const inquiryListEl = document.getElementById('inquiry-list');
        const inquiryCountEl = document.getElementById('inquiry-count');
        if (inquiryListEl) {
        const pendingInquiries = inquiries.filter(i => i.status === 'pending');
        inquiryCountEl.textContent = pendingInquiries.length;
        if (pendingInquiries.length === 0) {
            inquiryListEl.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>新規問い合わせはありません</p></div>';
          } else {
            inquiryListEl.innerHTML = pendingInquiries.slice(0, 5).map(inquiry => `
              <div class="inquiry-card" onclick="window.location.href='/sales/clients/new.html?inquiry=${inquiry.id}'">
                <div class="inquiry-company">${inquiry.company_name}</div>
                <div class="inquiry-meta">${inquiry.date} ${inquiry.time} - ${inquiry.message}</div>
            </div>
            `).join('');
          }
        }
      }

      // 顧客情報画面のレンダリング
      function renderClientInfo() {
        const clientInfoContainer = document.getElementById('client-info-container');
        if (!clientInfoContainer) return;

        // 本日の最初のスケジュールの顧客を表示
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const todaySchedules = schedules.filter(s => s.date === todayStr);
        
        if (todaySchedules.length === 0) {
          clientInfoContainer.innerHTML = '<div class="empty-state"><i class="fas fa-user"></i><p>本日のスケジュールがありません</p></div>';
          return;
        }
        
        const firstSchedule = todaySchedules[0];
        const client = clients.find(c => c.id === firstSchedule.client_id);

        if (!client) {
          clientInfoContainer.innerHTML = '<div class="empty-state"><i class="fas fa-user"></i><p>顧客情報が見つかりません</p></div>';
          return;
        }

        const clientEstimates = estimates.filter(e => e.client_id === client.id);
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(client.address || firstSchedule.address)}`;

        clientInfoContainer.innerHTML = `
          <div class="client-header">
            <h2 class="client-name">${client.company_name || client.name}</h2>
            <p class="client-store">${client.store_name || firstSchedule.store_name}</p>
              </div>
          <div class="client-contact">
            ${client.phone ? `<a href="tel:${client.phone}" class="contact-item"><i class="fas fa-phone"></i><span>${client.phone}</span></a>` : ''}
            ${client.email ? `<a href="mailto:${client.email}" class="contact-item"><i class="fas fa-envelope"></i><span>${client.email}</span></a>` : ''}
            </div>
          <div class="client-address">
            <p class="address-text">${client.address || firstSchedule.address}</p>
            <a href="${mapUrl}" target="_blank" class="btn-map"><i class="fas fa-map-marker-alt"></i> 地図で開く</a>
            </div>
          ${clientEstimates.length > 0 ? `
            <div class="client-estimates">
              <h3 class="estimates-title">過去の見積もり</h3>
              ${clientEstimates.slice(0, 5).map(est => `
                <div class="estimate-history-item">
                  <p class="estimate-history-date">${est.created_date || est.sent_date}</p>
                  <p class="estimate-history-service">${est.service_name || 'サービス'}</p>
                  <p class="estimate-history-price">${est.total}</p>
                </div>
              `).join('')}
            </div>
          ` : ''}
        `;
      }

      // サービス・価格画面のレンダリング
      function renderServices() {
        const servicesContainer = document.getElementById('services-container');
        if (!servicesContainer) return;

        // カテゴリ別にグループ化
        const servicesByCategory = {};
        serviceItems.forEach(item => {
          const category = item.category || 'その他';
          if (!servicesByCategory[category]) {
            servicesByCategory[category] = [];
          }
          servicesByCategory[category].push(item);
        });

        servicesContainer.innerHTML = Object.keys(servicesByCategory).map(category => {
          const categoryServices = servicesByCategory[category];
          // 4x4グリッド用に16個ずつに分割
          const chunks = [];
          for (let i = 0; i < categoryServices.length; i += 16) {
            chunks.push(categoryServices.slice(i, i + 16));
          }
          
          return chunks.map((chunk, chunkIndex) => `
            <div class="service-category">
              <h3 class="category-title">${category}${chunks.length > 1 ? ` (${chunkIndex + 1})` : ''}</h3>
              <div class="service-grid">
                ${chunk.map(item => {
                  const imagePath = item.image || item['detail-image'] || 'images/placeholder.png';
                  return `
                    <div class="service-item" data-service-id="${item.id}" data-service-name="${item.title.replace(/"/g, '&quot;')}" data-service-price="${item.price}">
                      <img src="${imagePath}" alt="${item.title}" class="service-item-image" onerror="this.src='images/placeholder.png'" />
                      <div class="service-item-name">${item.title}</div>
                      <div class="service-item-price">${item.price}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `).join('');
        }).join('');
        
        // サービスカードにダブルクリックイベントを追加
        const serviceItemElements = document.querySelectorAll('.service-item[data-service-id]');
        serviceItemElements.forEach(item => {
          let clickTimer = null;
          
          // シングルクリック（タップ）: 何もしない（または詳細表示など）
          item.addEventListener('click', (e) => {
            if (clickTimer === null) {
              clickTimer = setTimeout(() => {
                clickTimer = null;
                // シングルクリック時の処理（必要に応じて実装）
              }, 300);
            }
          });
          
          // ダブルクリック（タップ）: 見積もりに追加
          item.addEventListener('dblclick', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (clickTimer) {
              clearTimeout(clickTimer);
              clickTimer = null;
            }
            const serviceId = parseInt(item.dataset.serviceId, 10);
            const serviceName = item.dataset.serviceName;
            const servicePrice = item.dataset.servicePrice;
            addServiceToEstimate(serviceId, serviceName, servicePrice);
          });
          
          // タッチデバイス用のダブルタップ検出
          let lastTap = 0;
          item.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
              // ダブルタップ検出
              e.preventDefault();
              e.stopPropagation();
              if (clickTimer) {
                clearTimeout(clickTimer);
                clickTimer = null;
              }
              const serviceId = parseInt(item.dataset.serviceId, 10);
              const serviceName = item.dataset.serviceName;
              const servicePrice = item.dataset.servicePrice;
              addServiceToEstimate(serviceId, serviceName, servicePrice);
            } else {
              // シングルタップ
              if (clickTimer === null) {
                clickTimer = setTimeout(() => {
                  clickTimer = null;
                }, 300);
              }
            }
            lastTap = currentTime;
          }, { passive: false });
        });
      }

      // 仮見積もりにサービスを追加
      window.addServiceToEstimate = function(id, name, price) {
        const selectedServices = document.getElementById('selected-services');
        const emptyState = selectedServices.querySelector('.empty-state');
        if (emptyState) {
          emptyState.remove();
        }

        // 既に同じサービスが追加されているかチェック
        const existingItem = selectedServices.querySelector(`.selected-service-item[data-service-id="${id}"]`);
        if (existingItem) {
          // 既に追加されている場合は、その項目を開く
          toggleServiceMemo(existingItem.querySelector('.btn-service-memo'));
          return;
        }

        // 価格から数値を抽出（¥ 21,000〜 → 21000）
        const priceMatch = price.match(/¥\s*([\d,]+)/);
        const priceValue = priceMatch ? parseInt(priceMatch[1].replace(/,/g, ''), 10) : 0;

        const serviceItem = document.createElement('div');
        serviceItem.className = 'selected-service-item';
        serviceItem.dataset.serviceId = id;
        serviceItem.dataset.priceValue = priceValue;
        serviceItem.dataset.multiplier = '1'; // デフォルト倍率は1
        serviceItem.innerHTML = `
          <div class="selected-service-header" onclick="toggleServiceMemo(this.querySelector('.btn-service-memo'))">
            <div class="selected-service-info">
              <p class="selected-service-name">${name}</p>
              <p class="selected-service-price" id="service-price-${id}">${price}</p>
            </div>
            <div class="selected-service-actions" onclick="event.stopPropagation()">
              <button class="btn-service-memo" onclick="toggleServiceMemo(this)" title="メモ">
                <i class="fas fa-sticky-note"></i>
                <span>メモ</span>
              </button>
              <button class="btn-remove-service" onclick="removeServiceFromEstimate(this)">削除</button>
            </div>
          </div>
          <div class="selected-service-content">
            <div class="selected-service-multiplier">
              <label>倍率</label>
              <div class="multiplier-buttons">
                <button class="multiplier-btn active" data-multiplier="1" onclick="setServiceMultiplier(${id}, 1)">x1</button>
                <button class="multiplier-btn" data-multiplier="1.5" onclick="setServiceMultiplier(${id}, 1.5)">x1.5</button>
                <button class="multiplier-btn" data-multiplier="2" onclick="setServiceMultiplier(${id}, 2)">x2</button>
              </div>
            </div>
            <div class="selected-service-memo">
              <label for="service-memo-${id}">備考</label>
              <textarea id="service-memo-${id}" class="service-memo-input" placeholder="このサービスに関する備考を入力してください" oninput="saveServiceMemo(${id}, this.value)"></textarea>
            </div>
          </div>
        `;
        selectedServices.appendChild(serviceItem);
        updateEstimateTotal();
        
        // サービス画面にとどまる（見積もり画面に遷移しない）
      };

      // サービスメモの開閉
      window.toggleServiceMemo = function(btn) {
        const serviceItem = btn.closest('.selected-service-item');
        if (!serviceItem) return;

        const isExpanded = serviceItem.classList.contains('expanded');
        
        if (isExpanded) {
          serviceItem.classList.remove('expanded');
          btn.classList.remove('active');
        } else {
          serviceItem.classList.add('expanded');
          btn.classList.add('active');
          // メモ入力欄にフォーカス
          const memoTextarea = serviceItem.querySelector('.service-memo-input');
          if (memoTextarea) {
            setTimeout(() => {
              memoTextarea.focus();
            }, 100);
          }
        }
      };

      // サービスメモを保存
      window.saveServiceMemo = function(serviceId, memo) {
        const serviceItem = document.querySelector(`.selected-service-item[data-service-id="${serviceId}"]`);
        if (serviceItem) {
          serviceItem.dataset.memo = memo;
          // メモがある場合はメモボタンにバッジを表示
          const memoBtn = serviceItem.querySelector('.btn-service-memo');
          if (memo && memo.trim()) {
            if (!memoBtn.querySelector('.memo-badge')) {
              const badge = document.createElement('span');
              badge.className = 'memo-badge';
              badge.innerHTML = '<i class="fas fa-circle"></i>';
              memoBtn.appendChild(badge);
            }
          } else {
            const badge = memoBtn.querySelector('.memo-badge');
            if (badge) {
              badge.remove();
            }
          }
        }
      };

      // 仮見積もりからサービスを削除
      window.removeServiceFromEstimate = function(btn) {
        btn.closest('.selected-service-item').remove();
        const selectedServices = document.getElementById('selected-services');
        if (selectedServices.children.length === 0) {
          selectedServices.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>サービスを選択してください</p></div>';
        }
        updateEstimateTotal();
      };

      // サービス倍率を設定
      window.setServiceMultiplier = function(serviceId, multiplier) {
        const serviceItem = document.querySelector(`.selected-service-item[data-service-id="${serviceId}"]`);
        if (!serviceItem) return;

        // 倍率を保存
        serviceItem.dataset.multiplier = multiplier.toString();

        // ボタンのアクティブ状態を更新
        const multiplierBtns = serviceItem.querySelectorAll('.multiplier-btn');
        multiplierBtns.forEach(btn => {
          if (parseFloat(btn.dataset.multiplier) === multiplier) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // 価格を再計算して表示を更新
        const basePrice = parseInt(serviceItem.dataset.priceValue || '0', 10);
        const multipliedPrice = Math.round(basePrice * multiplier);
        const priceDisplay = serviceItem.querySelector(`#service-price-${serviceId}`);
        if (priceDisplay) {
          // 元の価格フォーマットを保持（¥ 21,000〜 のような形式）
          const originalPrice = serviceItem.querySelector('.selected-service-price').textContent;
          const priceMatch = originalPrice.match(/¥\s*([\d,]+)/);
          if (priceMatch) {
            priceDisplay.textContent = `¥${multipliedPrice.toLocaleString()}`;
          } else {
            priceDisplay.textContent = `¥${multipliedPrice.toLocaleString()}`;
          }
        }

        // 見積もり合計を更新
        updateEstimateTotal();
      };

      // 見積もり合計を更新
      function updateEstimateTotal() {
        const selectedItems = document.querySelectorAll('.selected-service-item');
        let total = 0;
        selectedItems.forEach(item => {
          const basePrice = parseInt(item.dataset.priceValue || '0', 10);
          const multiplier = parseFloat(item.dataset.multiplier || '1', 10);
          const multipliedPrice = Math.round(basePrice * multiplier);
          total += multipliedPrice;
        });
        document.getElementById('estimate-total').textContent = total > 0 ? `¥${total.toLocaleString()}` : '¥0';
      }

      // 下部メニューの入れ替え機能
      const quickMenu = document.querySelector('.concierge-quick-menu');
      const quickMenuSecond = document.getElementById('quick-menu-second');
      let menuSlideStartY = 0;
      let menuSlideCurrentY = 0;
      let isMenuSliding = false;
      let hasSwapped = false; // 入れ替えが実行されたかどうか

      // 一段目メニューに対応する画面
      const firstTierScreens = ['activity', 'schedule', 'client', 'services', 'estimate'];
      // 二段目メニューに対応する画面
      const secondTierScreens = ['todo', 'notes', 'camera', 'map', 'logout'];
      // 概算画面は独立した画面（メニューには表示されない）
      
      // 現在表示中のメニュータイプ（'first' または 'second'）
      let currentMenuTier = 'first';

      // 表示する画面を切り替える関数
      function updateVisibleScreens() {
        const visibleScreens = currentMenuTier === 'first' ? firstTierScreens : secondTierScreens;
        
        // すべての画面を一旦非表示にする
        screens.forEach(screen => {
          screen.style.display = 'none';
        });
        
        // 表示する画面のみを表示
        screens.forEach(screen => {
          const screenName = screen.dataset.screen;
          if (visibleScreens.includes(screenName)) {
            screen.style.display = 'block';
          }
        });

        // スライダーの幅を調整（表示中の画面数 × 100vw）
        if (slider) {
          const visibleCount = visibleScreens.length;
          slider.style.width = `${visibleCount * 100}vw`;
        }
      }

      // メニューを入れ替える関数（スライド＆フェードアニメーション付き）
      function swapMenus() {
        if (!quickMenu || !quickMenuSecond) return;

        // スライド＆フェードアニメーションを開始
        quickMenu.classList.add('sliding-fade');
        quickMenuSecond.classList.add('sliding-fade');

        // アニメーション完了後に実際の入れ替えを実行
        setTimeout(() => {
          // 一段目と二段目のメニュー項目を取得
          const firstTierItems = Array.from(quickMenu.children);
          const secondTierItems = Array.from(quickMenuSecond.children);

          // メニュー項目を入れ替え
          firstTierItems.forEach(item => {
            // ボタンかリンクかを判定
            if (item.tagName === 'BUTTON') {
              // ボタンのクラスを変更
              item.classList.remove('quick-menu-btn');
              item.classList.add('quick-menu-btn-second');
              quickMenuSecond.appendChild(item);
            } else if (item.tagName === 'A') {
              // リンクのクラスを変更
              item.classList.remove('quick-menu-btn');
              item.classList.add('quick-menu-btn-second');
              quickMenuSecond.appendChild(item);
            }
          });

          secondTierItems.forEach(item => {
            // ボタンかリンクかを判定
            if (item.tagName === 'BUTTON') {
              // ボタンのクラスを変更
              item.classList.remove('quick-menu-btn-second');
              item.classList.add('quick-menu-btn');
              quickMenu.appendChild(item);
            } else if (item.tagName === 'A') {
              // リンクのクラスを変更
              item.classList.remove('quick-menu-btn-second');
              item.classList.add('quick-menu-btn');
              quickMenu.appendChild(item);
            }
          });

          // メニュータイプを切り替え
          currentMenuTier = currentMenuTier === 'first' ? 'second' : 'first';
          
          // 表示する画面を更新
          updateVisibleScreens();

          // スライド＆フェードアニメーションを終了
          quickMenu.classList.remove('sliding-fade');
          quickMenuSecond.classList.remove('sliding-fade');

          // イベントリスナーを再設定
          setupMenuEventListeners();

          // デフォルト画面を表示
          // 一段目メニューの場合は「アクティビティ」、二段目メニューの場合は「TODO」
          const defaultScreenName = currentMenuTier === 'first' ? 'activity' : 'todo';
          const visibleScreens = currentMenuTier === 'first' ? firstTierScreens : secondTierScreens;
          const screenIndex = visibleScreens.indexOf(defaultScreenName);
          
          if (screenIndex !== -1) {
            // 表示中の画面の中でのインデックスを使用して画面を切り替え
            switchScreen(screenIndex);
          }
        }, 500); // アニメーション時間（0.5s）
      }

      // メニューのイベントリスナーを設定
      function setupMenuEventListeners() {
        // 一段目のメニューボタンのクリックイベント
        const firstTierBtns = quickMenu.querySelectorAll('.quick-menu-btn[data-screen]');
        firstTierBtns.forEach(btn => {
          // 既存のイベントリスナーを削除（重複防止）
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
          
          newBtn.addEventListener('click', () => {
            const screenName = newBtn.dataset.screen;
            const visibleScreens = currentMenuTier === 'first' ? firstTierScreens : secondTierScreens;
            const visibleScreenElements = Array.from(screens).filter(s => visibleScreens.includes(s.dataset.screen));
            const screenIndex = visibleScreenElements.findIndex(s => s.dataset.screen === screenName);
            if (screenIndex !== -1) {
              switchScreen(screenIndex);
            }
          });
        });

        // 二段目のメニューボタンのクリックイベント
        const secondTierBtns = quickMenuSecond.querySelectorAll('.quick-menu-btn-second[data-screen]');
        secondTierBtns.forEach(btn => {
          // 既存のイベントリスナーを削除（重複防止）
          const newBtn = btn.cloneNode(true);
          btn.parentNode.replaceChild(newBtn, btn);
          
          newBtn.addEventListener('click', () => {
            const screenName = newBtn.dataset.screen;
            const visibleScreens = currentMenuTier === 'first' ? firstTierScreens : secondTierScreens;
            const visibleScreenElements = Array.from(screens).filter(s => visibleScreens.includes(s.dataset.screen));
            const screenIndex = visibleScreenElements.findIndex(s => s.dataset.screen === screenName);
            if (screenIndex !== -1) {
              switchScreen(screenIndex);
              // 画面切り替え後、メニューを閉じる
              if (quickMenu) {
                quickMenu.classList.remove('slide-up');
              }
              if (quickMenuSecond) {
                quickMenuSecond.classList.remove('visible');
                // ページスクロールを再有効化
                document.body.style.overflow = '';
                // 視覚的効果を削除
                document.body.classList.remove('menu-expanded');
              }
            }
          });
        });
      }

      if (quickMenu) {
        // タッチイベントでスライド検出
        quickMenu.addEventListener('touchstart', (e) => {
          menuSlideStartY = e.touches[0].clientY;
          isMenuSliding = true;
          hasSwapped = false;
        }, { passive: true });

        quickMenu.addEventListener('touchmove', (e) => {
          if (!isMenuSliding) return;
          menuSlideCurrentY = e.touches[0].clientY;
          const deltaY = menuSlideStartY - menuSlideCurrentY;
          
          // 上にスワイプ（deltaY > 0）で入れ替え
          if (deltaY > 0 && deltaY > 30 && !hasSwapped) {
            hasSwapped = true;
            swapMenus();
          }
        }, { passive: true });

        quickMenu.addEventListener('touchend', () => {
          isMenuSliding = false;
          hasSwapped = false;
        }, { passive: true });
      }

      // 初期設定
      setupMenuEventListeners();

      // 写真撮影機能（削除）
      const photosGrid = document.getElementById('photos-grid');

      // 写真追加ボタンのクリックイベント（ファイル選択ダイアログを開く）
      const btnPhotoAdd = document.getElementById('btn-photo-add');
      if (btnPhotoAdd) {
        // 一時的なファイル入力を作成
        const photoInput = document.createElement('input');
        photoInput.type = 'file';
        photoInput.accept = 'image/*';
        photoInput.multiple = true;
        photoInput.style.display = 'none';
        document.body.appendChild(photoInput);

        btnPhotoAdd.addEventListener('click', () => {
          photoInput.click();
        });

        photoInput.addEventListener('change', (e) => {
          const files = Array.from(e.target.files);
          files.forEach(file => {
            if (file.type.startsWith('image/')) {
              const reader = new FileReader();
              reader.onload = (event) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `
                  <img src="${event.target.result}" alt="写真">
                  <button class="btn-remove-photo" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                  </button>
                `;
                if (photosGrid) {
                  photosGrid.appendChild(photoItem);
                }
              };
              reader.readAsDataURL(file);
            }
          });
          // ファイル選択をリセット（同じファイルを再度選択できるように）
          photoInput.value = '';
        });
      }

      // 見積もり保存
      document.getElementById('btn-save-estimate').addEventListener('click', () => {
        const selectedItems = document.querySelectorAll('.selected-service-item');
        const photos = Array.from(photosGrid.querySelectorAll('img')).map(img => img.src);
        const notes = document.getElementById('estimate-notes-input').value;
        
        // TODO: 実際の保存処理を実装
        alert('仮見積もりを保存しました');
      });

      // 見積もり作成（概算画面を表示）
      document.getElementById('btn-create-estimate').addEventListener('click', () => {
        const selectedItems = document.querySelectorAll('.selected-service-item');
        if (selectedItems.length === 0) {
          alert('サービスを選択してください');
          return;
        }
        
        // 概算画面をレンダリング
        renderEstimatePreview();
        
        // 概算画面に切り替え
        const previewScreen = document.querySelector('.concierge-screen[data-screen="estimate-preview"]');
        if (previewScreen) {
          const previewIndex = Array.from(screens).indexOf(previewScreen);
          if (previewIndex !== -1) {
            switchScreen(previewIndex);
          }
        }
      });

      // 地図画面のレンダリング
      function renderMap() {
        const mapScheduleList = document.getElementById('map-schedule-list');
        if (!mapScheduleList) return;

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const todaySchedules = schedules.filter(s => s.date === todayStr);
        
        if (todaySchedules.length === 0) {
          mapScheduleList.innerHTML = '<div class="empty-state"><i class="fas fa-map-marked-alt"></i><p>本日のスケジュールがありません</p></div>';
          return;
        }

        mapScheduleList.innerHTML = todaySchedules.map(schedule => {
          const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(schedule.address)}`;
          return `
            <div class="map-schedule-item">
              <p class="map-schedule-time">${schedule.time}</p>
              <p class="map-schedule-client">${schedule.client_name}</p>
              <p class="map-schedule-store">${schedule.store_name}</p>
              <div class="map-schedule-actions">
                <a href="${mapUrl}" target="_blank" class="btn-map-route"><i class="fas fa-route"></i> ルート</a>
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(schedule.address)}" target="_blank" class="btn-map-route"><i class="fas fa-map-marker-alt"></i> 地図</a>
              </div>
            </div>
          `;
        }).join('');

        // 地図プレースホルダーに地図リンクを表示
        const mapPlaceholder = document.getElementById('map-placeholder');
        if (mapPlaceholder && todaySchedules.length > 0) {
          const firstSchedule = todaySchedules[0];
          // 実際の実装ではGoogle Maps APIキーが必要
          // 現在は地図リンクのみ表示
          mapPlaceholder.innerHTML = `
            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(firstSchedule.address)}" target="_blank" style="text-decoration: none; color: inherit;">
              <i class="fas fa-map-marked-alt"></i>
              <p>地図を開く</p>
            </a>
          `;
        }
      }

      // 仮見積もり概算画面のレンダリング
      function renderEstimatePreview() {
        const previewContainer = document.getElementById('estimate-preview-content');
        if (!previewContainer) return;

        const selectedItems = document.querySelectorAll('.selected-service-item');
        const photos = Array.from(photosGrid.querySelectorAll('img')).map(img => img.src);
        const notes = document.getElementById('estimate-notes-input').value;
        const total = document.getElementById('estimate-total').textContent;

        // 選択されたサービス一覧を取得
        const services = Array.from(selectedItems).map(item => {
          const name = item.querySelector('.selected-service-name').textContent;
          const price = item.querySelector('.selected-service-price').textContent;
          const multiplier = item.dataset.multiplier || '1';
          const memo = item.querySelector('.service-memo-input')?.value || '';
          return { name, price, multiplier, memo };
        });

        // 現在の日時を取得
        const now = new Date();
        const dateStr = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

        // 概算画面のHTMLを生成
        previewContainer.innerHTML = `
          <div class="estimate-preview-header">
            <h2>仮見積もり（概算）</h2>
            <p class="estimate-date">作成日時: ${dateStr}</p>
          </div>
          <div class="estimate-preview-services">
            <h3>サービス一覧</h3>
            <table class="estimate-services-table">
              <thead>
                <tr>
                  <th>サービス名</th>
                  <th>単価</th>
                  <th>倍率</th>
                  <th>金額</th>
                </tr>
              </thead>
              <tbody>
                ${services.map(service => {
                  const basePrice = parseInt(service.price.replace(/[¥,\s〜]/g, ''), 10) || 0;
                  const multiplier = parseFloat(service.multiplier);
                  const finalPrice = basePrice * multiplier;
                  return `
                    <tr>
                      <td>${service.name}${service.memo ? `<br><small>${service.memo}</small>` : ''}</td>
                      <td>${service.price}</td>
                      <td>x${service.multiplier}</td>
                      <td>¥${finalPrice.toLocaleString()}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
              <tfoot>
                <tr>
                  <td colspan="3" class="total-label">合計見積もり</td>
                  <td class="total-value">${total}</td>
                </tr>
              </tfoot>
            </table>
          </div>
          ${photos.length > 0 ? `
            <div class="estimate-preview-photos">
              <h3>写真</h3>
              <div class="estimate-preview-photos-grid">
                ${photos.map(photo => `<img src="${photo}" alt="写真" class="preview-photo">`).join('')}
              </div>
            </div>
          ` : ''}
          ${notes ? `
            <div class="estimate-preview-notes">
              <h3>メモ</h3>
              <p>${notes}</p>
            </div>
          ` : ''}
        `;
      }

      // TODOリストとメモ帳のデータを初期化（関数定義より前に宣言）
      let todos = JSON.parse(localStorage.getItem('concierge-todos') || '[]');
      let notes = JSON.parse(localStorage.getItem('concierge-notes') || '[]');

      // 初期レンダリング
      renderActivity();
      renderClientInfo();
      renderServices();
      renderMap();
      renderSchedule();
      renderTodo();
      renderNotes();

      // PC版の初期表示設定
      const isMobile = window.innerWidth <= 767.98;
      if (!isMobile) {
        screens.forEach((s, i) => {
          if (i === 0) {
            s.style.display = 'block';
          } else {
            s.style.display = 'none';
          }
        });
      }

      // スケジュール画面のレンダリング
      function renderSchedule() {
        const scheduleContainer = document.getElementById('schedule-container');
        if (!scheduleContainer) return;

        // スケジュールを日付順にソート
        const sortedSchedules = [...schedules].sort((a, b) => {
          const dateA = new Date(a.date + ' ' + a.time);
          const dateB = new Date(b.date + ' ' + b.time);
          return dateA - dateB;
        });

        if (sortedSchedules.length === 0) {
          scheduleContainer.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>スケジュールがありません</p></div>';
          return;
        }
        
        scheduleContainer.innerHTML = sortedSchedules.map(schedule => {
          const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(schedule.address)}`;
          return `
            <div class="schedule-card">
              <div class="schedule-time">
                <span class="schedule-time-hour">${schedule.time}</span>
                <span class="schedule-time-date">${schedule.date}</span>
              </div>
                <div class="schedule-client">${schedule.client_name}</div>
              <div class="schedule-store">${schedule.store_name} - ${schedule.purpose}</div>
              <div class="schedule-actions">
                ${schedule.phone ? `<a href="tel:${schedule.phone}" class="schedule-action-btn"><i class="fas fa-phone"></i> 電話</a>` : ''}
                ${schedule.email ? `<a href="mailto:${schedule.email}" class="schedule-action-btn"><i class="fas fa-envelope"></i> メール</a>` : ''}
                <a href="${mapUrl}" target="_blank" class="schedule-action-btn"><i class="fas fa-map-marker-alt"></i> 地図</a>
              </div>
            </div>
          `;
        }).join('');
      }
      
      // TODOリスト画面のレンダリング
      function renderTodo() {
        const todoList = document.getElementById('todo-list');
        if (!todoList) return;

        if (todos.length === 0) {
          todoList.innerHTML = '<div class="empty-state"><i class="fas fa-tasks"></i><p>TODOがありません</p></div>';
          return;
        }

        todoList.innerHTML = todos.map((todo, index) => `
          <div class="todo-item ${todo.completed ? 'completed' : ''}">
            <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} onchange="toggleTodo(${index})" />
            <span class="todo-text">${todo.text}</span>
            <button class="btn-todo-delete" onclick="deleteTodo(${index})">
              <i class="fas fa-trash"></i>
            </button>
            </div>
        `).join('');
      }

      window.toggleTodo = function(index) {
        todos[index].completed = !todos[index].completed;
        localStorage.setItem('concierge-todos', JSON.stringify(todos));
        renderTodo();
      };

      window.deleteTodo = function(index) {
        todos.splice(index, 1);
        localStorage.setItem('concierge-todos', JSON.stringify(todos));
        renderTodo();
      };

      // TODO追加ボタン
      const btnTodoAdd = document.getElementById('btn-todo-add');
      const todoInput = document.getElementById('todo-input');
      if (btnTodoAdd && todoInput) {
        btnTodoAdd.addEventListener('click', () => {
          const text = todoInput.value.trim();
          if (text) {
            todos.push({ text: text, completed: false });
            localStorage.setItem('concierge-todos', JSON.stringify(todos));
            todoInput.value = '';
            renderTodo();
          }
        });

        todoInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            btnTodoAdd.click();
          }
        });
      }

      // メモ帳画面のレンダリング
      function renderNotes() {
        const notesList = document.getElementById('notes-list');
        if (!notesList) return;

        if (notes.length === 0) {
          notesList.innerHTML = '<div class="empty-state"><i class="fas fa-sticky-note"></i><p>メモがありません</p></div>';
          return;
        }
        
        notesList.innerHTML = notes.map((note, index) => `
          <div class="note-item">
            <div class="note-header">
              <span class="note-date">${note.date}</span>
              <button class="btn-note-delete" onclick="deleteNote(${index})">
                <i class="fas fa-trash"></i>
              </button>
                </div>
            <div class="note-content">${note.content}</div>
              </div>
        `).join('');
      }

      window.deleteNote = function(index) {
        notes.splice(index, 1);
        localStorage.setItem('concierge-notes', JSON.stringify(notes));
        renderNotes();
      };

      // メモ保存ボタン
      const btnNotesSave = document.getElementById('btn-notes-save');
      const notesInput = document.getElementById('notes-input');
      if (btnNotesSave && notesInput) {
        btnNotesSave.addEventListener('click', () => {
          const content = notesInput.value.trim();
          if (content) {
            const now = new Date();
            const dateStr = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 ${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
            notes.unshift({ content: content, date: dateStr });
            localStorage.setItem('concierge-notes', JSON.stringify(notes));
            notesInput.value = '';
            renderNotes();
          }
        });
      }

      // カメラ画面の初期化
      let cameraStream = null;
      let currentFacingMode = 'environment'; // 'user' or 'environment'

      function initCamera() {
        const cameraPreview = document.getElementById('camera-preview');
        const cameraVideo = document.getElementById('camera-video');
        const cameraPlaceholder = cameraPreview.querySelector('.camera-placeholder');
        const btnCameraCapture = document.getElementById('btn-camera-capture');
        const btnCameraSwitch = document.getElementById('btn-camera-switch');
        const cameraGallery = document.getElementById('camera-gallery');

        if (!cameraPreview || !cameraVideo) return;

        // カメラを起動
        navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: currentFacingMode } 
        }).then(stream => {
          cameraStream = stream;
          cameraVideo.srcObject = stream;
          cameraVideo.style.display = 'block';
          if (cameraPlaceholder) {
            cameraPlaceholder.style.display = 'none';
          }
        }).catch(err => {
          console.error('カメラの起動に失敗しました:', err);
          if (cameraPlaceholder) {
            cameraPlaceholder.innerHTML = '<i class="fas fa-exclamation-triangle"></i><p>カメラへのアクセスが拒否されました</p>';
          }
        });

        // 撮影ボタン
        if (btnCameraCapture) {
          btnCameraCapture.addEventListener('click', () => {
            const canvas = document.getElementById('camera-canvas');
            if (canvas && cameraVideo) {
              canvas.width = cameraVideo.videoWidth;
              canvas.height = cameraVideo.videoHeight;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(cameraVideo, 0, 0);
              
              const imageData = canvas.toDataURL('image/jpeg');
              
              // ギャラリーに追加
              if (cameraGallery) {
                const photoItem = document.createElement('div');
                photoItem.className = 'camera-gallery-item';
                photoItem.innerHTML = `
                  <img src="${imageData}" alt="撮影写真">
                  <button class="btn-gallery-delete" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                  </button>
                `;
                cameraGallery.appendChild(photoItem);
              }
            }
          });
        }

        // カメラ切り替えボタン
        if (btnCameraSwitch) {
          btnCameraSwitch.addEventListener('click', () => {
            if (cameraStream) {
              cameraStream.getTracks().forEach(track => track.stop());
            }
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            initCamera();
          });
        }
      }

      // カメラ画面を離れるときにカメラを停止
      const cameraScreen = document.querySelector('.concierge-screen[data-screen="camera"]');
      if (cameraScreen) {
        const observer = new MutationObserver(() => {
          if (!cameraScreen.classList.contains('active') && cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
          }
        });
        observer.observe(cameraScreen, { attributes: true, attributeFilter: ['class'] });
      }

      // 仮見積もり概算画面の処理
      const btnSavePreview = document.getElementById('btn-save-preview');
      const btnSendPreview = document.getElementById('btn-send-preview');

      if (btnSavePreview) {
        btnSavePreview.addEventListener('click', () => {
          // 確認ダイアログを表示
          if (confirm('画面を保存しますか？')) {
            // スクリーンショットを撮影
            captureScreenshot('estimate-preview-content', '仮見積もり概算');
          }
        });
      }

      if (btnSendPreview) {
        btnSendPreview.addEventListener('click', () => {
          // PDF化またはスクリーンショットを取得
          const previewContent = document.getElementById('estimate-preview-content');
          if (previewContent) {
            // スクリーンショットを撮影してから送信
            captureScreenshot('estimate-preview-content', '仮見積もり概算', () => {
              // TODO: 本社に送信する処理を実装（本社情報は別途提供予定）
              alert('仮見積もりを本社に送信しました');
            });
          }
        });
      }

      // スクリーンショット撮影関数
      function captureScreenshot(elementId, filename, callback) {
        const element = document.getElementById(elementId);
        if (!element) {
          alert('スクリーンショットを撮影する要素が見つかりません');
          return;
        }

        // html2canvasライブラリを使用
        if (typeof html2canvas === 'undefined') {
          alert('スクリーンショット機能を利用するには、html2canvasライブラリが必要です。\nページを再読み込みしてください。');
          return;
        }

        // ローディング表示（オプション）
        const loadingMsg = document.createElement('div');
        loadingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 8px; z-index: 10000;';
        loadingMsg.textContent = 'スクリーンショットを撮影中...';
        document.body.appendChild(loadingMsg);

        html2canvas(element, {
          backgroundColor: '#ffffff',
          scale: 2,
          useCORS: true,
          logging: false,
          allowTaint: true
        }).then(canvas => {
          // ローディング表示を削除
          document.body.removeChild(loadingMsg);

          // 画像としてダウンロード
          const link = document.createElement('a');
          link.download = `${filename}_${new Date().getTime()}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();

          if (callback) {
            callback();
          }
        }).catch(err => {
          // ローディング表示を削除
          if (document.body.contains(loadingMsg)) {
            document.body.removeChild(loadingMsg);
          }
          console.error('スクリーンショット撮影エラー:', err);
          alert('スクリーンショットの撮影に失敗しました');
        });
      }

      // ログアウト画面の処理
      const btnLogoutConfirm = document.getElementById('btn-logout-confirm');
      const btnLogoutCancel = document.getElementById('btn-logout-cancel');
      
      if (btnLogoutConfirm) {
        btnLogoutConfirm.addEventListener('click', () => {
          if (window.Auth && window.Auth.logout) {
            window.Auth.logout();
          } else {
            window.location.href = '/signin.html';
          }
        });
      }

      if (btnLogoutCancel) {
        btnLogoutCancel.addEventListener('click', () => {
          // アクティビティ画面に戻る
          const activityIndex = Array.from(screens).findIndex(s => s.dataset.screen === 'activity');
          if (activityIndex !== -1) {
            switchScreen(activityIndex);
          }
        });
      }

      // 最初の画面をアクティブに
      switchScreen(0);
    })();
  </script>
</main>
