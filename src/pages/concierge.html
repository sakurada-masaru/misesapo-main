@layout('layouts.base')
@json('data/meta/concierge_title.json', $title)
@json('data/meta/concierge_body_class.json', $body_class)
@json('data/clients.json', clients_data)
@json('data/sales_schedule.json', schedule_data)
@json('data/new_inquiries.json', inquiries_data)
@json('data/estimates.json', estimates_data)
@json('data/service_items.json', service_items_data)

<main id="main" class="concierge-page">
  <!-- 横スライドコンテナ -->
  <div class="concierge-slider-container">
    <div class="concierge-slider" id="concierge-slider">
      
      <!-- 画面1: アクティビティ画面（デフォルト） -->
      <div class="concierge-screen active" data-screen="activity">
        <div class="screen-header">
          <h1 class="screen-title">アクティビティ</h1>
  </div>

        <!-- 緊急対応が必要な顧客 -->
        <section class="activity-section urgent-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-exclamation-triangle"></i>
        緊急対応が必要な顧客
      </h2>
      <span class="urgent-badge" id="urgent-count">0</span>
    </div>
    <div class="urgent-list" id="urgent-list">
      <!-- Urgent items will be rendered by JavaScript -->
    </div>
  </section>

        <!-- 本日のスケジュール -->
        <section class="activity-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-calendar-day"></i>
        本日のスケジュール
      </h2>
    </div>
    <div class="schedule-list" id="schedule-list">
      <!-- Schedules will be rendered by JavaScript -->
    </div>
  </section>

        <!-- 新規問い合わせ -->
        <section class="activity-section">
    <div class="section-header">
      <h2 class="section-title">
        <i class="fas fa-bell"></i>
        新規問い合わせ
        <span class="notification-badge" id="inquiry-count">0</span>
      </h2>
    </div>
    <div class="inquiry-list" id="inquiry-list">
      <!-- Inquiries will be rendered by JavaScript -->
    </div>
  </section>
      </div>

      <!-- 画面2: 顧客情報画面 -->
      <div class="concierge-screen" data-screen="client">
        <div class="screen-header">
          <h1 class="screen-title">顧客情報</h1>
    </div>
        <div class="client-info-container" id="client-info-container">
          <!-- Client info will be rendered by JavaScript -->
        </div>
        </div>

      <!-- 画面3: サービス・価格画面 -->
      <div class="concierge-screen" data-screen="services">
        <div class="screen-header">
          <h1 class="screen-title">サービス・価格</h1>
      </div>
        <div class="services-container" id="services-container">
          <!-- Services will be rendered by JavaScript -->
        </div>
        </div>

      <!-- 画面4: 仮見積もり作成画面 -->
      <div class="concierge-screen" data-screen="estimate">
        <div class="screen-header">
          <h1 class="screen-title">仮見積もり作成</h1>
      </div>
        <div class="estimate-form-container" id="estimate-form-container">
          <!-- 合計見積もりを最上部に配置 -->
          <div class="estimate-total">
            <span class="total-label">合計見積もり</span>
            <span class="total-value" id="estimate-total">¥0</span>
          </div>
          <!-- 追加されたサービス一覧 -->
          <div class="selected-services" id="selected-services">
            <div class="empty-state">
              <i class="fas fa-shopping-cart"></i>
              <p>サービスを選択してください</p>
            </div>
          </div>
          <div class="estimate-photos" id="estimate-photos">
            <div class="photos-header">
              <h3>写真</h3>
              <button class="btn-photo-add" id="btn-photo-add">
                <i class="fas fa-camera"></i> 追加
              </button>
        </div>
            <div class="photos-grid" id="photos-grid">
              <!-- Photos will be added here -->
        </div>
      </div>
          <div class="estimate-notes">
            <label for="estimate-notes-input">メモ</label>
            <textarea id="estimate-notes-input" class="notes-input" placeholder="メモを入力してください"></textarea>
    </div>
          <div class="estimate-actions">
            <button class="btn-save" id="btn-save-estimate">
              <i class="fas fa-save"></i> 保存
            </button>
            <button class="btn-send" id="btn-send-estimate">
              <i class="fas fa-paper-plane"></i> 送信
            </button>
    </div>
        </div>
      </div>

      <!-- 画面5: 地図画面 -->
      <div class="concierge-screen" data-screen="map">
        <div class="screen-header">
          <h1 class="screen-title">地図</h1>
    </div>
        <div class="map-container" id="map-container">
          <div class="map-placeholder" id="map-placeholder">
            <i class="fas fa-map-marked-alt"></i>
            <p>地図を読み込んでいます...</p>
          </div>
        </div>
        <div class="map-schedule-list" id="map-schedule-list">
          <!-- Schedule items will be rendered by JavaScript -->
        </div>
      </div>

    </div>
  </div>

  <!-- 画面下部固定クイックメニュー -->
  <div class="concierge-quick-menu">
    <button class="quick-menu-btn" data-screen="activity" title="アクティビティ">
      <i class="fas fa-bolt"></i>
      <span>アクティビティ</span>
    </button>
    <button class="quick-menu-btn" data-screen="client" title="顧客情報">
      <i class="fas fa-user"></i>
      <span>顧客</span>
    </button>
    <button class="quick-menu-btn" data-screen="services" title="サービス一覧">
      <i class="fas fa-list"></i>
      <span>サービス</span>
    </button>
    <button class="quick-menu-btn" data-screen="estimate" title="仮見積もり">
        <i class="fas fa-file-invoice"></i>
      <span>見積</span>
    </button>
    <button class="quick-menu-btn" data-screen="map" title="地図">
      <i class="fas fa-map-marked-alt"></i>
      <span>地図</span>
    </button>
  </div>
  
  <!-- 二段目のメニュー -->
  <div class="concierge-quick-menu-second" id="quick-menu-second">
    <a href="/sales/dashboard.html" class="quick-menu-btn-second" title="ダッシュボード">
      <i class="fas fa-tachometer-alt"></i>
      <span>ダッシュボード</span>
    </a>
    <button class="quick-menu-btn-second" data-screen="map" title="地図">
      <i class="fas fa-map-marked-alt"></i>
      <span>地図</span>
    </button>
    <button class="quick-menu-btn-second" data-screen="activity" title="アクティビティ">
      <i class="fas fa-bell"></i>
      <span>アクティビティ</span>
    </button>
    <button class="quick-menu-btn-second" data-screen="client" title="顧客情報">
      <i class="fas fa-user"></i>
      <span>顧客</span>
    </button>
    <button class="quick-menu-btn-second" data-screen="estimate" title="仮見積もり">
      <i class="fas fa-file-invoice"></i>
      <span>見積</span>
    </button>
  </div>


  <!-- Data Scripts -->
  <script type="application/json" id="clients-data">
    @jsonvar $clients_data
  </script>
  <script type="application/json" id="schedule-data">
    @jsonvar $schedule_data
  </script>
  <script type="application/json" id="inquiries-data">
    @jsonvar $inquiries_data
  </script>
  <script type="application/json" id="estimates-data">
    @jsonvar $estimates_data
  </script>
  <script type="application/json" id="service-items-data">
    @jsonvar $service_items_data
  </script>

  <style>
    /* 基本レイアウト */
    .concierge-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      overflow: hidden;
      background: #f9fafb;
      padding-bottom: 80px; /* クイックメニューの高さ分 */
    }

    /* 横スライドコンテナ */
    .concierge-slider-container {
      width: 100%;
      height: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
    }

    .concierge-slider {
      display: flex;
      width: 500vw; /* 5画面分 */
      height: 100%;
    }

    /* 各画面 */
    .concierge-screen {
      width: 100vw;
      height: 100%;
      flex-shrink: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      scroll-snap-align: start;
      scroll-snap-stop: always;
      -webkit-overflow-scrolling: touch;
    }

    .screen-header {
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e5e7eb;
    }

    .screen-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }

    /* アクティビティ画面 */
    .activity-section {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .urgent-section {
      border: 2px solid #ef4444;
      background: #fef2f2;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .section-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-title i {
      color: var(--primary);
    }

    .urgent-badge,
    .notification-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      height: 24px;
      padding: 0 8px;
      background: #ef4444;
      color: #ffffff;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .urgent-list,
    .schedule-list,
    .inquiry-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .urgent-item,
    .schedule-card,
    .inquiry-card {
      padding: 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-left: 4px solid var(--primary);
      border-radius: 8px;
      transition: all 0.2s;
    }

    .urgent-item {
      border-left-color: #ef4444;
      background: #ffffff;
    }

    .urgent-item:active,
    .schedule-card:active,
    .inquiry-card:active {
      transform: scale(0.98);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .urgent-title,
    .schedule-client,
    .inquiry-company {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .urgent-description,
    .schedule-store,
    .inquiry-meta {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0;
    }

    .schedule-time {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .schedule-time-hour {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary);
    }

    .schedule-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .schedule-action-btn {
      flex: 1;
      padding: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      color: #6b7280;
      text-decoration: none;
      text-align: center;
      font-size: 0.875rem;
      transition: all 0.2s;
    }

    .schedule-action-btn:active {
      background: var(--primary);
      color: #ffffff;
      border-color: var(--primary);
    }

    /* 顧客情報画面 */
    .client-info-container {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .client-header {
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }

    .client-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0 0 8px 0;
    }

    .client-store {
      font-size: 1rem;
      color: #6b7280;
      margin: 0;
    }

    .client-contact {
      margin-bottom: 20px;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
      text-decoration: none;
      color: #111827;
    }

    .contact-item:active {
      background: #e5e7eb;
    }

    .contact-item i {
      width: 24px;
      color: var(--primary);
    }

    .client-address {
      margin-bottom: 20px;
    }

    .address-text {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0 0 12px 0;
    }

    .btn-map {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-map:active {
      background: #ff6b9d;
      transform: scale(0.98);
    }

    .client-estimates {
      margin-top: 20px;
    }

    .estimates-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 12px 0;
    }

    .estimate-history-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .estimate-history-date {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0 0 4px 0;
    }

    .estimate-history-service {
      font-size: 0.875rem;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .estimate-history-price {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
    }

    /* サービス・価格画面 */
    .services-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .service-category {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .category-title {
      font-size: 1.125rem;
      font-weight: 700;
      color: #111827;
      margin: 0 0 16px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }

    .service-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .service-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border: 2px solid transparent;
      transition: all 0.2s;
      cursor: pointer;
      text-decoration: none;
      color: inherit;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .service-item:active {
      background: #e5e7eb;
      border-color: var(--primary);
      transform: scale(0.98);
    }
    
    .service-item.double-tap-hint {
      position: relative;
    }
    
    .service-item.double-tap-hint::after {
      content: 'ダブルタップで追加';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #ffffff;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.625rem;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      z-index: 10;
    }
    
    .service-item.double-tap-hint:hover::after {
      opacity: 1;
    }

    .service-item-image {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 8px;
      background: #ffffff;
    }

    .service-item-name {
      font-size: 0.8125rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
      text-align: center;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .service-item-price {
      font-size: 1rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    @media (max-width: 767.98px) {
      .service-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }
      .service-item {
        padding: 6px 4px;
      }
      .service-item-image {
        margin-bottom: 4px;
      }
      .service-item-name {
        font-size: 0.625rem;
        line-height: 1.2;
        margin: 0 0 2px 0;
        -webkit-line-clamp: 2;
      }
      .service-item-price {
        font-size: 0.6875rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
      }
    }

    /* 仮見積もり作成画面 */
    .estimate-form-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .selected-services {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }

    .selected-service-item {
      background: #ffffff;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      overflow: hidden;
      transition: all 0.2s;
    }

    .selected-service-item.expanded {
      border-color: var(--primary);
      box-shadow: 0 2px 8px rgba(255, 107, 157, 0.15);
    }

    .selected-service-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .selected-service-header:hover {
      background: #f9fafb;
    }

    .selected-service-info {
      flex: 1;
      min-width: 0;
    }

    .selected-service-name {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .selected-service-price {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0;
    }

    .selected-service-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-service-memo {
      padding: 8px 12px;
      background: #f3f4f6;
      color: #6b7280;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 4px;
      position: relative;
    }

    .btn-service-memo:hover {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-service-memo.active {
      background: var(--primary);
      color: #ffffff;
    }

    .btn-service-memo i {
      font-size: 0.75rem;
    }

    .memo-badge {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      background: #ef4444;
      border-radius: 50%;
      border: 2px solid #ffffff;
    }

    .memo-badge i {
      display: none;
    }

    .btn-remove-service {
      padding: 8px 16px;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-remove-service:hover {
      background: #dc2626;
    }

    .btn-remove-service:active {
      transform: scale(0.98);
    }

    .selected-service-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }

    .selected-service-item.expanded .selected-service-content {
      max-height: 500px;
      transition: max-height 0.3s ease-in;
    }

    .selected-service-memo {
      padding: 0 16px 16px 16px;
      border-top: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .selected-service-memo label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }

    .selected-service-memo textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
      font-family: inherit;
      resize: vertical;
      transition: border-color 0.2s;
      box-sizing: border-box;
    }

    .selected-service-memo textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.1);
    }

    .estimate-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: linear-gradient(135deg, var(--primary) 0%, #ff6b9d 100%);
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(255, 107, 157, 0.3);
      color: #ffffff;
    }

    .total-label {
      font-size: 1rem;
      font-weight: 600;
    }

    .total-value {
      font-size: 1.75rem;
      font-weight: 700;
    }

    .estimate-photos {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .photos-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .photos-header h3 {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }

    .btn-photo-add {
      padding: 8px 16px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-photo-add:active {
      background: #ff6b9d;
    }

    .photos-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
    }

    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .photo-item .btn-remove-photo {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 24px;
      height: 24px;
      background: rgba(0,0,0,0.6);
      color: #ffffff;
      border: none;
      border-radius: 50%;
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .estimate-notes {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .estimate-notes label {
      display: block;
      font-size: 0.875rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 8px;
    }

    .notes-input {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.875rem;
      font-family: inherit;
      resize: vertical;
    }

    .estimate-actions {
      display: flex;
      gap: 12px;
    }

    .btn-save,
    .btn-send {
      flex: 1;
      padding: 16px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-save {
      background: #f9fafb;
      color: #111827;
      border: 1px solid #e5e7eb;
    }

    .btn-save:active {
      background: #e5e7eb;
    }

    .btn-send {
      background: var(--primary);
      color: #ffffff;
    }

    .btn-send:active {
      background: #ff6b9d;
      transform: scale(0.98);
    }

    /* 地図画面 */
    .map-container {
      width: 100%;
      height: 300px;
      background: #e5e7eb;
      border-radius: 12px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .map-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #6b7280;
    }

    .map-placeholder i {
      font-size: 3rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .map-placeholder p {
      font-size: 0.875rem;
      margin: 0;
    }

    .map-schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .map-schedule-item {
      padding: 16px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .map-schedule-time {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--primary);
      margin: 0 0 8px 0;
    }

    .map-schedule-client {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .map-schedule-store {
      font-size: 0.875rem;
      color: #6b7280;
      margin: 0 0 12px 0;
    }

    .map-schedule-actions {
      display: flex;
      gap: 8px;
    }

    .btn-map-route {
      flex: 1;
      padding: 10px;
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-map-route:active {
      background: #ff6b9d;
    }

    /* 画面下部固定クイックメニュー */
    .concierge-quick-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      padding: 8px 0;
      transition: transform 0.3s ease-out;
      will-change: transform;
    }

    .concierge-quick-menu.slide-up {
      transform: translateY(-100%);
    }

    .quick-menu-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px;
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .quick-menu-btn i {
      font-size: 1.5rem;
    }

    .quick-menu-btn.active {
      color: var(--primary);
    }

    .quick-menu-btn:active {
      transform: scale(0.95);
    }

    /* 二段目のメニュー */
    .concierge-quick-menu-second {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
      z-index: 999;
      padding: 8px 0;
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      will-change: transform;
    }

    .concierge-quick-menu-second.visible {
      transform: translateY(0);
    }

    .quick-menu-btn-second {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px;
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      text-decoration: none;
    }

    .quick-menu-btn-second i {
      font-size: 1.5rem;
    }

    .quick-menu-btn-second.active {
      color: var(--primary);
    }

    .quick-menu-btn-second:active {
      transform: scale(0.95);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }

    .empty-state i {
      font-size: 2.5rem;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 0.95rem;
      margin: 0;
    }

    /* PC対応（縦並び表示） */
    @media (min-width: 768px) {
      .concierge-slider {
        width: 100vw;
        flex-direction: column;
      }

      .concierge-screen {
        width: 100%;
        height: auto;
        min-height: calc(100vh - 80px);
        overflow-y: auto;
        overflow-x: hidden;
        padding-bottom: 160px; /* 二段メニュー分の余白を追加 */
      }

      .concierge-slider-container {
        scroll-snap-type: none;
        overflow-y: auto;
        overflow-x: hidden;
      }
      
      /* PC版では最初の画面のみ表示 */
      .concierge-screen:not(.active) {
        display: none;
      }
    }
  </style>

  <script>
    // データ読み込み
    (function() {
      const clientsData = JSON.parse(document.getElementById('clients-data').textContent);
      const scheduleData = JSON.parse(document.getElementById('schedule-data').textContent);
      const inquiriesData = JSON.parse(document.getElementById('inquiries-data').textContent);
      const estimatesData = JSON.parse(document.getElementById('estimates-data').textContent);
      const serviceItemsData = JSON.parse(document.getElementById('service-items-data').textContent);
      
      const clients = clientsData.clients || [];
      const schedules = scheduleData.schedules || [];
      const inquiries = inquiriesData.inquiries || [];
      const estimates = estimatesData.estimates || [];
      const serviceItems = serviceItemsData || [];

      // 横スライド機能
      const slider = document.getElementById('concierge-slider');
      const screens = document.querySelectorAll('.concierge-screen');
      const quickMenuBtns = document.querySelectorAll('.quick-menu-btn[data-screen]');
      let currentScreen = 0;
      let isScrolling = false;

      // 画面切り替え
      function switchScreen(index) {
        if (index < 0 || index >= screens.length) return;
        currentScreen = index;
        const screen = screens[index];
        const screenName = screen.dataset.screen;
        
        // PC版とSP版で異なる処理
        const isMobile = window.innerWidth <= 767.98;
        
        if (isMobile) {
          // SP版: 横スライドで切り替え
          slider.scrollTo({
            left: index * window.innerWidth,
            behavior: 'smooth'
          });
        } else {
          // PC版: 直接表示（横スライドなし）
          // 各画面を縦に並べて表示
          screens.forEach((s, i) => {
            if (i === index) {
              s.style.display = 'block';
            } else {
              s.style.display = 'none';
            }
          });
        }

        // アクティブ状態を更新
        screens.forEach(s => s.classList.remove('active'));
        screen.classList.add('active');
        
        // 一段目のメニューボタンのアクティブ状態を更新
        quickMenuBtns.forEach(btn => {
          if (btn.dataset.screen === screenName) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        // 二段目のメニューボタンのアクティブ状態も更新
        const quickMenuBtnsSecond = document.querySelectorAll('.quick-menu-btn-second[data-screen]');
        quickMenuBtnsSecond.forEach(btn => {
          if (btn.dataset.screen === screenName) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });

        // 画面固有の処理
        if (screenName === 'client') {
          renderClientInfo();
        } else if (screenName === 'services') {
          renderServices();
        } else if (screenName === 'map') {
          renderMap();
        }
      }
      
      // リサイズ時に画面表示を調整
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          const isMobile = window.innerWidth <= 767.98;
          if (!isMobile) {
            // PC版: 現在の画面のみ表示
            screens.forEach((s, i) => {
              if (i === currentScreen) {
                s.style.display = 'block';
              } else {
                s.style.display = 'none';
              }
            });
          } else {
            // SP版: すべて表示して横スライド可能に
            screens.forEach(s => {
              s.style.display = 'block';
            });
          }
        }, 100);
      });

      // クイックメニューボタンクリック
      quickMenuBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          const screenName = btn.dataset.screen;
          if (screenName) {
            const screenIndex = Array.from(screens).findIndex(s => s.dataset.screen === screenName);
            if (screenIndex !== -1) {
              switchScreen(screenIndex);
            }
          }
        });
      });

      // スワイプ検出
      let touchStartX = 0;
      let touchEndX = 0;

      slider.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });

      slider.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
      }, { passive: true });

      function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
          if (diff > 0) {
            // 左スワイプ（次の画面）
            switchScreen(currentScreen + 1);
          } else {
            // 右スワイプ（前の画面）
            switchScreen(currentScreen - 1);
          }
        }
      }

      // スクロール位置の監視
      slider.addEventListener('scroll', () => {
        if (isScrolling) return;
        const scrollLeft = slider.scrollLeft;
        const screenIndex = Math.round(scrollLeft / window.innerWidth);
        if (screenIndex !== currentScreen && screenIndex >= 0 && screenIndex < screens.length) {
          currentScreen = screenIndex;
          const screen = screens[screenIndex];
          const screenName = screen.dataset.screen;
          
          screens.forEach(s => s.classList.remove('active'));
          screen.classList.add('active');
          
          quickMenuBtns.forEach(btn => {
            if (btn.dataset.screen === screenName) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
        }
      }, { passive: true });

      // アクティビティ画面のレンダリング
      function renderActivity() {
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
      const todaySchedules = schedules.filter(s => s.date === todayStr);
      
        // 緊急対応
      const urgentItems = [];
      const threeDaysAgo = new Date();
      threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
      threeDaysAgo.setHours(0, 0, 0, 0);
      
      estimates.filter(e => e.status === 'sent' && e.sent_date).forEach(estimate => {
        try {
          const dateStr = estimate.sent_date.replace(/年/g, '-').replace(/月/g, '-').replace(/日/g, '');
          const parts = dateStr.split('-');
          if (parts.length === 3) {
            const year = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10);
            const day = parseInt(parts[2], 10);
            const sentDate = new Date(year, month - 1, day);
            sentDate.setHours(0, 0, 0, 0);
            
            if (sentDate < threeDaysAgo) {
              urgentItems.push({
                type: 'estimate',
                title: `見積もり承認待ち: ${estimate.client_name} ${estimate.store_name}`,
                description: `${estimate.sent_date}送付済み（${estimate.total}）`,
                  link: `/sales/estimates/${estimate.id}.html`
              });
            }
          }
        } catch (e) {
          console.error('Error parsing date:', estimate.sent_date, e);
        }
      });
      
      inquiries.filter(i => i.status === 'pending').forEach(inquiry => {
        urgentItems.push({
          type: 'inquiry',
          title: `新規問い合わせ: ${inquiry.company_name}`,
          description: `${inquiry.date} ${inquiry.time} - ${inquiry.message}`,
            link: `/sales/clients/new.html?inquiry=${inquiry.id}`
        });
      });
      
        // 緊急対応レンダリング
        const urgentListEl = document.getElementById('urgent-list');
        const urgentCountEl = document.getElementById('urgent-count');
        if (urgentListEl) {
        urgentCountEl.textContent = urgentItems.length;
        if (urgentItems.length === 0) {
            urgentListEl.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>緊急対応が必要な項目はありません</p></div>';
          } else {
            urgentListEl.innerHTML = urgentItems.map(item => `
            <div class="urgent-item" onclick="window.location.href='${item.link}'">
                <div class="urgent-title">${item.title}</div>
                <div class="urgent-description">${item.description}</div>
              </div>
            `).join('');
          }
        }

        // スケジュールレンダリング
        const scheduleListEl = document.getElementById('schedule-list');
        if (scheduleListEl) {
        if (todaySchedules.length === 0) {
            scheduleListEl.innerHTML = '<div class="empty-state"><i class="fas fa-calendar-times"></i><p>本日の予定はありません</p></div>';
          } else {
        scheduleListEl.innerHTML = todaySchedules.map(schedule => {
          const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(schedule.address)}`;
          return `
            <div class="schedule-card">
              <div class="schedule-time">
                    <span class="schedule-time-hour">${schedule.time}</span>
              </div>
                <div class="schedule-client">${schedule.client_name}</div>
                  <div class="schedule-store">${schedule.store_name} - ${schedule.purpose}</div>
              <div class="schedule-actions">
                    ${schedule.phone ? `<a href="tel:${schedule.phone}" class="schedule-action-btn"><i class="fas fa-phone"></i> 電話</a>` : ''}
                    ${schedule.email ? `<a href="mailto:${schedule.email}" class="schedule-action-btn"><i class="fas fa-envelope"></i> メール</a>` : ''}
                    <a href="${mapUrl}" target="_blank" class="schedule-action-btn"><i class="fas fa-map-marker-alt"></i> 地図</a>
              </div>
            </div>
          `;
        }).join('');
          }
      }
      
        // 問い合わせレンダリング
        const inquiryListEl = document.getElementById('inquiry-list');
        const inquiryCountEl = document.getElementById('inquiry-count');
        if (inquiryListEl) {
        const pendingInquiries = inquiries.filter(i => i.status === 'pending');
        inquiryCountEl.textContent = pendingInquiries.length;
        if (pendingInquiries.length === 0) {
            inquiryListEl.innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>新規問い合わせはありません</p></div>';
          } else {
            inquiryListEl.innerHTML = pendingInquiries.slice(0, 5).map(inquiry => `
              <div class="inquiry-card" onclick="window.location.href='/sales/clients/new.html?inquiry=${inquiry.id}'">
                <div class="inquiry-company">${inquiry.company_name}</div>
                <div class="inquiry-meta">${inquiry.date} ${inquiry.time} - ${inquiry.message}</div>
            </div>
            `).join('');
          }
        }
      }

      // 顧客情報画面のレンダリング
      function renderClientInfo() {
        const clientInfoContainer = document.getElementById('client-info-container');
        if (!clientInfoContainer) return;

        // 本日の最初のスケジュールの顧客を表示
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const todaySchedules = schedules.filter(s => s.date === todayStr);
        
        if (todaySchedules.length === 0) {
          clientInfoContainer.innerHTML = '<div class="empty-state"><i class="fas fa-user"></i><p>本日のスケジュールがありません</p></div>';
          return;
        }
        
        const firstSchedule = todaySchedules[0];
        const client = clients.find(c => c.id === firstSchedule.client_id);

        if (!client) {
          clientInfoContainer.innerHTML = '<div class="empty-state"><i class="fas fa-user"></i><p>顧客情報が見つかりません</p></div>';
          return;
        }

        const clientEstimates = estimates.filter(e => e.client_id === client.id);
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(client.address || firstSchedule.address)}`;

        clientInfoContainer.innerHTML = `
          <div class="client-header">
            <h2 class="client-name">${client.company_name || client.name}</h2>
            <p class="client-store">${client.store_name || firstSchedule.store_name}</p>
                </div>
          <div class="client-contact">
            ${client.phone ? `<a href="tel:${client.phone}" class="contact-item"><i class="fas fa-phone"></i><span>${client.phone}</span></a>` : ''}
            ${client.email ? `<a href="mailto:${client.email}" class="contact-item"><i class="fas fa-envelope"></i><span>${client.email}</span></a>` : ''}
              </div>
          <div class="client-address">
            <p class="address-text">${client.address || firstSchedule.address}</p>
            <a href="${mapUrl}" target="_blank" class="btn-map"><i class="fas fa-map-marker-alt"></i> 地図で開く</a>
            </div>
          ${clientEstimates.length > 0 ? `
            <div class="client-estimates">
              <h3 class="estimates-title">過去の見積もり</h3>
              ${clientEstimates.slice(0, 5).map(est => `
                <div class="estimate-history-item">
                  <p class="estimate-history-date">${est.created_date || est.sent_date}</p>
                  <p class="estimate-history-service">${est.service_name || 'サービス'}</p>
                  <p class="estimate-history-price">${est.total}</p>
                </div>
              `).join('')}
            </div>
          ` : ''}
        `;
      }

      // サービス・価格画面のレンダリング
      function renderServices() {
        const servicesContainer = document.getElementById('services-container');
        if (!servicesContainer) return;

        // カテゴリ別にグループ化
        const servicesByCategory = {};
        serviceItems.forEach(item => {
          const category = item.category || 'その他';
          if (!servicesByCategory[category]) {
            servicesByCategory[category] = [];
          }
          servicesByCategory[category].push(item);
        });

        servicesContainer.innerHTML = Object.keys(servicesByCategory).map(category => {
          const categoryServices = servicesByCategory[category];
          // 4x4グリッド用に16個ずつに分割
          const chunks = [];
          for (let i = 0; i < categoryServices.length; i += 16) {
            chunks.push(categoryServices.slice(i, i + 16));
          }
          
          return chunks.map((chunk, chunkIndex) => `
            <div class="service-category">
              <h3 class="category-title">${category}${chunks.length > 1 ? ` (${chunkIndex + 1})` : ''}</h3>
              <div class="service-grid">
                ${chunk.map(item => {
                  const imagePath = item.image || item['detail-image'] || 'images/placeholder.png';
                  return `
                    <div class="service-item" data-service-id="${item.id}" data-service-name="${item.title.replace(/"/g, '&quot;')}" data-service-price="${item.price}">
                      <img src="${imagePath}" alt="${item.title}" class="service-item-image" onerror="this.src='images/placeholder.png'" />
                      <div class="service-item-name">${item.title}</div>
                      <div class="service-item-price">${item.price}</div>
                    </div>
                  `;
                }).join('')}
              </div>
            </div>
          `).join('');
        }).join('');
        
        // サービスカードにダブルクリックイベントを追加
        const serviceItems = document.querySelectorAll('.service-item[data-service-id]');
        serviceItems.forEach(item => {
          let clickTimer = null;
          
          // シングルクリック（タップ）: 何もしない（または詳細表示など）
          item.addEventListener('click', (e) => {
            if (clickTimer === null) {
              clickTimer = setTimeout(() => {
                clickTimer = null;
                // シングルクリック時の処理（必要に応じて実装）
              }, 300);
            }
          });
          
          // ダブルクリック（タップ）: 見積もりに追加
          item.addEventListener('dblclick', (e) => {
            e.preventDefault();
            e.stopPropagation();
            if (clickTimer) {
              clearTimeout(clickTimer);
              clickTimer = null;
            }
            const serviceId = parseInt(item.dataset.serviceId, 10);
            const serviceName = item.dataset.serviceName;
            const servicePrice = item.dataset.servicePrice;
            addServiceToEstimate(serviceId, serviceName, servicePrice);
          });
          
          // タッチデバイス用のダブルタップ検出
          let lastTap = 0;
          item.addEventListener('touchend', (e) => {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 300 && tapLength > 0) {
              // ダブルタップ検出
              e.preventDefault();
              e.stopPropagation();
              if (clickTimer) {
                clearTimeout(clickTimer);
                clickTimer = null;
              }
              const serviceId = parseInt(item.dataset.serviceId, 10);
              const serviceName = item.dataset.serviceName;
              const servicePrice = item.dataset.servicePrice;
              addServiceToEstimate(serviceId, serviceName, servicePrice);
            } else {
              // シングルタップ
              if (clickTimer === null) {
                clickTimer = setTimeout(() => {
                  clickTimer = null;
                }, 300);
              }
            }
            lastTap = currentTime;
          }, { passive: false });
        });
      }

      // 仮見積もりにサービスを追加
      window.addServiceToEstimate = function(id, name, price) {
        const selectedServices = document.getElementById('selected-services');
        const emptyState = selectedServices.querySelector('.empty-state');
        if (emptyState) {
          emptyState.remove();
        }

        // 既に同じサービスが追加されているかチェック
        const existingItem = selectedServices.querySelector(`.selected-service-item[data-service-id="${id}"]`);
        if (existingItem) {
          // 既に追加されている場合は、その項目を開く
          toggleServiceMemo(existingItem.querySelector('.btn-service-memo'));
          return;
        }

        // 価格から数値を抽出（¥ 21,000〜 → 21000）
        const priceMatch = price.match(/¥\s*([\d,]+)/);
        const priceValue = priceMatch ? parseInt(priceMatch[1].replace(/,/g, ''), 10) : 0;

        const serviceItem = document.createElement('div');
        serviceItem.className = 'selected-service-item';
        serviceItem.dataset.serviceId = id;
        serviceItem.dataset.priceValue = priceValue;
        serviceItem.innerHTML = `
          <div class="selected-service-header" onclick="toggleServiceMemo(this.querySelector('.btn-service-memo'))">
            <div class="selected-service-info">
              <p class="selected-service-name">${name}</p>
              <p class="selected-service-price">${price}</p>
            </div>
            <div class="selected-service-actions" onclick="event.stopPropagation()">
              <button class="btn-service-memo" onclick="toggleServiceMemo(this)" title="メモ">
                <i class="fas fa-sticky-note"></i>
                <span>メモ</span>
              </button>
              <button class="btn-remove-service" onclick="removeServiceFromEstimate(this)">削除</button>
            </div>
          </div>
          <div class="selected-service-content">
            <div class="selected-service-memo">
              <label for="service-memo-${id}">備考</label>
              <textarea id="service-memo-${id}" class="service-memo-input" placeholder="このサービスに関する備考を入力してください" oninput="saveServiceMemo(${id}, this.value)"></textarea>
            </div>
          </div>
        `;
        selectedServices.appendChild(serviceItem);
        updateEstimateTotal();
        
        // 仮見積もり画面に切り替え
        switchScreen(3);
      };

      // サービスメモの開閉
      window.toggleServiceMemo = function(btn) {
        const serviceItem = btn.closest('.selected-service-item');
        if (!serviceItem) return;

        const isExpanded = serviceItem.classList.contains('expanded');
        
        if (isExpanded) {
          serviceItem.classList.remove('expanded');
          btn.classList.remove('active');
        } else {
          serviceItem.classList.add('expanded');
          btn.classList.add('active');
          // メモ入力欄にフォーカス
          const memoTextarea = serviceItem.querySelector('.service-memo-input');
          if (memoTextarea) {
            setTimeout(() => {
              memoTextarea.focus();
            }, 100);
          }
        }
      };

      // サービスメモを保存
      window.saveServiceMemo = function(serviceId, memo) {
        const serviceItem = document.querySelector(`.selected-service-item[data-service-id="${serviceId}"]`);
        if (serviceItem) {
          serviceItem.dataset.memo = memo;
          // メモがある場合はメモボタンにバッジを表示
          const memoBtn = serviceItem.querySelector('.btn-service-memo');
          if (memo && memo.trim()) {
            if (!memoBtn.querySelector('.memo-badge')) {
              const badge = document.createElement('span');
              badge.className = 'memo-badge';
              badge.innerHTML = '<i class="fas fa-circle"></i>';
              memoBtn.appendChild(badge);
            }
          } else {
            const badge = memoBtn.querySelector('.memo-badge');
            if (badge) {
              badge.remove();
            }
          }
        }
      };

      // 仮見積もりからサービスを削除
      window.removeServiceFromEstimate = function(btn) {
        btn.closest('.selected-service-item').remove();
        const selectedServices = document.getElementById('selected-services');
        if (selectedServices.children.length === 0) {
          selectedServices.innerHTML = '<div class="empty-state"><i class="fas fa-shopping-cart"></i><p>サービスを選択してください</p></div>';
        }
        updateEstimateTotal();
      };

      // 見積もり合計を更新
      function updateEstimateTotal() {
        const selectedItems = document.querySelectorAll('.selected-service-item');
        let total = 0;
        selectedItems.forEach(item => {
          const priceValue = parseInt(item.dataset.priceValue || '0', 10);
          total += priceValue;
        });
        document.getElementById('estimate-total').textContent = total > 0 ? `¥${total.toLocaleString()}` : '¥0';
      }

      // 下部メニューのスライド機能
      const quickMenu = document.querySelector('.concierge-quick-menu');
      const quickMenuSecond = document.getElementById('quick-menu-second');
      let menuSlideStartY = 0;
      let menuSlideCurrentY = 0;
      let isMenuSliding = false;
      const menuHeight = quickMenu ? quickMenu.offsetHeight : 0;

      if (quickMenu) {
        // タッチイベントでスライド検出
        quickMenu.addEventListener('touchstart', (e) => {
          menuSlideStartY = e.touches[0].clientY;
          isMenuSliding = true;
        }, { passive: true });

        quickMenu.addEventListener('touchmove', (e) => {
          if (!isMenuSliding) return;
          menuSlideCurrentY = e.touches[0].clientY;
          const deltaY = menuSlideStartY - menuSlideCurrentY;
          
          // 上にスワイプ（deltaY > 0）の場合のみ処理
          if (deltaY > 0 && deltaY > 30) {
            quickMenu.classList.add('slide-up');
            if (quickMenuSecond) {
              quickMenuSecond.classList.add('visible');
            }
          } else if (deltaY < -30) {
            // 下にスワイプで閉じる
            quickMenu.classList.remove('slide-up');
            if (quickMenuSecond) {
              quickMenuSecond.classList.remove('visible');
            }
          }
        }, { passive: true });

        quickMenu.addEventListener('touchend', () => {
          isMenuSliding = false;
        }, { passive: true });

        // 二段目のメニューも同様にスワイプで閉じられるように
        if (quickMenuSecond) {
          quickMenuSecond.addEventListener('touchstart', (e) => {
            menuSlideStartY = e.touches[0].clientY;
            isMenuSliding = true;
          }, { passive: true });

          quickMenuSecond.addEventListener('touchmove', (e) => {
            if (!isMenuSliding) return;
            menuSlideCurrentY = e.touches[0].clientY;
            const deltaY = menuSlideStartY - menuSlideCurrentY;
            
            // 下にスワイプ（deltaY < 0）で閉じる
            if (deltaY < -30) {
              quickMenu.classList.remove('slide-up');
              quickMenuSecond.classList.remove('visible');
            }
          }, { passive: true });

          quickMenuSecond.addEventListener('touchend', () => {
            isMenuSliding = false;
          }, { passive: true });
        }
      }

      // 写真撮影機能（削除）
      const photosGrid = document.getElementById('photos-grid');

      // 写真追加ボタンのクリックイベント（ファイル選択ダイアログを開く）
      const btnPhotoAdd = document.getElementById('btn-photo-add');
      if (btnPhotoAdd) {
        // 一時的なファイル入力を作成
        const photoInput = document.createElement('input');
        photoInput.type = 'file';
        photoInput.accept = 'image/*';
        photoInput.multiple = true;
        photoInput.style.display = 'none';
        document.body.appendChild(photoInput);

        btnPhotoAdd.addEventListener('click', () => {
          photoInput.click();
        });

        photoInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (event) => {
              const photoItem = document.createElement('div');
              photoItem.className = 'photo-item';
              photoItem.innerHTML = `
                <img src="${event.target.result}" alt="写真">
                <button class="btn-remove-photo" onclick="removePhoto(this)"><i class="fas fa-times"></i></button>
              `;
              photosGrid.appendChild(photoItem);
            };
            reader.readAsDataURL(file);
          }
        });
        e.target.value = ''; // 同じファイルを再度選択できるように
      });

      window.removePhoto = function(btn) {
        btn.closest('.photo-item').remove();
      };

      // 見積もり保存・送信
      document.getElementById('btn-save-estimate').addEventListener('click', () => {
        const selectedItems = document.querySelectorAll('.selected-service-item');
        const photos = Array.from(photosGrid.querySelectorAll('img')).map(img => img.src);
        const notes = document.getElementById('estimate-notes-input').value;
        
        // TODO: 実際の保存処理を実装
        alert('仮見積もりを保存しました');
      });

      document.getElementById('btn-send-estimate').addEventListener('click', () => {
        const selectedItems = document.querySelectorAll('.selected-service-item');
        if (selectedItems.length === 0) {
          alert('サービスを選択してください');
          return;
        }
        
        // TODO: 実際の送信処理を実装
        alert('仮見積もりを送信しました');
      });

      // 地図画面のレンダリング
      function renderMap() {
        const mapScheduleList = document.getElementById('map-schedule-list');
        if (!mapScheduleList) return;

        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const todaySchedules = schedules.filter(s => s.date === todayStr);

        if (todaySchedules.length === 0) {
          mapScheduleList.innerHTML = '<div class="empty-state"><i class="fas fa-map-marked-alt"></i><p>本日のスケジュールがありません</p></div>';
          return;
        }

        mapScheduleList.innerHTML = todaySchedules.map(schedule => {
          const mapUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(schedule.address)}`;
          return `
            <div class="map-schedule-item">
              <p class="map-schedule-time">${schedule.time}</p>
              <p class="map-schedule-client">${schedule.client_name}</p>
              <p class="map-schedule-store">${schedule.store_name}</p>
              <div class="map-schedule-actions">
                <a href="${mapUrl}" target="_blank" class="btn-map-route"><i class="fas fa-route"></i> ルート</a>
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(schedule.address)}" target="_blank" class="btn-map-route"><i class="fas fa-map-marker-alt"></i> 地図</a>
              </div>
            </div>
          `;
        }).join('');

        // 地図プレースホルダーに地図リンクを表示
        const mapPlaceholder = document.getElementById('map-placeholder');
        if (mapPlaceholder && todaySchedules.length > 0) {
          const firstSchedule = todaySchedules[0];
          // 実際の実装ではGoogle Maps APIキーが必要
          // 現在は地図リンクのみ表示
          mapPlaceholder.innerHTML = `
            <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(firstSchedule.address)}" target="_blank" style="text-decoration: none; color: inherit;">
              <i class="fas fa-map-marked-alt"></i>
              <p>地図を開く</p>
            </a>
          `;
        }
      }

      // 初期レンダリング
      renderActivity();
      renderClientInfo();
      renderServices();
      renderMap();

      // PC版の初期表示設定
      const isMobile = window.innerWidth <= 767.98;
      if (!isMobile) {
        screens.forEach((s, i) => {
          if (i === 0) {
            s.style.display = 'block';
          } else {
            s.style.display = 'none';
          }
        });
      }

      // 最初の画面をアクティブに
      switchScreen(0);
    })();
  </script>
</main>
