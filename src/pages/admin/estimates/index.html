@layout('layouts.admin')
@json('data/meta/admin_estimates_title.json', $title)
@json('data/meta/admin_estimates_body_class.json', $body_class)

<style>
  :root {
    --sidebar-width: 240px;
    --sidebar-width-collapsed: 64px;
    --topbar-height: 64px;
      --primary: #3b82f6;
  }

  .admin-estimates-v2 {
    display: flex;
    min-height: 100vh;
    background: #f9fafb;
  }

  .logo-link {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: inherit;
  }
  .logo-img {
    width: 32px;
    height: 32px;
    object-fit: contain;
    flex-shrink: 0;
  }
  .logo-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    white-space: nowrap;
    transition: opacity 0.3s ease;
  }
  
  .sidebar-role .role-badge {
    display: inline-block;
    padding: 3px 10px;
    background: #e0e7ff;
    color: #3730a3;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    white-space: nowrap;
  }

  .nav-label {
    transition: opacity 0.3s ease;
    white-space: nowrap;
    font-size: 0.8125rem;
  }

  .sidebar.collapsed 
  .nav-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 8px 12px;
  }

  /* メインコンテンツ */
  .main-content {
      margin-left: var(--sidebar-width) !important;
      padding: 24px;
      background: #f9fafb;
      width: calc(100% - var(--sidebar-width)) !important;
      max-width: none !important;
      box-sizing: border-box;
      transition: margin-left 0.3s ease, width 0.3s ease;
    }
  .sidebar.collapsed ~ .main-content {
      margin-left: var(--sidebar-width-collapsed) !important;
      padding: 24px;
      background: #f9fafb;
      width: calc(100% - var(--sidebar-width-collapsed)) !important;
      max-width: none !important;
      box-sizing: border-box;
      transition: margin-left 0.3s ease, width 0.3s ease;
    }

  .estimates-page {
    padding: 0;
    max-width: 100%;
    margin: 0;
  }
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .page-header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111;
    margin: 0;
  }
  .stats-row {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  .stat-card {
    background: #fff;
    border-radius: 12px;
    padding: 16px 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-width: 140px;
  }
  .stat-card.pending { border-left: 4px solid #f59e0b; }
  .stat-card.processing { border-left: 4px solid #3b82f6; }
  .stat-card.completed { border-left: 4px solid #10b981; }
  .stat-label { font-size: 0.8rem; color: #666; }
  .stat-value { font-size: 1.75rem; font-weight: 700; color: #111; }

  .filter-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .filter-bar select, .filter-bar input {
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.9rem;
  }
  .filter-bar input { flex: 1; min-width: 200px; }

  .estimates-table {
    width: 100%;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .estimates-table th, .estimates-table td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid #eee;
  }
  .estimates-table th {
    background: #f9fafb;
    font-weight: 600;
    font-size: 0.8rem;
    color: #666;
    text-transform: uppercase;
  }
  .estimates-table tr:hover { background: #f9fafb; }
  .estimates-table tr:last-child td { border-bottom: none; }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .status-pending { background: #fef3c7; color: #92400e; }
  .status-processing { background: #dbeafe; color: #1e40af; }
  .status-completed { background: #d1fae5; color: #065f46; }
  .status-rejected { background: #fee2e2; color: #991b1b; }

  .amount { font-weight: 600; color: #111; }
  .date { color: #666; font-size: 0.85rem; }
  .store-name { font-weight: 500; }

  .action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    margin-right: 6px;
  }
  .btn-view { background: #e0e7ff; color: #3730a3; }
  .btn-process { background: #dbeafe; color: #1e40af; }
  .btn-complete { background: #d1fae5; color: #065f46; }
  .btn-reject { background: #fee2e2; color: #991b1b; }

  /* モーダル */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: #fff;
    border-radius: 16px;
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .modal-header h2 { margin: 0; font-size: 1.25rem; }
  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
  }
  .modal-body { padding: 24px; }
  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }

  .detail-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  .detail-label { color: #666; }
  .detail-value { font-weight: 500; }

  .items-list {
    margin-top: 16px;
    background: #f9fafb;
    border-radius: 8px;
    padding: 12px;
  }
  .items-list h4 { margin: 0 0 12px; font-size: 0.9rem; color: #333; }
  .item-row, .item-row-edit {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
  }
  .item-row:last-child, .item-row-edit:last-child { border-bottom: none; }
  .item-info {
    flex: 1;
  }
  .item-name { 
    color: #333; 
    display: block;
    margin-bottom: 4px;
  }
  .item-multiplier { color: #666; font-size: 0.8rem; }
  .item-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-top: 4px;
  }
  .item-controls label {
    font-size: 0.875rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .item-multiplier-input {
    width: 60px;
    padding: 4px 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 0.875rem;
  }
  .btn-remove-item {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.75rem;
  }
  .btn-remove-item:hover {
    background: #dc2626;
  }
  .item-price { 
    font-weight: 600; 
    min-width: 100px;
    text-align: right;
  }
  .form-textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    font-family: inherit;
    resize: vertical;
  }
  .btn-edit {
    background: #e0e7ff;
    color: #3730a3;
  }
  .items-total {
    display: flex;
    justify-content: space-between;
    padding-top: 12px;
    margin-top: 8px;
    border-top: 2px solid #ddd;
    font-weight: 700;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }
  .empty-state i { font-size: 3rem; color: #ddd; margin-bottom: 16px; }

  @media (max-width: 768px) {
    .estimates-table { display: block; overflow-x: auto; }
    .stat-card { flex: 1; min-width: 100px; }
  }
</style>

<main id="main" class="admin-estimates-v2">
  @include('partials.admin-sidebar')
  <!-- メインコンテンツ -->
  <div class="main-content">
    <div class="estimates-page">
  <div class="page-header">
    <h1><i class="fas fa-file-invoice-dollar"></i> 仮見積もり管理</h1>
  </div>

  <div class="stats-row">
    <div class="stat-card pending">
      <div class="stat-label">未処理</div>
      <div class="stat-value" id="stat-pending">0</div>
    </div>
    <div class="stat-card processing">
      <div class="stat-label">作成中</div>
      <div class="stat-value" id="stat-processing">0</div>
    </div>
    <div class="stat-card completed">
      <div class="stat-label">完了</div>
      <div class="stat-value" id="stat-completed">0</div>
    </div>
  </div>

  <div class="filter-bar">
    <select id="filter-status">
      <option value="">すべてのステータス</option>
      <option value="pending">未処理</option>
      <option value="processing">本見積作成中</option>
      <option value="completed">完了</option>
      <option value="rejected">却下</option>
    </select>
    <input type="text" id="filter-search" placeholder="店舗名で検索...">
  </div>

  <table class="estimates-table">
    <thead>
      <tr>
        <th>見積もり番号</th>
        <th>店舗名</th>
        <th>金額</th>
        <th>ステータス</th>
        <th>作成日</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="estimates-body">
      <tr>
        <td colspan="6">
          <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>読み込み中...</p>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- 詳細モーダル -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal">
    <div class="modal-header">
      <h2>見積もり詳細</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modal-body">
      <!-- 動的に挿入 -->
    </div>
    <div class="modal-footer" id="modal-footer">
      <!-- 動的に挿入 -->
    </div>
    </div>
  </div>
</main>

<script>
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  let allEstimates = [];
  let allStores = [];
  let currentEstimate = null;

  const statusLabels = {
    pending: '未処理',
    processing: '本見積作成中',
    completed: '完了',
    rejected: '却下'
  };

  document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([loadEstimates(), loadStores()]);
    setupFilters();
      
  });

  async function loadEstimates() {
    try {
      const res = await fetch(`${API_BASE}/estimates`);
      if (!res.ok) {
        const errorText = await res.text();
        console.error('API Error:', res.status, errorText);
        throw new Error(`Failed to load: ${res.status} ${errorText}`);
      }
      const data = await res.json();
      // APIレスポンスが {estimates: [], count: 0} の形式の場合
      allEstimates = data.estimates || data || [];
      renderEstimates();
      updateStats();
    } catch (e) {
      console.error('Error loading estimates:', e);
      document.getElementById('estimates-body').innerHTML = `
        <tr><td colspan="6"><div class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <p>データの読み込みに失敗しました</p>
          <p style="font-size: 0.8rem; color: #666; margin-top: 8px;">${e.message}</p>
        </div></td></tr>`;
    }
  }

  async function loadStores() {
    try {
      const res = await fetch(`${API_BASE}/stores`);
      if (res.ok) allStores = await res.json();
    } catch (e) {
      console.error('Error loading stores:', e);
    }
  }

  function setupFilters() {
    document.getElementById('filter-status').addEventListener('change', renderEstimates);
    document.getElementById('filter-search').addEventListener('input', renderEstimates);
  }

  function renderEstimates() {
    const statusFilter = document.getElementById('filter-status').value;
    const searchFilter = document.getElementById('filter-search').value.toLowerCase();

    let filtered = allEstimates;

    if (statusFilter) {
      filtered = filtered.filter(e => e.status === statusFilter);
    }
    if (searchFilter) {
      filtered = filtered.filter(e => 
        (e.store_name || '').toLowerCase().includes(searchFilter)
      );
    }

    const tbody = document.getElementById('estimates-body');

    if (filtered.length === 0) {
      tbody.innerHTML = `
        <tr><td colspan="6"><div class="empty-state">
          <i class="fas fa-inbox"></i>
          <p>仮見積もりがありません</p>
        </div></td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(est => {
      const date = new Date(est.created_at);
      const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
      
      return `
        <tr>
          <td><strong>${escapeHtml(est.id)}</strong></td>
          <td class="store-name">${escapeHtml(est.store_name || '不明')}</td>
          <td class="amount">¥${(est.total || 0).toLocaleString()}</td>
          <td><span class="status-badge status-${est.status}">${statusLabels[est.status] || est.status}</span></td>
          <td class="date">${dateStr}</td>
          <td>
            <button class="action-btn btn-view" onclick="viewEstimate('${est.id}')">
              <i class="fas fa-eye"></i> 詳細
            </button>
            ${est.status === 'pending' ? `
              <button class="action-btn btn-process" onclick="updateStatus('${est.id}', 'processing')">
                <i class="fas fa-edit"></i> 作成開始
              </button>
            ` : ''}
            ${est.status === 'processing' ? `
              <button class="action-btn btn-complete" onclick="updateStatus('${est.id}', 'completed')">
                <i class="fas fa-check"></i> 完了
              </button>
            ` : ''}
          </td>
        </tr>
      `;
    }).join('');
  }

  function updateStats() {
    const pending = allEstimates.filter(e => e.status === 'pending').length;
    const processing = allEstimates.filter(e => e.status === 'processing').length;
    const completed = allEstimates.filter(e => e.status === 'completed').length;

    document.getElementById('stat-pending').textContent = pending;
    document.getElementById('stat-processing').textContent = processing;
    document.getElementById('stat-completed').textContent = completed;
  }

  function viewEstimate(id) {
    currentEstimate = allEstimates.find(e => e.id === id);
    if (!currentEstimate) return;

    const date = new Date(currentEstimate.created_at);
    const dateStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;

    const items = currentEstimate.items || [];
    const itemsHtml = items.map(item => `
      <div class="item-row">
        <div>
          <span class="item-name">${escapeHtml(item.name)}</span>
          ${item.multiplier !== 1 ? `<span class="item-multiplier"> (${item.multiplier}倍)</span>` : ''}
        </div>
        <span class="item-price">¥${(item.price || 0).toLocaleString()}</span>
      </div>
    `).join('');

    document.getElementById('modal-body').innerHTML = `
      <div class="detail-row">
        <span class="detail-label">見積もり番号</span>
        <span class="detail-value">${escapeHtml(currentEstimate.id)}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">店舗名</span>
        <span class="detail-value">${escapeHtml(currentEstimate.store_name || '不明')}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">ステータス</span>
        <span class="status-badge status-${currentEstimate.status}">${statusLabels[currentEstimate.status]}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">作成日時</span>
        <span class="detail-value">${dateStr}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">作成者</span>
        <span class="detail-value">${currentEstimate.created_by === 'sales' ? '営業担当' : currentEstimate.created_by}</span>
      </div>
      ${currentEstimate.notes ? `
        <div class="detail-row">
          <span class="detail-label">メモ</span>
          <span class="detail-value">${escapeHtml(currentEstimate.notes)}</span>
        </div>
      ` : ''}
      
      <div class="items-list">
        <h4><i class="fas fa-list"></i> サービス内訳</h4>
        ${itemsHtml}
        <div class="items-total">
          <span>合計</span>
          <span>¥${(currentEstimate.total || 0).toLocaleString()}</span>
        </div>
      </div>
    `;

    // フッターボタン
    let footerHtml = '<button class="action-btn btn-view" onclick="closeModal()">閉じる</button>';
    
    if (currentEstimate.status === 'pending') {
      footerHtml += `
        <button class="action-btn btn-reject" onclick="updateStatus('${currentEstimate.id}', 'rejected'); closeModal();">
          <i class="fas fa-times"></i> 却下
        </button>
        <button class="action-btn btn-process" onclick="startEstimateEdit('${currentEstimate.id}');">
          <i class="fas fa-edit"></i> 本見積作成開始
        </button>
      `;
    } else if (currentEstimate.status === 'processing') {
      footerHtml += `
        <button class="action-btn btn-edit" onclick="startEstimateEdit('${currentEstimate.id}');">
          <i class="fas fa-edit"></i> 編集
        </button>
        <button class="action-btn btn-complete" onclick="completeEstimate('${currentEstimate.id}');">
          <i class="fas fa-check"></i> 完了にする
        </button>
      `;
    }

    document.getElementById('modal-footer').innerHTML = footerHtml;
    document.getElementById('detail-modal').classList.add('active');
  }

  function closeModal() {
    document.getElementById('detail-modal').classList.remove('active');
    currentEstimate = null;
  }

  async function updateStatus(id, newStatus) {
    try {
      const res = await fetch(`${API_BASE}/estimates/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      if (!res.ok) throw new Error('更新に失敗しました');

      // ローカルデータ更新
      const est = allEstimates.find(e => e.id === id);
      if (est) est.status = newStatus;

      renderEstimates();
      updateStats();

      const action = newStatus === 'processing' ? '本見積作成を開始' : 
                     newStatus === 'completed' ? '完了' : 
                     newStatus === 'rejected' ? '却下' : '更新';
      alert(`${action}しました`);
    } catch (e) {
      console.error('Error:', e);
      alert('更新に失敗しました: ' + e.message);
    }
  }

  // 本見積もり編集開始
  function startEstimateEdit(id) {
    const est = allEstimates.find(e => e.id === id);
    if (!est) return;
    
    // ステータスを processing に更新（まだ更新されていない場合）
    if (est.status === 'pending') {
      updateStatus(id, 'processing').then(() => {
        viewEstimate(id, true);
      });
    } else {
      viewEstimate(id, true);
    }
    
    // フッターボタンを更新
    document.getElementById('modal-footer').innerHTML = `
      <button class="action-btn btn-view" onclick="viewEstimate('${id}', false)">キャンセル</button>
      <button class="action-btn btn-complete" onclick="saveEstimateEdit('${id}')">
        <i class="fas fa-save"></i> 保存
      </button>
    `;
  }

  // 見積もり合計を更新
  function updateEstimateTotal() {
    if (!currentEstimate) return;
    
    const items = currentEstimate.items || [];
    let total = 0;
    
    items.forEach((item, index) => {
      const multiplierInput = document.querySelector(`.item-multiplier-input[data-index="${index}"]`);
      if (multiplierInput) {
        const multiplier = parseFloat(multiplierInput.value) || 1;
        const basePrice = item.base_price || item.price / (item.multiplier || 1);
        const itemTotal = Math.round(basePrice * multiplier);
        total += itemTotal;
        
        // 価格表示を更新
        const priceEl = multiplierInput.closest('.item-row-edit').querySelector('.item-price');
        if (priceEl) {
          priceEl.textContent = `¥${itemTotal.toLocaleString()}`;
        }
      } else {
        total += item.price || 0;
      }
    });
    
    const totalEl = document.getElementById('estimate-total-edit');
    if (totalEl) {
      totalEl.textContent = `¥${total.toLocaleString()}`;
    }
  }

  // 見積もり項目を削除
  function removeEstimateItem(index) {
    if (!currentEstimate) return;
    if (!confirm('この項目を削除しますか？')) return;
    
    currentEstimate.items.splice(index, 1);
    viewEstimate(currentEstimate.id, true);
    
    // フッターボタンを再設定
    document.getElementById('modal-footer').innerHTML = `
      <button class="action-btn btn-view" onclick="viewEstimate('${currentEstimate.id}', false)">キャンセル</button>
      <button class="action-btn btn-complete" onclick="saveEstimateEdit('${currentEstimate.id}')">
        <i class="fas fa-save"></i> 保存
      </button>
    `;
  }

  // 見積もり編集を保存
  async function saveEstimateEdit(id) {
    if (!currentEstimate) return;
    
    try {
      // 編集された項目を取得
      const items = currentEstimate.items.map((item, index) => {
        const multiplierInput = document.querySelector(`.item-multiplier-input[data-index="${index}"]`);
        const multiplier = multiplierInput ? parseFloat(multiplierInput.value) || 1 : (item.multiplier || 1);
        const basePrice = item.base_price || item.price / (item.multiplier || 1);
        const price = Math.round(basePrice * multiplier);
        
        return {
          ...item,
          multiplier: multiplier,
          price: price,
          base_price: basePrice
        };
      });
      
      // 合計を計算
      const total = items.reduce((sum, item) => sum + item.price, 0);
      
      // メモを取得
      const notesEl = document.getElementById('estimate-notes-edit');
      const notes = notesEl ? notesEl.value : currentEstimate.notes;
      
      // APIに送信
      const res = await fetch(`${API_BASE}/estimates/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: items,
          total: total,
          notes: notes,
          status: 'processing',
          updated_at: new Date().toISOString()
        })
      });

      if (!res.ok) throw new Error('保存に失敗しました');

      // ローカルデータ更新
      const est = allEstimates.find(e => e.id === id);
      if (est) {
        est.items = items;
        est.total = total;
        est.notes = notes;
        currentEstimate = est;
      }

      renderEstimates();
      updateStats();
      
      // 表示モードに戻す
      viewEstimate(id, false);
      
      // フッターボタンを再設定
      document.getElementById('modal-footer').innerHTML = `
        <button class="action-btn btn-view" onclick="closeModal()">閉じる</button>
        <button class="action-btn btn-edit" onclick="startEstimateEdit('${id}');">
          <i class="fas fa-edit"></i> 編集
        </button>
        <button class="action-btn btn-complete" onclick="completeEstimate('${id}');">
          <i class="fas fa-check"></i> 完了にする
        </button>
      `;
      
      alert('本見積もりを保存しました');
    } catch (e) {
      console.error('Error:', e);
      alert('保存に失敗しました: ' + e.message);
    }
  }

  // 見積もりを完了
  async function completeEstimate(id) {
    if (!confirm('この見積もりを完了にしますか？')) return;
    
    try {
      await updateStatus(id, 'completed');
      closeModal();
    } catch (e) {
      console.error('Error:', e);
      alert('完了に失敗しました: ' + e.message);
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, s => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[s]));
  }

  // モーダル外クリックで閉じる
  document.getElementById('detail-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) closeModal();
  });
</script>

