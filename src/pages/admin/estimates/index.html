@layout('layouts.base')
@json('data/meta/admin_estimates_title.json', $title)
@json('data/meta/admin_estimates_body_class.json', $body_class)

<style>
  :root {
    --sidebar-width: 240px;
    --topbar-height: 64px;
  }

  .admin-estimates-v2 {
    display: flex;
    min-height: 100vh;
    background: #f9fafb;
  }

  /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
  .sidebar {
    width: var(--sidebar-width);
    background: #fff;
    border-right: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: 100;
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
  }
  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo-icon {
    font-size: 1.5rem;
  }
  .logo-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
  }
  .sidebar-nav {
    flex: 1;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: #6b7280;
    text-decoration: none;
    border-radius: 10px;
    transition: all 0.2s;
  }
  .nav-item:hover {
    background: #f3f4f6;
    color: #111827;
  }
  .nav-item.active {
    background: var(--primary);
    color: #fff;
  }
  .nav-item i {
    width: 20px;
    text-align: center;
  }
  .sidebar-footer {
    padding: 16px 12px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: 24px;
    background: #f9fafb;
  }

  .estimates-page {
    padding: 0;
    max-width: 100%;
    margin: 0;
  }
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
  }
  .page-header h1 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111;
    margin: 0;
  }
  .stats-row {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }
  .stat-card {
    background: #fff;
    border-radius: 12px;
    padding: 16px 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    min-width: 140px;
  }
  .stat-card.pending { border-left: 4px solid #f59e0b; }
  .stat-card.processing { border-left: 4px solid #3b82f6; }
  .stat-card.completed { border-left: 4px solid #10b981; }
  .stat-label { font-size: 0.8rem; color: #666; }
  .stat-value { font-size: 1.75rem; font-weight: 700; color: #111; }

  .filter-bar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .filter-bar select, .filter-bar input {
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.9rem;
  }
  .filter-bar input { flex: 1; min-width: 200px; }

  .estimates-table {
    width: 100%;
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }
  .estimates-table th, .estimates-table td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid #eee;
  }
  .estimates-table th {
    background: #f9fafb;
    font-weight: 600;
    font-size: 0.8rem;
    color: #666;
    text-transform: uppercase;
  }
  .estimates-table tr:hover { background: #f9fafb; }
  .estimates-table tr:last-child td { border-bottom: none; }

  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .status-pending { background: #fef3c7; color: #92400e; }
  .status-processing { background: #dbeafe; color: #1e40af; }
  .status-completed { background: #d1fae5; color: #065f46; }
  .status-rejected { background: #fee2e2; color: #991b1b; }

  .amount { font-weight: 600; color: #111; }
  .date { color: #666; font-size: 0.85rem; }
  .store-name { font-weight: 500; }

  .action-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    font-size: 0.8rem;
    cursor: pointer;
    margin-right: 6px;
  }
  .btn-view { background: #e0e7ff; color: #3730a3; }
  .btn-process { background: #dbeafe; color: #1e40af; }
  .btn-complete { background: #d1fae5; color: #065f46; }
  .btn-reject { background: #fee2e2; color: #991b1b; }

  /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: #fff;
    border-radius: 16px;
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  .modal-header {
    padding: 20px 24px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .modal-header h2 { margin: 0; font-size: 1.25rem; }
  .modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
  }
  .modal-body { padding: 24px; }
  .modal-footer {
    padding: 16px 24px;
    border-top: 1px solid #eee;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }

  .detail-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  .detail-label { color: #666; }
  .detail-value { font-weight: 500; }

  .items-list {
    margin-top: 16px;
    background: #f9fafb;
    border-radius: 8px;
    padding: 12px;
  }
  .items-list h4 { margin: 0 0 12px; font-size: 0.9rem; color: #333; }
  .item-row, .item-row-edit {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    font-size: 0.9rem;
  }
  .item-row:last-child, .item-row-edit:last-child { border-bottom: none; }
  .item-info {
    flex: 1;
  }
  .item-name { 
    color: #333; 
    display: block;
    margin-bottom: 4px;
  }
  .item-multiplier { color: #666; font-size: 0.8rem; }
  .item-controls {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-top: 4px;
  }
  .item-controls label {
    font-size: 0.875rem;
    color: #6b7280;
    display: flex;
    align-items: center;
    gap: 4px;
  }
  .item-multiplier-input {
    width: 60px;
    padding: 4px 8px;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-size: 0.875rem;
  }
  .btn-remove-item {
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.75rem;
  }
  .btn-remove-item:hover {
    background: #dc2626;
  }
  .item-price { 
    font-weight: 600; 
    min-width: 100px;
    text-align: right;
  }
  .form-textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.875rem;
    font-family: inherit;
    resize: vertical;
  }
  .btn-edit {
    background: #e0e7ff;
    color: #3730a3;
  }
  .items-total {
    display: flex;
    justify-content: space-between;
    padding-top: 12px;
    margin-top: 8px;
    border-top: 2px solid #ddd;
    font-weight: 700;
  }

  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
  }
  .empty-state i { font-size: 3rem; color: #ddd; margin-bottom: 16px; }

  @media (max-width: 768px) {
    .estimates-table { display: block; overflow-x: auto; }
    .stat-card { flex: 1; min-width: 100px; }
  }
</style>

<main id="main" class="admin-estimates-v2">
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <span class="logo-icon">ğŸ§¹</span>
        <span class="logo-text">ãƒŸã‚»ã‚µãƒ</span>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <a href="/admin/dashboard.html" class="nav-item">
        <i class="fas fa-home"></i>
        <span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
      </a>
      <a href="/admin/schedules/" class="nav-item">
        <i class="fas fa-calendar-alt"></i>
        <span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
      </a>
      <a href="/admin/customers/" class="nav-item">
        <i class="fas fa-store"></i>
        <span>é¡§å®¢ç®¡ç†</span>
      </a>
      <a href="/admin/reports/" class="nav-item">
        <i class="fas fa-file-alt"></i>
        <span>ãƒ¬ãƒãƒ¼ãƒˆ</span>
      </a>
      <a href="/admin/estimates/" class="nav-item active">
        <i class="fas fa-file-invoice-dollar"></i>
        <span>è¦‹ç©ã‚‚ã‚Š</span>
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i class="fas fa-shopping-cart"></i>
        <span>ç™ºæ³¨ç®¡ç†</span>
      </a>
      <a href="/admin/partners.html" class="nav-item">
        <i class="fas fa-handshake"></i>
        <span>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¼æ¥­</span>
      </a>
      <a href="/admin/users/" class="nav-item">
        <i class="fas fa-users"></i>
        <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
      </a>
      <a href="/admin/analytics/" class="nav-item">
        <i class="fas fa-chart-bar"></i>
        <span>åˆ†æ</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <a href="/admin/cleaning-manual.html" class="nav-item">
        <i class="fas fa-book"></i>
        <span>ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</span>
      </a>
      <a href="/admin/images/" class="nav-item">
        <i class="fas fa-images"></i>
        <span>ç”»åƒç®¡ç†</span>
      </a>
      <a href="/admin/services/" class="nav-item">
        <i class="fas fa-cog"></i>
        <span>è¨­å®š</span>
      </a>
    </div>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <div class="estimates-page">
  <div class="page-header">
    <h1><i class="fas fa-file-invoice-dollar"></i> ä»®è¦‹ç©ã‚‚ã‚Šç®¡ç†</h1>
  </div>

  <div class="stats-row">
    <div class="stat-card pending">
      <div class="stat-label">æœªå‡¦ç†</div>
      <div class="stat-value" id="stat-pending">0</div>
    </div>
    <div class="stat-card processing">
      <div class="stat-label">ä½œæˆä¸­</div>
      <div class="stat-value" id="stat-processing">0</div>
    </div>
    <div class="stat-card completed">
      <div class="stat-label">å®Œäº†</div>
      <div class="stat-value" id="stat-completed">0</div>
    </div>
  </div>

  <div class="filter-bar">
    <select id="filter-status">
      <option value="">ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
      <option value="pending">æœªå‡¦ç†</option>
      <option value="processing">æœ¬è¦‹ç©ä½œæˆä¸­</option>
      <option value="completed">å®Œäº†</option>
      <option value="rejected">å´ä¸‹</option>
    </select>
    <input type="text" id="filter-search" placeholder="åº—èˆ—åã§æ¤œç´¢...">
  </div>

  <table class="estimates-table">
    <thead>
      <tr>
        <th>è¦‹ç©ã‚‚ã‚Šç•ªå·</th>
        <th>åº—èˆ—å</th>
        <th>é‡‘é¡</th>
        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
        <th>ä½œæˆæ—¥</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="estimates-body">
      <tr>
        <td colspan="6">
          <div class="empty-state">
            <i class="fas fa-spinner fa-spin"></i>
            <p>èª­ã¿è¾¼ã¿ä¸­...</p>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal-overlay" id="detail-modal">
  <div class="modal">
    <div class="modal-header">
      <h2>è¦‹ç©ã‚‚ã‚Šè©³ç´°</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modal-body">
      <!-- å‹•çš„ã«æŒ¿å…¥ -->
    </div>
    <div class="modal-footer" id="modal-footer">
      <!-- å‹•çš„ã«æŒ¿å…¥ -->
    </div>
    </div>
  </div>
</main>

<script>
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  let allEstimates = [];
  let allStores = [];
  let currentEstimate = null;

  const statusLabels = {
    pending: 'æœªå‡¦ç†',
    processing: 'æœ¬è¦‹ç©ä½œæˆä¸­',
    completed: 'å®Œäº†',
    rejected: 'å´ä¸‹'
  };

  document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([loadEstimates(), loadStores()]);
    setupFilters();
  });

  async function loadEstimates() {
    try {
      const res = await fetch(`${API_BASE}/estimates`);
      if (!res.ok) throw new Error('Failed to load');
      allEstimates = await res.json();
      renderEstimates();
      updateStats();
    } catch (e) {
      console.error('Error loading estimates:', e);
      document.getElementById('estimates-body').innerHTML = `
        <tr><td colspan="6"><div class="empty-state">
          <i class="fas fa-exclamation-circle"></i>
          <p>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
        </div></td></tr>`;
    }
  }

  async function loadStores() {
    try {
      const res = await fetch(`${API_BASE}/stores`);
      if (res.ok) allStores = await res.json();
    } catch (e) {
      console.error('Error loading stores:', e);
    }
  }

  function setupFilters() {
    document.getElementById('filter-status').addEventListener('change', renderEstimates);
    document.getElementById('filter-search').addEventListener('input', renderEstimates);
  }

  function renderEstimates() {
    const statusFilter = document.getElementById('filter-status').value;
    const searchFilter = document.getElementById('filter-search').value.toLowerCase();

    let filtered = allEstimates;

    if (statusFilter) {
      filtered = filtered.filter(e => e.status === statusFilter);
    }
    if (searchFilter) {
      filtered = filtered.filter(e => 
        (e.store_name || '').toLowerCase().includes(searchFilter)
      );
    }

    const tbody = document.getElementById('estimates-body');

    if (filtered.length === 0) {
      tbody.innerHTML = `
        <tr><td colspan="6"><div class="empty-state">
          <i class="fas fa-inbox"></i>
          <p>ä»®è¦‹ç©ã‚‚ã‚ŠãŒã‚ã‚Šã¾ã›ã‚“</p>
        </div></td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(est => {
      const date = new Date(est.created_at);
      const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
      
      return `
        <tr>
          <td><strong>${escapeHtml(est.id)}</strong></td>
          <td class="store-name">${escapeHtml(est.store_name || 'ä¸æ˜')}</td>
          <td class="amount">Â¥${(est.total || 0).toLocaleString()}</td>
          <td><span class="status-badge status-${est.status}">${statusLabels[est.status] || est.status}</span></td>
          <td class="date">${dateStr}</td>
          <td>
            <button class="action-btn btn-view" onclick="viewEstimate('${est.id}')">
              <i class="fas fa-eye"></i> è©³ç´°
            </button>
            ${est.status === 'pending' ? `
              <button class="action-btn btn-process" onclick="updateStatus('${est.id}', 'processing')">
                <i class="fas fa-edit"></i> ä½œæˆé–‹å§‹
              </button>
            ` : ''}
            ${est.status === 'processing' ? `
              <button class="action-btn btn-complete" onclick="updateStatus('${est.id}', 'completed')">
                <i class="fas fa-check"></i> å®Œäº†
              </button>
            ` : ''}
          </td>
        </tr>
      `;
    }).join('');
  }

  function updateStats() {
    const pending = allEstimates.filter(e => e.status === 'pending').length;
    const processing = allEstimates.filter(e => e.status === 'processing').length;
    const completed = allEstimates.filter(e => e.status === 'completed').length;

    document.getElementById('stat-pending').textContent = pending;
    document.getElementById('stat-processing').textContent = processing;
    document.getElementById('stat-completed').textContent = completed;
  }

  function viewEstimate(id) {
    currentEstimate = allEstimates.find(e => e.id === id);
    if (!currentEstimate) return;

    const date = new Date(currentEstimate.created_at);
    const dateStr = `${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;

    const items = currentEstimate.items || [];
    const itemsHtml = items.map(item => `
      <div class="item-row">
        <div>
          <span class="item-name">${escapeHtml(item.name)}</span>
          ${item.multiplier !== 1 ? `<span class="item-multiplier"> (${item.multiplier}å€)</span>` : ''}
        </div>
        <span class="item-price">Â¥${(item.price || 0).toLocaleString()}</span>
      </div>
    `).join('');

    document.getElementById('modal-body').innerHTML = `
      <div class="detail-row">
        <span class="detail-label">è¦‹ç©ã‚‚ã‚Šç•ªå·</span>
        <span class="detail-value">${escapeHtml(currentEstimate.id)}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">åº—èˆ—å</span>
        <span class="detail-value">${escapeHtml(currentEstimate.store_name || 'ä¸æ˜')}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
        <span class="status-badge status-${currentEstimate.status}">${statusLabels[currentEstimate.status]}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">ä½œæˆæ—¥æ™‚</span>
        <span class="detail-value">${dateStr}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">ä½œæˆè€…</span>
        <span class="detail-value">${currentEstimate.created_by === 'sales' ? 'å–¶æ¥­æ‹…å½“' : currentEstimate.created_by}</span>
      </div>
      ${currentEstimate.notes ? `
        <div class="detail-row">
          <span class="detail-label">ãƒ¡ãƒ¢</span>
          <span class="detail-value">${escapeHtml(currentEstimate.notes)}</span>
        </div>
      ` : ''}
      
      <div class="items-list">
        <h4><i class="fas fa-list"></i> ã‚µãƒ¼ãƒ“ã‚¹å†…è¨³</h4>
        ${itemsHtml}
        <div class="items-total">
          <span>åˆè¨ˆ</span>
          <span>Â¥${(currentEstimate.total || 0).toLocaleString()}</span>
        </div>
      </div>
    `;

    // ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³
    let footerHtml = '<button class="action-btn btn-view" onclick="closeModal()">é–‰ã˜ã‚‹</button>';
    
    if (currentEstimate.status === 'pending') {
      footerHtml += `
        <button class="action-btn btn-reject" onclick="updateStatus('${currentEstimate.id}', 'rejected'); closeModal();">
          <i class="fas fa-times"></i> å´ä¸‹
        </button>
        <button class="action-btn btn-process" onclick="startEstimateEdit('${currentEstimate.id}');">
          <i class="fas fa-edit"></i> æœ¬è¦‹ç©ä½œæˆé–‹å§‹
        </button>
      `;
    } else if (currentEstimate.status === 'processing') {
      footerHtml += `
        <button class="action-btn btn-edit" onclick="startEstimateEdit('${currentEstimate.id}');">
          <i class="fas fa-edit"></i> ç·¨é›†
        </button>
        <button class="action-btn btn-complete" onclick="completeEstimate('${currentEstimate.id}');">
          <i class="fas fa-check"></i> å®Œäº†ã«ã™ã‚‹
        </button>
      `;
    }

    document.getElementById('modal-footer').innerHTML = footerHtml;
    document.getElementById('detail-modal').classList.add('active');
  }

  function closeModal() {
    document.getElementById('detail-modal').classList.remove('active');
    currentEstimate = null;
  }

  async function updateStatus(id, newStatus) {
    try {
      const res = await fetch(`${API_BASE}/estimates/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });

      if (!res.ok) throw new Error('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');

      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
      const est = allEstimates.find(e => e.id === id);
      if (est) est.status = newStatus;

      renderEstimates();
      updateStats();

      const action = newStatus === 'processing' ? 'æœ¬è¦‹ç©ä½œæˆã‚’é–‹å§‹' : 
                     newStatus === 'completed' ? 'å®Œäº†' : 
                     newStatus === 'rejected' ? 'å´ä¸‹' : 'æ›´æ–°';
      alert(`${action}ã—ã¾ã—ãŸ`);
    } catch (e) {
      console.error('Error:', e);
      alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
  }

  // æœ¬è¦‹ç©ã‚‚ã‚Šç·¨é›†é–‹å§‹
  function startEstimateEdit(id) {
    const est = allEstimates.find(e => e.id === id);
    if (!est) return;
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ processing ã«æ›´æ–°ï¼ˆã¾ã æ›´æ–°ã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
    if (est.status === 'pending') {
      updateStatus(id, 'processing').then(() => {
        viewEstimate(id, true);
      });
    } else {
      viewEstimate(id, true);
    }
    
    // ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
    document.getElementById('modal-footer').innerHTML = `
      <button class="action-btn btn-view" onclick="viewEstimate('${id}', false)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="action-btn btn-complete" onclick="saveEstimateEdit('${id}')">
        <i class="fas fa-save"></i> ä¿å­˜
      </button>
    `;
  }

  // è¦‹ç©ã‚‚ã‚Šåˆè¨ˆã‚’æ›´æ–°
  function updateEstimateTotal() {
    if (!currentEstimate) return;
    
    const items = currentEstimate.items || [];
    let total = 0;
    
    items.forEach((item, index) => {
      const multiplierInput = document.querySelector(`.item-multiplier-input[data-index="${index}"]`);
      if (multiplierInput) {
        const multiplier = parseFloat(multiplierInput.value) || 1;
        const basePrice = item.base_price || item.price / (item.multiplier || 1);
        const itemTotal = Math.round(basePrice * multiplier);
        total += itemTotal;
        
        // ä¾¡æ ¼è¡¨ç¤ºã‚’æ›´æ–°
        const priceEl = multiplierInput.closest('.item-row-edit').querySelector('.item-price');
        if (priceEl) {
          priceEl.textContent = `Â¥${itemTotal.toLocaleString()}`;
        }
      } else {
        total += item.price || 0;
      }
    });
    
    const totalEl = document.getElementById('estimate-total-edit');
    if (totalEl) {
      totalEl.textContent = `Â¥${total.toLocaleString()}`;
    }
  }

  // è¦‹ç©ã‚‚ã‚Šé …ç›®ã‚’å‰Šé™¤
  function removeEstimateItem(index) {
    if (!currentEstimate) return;
    if (!confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    currentEstimate.items.splice(index, 1);
    viewEstimate(currentEstimate.id, true);
    
    // ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’å†è¨­å®š
    document.getElementById('modal-footer').innerHTML = `
      <button class="action-btn btn-view" onclick="viewEstimate('${currentEstimate.id}', false)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="action-btn btn-complete" onclick="saveEstimateEdit('${currentEstimate.id}')">
        <i class="fas fa-save"></i> ä¿å­˜
      </button>
    `;
  }

  // è¦‹ç©ã‚‚ã‚Šç·¨é›†ã‚’ä¿å­˜
  async function saveEstimateEdit(id) {
    if (!currentEstimate) return;
    
    try {
      // ç·¨é›†ã•ã‚ŒãŸé …ç›®ã‚’å–å¾—
      const items = currentEstimate.items.map((item, index) => {
        const multiplierInput = document.querySelector(`.item-multiplier-input[data-index="${index}"]`);
        const multiplier = multiplierInput ? parseFloat(multiplierInput.value) || 1 : (item.multiplier || 1);
        const basePrice = item.base_price || item.price / (item.multiplier || 1);
        const price = Math.round(basePrice * multiplier);
        
        return {
          ...item,
          multiplier: multiplier,
          price: price,
          base_price: basePrice
        };
      });
      
      // åˆè¨ˆã‚’è¨ˆç®—
      const total = items.reduce((sum, item) => sum + item.price, 0);
      
      // ãƒ¡ãƒ¢ã‚’å–å¾—
      const notesEl = document.getElementById('estimate-notes-edit');
      const notes = notesEl ? notesEl.value : currentEstimate.notes;
      
      // APIã«é€ä¿¡
      const res = await fetch(`${API_BASE}/estimates/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          items: items,
          total: total,
          notes: notes,
          status: 'processing',
          updated_at: new Date().toISOString()
        })
      });

      if (!res.ok) throw new Error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');

      // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿æ›´æ–°
      const est = allEstimates.find(e => e.id === id);
      if (est) {
        est.items = items;
        est.total = total;
        est.notes = notes;
        currentEstimate = est;
      }

      renderEstimates();
      updateStats();
      
      // è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
      viewEstimate(id, false);
      
      // ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’å†è¨­å®š
      document.getElementById('modal-footer').innerHTML = `
        <button class="action-btn btn-view" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        <button class="action-btn btn-edit" onclick="startEstimateEdit('${id}');">
          <i class="fas fa-edit"></i> ç·¨é›†
        </button>
        <button class="action-btn btn-complete" onclick="completeEstimate('${id}');">
          <i class="fas fa-check"></i> å®Œäº†ã«ã™ã‚‹
        </button>
      `;
      
      alert('æœ¬è¦‹ç©ã‚‚ã‚Šã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    } catch (e) {
      console.error('Error:', e);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
  }

  // è¦‹ç©ã‚‚ã‚Šã‚’å®Œäº†
  async function completeEstimate(id) {
    if (!confirm('ã“ã®è¦‹ç©ã‚‚ã‚Šã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    try {
      await updateStatus(id, 'completed');
      closeModal();
    } catch (e) {
      console.error('Error:', e);
      alert('å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
    }
  }

  function escapeHtml(str) {
    if (!str) return '';
    return String(str).replace(/[&<>"']/g, s => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[s]));
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
  document.getElementById('detail-modal').addEventListener('click', (e) => {
    if (e.target.classList.contains('modal-overlay')) closeModal();
  });
</script>

