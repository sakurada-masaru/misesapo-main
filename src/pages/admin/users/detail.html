@layout('layouts.admin')
@json('data/meta/admin_user_detail_title.json', $title)
@json('data/meta/admin_user_detail_body_class.json', $body_class)

<main id="main" class="admin-user-detail">
  @include('partials.admin-sidebar')
  <!-- メインコンテンツ -->
  <div class="main-content">
    <div class="page-header">
      <a href="/admin/users/" class="back-btn" id="back-btn">
        <i class="fas fa-chevron-left"></i>
      </a>
      <h1 class="page-title" id="page-title">ユーザー詳細</h1>
      <button class="btn btn-outline btn-sm" id="edit-btn" style="display: none;" onclick="openEditModal()">
        <i class="fas fa-edit"></i> 編集
      </button>
    </div>

  <div class="loading" id="loading">読み込み中...</div>
  <div id="error-message" class="error-message" style="display: none;"></div>
  
  <div id="user-content" style="display: none;">
    <!-- ユーザー基本情報カード -->
    <div class="info-card">
      <div class="card-header">
        <div class="user-main-info">
          <div class="user-avatar-large" id="user-avatar-large">
            <span id="user-avatar-text">?</span>
          </div>
          <div class="user-info-text">
            <h2 class="user-name" id="user-name">-</h2>
            <div class="user-email" id="user-email">-</div>
            <div class="user-role-badge" id="user-role-badge">
              <span class="role-badge" id="role-badge">-</span>
            </div>
          </div>
        </div>
        <span class="status-badge" id="status-badge">-</span>
      </div>

      <div class="info-grid">
        <div class="info-section">
          <h3 class="section-title">
            <i class="fas fa-user"></i>
            基本情報
          </h3>
          <div class="info-item">
            <span class="info-label">ユーザーID</span>
            <span class="info-value" id="user-id">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">名前</span>
            <span class="info-value" id="info-name">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">メールアドレス</span>
            <span class="info-value">
              <a href="#" id="info-email">-</a>
            </span>
          </div>
          <div class="info-item">
            <span class="info-label">電話番号</span>
            <span class="info-value" id="info-phone">-</span>
          </div>
        </div>

        <div class="info-section">
          <h3 class="section-title">
            <i class="fas fa-briefcase"></i>
            所属情報
          </h3>
          <div class="info-item">
            <span class="info-label">ロール</span>
            <span class="info-value" id="info-role">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">部署</span>
            <span class="info-value" id="info-department">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">担当業務</span>
            <span class="info-value" id="info-job">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">ステータス</span>
            <span class="info-value" id="info-status">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">登録日</span>
            <span class="info-value" id="info-created-at">-</span>
          </div>
        </div>
      </div>
    </div>

    <!-- タイムカードセクション -->
    <div class="attendance-section">
      <div class="section-header">
        <h3 class="section-title">
          <i class="fas fa-clock"></i>
          タイムカード
        </h3>
        <div class="month-selector">
          <button class="btn-icon" id="prev-month-btn" title="前月">
            <i class="fas fa-chevron-left"></i>
          </button>
          <span class="month-display" id="month-display">2025年12月</span>
          <button class="btn-icon" id="next-month-btn" title="次月">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
      
      <!-- 月間サマリー -->
      <div class="monthly-summary" id="monthly-summary">
        <div class="summary-card">
          <div class="summary-label">出勤日数</div>
          <div class="summary-value" id="summary-work-days">-</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">総労働時間</div>
          <div class="summary-value" id="summary-total-hours">-</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">残業時間</div>
          <div class="summary-value" id="summary-overtime-hours">-</div>
        </div>
        <div class="summary-card">
          <div class="summary-label">遅刻回数</div>
          <div class="summary-value" id="summary-late-count">-</div>
        </div>
      </div>
      
      <!-- タイムカードテーブル（水平方向） -->
      <div class="timecard-table-container">
        <table class="timecard-table timecard-table-horizontal" id="timecard-table">
          <thead id="timecard-thead">
            <!-- 動的に生成 -->
          </thead>
          <tbody id="timecard-tbody">
            <!-- 動的に生成 -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- スケジュール情報セクション -->
    <div class="schedule-section">
      <h3 class="section-title">
        <i class="fas fa-calendar-alt"></i>
        スケジュール情報
      </h3>
      <div class="schedule-card">
        <div id="schedule-list">
          <!-- スケジュールが動的に生成される -->
        </div>
      </div>
    </div>

    <!-- クイックアクション -->
    <div class="actions-section">
      <h3 class="section-title">クイックアクション</h3>
      <div class="action-buttons">
        <a href="#" class="action-btn" id="mypage-btn" style="display: none;">
          <i class="fas fa-user-circle"></i>
          <span>マイページを開く</span>
        </a>
        <a href="#" class="action-btn" id="schedule-btn">
          <i class="fas fa-calendar-plus"></i>
          <span>スケジュール追加</span>
        </a>
        <a href="#" class="action-btn" id="report-btn">
          <i class="fas fa-file-alt"></i>
          <span>レポート確認</span>
        </a>
        <a href="#" class="action-btn" id="email-btn">
          <i class="fas fa-envelope"></i>
          <span>メール送信</span>
        </a>
      </div>
    </div>

    <!-- 戻るボタン -->
    <div class="nav-section">
      <a href="/admin/users/" class="btn btn-outline btn-block">
        <i class="fas fa-list"></i> ユーザー一覧に戻る
      </a>
    </div>
  </div>

  <!-- 編集モーダル -->
  <div class="edit-modal" id="edit-modal" style="display:none;">
    <div class="modal-overlay" onclick="closeEditModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>ユーザー情報編集</h2>
        <button class="modal-close" onclick="closeEditModal()">×</button>
      </div>
      <div class="modal-body">
        <form id="edit-form">
          <div class="form-grid">
            <div class="form-group full">
              <label for="edit-name">名前 <span class="required">*</span></label>
              <input type="text" id="edit-name" required>
            </div>
            <div class="form-group full">
              <label for="edit-email">メールアドレス <span class="required">*</span></label>
              <input type="email" id="edit-email" required placeholder="yamada.taro@example.com">
              <small class="form-hint">現状は個人メールアドレスも使用可能です（将来的には企業用メールアドレスへの移行を推奨）</small>
            </div>
            <div class="form-group">
              <label for="edit-phone">電話番号</label>
              <input type="tel" id="edit-phone" placeholder="090-1234-5678">
            </div>
            <div class="form-group">
              <label for="edit-role">ロール <span class="required">*</span></label>
              <select id="edit-role" required>
                <option value="admin">管理者</option>
                <option value="staff">なし</option>
              </select>
              <small class="form-hint">管理ダッシュボードへのアクセス権限を表します</small>
            </div>
            <div class="form-group">
              <label for="edit-department">部署</label>
              <input type="text" id="edit-department" placeholder="例: 取締役会、営業、事務、開発、現場、運営">
              <small class="form-hint">ユーザー管理ページでカテゴリ分けするために使用します</small>
            </div>
            <div class="form-group full">
              <label for="edit-job">担当業務</label>
              <input type="text" id="edit-job" placeholder="例: FS営業・清掃、システム開発・プログラミング">
              <small class="form-hint">ユーザーカードに表示されるバッジ（ステータス）です。複数の業務は「・」で区切ってください</small>
            </div>
            <div class="form-group">
              <label for="edit-status">ステータス <span class="required">*</span></label>
              <select id="edit-status" required>
                <option value="active">有効</option>
                <option value="inactive">無効</option>
              </select>
            </div>
            <div class="form-group">
              <label for="edit-scheduled-start-time">所定開始時刻</label>
              <input type="time" id="edit-scheduled-start-time" value="09:00">
            </div>
            <div class="form-group">
              <label for="edit-scheduled-end-time">所定終了時刻</label>
              <input type="time" id="edit-scheduled-end-time" value="18:00">
            </div>
            <div class="form-group">
              <label for="edit-scheduled-work-hours">所定労働時間（時間）</label>
              <input type="number" id="edit-scheduled-work-hours" step="0.5" min="0" max="24" value="8.0">
            </div>
          </div>
          <div class="form-status" id="edit-form-status"></div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">キャンセル</button>
            <button type="submit" class="btn btn-primary">保存</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <style>
    :root {
      --sidebar-width: 240px;
      --sidebar-width-collapsed: 64px;
    }

    .admin-user-detail {
      display: flex;
      min-height: 100vh;
      background: #f9fafb;
    }
    .nav-label {
      transition: opacity 0.3s ease;
      white-space: nowrap;
      font-size: 0.8125rem;
    }

    .sidebar.collapsed 
    .nav-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 12px;
    }

    /* メインコンテンツ */
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 24px;
      background: #f9fafb;
    
      transition: margin-left 0.3s ease;}
    .sidebar.collapsed ~ .main-content {
      margin-left: var(--sidebar-width);
      padding: 24px;
      background: #f9fafb;
    
      transition: margin-left 0.3s ease;}

    /* 既存のスタイル */
    .page-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
      flex-wrap: wrap;
    }
    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #374151;
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover {
      background: #f9fafb;
      border-color: var(--primary);
      color: var(--primary);
    }
    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
      flex: 1;
    }
    .loading {
      text-align: center;
      padding: 48px;
      color: #6b7280;
      font-size: 1rem;
    }
    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      text-align: center;
    }
    .info-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 20px;
      border-bottom: 2px solid #f3f4f6;
    }
    .user-main-info {
      display: flex;
      align-items: center;
      gap: 20px;
      flex: 1;
    }
    .user-avatar-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 2rem;
      flex-shrink: 0;
    }
    .user-info-text {
      flex: 1;
    }
    .user-name {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0 0 8px 0;
    }
    .user-email {
      font-size: 1rem;
      color: #6b7280;
      margin-bottom: 12px;
    }
    .user-role-badge {
      display: inline-block;
    }
    .role-badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .role-admin { background: #fce7f3; color: #be185d; }
    .role-none { background: #f1f5f9; color: #64748b; }
    .status-badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      flex-shrink: 0;
      margin-left: 16px;
    }
    .status-active { background: #d1fae5; color: #065f46; }
    .status-inactive { background: #fee2e2; color: #991b1b; }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 24px;
    }
    .info-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title i {
      color: var(--primary);
    }
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .info-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .info-value {
      font-size: 0.95rem;
      color: #111827;
      font-weight: 500;
    }
    .info-value a {
      color: var(--primary);
      text-decoration: none;
    }
    .info-value a:hover {
      text-decoration: underline;
    }
    .attendance-section,
    .schedule-section {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }
    .attendance-card {
      margin-top: 16px;
    }
    .attendance-today {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: #f9fafb;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    .attendance-status {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .status-indicator {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #9ca3af;
    }
    .status-indicator.working {
      background: #10b981;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
    }
    .status-text {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .status-label {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .status-time {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
    }
    .attendance-calendar {
      margin-top: 16px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .month-selector {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .month-display {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
      min-width: 120px;
      text-align: center;
    }
    .btn-icon {
      width: 32px;
      height: 32px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #fff;
      color: #6b7280;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .btn-icon:hover {
      background: #f3f4f6;
      border-color: var(--primary);
      color: var(--primary);
    }
    .monthly-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .summary-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .summary-label {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .summary-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
    }
    .timecard-table-container {
      overflow-x: auto;
      margin-top: 16px;
    }
    .timecard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    .timecard-table thead {
      background: #f9fafb;
      border-bottom: 2px solid #e5e7eb;
    }
    .timecard-table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }
    .timecard-table td {
      padding: 12px;
      border-bottom: 1px solid #e5e7eb;
    }
    .timecard-table tbody tr:hover {
      background: #f9fafb;
    }
    /* 水平方向タイムカード */
    .timecard-table-horizontal th:first-child,
    .timecard-table-horizontal td:first-child {
      position: sticky;
      left: 0;
      background: #ffffff;
      z-index: 1;
      border-right: 2px solid #e5e7eb;
      font-weight: 600;
    }
    .timecard-table-horizontal thead th:first-child {
      background: #f9fafb;
      z-index: 2;
    }
    .timecard-table-horizontal tbody tr:hover td:first-child {
      background: #f9fafb;
    }
    .timecard-table-horizontal th {
      text-align: center;
      min-width: 80px;
    }
    .timecard-table-horizontal td {
      text-align: center;
    }
    .timecard-table-horizontal .today-column {
      background: #eff6ff !important;
    }
    .timecard-table-horizontal .today-column:hover {
      background: #dbeafe !important;
    }
    .status-badge-timecard {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-completed { background: #d1fae5; color: #065f46; }
    .status-working { background: #dbeafe; color: #1e40af; }
    .status-absent { background: #fee2e2; color: #991b1b; }
    .status-late { background: #fef3c7; color: #92400e; }
    .status-early-leave { background: #fce7f3; color: #9f1239; }
    .today-row {
      background: #eff6ff !important;
      font-weight: 600;
    }
    .today-row:hover {
      background: #dbeafe !important;
    }
    .schedule-card {
      margin-top: 16px;
    }
    .actions-section {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      text-decoration: none;
      color: #374151;
      transition: all 0.2s;
    }
    .action-btn:hover {
      background: #ffffff;
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .action-btn i {
      font-size: 1.5rem;
      color: var(--primary);
    }
    .action-btn span {
      font-size: 0.875rem;
      font-weight: 500;
    }
    .nav-section {
      margin-bottom: 24px;
    }
    @media (max-width: 768px) {
      .admin-user-detail {
        padding: 12px;
      }
      .info-card,
      .attendance-section,
      .schedule-section,
      .actions-section {
        padding: 16px;
      }
      .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      .user-main-info {
        flex-direction: column;
        align-items: flex-start;
      }
      .info-grid {
        grid-template-columns: 1fr;
      }
      .attendance-today {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }
      .action-buttons {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* 編集モーダル */
    .edit-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      position: relative;
      background: #ffffff;
      border-radius: 12px;
      max-width: 600px;
      width: 90vw;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      z-index: 1001;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #6b7280;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .modal-close:hover {
      background: #f3f4f6;
      color: #111827;
    }
    .modal-body {
      padding: 24px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .form-group.full {
      grid-column: 1 / -1;
    }
    .form-group label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
    }
    .form-group .required {
      color: #ef4444;
    }
    .form-group input,
    .form-group select {
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    .form-hint {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 4px;
    }
    .form-status {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.875rem;
      text-align: center;
    }
    .form-status.success {
      background: #d1fae5;
      color: #065f46;
    }
    .form-status.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--primary);
      color: #ffffff;
    }
    .btn-secondary {
      background: #6b7280;
      color: #ffffff;
    }
    .btn-secondary:hover {
      background: #4b5563;
    }
    .btn-primary:hover {
      opacity: 0.9;
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      .modal-content {
        width: 95vw;
        max-height: 95vh;
      }
    }
  </style>

  <script>
    const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
    let currentUser = null;
    let attendanceRecords = {};
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let monthlyAttendance = [];

    // URLからユーザーIDを取得
    function getUserIdFromUrl() {
      // まずクエリパラメータから取得を試みる
      const urlParams = new URLSearchParams(window.location.search);
      const idFromQuery = urlParams.get('id') || urlParams.get('user_id');
      if (idFromQuery) {
        return idFromQuery;
      }
      
      // パスから取得を試みる（後方互換性のため）
      const path = window.location.pathname;
      let match = path.match(/\/admin\/users\/([^\/]+)(?:\.html)?$/);
      if (match) {
        const id = match[1];
        if (id !== 'detail') {
          return id;
        }
      }
      
      return null;
    }

    // 日付フォーマット
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric'
      });
    }

    function formatDateTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function formatTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleTimeString('ja-JP', { 
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ユーザー情報を読み込み
    async function loadUser() {
      const loadingEl = document.getElementById('loading');
      const contentEl = document.getElementById('user-content');
      const errorEl = document.getElementById('error-message');
      
      const userId = getUserIdFromUrl();
      if (!userId) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = 'ユーザーIDが取得できませんでした';
        return;
      }

      try {
        loadingEl.style.display = 'block';
        contentEl.style.display = 'none';
        errorEl.style.display = 'none';

        // まずAPIから最新データを取得（キャッシュを無効化）
        let response = null;
        try {
          // キャッシュを無効化するためにタイムスタンプを追加
          const timestamp = new Date().getTime();
          response = await fetch(`${API_BASE}/workers/${userId}?t=${timestamp}&_=${Date.now()}`, {
            cache: 'no-store'
          });
          if (!response.ok) {
            if (response.status === 404) {
              // APIでも見つからない場合、メールアドレスや名前で検索を試みる
              const allWorkersResponse = await fetch(`${API_BASE}/workers?t=${timestamp}&_=${Date.now()}`, {
                cache: 'no-store'
              });
              if (allWorkersResponse.ok) {
                const allWorkers = await allWorkersResponse.json();
                const workersArray = Array.isArray(allWorkers) ? allWorkers : (allWorkers.items || allWorkers.workers || []);
                const foundUser = workersArray.find(w => w.id === userId);
                if (foundUser) {
                  currentUser = foundUser;
                } else {
                  throw new Error('ユーザーが見つかりませんでした');
                }
              } else {
                throw new Error('ユーザーが見つかりませんでした');
              }
            } else {
              throw new Error('ユーザー情報の取得に失敗しました');
            }
          } else {
            currentUser = await response.json();
          }
        } catch (apiError) {
          console.warn('[UserDetail] API取得に失敗、ローカルのworkers.jsonを試行:', apiError);
          // APIで取得できない場合のみ、ローカルのworkers.jsonをフォールバックとして使用
          try {
            const timestamp = new Date().getTime();
            const localResponse = await fetch(`/data/workers.json?t=${timestamp}&_=${Date.now()}`, {
              cache: 'no-store'
            });
            if (localResponse.ok) {
              const localWorkers = await localResponse.json();
              if (Array.isArray(localWorkers) && localWorkers.length > 0) {
                const matchingUser = localWorkers.find(u => u.id === userId);
                if (matchingUser) {
                  currentUser = matchingUser;
                  console.log('[UserDetail] Found user from local data (fallback):', matchingUser.name);
                }
              }
            }
          } catch (localError) {
            console.log('[UserDetail] Local workers.json also not available');
            throw apiError; // 元のAPIエラーを再スロー
          }
        }
        
        // APIで取得できなかった場合
        if (!currentUser || !currentUser.id) {
          throw new Error('ユーザー情報の取得に失敗しました');
        }
        
        // ロールを変換（roleフィールドを優先、存在しない場合のみrole_codeから変換）
        if (!currentUser.role || currentUser.role === '') {
          if (currentUser.role_code !== undefined && currentUser.role_code !== null) {
            currentUser.role = getRoleFromCode(currentUser.role_code);
          } else {
            // role_codeもroleも存在しない場合はデフォルト値を設定
            currentUser.role = 'staff';
          }
        }
        // roleフィールドが存在する場合はそのまま使用（role_codeは無視）

        // ユーザー情報を表示
        renderUser(currentUser);
        
        // タイムカードを読み込み（出退勤記録も含む）
        loadTimecard();

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';
      } catch (error) {
        console.error('Error loading user:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = `エラー: ${error.message}`;
      }
    }

    function getRoleFromCode(code) {
      if (code === '1' || code === 1) return 'admin';
      if (code === '2' || code === 2) return 'sales';
      if (code === '3' || code === 3) return 'office';
      if (code === '4' || code === 4) return 'staff';
      if (code === '5' || code === 5) return 'developer';
      if (code === '6' || code === 6) return 'designer';
      if (code === '7' || code === 7) return 'general_affairs';
      if (code === '8' || code === 8) return 'operation';
      if (code === '9' || code === 9) return 'contractor';
      if (code === '10' || code === 10) return 'accounting';
      if (code === '11' || code === 11) return 'human_resources';
      return 'staff';
    }

    function getRoleLabel(role) {
      // 管理者のみ表示
      if (role === 'admin') {
        return '管理者';
      }
      return '';
    }

    // ユーザー情報を表示
    function renderUser(user) {
      // ページタイトル
      document.getElementById('page-title').textContent = `${user.name || 'ユーザー'}の詳細`;
      
      // アバター
      const avatarText = (user.name || '?')[0].toUpperCase();
      document.getElementById('user-avatar-text').textContent = avatarText;
      document.getElementById('user-avatar-large').style.background = getRoleColor(user.role);
      
      // 基本情報
      document.getElementById('user-name').textContent = user.name || '-';
      document.getElementById('user-email').textContent = user.email || '-';
      
      // ロールバッジ（管理者のみ表示）
      const roleLabel = getRoleLabel(user.role);
      const roleBadge = document.getElementById('role-badge');
      if (roleBadge) {
        if (roleLabel) {
      roleBadge.textContent = roleLabel;
          roleBadge.className = 'role-badge role-admin';
          roleBadge.style.display = 'inline-block';
        } else {
          roleBadge.style.display = 'none';
        }
      }
      
      // ステータスバッジ
      const status = user.status || 'active';
      const statusBadge = document.getElementById('status-badge');
      statusBadge.textContent = status === 'inactive' ? '無効' : '有効';
      statusBadge.className = `status-badge status-${status}`;
      
      // 詳細情報
      document.getElementById('user-id').textContent = user.id || '-';
      document.getElementById('info-name').textContent = user.name || '-';
      const emailLink = document.getElementById('info-email');
      emailLink.textContent = user.email || '-';
      emailLink.href = user.email ? `mailto:${user.email}` : '#';
      document.getElementById('info-phone').textContent = user.phone || '-';
      document.getElementById('info-role').textContent = roleLabel;
      document.getElementById('info-department').textContent = user.department || '-';
      // 担当業務を表示（「・」で区切られた複数の業務を表示）
      const jobInfo = user.job || '';
      if (jobInfo) {
        const jobs = jobInfo.split('・').map(j => j.trim()).filter(j => j);
        document.getElementById('info-job').textContent = jobs.join('、');
      } else {
        document.getElementById('info-job').textContent = '-';
      }
      document.getElementById('info-status').textContent = status === 'inactive' ? '無効' : '有効';
      document.getElementById('info-created-at').textContent = formatDate(user.created_at);
      
      // 編集ボタン
      document.getElementById('edit-btn').style.display = 'inline-flex';
      
      // クイックアクション
      document.getElementById('email-btn').href = user.email ? `mailto:${user.email}` : '#';
      
      // マイページボタンを更新（クイックアクション - 表示中のユーザーのマイページ）
      const mypageBtn = document.getElementById('mypage-btn');
      if (mypageBtn && user.id) {
        mypageBtn.href = `/staff/mypage.html?id=${encodeURIComponent(user.id)}`;
        mypageBtn.style.display = 'flex';
      } else if (mypageBtn && user.email && user.email !== '-') {
        mypageBtn.href = `/staff/mypage.html?email=${encodeURIComponent(user.email)}`;
        mypageBtn.style.display = 'flex';
      }
    }

    function getRoleColor(role) {
      const colors = {
        staff: '#f59e0b',
        sales: '#10b981',
        admin: '#ec4899',
        other: '#64748b'
      };
      return colors[role] || '#64748b';
    }

    // 出退勤記録を読み込み（タイムカード機能に統合されたため、この関数は空に）
    function loadAttendanceRecords() {
      // タイムカード機能で出退勤記録を管理するため、この関数は不要
      // エラーを防ぐため、空の関数として残す
    }

    // メールアドレスのバリデーション（現状は個人メールアドレスも許可）
    function validateEmail(email) {
      if (!email) {
        return { valid: false, message: 'メールアドレスは必須です。' };
      }
      
      // 基本的なメールアドレス形式のチェック
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        return {
          valid: false,
          message: '有効なメールアドレスを入力してください。'
        };
      }
      
      // 現状は個人メールアドレスも許可
      // 将来的には企業用メールアドレス（@misesapo.app）への移行を推奨
      return { valid: true };
    }

    // 編集モーダルを開く
    function openEditModal() {
      if (!currentUser) return;
      
      // フォームに現在の値を設定
      document.getElementById('edit-name').value = currentUser.name || '';
      document.getElementById('edit-email').value = currentUser.email || '';
      document.getElementById('edit-phone').value = currentUser.phone || '';
      // ロールは「管理者」か「なし」の2種類のみ
      document.getElementById('edit-role').value = (currentUser.role === 'admin') ? 'admin' : 'staff';
      document.getElementById('edit-department').value = currentUser.department || '';
      document.getElementById('edit-job').value = currentUser.job || '';
      document.getElementById('edit-status').value = currentUser.status || 'active';
      document.getElementById('edit-scheduled-start-time').value = currentUser.scheduled_start_time || '09:00';
      document.getElementById('edit-scheduled-end-time').value = currentUser.scheduled_end_time || '18:00';
      document.getElementById('edit-scheduled-work-hours').value = currentUser.scheduled_work_hours || 8.0;
      document.getElementById('edit-form-status').textContent = '';
      document.getElementById('edit-form-status').className = 'form-status';
      
      // モーダルを表示
      document.getElementById('edit-modal').style.display = 'flex';
    }

    // 編集モーダルを閉じる
    function closeEditModal() {
      document.getElementById('edit-modal').style.display = 'none';
    }

    // 編集フォームの送信（DOMContentLoaded内で実行）
    function setupEditForm() {
      const editForm = document.getElementById('edit-form');
      if (!editForm) {
        console.warn('Edit form not found');
        return;
      }
      
      editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentUser) return;
      
      const statusEl = document.getElementById('edit-form-status');
      statusEl.textContent = '保存中...';
      statusEl.className = 'form-status';
      
      // メールアドレスのバリデーション
      const email = document.getElementById('edit-email').value;
      const emailValidation = validateEmail(email);
      
      if (!emailValidation.valid) {
        statusEl.textContent = emailValidation.message;
        statusEl.className = 'form-status error';
        return;
      }
      
      const data = {
        name: document.getElementById('edit-name').value,
        email: email,
        phone: document.getElementById('edit-phone').value,
        role: document.getElementById('edit-role').value,
        department: document.getElementById('edit-department').value,
        job: document.getElementById('edit-job').value,  // 担当業務を追加
        status: document.getElementById('edit-status').value,
        scheduled_start_time: document.getElementById('edit-scheduled-start-time').value,
        scheduled_end_time: document.getElementById('edit-scheduled-end-time').value,
        scheduled_work_hours: parseFloat(document.getElementById('edit-scheduled-work-hours').value) || 8.0
      };
      
      // ロールコードを設定（管理者=1、それ以外=4）
      data.role_code = (data.role === 'admin') ? '1' : '4';
      
      try {
        const response = await fetch(`${API_BASE}/workers/${currentUser.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          statusEl.textContent = '保存しました';
          statusEl.className = 'form-status success';
          
          // 一覧画面に戻る際にリロードするためのフラグを設定
          sessionStorage.setItem('users_list_needs_reload', 'true');
          sessionStorage.setItem('users_list_updated_user_id', currentUser.id);
          
          // ユーザー情報を再読み込み（キャッシュを無効化）
          setTimeout(async () => {
            // キャッシュをクリアして再読み込み
            currentUser = null;
            // 少し待ってから再読み込み（DynamoDBの反映を待つ）
            await new Promise(resolve => setTimeout(resolve, 300));
            await loadUser();
            closeEditModal();
          }, 500);
        } else {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || errorData.message || '保存に失敗しました');
        }
      } catch (error) {
        console.error('Error updating user:', error);
        statusEl.textContent = error.message || '保存に失敗しました';
        statusEl.className = 'form-status error';
      }
      });
    }

    // 出退勤トグルボタンのセットアップ（タイムカード機能に統合されたため、この関数は空に）
    function setupAttendanceButton() {
      // タイムカード機能で出退勤記録を管理するため、この関数は不要
      // エラーを防ぐため、空の関数として残す
    }

    // タイムカードを読み込み
    async function loadTimecard() {
      if (!currentUser) return;
      
      try {
        const year = currentYear;
        const month = String(currentMonth + 1).padStart(2, '0');
        
        const response = await fetch(`${API_BASE}/attendance?staff_id=${currentUser.id}&year=${year}&month=${month}&limit=1000`);
        if (!response.ok) {
          throw new Error('タイムカードの取得に失敗しました');
        }
        
        const data = await response.json();
        monthlyAttendance = data.attendance || [];
        
        renderTimecard();
        renderMonthlySummary();
      } catch (error) {
        console.error('Error loading timecard:', error);
        monthlyAttendance = [];
        renderTimecard();
        renderMonthlySummary();
      }
    }
    
    // タイムカードを表示（水平方向）
    function renderTimecard() {
      const thead = document.getElementById('timecard-thead');
      const tbody = document.getElementById('timecard-tbody');
      if (!thead || !tbody) return;
      
      // 月の日数を取得
      const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
      const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
      
      // 出退勤記録を日付でマップ
      const attendanceMap = {};
      monthlyAttendance.forEach(record => {
        attendanceMap[record.date] = record;
      });
      
      // ヘッダー行を生成
      let headerHtml = '<tr><th>項目</th>';
      const todayStr = new Date().toISOString().split('T')[0];
      
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(currentYear, currentMonth, day);
        const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const weekday = weekdays[date.getDay()];
        const isToday = dateStr === todayStr;
        const headerClass = isToday ? 'today-column' : '';
        headerHtml += `<th class="${headerClass}">${day}日<br><span style="font-size: 0.75rem; font-weight: normal; color: #6b7280;">${weekday}</span></th>`;
      }
      headerHtml += '</tr>';
      thead.innerHTML = headerHtml;
      
      // データ行を生成
      const rows = [
        { label: '出勤', key: 'clockIn' },
        { label: '退勤', key: 'clockOut' },
        { label: '休憩', key: 'breakTime' },
        { label: '実労働', key: 'workHours' },
        { label: '残業', key: 'overtime' },
        { label: '状態', key: 'status' }
      ];
      
      let bodyHtml = '';
      rows.forEach(row => {
        bodyHtml += `<tr><td style="font-weight: 600;">${row.label}</td>`;
        
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const record = attendanceMap[dateStr];
          const isToday = dateStr === todayStr;
          const cellClass = isToday ? 'today-column' : '';
          
          let cellValue = '-';
        
        if (record) {
            switch (row.key) {
              case 'clockIn':
                cellValue = record.clock_in ? formatTime(record.clock_in) : '-';
                break;
              case 'clockOut':
                cellValue = record.clock_out ? formatTime(record.clock_out) : '-';
                break;
              case 'breakTime':
                cellValue = record.break_time ? `${record.break_time}h` : '-';
                break;
              case 'workHours':
                cellValue = record.work_hours ? `${record.work_hours}h` : '-';
                break;
              case 'overtime':
                cellValue = record.overtime_hours ? `${record.overtime_hours}h` : '-';
                break;
              case 'status':
          if (record.status === 'completed') {
            if (record.is_late && record.is_early_leave) {
                    cellValue = '<span class="status-badge-timecard status-late">遅刻・早退</span>';
            } else if (record.is_late) {
                    cellValue = `<span class="status-badge-timecard status-late">遅刻 ${record.late_minutes}分</span>`;
            } else if (record.is_early_leave) {
                    cellValue = `<span class="status-badge-timecard status-early-leave">早退 ${record.early_leave_minutes}分</span>`;
            } else {
                    cellValue = '<span class="status-badge-timecard status-completed">完了</span>';
            }
          } else if (record.status === 'working') {
                  cellValue = '<span class="status-badge-timecard status-working">勤務中</span>';
                } else {
                  cellValue = '<span class="status-badge-timecard status-absent">未出勤</span>';
                }
                break;
            }
          } else if (row.key === 'status') {
            cellValue = '<span class="status-badge-timecard status-absent">未出勤</span>';
          }
          
          bodyHtml += `<td class="${cellClass}">${cellValue}</td>`;
        }
        
        bodyHtml += '</tr>';
      });
      
      tbody.innerHTML = bodyHtml;
      
      // 月表示を更新
      document.getElementById('month-display').textContent = `${currentYear}年${currentMonth + 1}月`;
    }
    
    // 月間サマリーを表示
    function renderMonthlySummary() {
      let workDays = 0;
      let totalHours = 0;
      let overtimeHours = 0;
      let lateCount = 0;
      
      monthlyAttendance.forEach(record => {
        if (record.status === 'completed') {
          workDays++;
          if (record.work_hours) {
            totalHours += record.work_hours;
          }
          if (record.overtime_hours) {
            overtimeHours += record.overtime_hours;
          }
          if (record.is_late) {
            lateCount++;
          }
        }
      });
      
      document.getElementById('summary-work-days').textContent = `${workDays}日`;
      document.getElementById('summary-total-hours').textContent = `${totalHours.toFixed(1)}h`;
      document.getElementById('summary-overtime-hours').textContent = `${overtimeHours.toFixed(1)}h`;
      document.getElementById('summary-late-count').textContent = `${lateCount}回`;
    }
    
    // 月移動
    function setupMonthNavigation() {
      const prevBtn = document.getElementById('prev-month-btn');
      const nextBtn = document.getElementById('next-month-btn');
      
      if (prevBtn) {
        prevBtn.addEventListener('click', () => {
          currentMonth--;
          if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
          }
          loadTimecard();
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener('click', () => {
          currentMonth++;
          if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
          }
          loadTimecard();
        });
      }
    }
    
    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
      loadUser();
      setupEditForm();
      setupAttendanceButton();
      setupMonthNavigation();
      initSidebar();
        
  });

    // サイドバーの初期化（共通サイドバーを使用しているため、個別の初期化は不要）
    function initSidebar() {
      // 共通サイドバーのJavaScriptが処理するため、ここでは何もしない
    }
  </script>
</main>

