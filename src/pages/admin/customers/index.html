@layout('layouts.admin')
@json('data/meta/admin_stores_title.json', $title)
@json('data/meta/admin_stores_body_class.json', $body_class)

<link rel="stylesheet" href="/css/admin-customers-v3.css" />
<script src="/js/admin-customers-v3.js"></script>
<script src="/js/data_utils.js"></script>

<main id="main" class="admin-stores-v2">
  @include('partials.admin-sidebar')
  <!-- メインコンテンツ -->
  <div class="main-content">
    <div class="container">
      <!-- トップバー -->
      <header class="topbar">
        <div class="topbar-left">
          <h1>顧客管理</h1>
          <span class="store-count" id="store-count">読み込み中...</span>
        </div>
        <div class="topbar-right">
          <div class="export-actions">
            <button type="button" class="export-btn" id="export-csv-btn" title="CSVエクスポート (Ctrl/Cmd + E)">
              <i class="fas fa-file-csv"></i> CSV
            </button>
            <button type="button" class="export-btn" id="export-excel-btn" title="Excelエクスポート">
              <i class="fas fa-file-excel"></i> Excel
            </button>
          </div>
          <button type="button" class="btn btn-primary" id="add-store-btn" onclick="document.getElementById('store-dialog').showModal()" aria-label="新規顧客を追加">
            <i class="fas fa-plus"></i>
            新規追加
          </button>
        </div>
      </header>

    <!-- 最近閲覧した顧客（クイックアクセス） -->
    <div class="recent-views-section" id="recent-views-section" style="display: none;">
      <h2 class="section-title-small">最近閲覧した顧客</h2>
      <div class="recent-views-list" id="recent-views-list">
        <!-- 動的に生成 -->
      </div>
    </div>

    <!-- 統計 -->
    <section class="stats-grid" aria-label="顧客統計">
      <div class="stat-card" role="region" aria-label="店舗統計">
        <div class="stat-label">店舗</div>
        <div class="stat-value" id="stat-stores-total" aria-live="polite">-</div>
        <div class="stat-sub" id="stat-stores-active">稼働中: -</div>
      </div>
      <div class="stat-card" role="region" aria-label="法人統計">
        <div class="stat-label">法人</div>
        <div class="stat-value" id="stat-clients-total" aria-live="polite">-</div>
      </div>
      <div class="stat-card" role="region" aria-label="ブランド統計">
        <div class="stat-label">ブランド</div>
        <div class="stat-value" id="stat-brands-total" aria-live="polite">-</div>
        <div class="stat-sub" id="stat-stores-no-brand">未ブランド紐付け: -</div>
      </div>
      <div class="stat-card" role="region" aria-label="連絡先未登録統計">
        <div class="stat-label">連絡先未登録</div>
        <div class="stat-value" id="stat-missing-contact" aria-live="polite">-</div>
        <div class="stat-sub">電話 or メールが空</div>
      </div>
    </section>

    <!-- ビューモード切り替え -->
    <div class="view-mode-switcher" role="tablist" aria-label="ビューモード切り替え">
      <button class="view-mode-btn" data-view="hierarchy" title="階層ビュー" role="tab" aria-selected="false" aria-controls="hierarchy-view">
        <i class="fas fa-sitemap"></i> 階層
      </button>
      <button class="view-mode-btn" data-view="flat" title="一覧ビュー" role="tab" aria-selected="false" aria-controls="flat-view">
        <i class="fas fa-list"></i> 一覧
      </button>
      <button class="view-mode-btn" data-view="cards" title="カードビュー" role="tab" aria-selected="false" aria-controls="cards-view">
        <i class="fas fa-th"></i> カード
      </button>
    </div>

    <!-- 一括操作バー -->
    <div class="batch-operations-bar" id="batch-operations-bar" role="region" aria-label="一括操作">
      <span class="batch-selected-count" id="batch-selected-count" aria-live="polite">0件選択</span>
      <div class="batch-actions">
        <button class="batch-btn" onclick="batchChangeStatus()" aria-label="選択した項目のステータスを変更">
          <i class="fas fa-edit"></i> ステータス変更
        </button>
        <button class="batch-btn" onclick="batchExport()" aria-label="選択した項目をエクスポート">
          <i class="fas fa-download"></i> エクスポート
        </button>
        <button class="batch-btn" onclick="clearSelection()" aria-label="選択を解除">
          <i class="fas fa-times"></i> 選択解除
        </button>
      </div>
    </div>

    <!-- 統合検索セクション -->
    <div class="unified-search-section">
      <div class="search-header">
        <h2 class="search-title">統合検索</h2>
      </div>
      <div class="search-main">
      <div class="search-input-wrapper">
        <i class="fas fa-search search-icon" aria-hidden="true"></i>
        <input type="text" id="unified-search-input" class="search-input" 
               placeholder="法人名・ブランド名・店舗名・住所・電話で検索..." 
               aria-label="統合検索（Ctrl/Cmd + Kでフォーカス）"
               autocomplete="off"
               list="search-suggestions">
        <datalist id="search-suggestions">
          <!-- 検索履歴が動的に追加されます -->
        </datalist>
        <span class="sr-only">Ctrl/Cmd + K で検索にフォーカス</span>
      </div>
      </div>
      <div class="search-filters">
        <div class="filter-group">
          <label class="filter-label">法人</label>
          <select id="unified-client-filter" class="filter-select">
            <option value="">全法人</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">ブランド</label>
          <select id="unified-brand-filter" class="filter-select">
            <option value="">全ブランド</option>
          </select>
        </div>
        <div class="filter-group">
          <label class="filter-label">ステータス</label>
          <select id="unified-status-filter" class="filter-select">
            <option value="">全ステータス</option>
            <option value="active">稼働中</option>
            <option value="contract_pending">契約作業中</option>
            <option value="considering">検討中</option>
            <option value="prospect">アプローチ前</option>
            <option value="negotiated">商談済</option>
            <option value="lost">失注</option>
            <option value="suspended">休止中</option>
            <option value="terminated">契約終了</option>
          </select>
        </div>
      </div>
      <div class="search-actions">
        <button type="button" class="btn btn-secondary btn-sm" id="unified-reset-filters" aria-label="検索条件をリセット">
          <i class="fas fa-undo"></i> リセット
        </button>
        <button type="button" class="btn btn-outline btn-sm" id="clear-search-history" aria-label="検索履歴をクリア" style="display: none;">
          <i class="fas fa-history"></i> 履歴クリア
        </button>
      </div>
    </div>

    <!-- 階層ビュー -->
    <div id="hierarchy-view" style="display: none;" role="tabpanel" aria-labelledby="hierarchy-tab">
      <div class="hierarchy-tree" id="hierarchy-tree-container" role="tree" aria-label="顧客階層ツリー">
        <div class="loading-cell">
          <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 読み込み中...
        </div>
      </div>
    </div>

    <!-- フラットビュー（既存のテーブル） -->
    <div id="flat-view" role="tabpanel" aria-labelledby="flat-tab">
    <!-- ソート機能（一覧ビュー専用） -->
    <div class="sort-section">
      <div class="sort-row">
        <label for="sort-filter" class="sort-label">並び替え:</label>
        <select id="sort-filter" class="filter-select">
          <option value="name-asc">店舗名 昇順</option>
          <option value="name-desc">店舗名 降順</option>
          <option value="created-desc">登録日 新しい順</option>
          <option value="created-asc">登録日 古い順</option>
          <option value="id-asc">ID 昇順</option>
          <option value="id-desc">ID 降順</option>
        </select>
      </div>
    </div>

    <!-- 店舗一覧 -->
    <div class="stores-table-wrapper">
      <table class="stores-table">
        <thead>
      <tr>
        <th style="width: 40px;"><input type="checkbox" id="select-all-stores" onchange="toggleSelectAll(this)" aria-label="すべて選択"></th>
        <th>ID</th>
        <th>ブランド名</th>
        <th>店舗名</th>
        <th>法人名</th>
        <th>ステータス</th>
        <th>住所</th>
        <th>電話番号</th>
        <th>操作</th>
      </tr>
        </thead>
        <tbody id="stores-tbody">
          <tr>
            <td colspan="8" class="loading-cell">
              <i class="fas fa-spinner fa-spin"></i> 読み込み中...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ページネーション -->
    <div class="pagination" id="pagination"></div>
    </div>

    <!-- カードビュー -->
    <div id="cards-view" style="display: none;" role="tabpanel" aria-labelledby="cards-tab">
      <div class="customer-cards-grid" id="cards-view-container" role="grid" aria-label="顧客カード一覧">
        <div class="loading-cell">
          <i class="fas fa-spinner fa-spin" aria-hidden="true"></i> 読み込み中...
        </div>
      </div>
    </div>
    </div>
  </div>
</main>

<!-- 新規追加/編集ダイアログ -->
<dialog id="store-dialog" class="store-dialog">
  <div class="dialog-content">
    <button type="button" class="dialog-close" onclick="closeStoreDialog()" aria-label="閉じる">
      <i class="fas fa-times"></i>
    </button>
    <h3 id="modal-title">新規顧客登録</h3>
    <form id="store-form" method="dialog">
      <input type="hidden" id="store-id" name="id">
      
      <!-- 法人情報セクション -->
      <div class="hierarchy-section">
        <div class="hierarchy-header">
          <i class="fas fa-building"></i> 法人名
        </div>
      <div class="form-row">
          <div class="form-field">
            <label for="store-client">既存法人から選択</label>
            <select id="store-client" name="client_id">
              <option value="">-- 新規法人または選択 --</option>
            </select>
        </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-client-new">新規法人登録</label>
            <input type="text" id="store-client-new" name="client_name_new" placeholder="株式会社○○">
          </div>
        </div>
      </div>
      
      <!-- ブランド情報セクション -->
      <div class="hierarchy-section">
        <div class="hierarchy-header">
          <i class="fas fa-tag"></i> ブランド名
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-brand">既存ブランドから選択</label>
            <select id="store-brand" name="brand_id">
              <option value="">-- 新規ブランドまたは選択 --</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-brand-new">新規ブランド登録</label>
            <input type="text" id="store-brand-new" name="brand_name_new" placeholder="晩杯屋">
          </div>
        </div>
      </div>
      
      <!-- 店舗情報セクション -->
      <div class="store-section">
        <div class="hierarchy-header">
          <i class="fas fa-store"></i> 新規店舗登録
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-name">店舗名 <span class="required">*</span></label>
            <input type="text" id="store-name" name="name" required placeholder="門前仲町店">
          </div>
        </div>
        <div class="form-row">
        <div class="form-field half">
          <label for="store-contact">担当者名</label>
          <input type="text" id="store-contact" name="contact_person" placeholder="山田太郎">
        </div>
          <div class="form-field half">
            <label for="store-phone">電話番号</label>
            <input type="tel" id="store-phone" name="phone" placeholder="03-1234-5678">
          </div>
      </div>
      <div class="form-row">
        <div class="form-field">
            <label for="store-email">メールアドレス <span class="required" id="email-required" style="display:none">*</span></label>
            <input type="email" id="store-email" name="email" placeholder="info@example.com">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field half">
          <label for="store-postcode">郵便番号</label>
          <input type="text" id="store-postcode" name="postcode" placeholder="1234567">
        </div>
        <div class="form-field half">
          <label for="store-pref">都道府県</label>
          <input type="text" id="store-pref" name="pref" placeholder="東京都">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field half">
          <label for="store-city">市区町村</label>
          <input type="text" id="store-city" name="city" placeholder="新宿区">
        </div>
        <div class="form-field half">
            <label for="store-address1">住所</label>
          <input type="text" id="store-address1" name="address1" placeholder="1-2-3">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
            <label for="store-address2">建物名等</label>
          <input type="text" id="store-address2" name="address2" placeholder="○○ビル3F">
        </div>
      </div>
      <div class="form-row">
          <div class="form-field">
            <label for="store-status">ステータス</label>
            <select id="store-status" name="status">
              <option value="active">稼働中</option>
              <option value="contract_pending">契約作業中</option>
              <option value="considering">検討中</option>
              <option value="prospect">アプローチ前</option>
              <option value="negotiated">商談済</option>
              <option value="lost">失注</option>
              <option value="suspended">休止中</option>
              <option value="terminated">契約終了</option>
            </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label for="store-description">備考</label>
            <textarea id="store-description" name="description" rows="2"></textarea>
          </div>
        </div>
      </div>
      
      <!-- 営業メモ（編集時のみ表示） -->
      <div class="sales-notes-section" id="sales-notes-section" style="display:none;">
        <h4><i class="fas fa-user-tie"></i> 営業情報</h4>
        <div class="sales-info-grid">
          <div class="info-item">
            <span class="info-label">営業担当</span>
            <span class="info-value" id="view-sales-rep">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">商談ステータス</span>
            <span class="info-value" id="view-lead-status">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">見込み度</span>
            <span class="info-value" id="view-probability">-</span>
          </div>
        </div>
        <div class="notes-box">
          <span class="info-label">営業メモ</span>
          <p id="view-notes">-</p>
        </div>
      </div>
      
      <!-- 招待リンク送信オプション（新規追加時のみ表示） -->
      <div class="invite-option" id="invite-option">
        <label class="checkbox-label">
          <input type="checkbox" id="send-invite" name="send_invite">
          <span>お客様に詳細情報入力の招待リンクを送信する</span>
        </label>
        <p class="invite-hint">チェックすると、登録後にお客様のメールアドレスへ招待リンクが送信されます。</p>
      </div>
      
      <div class="form-status" id="form-status"></div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('store-dialog').close()">キャンセル</button>
        <button type="submit" class="btn btn-primary" id="submit-btn">保存</button>
      </div>
    </form>
  </div>
</dialog>

  <!-- 削除確認モーダル -->
  <div class="modal-backdrop" id="delete-modal-backdrop">
    <div class="modal modal-sm" role="dialog" aria-modal="true">
      <h3>削除確認</h3>
      <p id="delete-message">この顧客を削除しますか？</p>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="cancel-delete">キャンセル</button>
        <button type="button" class="btn btn-danger" id="confirm-delete">削除</button>
      </div>
    </div>
  </div>

  <!-- 顧客詳細モーダル -->
  <div class="modal-backdrop" id="detail-modal-backdrop">
    <div class="modal modal-lg" role="dialog" aria-modal="true">
      <button type="button" class="modal-close-btn" onclick="closeDetailModal()">
        <i class="fas fa-times"></i>
      </button>
      <div class="detail-header">
        <h3 id="detail-store-name">店舗名</h3>
        <span class="detail-status" id="detail-status">ステータス</span>
      </div>
      
      <!-- タブナビゲーション -->
      <div class="detail-tabs">
        <button class="detail-tab active" data-tab="info" onclick="switchDetailTab('info')">
          <i class="fas fa-info-circle"></i> 基本情報
        </button>
        <button class="detail-tab" data-tab="estimates" onclick="switchDetailTab('estimates')">
          <i class="fas fa-file-invoice-dollar"></i> 見積もり履歴
        </button>
        <button class="detail-tab" data-tab="schedules" onclick="switchDetailTab('schedules')">
          <i class="fas fa-calendar"></i> スケジュール
        </button>
        <button class="detail-tab" data-tab="reports" onclick="switchDetailTab('reports')">
          <i class="fas fa-file-alt"></i> レポート
        </button>
      </div>
      
      <!-- タブコンテンツ -->
      <div class="detail-content">
        <!-- 基本情報タブ -->
        <div class="detail-panel active" id="panel-info">
          <div class="info-grid" id="detail-info-grid">
            <!-- 動的に挿入 -->
          </div>
        </div>
        
        <!-- 見積もり履歴タブ -->
        <div class="detail-panel" id="panel-estimates">
          <div class="panel-loading" id="estimates-loading">
            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
          </div>
          <div class="estimates-list" id="detail-estimates-list">
            <!-- 動的に挿入 -->
          </div>
        </div>
        
        <!-- スケジュールタブ -->
        <div class="detail-panel" id="panel-schedules">
          <div class="panel-loading" id="schedules-loading">
            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
          </div>
          <div class="schedules-list" id="detail-schedules-list">
            <!-- 動的に挿入 -->
          </div>
        </div>
        
        <!-- レポートタブ -->
        <div class="detail-panel" id="panel-reports">
          <div class="panel-loading" id="reports-loading">
            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
          </div>
          <div class="reports-list" id="detail-reports-list">
            <!-- 動的に挿入 -->
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">閉じる</button>
        <button type="button" class="btn btn-primary" onclick="editFromDetail()">
          <i class="fas fa-edit"></i> 編集
        </button>
      </div>
    </div>
  </div>

  <style>
    :root {
      --sidebar-width: 240px;
      --sidebar-width-collapsed: 64px;
      --topbar-height: 64px;
        --primary: #3b82f6;
  }

    body.page-admin-stores {
      background: #f9fafb;
    }
    main.admin-stores-v2 {
      display: flex;
      min-height: 100vh;
      background: #f9fafb;
    }

    .logo-link {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }
    .logo-img {
      width: 32px;
      height: 32px;
      object-fit: contain;
      flex-shrink: 0;
    }
    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: #111827;
      white-space: nowrap;
      transition: opacity 0.3s ease;
    }
    
    .sidebar-role .role-badge {
      display: inline-block;
      padding: 3px 10px;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }

    .nav-label {
      transition: opacity 0.3s ease;
      white-space: nowrap;
      font-size: 0.8125rem;
    }
    .nav-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 12px;
    }
    .sidebar.collapsed .nav-divider {
      margin: 8px 8px;
    }
    
    .sidebar.collapsed 

    /* メインコンテンツ */
    .main-content {
      margin-left: var(--sidebar-width) !important;
      padding: 24px;
      background: #f9fafb;
      width: calc(100% - var(--sidebar-width)) !important;
      max-width: none !important;
      box-sizing: border-box;
      transition: margin-left 0.3s ease, width 0.3s ease;
    }
    .sidebar.collapsed ~ .main-content {
      margin-left: var(--sidebar-width-collapsed) !important;
      padding: 24px;
      background: #f9fafb;
      width: calc(100% - var(--sidebar-width-collapsed)) !important;
      max-width: none !important;
      box-sizing: border-box;
      transition: margin-left 0.3s ease, width 0.3s ease;
    }
    main.admin-stores-v2 > .main-content > .container {
      width: 100% !important;
      max-width: none !important;
      margin: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
    }

    /* トップバー */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .topbar-left h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    .store-count {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .store-count {
      background: var(--primary);
      color: #fff;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
    }
    .btn-primary:hover {
      background: #d6336c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
    }
    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* 招待リンク成功表示 */
    .invite-success {
      text-align: left;
      padding: 16px;
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 12px;
    }
    .invite-success-header {
      font-size: 1.1rem;
      font-weight: 700;
      color: #16a34a;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .invite-success-header i {
      font-size: 1.25rem;
    }
    .invite-success-body {
      margin-bottom: 8px;
    }
    .invite-success-body p {
      font-size: 0.85rem;
      color: #374151;
      margin: 0 0 6px;
    }
    .invite-link-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 0.85rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      margin-bottom: 6px;
    }
    .invite-success-body small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-danger {
      background: #dc2626;
      color: #fff;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.875rem;
    }
    .search-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }
    .search-row {
      display: flex;
      gap: 12px;
      align-items: stretch;
      flex-wrap: wrap;
    }
    .filter-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: stretch;
    }
    .search-box {
      flex: 1 1 520px; /* 小さめPCでも検索欄が潰れにくい */
      min-width: 360px; /* “見栄え”の基準幅 */
      position: relative;
    }
    .search-box i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }
    .search-box input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fff;
    }
    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,103,156,0.2);
    }
    .filter-select {
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fff;
      min-width: 160px;
    }
    #client-filter.filter-select {
      flex: 0 0 220px;
      min-width: 200px;
    }
    .filter-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    #reset-filters {
      margin-left: auto; /* 2行目の右端へ寄せる */
      white-space: nowrap;
    }
    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .filter-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 999px;
      font-size: 0.875rem;
    }
    .filter-tag button {
      background: none;
      border: none;
      color: #1e40af;
      cursor: pointer;
      padding: 0;
      font-size: 0.75rem;
    }
    .filter-tag button:hover {
      color: #dc2626;
    }
    .stores-table-wrapper {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .stores-table {
      width: 100%;
      border-collapse: collapse;
    }
    .stores-table th,
    .stores-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .stores-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
    }
    .stores-table td {
      font-size: 0.95rem;
      color: #111827;
    }
    .stores-table tr:hover {
      background: #f9fafb;
    }
    .loading-cell {
      text-align: center;
      padding: 48px !important;
      color: #6b7280;
    }
    .store-name {
      font-weight: 600;
      color: var(--primary);
    }
    /* テーブル内リンク */
    .table-link {
      text-decoration: none;
      transition: all 0.2s;
    }
    .table-link:hover {
      text-decoration: underline;
    }
    .table-link.brand-link {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.95rem;
    }
    .table-link.store-link {
      font-weight: 500;
      color: #374151;
      font-size: 0.9rem;
    }
    .table-link.store-link:hover {
      color: var(--primary);
    }
    .table-link.client-link {
      font-size: 0.85rem;
      color: #1e40af;
    }
    .table-link.client-link:hover {
      color: #3b82f6;
    }
    .text-muted {
      color: #9ca3af;
      font-size: 0.85rem;
    }
    .store-address {
      color: #6b7280;
      font-size: 0.875rem;
    }
    .action-btns {
      display: flex;
      gap: 8px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .source-badge {
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .source-badge i {
      margin-right: 4px;
    }
    /* 3層構造表示 */
    .hierarchy-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .hierarchy-client {
      font-size: 0.8rem;
      font-weight: 600;
      color: #1e40af;
    }
    .hierarchy-client i {
      color: #3b82f6;
      margin-right: 4px;
    }
    .hierarchy-brand {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .hierarchy-brand i {
      color: #9ca3af;
      margin-right: 4px;
    }
    .hierarchy-badge.individual {
      font-size: 0.8rem;
      color: #6b7280;
      background: #f3f4f6;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .lead-badge {
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .store-sub {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }
    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
      text-decoration: none;
    }
    .action-btn i {
      font-size: 0.7rem;
    }
    .action-btn.view {
      background: #f3f4f6;
      color: #374151;
    }
    .action-btn.view:hover {
      background: #374151;
      color: #fff;
    }
    .action-btn.chart {
      background: #f0fdf4;
      color: #16a34a;
    }
    .action-btn.chart:hover {
      background: #16a34a;
      color: #fff;
    }
    .action-btn.edit {
      background: #dbeafe;
      color: #2563eb;
    }
    .action-btn.edit:hover {
      background: #2563eb;
      color: #fff;
    }
    .action-btn.delete {
      background: #fee2e2;
      color: #dc2626;
    }
    .action-btn.delete:hover {
      background: #dc2626;
      color: #fff;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 24px;
    }
    .page-btn {
      padding: 8px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .page-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .page-btn:hover:not(.active) {
      background: #f3f4f6;
    }

    /* 統計カード */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin: 12px 0 16px;
    }
    .stat-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04);
    }
    .stat-label {
      font-size: 0.75rem;
      color: #6b7280;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: 800;
      color: #111827;
      margin-top: 2px;
      line-height: 1.2;
    }
    .stat-sub {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 6px;
    }
    @media (max-width: 1024px) {
      .stats-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 520px) {
      .stats-grid { grid-template-columns: 1fr; }
    }
    /* ダイアログ（HTML5 dialog要素） */
    .store-dialog {
      border: none;
      border-radius: 16px;
      padding: 0;
      max-width: 640px;
      width: 92vw;
      max-height: 90vh;
      overflow: visible;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }
    .store-dialog::backdrop {
      background: rgba(0,0,0,0.5);
    }
    .store-dialog .dialog-content {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .store-dialog h3 {
      font-size: 1.5rem;
      margin-bottom: 24px;
      color: #111827;
    }
    
    /* 法人・ブランド・店舗セクション */
    .hierarchy-section,
    .store-section {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .hierarchy-header {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    .hierarchy-header i {
      font-size: 1rem;
    }
    .hierarchy-section select,
    .store-section select,
    .hierarchy-section input,
    .store-section input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fff;
      box-sizing: border-box;
    }
    .hierarchy-section select:focus,
    .store-section select:focus,
    .hierarchy-section input:focus,
    .store-section input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }
    .hierarchy-section .form-row,
    .store-section .form-row {
      margin-bottom: 12px;
    }
    .hierarchy-section .form-row:last-child,
    .store-section .form-row:last-child {
      margin-bottom: 0;
    }
    .hierarchy-section label,
    .store-section label {
      display: block;
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 6px;
    }
    
    .dialog-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: #6b7280;
      cursor: pointer;
      z-index: 10;
    }
    .dialog-close:hover {
      color: #111827;
    }
    .sales-notes-section {
      background: #faf5ff;
      border: 1px solid #d8b4fe;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .sales-notes-section h4 {
      color: #7c3aed;
      font-size: 0.95rem;
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sales-info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .info-label {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .info-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
    }
    .notes-box {
      background: #fff;
      border-radius: 6px;
      padding: 12px;
    }
    .notes-box p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #374151;
      white-space: pre-wrap;
    }
    .invite-option {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .invite-option .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #166534;
      cursor: pointer;
    }
    .invite-option .checkbox-label input {
      width: 18px;
      height: 18px;
    }
    .invite-hint {
      font-size: 0.8rem;
      color: #15803d;
      margin: 8px 0 0 26px;
    }
    /* モーダル（削除確認用） */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-backdrop.active {
      display: flex !important;
    }
    .modal {
      background: #fff;
      border-radius: 16px;
      width: min(640px, 92vw);
      padding: 32px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal.modal-sm {
      width: min(400px, 92vw);
      text-align: center;
    }
    .modal.modal-lg {
      width: min(900px, 95vw);
      max-height: 85vh;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    .modal-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #6b7280;
      z-index: 10;
    }
    .detail-header {
      padding: 24px 32px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .detail-header h3 {
      margin: 0;
      font-size: 1.25rem;
    }
    .detail-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .detail-status.active { background: #d1fae5; color: #065f46; }
    .detail-status.suspended { background: #fef3c7; color: #92400e; }
    .detail-status.terminated { background: #fee2e2; color: #991b1b; }
    .detail-status.pending { background: #e0e7ff; color: #3730a3; }
    
    .detail-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      padding: 0 24px;
      background: #f9fafb;
    }
    .detail-tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      font-size: 0.9rem;
      color: #6b7280;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .detail-tab:hover { color: #111827; }
    .detail-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 600;
    }
    
    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
    }
    .detail-panel {
      display: none;
    }
    .detail-panel.active {
      display: block;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .info-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .info-item.full { grid-column: 1 / -1; }
    .info-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .info-value {
      font-size: 0.95rem;
      color: #111827;
      font-weight: 500;
    }
    
    .panel-loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .empty-panel {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }
    .empty-panel i {
      font-size: 2rem;
      margin-bottom: 12px;
      display: block;
    }
    
    .history-item {
      padding: 16px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .history-item:last-child { margin-bottom: 0; }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-id {
      font-weight: 600;
      color: #111827;
    }
    .history-date {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .history-status {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .history-status.pending { background: #fef3c7; color: #92400e; }
    .history-status.processing { background: #dbeafe; color: #1e40af; }
    .history-status.completed { background: #d1fae5; color: #065f46; }
    .history-status.rejected { background: #fee2e2; color: #991b1b; }
    .history-status.scheduled { background: #dbeafe; color: #1e40af; }
    .history-status.draft { background: #fef3c7; color: #92400e; }
    .history-body {
      font-size: 0.9rem;
      color: #374151;
    }
    .history-amount {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
      margin-top: 8px;
    }
    .history-items {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f0f0f0;
      font-size: 0.85rem;
      color: #6b7280;
    }
    
    .modal.modal-lg .modal-actions {
      padding: 16px 32px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    @media (max-width: 640px) {
      .info-grid { grid-template-columns: 1fr; }
      .detail-tabs { overflow-x: auto; }
      .detail-tab { white-space: nowrap; padding: 10px 14px; font-size: 0.8rem; }
    }
    
    .modal h3 {
      font-size: 1.5rem;
      margin-bottom: 24px;
      color: #111827;
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #6b7280;
    }
    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    .form-field {
      flex: 1;
    }
    .form-field.half {
      flex: 0 0 calc(50% - 8px);
    }
    .form-field label {
      display: block;
      font-weight: 600;
      font-size: 0.875rem;
      color: #374151;
      margin-bottom: 6px;
    }
    .form-field .required {
      color: #dc2626;
    }
    .form-field input,
    .form-field textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .form-field input:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,103,156,0.2);
    }
    .form-status {
      min-height: 24px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }
    .form-status.success { color: #059669; }
    .form-status.error { color: #dc2626; }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    @media (max-width: 768px) {
      main.admin-stores > .container {
        padding: 16px;
      }
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      .search-box {
        min-width: 0; /* SPでは幅固定を解除 */
      }
      #client-filter.filter-select {
        flex: 1 1 220px;
      }
      #reset-filters {
        margin-left: 0;
      }
      .stores-table th:nth-child(3),
      .stores-table td:nth-child(3),
      .stores-table th:nth-child(5),
      .stores-table td:nth-child(5) {
        display: none;
      }
      .form-row {
        flex-direction: column;
        gap: 12px;
      }
      .form-field.half {
        flex: 1;
      }
    }
  </style>

<script>
(function() {
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  
  let allStores = [];
  let allClients = [];
  let allBrands = [];
  let filteredStores = [];
  let currentPage = 1;
  const perPage = 20;
  let deleteTargetId = null;

  // DOM要素
  const tbody = document.getElementById('stores-tbody');
  const storeCount = document.getElementById('store-count');
  // 統合検索を使用するため、一覧ビューの検索・フィルターは削除
  // const searchInput = document.getElementById('search-input');
  // const clientFilter = document.getElementById('client-filter');
  // const brandFilter = document.getElementById('brand-filter');
  // const prefFilter = document.getElementById('pref-filter');
  // const statusFilter = document.getElementById('status-filter');
  const sortFilter = document.getElementById('sort-filter'); // ソート機能は残す
  // const activeFiltersEl = document.getElementById('active-filters');
  const pagination = document.getElementById('pagination');
  
  const storeModal = document.getElementById('store-dialog');
  const deleteModal = document.getElementById('delete-modal-backdrop');
  const storeForm = document.getElementById('store-form');
  const modalTitle = document.getElementById('modal-title');
  const formStatus = document.getElementById('form-status');

  // IDトークン取得（Cognito/localStorageから取得）
  async function getFirebaseIdToken() {
    try {
      const cognitoIdToken = localStorage.getItem('cognito_id_token');
      if (cognitoIdToken) return cognitoIdToken;

      const authData = localStorage.getItem('misesapo_auth');
      if (authData) {
        const parsed = JSON.parse(authData);
        if (parsed.token) return parsed.token;
      }
      return null;
    } catch (error) {
      console.error('Error getting ID token:', error);
      return null;
    }
  }

  async function getAuthHeaders() {
    const idToken = await getFirebaseIdToken();
    if (!idToken) return null;
    return {
      'Authorization': `Bearer ${idToken}`,
      'Content-Type': 'application/json'
    };
  }

  // データを取得
  async function loadStores() {
    try {
      const headers = (await getAuthHeaders()) || { 'Content-Type': 'application/json' };
      // 並列で取得
      const [storesRes, clientsRes, brandsRes] = await Promise.all([
        fetch(`${API_BASE}/stores`, { headers }).catch(() => ({ ok: false })),
        fetch(`${API_BASE}/clients`, { headers }).catch(() => ({ ok: false })),
        fetch(`${API_BASE}/brands`, { headers }).catch(() => ({ ok: false }))
      ]);
      
      if (storesRes.ok) {
        const storesData = await storesRes.json();
        allStores = Array.isArray(storesData) ? storesData : (storesData.items || storesData.stores || []);
      } else {
        console.warn('Failed to load stores');
        allStores = [];
      }
      
      if (clientsRes.ok) {
        const clientsData = await clientsRes.json();
        allClients = Array.isArray(clientsData) ? clientsData : (clientsData.items || clientsData.clients || []);
        console.log('Loaded clients:', allClients.length, 'items');
        if (allClients.length > 0) {
          console.log('Sample client:', allClients[0]);
        }
      } else {
        console.warn('Failed to load clients');
        allClients = [];
      }
      
      if (brandsRes.ok) {
        const brandsData = await brandsRes.json();
        allBrands = Array.isArray(brandsData) ? brandsData : (brandsData.items || brandsData.brands || []);
      } else {
        console.warn('Failed to load brands');
        allBrands = [];
      }
      
      // フィルター選択肢を生成
      populateFilters();
      updateStats();
      filterAndRender();
    } catch (error) {
      console.error('Failed to load data:', error);
      tbody.innerHTML = '<tr><td colspan="9" class="loading-cell"><i class="fas fa-exclamation-triangle"></i><br>読み込みに失敗しました<br><small>ネットワーク接続を確認してください</small></td></tr>';
    }
  }

  function updateStats() {
    const storesTotalEl = document.getElementById('stat-stores-total');
    const storesActiveEl = document.getElementById('stat-stores-active');
    const clientsTotalEl = document.getElementById('stat-clients-total');
    const brandsTotalEl = document.getElementById('stat-brands-total');
    const storesNoBrandEl = document.getElementById('stat-stores-no-brand');
    const missingContactEl = document.getElementById('stat-missing-contact');

    const stores = Array.isArray(allStores) ? allStores : [];
    const clients = Array.isArray(allClients) ? allClients : [];
    const brands = Array.isArray(allBrands) ? allBrands : [];

    const storesActive = stores.filter(s => s.status === 'active' || s.status === '稼働中').length;
    const storesNoBrand = stores.filter(s => !s.brand_id).length;
    const missingContact = stores.filter(s => !(s.phone || '').trim() || !(s.email || '').trim()).length;

    if (storesTotalEl) storesTotalEl.textContent = String(stores.length);
    if (storesActiveEl) storesActiveEl.textContent = `稼働中: ${storesActive}`;
    if (clientsTotalEl) clientsTotalEl.textContent = String(clients.length);
    if (brandsTotalEl) brandsTotalEl.textContent = String(brands.length);
    if (storesNoBrandEl) storesNoBrandEl.textContent = `未ブランド紐付け: ${storesNoBrand}`;
    if (missingContactEl) missingContactEl.textContent = String(missingContact);
  }
  
  // フィルター選択肢を生成
  function populateFilters() {
    // 配列であることを確認
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array:', allClients);
      allClients = [];
    }
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array:', allBrands);
      allBrands = [];
    }
    if (!Array.isArray(allStores)) {
      console.warn('allStores is not an array:', allStores);
      allStores = [];
    }
    
    // 統合検索を使用するため、一覧ビューのフィルター初期化は削除
    // 取引先（企業/個人）
    // clientFilter.innerHTML = '<option value="">全法人</option>' + 
    //   allClients.map(c => `<option value="${c.id}">${c.name}${c.type === 'individual' ? '（個人）' : ''}</option>`).join('');
    
    // ブランド（取引先に連動）
    // updateBrandFilter();
    
    // 都道府県
    // const prefs = [...new Set(allStores.map(s => s.pref).filter(Boolean))].sort();
    // prefFilter.innerHTML = '<option value="">全都道府県</option>' + 
    //   prefs.map(p => `<option value="${p}">${p}</option>`).join('');
  }
  
  // ブランドフィルターを更新（取引先に連動）
  function updateBrandFilter() {
    // 配列であることを確認
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array in updateBrandFilter:', allBrands);
      allBrands = [];
    }
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array in updateBrandFilter:', allClients);
      allClients = [];
    }
    
    const selectedClient = clientFilter.value;
    let brands;
    if (selectedClient) {
      // IdUtils.isSameを使用してID形式の違いに対応
      if (window.DataUtils?.IdUtils?.isSame) {
        brands = allBrands.filter(b => window.DataUtils.IdUtils.isSame(b.client_id, selectedClient));
      } else {
        brands = allBrands.filter(b => b.client_id === selectedClient || String(b.client_id) === String(selectedClient));
      }
    } else {
      brands = allBrands;
    }
    brandFilter.innerHTML = '<option value="">全ブランド</option>' + 
      brands.map(b => {
        // EntityFinderを使用してID形式の違いに対応
        let client = null;
        if (window.DataUtils?.EntityFinder?.findClient) {
          client = window.DataUtils.EntityFinder.findClient(allClients, b.client_id);
        } else {
          client = allClients.find(c => c.id === b.client_id || String(c.id) === String(b.client_id));
        }
        const clientName = client ? ` (${client.name || client.company_name || ''})` : '';
        return `<option value="${b.id}">${b.name}${selectedClient ? '' : clientName}</option>`;
      }).join('');
  }

  // フィルタリングと表示
  function filterAndRender() {
    // 配列であることを確認
    if (!Array.isArray(allStores)) {
      console.warn('allStores is not an array in filterAndRender:', allStores);
      allStores = [];
    }
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array in filterAndRender:', allBrands);
      allBrands = [];
    }
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array in filterAndRender:', allClients);
      allClients = [];
    }
    
    // 統合検索の要素を使用
    const unifiedSearchInput = document.getElementById('unified-search-input');
    const unifiedClientFilter = document.getElementById('unified-client-filter');
    const unifiedBrandFilter = document.getElementById('unified-brand-filter');
    const unifiedStatusFilter = document.getElementById('unified-status-filter');
    
    const searchTerm = (unifiedSearchInput?.value || '').toLowerCase();
    const clientValue = unifiedClientFilter?.value || '';
    const brandValue = unifiedBrandFilter?.value || '';
    const prefValue = ''; // 都道府県フィルターは統合検索にないため削除
    const statusValue = unifiedStatusFilter?.value || '';
    const sortValue = sortFilter?.value || 'name-asc';
    
    // フィルタリング
    filteredStores = allStores.filter(store => {
      const matchSearch = !searchTerm || 
        (store.name || '').toLowerCase().includes(searchTerm) ||
        (store.city || '').toLowerCase().includes(searchTerm) ||
        (store.address1 || '').toLowerCase().includes(searchTerm) ||
        (store.phone || '').includes(searchTerm);
      
      // ブランドでフィルター（IdUtils.isSameを使用）
      let matchBrand = true;
      if (brandValue) {
        if (window.DataUtils?.IdUtils?.isSame) {
          matchBrand = window.DataUtils.IdUtils.isSame(store.brand_id, brandValue);
        } else {
          matchBrand = store.brand_id === brandValue || String(store.brand_id) === String(brandValue);
        }
      }
      
      // 取引先でフィルター（ブランド経由、または直接）
      let matchClient = true;
      if (clientValue) {
        if (brandValue) {
          // ブランドも選択されている場合、ブランドがその取引先に属しているか確認
          let brand = null;
          if (window.DataUtils?.EntityFinder?.findBrand) {
            brand = window.DataUtils.EntityFinder.findBrand(allBrands, brandValue);
          } else {
            brand = allBrands.find(b => b.id === brandValue || String(b.id) === String(brandValue));
          }
          // IdUtils.isSameを使用してID形式の違いに対応
          if (window.DataUtils?.IdUtils?.isSame) {
            matchClient = brand && window.DataUtils.IdUtils.isSame(brand.client_id, clientValue);
          } else {
            matchClient = brand && (brand.client_id === clientValue || String(brand.client_id) === String(clientValue));
          }
        } else {
          // ブランドが選択されていない場合、取引先に属するブランドの店舗を表示
          let clientBrands = [];
          if (window.DataUtils?.IdUtils?.isSame) {
            clientBrands = allBrands.filter(b => window.DataUtils.IdUtils.isSame(b.client_id, clientValue)).map(b => b.id);
          } else {
            clientBrands = allBrands.filter(b => b.client_id === clientValue || String(b.client_id) === String(clientValue)).map(b => b.id);
          }
          // IdUtils.isSameを使用してID形式の違いに対応
          if (window.DataUtils?.IdUtils?.isSame) {
            matchBrand = clientBrands.some(bid => window.DataUtils.IdUtils.isSame(store.brand_id, bid)) || 
                        window.DataUtils.IdUtils.isSame(store.client_id, clientValue);
          } else {
            matchBrand = clientBrands.includes(store.brand_id) || store.brand_id === clientValue || 
                        store.client_id === clientValue || String(store.client_id) === String(clientValue);
          }
        }
      }
      
      const matchPref = !prefValue || store.pref === prefValue;
      const matchStatus = !statusValue || store.status === statusValue;
      return matchSearch && matchBrand && matchClient && matchPref && matchStatus;
    });
    
    // ソート
    filteredStores.sort((a, b) => {
      switch (sortValue) {
        case 'name-asc':
          return (a.name || '').localeCompare(b.name || '', 'ja');
        case 'name-desc':
          return (b.name || '').localeCompare(a.name || '', 'ja');
        case 'created-desc':
          return (b.created_at || '').localeCompare(a.created_at || '');
        case 'created-asc':
          return (a.created_at || '').localeCompare(b.created_at || '');
        case 'id-asc':
          {
            const toSortableIdNumber = (id) => {
              const raw = (window.DataUtils?.IdUtils?.extractNumber)
                ? window.DataUtils.IdUtils.extractNumber(id)
                : (String(id || '').match(/\d+$/)?.[0] || String(id || ''));
              const n = parseInt(raw, 10);
              return Number.isFinite(n) ? n : Number.MAX_SAFE_INTEGER;
            };
            const diff = toSortableIdNumber(a.id) - toSortableIdNumber(b.id);
            return diff !== 0 ? diff : String(a.id || '').localeCompare(String(b.id || ''), 'ja');
          }
        case 'id-desc':
          {
            const toSortableIdNumber = (id) => {
              const raw = (window.DataUtils?.IdUtils?.extractNumber)
                ? window.DataUtils.IdUtils.extractNumber(id)
                : (String(id || '').match(/\d+$/)?.[0] || String(id || ''));
              const n = parseInt(raw, 10);
              return Number.isFinite(n) ? n : Number.MAX_SAFE_INTEGER;
            };
            const diff = toSortableIdNumber(b.id) - toSortableIdNumber(a.id);
            return diff !== 0 ? diff : String(b.id || '').localeCompare(String(a.id || ''), 'ja');
          }
        default:
          return 0;
      }
    });
    
    storeCount.textContent = `${filteredStores.length}件`;
    currentPage = 1;
    renderTable();
    renderPagination();
    // renderActiveFilters(); // 統合検索を使用するため削除
  }
  
  // アクティブフィルター表示（統合検索を使用するため削除）
  // function renderActiveFilters() {
  //   const filters = [];
  //   if (searchInput.value) filters.push({ key: 'search', label: `検索: ${searchInput.value}` });
  //   if (clientFilter.value) {
  //     let client = null;
  //     if (window.DataUtils?.EntityFinder?.findClient) {
  //       client = window.DataUtils.EntityFinder.findClient(allClients, clientFilter.value);
  //     } else {
  //       client = allClients.find(c => c.id === clientFilter.value || String(c.id) === String(clientFilter.value));
  //     }
  //     filters.push({ key: 'client', label: `取引先: ${client ? (client.name || client.company_name || '') : clientFilter.value}` });
  //   }
  //   if (brandFilter.value) {
  //     let brand = null;
  //     if (window.DataUtils?.EntityFinder?.findBrand) {
  //       brand = window.DataUtils.EntityFinder.findBrand(allBrands, brandFilter.value);
  //     } else {
  //       brand = allBrands.find(b => b.id === brandFilter.value || String(b.id) === String(brandFilter.value));
  //     }
  //     filters.push({ key: 'brand', label: `ブランド: ${brand ? brand.name : brandFilter.value}` });
  //   }
  //   if (prefFilter.value) filters.push({ key: 'pref', label: prefFilter.value });
  //   if (statusFilter.value) {
  //     const statusLabelsMap = {
  //       'pending_customer_info': '情報入力待ち', 'pending_approval': '承認待ち',
  //       'active': '稼働中', 'suspended': '休止中', 'terminated': '契約終了'
  //     };
  //     filters.push({ key: 'status', label: statusLabelsMap[statusFilter.value] || statusFilter.value });
  //   }
  //   
  //   if (filters.length === 0) {
  //     activeFiltersEl.innerHTML = '';
  //     return;
  //   }
  //   
  //   activeFiltersEl.innerHTML = filters.map(f => `
  //     <span class="filter-tag">
  //       ${escapeHtml(f.label)}
  //       <button onclick="clearFilter('${f.key}')" title="解除">×</button>
  //     </span>
  //   `).join('');
  // }
  
  // 個別フィルター解除（統合検索を使用するため削除）
  // window.clearFilter = function(key) {
  //   switch (key) {
  //     case 'search': searchInput.value = ''; break;
  //     case 'client': clientFilter.value = ''; updateBrandFilter(); break;
  //     case 'brand': brandFilter.value = ''; break;
  //     case 'pref': prefFilter.value = ''; break;
  //     case 'status': statusFilter.value = ''; break;
  //   }
  //   filterAndRender();
  // };
  
  // 全フィルターリセット（統合検索を使用するため削除）
  // document.getElementById('reset-filters').addEventListener('click', () => {
  //   searchInput.value = '';
  //   clientFilter.value = '';
  //   brandFilter.value = '';
  //   prefFilter.value = '';
  //   statusFilter.value = '';
  //   sortFilter.value = 'name-asc';
  //   updateBrandFilter();
  //   filterAndRender();
  // });

  // テーブル描画
  function renderTable() {
    const start = (currentPage - 1) * perPage;
    const pageStores = filteredStores.slice(start, start + perPage);
    
    if (pageStores.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="loading-cell"><i class="fas fa-inbox"></i><br>該当する店舗がありません</td></tr>';
      return;
    }
    
    tbody.innerHTML = pageStores.map(store => {
      // 3層構造の情報を取得（data_utils.jsを使用）
      let hierarchy = { client: null, brand: null, store: null };
      if (window.DataUtils?.Hierarchy?.getFromStore) {
        try {
          hierarchy = window.DataUtils.Hierarchy.getFromStore(store, allClients, allBrands);
        } catch (e) {
          console.warn('Failed to get hierarchy from DataUtils:', e);
        }
      }
      
      // フォールバック: EntityFinderを使用（ID形式の違いに対応）
      let brand = hierarchy.brand;
      let client = hierarchy.client;
      
      if (!brand && store.brand_id) {
        // EntityFinderを使用してID形式の違いに対応
        if (window.DataUtils?.EntityFinder?.findBrand) {
          brand = window.DataUtils.EntityFinder.findBrand(allBrands, store.brand_id);
        } else {
          // フォールバック: 手動で取得（文字列比較と数値比較）
          brand = allBrands.find(b => {
            return b.id === store.brand_id || String(b.id) === String(store.brand_id);
          });
        }
      }
      
      if (!client) {
        // まずstore.client_idから直接取得を試みる
        if (store.client_id) {
          // EntityFinderを使用してID形式の違いに対応
          if (window.DataUtils?.EntityFinder?.findClient) {
            client = window.DataUtils.EntityFinder.findClient(allClients, store.client_id);
          } else {
            // フォールバック: 手動で取得
            client = allClients.find(c => {
              const match = c.id === store.client_id || String(c.id) === String(store.client_id);
              if (match && !c.name) {
                console.warn('Client found but name is missing:', c);
              }
              return match;
            });
          }
        }
        // store.client_idで取得できなかった場合、brand.client_idから取得
        if (!client && brand && brand.client_id) {
          // EntityFinderを使用してID形式の違いに対応
          if (window.DataUtils?.EntityFinder?.findClient) {
            client = window.DataUtils.EntityFinder.findClient(allClients, brand.client_id);
          } else {
            // フォールバック: 手動で取得
            client = allClients.find(c => {
              return c.id === brand.client_id || String(c.id) === String(brand.client_id);
            });
          }
        }
      }
      
      // デバッグ: clientが見つからない場合
      if (!client && store.client_id) {
        console.warn('Client not found for store:', store.id, 'client_id:', store.client_id, 'available clients:', allClients.length);
      }
      
      // 店舗名からブランド名と店舗名（〜店）を分離
      const storeName = store.name || '';
      const brandName = brand?.name || '';
      let shopName = storeName;
      
      // ブランド名が店舗名に含まれている場合、店舗名部分（〜店）を抽出
      if (brandName && storeName.startsWith(brandName)) {
        shopName = storeName.substring(brandName.length).trim() || '-';
      }
      
      // リンク生成（データがない場合はテキストのみ）
      const storeLink = `/admin/customers/stores/detail.html?id=${store.id}`;
      const brandCell = brand 
        ? `<a href="/admin/customers/brands/detail?id=${brand.id}" class="table-link brand-link">${escapeHtml(brandName)}</a>`
        : `<span class="text-muted">${escapeHtml(brandName || '-')}</span>`;
      // 法人名を取得（nameフィールドを優先、なければcompany_name）
      const clientName = client ? (client.name || client.company_name || '-') : '-';
      const clientCell = client 
        ? `<a href="/admin/customers/clients/detail?id=${client.id}" class="table-link client-link">${escapeHtml(clientName)}</a>`
        : `<span class="text-muted">-</span>`;
      
      // デバッグ: 法人名が空の場合
      if (client && !client.name && !client.company_name) {
        console.warn('Client has no name:', client);
      }
      
      const isSelected = window.selectedItems && window.selectedItems.has(store.id);
      return `
      <tr data-id="${store.id}" ${isSelected ? 'class="row-selected"' : ''}>
        <td><input type="checkbox" class="store-checkbox" data-id="${store.id}" onchange="toggleStoreSelection('${store.id}')" aria-label="店舗 ${escapeHtml(store.name || store.id)} を選択" ${isSelected ? 'checked' : ''}></td>
        <td>${store.id}</td>
        <td>${brandCell}</td>
        <td>
          <a href="${storeLink}" class="table-link store-link">${escapeHtml(shopName)}</a>
        </td>
        <td>${clientCell}</td>
        <td>${getStatusBadge(store.status)}</td>
        <td>
          ${store.pref || ''}${store.city || ''}<br>
          <small>${store.address1 || ''}</small>
        </td>
        <td>${store.phone || '-'}</td>
        <td>
          <div class="action-btns">
            <input type="checkbox" class="store-checkbox" data-id="${store.id}" onchange="toggleStoreSelection('${store.id}')" style="margin-right: 8px;">
            <a href="/admin/customers/stores/[id]/chart.html?id=${encodeURIComponent(store.id)}" class="action-btn chart" title="清掃カルテ">
              <i class="fas fa-clipboard-list"></i>
            </a>
            <button type="button" class="action-btn edit" title="編集" onclick="editStore('${store.id}')">
              <i class="fas fa-edit"></i>
            </button>
            <button type="button" class="action-btn delete" title="削除" onclick="deleteStore('${store.id}','${escapeHtml(store.name || '')}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `}).join('');
  }
  
  // 3層構造バッジ
  function getHierarchyBadge(client, brand) {
    if (!client && !brand) {
      return '<span class="hierarchy-badge individual"><i class="fas fa-store"></i> 個人店舗</span>';
    }
    
    let html = '<div class="hierarchy-info">';
    if (client) {
      html += `<div class="hierarchy-client"><i class="fas fa-building"></i> ${escapeHtml(client.name)}</div>`;
    }
    if (brand && brand.name !== client?.name) {
      html += `<div class="hierarchy-brand"><i class="fas fa-tag"></i> ${escapeHtml(brand.name)}</div>`;
    }
    html += '</div>';
    return html;
  }

  // ページネーション描画
  function renderPagination() {
    const totalPages = Math.ceil(filteredStores.length / perPage);
    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }
    
    let html = '';
    for (let i = 1; i <= totalPages; i++) {
      html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
    pagination.innerHTML = html;
  }

  // ページ移動
  window.goToPage = function(page) {
    currentPage = page;
    renderTable();
    renderPagination();
  };

  // モーダルを閉じる関数
  window.closeStoreDialog = function() {
    storeModal.close();
    formStatus.textContent = '';
    formStatus.className = 'form-status';
  };
  
  // 法人・ブランドの選択肢を更新
  function populateHierarchySelects() {
    // 配列であることを確認
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array in populateHierarchySelects:', allClients);
      allClients = [];
    }
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array in populateHierarchySelects:', allBrands);
      allBrands = [];
    }
    
    const clientSelect = document.getElementById('store-client');
    const brandSelect = document.getElementById('store-brand');
    
    // 法人選択肢
    clientSelect.innerHTML = '<option value="">-- 新規法人または選択 --</option>' + 
      allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // ブランド選択肢（全て）
    updateBrandSelectForForm();
  }
  
  // フォーム用ブランド選択肢を更新
  function updateBrandSelectForForm() {
    // 配列であることを確認
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array in updateBrandSelectForForm:', allBrands);
      allBrands = [];
    }
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array in updateBrandSelectForForm:', allClients);
      allClients = [];
    }
    
    const clientId = document.getElementById('store-client').value;
    const brandSelect = document.getElementById('store-brand');
    
    let brands;
    if (clientId) {
      // IdUtils.isSameを使用してID形式の違いに対応
      if (window.DataUtils?.IdUtils?.isSame) {
        brands = allBrands.filter(b => window.DataUtils.IdUtils.isSame(b.client_id, clientId));
      } else {
        brands = allBrands.filter(b => b.client_id === clientId || String(b.client_id) === String(clientId));
      }
    } else {
      brands = allBrands;
    }
    
    brandSelect.innerHTML = '<option value="">-- 新規ブランドまたは選択 --</option>' + 
      brands.map(b => {
        // EntityFinderを使用してID形式の違いに対応
        let client = null;
        if (window.DataUtils?.EntityFinder?.findClient) {
          client = window.DataUtils.EntityFinder.findClient(allClients, b.client_id);
        } else {
          client = allClients.find(c => c.id === b.client_id || String(c.id) === String(b.client_id));
        }
        const clientName = client ? ` (${client.name || client.company_name || ''})` : '';
        return `<option value="${b.id}">${b.name}${clientName}</option>`;
      }).join('');
  }
  
  // 法人選択時にブランド選択肢を更新
  document.getElementById('store-client').addEventListener('change', updateBrandSelectForForm);

  // 新規追加モーダル
  document.getElementById('add-store-btn').addEventListener('click', () => {
    modalTitle.textContent = '新規顧客登録';
    storeForm.reset();
    document.getElementById('store-id').value = '';
    document.getElementById('invite-option').style.display = 'block';
    document.getElementById('store-status').value = 'active';
    populateHierarchySelects();
    formStatus.textContent = '';
    formStatus.className = 'form-status';
    storeModal.showModal();
  });

  // 編集モーダル
  window.editStore = function(id) {
    const store = allStores.find(s => s.id === id);
    if (!store) return;
    
    modalTitle.textContent = '顧客情報編集';
    const storeIdEl = document.getElementById('store-id');
    if (storeIdEl) storeIdEl.value = store.id;
    
    const storeCompanyEl = document.getElementById('store-company');
    if (storeCompanyEl) storeCompanyEl.value = store.company_name || '';
    
    const storeContactEl = document.getElementById('store-contact');
    if (storeContactEl) storeContactEl.value = store.contact_person || '';
    
    const storeNameEl = document.getElementById('store-name');
    if (storeNameEl) storeNameEl.value = store.name || '';
    
    const storePostcodeEl = document.getElementById('store-postcode');
    if (storePostcodeEl) storePostcodeEl.value = store.postcode || '';
    
    const storePrefEl = document.getElementById('store-pref');
    if (storePrefEl) storePrefEl.value = store.pref || '';
    
    const storeCityEl = document.getElementById('store-city');
    if (storeCityEl) storeCityEl.value = store.city || '';
    
    const storeAddress1El = document.getElementById('store-address1');
    if (storeAddress1El) storeAddress1El.value = store.address1 || '';
    
    const storeAddress2El = document.getElementById('store-address2');
    if (storeAddress2El) storeAddress2El.value = store.address2 || '';
    
    const storePhoneEl = document.getElementById('store-phone');
    if (storePhoneEl) storePhoneEl.value = store.phone || '';
    
    const storeEmailEl = document.getElementById('store-email');
    if (storeEmailEl) storeEmailEl.value = store.email || store.report_email || '';
    
    const storeDescriptionEl = document.getElementById('store-description');
    if (storeDescriptionEl) storeDescriptionEl.value = store.description || '';
    
    const inviteOptionEl = document.getElementById('invite-option');
    if (inviteOptionEl) inviteOptionEl.style.display = 'none'; // 編集時は非表示
    
    const sendInviteEl = document.getElementById('send-invite');
    if (sendInviteEl) sendInviteEl.checked = false;
    
    // 営業情報表示（営業からの登録の場合）
    const salesSection = document.getElementById('sales-notes-section');
    if (store.registration_type === 'sales_lead') {
      salesSection.style.display = 'block';
      document.getElementById('view-sales-rep').textContent = store.sales_rep || '-';
      const leadLabels = { 'initial': '初回接触', 'negotiating': '商談中', 'proposal': '提案済み', 'pending': '検討中' };
      document.getElementById('view-lead-status').textContent = leadLabels[store.lead_status] || store.lead_status || '-';
      const probLabels = { 'high': '高（80%以上）', 'medium': '中（50%程度）', 'low': '低（30%以下）' };
      document.getElementById('view-probability').textContent = probLabels[store.probability] || store.probability || '-';
      document.getElementById('view-notes').textContent = store.notes || '（メモなし）';
    } else {
      salesSection.style.display = 'none';
    }
    
    formStatus.textContent = '';
    storeModal.showModal();
  };

  // 削除確認
  window.deleteStore = function(id, name) {
    if (!id) {
      console.error('Delete store: id is required');
      return;
    }
    deleteTargetId = id;
    const deleteMessageEl = document.getElementById('delete-message');
    if (deleteMessageEl) {
      deleteMessageEl.textContent = `「${name}」を削除しますか？この操作は取り消せません。`;
    }
    if (deleteModal) {
      deleteModal.classList.add('active');
    } else {
      console.error('Delete modal not found');
      alert('削除モーダルが見つかりません');
    }
  };

  // 詳細表示
  const detailModal = document.getElementById('detail-modal-backdrop');
  let currentDetailStore = null;

  window.viewStore = function(id) {
    // 詳細ページへ遷移
    window.location.href = `/admin/customers/stores/detail.html?id=${id}`;
  };

  // モーダル版（後方互換用）
  window.viewStoreModal = async function(id) {
    currentDetailStore = allStores.find(s => s.id === id);
    if (!currentDetailStore) return;

    // 基本情報を表示
    document.getElementById('detail-store-name').textContent = currentDetailStore.name || '名称未設定';
    const statusEl = document.getElementById('detail-status');
    const statusLabels = {
      active: '稼働中',
      suspended: '休止中',
      terminated: '契約終了',
      pending_customer_info: '情報入力待ち',
      pending_approval: '承認待ち'
    };
    statusEl.textContent = statusLabels[currentDetailStore.status] || currentDetailStore.status || '不明';
    statusEl.className = 'detail-status ' + (currentDetailStore.status || 'pending');

    // 基本情報グリッド
    // EntityFinderを使用してID形式の違いに対応
    let client = null;
    // まずstore.client_idから直接取得を試みる
    if (currentDetailStore.client_id) {
      if (window.DataUtils?.EntityFinder?.findClient) {
        client = window.DataUtils.EntityFinder.findClient(allClients, currentDetailStore.client_id);
      } else {
        client = allClients.find(c => c.id === currentDetailStore.client_id || String(c.id) === String(currentDetailStore.client_id));
      }
    }
    // store.client_idで取得できなかった場合、brand.client_idから取得
    let brand = null;
    if (window.DataUtils?.EntityFinder?.findBrand) {
      brand = window.DataUtils.EntityFinder.findBrand(allBrands, currentDetailStore.brand_id);
    } else {
      brand = allBrands.find(b => b.id === currentDetailStore.brand_id || String(b.id) === String(currentDetailStore.brand_id));
    }
    if (!client && brand && brand.client_id) {
      if (window.DataUtils?.EntityFinder?.findClient) {
        client = window.DataUtils.EntityFinder.findClient(allClients, brand.client_id);
      } else {
        client = allClients.find(c => c.id === brand.client_id || String(c.id) === String(brand.client_id));
      }
    }
    
    document.getElementById('detail-info-grid').innerHTML = `
      <div class="info-item">
        <div class="info-label">店舗ID</div>
        <div class="info-value">${currentDetailStore.id || '-'}</div>
      </div>
      <div class="info-item">
        <div class="info-label">取引先</div>
        <div class="info-value">${client?.name || '-'}</div>
      </div>
      <div class="info-item">
        <div class="info-label">ブランド</div>
        <div class="info-value">${brand?.name || '-'}</div>
      </div>
      <div class="info-item">
        <div class="info-label">電話番号</div>
        <div class="info-value">${currentDetailStore.phone || '-'}</div>
      </div>
      <div class="info-item full">
        <div class="info-label">住所</div>
        <div class="info-value">${currentDetailStore.postcode ? '〒' + currentDetailStore.postcode + ' ' : ''}${currentDetailStore.pref || ''}${currentDetailStore.city || ''}${currentDetailStore.address1 || ''}</div>
      </div>
      <div class="info-item full">
        <div class="info-label">備考</div>
        <div class="info-value">${currentDetailStore.notes || '-'}</div>
      </div>
    `;

    // タブをリセット
    switchDetailTab('info');
    detailModal.classList.add('active');
  };

  window.switchDetailTab = function(tabName) {
    document.querySelectorAll('.detail-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
    document.querySelectorAll('.detail-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tabName));

    // データを遅延読み込み
    if (tabName === 'estimates') loadStoreEstimates();
    if (tabName === 'schedules') loadStoreSchedules();
    if (tabName === 'reports') loadStoreReports();
  };

  async function loadStoreEstimates() {
    if (!currentDetailStore) return;
    const container = document.getElementById('detail-estimates-list');
    const loading = document.getElementById('estimates-loading');
    loading.style.display = 'block';
    container.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/estimates`);
      if (!res.ok) throw new Error('Failed');
      const estimates = await res.json();
      // IdUtils.isSameを使用してID形式の違いに対応
      let storeEstimates = [];
      if (window.DataUtils?.IdUtils?.isSame) {
        storeEstimates = estimates.filter(e => window.DataUtils.IdUtils.isSame(e.store_id, currentDetailStore.id));
      } else {
        storeEstimates = estimates.filter(e => e.store_id === currentDetailStore.id || String(e.store_id) === String(currentDetailStore.id));
      }
      loading.style.display = 'none';

      if (storeEstimates.length === 0) {
        container.innerHTML = '<div class="empty-panel"><i class="fas fa-file-invoice-dollar"></i>見積もり履歴がありません</div>';
        return;
      }

      const statusLabels = { pending: '未処理', processing: '作成中', completed: '完了', rejected: '却下' };
      container.innerHTML = storeEstimates.map(e => {
        const date = new Date(e.created_at);
        const items = e.items || [];
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-id">${e.id}</span>
              <span class="history-status ${e.status}">${statusLabels[e.status] || e.status}</span>
            </div>
            <div class="history-date">${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
            <div class="history-amount">¥${(e.total || 0).toLocaleString()}</div>
            <div class="history-items">${items.map(i => i.name + (i.multiplier > 1 ? ` (${i.multiplier}倍)` : '')).join(', ') || '-'}</div>
          </div>
        `;
      }).join('');
    } catch (err) {
      loading.style.display = 'none';
      container.innerHTML = '<div class="empty-panel"><i class="fas fa-exclamation-circle"></i>読み込みに失敗しました</div>';
    }
  }

  async function loadStoreSchedules() {
    if (!currentDetailStore) return;
    const container = document.getElementById('detail-schedules-list');
    const loading = document.getElementById('schedules-loading');
    loading.style.display = 'block';
    container.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/schedules`);
      if (!res.ok) throw new Error('Failed');
      const schedulesData = await res.json();
      // APIレスポンスが配列かオブジェクトかをチェック
      const schedules = Array.isArray(schedulesData) ? schedulesData : (schedulesData.items || schedulesData.schedules || []);
      // DataUtilsで新旧両方のID形式に対応
      const storeSchedules = DataUtils.filterByStoreId(schedules, currentDetailStore.id);
      loading.style.display = 'none';

      if (storeSchedules.length === 0) {
        container.innerHTML = '<div class="empty-panel"><i class="fas fa-calendar"></i>スケジュール履歴がありません</div>';
        return;
      }

      container.innerHTML = storeSchedules.slice(0, 20).map(s => {
        const normalized = DataUtils.normalizeSchedule(s);
        return `
        <div class="history-item">
          <div class="history-header">
              <span class="history-id">${DataUtils.formatDate(normalized.date)} ${normalized.time || ''}</span>
              <span class="history-status ${normalized.status}">${DataUtils.getStatusLabel(normalized.status)}</span>
          </div>
            <div class="history-body">${DataUtils.escapeHtml(normalized.work_content) || '作業内容未設定'}</div>
        </div>
        `;
      }).join('');
    } catch (err) {
      loading.style.display = 'none';
      container.innerHTML = '<div class="empty-panel"><i class="fas fa-exclamation-circle"></i>読み込みに失敗しました</div>';
    }
  }

  async function loadStoreReports() {
    if (!currentDetailStore) return;
    const container = document.getElementById('detail-reports-list');
    const loading = document.getElementById('reports-loading');
    loading.style.display = 'block';
    container.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/reports`);
      if (!res.ok) throw new Error('Failed');
      const reports = await res.json();
      // IdUtils.isSameを使用してID形式の違いに対応
      let storeReports = [];
      if (window.DataUtils?.IdUtils?.isSame) {
        storeReports = reports.filter(r => window.DataUtils.IdUtils.isSame(r.store_id, currentDetailStore.id));
      } else {
        storeReports = reports.filter(r => r.store_id === currentDetailStore.id || String(r.store_id) === String(currentDetailStore.id));
      }
      loading.style.display = 'none';

      if (storeReports.length === 0) {
        container.innerHTML = '<div class="empty-panel"><i class="fas fa-file-alt"></i>レポート履歴がありません</div>';
        return;
      }

      container.innerHTML = storeReports.slice(0, 20).map(r => {
        const date = new Date(r.created_at || r.work_date);
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-id">${date.toLocaleDateString('ja-JP')}</span>
              <span class="history-status completed">完了</span>
            </div>
            <div class="history-body">${r.content || r.work_content || '内容未設定'}</div>
          </div>
        `;
      }).join('');
    } catch (err) {
      loading.style.display = 'none';
      container.innerHTML = '<div class="empty-panel"><i class="fas fa-exclamation-circle"></i>読み込みに失敗しました</div>';
    }
  }

  window.closeDetailModal = function() {
    detailModal.classList.remove('active');
    currentDetailStore = null;
  };

  window.editFromDetail = function() {
    if (currentDetailStore) {
      closeDetailModal();
      editStore(currentDetailStore.id);
    }
  };

  // 詳細モーダル閉じる
  detailModal.addEventListener('click', (e) => {
    if (e.target === detailModal) closeDetailModal();
  });

  // 削除実行
  const confirmDeleteBtn = document.getElementById('confirm-delete');
  if (confirmDeleteBtn) {
    confirmDeleteBtn.addEventListener('click', async () => {
      if (!deleteTargetId) {
        console.warn('Delete target ID is not set');
        return;
      }
      
      try {
        const authHeaders = (await getAuthHeaders()) || { 'Content-Type': 'application/json' };
        const response = await fetch(`${API_BASE}/stores/${deleteTargetId}`, {
          method: 'DELETE',
          headers: authHeaders
        });
        
        if (response.ok || response.status === 204) {
          // IdUtils.isSameを使用してID形式の違いに対応
          if (window.DataUtils?.IdUtils?.isSame) {
            allStores = allStores.filter(s => !window.DataUtils.IdUtils.isSame(s.id, deleteTargetId));
          } else {
            allStores = allStores.filter(s => s.id !== deleteTargetId && String(s.id) !== String(deleteTargetId));
          }
          updateStats();
          filterAndRender();
          if (deleteModal) {
            deleteModal.classList.remove('active');
          }
          deleteTargetId = null;
        } else {
          const errorText = await response.text().catch(() => '');
          console.error('Delete failed:', response.status, errorText);
          alert(`削除に失敗しました (${response.status})`);
        }
      } catch (error) {
        console.error('Delete failed:', error);
        alert('削除に失敗しました: ' + error.message);
      }
    });
  } else {
    console.error('Confirm delete button not found');
  }

  // フォーム送信
  storeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('store-id').value;
    const isNew = !id;
    
    const sendInvite = document.getElementById('send-invite').checked;
    const email = document.getElementById('store-email').value;
    
    // 招待送信時はメール必須
    if (isNew && sendInvite && !email) {
      alert('招待リンクを送信するにはメールアドレスが必要です');
      document.getElementById('store-email').focus();
      return;
    }
    
    // 3層構造の取得
    let clientId = document.getElementById('store-client').value;
    let brandId = document.getElementById('store-brand').value;
    const newClientName = document.getElementById('store-client-new').value.trim();
    const newBrandName = document.getElementById('store-brand-new').value.trim();
    
    try {
      formStatus.textContent = '保存中...';
      formStatus.className = 'form-status';

      const authHeaders = await getAuthHeaders();
      if (!authHeaders) {
        formStatus.textContent = '保存に失敗しました（ログイン情報が見つかりません）';
        formStatus.className = 'form-status error';
        alert('認証情報が見つかりません。再ログインしてから保存してください。');
        return;
      }
      
      // 新規法人の作成（IDはバックエンドで生成）
      if (!clientId && newClientName) {
        const newClient = {
          // IDはバックエンドで生成されるため、ここでは指定しない
          name: newClientName,
          type: 'corporate',
          created_at: new Date().toISOString()
        };
        const clientRes = await fetch(`${API_BASE}/clients`, {
          method: 'POST',
          headers: authHeaders,
          body: JSON.stringify(newClient)
        });
        if (!clientRes.ok) {
          const errorData = await clientRes.json().catch(() => ({}));
          throw new Error(errorData.error || '法人の作成に失敗しました');
        }
        const createdClientRes = await clientRes.json();
        const createdClient = createdClientRes.client || createdClientRes;
        allClients.push(createdClient);
        clientId = createdClientRes.id || createdClient.id;
      }
      
      // 新規ブランドの作成（IDはバックエンドで生成）
      if (!brandId && newBrandName) {
        if (!clientId) {
          throw new Error('ブランドを作成するには法人を選択または作成してください');
        }
        const newBrand = {
          // IDはバックエンドで生成されるため、ここでは指定しない
          name: newBrandName,
          client_id: clientId,
          created_at: new Date().toISOString()
        };
        const brandRes = await fetch(`${API_BASE}/brands`, {
          method: 'POST',
          headers: authHeaders,
          body: JSON.stringify(newBrand)
        });
        if (!brandRes.ok) {
          const errorData = await brandRes.json().catch(() => ({}));
          throw new Error(errorData.error || 'ブランドの作成に失敗しました');
        }
        const createdBrandRes = await brandRes.json();
        const createdBrand = createdBrandRes.brand || createdBrandRes;
        allBrands.push(createdBrand);
        brandId = createdBrandRes.id || createdBrand.id;
      }
      
      // 店舗データ
    const data = {
      contact_person: document.getElementById('store-contact').value,
      name: document.getElementById('store-name').value,
      postcode: document.getElementById('store-postcode').value,
      pref: document.getElementById('store-pref').value,
      city: document.getElementById('store-city').value,
      address1: document.getElementById('store-address1').value,
      address2: document.getElementById('store-address2').value,
      phone: document.getElementById('store-phone').value,
      email: email,
        description: document.getElementById('store-description').value,
        status: document.getElementById('store-status').value,
        client_id: clientId || null,
        brand_id: brandId || null
    };
    
    if (isNew) {
        // IDはバックエンドで生成されるため、ここでは指定しない
        // data.id = 'ST' + Date.now(); // 削除: バックエンドで生成
        data.created_at = new Date().toISOString();
        if (sendInvite) data.status = 'pending_customer_info';
    } else {
      data.id = id;
    }
      data.updated_at = new Date().toISOString();
      
      const response = await fetch(`${API_BASE}/stores${isNew ? '' : '/' + id}`, {
        method: isNew ? 'POST' : 'PUT',
        headers: authHeaders,
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        const storeRes = await response.json().catch(() => ({}));
        const savedStore = storeRes.store || storeRes;
        // リスト更新
        if (isNew) {
          allStores.unshift(savedStore);
          
          // 招待リンク送信
          if (sendInvite) {
            const storeIdForInvite = savedStore.id || data.id;
            const inviteLink = `${window.location.origin}/registration/customer-complete.html?token=${storeIdForInvite}`;
            formStatus.innerHTML = `
              <div class="invite-success">
                <div class="invite-success-header">
                  <i class="fas fa-check-circle"></i> 保存しました
                </div>
                <div class="invite-success-body">
                  <p>招待リンク:</p>
                  <input type="text" value="${inviteLink}" readonly class="invite-link-input" onclick="this.select()">
                  <small>このリンクをお客様にお送りください</small>
                </div>
                <button type="button" class="btn btn-primary" onclick="closeStoreDialog()" style="margin-top:12px;width:100%;">
                  閉じる
                </button>
              </div>
            `;
            formStatus.className = 'form-status success';
          } else {
            formStatus.textContent = '保存しました';
            formStatus.className = 'form-status success';
            setTimeout(() => closeStoreDialog(), 800);
          }
        } else {
          // IdUtils.isSameを使用してID形式の違いに対応
          let idx = -1;
          if (window.DataUtils?.IdUtils?.isSame) {
            idx = allStores.findIndex(s => window.DataUtils.IdUtils.isSame(s.id, id));
          } else {
            idx = allStores.findIndex(s => s.id === id || String(s.id) === String(id));
          }
          if (idx >= 0) allStores[idx] = { ...allStores[idx], ...savedStore };
          formStatus.textContent = '保存しました';
          formStatus.className = 'form-status success';
          setTimeout(() => closeStoreDialog(), 800);
        }
        filterAndRender();
      } else {
        throw new Error('Save failed');
      }
    } catch (error) {
      console.error('Save failed:', error);
      formStatus.textContent = '保存に失敗しました';
      formStatus.className = 'form-status error';
    }
  });

  // モーダル閉じる（削除確認用）
  // モーダル閉じる（削除確認用）
  const cancelDeleteBtn = document.getElementById('cancel-delete');
  if (cancelDeleteBtn && deleteModal) {
    cancelDeleteBtn.addEventListener('click', () => {
      deleteModal.classList.remove('active');
      deleteTargetId = null;
    });
  }
  if (deleteModal) {
    deleteModal.addEventListener('click', (e) => {
      if (e.target === deleteModal) {
        deleteModal.classList.remove('active');
        deleteTargetId = null;
      }
    });
  }

  // 検索・フィルター（統合検索を使用するため削除）
  // searchInput.addEventListener('input', debounce(filterAndRender, 300));
  // clientFilter.addEventListener('change', () => {
  //   updateBrandFilter();
  //   filterAndRender();
  // });
  // brandFilter.addEventListener('change', filterAndRender);
  // prefFilter.addEventListener('change', filterAndRender);
  // statusFilter.addEventListener('change', filterAndRender);
  // ソート機能のみ残す
  if (sortFilter) {
    sortFilter.addEventListener('change', filterAndRender);
  }

  // ユーティリティ
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return '-';
    return dateStr.split(' ')[0];
  }
  
  // ステータスバッジ
  const statusLabels = {
    'pending_customer_info': { label: '情報入力待ち', color: '#f59e0b' },
    'pending_approval': { label: '承認待ち', color: '#3b82f6' },
    'active': { label: '稼働中', color: '#10b981' },
    'suspended': { label: '休止中', color: '#6b7280' },
    'terminated': { label: '契約終了', color: '#ef4444' },
    // CSVからのステータス
    'contract_pending': { label: '契約作業中', color: '#f59e0b' },
    'considering': { label: '検討中', color: '#8b5cf6' },
    'prospect': { label: 'アプローチ前', color: '#6b7280' },
    'negotiated': { label: '商談済', color: '#3b82f6' },
    'lost': { label: '失注', color: '#ef4444' },
    'unknown': { label: '未設定', color: '#9ca3af' }
  };
  
  function getStatusBadge(status) {
    const info = statusLabels[status] || { label: status || '未設定', color: '#9ca3af' };
    return `<span class="status-badge" style="background: ${info.color}20; color: ${info.color}; border: 1px solid ${info.color}40;">${info.label}</span>`;
  }
  
  // 登録元バッジ
  function getSourceBadge(type) {
    const sources = {
      'sales_lead': { label: '営業', color: '#8b5cf6', icon: 'fa-user-tie' },
      'admin': { label: '管理者', color: '#3b82f6', icon: 'fa-user-shield' },
      'customer': { label: 'お客様', color: '#10b981', icon: 'fa-user' },
      'migration': { label: '移行', color: '#6b7280', icon: 'fa-database' }
    };
    // 未設定の場合は「移行」として扱う（既存データの移行）
    const info = sources[type] || sources['migration'];
    return `<span class="source-badge" style="color: ${info.color};"><i class="fas ${info.icon}"></i> ${info.label}</span>`;
  }
  
  // 商談バッジ
  function getLeadBadge(leadStatus, probability) {
    if (!leadStatus) return '-';
    const leads = {
      'initial': { label: '初回', color: '#6b7280' },
      'negotiating': { label: '商談中', color: '#f59e0b' },
      'proposal': { label: '提案済', color: '#3b82f6' },
      'pending': { label: '検討中', color: '#8b5cf6' }
    };
    const probs = { 'high': '◎', 'medium': '○', 'low': '△' };
    const info = leads[leadStatus] || { label: leadStatus, color: '#9ca3af' };
    const probIcon = probs[probability] || '';
    return `<span class="lead-badge" style="color: ${info.color};">${info.label}${probIcon ? ' ' + probIcon : ''}</span>`;
  }
  
  function debounce(fn, delay) {
    let timer;
    return function(...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  // URLパラメータで編集モードを確認
  function checkEditMode() {
    const urlParams = new URLSearchParams(window.location.search);
    const editStoreId = urlParams.get('edit_store');
    if (editStoreId) {
      // データ読み込み後に編集モーダルを開く
      setTimeout(() => {
        editStore(editStoreId);
        // URLからパラメータを削除
        window.history.replaceState({}, '', '/admin/customers/');
      }, 500);
    }
  }

  // グローバル変数をv3と共有
  window.allStoresGlobal = allStores;
  window.allClientsGlobal = allClients;
  window.allBrandsGlobal = allBrands;
  window.filteredStoresGlobal = filteredStores;

  // データ更新時にv3も更新
  const originalFilterAndRender = filterAndRender;
  filterAndRender = function() {
    originalFilterAndRender();
    window.allStoresGlobal = allStores;
    window.allClientsGlobal = allClients;
    window.allBrandsGlobal = allBrands;
    window.filteredStoresGlobal = filteredStores;
    if (window.CustomerManagementV3) {
      window.CustomerManagementV3.allStores = allStores;
      window.CustomerManagementV3.allClients = allClients;
      window.CustomerManagementV3.allBrands = allBrands;
      window.CustomerManagementV3.filteredData = filteredStores;
      window.CustomerManagementV3.renderCurrentView();
    }
  };

  // 一括操作用のグローバル変数
  window.selectedItems = new Set();

  // 初期化
  loadStores().then(() => {
    checkEditMode();
    // v3機能の初期化（データ読み込み後）
    setTimeout(() => {
      window.allStoresGlobal = allStores;
      window.allClientsGlobal = allClients;
      window.allBrandsGlobal = allBrands;
      window.filteredStoresGlobal = filteredStores;
      if (window.CustomerManagementV3) {
        window.CustomerManagementV3.allStores = allStores;
        window.CustomerManagementV3.allClients = allClients;
        window.CustomerManagementV3.allBrands = allBrands;
        window.CustomerManagementV3.loadData();
        window.CustomerManagementV3.updateUnifiedFilters();
      }
    }, 500);
  });

  // エクスポート機能
  document.getElementById('export-csv-btn')?.addEventListener('click', () => {
    exportToCSV();
  });

  document.getElementById('export-excel-btn')?.addEventListener('click', () => {
    exportToCSV(); // ExcelはCSVとして出力
  });

  function exportToCSV() {
    const headers = ['ID', '法人名', 'ブランド名', '店舗名', 'ステータス', '住所', '電話番号', 'メールアドレス'];
    const rows = filteredStores.map(store => {
      let brand = null;
      let client = null;
      
      if (window.DataUtils?.EntityFinder?.findBrand) {
        brand = window.DataUtils.EntityFinder.findBrand(allBrands, store.brand_id);
      } else {
        brand = allBrands.find(b => b.id === store.brand_id || String(b.id) === String(store.brand_id));
      }
      
      if (brand && window.DataUtils?.EntityFinder?.findClient) {
        client = window.DataUtils.EntityFinder.findClient(allClients, brand.client_id);
      } else if (brand) {
        client = allClients.find(c => c.id === brand.client_id || String(c.id) === String(brand.client_id));
      }

      return [
        store.id || '',
        client ? (client.name || client.company_name || '') : '',
        brand ? (brand.name || '') : '',
        store.name || '',
        store.status || '',
        `${store.pref || ''}${store.city || ''}${store.address1 || ''}`,
        store.phone || '',
        store.email || ''
      ];
    });

    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `customers_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  }

  // 一括操作
  window.batchChangeStatus = function() {
    if (window.selectedItems.size === 0) {
      alert('選択された項目がありません');
      return;
    }
    const newStatus = prompt('新しいステータスを選択してください:\n1. active (稼働中)\n2. suspended (休止中)\n3. terminated (契約終了)');
    if (newStatus && ['active', 'suspended', 'terminated'].includes(newStatus)) {
      alert(`${window.selectedItems.size}件のステータスを${newStatus}に変更します（実装予定）`);
    }
  };

  window.batchExport = function() {
    if (window.selectedItems.size === 0) {
      alert('選択された項目がありません');
      return;
    }
    const selectedStores = filteredStores.filter(s => window.selectedItems.has(s.id));
    const originalFiltered = filteredStores;
    filteredStores = selectedStores;
    exportToCSV();
    filteredStores = originalFiltered;
  };

  window.clearSelection = function() {
    window.selectedItems.clear();
    
    // すべてのチェックボックスを解除
    document.querySelectorAll('.store-checkbox').forEach(cb => {
      cb.checked = false;
      const storeId = cb.dataset.id;
      
      // テーブル行のハイライト解除
      const row = document.querySelector(`tr[data-id="${storeId}"]`);
      if (row) {
        row.classList.remove('row-selected');
      }
      
      // カードのハイライト解除
      const card = document.querySelector(`.customer-card[data-id="${storeId}"]`);
      if (card) {
        card.classList.remove('selected');
      }
    });
    
    updateBatchOperationsBar();
    updateSelectAllCheckbox();
    renderTable();
    if (window.CustomerManagementV3) {
      window.CustomerManagementV3.renderCurrentView();
    }
  };

  function updateBatchOperationsBar() {
    const bar = document.getElementById('batch-operations-bar');
    const count = document.getElementById('batch-selected-count');
    if (bar && count) {
      if (window.selectedItems.size > 0) {
        bar.classList.add('active');
        count.textContent = `${window.selectedItems.size}件選択`;
      } else {
        bar.classList.remove('active');
      }
    }
  }

  window.toggleStoreSelection = function(storeId) {
    const checkbox = document.querySelector(`.store-checkbox[data-id="${storeId}"]`);
    if (checkbox) {
      if (checkbox.checked) {
        window.selectedItems.add(storeId);
      } else {
        window.selectedItems.delete(storeId);
      }
      updateBatchOperationsBar();
      updateSelectAllCheckbox();
      
      // 行のハイライト（テーブルビュー）
      const row = document.querySelector(`tr[data-id="${storeId}"]`);
      if (row) {
        if (checkbox.checked) {
          row.classList.add('row-selected');
        } else {
          row.classList.remove('row-selected');
        }
      }
      
      // カードのハイライト（カードビュー）
      const card = document.querySelector(`.customer-card[data-id="${storeId}"]`);
      if (card) {
        if (checkbox.checked) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      }
    }
  };

  window.toggleSelectAll = function(checkbox) {
    const storeCheckboxes = document.querySelectorAll('.store-checkbox:not(#select-all-stores)');
    storeCheckboxes.forEach(cb => {
      cb.checked = checkbox.checked;
      const storeId = cb.dataset.id;
      if (checkbox.checked) {
        window.selectedItems.add(storeId);
      } else {
        window.selectedItems.delete(storeId);
      }
      
      // 行のハイライト（テーブルビュー）
      const row = document.querySelector(`tr[data-id="${storeId}"]`);
      if (row) {
        if (checkbox.checked) {
          row.classList.add('row-selected');
        } else {
          row.classList.remove('row-selected');
        }
      }
      
      // カードのハイライト（カードビュー）
      const card = document.querySelector(`.customer-card[data-id="${storeId}"]`);
      if (card) {
        if (checkbox.checked) {
          card.classList.add('selected');
        } else {
          card.classList.remove('selected');
        }
      }
    });
    updateBatchOperationsBar();
  };

  function updateSelectAllCheckbox() {
    const selectAll = document.getElementById('select-all-stores');
    if (selectAll) {
      const allCheckboxes = document.querySelectorAll('.store-checkbox:not(#select-all-stores)');
      const checkedCount = Array.from(allCheckboxes).filter(cb => cb.checked).length;
      selectAll.checked = checkedCount === allCheckboxes.length && allCheckboxes.length > 0;
      selectAll.indeterminate = checkedCount > 0 && checkedCount < allCheckboxes.length;
    }
  }

  // ページ読み込み時に選択状態を復元
  function restoreSelectionState() {
    if (window.selectedItems && window.selectedItems.size > 0) {
      window.selectedItems.forEach(storeId => {
        const checkbox = document.querySelector(`.store-checkbox[data-id="${storeId}"]`);
        if (checkbox) {
          checkbox.checked = true;
          toggleStoreSelection(storeId);
        }
      });
      updateBatchOperationsBar();
      updateSelectAllCheckbox();
    }
  }

  // データ読み込み後に選択状態を復元
  const originalLoadStores = loadStores;
  loadStores = async function() {
    await originalLoadStores();
    setTimeout(restoreSelectionState, 100);
  };

  // エクスポート機能
  document.getElementById('export-csv-btn')?.addEventListener('click', () => {
    exportToCSV();
  });

  document.getElementById('export-excel-btn')?.addEventListener('click', () => {
    exportToExcel();
  });

  function exportToCSV() {
    const headers = ['ID', '法人名', 'ブランド名', '店舗名', 'ステータス', '住所', '電話番号', 'メールアドレス'];
    const rows = filteredStores.map(store => {
      let brand = null;
      let client = null;
      
      if (window.DataUtils?.EntityFinder?.findBrand) {
        brand = window.DataUtils.EntityFinder.findBrand(allBrands, store.brand_id);
      } else {
        brand = allBrands.find(b => b.id === store.brand_id || String(b.id) === String(store.brand_id));
      }
      
      if (brand && window.DataUtils?.EntityFinder?.findClient) {
        client = window.DataUtils.EntityFinder.findClient(allClients, brand.client_id);
      } else if (brand) {
        client = allClients.find(c => c.id === brand.client_id || String(c.id) === String(brand.client_id));
      }

      return [
        store.id || '',
        client ? (client.name || client.company_name || '') : '',
        brand ? (brand.name || '') : '',
        store.name || '',
        store.status || '',
        `${store.pref || ''}${store.city || ''}${store.address1 || ''}`,
        store.phone || '',
        store.email || ''
      ];
    });

    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
    ].join('\n');

    const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `customers_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  }

  function exportToExcel() {
    // Excel形式はCSVとして出力（実際のExcelライブラリが必要な場合は後で追加）
    exportToCSV();
  }

  // 一括操作
  window.batchChangeStatus = function() {
    if (selectedItems.size === 0) {
      alert('選択された項目がありません');
      return;
    }
    // ステータス変更モーダルを表示（簡易実装）
    const newStatus = prompt('新しいステータスを選択してください:\n1. active (稼働中)\n2. suspended (休止中)\n3. terminated (契約終了)');
    if (newStatus && ['active', 'suspended', 'terminated'].includes(newStatus)) {
      // 実際のAPI呼び出しは後で実装
      alert(`${selectedItems.size}件のステータスを${newStatus}に変更します（実装予定）`);
    }
  };

  window.batchExport = function() {
    if (selectedItems.size === 0) {
      alert('選択された項目がありません');
      return;
    }
    // 選択された項目のみをエクスポート
    const selectedStores = filteredStores.filter(s => selectedItems.has(s.id));
    const originalFiltered = filteredStores;
    filteredStores = selectedStores;
    exportToCSV();
    filteredStores = originalFiltered;
  };


  
})();
    </script>

    </main>
