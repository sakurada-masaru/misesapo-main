@layout('layouts.base')
@json('data/meta/admin_stores_title.json', $title)
@json('data/meta/admin_stores_body_class.json', $body_class)

<script src="/js/data_utils.js"></script>

<main id="main" class="admin-stores-v2">
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <span class="logo-icon">ğŸ§¹</span>
        <span class="logo-text">ãƒŸã‚»ã‚µãƒ</span>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <a href="/admin/dashboard.html" class="nav-item">
        <i class="fas fa-home"></i>
        <span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
      </a>
      <a href="/admin/schedules/" class="nav-item">
        <i class="fas fa-calendar-alt"></i>
        <span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
      </a>
      <a href="/admin/customers/" class="nav-item active">
        <i class="fas fa-store"></i>
        <span>é¡§å®¢ç®¡ç†</span>
      </a>
      <a href="/admin/reports/" class="nav-item">
        <i class="fas fa-file-alt"></i>
        <span>ãƒ¬ãƒãƒ¼ãƒˆ</span>
      </a>
      <a href="/admin/estimates/" class="nav-item">
        <i class="fas fa-file-invoice-dollar"></i>
        <span>è¦‹ç©ã‚‚ã‚Š</span>
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i class="fas fa-shopping-cart"></i>
        <span>ç™ºæ³¨ç®¡ç†</span>
      </a>
      <a href="/admin/partners.html" class="nav-item">
        <i class="fas fa-handshake"></i>
        <span>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¼æ¥­</span>
      </a>
      <a href="/admin/users/" class="nav-item">
        <i class="fas fa-users"></i>
        <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
      </a>
      <a href="/admin/analytics/" class="nav-item">
        <i class="fas fa-chart-bar"></i>
        <span>åˆ†æ</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <a href="/admin/cleaning-manual.html" class="nav-item">
        <i class="fas fa-book"></i>
        <span>ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</span>
      </a>
      <a href="/admin/images/" class="nav-item">
        <i class="fas fa-images"></i>
        <span>ç”»åƒç®¡ç†</span>
      </a>
      <a href="/admin/services/" class="nav-item">
        <i class="fas fa-cog"></i>
        <span>è¨­å®š</span>
      </a>
    </div>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <div class="container">
      <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
      <header class="topbar">
        <div class="topbar-left">
          <h1>é¡§å®¢ç®¡ç†</h1>
          <span class="store-count" id="store-count">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
        <div class="topbar-right">
          <button type="button" class="btn btn-primary" id="add-store-btn" onclick="document.getElementById('store-dialog').showModal()">
            <i class="fas fa-plus"></i>
            æ–°è¦è¿½åŠ 
          </button>
        </div>
      </header>

    <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="search-section">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="search-input" placeholder="åº—èˆ—åã€ä½æ‰€ã€é›»è©±ç•ªå·ã§æ¤œç´¢...">
      </div>
      <div class="filter-group">
        <select id="client-filter">
          <option value="">å…¨å–å¼•å…ˆ</option>
        </select>
        <select id="brand-filter">
          <option value="">å…¨ãƒ–ãƒ©ãƒ³ãƒ‰</option>
        </select>
        <select id="pref-filter">
          <option value="">å…¨éƒ½é“åºœçœŒ</option>
        </select>
        <select id="status-filter">
          <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
          <option value="active">ç¨¼åƒä¸­</option>
          <option value="contract_pending">å¥‘ç´„ä½œæ¥­ä¸­</option>
          <option value="considering">æ¤œè¨ä¸­</option>
          <option value="prospect">ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå‰</option>
          <option value="negotiated">å•†è«‡æ¸ˆ</option>
          <option value="lost">å¤±æ³¨</option>
          <option value="suspended">ä¼‘æ­¢ä¸­</option>
          <option value="terminated">å¥‘ç´„çµ‚äº†</option>
        </select>
        <select id="sort-filter">
          <option value="name-asc">åº—èˆ—å æ˜‡é †</option>
          <option value="name-desc">åº—èˆ—å é™é †</option>
          <option value="created-desc">ç™»éŒ²æ—¥ æ–°ã—ã„é †</option>
          <option value="created-asc">ç™»éŒ²æ—¥ å¤ã„é †</option>
          <option value="id-asc">ID æ˜‡é †</option>
          <option value="id-desc">ID é™é †</option>
        </select>
      </div>
      <button type="button" class="btn btn-secondary btn-sm" id="reset-filters">
        <i class="fas fa-undo"></i> ãƒªã‚»ãƒƒãƒˆ
      </button>
    </div>
    
    <!-- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º -->
    <div class="active-filters" id="active-filters"></div>

    <!-- åº—èˆ—ä¸€è¦§ -->
    <div class="stores-table-wrapper">
      <table class="stores-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>ãƒ–ãƒ©ãƒ³ãƒ‰å</th>
            <th>åº—èˆ—å</th>
            <th>æ³•äººå</th>
            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
            <th>ä½æ‰€</th>
            <th>é›»è©±ç•ªå·</th>
          </tr>
        </thead>
        <tbody id="stores-tbody">
          <tr>
            <td colspan="8" class="loading-cell">
              <i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="pagination" id="pagination"></div>
    </div>
  </div>
</main>

<!-- æ–°è¦è¿½åŠ /ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="store-dialog" class="store-dialog">
  <div class="dialog-content">
    <button type="button" class="dialog-close" onclick="closeStoreDialog()" aria-label="é–‰ã˜ã‚‹">
      <i class="fas fa-times"></i>
    </button>
    <h3 id="modal-title">æ–°è¦é¡§å®¢ç™»éŒ²</h3>
    <form id="store-form" method="dialog">
      <input type="hidden" id="store-id" name="id">
      
      <!-- æ³•äººæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="hierarchy-section">
        <div class="hierarchy-header">
          <i class="fas fa-building"></i> æ³•äººå
        </div>
      <div class="form-row">
          <div class="form-field">
            <label for="store-client">æ—¢å­˜æ³•äººã‹ã‚‰é¸æŠ</label>
            <select id="store-client" name="client_id">
              <option value="">-- æ–°è¦æ³•äººã¾ãŸã¯é¸æŠ --</option>
            </select>
        </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-client-new">æ–°è¦æ³•äººç™»éŒ²</label>
            <input type="text" id="store-client-new" name="client_name_new" placeholder="æ ªå¼ä¼šç¤¾â—‹â—‹">
          </div>
        </div>
      </div>
      
      <!-- ãƒ–ãƒ©ãƒ³ãƒ‰æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="hierarchy-section">
        <div class="hierarchy-header">
          <i class="fas fa-tag"></i> ãƒ–ãƒ©ãƒ³ãƒ‰å
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-brand">æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒ‰ã‹ã‚‰é¸æŠ</label>
            <select id="store-brand" name="brand_id">
              <option value="">-- æ–°è¦ãƒ–ãƒ©ãƒ³ãƒ‰ã¾ãŸã¯é¸æŠ --</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-brand-new">æ–°è¦ãƒ–ãƒ©ãƒ³ãƒ‰ç™»éŒ²</label>
            <input type="text" id="store-brand-new" name="brand_name_new" placeholder="æ™©æ¯å±‹">
          </div>
        </div>
      </div>
      
      <!-- åº—èˆ—æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="store-section">
        <div class="hierarchy-header">
          <i class="fas fa-store"></i> æ–°è¦åº—èˆ—ç™»éŒ²
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-name">åº—èˆ—å <span class="required">*</span></label>
            <input type="text" id="store-name" name="name" required placeholder="é–€å‰ä»²ç”ºåº—">
          </div>
        </div>
        <div class="form-row">
        <div class="form-field half">
          <label for="store-contact">æ‹…å½“è€…å</label>
          <input type="text" id="store-contact" name="contact_person" placeholder="å±±ç”°å¤ªéƒ">
        </div>
          <div class="form-field half">
            <label for="store-phone">é›»è©±ç•ªå·</label>
            <input type="tel" id="store-phone" name="phone" placeholder="03-1234-5678">
          </div>
      </div>
      <div class="form-row">
        <div class="form-field">
            <label for="store-email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ <span class="required" id="email-required" style="display:none">*</span></label>
            <input type="email" id="store-email" name="email" placeholder="info@example.com">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field half">
          <label for="store-postcode">éƒµä¾¿ç•ªå·</label>
          <input type="text" id="store-postcode" name="postcode" placeholder="1234567">
        </div>
        <div class="form-field half">
          <label for="store-pref">éƒ½é“åºœçœŒ</label>
          <input type="text" id="store-pref" name="pref" placeholder="æ±äº¬éƒ½">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field half">
          <label for="store-city">å¸‚åŒºç”ºæ‘</label>
          <input type="text" id="store-city" name="city" placeholder="æ–°å®¿åŒº">
        </div>
        <div class="form-field half">
            <label for="store-address1">ä½æ‰€</label>
          <input type="text" id="store-address1" name="address1" placeholder="1-2-3">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
            <label for="store-address2">å»ºç‰©åç­‰</label>
          <input type="text" id="store-address2" name="address2" placeholder="â—‹â—‹ãƒ“ãƒ«3F">
        </div>
      </div>
      <div class="form-row">
          <div class="form-field">
            <label for="store-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select id="store-status" name="status">
              <option value="active">ç¨¼åƒä¸­</option>
              <option value="contract_pending">å¥‘ç´„ä½œæ¥­ä¸­</option>
              <option value="considering">æ¤œè¨ä¸­</option>
              <option value="prospect">ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå‰</option>
              <option value="negotiated">å•†è«‡æ¸ˆ</option>
              <option value="lost">å¤±æ³¨</option>
              <option value="suspended">ä¼‘æ­¢ä¸­</option>
              <option value="terminated">å¥‘ç´„çµ‚äº†</option>
            </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label for="store-description">å‚™è€ƒ</label>
            <textarea id="store-description" name="description" rows="2"></textarea>
          </div>
        </div>
      </div>
      
      <!-- å–¶æ¥­ãƒ¡ãƒ¢ï¼ˆç·¨é›†æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="sales-notes-section" id="sales-notes-section" style="display:none;">
        <h4><i class="fas fa-user-tie"></i> å–¶æ¥­æƒ…å ±</h4>
        <div class="sales-info-grid">
          <div class="info-item">
            <span class="info-label">å–¶æ¥­æ‹…å½“</span>
            <span class="info-value" id="view-sales-rep">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">å•†è«‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
            <span class="info-value" id="view-lead-status">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">è¦‹è¾¼ã¿åº¦</span>
            <span class="info-value" id="view-probability">-</span>
          </div>
        </div>
        <div class="notes-box">
          <span class="info-label">å–¶æ¥­ãƒ¡ãƒ¢</span>
          <p id="view-notes">-</p>
        </div>
      </div>
      
      <!-- æ‹›å¾…ãƒªãƒ³ã‚¯é€ä¿¡ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆæ–°è¦è¿½åŠ æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
      <div class="invite-option" id="invite-option">
        <label class="checkbox-label">
          <input type="checkbox" id="send-invite" name="send_invite">
          <span>ãŠå®¢æ§˜ã«è©³ç´°æƒ…å ±å…¥åŠ›ã®æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã™ã‚‹</span>
        </label>
        <p class="invite-hint">ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã¨ã€ç™»éŒ²å¾Œã«ãŠå®¢æ§˜ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¸æ‹›å¾…ãƒªãƒ³ã‚¯ãŒé€ä¿¡ã•ã‚Œã¾ã™ã€‚</p>
      </div>
      
      <div class="form-status" id="form-status"></div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('store-dialog').close()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="btn btn-primary" id="submit-btn">ä¿å­˜</button>
      </div>
    </form>
  </div>
</dialog>

  <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="delete-modal-backdrop">
    <div class="modal modal-sm" role="dialog" aria-modal="true">
      <h3>å‰Šé™¤ç¢ºèª</h3>
      <p id="delete-message">ã“ã®é¡§å®¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="cancel-delete">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-danger" id="confirm-delete">å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <!-- é¡§å®¢è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="modal-backdrop" id="detail-modal-backdrop">
    <div class="modal modal-lg" role="dialog" aria-modal="true">
      <button type="button" class="modal-close-btn" onclick="closeDetailModal()">
        <i class="fas fa-times"></i>
      </button>
      <div class="detail-header">
        <h3 id="detail-store-name">åº—èˆ—å</h3>
        <span class="detail-status" id="detail-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</span>
      </div>
      
      <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="detail-tabs">
        <button class="detail-tab active" data-tab="info" onclick="switchDetailTab('info')">
          <i class="fas fa-info-circle"></i> åŸºæœ¬æƒ…å ±
        </button>
        <button class="detail-tab" data-tab="estimates" onclick="switchDetailTab('estimates')">
          <i class="fas fa-file-invoice-dollar"></i> è¦‹ç©ã‚‚ã‚Šå±¥æ­´
        </button>
        <button class="detail-tab" data-tab="schedules" onclick="switchDetailTab('schedules')">
          <i class="fas fa-calendar"></i> ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
        </button>
        <button class="detail-tab" data-tab="reports" onclick="switchDetailTab('reports')">
          <i class="fas fa-file-alt"></i> ãƒ¬ãƒãƒ¼ãƒˆ
        </button>
      </div>
      
      <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div class="detail-content">
        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ– -->
        <div class="detail-panel active" id="panel-info">
          <div class="info-grid" id="detail-info-grid">
            <!-- å‹•çš„ã«æŒ¿å…¥ -->
          </div>
        </div>
        
        <!-- è¦‹ç©ã‚‚ã‚Šå±¥æ­´ã‚¿ãƒ– -->
        <div class="detail-panel" id="panel-estimates">
          <div class="panel-loading" id="estimates-loading">
            <i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...
          </div>
          <div class="estimates-list" id="detail-estimates-list">
            <!-- å‹•çš„ã«æŒ¿å…¥ -->
          </div>
        </div>
        
        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
        <div class="detail-panel" id="panel-schedules">
          <div class="panel-loading" id="schedules-loading">
            <i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...
          </div>
          <div class="schedules-list" id="detail-schedules-list">
            <!-- å‹•çš„ã«æŒ¿å…¥ -->
          </div>
        </div>
        
        <!-- ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ– -->
        <div class="detail-panel" id="panel-reports">
          <div class="panel-loading" id="reports-loading">
            <i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...
          </div>
          <div class="reports-list" id="detail-reports-list">
            <!-- å‹•çš„ã«æŒ¿å…¥ -->
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">é–‰ã˜ã‚‹</button>
        <button type="button" class="btn btn-primary" onclick="editFromDetail()">
          <i class="fas fa-edit"></i> ç·¨é›†
        </button>
      </div>
    </div>
  </div>

  <style>
    :root {
      --sidebar-width: 240px;
      --topbar-height: 64px;
    }

    body.page-admin-stores {
      background: #f9fafb;
    }
    main.admin-stores-v2 {
      display: flex;
      min-height: 100vh;
      background: #f9fafb;
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar {
      width: var(--sidebar-width);
      background: #fff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      z-index: 100;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    }
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-icon {
      font-size: 1.5rem;
    }
    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: #111827;
    }
    .sidebar-nav {
      flex: 1;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: #6b7280;
      text-decoration: none;
      border-radius: 10px;
      transition: all 0.2s;
    }
    .nav-item:hover {
      background: #f3f4f6;
      color: #111827;
    }
    .nav-item.active {
      background: var(--primary);
      color: #fff;
    }
    .nav-item i {
      width: 20px;
      text-align: center;
    }
    .sidebar-footer {
      padding: 16px 12px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 24px;
      background: #f9fafb;
    }
    main.admin-stores-v2 > .main-content > .container {
      width: 100%;
      max-width: 100%;
    }

    /* ãƒˆãƒƒãƒ—ãƒãƒ¼ */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .topbar-left h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    .store-count {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .store-count {
      background: var(--primary);
      color: #fff;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
    }
    .btn-primary:hover {
      background: #d6336c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
    }
    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* æ‹›å¾…ãƒªãƒ³ã‚¯æˆåŠŸè¡¨ç¤º */
    .invite-success {
      text-align: left;
      padding: 16px;
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 12px;
    }
    .invite-success-header {
      font-size: 1.1rem;
      font-weight: 700;
      color: #16a34a;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .invite-success-header i {
      font-size: 1.25rem;
    }
    .invite-success-body {
      margin-bottom: 8px;
    }
    .invite-success-body p {
      font-size: 0.85rem;
      color: #374151;
      margin: 0 0 6px;
    }
    .invite-link-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 0.85rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      margin-bottom: 6px;
    }
    .invite-success-body small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-danger {
      background: #dc2626;
      color: #fff;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.875rem;
    }
    .search-section {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }
    .search-box {
      flex: 1;
      position: relative;
    }
    .search-box i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }
    .search-box input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fff;
    }
    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,103,156,0.2);
    }
    .filter-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .filter-group select {
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fff;
      min-width: 140px;
    }
    .filter-group select:focus {
      outline: none;
      border-color: var(--primary);
    }
    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .filter-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 999px;
      font-size: 0.875rem;
    }
    .filter-tag button {
      background: none;
      border: none;
      color: #1e40af;
      cursor: pointer;
      padding: 0;
      font-size: 0.75rem;
    }
    .filter-tag button:hover {
      color: #dc2626;
    }
    .stores-table-wrapper {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .stores-table {
      width: 100%;
      border-collapse: collapse;
    }
    .stores-table th,
    .stores-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .stores-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
    }
    .stores-table td {
      font-size: 0.95rem;
      color: #111827;
    }
    .stores-table tr:hover {
      background: #f9fafb;
    }
    .loading-cell {
      text-align: center;
      padding: 48px !important;
      color: #6b7280;
    }
    .store-name {
      font-weight: 600;
      color: var(--primary);
    }
    /* ãƒ†ãƒ¼ãƒ–ãƒ«å†…ãƒªãƒ³ã‚¯ */
    .table-link {
      text-decoration: none;
      transition: all 0.2s;
    }
    .table-link:hover {
      text-decoration: underline;
    }
    .table-link.brand-link {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.95rem;
    }
    .table-link.store-link {
      font-weight: 500;
      color: #374151;
      font-size: 0.9rem;
    }
    .table-link.store-link:hover {
      color: var(--primary);
    }
    .table-link.client-link {
      font-size: 0.85rem;
      color: #1e40af;
    }
    .table-link.client-link:hover {
      color: #3b82f6;
    }
    .text-muted {
      color: #9ca3af;
      font-size: 0.85rem;
    }
    .store-address {
      color: #6b7280;
      font-size: 0.875rem;
    }
    .action-btns {
      display: flex;
      gap: 8px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .source-badge {
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .source-badge i {
      margin-right: 4px;
    }
    /* 3å±¤æ§‹é€ è¡¨ç¤º */
    .hierarchy-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .hierarchy-client {
      font-size: 0.8rem;
      font-weight: 600;
      color: #1e40af;
    }
    .hierarchy-client i {
      color: #3b82f6;
      margin-right: 4px;
    }
    .hierarchy-brand {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .hierarchy-brand i {
      color: #9ca3af;
      margin-right: 4px;
    }
    .hierarchy-badge.individual {
      font-size: 0.8rem;
      color: #6b7280;
      background: #f3f4f6;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .lead-badge {
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .store-sub {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }
    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .action-btn i {
      font-size: 0.7rem;
    }
    .action-btn.view {
      background: #f3f4f6;
      color: #374151;
    }
    .action-btn.view:hover {
      background: #374151;
      color: #fff;
    }
    .action-btn.edit {
      background: #dbeafe;
      color: #2563eb;
    }
    .action-btn.edit:hover {
      background: #2563eb;
      color: #fff;
    }
    .action-btn.delete {
      background: #fee2e2;
      color: #dc2626;
    }
    .action-btn.delete:hover {
      background: #dc2626;
      color: #fff;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 24px;
    }
    .page-btn {
      padding: 8px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .page-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .page-btn:hover:not(.active) {
      background: #f3f4f6;
    }
    /* ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆHTML5 dialogè¦ç´ ï¼‰ */
    .store-dialog {
      border: none;
      border-radius: 16px;
      padding: 0;
      max-width: 640px;
      width: 92vw;
      max-height: 90vh;
      overflow: visible;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }
    .store-dialog::backdrop {
      background: rgba(0,0,0,0.5);
    }
    .store-dialog .dialog-content {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .store-dialog h3 {
      font-size: 1.5rem;
      margin-bottom: 24px;
      color: #111827;
    }
    
    /* æ³•äººãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ»åº—èˆ—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .hierarchy-section,
    .store-section {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .hierarchy-header {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    .hierarchy-header i {
      font-size: 1rem;
    }
    .hierarchy-section select,
    .store-section select,
    .hierarchy-section input,
    .store-section input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fff;
      box-sizing: border-box;
    }
    .hierarchy-section select:focus,
    .store-section select:focus,
    .hierarchy-section input:focus,
    .store-section input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }
    .hierarchy-section .form-row,
    .store-section .form-row {
      margin-bottom: 12px;
    }
    .hierarchy-section .form-row:last-child,
    .store-section .form-row:last-child {
      margin-bottom: 0;
    }
    .hierarchy-section label,
    .store-section label {
      display: block;
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 6px;
    }
    
    .dialog-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: #6b7280;
      cursor: pointer;
      z-index: 10;
    }
    .dialog-close:hover {
      color: #111827;
    }
    .sales-notes-section {
      background: #faf5ff;
      border: 1px solid #d8b4fe;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .sales-notes-section h4 {
      color: #7c3aed;
      font-size: 0.95rem;
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sales-info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .info-label {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .info-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
    }
    .notes-box {
      background: #fff;
      border-radius: 6px;
      padding: 12px;
    }
    .notes-box p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #374151;
      white-space: pre-wrap;
    }
    .invite-option {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .invite-option .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #166534;
      cursor: pointer;
    }
    .invite-option .checkbox-label input {
      width: 18px;
      height: 18px;
    }
    .invite-hint {
      font-size: 0.8rem;
      color: #15803d;
      margin: 8px 0 0 26px;
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå‰Šé™¤ç¢ºèªç”¨ï¼‰ */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-backdrop.active {
      display: flex !important;
    }
    .modal {
      background: #fff;
      border-radius: 16px;
      width: min(640px, 92vw);
      padding: 32px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal.modal-sm {
      width: min(400px, 92vw);
      text-align: center;
    }
    .modal.modal-lg {
      width: min(900px, 95vw);
      max-height: 85vh;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    .modal-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #6b7280;
      z-index: 10;
    }
    .detail-header {
      padding: 24px 32px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .detail-header h3 {
      margin: 0;
      font-size: 1.25rem;
    }
    .detail-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .detail-status.active { background: #d1fae5; color: #065f46; }
    .detail-status.suspended { background: #fef3c7; color: #92400e; }
    .detail-status.terminated { background: #fee2e2; color: #991b1b; }
    .detail-status.pending { background: #e0e7ff; color: #3730a3; }
    
    .detail-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      padding: 0 24px;
      background: #f9fafb;
    }
    .detail-tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      font-size: 0.9rem;
      color: #6b7280;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .detail-tab:hover { color: #111827; }
    .detail-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 600;
    }
    
    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
    }
    .detail-panel {
      display: none;
    }
    .detail-panel.active {
      display: block;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .info-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .info-item.full { grid-column: 1 / -1; }
    .info-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .info-value {
      font-size: 0.95rem;
      color: #111827;
      font-weight: 500;
    }
    
    .panel-loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .empty-panel {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }
    .empty-panel i {
      font-size: 2rem;
      margin-bottom: 12px;
      display: block;
    }
    
    .history-item {
      padding: 16px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .history-item:last-child { margin-bottom: 0; }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-id {
      font-weight: 600;
      color: #111827;
    }
    .history-date {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .history-status {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .history-status.pending { background: #fef3c7; color: #92400e; }
    .history-status.processing { background: #dbeafe; color: #1e40af; }
    .history-status.completed { background: #d1fae5; color: #065f46; }
    .history-status.rejected { background: #fee2e2; color: #991b1b; }
    .history-status.scheduled { background: #dbeafe; color: #1e40af; }
    .history-status.draft { background: #fef3c7; color: #92400e; }
    .history-body {
      font-size: 0.9rem;
      color: #374151;
    }
    .history-amount {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
      margin-top: 8px;
    }
    .history-items {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f0f0f0;
      font-size: 0.85rem;
      color: #6b7280;
    }
    
    .modal.modal-lg .modal-actions {
      padding: 16px 32px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    @media (max-width: 640px) {
      .info-grid { grid-template-columns: 1fr; }
      .detail-tabs { overflow-x: auto; }
      .detail-tab { white-space: nowrap; padding: 10px 14px; font-size: 0.8rem; }
    }
    
    .modal h3 {
      font-size: 1.5rem;
      margin-bottom: 24px;
      color: #111827;
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #6b7280;
    }
    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    .form-field {
      flex: 1;
    }
    .form-field.half {
      flex: 0 0 calc(50% - 8px);
    }
    .form-field label {
      display: block;
      font-weight: 600;
      font-size: 0.875rem;
      color: #374151;
      margin-bottom: 6px;
    }
    .form-field .required {
      color: #dc2626;
    }
    .form-field input,
    .form-field textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .form-field input:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,103,156,0.2);
    }
    .form-status {
      min-height: 24px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }
    .form-status.success { color: #059669; }
    .form-status.error { color: #dc2626; }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    @media (max-width: 768px) {
      main.admin-stores > .container {
        padding: 16px;
      }
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      .search-section {
        flex-direction: column;
      }
      .stores-table th:nth-child(3),
      .stores-table td:nth-child(3),
      .stores-table th:nth-child(5),
      .stores-table td:nth-child(5) {
        display: none;
      }
      .form-row {
        flex-direction: column;
        gap: 12px;
      }
      .form-field.half {
        flex: 1;
      }
    }
  </style>

<script>
(function() {
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  
  let allStores = [];
  let allClients = [];
  let allBrands = [];
  let filteredStores = [];
  let currentPage = 1;
  const perPage = 20;
  let deleteTargetId = null;

  // DOMè¦ç´ 
  const tbody = document.getElementById('stores-tbody');
  const storeCount = document.getElementById('store-count');
  const searchInput = document.getElementById('search-input');
  const clientFilter = document.getElementById('client-filter');
  const brandFilter = document.getElementById('brand-filter');
  const prefFilter = document.getElementById('pref-filter');
  const statusFilter = document.getElementById('status-filter');
  const sortFilter = document.getElementById('sort-filter');
  const activeFiltersEl = document.getElementById('active-filters');
  const pagination = document.getElementById('pagination');
  
  const storeModal = document.getElementById('store-dialog');
  const deleteModal = document.getElementById('delete-modal-backdrop');
  const storeForm = document.getElementById('store-form');
  const modalTitle = document.getElementById('modal-title');
  const formStatus = document.getElementById('form-status');

  // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  async function loadStores() {
    try {
      // ä¸¦åˆ—ã§å–å¾—
      const [storesRes, clientsRes, brandsRes] = await Promise.all([
        fetch(`${API_BASE}/stores`),
        fetch(`${API_BASE}/clients`),
        fetch(`${API_BASE}/brands`)
      ]);
      allStores = await storesRes.json();
      allClients = await clientsRes.json();
      allBrands = await brandsRes.json();
      
      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é¸æŠè‚¢ã‚’ç”Ÿæˆ
      populateFilters();
      filterAndRender();
    } catch (error) {
      console.error('Failed to load data:', error);
      tbody.innerHTML = '<tr><td colspan="8" class="loading-cell">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
    }
  }
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é¸æŠè‚¢ã‚’ç”Ÿæˆ
  function populateFilters() {
    // å–å¼•å…ˆï¼ˆä¼æ¥­/å€‹äººï¼‰
    clientFilter.innerHTML = '<option value="">å…¨å–å¼•å…ˆ</option>' + 
      allClients.map(c => `<option value="${c.id}">${c.name}${c.type === 'individual' ? 'ï¼ˆå€‹äººï¼‰' : ''}</option>`).join('');
    
    // ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆå–å¼•å…ˆã«é€£å‹•ï¼‰
    updateBrandFilter();
    
    // éƒ½é“åºœçœŒ
    const prefs = [...new Set(allStores.map(s => s.pref).filter(Boolean))].sort();
    prefFilter.innerHTML = '<option value="">å…¨éƒ½é“åºœçœŒ</option>' + 
      prefs.map(p => `<option value="${p}">${p}</option>`).join('');
  }
  
  // ãƒ–ãƒ©ãƒ³ãƒ‰ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æ›´æ–°ï¼ˆå–å¼•å…ˆã«é€£å‹•ï¼‰
  function updateBrandFilter() {
    const selectedClient = clientFilter.value;
    let brands;
    if (selectedClient) {
      brands = allBrands.filter(b => b.client_id === selectedClient);
    } else {
      brands = allBrands;
    }
    brandFilter.innerHTML = '<option value="">å…¨ãƒ–ãƒ©ãƒ³ãƒ‰</option>' + 
      brands.map(b => {
        const client = allClients.find(c => c.id === b.client_id);
        const clientName = client ? ` (${client.name})` : '';
        return `<option value="${b.id}">${b.name}${selectedClient ? '' : clientName}</option>`;
      }).join('');
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¨è¡¨ç¤º
  function filterAndRender() {
    const searchTerm = searchInput.value.toLowerCase();
    const clientValue = clientFilter.value;
    const brandValue = brandFilter.value;
    const prefValue = prefFilter.value;
    const statusValue = statusFilter.value;
    const sortValue = sortFilter.value;
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    filteredStores = allStores.filter(store => {
      const matchSearch = !searchTerm || 
        (store.name || '').toLowerCase().includes(searchTerm) ||
        (store.city || '').toLowerCase().includes(searchTerm) ||
        (store.address1 || '').toLowerCase().includes(searchTerm) ||
        (store.phone || '').includes(searchTerm);
      
      // ãƒ–ãƒ©ãƒ³ãƒ‰ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
      let matchBrand = true;
      if (brandValue) {
        matchBrand = store.brand_id === brandValue;
      }
      
      // å–å¼•å…ˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰çµŒç”±ï¼‰
      let matchClient = true;
      if (clientValue && !brandValue) {
        const clientBrands = allBrands.filter(b => b.client_id === clientValue).map(b => b.id);
        matchBrand = clientBrands.includes(store.brand_id);
      }
      
      const matchPref = !prefValue || store.pref === prefValue;
      const matchStatus = !statusValue || store.status === statusValue;
      return matchSearch && matchBrand && matchClient && matchPref && matchStatus;
    });
    
    // ã‚½ãƒ¼ãƒˆ
    filteredStores.sort((a, b) => {
      switch (sortValue) {
        case 'name-asc':
          return (a.name || '').localeCompare(b.name || '', 'ja');
        case 'name-desc':
          return (b.name || '').localeCompare(a.name || '', 'ja');
        case 'created-desc':
          return (b.created_at || '').localeCompare(a.created_at || '');
        case 'created-asc':
          return (a.created_at || '').localeCompare(b.created_at || '');
        case 'id-asc':
          return parseInt(a.id) - parseInt(b.id);
        case 'id-desc':
          return parseInt(b.id) - parseInt(a.id);
        default:
          return 0;
      }
    });
    
    storeCount.textContent = `${filteredStores.length}ä»¶`;
    currentPage = 1;
    renderTable();
    renderPagination();
    renderActiveFilters();
  }
  
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤º
  function renderActiveFilters() {
    const filters = [];
    if (searchInput.value) filters.push({ key: 'search', label: `æ¤œç´¢: ${searchInput.value}` });
    if (clientFilter.value) {
      const client = allClients.find(c => c.id === clientFilter.value);
      filters.push({ key: 'client', label: `å–å¼•å…ˆ: ${client ? client.name : clientFilter.value}` });
    }
    if (brandFilter.value) {
      const brand = allBrands.find(b => b.id === brandFilter.value);
      filters.push({ key: 'brand', label: `ãƒ–ãƒ©ãƒ³ãƒ‰: ${brand ? brand.name : brandFilter.value}` });
    }
    if (prefFilter.value) filters.push({ key: 'pref', label: prefFilter.value });
    if (statusFilter.value) {
      const statusLabelsMap = {
        'pending_customer_info': 'æƒ…å ±å…¥åŠ›å¾…ã¡', 'pending_approval': 'æ‰¿èªå¾…ã¡',
        'active': 'ç¨¼åƒä¸­', 'suspended': 'ä¼‘æ­¢ä¸­', 'terminated': 'å¥‘ç´„çµ‚äº†'
      };
      filters.push({ key: 'status', label: statusLabelsMap[statusFilter.value] || statusFilter.value });
    }
    
    if (filters.length === 0) {
      activeFiltersEl.innerHTML = '';
      return;
    }
    
    activeFiltersEl.innerHTML = filters.map(f => `
      <span class="filter-tag">
        ${escapeHtml(f.label)}
        <button onclick="clearFilter('${f.key}')" title="è§£é™¤">Ã—</button>
      </span>
    `).join('');
  }
  
  // å€‹åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è§£é™¤
  window.clearFilter = function(key) {
    switch (key) {
      case 'search': searchInput.value = ''; break;
      case 'client': clientFilter.value = ''; updateBrandFilter(); break;
      case 'brand': brandFilter.value = ''; break;
      case 'pref': prefFilter.value = ''; break;
      case 'status': statusFilter.value = ''; break;
    }
    filterAndRender();
  };
  
  // å…¨ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
  document.getElementById('reset-filters').addEventListener('click', () => {
    searchInput.value = '';
    clientFilter.value = '';
    brandFilter.value = '';
    prefFilter.value = '';
    statusFilter.value = '';
    sortFilter.value = 'name-asc';
    updateBrandFilter();
    filterAndRender();
  });

  // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
  function renderTable() {
    const start = (currentPage - 1) * perPage;
    const pageStores = filteredStores.slice(start, start + perPage);
    
    if (pageStores.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="loading-cell">è©²å½“ã™ã‚‹åº—èˆ—ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }
    
    tbody.innerHTML = pageStores.map(store => {
      // 3å±¤æ§‹é€ ã®æƒ…å ±ã‚’å–å¾—
      const brand = allBrands.find(b => b.id === store.brand_id);
      const client = brand ? allClients.find(c => c.id === brand.client_id) : 
                     allClients.find(c => c.id === store.client_id);
      
      // åº—èˆ—åã‹ã‚‰ãƒ–ãƒ©ãƒ³ãƒ‰åã¨åº—èˆ—åï¼ˆã€œåº—ï¼‰ã‚’åˆ†é›¢
      const storeName = store.name || '';
      const brandName = brand?.name || '';
      let shopName = storeName;
      
      // ãƒ–ãƒ©ãƒ³ãƒ‰åãŒåº—èˆ—åã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€åº—èˆ—åéƒ¨åˆ†ï¼ˆã€œåº—ï¼‰ã‚’æŠ½å‡º
      if (brandName && storeName.startsWith(brandName)) {
        shopName = storeName.substring(brandName.length).trim() || '-';
      }
      
      // ãƒªãƒ³ã‚¯ç”Ÿæˆï¼ˆãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ï¼‰
      const storeLink = `/admin/customers/stores/detail.html?id=${store.id}`;
      const brandCell = brand 
        ? `<a href="/admin/customers/brands/detail.html?id=${brand.id}" class="table-link brand-link">${escapeHtml(brandName)}</a>`
        : `<span class="text-muted">${escapeHtml(brandName || '-')}</span>`;
      const clientCell = client 
        ? `<a href="/admin/customers/clients/detail.html?id=${client.id}" class="table-link client-link">${escapeHtml(client.name)}</a>`
        : `<span class="text-muted">-</span>`;
      
      return `
      <tr data-id="${store.id}">
        <td>${store.id}</td>
        <td>${brandCell}</td>
        <td>
          <a href="${storeLink}" class="table-link store-link">${escapeHtml(shopName)}</a>
        </td>
        <td>${clientCell}</td>
        <td>${getStatusBadge(store.status)}</td>
        <td>
          ${store.pref || ''}${store.city || ''}<br>
          <small>${store.address1 || ''}</small>
        </td>
        <td>${store.phone || '-'}</td>
      </tr>
    `}).join('');
  }
  
  // 3å±¤æ§‹é€ ãƒãƒƒã‚¸
  function getHierarchyBadge(client, brand) {
    if (!client && !brand) {
      return '<span class="hierarchy-badge individual"><i class="fas fa-store"></i> å€‹äººåº—èˆ—</span>';
    }
    
    let html = '<div class="hierarchy-info">';
    if (client) {
      html += `<div class="hierarchy-client"><i class="fas fa-building"></i> ${escapeHtml(client.name)}</div>`;
    }
    if (brand && brand.name !== client?.name) {
      html += `<div class="hierarchy-brand"><i class="fas fa-tag"></i> ${escapeHtml(brand.name)}</div>`;
    }
    html += '</div>';
    return html;
  }

  // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æç”»
  function renderPagination() {
    const totalPages = Math.ceil(filteredStores.length / perPage);
    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }
    
    let html = '';
    for (let i = 1; i <= totalPages; i++) {
      html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
    pagination.innerHTML = html;
  }

  // ãƒšãƒ¼ã‚¸ç§»å‹•
  window.goToPage = function(page) {
    currentPage = page;
    renderTable();
    renderPagination();
  };

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°
  window.closeStoreDialog = function() {
    storeModal.close();
    formStatus.textContent = '';
    formStatus.className = 'form-status';
  };
  
  // æ³•äººãƒ»ãƒ–ãƒ©ãƒ³ãƒ‰ã®é¸æŠè‚¢ã‚’æ›´æ–°
  function populateHierarchySelects() {
    const clientSelect = document.getElementById('store-client');
    const brandSelect = document.getElementById('store-brand');
    
    // æ³•äººé¸æŠè‚¢
    clientSelect.innerHTML = '<option value="">-- æ–°è¦æ³•äººã¾ãŸã¯é¸æŠ --</option>' + 
      allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // ãƒ–ãƒ©ãƒ³ãƒ‰é¸æŠè‚¢ï¼ˆå…¨ã¦ï¼‰
    updateBrandSelectForForm();
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ ç”¨ãƒ–ãƒ©ãƒ³ãƒ‰é¸æŠè‚¢ã‚’æ›´æ–°
  function updateBrandSelectForForm() {
    const clientId = document.getElementById('store-client').value;
    const brandSelect = document.getElementById('store-brand');
    
    let brands;
    if (clientId) {
      brands = allBrands.filter(b => b.client_id === clientId);
    } else {
      brands = allBrands;
    }
    
    brandSelect.innerHTML = '<option value="">-- æ–°è¦ãƒ–ãƒ©ãƒ³ãƒ‰ã¾ãŸã¯é¸æŠ --</option>' + 
      brands.map(b => {
        const client = allClients.find(c => c.id === b.client_id);
        const clientName = client ? ` (${client.name})` : '';
        return `<option value="${b.id}">${b.name}${clientName}</option>`;
      }).join('');
  }
  
  // æ³•äººé¸æŠæ™‚ã«ãƒ–ãƒ©ãƒ³ãƒ‰é¸æŠè‚¢ã‚’æ›´æ–°
  document.getElementById('store-client').addEventListener('change', updateBrandSelectForForm);

  // æ–°è¦è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«
  document.getElementById('add-store-btn').addEventListener('click', () => {
    modalTitle.textContent = 'æ–°è¦é¡§å®¢ç™»éŒ²';
    storeForm.reset();
    document.getElementById('store-id').value = '';
    document.getElementById('invite-option').style.display = 'block';
    document.getElementById('store-status').value = 'active';
    populateHierarchySelects();
    formStatus.textContent = '';
    formStatus.className = 'form-status';
    storeModal.showModal();
  });

  // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«
  window.editStore = function(id) {
    const store = allStores.find(s => s.id === id);
    if (!store) return;
    
    modalTitle.textContent = 'é¡§å®¢æƒ…å ±ç·¨é›†';
    document.getElementById('store-id').value = store.id;
    document.getElementById('store-company').value = store.company_name || '';
    document.getElementById('store-contact').value = store.contact_person || '';
    document.getElementById('store-name').value = store.name || '';
    document.getElementById('store-postcode').value = store.postcode || '';
    document.getElementById('store-pref').value = store.pref || '';
    document.getElementById('store-city').value = store.city || '';
    document.getElementById('store-address1').value = store.address1 || '';
    document.getElementById('store-address2').value = store.address2 || '';
    document.getElementById('store-phone').value = store.phone || '';
    document.getElementById('store-email').value = store.email || store.report_email || '';
    document.getElementById('store-description').value = store.description || '';
    document.getElementById('invite-option').style.display = 'none'; // ç·¨é›†æ™‚ã¯éè¡¨ç¤º
    document.getElementById('send-invite').checked = false;
    
    // å–¶æ¥­æƒ…å ±è¡¨ç¤ºï¼ˆå–¶æ¥­ã‹ã‚‰ã®ç™»éŒ²ã®å ´åˆï¼‰
    const salesSection = document.getElementById('sales-notes-section');
    if (store.registration_type === 'sales_lead') {
      salesSection.style.display = 'block';
      document.getElementById('view-sales-rep').textContent = store.sales_rep || '-';
      const leadLabels = { 'initial': 'åˆå›æ¥è§¦', 'negotiating': 'å•†è«‡ä¸­', 'proposal': 'ææ¡ˆæ¸ˆã¿', 'pending': 'æ¤œè¨ä¸­' };
      document.getElementById('view-lead-status').textContent = leadLabels[store.lead_status] || store.lead_status || '-';
      const probLabels = { 'high': 'é«˜ï¼ˆ80%ä»¥ä¸Šï¼‰', 'medium': 'ä¸­ï¼ˆ50%ç¨‹åº¦ï¼‰', 'low': 'ä½ï¼ˆ30%ä»¥ä¸‹ï¼‰' };
      document.getElementById('view-probability').textContent = probLabels[store.probability] || store.probability || '-';
      document.getElementById('view-notes').textContent = store.notes || 'ï¼ˆãƒ¡ãƒ¢ãªã—ï¼‰';
    } else {
      salesSection.style.display = 'none';
    }
    
    formStatus.textContent = '';
    storeModal.showModal();
  };

  // å‰Šé™¤ç¢ºèª
  window.deleteStore = function(id, name) {
    deleteTargetId = id;
    document.getElementById('delete-message').textContent = `ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`;
    deleteModal.classList.add('active');
  };

  // è©³ç´°è¡¨ç¤º
  const detailModal = document.getElementById('detail-modal-backdrop');
  let currentDetailStore = null;

  window.viewStore = function(id) {
    // è©³ç´°ãƒšãƒ¼ã‚¸ã¸é·ç§»
    window.location.href = `/admin/customers/stores/detail.html?id=${id}`;
  };

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ç‰ˆï¼ˆå¾Œæ–¹äº’æ›ç”¨ï¼‰
  window.viewStoreModal = async function(id) {
    currentDetailStore = allStores.find(s => s.id === id);
    if (!currentDetailStore) return;

    // åŸºæœ¬æƒ…å ±ã‚’è¡¨ç¤º
    document.getElementById('detail-store-name').textContent = currentDetailStore.name || 'åç§°æœªè¨­å®š';
    const statusEl = document.getElementById('detail-status');
    const statusLabels = {
      active: 'ç¨¼åƒä¸­',
      suspended: 'ä¼‘æ­¢ä¸­',
      terminated: 'å¥‘ç´„çµ‚äº†',
      pending_customer_info: 'æƒ…å ±å…¥åŠ›å¾…ã¡',
      pending_approval: 'æ‰¿èªå¾…ã¡'
    };
    statusEl.textContent = statusLabels[currentDetailStore.status] || currentDetailStore.status || 'ä¸æ˜';
    statusEl.className = 'detail-status ' + (currentDetailStore.status || 'pending');

    // åŸºæœ¬æƒ…å ±ã‚°ãƒªãƒƒãƒ‰
    const client = allClients.find(c => c.id === currentDetailStore.client_id);
    const brand = allBrands.find(b => b.id === currentDetailStore.brand_id);
    
    document.getElementById('detail-info-grid').innerHTML = `
      <div class="info-item">
        <div class="info-label">åº—èˆ—ID</div>
        <div class="info-value">${currentDetailStore.id || '-'}</div>
      </div>
      <div class="info-item">
        <div class="info-label">å–å¼•å…ˆ</div>
        <div class="info-value">${client?.name || '-'}</div>
      </div>
      <div class="info-item">
        <div class="info-label">ãƒ–ãƒ©ãƒ³ãƒ‰</div>
        <div class="info-value">${brand?.name || '-'}</div>
      </div>
      <div class="info-item">
        <div class="info-label">é›»è©±ç•ªå·</div>
        <div class="info-value">${currentDetailStore.phone || '-'}</div>
      </div>
      <div class="info-item full">
        <div class="info-label">ä½æ‰€</div>
        <div class="info-value">${currentDetailStore.postcode ? 'ã€’' + currentDetailStore.postcode + ' ' : ''}${currentDetailStore.pref || ''}${currentDetailStore.city || ''}${currentDetailStore.address1 || ''}</div>
      </div>
      <div class="info-item full">
        <div class="info-label">å‚™è€ƒ</div>
        <div class="info-value">${currentDetailStore.notes || '-'}</div>
      </div>
    `;

    // ã‚¿ãƒ–ã‚’ãƒªã‚»ãƒƒãƒˆ
    switchDetailTab('info');
    detailModal.classList.add('active');
  };

  window.switchDetailTab = function(tabName) {
    document.querySelectorAll('.detail-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
    document.querySelectorAll('.detail-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tabName));

    // ãƒ‡ãƒ¼ã‚¿ã‚’é…å»¶èª­ã¿è¾¼ã¿
    if (tabName === 'estimates') loadStoreEstimates();
    if (tabName === 'schedules') loadStoreSchedules();
    if (tabName === 'reports') loadStoreReports();
  };

  async function loadStoreEstimates() {
    if (!currentDetailStore) return;
    const container = document.getElementById('detail-estimates-list');
    const loading = document.getElementById('estimates-loading');
    loading.style.display = 'block';
    container.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/estimates`);
      if (!res.ok) throw new Error('Failed');
      const estimates = await res.json();
      const storeEstimates = estimates.filter(e => e.store_id === currentDetailStore.id);
      loading.style.display = 'none';

      if (storeEstimates.length === 0) {
        container.innerHTML = '<div class="empty-panel"><i class="fas fa-file-invoice-dollar"></i>è¦‹ç©ã‚‚ã‚Šå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      const statusLabels = { pending: 'æœªå‡¦ç†', processing: 'ä½œæˆä¸­', completed: 'å®Œäº†', rejected: 'å´ä¸‹' };
      container.innerHTML = storeEstimates.map(e => {
        const date = new Date(e.created_at);
        const items = e.items || [];
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-id">${e.id}</span>
              <span class="history-status ${e.status}">${statusLabels[e.status] || e.status}</span>
            </div>
            <div class="history-date">${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
            <div class="history-amount">Â¥${(e.total || 0).toLocaleString()}</div>
            <div class="history-items">${items.map(i => i.name + (i.multiplier > 1 ? ` (${i.multiplier}å€)` : '')).join(', ') || '-'}</div>
          </div>
        `;
      }).join('');
    } catch (err) {
      loading.style.display = 'none';
      container.innerHTML = '<div class="empty-panel"><i class="fas fa-exclamation-circle"></i>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    }
  }

  async function loadStoreSchedules() {
    if (!currentDetailStore) return;
    const container = document.getElementById('detail-schedules-list');
    const loading = document.getElementById('schedules-loading');
    loading.style.display = 'block';
    container.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/schedules`);
      if (!res.ok) throw new Error('Failed');
      const schedules = await res.json();
      // DataUtilsã§æ–°æ—§ä¸¡æ–¹ã®IDå½¢å¼ã«å¯¾å¿œ
      const storeSchedules = DataUtils.filterByStoreId(schedules, currentDetailStore.id);
      loading.style.display = 'none';

      if (storeSchedules.length === 0) {
        container.innerHTML = '<div class="empty-panel"><i class="fas fa-calendar"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = storeSchedules.slice(0, 20).map(s => {
        const normalized = DataUtils.normalizeSchedule(s);
        return `
        <div class="history-item">
          <div class="history-header">
              <span class="history-id">${DataUtils.formatDate(normalized.date)} ${normalized.time || ''}</span>
              <span class="history-status ${normalized.status}">${DataUtils.getStatusLabel(normalized.status)}</span>
          </div>
            <div class="history-body">${DataUtils.escapeHtml(normalized.work_content) || 'ä½œæ¥­å†…å®¹æœªè¨­å®š'}</div>
        </div>
        `;
      }).join('');
    } catch (err) {
      loading.style.display = 'none';
      container.innerHTML = '<div class="empty-panel"><i class="fas fa-exclamation-circle"></i>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    }
  }

  async function loadStoreReports() {
    if (!currentDetailStore) return;
    const container = document.getElementById('detail-reports-list');
    const loading = document.getElementById('reports-loading');
    loading.style.display = 'block';
    container.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/reports`);
      if (!res.ok) throw new Error('Failed');
      const reports = await res.json();
      const storeReports = reports.filter(r => r.store_id === currentDetailStore.id);
      loading.style.display = 'none';

      if (storeReports.length === 0) {
        container.innerHTML = '<div class="empty-panel"><i class="fas fa-file-alt"></i>ãƒ¬ãƒãƒ¼ãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      container.innerHTML = storeReports.slice(0, 20).map(r => {
        const date = new Date(r.created_at || r.work_date);
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-id">${date.toLocaleDateString('ja-JP')}</span>
              <span class="history-status completed">å®Œäº†</span>
            </div>
            <div class="history-body">${r.content || r.work_content || 'å†…å®¹æœªè¨­å®š'}</div>
          </div>
        `;
      }).join('');
    } catch (err) {
      loading.style.display = 'none';
      container.innerHTML = '<div class="empty-panel"><i class="fas fa-exclamation-circle"></i>èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    }
  }

  window.closeDetailModal = function() {
    detailModal.classList.remove('active');
    currentDetailStore = null;
  };

  window.editFromDetail = function() {
    if (currentDetailStore) {
      closeDetailModal();
      editStore(currentDetailStore.id);
    }
  };

  // è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
  detailModal.addEventListener('click', (e) => {
    if (e.target === detailModal) closeDetailModal();
  });

  // å‰Šé™¤å®Ÿè¡Œ
  document.getElementById('confirm-delete').addEventListener('click', async () => {
    if (!deleteTargetId) return;
    
    try {
      const response = await fetch(`${API_BASE}/stores/${deleteTargetId}`, {
        method: 'DELETE'
      });
      
      if (response.ok || response.status === 204) {
        allStores = allStores.filter(s => s.id !== deleteTargetId);
        filterAndRender();
        deleteModal.classList.remove('active');
        deleteTargetId = null;
      } else {
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    } catch (error) {
      console.error('Delete failed:', error);
      alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  });

  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  storeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('store-id').value;
    const isNew = !id;
    
    const sendInvite = document.getElementById('send-invite').checked;
    const email = document.getElementById('store-email').value;
    
    // æ‹›å¾…é€ä¿¡æ™‚ã¯ãƒ¡ãƒ¼ãƒ«å¿…é ˆ
    if (isNew && sendInvite && !email) {
      alert('æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã™ã‚‹ã«ã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¿…è¦ã§ã™');
      document.getElementById('store-email').focus();
      return;
    }
    
    // 3å±¤æ§‹é€ ã®å–å¾—
    let clientId = document.getElementById('store-client').value;
    let brandId = document.getElementById('store-brand').value;
    const newClientName = document.getElementById('store-client-new').value.trim();
    const newBrandName = document.getElementById('store-brand-new').value.trim();
    
    try {
      formStatus.textContent = 'ä¿å­˜ä¸­...';
      formStatus.className = 'form-status';
      
      // æ–°è¦æ³•äººã®ä½œæˆ
      if (!clientId && newClientName) {
        const newClient = {
          id: 'CL' + Date.now(),
          name: newClientName,
          type: 'corporate',
          created_at: new Date().toISOString()
        };
        const clientRes = await fetch(`${API_BASE}/clients`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newClient)
        });
        if (clientRes.ok) {
          allClients.push(newClient);
          clientId = newClient.id;
        }
      }
      
      // æ–°è¦ãƒ–ãƒ©ãƒ³ãƒ‰ã®ä½œæˆ
      if (!brandId && newBrandName) {
        const newBrand = {
          id: 'BR' + Date.now(),
          name: newBrandName,
          client_id: clientId || null,
          created_at: new Date().toISOString()
        };
        const brandRes = await fetch(`${API_BASE}/brands`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newBrand)
        });
        if (brandRes.ok) {
          allBrands.push(newBrand);
          brandId = newBrand.id;
        }
      }
      
      // åº—èˆ—ãƒ‡ãƒ¼ã‚¿
    const data = {
      contact_person: document.getElementById('store-contact').value,
      name: document.getElementById('store-name').value,
      postcode: document.getElementById('store-postcode').value,
      pref: document.getElementById('store-pref').value,
      city: document.getElementById('store-city').value,
      address1: document.getElementById('store-address1').value,
      address2: document.getElementById('store-address2').value,
      phone: document.getElementById('store-phone').value,
      email: email,
        description: document.getElementById('store-description').value,
        status: document.getElementById('store-status').value,
        client_id: clientId || null,
        brand_id: brandId || null
    };
    
    if (isNew) {
        data.id = 'ST' + Date.now();
        data.created_at = new Date().toISOString();
        if (sendInvite) data.status = 'pending_customer_info';
    } else {
      data.id = id;
    }
      data.updated_at = new Date().toISOString();
      
      const response = await fetch(`${API_BASE}/stores${isNew ? '' : '/' + id}`, {
        method: isNew ? 'POST' : 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        // ãƒªã‚¹ãƒˆæ›´æ–°
        if (isNew) {
          allStores.unshift(data);
          
          // æ‹›å¾…ãƒªãƒ³ã‚¯é€ä¿¡
          if (sendInvite) {
            const inviteLink = `${window.location.origin}/registration/customer-complete.html?token=${data.id}`;
            formStatus.innerHTML = `
              <div class="invite-success">
                <div class="invite-success-header">
                  <i class="fas fa-check-circle"></i> ä¿å­˜ã—ã¾ã—ãŸ
                </div>
                <div class="invite-success-body">
                  <p>æ‹›å¾…ãƒªãƒ³ã‚¯:</p>
                  <input type="text" value="${inviteLink}" readonly class="invite-link-input" onclick="this.select()">
                  <small>ã“ã®ãƒªãƒ³ã‚¯ã‚’ãŠå®¢æ§˜ã«ãŠé€ã‚Šãã ã•ã„</small>
                </div>
                <button type="button" class="btn btn-primary" onclick="closeStoreDialog()" style="margin-top:12px;width:100%;">
                  é–‰ã˜ã‚‹
                </button>
              </div>
            `;
            formStatus.className = 'form-status success';
          } else {
            formStatus.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
            formStatus.className = 'form-status success';
            setTimeout(() => closeStoreDialog(), 800);
          }
        } else {
          const idx = allStores.findIndex(s => s.id === id);
          if (idx >= 0) allStores[idx] = { ...allStores[idx], ...data };
          formStatus.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
          formStatus.className = 'form-status success';
          setTimeout(() => closeStoreDialog(), 800);
        }
        filterAndRender();
      } else {
        throw new Error('Save failed');
      }
    } catch (error) {
      console.error('Save failed:', error);
      formStatus.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
      formStatus.className = 'form-status error';
    }
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ï¼ˆå‰Šé™¤ç¢ºèªç”¨ï¼‰
  document.getElementById('cancel-delete').addEventListener('click', () => deleteModal.classList.remove('active'));
  deleteModal.addEventListener('click', (e) => {
    if (e.target === deleteModal) deleteModal.classList.remove('active');
  });

  // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  searchInput.addEventListener('input', debounce(filterAndRender, 300));
  clientFilter.addEventListener('change', () => {
    updateBrandFilter();
    filterAndRender();
  });
  brandFilter.addEventListener('change', filterAndRender);
  prefFilter.addEventListener('change', filterAndRender);
  statusFilter.addEventListener('change', filterAndRender);
  sortFilter.addEventListener('change', filterAndRender);

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return '-';
    return dateStr.split(' ')[0];
  }
  
  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
  const statusLabels = {
    'pending_customer_info': { label: 'æƒ…å ±å…¥åŠ›å¾…ã¡', color: '#f59e0b' },
    'pending_approval': { label: 'æ‰¿èªå¾…ã¡', color: '#3b82f6' },
    'active': { label: 'ç¨¼åƒä¸­', color: '#10b981' },
    'suspended': { label: 'ä¼‘æ­¢ä¸­', color: '#6b7280' },
    'terminated': { label: 'å¥‘ç´„çµ‚äº†', color: '#ef4444' },
    // CSVã‹ã‚‰ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    'contract_pending': { label: 'å¥‘ç´„ä½œæ¥­ä¸­', color: '#f59e0b' },
    'considering': { label: 'æ¤œè¨ä¸­', color: '#8b5cf6' },
    'prospect': { label: 'ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå‰', color: '#6b7280' },
    'negotiated': { label: 'å•†è«‡æ¸ˆ', color: '#3b82f6' },
    'lost': { label: 'å¤±æ³¨', color: '#ef4444' },
    'unknown': { label: 'æœªè¨­å®š', color: '#9ca3af' }
  };
  
  function getStatusBadge(status) {
    const info = statusLabels[status] || { label: status || 'æœªè¨­å®š', color: '#9ca3af' };
    return `<span class="status-badge" style="background: ${info.color}20; color: ${info.color}; border: 1px solid ${info.color}40;">${info.label}</span>`;
  }
  
  // ç™»éŒ²å…ƒãƒãƒƒã‚¸
  function getSourceBadge(type) {
    const sources = {
      'sales_lead': { label: 'å–¶æ¥­', color: '#8b5cf6', icon: 'fa-user-tie' },
      'admin': { label: 'ç®¡ç†è€…', color: '#3b82f6', icon: 'fa-user-shield' },
      'customer': { label: 'ãŠå®¢æ§˜', color: '#10b981', icon: 'fa-user' },
      'migration': { label: 'ç§»è¡Œ', color: '#6b7280', icon: 'fa-database' }
    };
    // æœªè¨­å®šã®å ´åˆã¯ã€Œç§»è¡Œã€ã¨ã—ã¦æ‰±ã†ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œï¼‰
    const info = sources[type] || sources['migration'];
    return `<span class="source-badge" style="color: ${info.color};"><i class="fas ${info.icon}"></i> ${info.label}</span>`;
  }
  
  // å•†è«‡ãƒãƒƒã‚¸
  function getLeadBadge(leadStatus, probability) {
    if (!leadStatus) return '-';
    const leads = {
      'initial': { label: 'åˆå›', color: '#6b7280' },
      'negotiating': { label: 'å•†è«‡ä¸­', color: '#f59e0b' },
      'proposal': { label: 'ææ¡ˆæ¸ˆ', color: '#3b82f6' },
      'pending': { label: 'æ¤œè¨ä¸­', color: '#8b5cf6' }
    };
    const probs = { 'high': 'â—', 'medium': 'â—‹', 'low': 'â–³' };
    const info = leads[leadStatus] || { label: leadStatus, color: '#9ca3af' };
    const probIcon = probs[probability] || '';
    return `<span class="lead-badge" style="color: ${info.color};">${info.label}${probIcon ? ' ' + probIcon : ''}</span>`;
  }
  
  function debounce(fn, delay) {
    let timer;
    return function(...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèª
  function checkEditMode() {
    const urlParams = new URLSearchParams(window.location.search);
    const editStoreId = urlParams.get('edit_store');
    if (editStoreId) {
      // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      setTimeout(() => {
        editStore(editStoreId);
        // URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        window.history.replaceState({}, '', '/admin/customers/');
      }, 500);
    }
  }

  // åˆæœŸåŒ–
  loadStores().then(() => {
    checkEditMode();
  });
})();
</script>


    </main>
    <footer class="site-footer">
  <div class="container text-center muted small" style="padding: 16px 0;">
    <p>&copy; 2025 ãƒŸã‚»ã‚µãƒ</p>
  </div>
</footer>


    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="/js/firebase-config.js"></script>
    <script src="/js/users.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/modal_manager.js"></script>
    <script src="/app.js"></script>
    <script>
      // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ã¯é€šå¸¸ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤º
      (function() {
        const path = window.location.pathname || '';
        const isSigninPage = path.includes('/signin.html') || path.includes('/signin');
        
        // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ã¯é€šå¸¸ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¡¨ç¤ºã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º
        if (isSigninPage) {
          const defaultHeaderWrapper = document.getElementById('default-header-wrapper');
          const normalHeaderWrapper = document.getElementById('normal-header-wrapper');
          if (defaultHeaderWrapper) {
            defaultHeaderWrapper.style.display = 'none';
          }
          if (normalHeaderWrapper) {
            normalHeaderWrapper.style.display = 'block';
            // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ã¯é€šå¸¸ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¸¸ã«è¡¨ç¤º
            const normalHeader = normalHeaderWrapper.querySelector('.normal-header');
            if (normalHeader) {
              normalHeader.classList.add('visible');
            }
          }
        }
      })();
    </script>
  </body>
  </html>


