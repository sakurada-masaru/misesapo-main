@layout('layouts.admin')
@json('data/meta/admin_stores_title.json', $title)
@json('data/meta/admin_stores_body_class.json', $body_class)

<script src="/js/data_utils.js"></script>

<main id="main" class="admin-stores-v2">
  <!-- サイドバー -->
  <aside class="sidebar" id="admin-sidebar">
    <div class="sidebar-header">
      <a href="/admin/dashboard.html" class="logo-link">
        <img src="/images/logo_144x144.png" alt="ミセサポ" class="logo-img" />
        <span class="logo-text">ミセサポ</span>
      </a>
      </div>
    
    <!-- ロール表示 -->
    <div class="sidebar-role">
      <span class="role-badge" id="sidebar-role-badge">管理者</span>
    </div>
    
    <nav class="sidebar-nav">
      <a href="/admin/dashboard.html" class="nav-item">
        <i class="fas fa-history"></i>
        <span class="nav-label">アクティビティ</span>
      </a>
      <a href="/admin/schedules/" class="nav-item">
        <i class="fas fa-calendar-alt"></i>
        <span class="nav-label">スケジュール</span>
      </a>
      <a href="/admin/customers/" class="nav-item active">
        <i class="fas fa-store"></i>
        <span class="nav-label">顧客管理</span>
      </a>
      <a href="/admin/reports/" class="nav-item">
        <i class="fas fa-file-alt"></i>
        <span class="nav-label">レポート</span>
      </a>
      <a href="/admin/estimates/" class="nav-item">
        <i class="fas fa-file-invoice-dollar"></i>
        <span class="nav-label">見積もり</span>
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i class="fas fa-shopping-cart"></i>
        <span class="nav-label">発注管理</span>
      </a>
      <a href="/admin/partners.html" class="nav-item">
        <i class="fas fa-handshake"></i>
        <span class="nav-label">パートナー企業</span>
      </a>
      <a href="/admin/users/" class="nav-item">
        <i class="fas fa-users"></i>
        <span class="nav-label">ユーザー</span>
      </a>
      <a href="/admin/services/" class="nav-item">
        <i class="fas fa-cog"></i>
        <span class="nav-label">サービス管理</span>
      </a>
      <a href="/admin/analytics/" class="nav-item">
        <i class="fas fa-chart-bar"></i>
        <span class="nav-label">分析</span>
      </a>
      <a href="/admin/images/" class="nav-item">
        <i class="fas fa-images"></i>
        <span class="nav-label">メディア</span>
      </a>
      <div class="nav-divider"></div>
      <a href="/wiki" class="nav-item">
        <i class="fas fa-book-open"></i>
        <span class="nav-label">WIKI</span>
      </a>
      <a href="/admin/settings/" class="nav-item">
        <i class="fas fa-sliders-h"></i>
        <span class="nav-label">設定</span>
      </a>
      <a href="/admin/sitemap.html" class="nav-item">
        <i class="fas fa-sitemap"></i>
        <span class="nav-label">サイトマップ</span>
      </a>
      <button class="nav-item nav-item-button" onclick="window.Auth && window.Auth.logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span class="nav-label">ログアウト</span>
      </button>
    </nav>

    <!-- トグルボタン -->
    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="サイドバーを開閉">
      <i class="fas fa-chevron-left"></i>
    </button>
  </aside>

  <!-- メインコンテンツ -->
  <div class="main-content">
    <div class="container">
      <!-- トップバー -->
      <header class="topbar">
        <div class="topbar-left">
          <h1>顧客管理</h1>
          <span class="store-count" id="store-count">読み込み中...</span>
        </div>
        <div class="topbar-right">
          <button type="button" class="btn btn-primary" id="add-store-btn" onclick="document.getElementById('store-dialog').showModal()">
            <i class="fas fa-plus"></i>
            新規追加
          </button>
        </div>
      </header>

    <!-- 検索・フィルター -->
    <div class="search-section">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="search-input" placeholder="店舗名、住所、電話番号で検索...">
      </div>
      <div class="filter-group">
        <select id="client-filter">
          <option value="">全取引先</option>
        </select>
        <select id="brand-filter">
          <option value="">全ブランド</option>
        </select>
        <select id="pref-filter">
          <option value="">全都道府県</option>
        </select>
        <select id="status-filter">
          <option value="">全ステータス</option>
          <option value="active">稼働中</option>
          <option value="contract_pending">契約作業中</option>
          <option value="considering">検討中</option>
          <option value="prospect">アプローチ前</option>
          <option value="negotiated">商談済</option>
          <option value="lost">失注</option>
          <option value="suspended">休止中</option>
          <option value="terminated">契約終了</option>
        </select>
        <select id="sort-filter">
          <option value="name-asc">店舗名 昇順</option>
          <option value="name-desc">店舗名 降順</option>
          <option value="created-desc">登録日 新しい順</option>
          <option value="created-asc">登録日 古い順</option>
          <option value="id-asc">ID 昇順</option>
          <option value="id-desc">ID 降順</option>
        </select>
      </div>
      <button type="button" class="btn btn-secondary btn-sm" id="reset-filters">
        <i class="fas fa-undo"></i> リセット
      </button>
    </div>
    
    <!-- アクティブフィルター表示 -->
    <div class="active-filters" id="active-filters"></div>

    <!-- 店舗一覧 -->
    <div class="stores-table-wrapper">
      <table class="stores-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>ブランド名</th>
            <th>店舗名</th>
            <th>法人名</th>
            <th>ステータス</th>
            <th>住所</th>
            <th>電話番号</th>
          </tr>
        </thead>
        <tbody id="stores-tbody">
          <tr>
            <td colspan="8" class="loading-cell">
              <i class="fas fa-spinner fa-spin"></i> 読み込み中...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ページネーション -->
    <div class="pagination" id="pagination"></div>
    </div>
  </div>
</main>

<!-- 新規追加/編集ダイアログ -->
<dialog id="store-dialog" class="store-dialog">
  <div class="dialog-content">
    <button type="button" class="dialog-close" onclick="closeStoreDialog()" aria-label="閉じる">
      <i class="fas fa-times"></i>
    </button>
    <h3 id="modal-title">新規顧客登録</h3>
    <form id="store-form" method="dialog">
      <input type="hidden" id="store-id" name="id">
      
      <!-- 法人情報セクション -->
      <div class="hierarchy-section">
        <div class="hierarchy-header">
          <i class="fas fa-building"></i> 法人名
        </div>
      <div class="form-row">
          <div class="form-field">
            <label for="store-client">既存法人から選択</label>
            <select id="store-client" name="client_id">
              <option value="">-- 新規法人または選択 --</option>
            </select>
        </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-client-new">新規法人登録</label>
            <input type="text" id="store-client-new" name="client_name_new" placeholder="株式会社○○">
          </div>
        </div>
      </div>
      
      <!-- ブランド情報セクション -->
      <div class="hierarchy-section">
        <div class="hierarchy-header">
          <i class="fas fa-tag"></i> ブランド名
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-brand">既存ブランドから選択</label>
            <select id="store-brand" name="brand_id">
              <option value="">-- 新規ブランドまたは選択 --</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-brand-new">新規ブランド登録</label>
            <input type="text" id="store-brand-new" name="brand_name_new" placeholder="晩杯屋">
          </div>
        </div>
      </div>
      
      <!-- 店舗情報セクション -->
      <div class="store-section">
        <div class="hierarchy-header">
          <i class="fas fa-store"></i> 新規店舗登録
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="store-name">店舗名 <span class="required">*</span></label>
            <input type="text" id="store-name" name="name" required placeholder="門前仲町店">
          </div>
        </div>
        <div class="form-row">
        <div class="form-field half">
          <label for="store-contact">担当者名</label>
          <input type="text" id="store-contact" name="contact_person" placeholder="山田太郎">
        </div>
          <div class="form-field half">
            <label for="store-phone">電話番号</label>
            <input type="tel" id="store-phone" name="phone" placeholder="03-1234-5678">
          </div>
      </div>
      <div class="form-row">
        <div class="form-field">
            <label for="store-email">メールアドレス <span class="required" id="email-required" style="display:none">*</span></label>
            <input type="email" id="store-email" name="email" placeholder="info@example.com">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field half">
          <label for="store-postcode">郵便番号</label>
          <input type="text" id="store-postcode" name="postcode" placeholder="1234567">
        </div>
        <div class="form-field half">
          <label for="store-pref">都道府県</label>
          <input type="text" id="store-pref" name="pref" placeholder="東京都">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field half">
          <label for="store-city">市区町村</label>
          <input type="text" id="store-city" name="city" placeholder="新宿区">
        </div>
        <div class="form-field half">
            <label for="store-address1">住所</label>
          <input type="text" id="store-address1" name="address1" placeholder="1-2-3">
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
            <label for="store-address2">建物名等</label>
          <input type="text" id="store-address2" name="address2" placeholder="○○ビル3F">
        </div>
      </div>
      <div class="form-row">
          <div class="form-field">
            <label for="store-status">ステータス</label>
            <select id="store-status" name="status">
              <option value="active">稼働中</option>
              <option value="contract_pending">契約作業中</option>
              <option value="considering">検討中</option>
              <option value="prospect">アプローチ前</option>
              <option value="negotiated">商談済</option>
              <option value="lost">失注</option>
              <option value="suspended">休止中</option>
              <option value="terminated">契約終了</option>
            </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label for="store-description">備考</label>
            <textarea id="store-description" name="description" rows="2"></textarea>
          </div>
        </div>
      </div>
      
      <!-- 営業メモ（編集時のみ表示） -->
      <div class="sales-notes-section" id="sales-notes-section" style="display:none;">
        <h4><i class="fas fa-user-tie"></i> 営業情報</h4>
        <div class="sales-info-grid">
          <div class="info-item">
            <span class="info-label">営業担当</span>
            <span class="info-value" id="view-sales-rep">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">商談ステータス</span>
            <span class="info-value" id="view-lead-status">-</span>
          </div>
          <div class="info-item">
            <span class="info-label">見込み度</span>
            <span class="info-value" id="view-probability">-</span>
          </div>
        </div>
        <div class="notes-box">
          <span class="info-label">営業メモ</span>
          <p id="view-notes">-</p>
        </div>
      </div>
      
      <!-- 招待リンク送信オプション（新規追加時のみ表示） -->
      <div class="invite-option" id="invite-option">
        <label class="checkbox-label">
          <input type="checkbox" id="send-invite" name="send_invite">
          <span>お客様に詳細情報入力の招待リンクを送信する</span>
        </label>
        <p class="invite-hint">チェックすると、登録後にお客様のメールアドレスへ招待リンクが送信されます。</p>
      </div>
      
      <div class="form-status" id="form-status"></div>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('store-dialog').close()">キャンセル</button>
        <button type="submit" class="btn btn-primary" id="submit-btn">保存</button>
      </div>
    </form>
  </div>
</dialog>

  <!-- 削除確認モーダル -->
  <div class="modal-backdrop" id="delete-modal-backdrop">
    <div class="modal modal-sm" role="dialog" aria-modal="true">
      <h3>削除確認</h3>
      <p id="delete-message">この顧客を削除しますか？</p>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="cancel-delete">キャンセル</button>
        <button type="button" class="btn btn-danger" id="confirm-delete">削除</button>
      </div>
    </div>
  </div>

  <!-- 顧客詳細モーダル -->
  <div class="modal-backdrop" id="detail-modal-backdrop">
    <div class="modal modal-lg" role="dialog" aria-modal="true">
      <button type="button" class="modal-close-btn" onclick="closeDetailModal()">
        <i class="fas fa-times"></i>
      </button>
      <div class="detail-header">
        <h3 id="detail-store-name">店舗名</h3>
        <span class="detail-status" id="detail-status">ステータス</span>
      </div>
      
      <!-- タブナビゲーション -->
      <div class="detail-tabs">
        <button class="detail-tab active" data-tab="info" onclick="switchDetailTab('info')">
          <i class="fas fa-info-circle"></i> 基本情報
        </button>
        <button class="detail-tab" data-tab="estimates" onclick="switchDetailTab('estimates')">
          <i class="fas fa-file-invoice-dollar"></i> 見積もり履歴
        </button>
        <button class="detail-tab" data-tab="schedules" onclick="switchDetailTab('schedules')">
          <i class="fas fa-calendar"></i> スケジュール
        </button>
        <button class="detail-tab" data-tab="reports" onclick="switchDetailTab('reports')">
          <i class="fas fa-file-alt"></i> レポート
        </button>
      </div>
      
      <!-- タブコンテンツ -->
      <div class="detail-content">
        <!-- 基本情報タブ -->
        <div class="detail-panel active" id="panel-info">
          <div class="info-grid" id="detail-info-grid">
            <!-- 動的に挿入 -->
          </div>
        </div>
        
        <!-- 見積もり履歴タブ -->
        <div class="detail-panel" id="panel-estimates">
          <div class="panel-loading" id="estimates-loading">
            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
          </div>
          <div class="estimates-list" id="detail-estimates-list">
            <!-- 動的に挿入 -->
          </div>
        </div>
        
        <!-- スケジュールタブ -->
        <div class="detail-panel" id="panel-schedules">
          <div class="panel-loading" id="schedules-loading">
            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
          </div>
          <div class="schedules-list" id="detail-schedules-list">
            <!-- 動的に挿入 -->
          </div>
        </div>
        
        <!-- レポートタブ -->
        <div class="detail-panel" id="panel-reports">
          <div class="panel-loading" id="reports-loading">
            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
          </div>
          <div class="reports-list" id="detail-reports-list">
            <!-- 動的に挿入 -->
          </div>
        </div>
      </div>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeDetailModal()">閉じる</button>
        <button type="button" class="btn btn-primary" onclick="editFromDetail()">
          <i class="fas fa-edit"></i> 編集
        </button>
      </div>
    </div>
  </div>

  <style>
    :root {
      --sidebar-width: 240px;
      --sidebar-width-collapsed: 64px;
      --topbar-height: 64px;
    }

    body.page-admin-stores {
      background: #f9fafb;
    }
    main.admin-stores-v2 {
      display: flex;
      min-height: 100vh;
      background: #f9fafb;
    }

    /* サイドバー */
    .sidebar {
      width: var(--sidebar-width);
      background: #fff;
      border-right: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      z-index: 100;
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
      transition: width 0.3s ease;
      overflow: hidden;
    }
    .sidebar.collapsed {
      width: var(--sidebar-width-collapsed);
    }
    .sidebar.collapsed .nav-label,
    .sidebar.collapsed .logo-text,
    .sidebar.collapsed .sidebar-role {
      opacity: 0;
      width: 0;
      overflow: hidden;
    }
    .sidebar.collapsed .sidebar-toggle i {
      transform: rotate(180deg);
    }
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      min-height: 64px;
      display: flex;
      align-items: center;
    }
    .logo-link {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }
    .logo-img {
      width: 32px;
      height: 32px;
      object-fit: contain;
      flex-shrink: 0;
    }
    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: #111827;
      white-space: nowrap;
      transition: opacity 0.3s ease;
    }
    .sidebar-role {
      padding: 8px 20px;
      border-bottom: 1px solid #e5e7eb;
      transition: opacity 0.3s ease;
    }
    .sidebar-role .role-badge {
      display: inline-block;
      padding: 4px 12px;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 4px;
      font-size: 0.875rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .sidebar-nav {
      flex: 1;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      overflow-y: auto;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      color: #6b7280;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .nav-item-button {
      background: none;
      border: none;
      cursor: pointer;
      width: 100%;
      text-align: left;
    }
    .nav-item:hover {
      background: #f3f4f6;
      color: #111827;
    }
    .nav-item.active {
      background: var(--primary);
      color: #fff;
    }
    .nav-item i {
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }
    .nav-label {
      transition: opacity 0.3s ease;
      white-space: nowrap;
    }
    .nav-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 12px;
    }
    .sidebar-toggle {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border: 1px solid #e5e7eb;
      border-radius: 50%;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      transition: all 0.2s;
      z-index: 200;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .sidebar.collapsed .sidebar-toggle {
      right: 18px;
    }
    .sidebar-toggle:hover {
      background: #f3f4f6;
      border-color: var(--primary);
      color: var(--primary);
    }
    .sidebar-toggle i {
      transition: transform 0.3s ease;
    }

    /* メインコンテンツ */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 24px;
      background: #f9fafb;
      transition: margin-left 0.3s ease;
    }
    .sidebar.collapsed ~ .main-content {
      margin-left: var(--sidebar-width-collapsed);
    }
    main.admin-stores-v2 > .main-content > .container {
      width: 100%;
      max-width: 100%;
    }

    /* トップバー */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .topbar-left h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    .store-count {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .store-count {
      background: var(--primary);
      color: #fff;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: var(--primary);
      color: #fff;
    }
    .btn-primary:hover {
      background: #d6336c;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
    }
    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    /* 招待リンク成功表示 */
    .invite-success {
      text-align: left;
      padding: 16px;
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 12px;
    }
    .invite-success-header {
      font-size: 1.1rem;
      font-weight: 700;
      color: #16a34a;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .invite-success-header i {
      font-size: 1.25rem;
    }
    .invite-success-body {
      margin-bottom: 8px;
    }
    .invite-success-body p {
      font-size: 0.85rem;
      color: #374151;
      margin: 0 0 6px;
    }
    .invite-link-input {
      width: 100%;
      padding: 10px 12px;
      font-size: 0.85rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      margin-bottom: 6px;
    }
    .invite-success-body small {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    .btn-danger {
      background: #dc2626;
      color: #fff;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.875rem;
    }
    .search-section {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }
    .search-box {
      flex: 1;
      position: relative;
    }
    .search-box i {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      color: #9ca3af;
    }
    .search-box input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fff;
    }
    .search-box input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,103,156,0.2);
    }
    .filter-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .filter-group select {
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fff;
      min-width: 140px;
    }
    .filter-group select:focus {
      outline: none;
      border-color: var(--primary);
    }
    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }
    .filter-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 999px;
      font-size: 0.875rem;
    }
    .filter-tag button {
      background: none;
      border: none;
      color: #1e40af;
      cursor: pointer;
      padding: 0;
      font-size: 0.75rem;
    }
    .filter-tag button:hover {
      color: #dc2626;
    }
    .stores-table-wrapper {
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .stores-table {
      width: 100%;
      border-collapse: collapse;
    }
    .stores-table th,
    .stores-table td {
      padding: 16px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .stores-table th {
      background: #f9fafb;
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
    }
    .stores-table td {
      font-size: 0.95rem;
      color: #111827;
    }
    .stores-table tr:hover {
      background: #f9fafb;
    }
    .loading-cell {
      text-align: center;
      padding: 48px !important;
      color: #6b7280;
    }
    .store-name {
      font-weight: 600;
      color: var(--primary);
    }
    /* テーブル内リンク */
    .table-link {
      text-decoration: none;
      transition: all 0.2s;
    }
    .table-link:hover {
      text-decoration: underline;
    }
    .table-link.brand-link {
      font-weight: 600;
      color: var(--primary);
      font-size: 0.95rem;
    }
    .table-link.store-link {
      font-weight: 500;
      color: #374151;
      font-size: 0.9rem;
    }
    .table-link.store-link:hover {
      color: var(--primary);
    }
    .table-link.client-link {
      font-size: 0.85rem;
      color: #1e40af;
    }
    .table-link.client-link:hover {
      color: #3b82f6;
    }
    .text-muted {
      color: #9ca3af;
      font-size: 0.85rem;
    }
    .store-address {
      color: #6b7280;
      font-size: 0.875rem;
    }
    .action-btns {
      display: flex;
      gap: 8px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .source-badge {
      font-size: 0.8rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .source-badge i {
      margin-right: 4px;
    }
    /* 3層構造表示 */
    .hierarchy-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .hierarchy-client {
      font-size: 0.8rem;
      font-weight: 600;
      color: #1e40af;
    }
    .hierarchy-client i {
      color: #3b82f6;
      margin-right: 4px;
    }
    .hierarchy-brand {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .hierarchy-brand i {
      color: #9ca3af;
      margin-right: 4px;
    }
    .hierarchy-badge.individual {
      font-size: 0.8rem;
      color: #6b7280;
      background: #f3f4f6;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .lead-badge {
      font-size: 0.8rem;
      font-weight: 600;
      white-space: nowrap;
    }
    .store-sub {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }
    .action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .action-btn i {
      font-size: 0.7rem;
    }
    .action-btn.view {
      background: #f3f4f6;
      color: #374151;
    }
    .action-btn.view:hover {
      background: #374151;
      color: #fff;
    }
    .action-btn.edit {
      background: #dbeafe;
      color: #2563eb;
    }
    .action-btn.edit:hover {
      background: #2563eb;
      color: #fff;
    }
    .action-btn.delete {
      background: #fee2e2;
      color: #dc2626;
    }
    .action-btn.delete:hover {
      background: #dc2626;
      color: #fff;
    }
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 24px;
    }
    .page-btn {
      padding: 8px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .page-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .page-btn:hover:not(.active) {
      background: #f3f4f6;
    }
    /* ダイアログ（HTML5 dialog要素） */
    .store-dialog {
      border: none;
      border-radius: 16px;
      padding: 0;
      max-width: 640px;
      width: 92vw;
      max-height: 90vh;
      overflow: visible;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }
    .store-dialog::backdrop {
      background: rgba(0,0,0,0.5);
    }
    .store-dialog .dialog-content {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .store-dialog h3 {
      font-size: 1.5rem;
      margin-bottom: 24px;
      color: #111827;
    }
    
    /* 法人・ブランド・店舗セクション */
    .hierarchy-section,
    .store-section {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .hierarchy-header {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e7eb;
    }
    .hierarchy-header i {
      font-size: 1rem;
    }
    .hierarchy-section select,
    .store-section select,
    .hierarchy-section input,
    .store-section input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.95rem;
      background: #fff;
      box-sizing: border-box;
    }
    .hierarchy-section select:focus,
    .store-section select:focus,
    .hierarchy-section input:focus,
    .store-section input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
    }
    .hierarchy-section .form-row,
    .store-section .form-row {
      margin-bottom: 12px;
    }
    .hierarchy-section .form-row:last-child,
    .store-section .form-row:last-child {
      margin-bottom: 0;
    }
    .hierarchy-section label,
    .store-section label {
      display: block;
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 6px;
    }
    
    .dialog-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.25rem;
      color: #6b7280;
      cursor: pointer;
      z-index: 10;
    }
    .dialog-close:hover {
      color: #111827;
    }
    .sales-notes-section {
      background: #faf5ff;
      border: 1px solid #d8b4fe;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .sales-notes-section h4 {
      color: #7c3aed;
      font-size: 0.95rem;
      margin: 0 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .sales-info-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    .info-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .info-label {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .info-value {
      font-size: 0.9rem;
      font-weight: 600;
      color: #374151;
    }
    .notes-box {
      background: #fff;
      border-radius: 6px;
      padding: 12px;
    }
    .notes-box p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      color: #374151;
      white-space: pre-wrap;
    }
    .invite-option {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }
    .invite-option .checkbox-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #166534;
      cursor: pointer;
    }
    .invite-option .checkbox-label input {
      width: 18px;
      height: 18px;
    }
    .invite-hint {
      font-size: 0.8rem;
      color: #15803d;
      margin: 8px 0 0 26px;
    }
    /* モーダル（削除確認用） */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }
    .modal-backdrop.active {
      display: flex !important;
    }
    .modal {
      background: #fff;
      border-radius: 16px;
      width: min(640px, 92vw);
      padding: 32px;
      position: relative;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal.modal-sm {
      width: min(400px, 92vw);
      text-align: center;
    }
    .modal.modal-lg {
      width: min(900px, 95vw);
      max-height: 85vh;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    .modal-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #6b7280;
      z-index: 10;
    }
    .detail-header {
      padding: 24px 32px 16px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .detail-header h3 {
      margin: 0;
      font-size: 1.25rem;
    }
    .detail-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .detail-status.active { background: #d1fae5; color: #065f46; }
    .detail-status.suspended { background: #fef3c7; color: #92400e; }
    .detail-status.terminated { background: #fee2e2; color: #991b1b; }
    .detail-status.pending { background: #e0e7ff; color: #3730a3; }
    
    .detail-tabs {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      padding: 0 24px;
      background: #f9fafb;
    }
    .detail-tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      font-size: 0.9rem;
      color: #6b7280;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .detail-tab:hover { color: #111827; }
    .detail-tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
      font-weight: 600;
    }
    
    .detail-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px 32px;
    }
    .detail-panel {
      display: none;
    }
    .detail-panel.active {
      display: block;
    }
    
    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .info-item {
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .info-item.full { grid-column: 1 / -1; }
    .info-label {
      font-size: 0.75rem;
      color: #6b7280;
      margin-bottom: 4px;
    }
    .info-value {
      font-size: 0.95rem;
      color: #111827;
      font-weight: 500;
    }
    
    .panel-loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .empty-panel {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
    }
    .empty-panel i {
      font-size: 2rem;
      margin-bottom: 12px;
      display: block;
    }
    
    .history-item {
      padding: 16px;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      margin-bottom: 12px;
    }
    .history-item:last-child { margin-bottom: 0; }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .history-id {
      font-weight: 600;
      color: #111827;
    }
    .history-date {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .history-status {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .history-status.pending { background: #fef3c7; color: #92400e; }
    .history-status.processing { background: #dbeafe; color: #1e40af; }
    .history-status.completed { background: #d1fae5; color: #065f46; }
    .history-status.rejected { background: #fee2e2; color: #991b1b; }
    .history-status.scheduled { background: #dbeafe; color: #1e40af; }
    .history-status.draft { background: #fef3c7; color: #92400e; }
    .history-body {
      font-size: 0.9rem;
      color: #374151;
    }
    .history-amount {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary);
      margin-top: 8px;
    }
    .history-items {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #f0f0f0;
      font-size: 0.85rem;
      color: #6b7280;
    }
    
    .modal.modal-lg .modal-actions {
      padding: 16px 32px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    @media (max-width: 640px) {
      .info-grid { grid-template-columns: 1fr; }
      .detail-tabs { overflow-x: auto; }
      .detail-tab { white-space: nowrap; padding: 10px 14px; font-size: 0.8rem; }
    }
    
    .modal h3 {
      font-size: 1.5rem;
      margin-bottom: 24px;
      color: #111827;
    }
    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      color: #6b7280;
    }
    .form-row {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
    }
    .form-field {
      flex: 1;
    }
    .form-field.half {
      flex: 0 0 calc(50% - 8px);
    }
    .form-field label {
      display: block;
      font-weight: 600;
      font-size: 0.875rem;
      color: #374151;
      margin-bottom: 6px;
    }
    .form-field .required {
      color: #dc2626;
    }
    .form-field input,
    .form-field textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
    }
    .form-field input:focus,
    .form-field textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255,103,156,0.2);
    }
    .form-status {
      min-height: 24px;
      margin-bottom: 16px;
      font-size: 0.9rem;
    }
    .form-status.success { color: #059669; }
    .form-status.error { color: #dc2626; }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    @media (max-width: 768px) {
      main.admin-stores > .container {
        padding: 16px;
      }
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      .search-section {
        flex-direction: column;
      }
      .stores-table th:nth-child(3),
      .stores-table td:nth-child(3),
      .stores-table th:nth-child(5),
      .stores-table td:nth-child(5) {
        display: none;
      }
      .form-row {
        flex-direction: column;
        gap: 12px;
      }
      .form-field.half {
        flex: 1;
      }
    }
  </style>

<script>
(function() {
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  
  let allStores = [];
  let allClients = [];
  let allBrands = [];
  let filteredStores = [];
  let currentPage = 1;
  const perPage = 20;
  let deleteTargetId = null;

  // DOM要素
  const tbody = document.getElementById('stores-tbody');
  const storeCount = document.getElementById('store-count');
  const searchInput = document.getElementById('search-input');
  const clientFilter = document.getElementById('client-filter');
  const brandFilter = document.getElementById('brand-filter');
  const prefFilter = document.getElementById('pref-filter');
  const statusFilter = document.getElementById('status-filter');
  const sortFilter = document.getElementById('sort-filter');
  const activeFiltersEl = document.getElementById('active-filters');
  const pagination = document.getElementById('pagination');
  
  const storeModal = document.getElementById('store-dialog');
  const deleteModal = document.getElementById('delete-modal-backdrop');
  const storeForm = document.getElementById('store-form');
  const modalTitle = document.getElementById('modal-title');
  const formStatus = document.getElementById('form-status');

  // データを取得
  async function loadStores() {
    try {
      // 並列で取得
      const [storesRes, clientsRes, brandsRes] = await Promise.all([
        fetch(`${API_BASE}/stores`).catch(() => ({ ok: false })),
        fetch(`${API_BASE}/clients`).catch(() => ({ ok: false })),
        fetch(`${API_BASE}/brands`).catch(() => ({ ok: false }))
      ]);
      
      if (storesRes.ok) {
        const storesData = await storesRes.json();
        allStores = Array.isArray(storesData) ? storesData : (storesData.items || storesData.stores || []);
      } else {
        console.warn('Failed to load stores');
        allStores = [];
      }
      
      if (clientsRes.ok) {
        const clientsData = await clientsRes.json();
        allClients = Array.isArray(clientsData) ? clientsData : (clientsData.items || clientsData.clients || []);
      } else {
        console.warn('Failed to load clients');
        allClients = [];
      }
      
      if (brandsRes.ok) {
        const brandsData = await brandsRes.json();
        allBrands = Array.isArray(brandsData) ? brandsData : (brandsData.items || brandsData.brands || []);
      } else {
        console.warn('Failed to load brands');
        allBrands = [];
      }
      
      // フィルター選択肢を生成
      populateFilters();
      filterAndRender();
    } catch (error) {
      console.error('Failed to load data:', error);
      tbody.innerHTML = '<tr><td colspan="8" class="loading-cell">読み込みに失敗しました</td></tr>';
    }
  }
  
  // フィルター選択肢を生成
  function populateFilters() {
    // 配列であることを確認
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array:', allClients);
      allClients = [];
    }
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array:', allBrands);
      allBrands = [];
    }
    if (!Array.isArray(allStores)) {
      console.warn('allStores is not an array:', allStores);
      allStores = [];
    }
    
    // 取引先（企業/個人）
    clientFilter.innerHTML = '<option value="">全取引先</option>' + 
      allClients.map(c => `<option value="${c.id}">${c.name}${c.type === 'individual' ? '（個人）' : ''}</option>`).join('');
    
    // ブランド（取引先に連動）
    updateBrandFilter();
    
    // 都道府県
    const prefs = [...new Set(allStores.map(s => s.pref).filter(Boolean))].sort();
    prefFilter.innerHTML = '<option value="">全都道府県</option>' + 
      prefs.map(p => `<option value="${p}">${p}</option>`).join('');
  }
  
  // ブランドフィルターを更新（取引先に連動）
  function updateBrandFilter() {
    // 配列であることを確認
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array in updateBrandFilter:', allBrands);
      allBrands = [];
    }
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array in updateBrandFilter:', allClients);
      allClients = [];
    }
    
    const selectedClient = clientFilter.value;
    let brands;
    if (selectedClient) {
      brands = allBrands.filter(b => b.client_id === selectedClient);
    } else {
      brands = allBrands;
    }
    brandFilter.innerHTML = '<option value="">全ブランド</option>' + 
      brands.map(b => {
        // EntityFinderを使用してID形式の違いに対応
        let client = null;
        if (window.DataUtils?.EntityFinder?.findClient) {
          client = window.DataUtils.EntityFinder.findClient(allClients, b.client_id);
        } else {
          client = allClients.find(c => c.id === b.client_id || String(c.id) === String(b.client_id));
        }
        const clientName = client ? ` (${client.name || client.company_name || ''})` : '';
        return `<option value="${b.id}">${b.name}${selectedClient ? '' : clientName}</option>`;
      }).join('');
  }

  // フィルタリングと表示
  function filterAndRender() {
    // 配列であることを確認
    if (!Array.isArray(allStores)) {
      console.warn('allStores is not an array in filterAndRender:', allStores);
      allStores = [];
    }
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array in filterAndRender:', allBrands);
      allBrands = [];
    }
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array in filterAndRender:', allClients);
      allClients = [];
    }
    
    const searchTerm = searchInput.value.toLowerCase();
    const clientValue = clientFilter.value;
    const brandValue = brandFilter.value;
    const prefValue = prefFilter.value;
    const statusValue = statusFilter.value;
    const sortValue = sortFilter.value;
    
    // フィルタリング
    filteredStores = allStores.filter(store => {
      const matchSearch = !searchTerm || 
        (store.name || '').toLowerCase().includes(searchTerm) ||
        (store.city || '').toLowerCase().includes(searchTerm) ||
        (store.address1 || '').toLowerCase().includes(searchTerm) ||
        (store.phone || '').includes(searchTerm);
      
      // ブランドでフィルター
      let matchBrand = true;
      if (brandValue) {
        matchBrand = store.brand_id === brandValue;
      }
      
      // 取引先でフィルター（ブランド経由、または直接）
      let matchClient = true;
      if (clientValue) {
        if (brandValue) {
          // ブランドも選択されている場合、ブランドがその取引先に属しているか確認
          let brand = null;
          if (window.DataUtils?.EntityFinder?.findBrand) {
            brand = window.DataUtils.EntityFinder.findBrand(allBrands, brandValue);
          } else {
            brand = allBrands.find(b => b.id === brandValue || String(b.id) === String(brandValue));
          }
          // IdUtils.isSameを使用してID形式の違いに対応
          if (window.DataUtils?.IdUtils?.isSame) {
            matchClient = brand && window.DataUtils.IdUtils.isSame(brand.client_id, clientValue);
          } else {
            matchClient = brand && (brand.client_id === clientValue || String(brand.client_id) === String(clientValue));
          }
        } else {
          // ブランドが選択されていない場合、取引先に属するブランドの店舗を表示
          let clientBrands = [];
          if (window.DataUtils?.IdUtils?.isSame) {
            clientBrands = allBrands.filter(b => window.DataUtils.IdUtils.isSame(b.client_id, clientValue)).map(b => b.id);
          } else {
            clientBrands = allBrands.filter(b => b.client_id === clientValue || String(b.client_id) === String(clientValue)).map(b => b.id);
          }
          // IdUtils.isSameを使用してID形式の違いに対応
          if (window.DataUtils?.IdUtils?.isSame) {
            matchBrand = clientBrands.some(bid => window.DataUtils.IdUtils.isSame(store.brand_id, bid)) || 
                        window.DataUtils.IdUtils.isSame(store.client_id, clientValue);
          } else {
            matchBrand = clientBrands.includes(store.brand_id) || store.brand_id === clientValue || 
                        store.client_id === clientValue || String(store.client_id) === String(clientValue);
          }
        }
      }
      
      const matchPref = !prefValue || store.pref === prefValue;
      const matchStatus = !statusValue || store.status === statusValue;
      return matchSearch && matchBrand && matchClient && matchPref && matchStatus;
    });
    
    // ソート
    filteredStores.sort((a, b) => {
      switch (sortValue) {
        case 'name-asc':
          return (a.name || '').localeCompare(b.name || '', 'ja');
        case 'name-desc':
          return (b.name || '').localeCompare(a.name || '', 'ja');
        case 'created-desc':
          return (b.created_at || '').localeCompare(a.created_at || '');
        case 'created-asc':
          return (a.created_at || '').localeCompare(b.created_at || '');
        case 'id-asc':
          return parseInt(a.id) - parseInt(b.id);
        case 'id-desc':
          return parseInt(b.id) - parseInt(a.id);
        default:
          return 0;
      }
    });
    
    storeCount.textContent = `${filteredStores.length}件`;
    currentPage = 1;
    renderTable();
    renderPagination();
    renderActiveFilters();
  }
  
  // アクティブフィルター表示
  function renderActiveFilters() {
    const filters = [];
    if (searchInput.value) filters.push({ key: 'search', label: `検索: ${searchInput.value}` });
    if (clientFilter.value) {
      let client = null;
      if (window.DataUtils?.EntityFinder?.findClient) {
        client = window.DataUtils.EntityFinder.findClient(allClients, clientFilter.value);
      } else {
        client = allClients.find(c => c.id === clientFilter.value || String(c.id) === String(clientFilter.value));
      }
      filters.push({ key: 'client', label: `取引先: ${client ? (client.name || client.company_name || '') : clientFilter.value}` });
    }
    if (brandFilter.value) {
      let brand = null;
      if (window.DataUtils?.EntityFinder?.findBrand) {
        brand = window.DataUtils.EntityFinder.findBrand(allBrands, brandFilter.value);
      } else {
        brand = allBrands.find(b => b.id === brandFilter.value || String(b.id) === String(brandFilter.value));
      }
      filters.push({ key: 'brand', label: `ブランド: ${brand ? brand.name : brandFilter.value}` });
    }
    if (prefFilter.value) filters.push({ key: 'pref', label: prefFilter.value });
    if (statusFilter.value) {
      const statusLabelsMap = {
        'pending_customer_info': '情報入力待ち', 'pending_approval': '承認待ち',
        'active': '稼働中', 'suspended': '休止中', 'terminated': '契約終了'
      };
      filters.push({ key: 'status', label: statusLabelsMap[statusFilter.value] || statusFilter.value });
    }
    
    if (filters.length === 0) {
      activeFiltersEl.innerHTML = '';
      return;
    }
    
    activeFiltersEl.innerHTML = filters.map(f => `
      <span class="filter-tag">
        ${escapeHtml(f.label)}
        <button onclick="clearFilter('${f.key}')" title="解除">×</button>
      </span>
    `).join('');
  }
  
  // 個別フィルター解除
  window.clearFilter = function(key) {
    switch (key) {
      case 'search': searchInput.value = ''; break;
      case 'client': clientFilter.value = ''; updateBrandFilter(); break;
      case 'brand': brandFilter.value = ''; break;
      case 'pref': prefFilter.value = ''; break;
      case 'status': statusFilter.value = ''; break;
    }
    filterAndRender();
  };
  
  // 全フィルターリセット
  document.getElementById('reset-filters').addEventListener('click', () => {
    searchInput.value = '';
    clientFilter.value = '';
    brandFilter.value = '';
    prefFilter.value = '';
    statusFilter.value = '';
    sortFilter.value = 'name-asc';
    updateBrandFilter();
    filterAndRender();
  });

  // テーブル描画
  function renderTable() {
    const start = (currentPage - 1) * perPage;
    const pageStores = filteredStores.slice(start, start + perPage);
    
    if (pageStores.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="loading-cell">該当する店舗がありません</td></tr>';
      return;
    }
    
    tbody.innerHTML = pageStores.map(store => {
      // 3層構造の情報を取得（data_utils.jsを使用）
      let hierarchy = { client: null, brand: null, store: null };
      if (window.DataUtils?.Hierarchy?.getFromStore) {
        try {
          hierarchy = window.DataUtils.Hierarchy.getFromStore(store, allClients, allBrands);
        } catch (e) {
          console.warn('Failed to get hierarchy from DataUtils:', e);
        }
      }
      
      // フォールバック: EntityFinderを使用（ID形式の違いに対応）
      let brand = hierarchy.brand;
      let client = hierarchy.client;
      
      if (!brand && store.brand_id) {
        // EntityFinderを使用してID形式の違いに対応
        if (window.DataUtils?.EntityFinder?.findBrand) {
          brand = window.DataUtils.EntityFinder.findBrand(allBrands, store.brand_id);
        } else {
          // フォールバック: 手動で取得（文字列比較と数値比較）
          brand = allBrands.find(b => {
            return b.id === store.brand_id || String(b.id) === String(store.brand_id);
          });
        }
      }
      
      if (!client) {
        if (brand && brand.client_id) {
          // EntityFinderを使用してID形式の違いに対応
          if (window.DataUtils?.EntityFinder?.findClient) {
            client = window.DataUtils.EntityFinder.findClient(allClients, brand.client_id);
          } else {
            // フォールバック: 手動で取得
            client = allClients.find(c => {
              return c.id === brand.client_id || String(c.id) === String(brand.client_id);
            });
          }
        }
        if (!client && store.client_id) {
          // EntityFinderを使用してID形式の違いに対応
          if (window.DataUtils?.EntityFinder?.findClient) {
            client = window.DataUtils.EntityFinder.findClient(allClients, store.client_id);
          } else {
            // フォールバック: 手動で取得
            client = allClients.find(c => {
              return c.id === store.client_id || String(c.id) === String(store.client_id);
            });
          }
        }
      }
      
      // 店舗名からブランド名と店舗名（〜店）を分離
      const storeName = store.name || '';
      const brandName = brand?.name || '';
      let shopName = storeName;
      
      // ブランド名が店舗名に含まれている場合、店舗名部分（〜店）を抽出
      if (brandName && storeName.startsWith(brandName)) {
        shopName = storeName.substring(brandName.length).trim() || '-';
      }
      
      // リンク生成（データがない場合はテキストのみ）
      const storeLink = `/admin/customers/stores/detail.html?id=${store.id}`;
      const brandCell = brand 
        ? `<a href="/admin/customers/brands/detail.html?id=${brand.id}" class="table-link brand-link">${escapeHtml(brandName)}</a>`
        : `<span class="text-muted">${escapeHtml(brandName || '-')}</span>`;
      const clientCell = client 
        ? `<a href="/admin/customers/clients/detail.html?id=${client.id}" class="table-link client-link">${escapeHtml(client.name || client.company_name || '-')}</a>`
        : `<span class="text-muted">-</span>`;
      
      return `
      <tr data-id="${store.id}">
        <td>${store.id}</td>
        <td>${brandCell}</td>
        <td>
          <a href="${storeLink}" class="table-link store-link">${escapeHtml(shopName)}</a>
        </td>
        <td>${clientCell}</td>
        <td>${getStatusBadge(store.status)}</td>
        <td>
          ${store.pref || ''}${store.city || ''}<br>
          <small>${store.address1 || ''}</small>
        </td>
        <td>${store.phone || '-'}</td>
      </tr>
    `}).join('');
  }
  
  // 3層構造バッジ
  function getHierarchyBadge(client, brand) {
    if (!client && !brand) {
      return '<span class="hierarchy-badge individual"><i class="fas fa-store"></i> 個人店舗</span>';
    }
    
    let html = '<div class="hierarchy-info">';
    if (client) {
      html += `<div class="hierarchy-client"><i class="fas fa-building"></i> ${escapeHtml(client.name)}</div>`;
    }
    if (brand && brand.name !== client?.name) {
      html += `<div class="hierarchy-brand"><i class="fas fa-tag"></i> ${escapeHtml(brand.name)}</div>`;
    }
    html += '</div>';
    return html;
  }

  // ページネーション描画
  function renderPagination() {
    const totalPages = Math.ceil(filteredStores.length / perPage);
    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }
    
    let html = '';
    for (let i = 1; i <= totalPages; i++) {
      html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
    }
    pagination.innerHTML = html;
  }

  // ページ移動
  window.goToPage = function(page) {
    currentPage = page;
    renderTable();
    renderPagination();
  };

  // モーダルを閉じる関数
  window.closeStoreDialog = function() {
    storeModal.close();
    formStatus.textContent = '';
    formStatus.className = 'form-status';
  };
  
  // 法人・ブランドの選択肢を更新
  function populateHierarchySelects() {
    // 配列であることを確認
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array in populateHierarchySelects:', allClients);
      allClients = [];
    }
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array in populateHierarchySelects:', allBrands);
      allBrands = [];
    }
    
    const clientSelect = document.getElementById('store-client');
    const brandSelect = document.getElementById('store-brand');
    
    // 法人選択肢
    clientSelect.innerHTML = '<option value="">-- 新規法人または選択 --</option>' + 
      allClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    
    // ブランド選択肢（全て）
    updateBrandSelectForForm();
  }
  
  // フォーム用ブランド選択肢を更新
  function updateBrandSelectForForm() {
    // 配列であることを確認
    if (!Array.isArray(allBrands)) {
      console.warn('allBrands is not an array in updateBrandSelectForForm:', allBrands);
      allBrands = [];
    }
    if (!Array.isArray(allClients)) {
      console.warn('allClients is not an array in updateBrandSelectForForm:', allClients);
      allClients = [];
    }
    
    const clientId = document.getElementById('store-client').value;
    const brandSelect = document.getElementById('store-brand');
    
    let brands;
    if (clientId) {
      brands = allBrands.filter(b => b.client_id === clientId);
    } else {
      brands = allBrands;
    }
    
    brandSelect.innerHTML = '<option value="">-- 新規ブランドまたは選択 --</option>' + 
      brands.map(b => {
        // EntityFinderを使用してID形式の違いに対応
        let client = null;
        if (window.DataUtils?.EntityFinder?.findClient) {
          client = window.DataUtils.EntityFinder.findClient(allClients, b.client_id);
        } else {
          client = allClients.find(c => c.id === b.client_id || String(c.id) === String(b.client_id));
        }
        const clientName = client ? ` (${client.name || client.company_name || ''})` : '';
        return `<option value="${b.id}">${b.name}${clientName}</option>`;
      }).join('');
  }
  
  // 法人選択時にブランド選択肢を更新
  document.getElementById('store-client').addEventListener('change', updateBrandSelectForForm);

  // 新規追加モーダル
  document.getElementById('add-store-btn').addEventListener('click', () => {
    modalTitle.textContent = '新規顧客登録';
    storeForm.reset();
    document.getElementById('store-id').value = '';
    document.getElementById('invite-option').style.display = 'block';
    document.getElementById('store-status').value = 'active';
    populateHierarchySelects();
    formStatus.textContent = '';
    formStatus.className = 'form-status';
    storeModal.showModal();
  });

  // 編集モーダル
  window.editStore = function(id) {
    const store = allStores.find(s => s.id === id);
    if (!store) return;
    
    modalTitle.textContent = '顧客情報編集';
    document.getElementById('store-id').value = store.id;
    document.getElementById('store-company').value = store.company_name || '';
    document.getElementById('store-contact').value = store.contact_person || '';
    document.getElementById('store-name').value = store.name || '';
    document.getElementById('store-postcode').value = store.postcode || '';
    document.getElementById('store-pref').value = store.pref || '';
    document.getElementById('store-city').value = store.city || '';
    document.getElementById('store-address1').value = store.address1 || '';
    document.getElementById('store-address2').value = store.address2 || '';
    document.getElementById('store-phone').value = store.phone || '';
    document.getElementById('store-email').value = store.email || store.report_email || '';
    document.getElementById('store-description').value = store.description || '';
    document.getElementById('invite-option').style.display = 'none'; // 編集時は非表示
    document.getElementById('send-invite').checked = false;
    
    // 営業情報表示（営業からの登録の場合）
    const salesSection = document.getElementById('sales-notes-section');
    if (store.registration_type === 'sales_lead') {
      salesSection.style.display = 'block';
      document.getElementById('view-sales-rep').textContent = store.sales_rep || '-';
      const leadLabels = { 'initial': '初回接触', 'negotiating': '商談中', 'proposal': '提案済み', 'pending': '検討中' };
      document.getElementById('view-lead-status').textContent = leadLabels[store.lead_status] || store.lead_status || '-';
      const probLabels = { 'high': '高（80%以上）', 'medium': '中（50%程度）', 'low': '低（30%以下）' };
      document.getElementById('view-probability').textContent = probLabels[store.probability] || store.probability || '-';
      document.getElementById('view-notes').textContent = store.notes || '（メモなし）';
    } else {
      salesSection.style.display = 'none';
    }
    
    formStatus.textContent = '';
    storeModal.showModal();
  };

  // 削除確認
  window.deleteStore = function(id, name) {
    deleteTargetId = id;
    document.getElementById('delete-message').textContent = `「${name}」を削除しますか？この操作は取り消せません。`;
    deleteModal.classList.add('active');
  };

  // 詳細表示
  const detailModal = document.getElementById('detail-modal-backdrop');
  let currentDetailStore = null;

  window.viewStore = function(id) {
    // 詳細ページへ遷移
    window.location.href = `/admin/customers/stores/detail.html?id=${id}`;
  };

  // モーダル版（後方互換用）
  window.viewStoreModal = async function(id) {
    currentDetailStore = allStores.find(s => s.id === id);
    if (!currentDetailStore) return;

    // 基本情報を表示
    document.getElementById('detail-store-name').textContent = currentDetailStore.name || '名称未設定';
    const statusEl = document.getElementById('detail-status');
    const statusLabels = {
      active: '稼働中',
      suspended: '休止中',
      terminated: '契約終了',
      pending_customer_info: '情報入力待ち',
      pending_approval: '承認待ち'
    };
    statusEl.textContent = statusLabels[currentDetailStore.status] || currentDetailStore.status || '不明';
    statusEl.className = 'detail-status ' + (currentDetailStore.status || 'pending');

    // 基本情報グリッド
    // EntityFinderを使用してID形式の違いに対応
    let client = null;
    if (window.DataUtils?.EntityFinder?.findClient) {
      client = window.DataUtils.EntityFinder.findClient(allClients, currentDetailStore.client_id);
    } else {
      client = allClients.find(c => c.id === currentDetailStore.client_id || String(c.id) === String(currentDetailStore.client_id));
    }
    let brand = null;
    if (window.DataUtils?.EntityFinder?.findBrand) {
      brand = window.DataUtils.EntityFinder.findBrand(allBrands, currentDetailStore.brand_id);
    } else {
      brand = allBrands.find(b => b.id === currentDetailStore.brand_id || String(b.id) === String(currentDetailStore.brand_id));
    }
    
    document.getElementById('detail-info-grid').innerHTML = `
      <div class="info-item">
        <div class="info-label">店舗ID</div>
        <div class="info-value">${currentDetailStore.id || '-'}</div>
      </div>
      <div class="info-item">
        <div class="info-label">取引先</div>
        <div class="info-value">${client?.name || '-'}</div>
      </div>
      <div class="info-item">
        <div class="info-label">ブランド</div>
        <div class="info-value">${brand?.name || '-'}</div>
      </div>
      <div class="info-item">
        <div class="info-label">電話番号</div>
        <div class="info-value">${currentDetailStore.phone || '-'}</div>
      </div>
      <div class="info-item full">
        <div class="info-label">住所</div>
        <div class="info-value">${currentDetailStore.postcode ? '〒' + currentDetailStore.postcode + ' ' : ''}${currentDetailStore.pref || ''}${currentDetailStore.city || ''}${currentDetailStore.address1 || ''}</div>
      </div>
      <div class="info-item full">
        <div class="info-label">備考</div>
        <div class="info-value">${currentDetailStore.notes || '-'}</div>
      </div>
    `;

    // タブをリセット
    switchDetailTab('info');
    detailModal.classList.add('active');
  };

  window.switchDetailTab = function(tabName) {
    document.querySelectorAll('.detail-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));
    document.querySelectorAll('.detail-panel').forEach(p => p.classList.toggle('active', p.id === 'panel-' + tabName));

    // データを遅延読み込み
    if (tabName === 'estimates') loadStoreEstimates();
    if (tabName === 'schedules') loadStoreSchedules();
    if (tabName === 'reports') loadStoreReports();
  };

  async function loadStoreEstimates() {
    if (!currentDetailStore) return;
    const container = document.getElementById('detail-estimates-list');
    const loading = document.getElementById('estimates-loading');
    loading.style.display = 'block';
    container.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/estimates`);
      if (!res.ok) throw new Error('Failed');
      const estimates = await res.json();
      const storeEstimates = estimates.filter(e => e.store_id === currentDetailStore.id);
      loading.style.display = 'none';

      if (storeEstimates.length === 0) {
        container.innerHTML = '<div class="empty-panel"><i class="fas fa-file-invoice-dollar"></i>見積もり履歴がありません</div>';
        return;
      }

      const statusLabels = { pending: '未処理', processing: '作成中', completed: '完了', rejected: '却下' };
      container.innerHTML = storeEstimates.map(e => {
        const date = new Date(e.created_at);
        const items = e.items || [];
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-id">${e.id}</span>
              <span class="history-status ${e.status}">${statusLabels[e.status] || e.status}</span>
            </div>
            <div class="history-date">${date.toLocaleDateString('ja-JP')} ${date.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</div>
            <div class="history-amount">¥${(e.total || 0).toLocaleString()}</div>
            <div class="history-items">${items.map(i => i.name + (i.multiplier > 1 ? ` (${i.multiplier}倍)` : '')).join(', ') || '-'}</div>
          </div>
        `;
      }).join('');
    } catch (err) {
      loading.style.display = 'none';
      container.innerHTML = '<div class="empty-panel"><i class="fas fa-exclamation-circle"></i>読み込みに失敗しました</div>';
    }
  }

  async function loadStoreSchedules() {
    if (!currentDetailStore) return;
    const container = document.getElementById('detail-schedules-list');
    const loading = document.getElementById('schedules-loading');
    loading.style.display = 'block';
    container.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/schedules`);
      if (!res.ok) throw new Error('Failed');
      const schedulesData = await res.json();
      // APIレスポンスが配列かオブジェクトかをチェック
      const schedules = Array.isArray(schedulesData) ? schedulesData : (schedulesData.items || schedulesData.schedules || []);
      // DataUtilsで新旧両方のID形式に対応
      const storeSchedules = DataUtils.filterByStoreId(schedules, currentDetailStore.id);
      loading.style.display = 'none';

      if (storeSchedules.length === 0) {
        container.innerHTML = '<div class="empty-panel"><i class="fas fa-calendar"></i>スケジュール履歴がありません</div>';
        return;
      }

      container.innerHTML = storeSchedules.slice(0, 20).map(s => {
        const normalized = DataUtils.normalizeSchedule(s);
        return `
        <div class="history-item">
          <div class="history-header">
              <span class="history-id">${DataUtils.formatDate(normalized.date)} ${normalized.time || ''}</span>
              <span class="history-status ${normalized.status}">${DataUtils.getStatusLabel(normalized.status)}</span>
          </div>
            <div class="history-body">${DataUtils.escapeHtml(normalized.work_content) || '作業内容未設定'}</div>
        </div>
        `;
      }).join('');
    } catch (err) {
      loading.style.display = 'none';
      container.innerHTML = '<div class="empty-panel"><i class="fas fa-exclamation-circle"></i>読み込みに失敗しました</div>';
    }
  }

  async function loadStoreReports() {
    if (!currentDetailStore) return;
    const container = document.getElementById('detail-reports-list');
    const loading = document.getElementById('reports-loading');
    loading.style.display = 'block';
    container.innerHTML = '';

    try {
      const res = await fetch(`${API_BASE}/reports`);
      if (!res.ok) throw new Error('Failed');
      const reports = await res.json();
      const storeReports = reports.filter(r => r.store_id === currentDetailStore.id);
      loading.style.display = 'none';

      if (storeReports.length === 0) {
        container.innerHTML = '<div class="empty-panel"><i class="fas fa-file-alt"></i>レポート履歴がありません</div>';
        return;
      }

      container.innerHTML = storeReports.slice(0, 20).map(r => {
        const date = new Date(r.created_at || r.work_date);
        return `
          <div class="history-item">
            <div class="history-header">
              <span class="history-id">${date.toLocaleDateString('ja-JP')}</span>
              <span class="history-status completed">完了</span>
            </div>
            <div class="history-body">${r.content || r.work_content || '内容未設定'}</div>
          </div>
        `;
      }).join('');
    } catch (err) {
      loading.style.display = 'none';
      container.innerHTML = '<div class="empty-panel"><i class="fas fa-exclamation-circle"></i>読み込みに失敗しました</div>';
    }
  }

  window.closeDetailModal = function() {
    detailModal.classList.remove('active');
    currentDetailStore = null;
  };

  window.editFromDetail = function() {
    if (currentDetailStore) {
      closeDetailModal();
      editStore(currentDetailStore.id);
    }
  };

  // 詳細モーダル閉じる
  detailModal.addEventListener('click', (e) => {
    if (e.target === detailModal) closeDetailModal();
  });

  // 削除実行
  document.getElementById('confirm-delete').addEventListener('click', async () => {
    if (!deleteTargetId) return;
    
    try {
      const response = await fetch(`${API_BASE}/stores/${deleteTargetId}`, {
        method: 'DELETE'
      });
      
      if (response.ok || response.status === 204) {
        allStores = allStores.filter(s => s.id !== deleteTargetId);
        filterAndRender();
        deleteModal.classList.remove('active');
        deleteTargetId = null;
      } else {
        alert('削除に失敗しました');
      }
    } catch (error) {
      console.error('Delete failed:', error);
      alert('削除に失敗しました');
    }
  });

  // フォーム送信
  storeForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const id = document.getElementById('store-id').value;
    const isNew = !id;
    
    const sendInvite = document.getElementById('send-invite').checked;
    const email = document.getElementById('store-email').value;
    
    // 招待送信時はメール必須
    if (isNew && sendInvite && !email) {
      alert('招待リンクを送信するにはメールアドレスが必要です');
      document.getElementById('store-email').focus();
      return;
    }
    
    // 3層構造の取得
    let clientId = document.getElementById('store-client').value;
    let brandId = document.getElementById('store-brand').value;
    const newClientName = document.getElementById('store-client-new').value.trim();
    const newBrandName = document.getElementById('store-brand-new').value.trim();
    
    try {
      formStatus.textContent = '保存中...';
      formStatus.className = 'form-status';
      
      // 新規法人の作成（IDはバックエンドで生成）
      if (!clientId && newClientName) {
        const newClient = {
          // IDはバックエンドで生成されるため、ここでは指定しない
          name: newClientName,
          type: 'corporate',
          created_at: new Date().toISOString()
        };
        const clientRes = await fetch(`${API_BASE}/clients`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newClient)
        });
        if (!clientRes.ok) {
          const errorData = await clientRes.json().catch(() => ({}));
          throw new Error(errorData.error || '法人の作成に失敗しました');
        }
        const createdClient = await clientRes.json();
        allClients.push(createdClient);
        clientId = createdClient.id || newClient.id;
      }
      
      // 新規ブランドの作成（IDはバックエンドで生成）
      if (!brandId && newBrandName) {
        if (!clientId) {
          throw new Error('ブランドを作成するには法人を選択または作成してください');
        }
        const newBrand = {
          // IDはバックエンドで生成されるため、ここでは指定しない
          name: newBrandName,
          client_id: clientId,
          created_at: new Date().toISOString()
        };
        const brandRes = await fetch(`${API_BASE}/brands`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newBrand)
        });
        if (!brandRes.ok) {
          const errorData = await brandRes.json().catch(() => ({}));
          throw new Error(errorData.error || 'ブランドの作成に失敗しました');
        }
        const createdBrand = await brandRes.json();
        allBrands.push(createdBrand);
        brandId = createdBrand.id || newBrand.id;
      }
      
      // 店舗データ
    const data = {
      contact_person: document.getElementById('store-contact').value,
      name: document.getElementById('store-name').value,
      postcode: document.getElementById('store-postcode').value,
      pref: document.getElementById('store-pref').value,
      city: document.getElementById('store-city').value,
      address1: document.getElementById('store-address1').value,
      address2: document.getElementById('store-address2').value,
      phone: document.getElementById('store-phone').value,
      email: email,
        description: document.getElementById('store-description').value,
        status: document.getElementById('store-status').value,
        client_id: clientId || null,
        brand_id: brandId || null
    };
    
    if (isNew) {
        // IDはバックエンドで生成されるため、ここでは指定しない
        // data.id = 'ST' + Date.now(); // 削除: バックエンドで生成
        data.created_at = new Date().toISOString();
        if (sendInvite) data.status = 'pending_customer_info';
    } else {
      data.id = id;
    }
      data.updated_at = new Date().toISOString();
      
      const response = await fetch(`${API_BASE}/stores${isNew ? '' : '/' + id}`, {
        method: isNew ? 'POST' : 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      
      if (response.ok) {
        // リスト更新
        if (isNew) {
          allStores.unshift(data);
          
          // 招待リンク送信
          if (sendInvite) {
            const inviteLink = `${window.location.origin}/registration/customer-complete.html?token=${data.id}`;
            formStatus.innerHTML = `
              <div class="invite-success">
                <div class="invite-success-header">
                  <i class="fas fa-check-circle"></i> 保存しました
                </div>
                <div class="invite-success-body">
                  <p>招待リンク:</p>
                  <input type="text" value="${inviteLink}" readonly class="invite-link-input" onclick="this.select()">
                  <small>このリンクをお客様にお送りください</small>
                </div>
                <button type="button" class="btn btn-primary" onclick="closeStoreDialog()" style="margin-top:12px;width:100%;">
                  閉じる
                </button>
              </div>
            `;
            formStatus.className = 'form-status success';
          } else {
            formStatus.textContent = '保存しました';
            formStatus.className = 'form-status success';
            setTimeout(() => closeStoreDialog(), 800);
          }
        } else {
          const idx = allStores.findIndex(s => s.id === id);
          if (idx >= 0) allStores[idx] = { ...allStores[idx], ...data };
          formStatus.textContent = '保存しました';
          formStatus.className = 'form-status success';
          setTimeout(() => closeStoreDialog(), 800);
        }
        filterAndRender();
      } else {
        throw new Error('Save failed');
      }
    } catch (error) {
      console.error('Save failed:', error);
      formStatus.textContent = '保存に失敗しました';
      formStatus.className = 'form-status error';
    }
  });

  // モーダル閉じる（削除確認用）
  document.getElementById('cancel-delete').addEventListener('click', () => deleteModal.classList.remove('active'));
  deleteModal.addEventListener('click', (e) => {
    if (e.target === deleteModal) deleteModal.classList.remove('active');
  });

  // 検索・フィルター
  searchInput.addEventListener('input', debounce(filterAndRender, 300));
  clientFilter.addEventListener('change', () => {
    updateBrandFilter();
    filterAndRender();
  });
  brandFilter.addEventListener('change', filterAndRender);
  prefFilter.addEventListener('change', filterAndRender);
  statusFilter.addEventListener('change', filterAndRender);
  sortFilter.addEventListener('change', filterAndRender);

  // ユーティリティ
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
  
  function formatDate(dateStr) {
    if (!dateStr) return '-';
    return dateStr.split(' ')[0];
  }
  
  // ステータスバッジ
  const statusLabels = {
    'pending_customer_info': { label: '情報入力待ち', color: '#f59e0b' },
    'pending_approval': { label: '承認待ち', color: '#3b82f6' },
    'active': { label: '稼働中', color: '#10b981' },
    'suspended': { label: '休止中', color: '#6b7280' },
    'terminated': { label: '契約終了', color: '#ef4444' },
    // CSVからのステータス
    'contract_pending': { label: '契約作業中', color: '#f59e0b' },
    'considering': { label: '検討中', color: '#8b5cf6' },
    'prospect': { label: 'アプローチ前', color: '#6b7280' },
    'negotiated': { label: '商談済', color: '#3b82f6' },
    'lost': { label: '失注', color: '#ef4444' },
    'unknown': { label: '未設定', color: '#9ca3af' }
  };
  
  function getStatusBadge(status) {
    const info = statusLabels[status] || { label: status || '未設定', color: '#9ca3af' };
    return `<span class="status-badge" style="background: ${info.color}20; color: ${info.color}; border: 1px solid ${info.color}40;">${info.label}</span>`;
  }
  
  // 登録元バッジ
  function getSourceBadge(type) {
    const sources = {
      'sales_lead': { label: '営業', color: '#8b5cf6', icon: 'fa-user-tie' },
      'admin': { label: '管理者', color: '#3b82f6', icon: 'fa-user-shield' },
      'customer': { label: 'お客様', color: '#10b981', icon: 'fa-user' },
      'migration': { label: '移行', color: '#6b7280', icon: 'fa-database' }
    };
    // 未設定の場合は「移行」として扱う（既存データの移行）
    const info = sources[type] || sources['migration'];
    return `<span class="source-badge" style="color: ${info.color};"><i class="fas ${info.icon}"></i> ${info.label}</span>`;
  }
  
  // 商談バッジ
  function getLeadBadge(leadStatus, probability) {
    if (!leadStatus) return '-';
    const leads = {
      'initial': { label: '初回', color: '#6b7280' },
      'negotiating': { label: '商談中', color: '#f59e0b' },
      'proposal': { label: '提案済', color: '#3b82f6' },
      'pending': { label: '検討中', color: '#8b5cf6' }
    };
    const probs = { 'high': '◎', 'medium': '○', 'low': '△' };
    const info = leads[leadStatus] || { label: leadStatus, color: '#9ca3af' };
    const probIcon = probs[probability] || '';
    return `<span class="lead-badge" style="color: ${info.color};">${info.label}${probIcon ? ' ' + probIcon : ''}</span>`;
  }
  
  function debounce(fn, delay) {
    let timer;
    return function(...args) {
      clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  // URLパラメータで編集モードを確認
  function checkEditMode() {
    const urlParams = new URLSearchParams(window.location.search);
    const editStoreId = urlParams.get('edit_store');
    if (editStoreId) {
      // データ読み込み後に編集モーダルを開く
      setTimeout(() => {
        editStore(editStoreId);
        // URLからパラメータを削除
        window.history.replaceState({}, '', '/admin/customers/');
      }, 500);
    }
  }

  // 初期化
  loadStores().then(() => {
    checkEditMode();
  });
})();

  // サイドバー開閉機能
  const sidebar = document.getElementById('admin-sidebar');
  const sidebarToggle = document.getElementById('sidebar-toggle');
  
  if (sidebar && sidebarToggle) {
    // ローカルストレージから状態を読み込み
    const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
    if (isCollapsed) {
      sidebar.classList.add('collapsed');
    }
    
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      const collapsed = sidebar.classList.contains('collapsed');
      localStorage.setItem('sidebar-collapsed', collapsed);
    });
  }

  // ロール表示の更新
  function updateRoleBadge() {
    const roleBadge = document.getElementById('sidebar-role-badge');
    if (!roleBadge) return;
        
    // ロール情報を取得
    if (window.Auth && window.Auth.getCurrentUser) {
      const user = window.Auth.getCurrentUser();
      if (user && user.role) {
        const roleConfig = window.RoleConfig?.ROLE_CONFIG;
        const roleInfo = roleConfig?.roles?.[user.role];
        if (roleInfo) {
          roleBadge.textContent = roleInfo.displayName || roleInfo.name || user.role;
          
          // ロールに応じたバッジの色を設定
          const badgeColors = {
            'guest': { bg: '#e5e7eb', color: '#6b7280' },
            'customer': { bg: '#dbeafe', color: '#1e40af' },
            'staff': { bg: '#dcfce7', color: '#166534' },
            'concierge': { bg: '#fef3c7', color: '#92400e' },
            'admin': { bg: '#e0e7ff', color: '#3730a3' },
            'developer': { bg: '#fce7f3', color: '#831843' },
            'master': { bg: '#fef2f2', color: '#991b1b' }
          };
          
          const colors = badgeColors[user.role] || badgeColors['admin'];
          roleBadge.style.background = colors.bg;
          roleBadge.style.color = colors.color;
        }
      }
    } else {
      // デフォルトで管理者として表示
      roleBadge.textContent = '管理者';
    }
  }
  
  // ページ読み込み時にロールを更新
  updateRoleBadge();
  
  // Authの状態が変わったときにロールを更新
  if (window.Auth && window.Auth.onAuthStateChanged) {
    window.Auth.onAuthStateChanged(() => {
      updateRoleBadge();
    });
  }
    </script>


    </main>


