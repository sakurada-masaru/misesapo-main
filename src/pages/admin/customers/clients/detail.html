@layout('layouts.base')
@json('data/meta/admin_clients_title.json', $title)
@json('data/meta/admin_clients_body_class.json', $body_class)

<style>
  #default-header-wrapper,
  #normal-header-wrapper {
    display: none !important;
  }
</style>

<main id="main" class="client-detail-page">
  <div class="container">
    <!-- ヘッダー -->
    <div class="page-header">
      <div class="header-left">
        <a href="/admin/customers/" class="back-link">
          <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-title">
          <div class="breadcrumb">
            <span class="label">企業/個人</span>
          </div>
          <h1 id="client-name">読み込み中...</h1>
        </div>
      </div>
      <div class="header-actions">
        <span class="status-badge" id="client-status">-</span>
        <button class="btn btn-secondary" onclick="editClient()">
          <i class="fas fa-edit"></i> 編集
        </button>
      </div>
    </div>

    <!-- 関連ページへのリンク -->
    <div class="hierarchy-links" id="hierarchy-links">
      <div class="hierarchy-link-btn brands-btn" id="brands-link-btn">
        <i class="fas fa-tag"></i>
        <div class="link-content">
          <span class="link-label">ブランド数</span>
          <span class="link-name" id="brands-link-count">0 ブランド</span>
        </div>
      </div>
      <div class="hierarchy-link-btn stores-btn" id="stores-link-btn">
        <i class="fas fa-store"></i>
        <div class="link-content">
          <span class="link-label">店舗数</span>
          <span class="link-name" id="stores-link-count">0 店舗</span>
        </div>
      </div>
    </div>

    <!-- タブナビゲーション -->
    <div class="tab-cards">
      <div class="tab-card active" data-tab="info" onclick="switchTab('info')">
        <span class="tab-label">企業情報</span>
      </div>
      <div class="tab-card" data-tab="brands" onclick="switchTab('brands')">
        <span class="tab-label">ブランド一覧</span>
        <span class="tab-badge" id="brands-badge">0</span>
      </div>
      <div class="tab-card" data-tab="contracts" onclick="switchTab('contracts')" data-permission="client_contract">
        <span class="tab-label">契約情報</span>
      </div>
    </div>

    <!-- 2カラムレイアウト -->
    <div class="main-layout">
      <!-- 左カラム -->
      <div class="left-column">
        
        <!-- 企業情報セクション -->
        <div class="section-card">
          <div class="section-header" onclick="toggleSection('client-info')">
            <div class="section-title">
              <span class="section-dot"></span>
              企業情報確認/変更
            </div>
            <i class="fas fa-chevron-down section-toggle" id="toggle-client-info"></i>
          </div>
          <div class="section-body" id="section-client-info">
            <div class="info-list" id="client-info-list">
              <!-- 動的に挿入 -->
            </div>
            <div class="section-actions">
              <button class="btn-outline" onclick="editClient()">修正する</button>
              <button class="btn-link" onclick="toggleSection('client-info')">∧ 閉じる</button>
            </div>
          </div>
        </div>

        <!-- 担当者情報セクション -->
        <div class="section-card" data-permission="client_contact">
          <div class="section-header" onclick="toggleSection('contacts')">
            <div class="section-title">
              <span class="section-dot"></span>
              担当者情報
            </div>
            <i class="fas fa-chevron-down section-toggle" id="toggle-contacts"></i>
          </div>
          <div class="section-body collapsed" id="section-contacts">
            <div class="contacts-list" id="contacts-list">
              <div class="empty-state">担当者情報がありません</div>
            </div>
            <button class="btn-link center" onclick="addContact()">+ 担当者を追加</button>
          </div>
        </div>

        <!-- 営業メモセクション（管理者・営業のみ） -->
        <div class="section-card admin-only" data-permission="client_sales_notes">
          <div class="section-header" onclick="toggleSection('sales-notes')">
            <div class="section-title">
              <span class="section-dot warning"></span>
              営業メモ
            </div>
            <i class="fas fa-chevron-down section-toggle" id="toggle-sales-notes"></i>
          </div>
          <div class="section-body collapsed" id="section-sales-notes">
            <div class="sales-info">
              <div class="info-row">
                <label>営業担当</label>
                <span id="sales-rep">-</span>
              </div>
              <div class="info-row">
                <label>商談ステータス</label>
                <span id="lead-status">-</span>
              </div>
              <div class="info-row">
                <label>見込み度</label>
                <span id="probability">-</span>
              </div>
            </div>
            <div class="notes-box">
              <label>メモ</label>
              <div class="notes-content" id="notes-content">-</div>
            </div>
          </div>
        </div>

      </div>

      <!-- 右カラム -->
      <div class="right-column">
        
        <!-- ブランド一覧 -->
        <div class="list-card" id="brands-panel">
          <div class="list-header">
            <h3>ブランド一覧</h3>
            <button class="btn btn-sm btn-primary" onclick="addBrand()">
              <i class="fas fa-plus"></i> 追加
            </button>
          </div>
          <div class="brand-list" id="brand-list">
            <div class="loading">読み込み中...</div>
          </div>
        </div>

        <!-- 契約情報 -->
        <div class="list-card" id="contracts-panel" style="display:none;">
          <div class="list-header">
            <h3>契約情報</h3>
          </div>
          <div class="contract-info" id="contract-info">
            <div class="info-row">
              <label>契約状態</label>
              <span id="contract-status">-</span>
            </div>
            <div class="info-row">
              <label>契約開始日</label>
              <span id="contract-start">-</span>
            </div>
            <div class="info-row">
              <label>契約終了日</label>
              <span id="contract-end">-</span>
            </div>
            <div class="info-row">
              <label>支払い条件</label>
              <span id="payment-terms">-</span>
            </div>
          </div>
        </div>

        <!-- 統計サマリー -->
        <div class="stats-card">
          <h3>統計</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="stat-brands">0</div>
              <div class="stat-label">ブランド数</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-stores">0</div>
              <div class="stat-label">店舗数</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="stat-schedules">0</div>
              <div class="stat-label">総清掃回数</div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
  
  <!-- 編集モーダル -->
  <div class="edit-modal" id="edit-modal" style="display:none;">
    <div class="modal-overlay" onclick="closeEditModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>法人/個人情報編集</h2>
        <button class="modal-close" onclick="closeEditModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full">
            <label>企業名/氏名 <span class="required">*</span></label>
            <input type="text" id="edit-name" placeholder="企業名または氏名">
          </div>
          <div class="form-group">
            <label>企業名カナ</label>
            <input type="text" id="edit-name-kana" placeholder="キギョウメイカナ">
          </div>
          <div class="form-group">
            <label>種別</label>
            <select id="edit-type">
              <option value="corporate">法人</option>
              <option value="individual">個人</option>
            </select>
          </div>
          <div class="form-group">
            <label>代表者名</label>
            <input type="text" id="edit-representative" placeholder="代表者名">
          </div>
          <div class="form-group">
            <label>電話番号</label>
            <input type="tel" id="edit-phone" placeholder="03-1234-5678">
          </div>
          <div class="form-group">
            <label>メールアドレス</label>
            <input type="email" id="edit-email" placeholder="info@example.com">
          </div>
          <div class="form-group">
            <label>法人番号</label>
            <input type="text" id="edit-corporate-number" placeholder="1234567890123">
          </div>
          <div class="form-group">
            <label>郵便番号</label>
            <input type="text" id="edit-postcode" placeholder="123-4567">
          </div>
          <div class="form-group">
            <label>都道府県</label>
            <input type="text" id="edit-pref" placeholder="東京都">
          </div>
          <div class="form-group">
            <label>市区町村</label>
            <input type="text" id="edit-city" placeholder="渋谷区">
          </div>
          <div class="form-group full">
            <label>住所</label>
            <input type="text" id="edit-address1" placeholder="道玄坂1-2-3">
          </div>
          <div class="form-group full">
            <label>建物名</label>
            <input type="text" id="edit-address2" placeholder="○○ビル3F">
          </div>
          <div class="form-group">
            <label>業種</label>
            <input type="text" id="edit-industry" placeholder="飲食業">
          </div>
          <div class="form-group">
            <label>Webサイト</label>
            <input type="url" id="edit-website" placeholder="https://example.com">
          </div>
          <div class="form-group full">
            <label>備考</label>
            <textarea id="edit-notes" rows="3" placeholder="備考"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditModal()">キャンセル</button>
        <button class="btn btn-primary" id="save-btn" onclick="saveClient()">保存</button>
      </div>
    </div>
  </div>
</main>

<style>
  .client-detail-page {
    background: #f8f8f8;
    min-height: 100vh;
    padding: 24px 0;
  }
  .container {
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
    padding: 0 24px;
  }
  
  /* ヘッダー */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
  }
  .header-left {
    display: flex;
    align-items: flex-start;
    gap: 16px;
  }
  .back-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: #fff;
    border-radius: 8px;
    color: #374151;
    text-decoration: none;
  }
  .back-link:hover { background: var(--primary); color: #fff; }
  .breadcrumb {
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 4px;
  }
  .breadcrumb .label {
    background: #e0e7ff;
    color: #3730a3;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .header-title h1 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 4px 0 0;
  }
  .header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }
  .status-badge.active { background: #d1fae5; color: #065f46; }
  .status-badge.pending { background: #fef3c7; color: #92400e; }
  .status-badge.corporate { background: #dbeafe; color: #1e40af; }
  .status-badge.individual { background: #fce7f3; color: #9d174d; }
  
  /* 関連ページへのリンク */
  .hierarchy-links {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
  }
  .hierarchy-link-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    background: #fff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px 24px;
    cursor: pointer;
    transition: all 0.2s;
    flex: 1;
    max-width: 300px;
  }
  .hierarchy-link-btn:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .hierarchy-link-btn i {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
  }
  .hierarchy-link-btn.brands-btn i {
    background: #fce7f3;
    color: var(--primary);
  }
  .hierarchy-link-btn.stores-btn i {
    background: #d1fae5;
    color: #059669;
  }
  .link-content {
    display: flex;
    flex-direction: column;
  }
  .link-label {
    font-size: 0.75rem;
    color: #6b7280;
  }
  .link-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: #111827;
    margin-top: 2px;
  }
  
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-secondary { background: #fff; color: #374151; border: 1px solid #e5e7eb; }
  .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

  /* タブカード */
  .tab-cards {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
  }
  .tab-card {
    background: #fff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
  }
  .tab-card:hover { border-color: var(--primary); }
  .tab-card.active { border-color: var(--primary); }
  .tab-label { font-weight: 600; color: #374151; }
  .tab-badge {
    background: var(--primary);
    color: #fff;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  /* 2カラムレイアウト */
  .main-layout {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 24px;
  }
  @media (max-width: 1024px) {
    .main-layout { grid-template-columns: 1fr; }
  }

  /* セクションカード */
  .section-card {
    background: #fff;
    border-radius: 12px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
  }
  .section-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #111827;
  }
  .section-dot {
    width: 10px;
    height: 10px;
    background: var(--primary);
    border-radius: 50%;
  }
  .section-dot.warning { background: #f59e0b; }
  .section-toggle {
    color: #9ca3af;
    transition: transform 0.2s;
  }
  .section-body {
    padding: 20px;
  }
  .section-body.collapsed { display: none; }
  .section-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid #f0f0f0;
  }
  .btn-outline {
    padding: 10px 32px;
    border: 2px solid var(--primary);
    background: #fff;
    color: var(--primary);
    border-radius: 24px;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-link {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 0.9rem;
    cursor: pointer;
  }
  .btn-link.center { display: block; margin: 16px auto 0; }

  /* 情報リスト */
  .info-list {
    display: flex;
    flex-direction: column;
  }
  .info-row {
    display: flex;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
  }
  .info-row:last-child { border-bottom: none; }
  .info-row label {
    width: 140px;
    flex-shrink: 0;
    font-size: 0.85rem;
    color: #6b7280;
  }
  .info-row span {
    flex: 1;
    font-size: 0.95rem;
    color: #111827;
  }

  /* 担当者リスト */
  .contacts-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .contact-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
  }
  .contact-avatar {
    width: 40px;
    height: 40px;
    background: var(--primary);
    color: #fff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
  }
  .contact-info { flex: 1; }
  .contact-name { font-weight: 600; color: #111827; }
  .contact-role { font-size: 0.85rem; color: #6b7280; }

  /* 営業メモ */
  .sales-info {
    background: #faf5ff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }
  .notes-box {
    margin-top: 16px;
  }
  .notes-box label {
    font-size: 0.85rem;
    color: #6b7280;
    display: block;
    margin-bottom: 8px;
  }
  .notes-content {
    background: #f9fafb;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.9rem;
    color: #374151;
    white-space: pre-wrap;
  }

  /* リストカード */
  .list-card, .stats-card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  .list-header h3, .stats-card h3 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0;
    color: #111827;
  }

  /* ブランドリスト */
  .brand-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .brand-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
    background: #f9fafb;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .brand-item:hover {
    background: #f3f4f6;
    transform: translateX(4px);
  }
  .brand-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--primary), #f472b6);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1.2rem;
  }
  .brand-info { flex: 1; }
  .brand-name { font-weight: 600; color: #111827; }
  .brand-stores { font-size: 0.85rem; color: #6b7280; }
  .brand-arrow { color: #9ca3af; }

  /* 統計グリッド */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-top: 16px;
  }
  .stat-item {
    text-align: center;
    padding: 16px;
    background: #f9fafb;
    border-radius: 10px;
  }
  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
  }
  .stat-label {
    font-size: 0.8rem;
    color: #6b7280;
    margin-top: 4px;
  }

  /* 契約情報 */
  .contract-info {
    display: flex;
    flex-direction: column;
  }

  .loading {
    text-align: center;
    padding: 24px;
    color: #9ca3af;
  }
  .empty-state {
    text-align: center;
    padding: 24px;
    color: #9ca3af;
    font-size: 0.9rem;
  }

  @media (max-width: 768px) {
    .page-header { flex-direction: column; gap: 16px; }
    .tab-cards { flex-direction: column; }
    .stats-grid { grid-template-columns: 1fr; }
  }
  
  /* 編集モーダル */
  .edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
  }
  .modal-content {
    position: relative;
    background: #fff;
    border-radius: 16px;
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
  }
  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: #fff;
    font-weight: 700;
  }
  .modal-close {
    background: rgba(255,255,255,0.2);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 1.5rem;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }
  .modal-close:hover {
    background: rgba(255,255,255,0.3);
  }
  .modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }
  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
  }
  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .form-group.full {
    grid-column: 1 / -1;
  }
  .form-group label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #374151;
  }
  .form-group label .required {
    color: #ef4444;
  }
  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 10px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
  }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }
  .btn-primary {
    background: #3b82f6;
    color: #fff;
    border: none;
    padding: 10px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }
  .btn-primary:hover {
    background: #2563eb;
  }
  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  @media (max-width: 600px) {
    .form-grid {
      grid-template-columns: 1fr;
    }
    .modal-content {
      width: 95%;
      max-height: 95vh;
    }
  }
</style>

<script>
(function() {
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  
  let clientData = null;
  let allBrands = [];
  let allStores = [];
  let allSchedules = [];

  const urlParams = new URLSearchParams(window.location.search);
  const clientId = urlParams.get('id');

  if (!clientId) {
    document.getElementById('client-name').textContent = '企業が指定されていません';
    return;
  }

  document.addEventListener('DOMContentLoaded', loadAllData);

  async function loadAllData() {
    try {
      const [clientsRes, brandsRes, storesRes, schedulesRes] = await Promise.all([
        fetch(`${API_BASE}/clients`).catch(() => ({ ok: false })),
        fetch(`${API_BASE}/brands`).catch(() => ({ ok: false })),
        fetch(`${API_BASE}/stores`).catch(() => ({ ok: false })),
        fetch(`${API_BASE}/schedules`).catch(() => ({ ok: false }))
      ]);

      let clients = [];
      let brands = [];
      let stores = [];
      let schedules = [];
      
      if (clientsRes.ok) {
        const clientsData = await clientsRes.json();
        clients = Array.isArray(clientsData) ? clientsData : (clientsData.items || clientsData.clients || []);
      } else {
        console.warn('Failed to load clients');
      }
      
      if (brandsRes.ok) {
        const brandsData = await brandsRes.json();
        brands = Array.isArray(brandsData) ? brandsData : (brandsData.items || brandsData.brands || []);
      } else {
        console.warn('Failed to load brands');
      }
      
      if (storesRes.ok) {
        const storesData = await storesRes.json();
        stores = Array.isArray(storesData) ? storesData : (storesData.items || storesData.stores || []);
      } else {
        console.warn('Failed to load stores');
      }
      
      if (schedulesRes.ok) {
        const schedulesData = await schedulesRes.json();
        schedules = Array.isArray(schedulesData) ? schedulesData : (schedulesData.items || schedulesData.schedules || []);
      } else {
        console.warn('Failed to load schedules');
      }

      // EntityFinderを使用してID形式の違いに対応
      if (window.DataUtils?.EntityFinder?.findClient) {
        clientData = window.DataUtils.EntityFinder.findClient(clients, clientId);
      } else {
        clientData = clients.find(c => String(c.id) === String(clientId));
      }
      if (!clientData) {
        document.getElementById('client-name').textContent = '企業が見つかりません';
        return;
      }

      // この企業に属するブランド（IdUtils.isSameを使用）
      if (window.DataUtils?.IdUtils?.isSame) {
        allBrands = brands.filter(b => window.DataUtils.IdUtils.isSame(b.client_id, clientId));
      } else {
        allBrands = brands.filter(b => String(b.client_id) === String(clientId));
      }
      
      // この企業に属する店舗（ブランド経由、IdUtils.isSameを使用）
      const brandIds = allBrands.map(b => String(b.id));
      if (window.DataUtils?.IdUtils?.isSame) {
        allStores = stores.filter(s => brandIds.some(bid => window.DataUtils.IdUtils.isSame(s.brand_id, bid)));
      } else {
        allStores = stores.filter(s => brandIds.includes(String(s.brand_id)));
      }
      
      // この企業の店舗のスケジュール（IdUtils.isSameを使用）
      const storeIds = allStores.map(s => String(s.id));
      if (window.DataUtils?.IdUtils?.isSame) {
        allSchedules = schedules.filter(s => storeIds.some(sid => window.DataUtils.IdUtils.isSame(s.store_id, sid)));
      } else {
        allSchedules = schedules.filter(s => storeIds.includes(String(s.store_id)));
      }

      renderAll();

    } catch (error) {
      console.error('Failed to load data:', error);
      document.getElementById('client-name').textContent = '読み込みに失敗しました';
    }
  }

  function renderAll() {
    renderHeader();
    renderClientInfo();
    renderBrands();
    renderStats();
    updateBadges();
    
    // ロール別の権限を適用
    if (window.RolePermissions) {
      window.RolePermissions.applyPermissions();
    }
  }

  function renderHeader() {
    document.getElementById('client-name').textContent = clientData.name || '名称未設定';
    
    const statusEl = document.getElementById('client-status');
    const typeLabel = clientData.type === 'corporate' ? '法人' : '個人';
    statusEl.textContent = typeLabel;
    statusEl.className = 'status-badge ' + (clientData.type || 'individual');
  }

  function renderClientInfo() {
    const infoFields = [
      { label: '企業名/氏名', value: clientData.name },
      { label: '企業名カナ', value: clientData.name_kana },
      { label: '種別', value: clientData.type === 'corporate' ? '法人' : '個人' },
      { label: '代表者名', value: clientData.representative },
      { label: '電話番号', value: clientData.phone },
      { label: 'メールアドレス', value: clientData.email },
      { label: '郵便番号', value: clientData.postcode },
      { label: '住所', value: [clientData.pref, clientData.city, clientData.address1].filter(Boolean).join('') },
      { label: '建物名', value: clientData.address2 },
      { label: '法人番号', value: clientData.corporate_number },
      { label: '設立年月日', value: clientData.established_date },
      { label: '資本金', value: clientData.capital ? `${Number(clientData.capital).toLocaleString()}円` : null },
      { label: '従業員数', value: clientData.employees ? `${clientData.employees}名` : null },
      { label: '業種', value: clientData.industry },
      { label: 'Webサイト', value: clientData.website },
    ];

    const container = document.getElementById('client-info-list');
    container.innerHTML = infoFields
      .filter(f => f.value)
      .map(f => `
        <div class="info-row">
          <label>${f.label}</label>
          <span>${escapeHtml(String(f.value))}</span>
        </div>
      `).join('');

    // 営業メモ
    document.getElementById('sales-rep').textContent = clientData.sales_rep || '-';
    document.getElementById('lead-status').textContent = clientData.lead_status || '-';
    document.getElementById('probability').textContent = clientData.probability || '-';
    document.getElementById('notes-content').textContent = clientData.notes || '-';
  }

  function renderBrands() {
    const container = document.getElementById('brand-list');
    
    if (allBrands.length === 0) {
      container.innerHTML = '<div class="empty-state">ブランドがありません</div>';
      return;
    }

    container.innerHTML = allBrands.map(brand => {
      // IdUtils.isSameを使用してID形式の違いに対応
      let storeCount = 0;
      if (window.DataUtils?.IdUtils?.isSame) {
        storeCount = allStores.filter(s => window.DataUtils.IdUtils.isSame(s.brand_id, brand.id)).length;
      } else {
        storeCount = allStores.filter(s => String(s.brand_id) === String(brand.id)).length;
      }
      return `
        <div class="brand-item" onclick="viewBrand('${brand.id}')">
          <div class="brand-icon"><i class="fas fa-store"></i></div>
          <div class="brand-info">
            <div class="brand-name">${escapeHtml(brand.name || '名称未設定')}</div>
            <div class="brand-stores">${storeCount}店舗</div>
          </div>
          <div class="brand-arrow"><i class="fas fa-chevron-right"></i></div>
        </div>
      `;
    }).join('');
  }

  function renderStats() {
    document.getElementById('stat-brands').textContent = allBrands.length;
    document.getElementById('stat-stores').textContent = allStores.length;
    document.getElementById('stat-schedules').textContent = allSchedules.length;
    
    // リンクカードの更新
    document.getElementById('brands-link-count').textContent = `${allBrands.length} ブランド`;
    document.getElementById('stores-link-count').textContent = `${allStores.length} 店舗`;
  }

  function updateBadges() {
    document.getElementById('brands-badge').textContent = allBrands.length;
  }
  
  // リンクカードのクリック
  document.getElementById('brands-link-btn').addEventListener('click', () => {
    switchTab('brands');
  });
  
  document.getElementById('stores-link-btn').addEventListener('click', () => {
    // 店舗一覧へ（この企業でフィルター）
    window.location.href = `/admin/customers/?client=${clientId}`;
  });

  // タブ切り替え
  window.switchTab = function(tabName) {
    document.querySelectorAll('.tab-card').forEach(card => {
      card.classList.toggle('active', card.dataset.tab === tabName);
    });

    document.getElementById('brands-panel').style.display = tabName === 'brands' || tabName === 'info' ? 'block' : 'none';
    document.getElementById('contracts-panel').style.display = tabName === 'contracts' ? 'block' : 'none';
  };

  // セクション開閉
  window.toggleSection = function(sectionId) {
    const body = document.getElementById('section-' + sectionId);
    const toggle = document.getElementById('toggle-' + sectionId);
    body.classList.toggle('collapsed');
    if (toggle) {
      toggle.style.transform = body.classList.contains('collapsed') ? 'rotate(0deg)' : 'rotate(180deg)';
    }
  };

  window.viewBrand = function(brandId) {
    window.location.href = `/admin/customers/brands/detail.html?id=${brandId}`;
  };

  window.editClient = function() {
    openEditModal();
  };
  
  function openEditModal() {
    const modal = document.getElementById('edit-modal');
    if (!modal) return;
    
    document.getElementById('edit-name').value = clientData.name || '';
    document.getElementById('edit-name-kana').value = clientData.name_kana || '';
    document.getElementById('edit-type').value = clientData.type || 'individual';
    document.getElementById('edit-representative').value = clientData.representative || '';
    document.getElementById('edit-phone').value = clientData.phone || '';
    document.getElementById('edit-email').value = clientData.email || '';
    document.getElementById('edit-postcode').value = clientData.postcode || '';
    document.getElementById('edit-pref').value = clientData.pref || '';
    document.getElementById('edit-city').value = clientData.city || '';
    document.getElementById('edit-address1').value = clientData.address1 || '';
    document.getElementById('edit-address2').value = clientData.address2 || '';
    document.getElementById('edit-corporate-number').value = clientData.corporate_number || '';
    document.getElementById('edit-industry').value = clientData.industry || '';
    document.getElementById('edit-website').value = clientData.website || '';
    document.getElementById('edit-notes').value = clientData.notes || '';
    
    modal.style.display = 'flex';
  }
  
  window.closeEditModal = function() {
    document.getElementById('edit-modal').style.display = 'none';
  };
  
  window.saveClient = async function() {
    const saveBtn = document.getElementById('save-btn');
    saveBtn.disabled = true;
    saveBtn.textContent = '保存中...';
    
    try {
      const updatedData = {
        ...clientData,
        name: document.getElementById('edit-name').value,
        name_kana: document.getElementById('edit-name-kana').value,
        type: document.getElementById('edit-type').value,
        representative: document.getElementById('edit-representative').value,
        phone: document.getElementById('edit-phone').value,
        email: document.getElementById('edit-email').value,
        postcode: document.getElementById('edit-postcode').value,
        pref: document.getElementById('edit-pref').value,
        city: document.getElementById('edit-city').value,
        address1: document.getElementById('edit-address1').value,
        address2: document.getElementById('edit-address2').value,
        corporate_number: document.getElementById('edit-corporate-number').value,
        industry: document.getElementById('edit-industry').value,
        website: document.getElementById('edit-website').value,
        notes: document.getElementById('edit-notes').value,
        updated_at: new Date().toISOString()
      };
      
      const response = await fetch(`${API_BASE}/clients/${clientId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedData)
      });
      
      if (!response.ok) throw new Error('保存に失敗しました');
      
      clientData = updatedData;
      renderHeader();
      renderClientInfo();
      closeEditModal();
      
      alert('保存しました');
    } catch (error) {
      console.error('Save error:', error);
      alert('保存に失敗しました: ' + error.message);
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = '保存';
    }
  };

  window.addBrand = function() {
    alert('ブランド追加機能は準備中です');
  };

  window.addContact = function() {
    alert('担当者追加機能は準備中です');
  };

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
})();
</script>
