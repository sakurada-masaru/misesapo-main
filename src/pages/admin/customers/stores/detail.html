@layout('layouts.base')
@json('data/meta/admin_stores_title.json', $title)
@json('data/meta/admin_stores_body_class.json', $body_class)

<style>
  #default-header-wrapper,
  #normal-header-wrapper {
    display: none !important;
  }
</style>

<main id="main" class="store-detail-page">
  <div class="container">
    <!-- ヘッダー -->
    <div class="page-header">
      <div class="header-left">
        <a href="/admin/customers/" class="back-link">
          <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-title">
          <div class="enhanced-breadcrumb" id="breadcrumb">
            <div class="breadcrumb-item">
              <a href="/admin/customers/" class="breadcrumb-link">
                <i class="fas fa-home"></i> 顧客管理
              </a>
            </div>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <div class="breadcrumb-item">
              <a href="#" class="client-name breadcrumb-link" id="client-link">-</a>
            </div>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <div class="breadcrumb-item">
              <a href="#" class="brand-name breadcrumb-link" id="brand-link">-</a>
            </div>
            <i class="fas fa-chevron-right breadcrumb-separator"></i>
            <div class="breadcrumb-item">
              <span class="store-name breadcrumb-current">-</span>
            </div>
          </div>
          <h1 id="store-name">読み込み中...</h1>
        </div>
      </div>
      <div class="header-actions">
        <span class="status-badge" id="store-status">-</span>
        <a href="#" id="input-karte-link" class="btn btn-secondary">
          <i class="fas fa-edit"></i> 清掃カルテ入力
        </a>
        <a href="#" id="premium-karte-link" class="btn btn-secondary" style="color: #2563eb; border-color: #2563eb;">
          <i class="fas fa-heartbeat"></i> プレミアムカルテ
        </a>
        <button class="btn btn-secondary" onclick="editStore()" data-permission="can_edit">
          <i class="fas fa-cog"></i> 店舗情報編集
        </button>
      </div>
    </div>

    <!-- 法人・ブランドへのリンクボタン -->
    <div class="hierarchy-links" id="hierarchy-links">
      <a href="#" class="hierarchy-link-btn client-btn" id="client-btn">
        <i class="fas fa-building"></i>
        <span class="link-label">法人情報</span>
        <span class="link-name" id="client-btn-name">-</span>
      </a>
      <a href="#" class="hierarchy-link-btn brand-btn" id="brand-btn">
        <i class="fas fa-tag"></i>
        <span class="link-label">ブランド情報</span>
        <span class="link-name" id="brand-btn-name">-</span>
      </a>
    </div>

    <!-- タブナビゲーション（マイページ風） -->
    <div class="tab-cards">
      <div class="tab-card active" data-tab="info" onclick="switchTab('info')">
        <span class="tab-label">店舗情報</span>
        <span class="tab-badge" id="info-badge"></span>
      </div>
      <div class="tab-card" data-tab="chart" onclick="switchTab('chart')">
        <span class="tab-label">清掃カルテ</span>
        <span class="tab-badge" id="chart-badge"></span>
      </div>
      <div class="tab-card" data-tab="estimates" onclick="switchTab('estimates')" data-permission="estimates">
        <span class="tab-label">見積もり履歴</span>
        <span class="tab-badge" id="estimates-badge">0</span>
      </div>
      <div class="tab-card" data-tab="history" onclick="switchTab('history')">
        <span class="tab-label">作業履歴</span>
        <span class="tab-badge" id="history-badge">0</span>
      </div>
    </div>

    <!-- 2カラムレイアウト -->
    <div class="main-layout">
      <!-- 左カラム：店舗情報 -->
      <div class="left-column">

        <!-- 店舗情報セクション -->
        <div class="section-card">
          <div class="section-header" onclick="toggleSection('store-info')">
            <div class="section-title">
              <span class="section-dot"></span>
              店舗情報確認/変更
            </div>
            <i class="fas fa-chevron-down section-toggle" id="toggle-store-info"></i>
          </div>
          <div class="section-body" id="section-store-info">
            <div class="info-list" id="store-info-list">
              <!-- 動的に挿入 -->
            </div>
            <div class="section-actions">
              <button class="btn-outline" onclick="editStore()">修正する</button>
              <button class="btn-link" onclick="toggleSection('store-info')">∧ 閉じる</button>
            </div>
          </div>
        </div>

        <!-- 提出資料セクション（管理者・顧客のみ） -->
        <div class="section-card" data-permission="store_documents">
          <div class="section-header" onclick="toggleSection('documents')">
            <div class="section-title">
              <span class="section-dot"></span>
              提出資料
            </div>
            <i class="fas fa-chevron-down section-toggle" id="toggle-documents"></i>
          </div>
          <div class="section-body collapsed" id="section-documents">
            <div class="documents-grid" id="documents-grid">
              <!-- 責任者情報 -->
              <div class="doc-item">
                <div class="doc-header">
                  <i class="fas fa-check-circle doc-check"></i>
                  <span>統括管理責任者</span>
                  <button class="doc-edit"><i class="fas fa-pen"></i></button>
                </div>
                <div class="doc-value" id="doc-manager">-</div>
              </div>
              <div class="doc-item">
                <div class="doc-header">
                  <i class="fas fa-check-circle doc-check"></i>
                  <span>衛生管理責任者</span>
                  <button class="doc-edit"><i class="fas fa-pen"></i></button>
                </div>
                <div class="doc-value" id="doc-hygiene">-</div>
              </div>
              <!-- 契約書・図面 -->
              <div class="doc-item doc-file">
                <div class="doc-header">
                  <i class="fas fa-check-circle doc-check inactive"></i>
                  <span>賃貸借契約書</span>
                </div>
                <div class="doc-preview" id="doc-contract">
                  <div class="doc-placeholder"><i class="fas fa-file-alt"></i></div>
                </div>
                <button class="btn-upload"><i class="fas fa-upload"></i> 変更する</button>
              </div>
              <div class="doc-item doc-file">
                <div class="doc-header">
                  <i class="fas fa-check-circle doc-check inactive"></i>
                  <span>段階図面</span>
                </div>
                <div class="doc-preview" id="doc-floor-plan">
                  <div class="doc-placeholder"><i class="fas fa-drafting-compass"></i></div>
                </div>
                <button class="btn-upload"><i class="fas fa-upload"></i> 変更する</button>
              </div>
              <div class="doc-item doc-file">
                <div class="doc-header">
                  <i class="fas fa-check-circle doc-check inactive"></i>
                  <span>電気配線図</span>
                </div>
                <div class="doc-preview" id="doc-wiring">
                  <div class="doc-placeholder"><i class="fas fa-bolt"></i></div>
                </div>
                <button class="btn-upload"><i class="fas fa-upload"></i> 変更する</button>
              </div>
            </div>
            <button class="btn-link center" onclick="toggleSection('documents')">∧ 閉じる</button>
          </div>
        </div>

        <!-- 営業メモセクション（管理者・営業のみ） -->
        <div class="section-card admin-only" data-permission="store_sales_notes">
          <div class="section-header" onclick="toggleSection('sales-notes')">
            <div class="section-title">
              <span class="section-dot warning"></span>
              営業メモ・注意事項
            </div>
            <i class="fas fa-chevron-down section-toggle" id="toggle-sales-notes"></i>
          </div>
          <div class="section-body collapsed" id="section-sales-notes">
            <div class="sales-info">
              <div class="info-row">
                <label>営業担当</label>
                <span id="sales-rep">-</span>
              </div>
              <div class="info-row">
                <label>商談ステータス</label>
                <span id="lead-status">-</span>
              </div>
              <div class="info-row">
                <label>見込み度</label>
                <span id="probability">-</span>
              </div>
            </div>
            <div class="notes-box">
              <label>営業メモ</label>
              <div class="notes-content" id="sales-notes-content">-</div>
            </div>
            <div class="caution-box">
              <label><i class="fas fa-exclamation-triangle"></i> 注意事項</label>
              <div class="caution-content" id="caution-content">-</div>
            </div>
          </div>
        </div>

        <!-- 定期発注セクション -->
        <div class="section-card">
          <div class="section-header">
            <div class="section-title">定期発注</div>
          </div>
          <div class="section-body">
            <div class="frequency-list" id="frequency-list">
              <div class="freq-item"><span class="freq-dot"></span> 毎月</div>
              <div class="freq-item"><span class="freq-dot"></span> 2ヶ月</div>
              <div class="freq-item"><span class="freq-dot"></span> 3ヶ月</div>
              <div class="freq-item"><span class="freq-dot"></span> 6ヶ月</div>
              <div class="freq-item"><span class="freq-dot"></span> 毎年</div>
            </div>
          </div>
        </div>

      </div>

      <!-- 右カラム：カレンダー＋予定 -->
      <div class="right-column">

        <!-- カレンダー -->
        <div class="calendar-card">
          <div class="calendar-header">
            <button class="cal-nav" onclick="prevMonth()"><i class="fas fa-chevron-left"></i></button>
            <span class="cal-title" id="calendar-title">2025 06</span>
            <button class="cal-nav" onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
          </div>
          <div class="calendar-weekdays">
            <span>M</span><span>T</span><span>W</span><span>T</span><span>F</span><span>S</span><span>S</span>
          </div>
          <div class="calendar-grid" id="calendar-grid">
            <!-- 動的に生成 -->
          </div>
          <div class="calendar-legend">
            <span class="legend-item"><span class="legend-dot scheduled"></span> 清掃予定</span>
            <span class="legend-item"><span class="legend-dot completed"></span> 清掃完了</span>
          </div>
        </div>

        <!-- 清掃予定 -->
        <div class="schedule-card" id="schedule-panel">
          <h3>清掃予定</h3>
          <div class="schedule-list" id="upcoming-schedules">
            <div class="loading">読み込み中...</div>
          </div>
          <button class="btn-primary-full" onclick="viewAllSchedules()">全て見る</button>
        </div>

        <!-- 見積もり履歴（タブ切替時表示） -->
        <div class="schedule-card" id="estimates-panel" style="display:none;">
          <h3>見積もり履歴</h3>
          <div class="schedule-list" id="estimates-list">
            <div class="loading">読み込み中...</div>
          </div>
        </div>

        <!-- 作業履歴（タブ切替時表示） -->
        <div class="schedule-card" id="history-panel" style="display:none;">
          <h3>作業レポート</h3>
          <div class="schedule-list" id="reports-list">
            <div class="loading">読み込み中...</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- 編集モーダル -->
  <div class="edit-modal" id="edit-modal" style="display:none;">
    <div class="modal-overlay" onclick="closeEditModal()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>店舗情報編集</h2>
        <button class="modal-close" onclick="closeEditModal()">×</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <div class="form-group full">
            <label>店舗名 <span class="required">*</span></label>
            <input type="text" id="edit-name" placeholder="店舗名">
          </div>
          <div class="form-group">
            <label>店舗名カナ</label>
            <input type="text" id="edit-name-kana" placeholder="テンポメイカナ">
          </div>
          <div class="form-group">
            <label>担当者名</label>
            <input type="text" id="edit-contact" placeholder="担当者名">
          </div>
          <div class="form-group">
            <label>電話番号</label>
            <input type="tel" id="edit-phone" placeholder="03-1234-5678">
          </div>
          <div class="form-group">
            <label>メールアドレス</label>
            <input type="email" id="edit-email" placeholder="store@example.com">
          </div>
          <div class="form-group">
            <label>郵便番号</label>
            <input type="text" id="edit-postcode" placeholder="123-4567">
          </div>
          <div class="form-group">
            <label>都道府県</label>
            <input type="text" id="edit-pref" placeholder="東京都">
          </div>
          <div class="form-group">
            <label>市区町村</label>
            <input type="text" id="edit-city" placeholder="渋谷区">
          </div>
          <div class="form-group">
            <label>住所</label>
            <input type="text" id="edit-address1" placeholder="道玄坂1-2-3">
          </div>
          <div class="form-group full">
            <label>建物名</label>
            <input type="text" id="edit-address2" placeholder="○○ビル3F">
          </div>
          <div class="form-group">
            <label>営業時間</label>
            <input type="text" id="edit-business-hours" placeholder="11:00-23:00">
          </div>
          <div class="form-group">
            <label>定休日</label>
            <input type="text" id="edit-holidays" placeholder="月曜日">
          </div>
          <div class="form-group">
            <label>清掃可能時間</label>
            <input type="text" id="edit-cleaning-hours" placeholder="9:00-11:00">
          </div>
          <div class="form-group">
            <label>業種・業態</label>
            <input type="text" id="edit-category" placeholder="居酒屋">
          </div>
          <div class="form-group">
            <label>ステータス</label>
            <select id="edit-status">
              <option value="active">稼働中</option>
              <option value="contract_pending">契約作業中</option>
              <option value="considering">検討中</option>
              <option value="prospect">アプローチ前</option>
              <option value="negotiated">商談済</option>
              <option value="lost">失注</option>
              <option value="suspended">休止中</option>
              <option value="terminated">契約終了</option>
            </select>
          </div>
          <div class="form-group full">
            <label>備考</label>
            <textarea id="edit-notes" rows="3" placeholder="備考"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeEditModal()">キャンセル</button>
        <button class="btn btn-primary" id="save-btn" onclick="saveStore()">保存</button>
      </div>
    </div>
  </div>
</main>

<style>
  .store-detail-page {
    background: #f8f8f8;
    min-height: 100vh;
    padding: 24px 0;
  }

  .container {
    max-width: 100%;
    width: 100%;
    margin: 0 auto;
    padding: 0 24px;
  }

  /* ヘッダー */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 24px;
  }

  .header-left {
    display: flex;
    align-items: flex-start;
    gap: 16px;
  }

  .back-link {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: #fff;
    border-radius: 8px;
    color: #374151;
    text-decoration: none;
  }

  .back-link:hover {
    background: var(--primary);
    color: #fff;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.8rem;
    color: #6b7280;
    margin-bottom: 4px;
  }

  .breadcrumb i {
    font-size: 0.6rem;
  }

  .breadcrumb-link {
    color: #3b82f6;
    text-decoration: none;
    transition: color 0.2s;
  }

  .breadcrumb-link:hover {
    color: var(--primary);
    text-decoration: underline;
  }

  /* 法人・ブランドへのリンクボタン */
  .hierarchy-links {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
  }

  .hierarchy-link-btn {
    display: flex;
    align-items: center;
    gap: 12px;
    background: #fff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px 24px;
    text-decoration: none;
    transition: all 0.2s;
    flex: 1;
    max-width: 300px;
  }

  .hierarchy-link-btn:hover {
    border-color: var(--primary);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .hierarchy-link-btn i {
    font-size: 1.5rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
  }

  .hierarchy-link-btn.client-btn i {
    background: #dbeafe;
    color: #2563eb;
  }

  .hierarchy-link-btn.brand-btn i {
    background: #fce7f3;
    color: var(--primary);
  }

  .link-label {
    font-size: 0.75rem;
    color: #6b7280;
    display: block;
  }

  .link-name {
    font-size: 0.95rem;
    font-weight: 600;
    color: #111827;
    display: block;
    margin-top: 2px;
  }

  .header-title h1 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .status-badge {
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  .status-badge.active {
    background: #d1fae5;
    color: #065f46;
  }

  .status-badge.pending {
    background: #fef3c7;
    color: #92400e;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-secondary {
    background: #fff;
    color: #374151;
    border: 1px solid #e5e7eb;
  }

  /* タブカード */
  .tab-cards {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
  }

  .tab-card {
    background: #fff;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 16px 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.2s;
  }

  .tab-card:hover {
    border-color: var(--primary);
  }

  .tab-card.active {
    border-color: var(--primary);
    background: #fff;
  }

  .tab-label {
    font-weight: 600;
    color: #374151;
  }

  .tab-badge {
    background: var(--primary);
    color: #fff;
    padding: 2px 10px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
  }

  /* 2カラムレイアウト */
  .main-layout {
    display: grid;
    grid-template-columns: 1fr 380px;
    gap: 24px;
  }

  @media (max-width: 1024px) {
    .main-layout {
      grid-template-columns: 1fr;
    }
  }

  /* セクションカード */
  .section-card {
    background: #fff;
    border-radius: 12px;
    margin-bottom: 16px;
    overflow: hidden;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
  }

  .section-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: #111827;
  }

  .section-dot {
    width: 10px;
    height: 10px;
    background: var(--primary);
    border-radius: 50%;
  }

  .section-dot.warning {
    background: #f59e0b;
  }

  .section-toggle {
    color: #9ca3af;
    transition: transform 0.2s;
  }

  .section-body {
    padding: 20px;
  }

  .section-body.collapsed {
    display: none;
  }

  .section-actions {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid #f0f0f0;
  }

  .btn-outline {
    padding: 10px 32px;
    border: 2px solid var(--primary);
    background: #fff;
    color: var(--primary);
    border-radius: 24px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-link {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 0.9rem;
    cursor: pointer;
  }

  .btn-link.center {
    display: block;
    margin: 16px auto 0;
  }

  /* 情報リスト */
  .info-list {
    display: flex;
    flex-direction: column;
  }

  .info-row {
    display: flex;
    padding: 12px 0;
    border-bottom: 1px solid #f5f5f5;
  }

  .info-row:last-child {
    border-bottom: none;
  }

  .info-row label {
    width: 140px;
    flex-shrink: 0;
    font-size: 0.85rem;
    color: #6b7280;
  }

  .info-row span {
    flex: 1;
    font-size: 0.95rem;
    color: #111827;
  }

  /* 提出資料グリッド */
  .documents-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }

  .doc-item {
    background: #f9fafb;
    border-radius: 10px;
    padding: 16px;
  }

  .doc-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .doc-check {
    color: var(--primary);
  }

  .doc-check.inactive {
    color: #d1d5db;
  }

  .doc-header span {
    font-weight: 600;
    font-size: 0.9rem;
    flex: 1;
  }

  .doc-edit {
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
  }

  .doc-value {
    font-size: 0.95rem;
    color: #374151;
  }

  .doc-file {
    text-align: center;
  }

  .doc-preview {
    height: 100px;
    background: #fff;
    border: 1px dashed #d1d5db;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 12px 0;
  }

  .doc-placeholder {
    color: #d1d5db;
    font-size: 2rem;
  }

  .btn-upload {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 0.85rem;
    cursor: pointer;
  }

  /* 営業メモ */
  .sales-info {
    background: #faf5ff;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .notes-box,
  .caution-box {
    margin-top: 16px;
  }

  .notes-box label,
  .caution-box label {
    font-size: 0.85rem;
    color: #6b7280;
    display: block;
    margin-bottom: 8px;
  }

  .notes-content,
  .caution-content {
    background: #f9fafb;
    padding: 12px;
    border-radius: 8px;
    font-size: 0.9rem;
    color: #374151;
    white-space: pre-wrap;
  }

  .caution-box label {
    color: #dc2626;
  }

  .caution-box label i {
    margin-right: 6px;
  }

  .caution-content {
    background: #fef2f2;
    color: #991b1b;
  }

  /* 定期発注 */
  .frequency-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .freq-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    font-size: 0.95rem;
    color: #374151;
  }

  .freq-dot {
    width: 12px;
    height: 12px;
    border: 2px solid #d1d5db;
    border-radius: 50%;
  }

  .freq-dot.active {
    background: var(--primary);
    border-color: var(--primary);
  }

  /* カレンダー */
  .calendar-card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .cal-nav {
    background: none;
    border: none;
    color: #6b7280;
    cursor: pointer;
    padding: 8px;
  }

  .cal-title {
    font-weight: 700;
    font-size: 1.1rem;
  }

  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    font-size: 0.8rem;
    color: #9ca3af;
    margin-bottom: 8px;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  .cal-day {
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    border-radius: 50%;
    cursor: pointer;
  }

  .cal-day:hover {
    background: #f3f4f6;
  }

  .cal-day.today {
    background: var(--primary);
    color: #fff;
  }

  .cal-day.has-schedule::after {
    content: '';
    position: absolute;
    bottom: 2px;
    width: 4px;
    height: 4px;
    background: var(--primary);
    border-radius: 50%;
  }

  .cal-day.other-month {
    color: #d1d5db;
  }

  .calendar-legend {
    display: flex;
    gap: 16px;
    margin-top: 16px;
    font-size: 0.8rem;
    color: #6b7280;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .legend-dot.scheduled {
    background: var(--primary);
  }

  .legend-dot.completed {
    background: #10b981;
  }

  /* スケジュールカード */
  .schedule-card {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
  }

  .schedule-card h3 {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 16px;
    color: #111827;
  }

  .schedule-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
  }

  .schedule-item {
    background: #f9fafb;
    border-radius: 10px;
    padding: 16px;
    border-left: 4px solid var(--primary);
  }

  .schedule-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 4px;
  }

  .schedule-date {
    font-weight: 600;
    color: #111827;
  }

  .schedule-time {
    font-size: 0.85rem;
    color: #6b7280;
  }

  .schedule-type {
    font-size: 0.85rem;
    color: #6b7280;
  }

  .schedule-link {
    color: var(--primary);
    font-size: 0.85rem;
    text-decoration: none;
  }

  .btn-primary-full {
    width: 100%;
    padding: 12px;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }

  .loading {
    text-align: center;
    padding: 24px;
    color: #9ca3af;
  }

  .empty-state {
    text-align: center;
    padding: 24px;
    color: #9ca3af;
    font-size: 0.9rem;
  }

  @media (max-width: 768px) {
    .page-header {
      flex-direction: column;
      gap: 16px;
    }

    .tab-cards {
      flex-direction: column;
    }

    .documents-grid {
      grid-template-columns: 1fr;
    }

    .info-row {
      flex-direction: column;
      gap: 4px;
    }

    .info-row label {
      width: auto;
    }
  }

  /* 編集モーダル */
  .edit-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    position: relative;
    background: #fff;
    border-radius: 16px;
    width: 90%;
    max-width: 700px;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    border-bottom: 1px solid #e5e7eb;
    background: linear-gradient(135deg, var(--primary) 0%, #f472b6 100%);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.25rem;
    color: #fff;
    font-weight: 700;
  }

  .modal-close {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    width: 32px;
    height: 32px;
    border-radius: 50%;
    font-size: 1.5rem;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }

  .modal-close:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  .modal-body {
    padding: 24px;
    overflow-y: auto;
    flex: 1;
  }

  .modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    padding: 16px 24px;
    border-top: 1px solid #e5e7eb;
    background: #f9fafb;
  }

  .form-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-group.full {
    grid-column: 1 / -1;
  }

  .form-group label {
    font-size: 0.85rem;
    font-weight: 600;
    color: #374151;
  }

  .form-group label .required {
    color: #ef4444;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 10px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: border-color 0.2s;
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
  }

  .btn-primary {
    background: var(--primary);
    color: #fff;
    border: none;
    padding: 10px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
  }

  .btn-primary:hover {
    opacity: 0.9;
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  @media (max-width: 600px) {
    .form-grid {
      grid-template-columns: 1fr;
    }

    .modal-content {
      width: 95%;
      max-height: 95vh;
    }
  }
</style>

<script>
  (function () {
    const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';

    let storeData = null;
    let clientData = null;
    let brandData = null;
    let allSchedules = [];
    let allEstimates = [];
    let allReports = [];
    let currentMonth = new Date();

    const urlParams = new URLSearchParams(window.location.search);
    const storeId = urlParams.get('id');

    if (!storeId) {
      document.getElementById('store-name').textContent = '店舗が指定されていません';
      return;
    }

    document.addEventListener('DOMContentLoaded', loadAllData);

    async function loadAllData() {
      try {
        const [storesRes, clientsRes, brandsRes, schedulesRes, estimatesRes, reportsRes] = await Promise.all([
          fetch(`${API_BASE}/stores`).catch(() => ({ ok: false })),
          fetch(`${API_BASE}/clients`).catch(() => ({ ok: false })),
          fetch(`${API_BASE}/brands`).catch(() => ({ ok: false })),
          fetch(`${API_BASE}/schedules`).catch(() => ({ ok: false })),
          fetch(`${API_BASE}/estimates`).catch(() => ({ ok: false })),
          fetch(`${API_BASE}/reports`).catch(() => ({ ok: false }))
        ]);

        let stores = [];
        let clients = [];
        let brands = [];
        let schedules = [];
        let estimates = [];
        let reports = [];

        if (storesRes.ok) {
          const storesData = await storesRes.json();
          stores = Array.isArray(storesData) ? storesData : (storesData.items || storesData.stores || []);
        } else {
          console.warn('Failed to load stores');
        }

        if (clientsRes.ok) {
          const clientsData = await clientsRes.json();
          clients = Array.isArray(clientsData) ? clientsData : (clientsData.items || clientsData.clients || []);
        } else {
          console.warn('Failed to load clients');
        }

        if (brandsRes.ok) {
          const brandsData = await brandsRes.json();
          brands = Array.isArray(brandsData) ? brandsData : (brandsData.items || brandsData.brands || []);
        } else {
          console.warn('Failed to load brands');
        }

        if (schedulesRes.ok) {
          const schedulesData = await schedulesRes.json();
          schedules = Array.isArray(schedulesData) ? schedulesData : (schedulesData.items || schedulesData.schedules || []);
        } else {
          console.warn('Failed to load schedules');
        }

        if (estimatesRes.ok) {
          const estimatesData = await estimatesRes.json();
          estimates = Array.isArray(estimatesData) ? estimatesData : (estimatesData.items || estimatesData.estimates || []);
        } else {
          console.warn('Failed to load estimates');
        }

        if (reportsRes.ok) {
          const reportsData = await reportsRes.json();
          reports = Array.isArray(reportsData) ? reportsData : (reportsData.items || reportsData.reports || []);
        } else {
          console.warn('Failed to load reports');
        }

        // EntityFinderを使用してID形式の違いに対応
        if (window.DataUtils?.EntityFinder?.findStore) {
          storeData = window.DataUtils.EntityFinder.findStore(stores, storeId);
        } else {
          storeData = stores.find(s => String(s.id) === String(storeId));
        }
        if (!storeData) {
          document.getElementById('store-name').textContent = '店舗が見つかりません';
          return;
        }

        // EntityFinderを使用してID形式の違いに対応
        if (window.DataUtils?.EntityFinder?.findBrand) {
          brandData = window.DataUtils.EntityFinder.findBrand(brands, storeData.brand_id);
        } else {
          brandData = brands.find(b => b.id === storeData.brand_id || String(b.id) === String(storeData.brand_id));
        }
        if (brandData) {
          if (window.DataUtils?.EntityFinder?.findClient) {
            clientData = window.DataUtils.EntityFinder.findClient(clients, brandData.client_id);
          } else {
            clientData = clients.find(c => c.id === brandData.client_id || String(c.id) === String(brandData.client_id));
          }
        }

        // この店舗のデータをフィルター（DataUtilsで新旧両方のID形式に対応）
        allSchedules = DataUtils.filterByStoreId(schedules, storeId);
        allEstimates = DataUtils.filterByStoreId(estimates, storeId);
        allReports = DataUtils.filterByStoreId(reports, storeId);

        renderAll();

      } catch (error) {
        console.error('Failed to load data:', error);
        document.getElementById('store-name').textContent = '読み込みに失敗しました';
      }
    }

    function renderAll() {
      renderHeader();
      renderStoreInfo();
      renderDocuments();
      renderSalesNotes();
      renderCalendar();
      renderUpcomingSchedules();
      updateBadges();

      // ロール別の権限を適用
      if (window.RolePermissions) {
        window.RolePermissions.applyPermissions();
      }
    }

    function renderHeader() {
      document.getElementById('store-name').textContent = storeData.name || '名称未設定';

      const breadcrumb = document.getElementById('breadcrumb');
      const clientNameEl = document.getElementById('client-link');
      const brandNameEl = document.getElementById('brand-link');
      const storeNameEl = breadcrumb.querySelector('.store-name');

      // パンくずリストの動的表示（データがある場合のみ表示）
      const separators = breadcrumb.querySelectorAll('.fa-chevron-right');

      // 法人・ブランドリンクボタン
      const hierarchyLinks = document.getElementById('hierarchy-links');
      const clientBtn = document.getElementById('client-btn');
      const brandBtn = document.getElementById('brand-btn');
      const clientBtnName = document.getElementById('client-btn-name');
      const brandBtnName = document.getElementById('brand-btn-name');

      if (clientData?.name) {
        clientNameEl.textContent = clientData.name;
        clientNameEl.href = `/admin/customers/clients/detail.html?id=${clientData.id}`;
        clientNameEl.style.display = '';
        separators[0].style.display = '';

        // リンクボタン
        clientBtn.href = `/admin/customers/clients/detail.html?id=${clientData.id}`;
        clientBtnName.textContent = clientData.name;
        clientBtn.style.display = 'flex';
      } else {
        clientNameEl.style.display = 'none';
        separators[0].style.display = 'none';
        clientBtn.style.display = 'none';
      }

      if (brandData?.name) {
        brandNameEl.textContent = brandData.name;
        brandNameEl.href = `/admin/customers/brands/detail.html?id=${brandData.id}`;
        brandNameEl.style.display = '';
        separators[1].style.display = '';

        // リンクボタン
        brandBtn.href = `/admin/customers/brands/detail.html?id=${brandData.id}`;
        brandBtnName.textContent = brandData.name;
        brandBtn.style.display = 'flex';
      } else {
        brandNameEl.style.display = 'none';
        separators[1].style.display = 'none';
        brandBtn.style.display = 'none';
      }

      // 両方ない場合はリンクセクション自体を非表示
      if (!clientData?.name && !brandData?.name) {
        hierarchyLinks.style.display = 'none';
      }

      storeNameEl.textContent = storeData.name || '';

      const statusEl = document.getElementById('store-status');
      const statusLabels = {
        active: '稼働中', suspended: '休止中', terminated: '契約終了',
        pending_customer_info: '情報入力待ち', pending_approval: '承認待ち',
        contract_pending: '契約作業中', considering: '検討中',
        prospect: 'アプローチ前', negotiated: '商談済', lost: '失注'
      };
      statusEl.textContent = statusLabels[storeData.status] || storeData.status || '未設定';
      statusEl.className = 'status-badge ' + (storeData.status || 'pending');
    }

    function renderStoreInfo() {
      const infoFields = [
        { label: '店名', value: storeData.name },
        { label: '店名カナ', value: storeData.name_kana },
        { label: '担当者名', value: storeData.contact_person },
        { label: '電話番号', value: storeData.phone },
        { label: '店舗メールアドレス', value: storeData.email || storeData.report_email },
        { label: '営業時間', value: storeData.business_hours },
        { label: '定休日', value: storeData.holidays },
        { label: '清掃可能時間', value: storeData.cleaning_hours },
        { label: '業種・業態', value: storeData.category || storeData.business_type },
        { label: '建物の築年数', value: storeData.building_age },
        { label: '現店舗の営業年数', value: storeData.store_age },
        { label: '店舗の広さ', value: storeData.area },
        { label: '天井の高さ', value: storeData.ceiling_height },
        { label: '郵便番号', value: storeData.postcode },
        { label: '住所', value: [storeData.pref, storeData.city, storeData.address1].filter(Boolean).join('') },
        { label: '建物名', value: storeData.address2 || storeData.building },
        { label: '清掃備品シンク', value: storeData.has_sink ? 'はい' : 'いいえ' },
        { label: '駐車場', value: storeData.has_parking ? 'はい' : 'いいえ' },
        { label: '鍵の受け渡し方法', value: storeData.key_method },
        { label: '', value: storeData.key_detail || storeData.key_note },
        { label: 'ミセサポからの通知', value: storeData.notify_enabled ? 'はい' : 'いいえ' },
        { label: 'メールマガジン', value: storeData.newsletter_enabled ? 'はい' : 'いいえ' },
      ];

      const container = document.getElementById('store-info-list');
      container.innerHTML = infoFields
        .filter(f => f.value)
        .map(f => `
        <div class="info-row">
          <label>${f.label}</label>
          <span>${escapeHtml(String(f.value))}</span>
        </div>
      `).join('');
    }

    function renderDocuments() {
      document.getElementById('doc-manager').textContent = storeData.manager || '-';
      document.getElementById('doc-hygiene').textContent = storeData.hygiene_manager || '-';
    }

    function renderSalesNotes() {
      document.getElementById('sales-rep').textContent = storeData.sales_rep || '-';

      const leadLabels = { initial: '初回接触', negotiating: '商談中', proposal: '提案済み', pending: '検討中' };
      document.getElementById('lead-status').textContent = leadLabels[storeData.lead_status] || storeData.lead_status || '-';

      const probLabels = { high: '高（80%以上）', medium: '中（50%程度）', low: '低（30%以下）' };
      document.getElementById('probability').textContent = probLabels[storeData.probability] || storeData.probability || '-';

      document.getElementById('sales-notes-content').textContent = storeData.notes || storeData.sales_notes || '-';
      document.getElementById('caution-content').textContent = storeData.caution || storeData.attention || '-';
    }

    function renderCalendar() {
      const year = currentMonth.getFullYear();
      const month = currentMonth.getMonth();

      document.getElementById('calendar-title').textContent = `${year} ${String(month + 1).padStart(2, '0')}`;

      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDay = (firstDay.getDay() + 6) % 7; // Monday = 0

      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const scheduleDates = allSchedules.map(s => s.scheduled_date);

      let html = '';

      // Previous month days
      const prevMonthLast = new Date(year, month, 0).getDate();
      for (let i = startDay - 1; i >= 0; i--) {
        html += `<div class="cal-day other-month">${prevMonthLast - i}</div>`;
      }

      // Current month days
      for (let d = 1; d <= lastDay.getDate(); d++) {
        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const isToday = new Date(year, month, d).getTime() === today.getTime();
        const hasSchedule = scheduleDates.includes(dateStr);

        let classes = 'cal-day';
        if (isToday) classes += ' today';
        if (hasSchedule) classes += ' has-schedule';

        html += `<div class="${classes}" style="position:relative">${d}</div>`;
      }

      // Next month days
      const remaining = 42 - (startDay + lastDay.getDate());
      for (let d = 1; d <= remaining; d++) {
        html += `<div class="cal-day other-month">${d}</div>`;
      }

      document.getElementById('calendar-grid').innerHTML = html;
    }

    function renderUpcomingSchedules() {
      const container = document.getElementById('upcoming-schedules');
      const today = new Date().toISOString().split('T')[0];

      const upcoming = allSchedules
        .filter(s => s.scheduled_date >= today)
        .sort((a, b) => a.scheduled_date.localeCompare(b.scheduled_date))
        .slice(0, 5);

      if (upcoming.length === 0) {
        container.innerHTML = '<div class="empty-state">予定された清掃はありません</div>';
        return;
      }

      container.innerHTML = upcoming.map(s => {
        const date = new Date(s.scheduled_date);
        const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
        const dateStr = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日(${dayNames[date.getDay()]})`;

        return `
        <div class="schedule-item">
          <div class="schedule-item-header">
            <span class="schedule-date">${dateStr}</span>
            <a href="#" class="schedule-link">詳細へ ></a>
          </div>
          <div class="schedule-time">${s.scheduled_time || ''}</div>
          <div class="schedule-type">${s.notes || 'スポット発注'}</div>
        </div>
      `;
      }).join('');
    }

    function updateBadges() {
      document.getElementById('estimates-badge').textContent = allEstimates.length;
      document.getElementById('history-badge').textContent = allReports.length;
    }

    // タブ切り替え
    window.switchTab = function (tabName) {
      document.querySelectorAll('.tab-card').forEach(card => {
        card.classList.toggle('active', card.dataset.tab === tabName);
      });

      // パネル表示切り替え
      document.getElementById('schedule-panel').style.display = tabName === 'info' ? 'block' : 'none';
      document.getElementById('estimates-panel').style.display = tabName === 'estimates' ? 'block' : 'none';
      document.getElementById('history-panel').style.display = tabName === 'history' ? 'block' : 'none';

      // カルテタブの処理
      if (tabName === 'chart') {
        // カルテページへリダイレクト（テンプレートパスにクエリを付与して404を回避）
        const storeId = new URLSearchParams(window.location.search).get('id');
        if (storeId) {
          const encodedId = encodeURIComponent(storeId);
          window.location.href = `/admin/customers/stores/[id]/chart.html?id=${encodedId}`;
        }
      }

      if (tabName === 'estimates') loadEstimates();
      if (tabName === 'history') loadReports();
    };

    function loadEstimates() {
      const container = document.getElementById('estimates-list');
      if (allEstimates.length === 0) {
        container.innerHTML = '<div class="empty-state">見積もり履歴がありません</div>';
        return;
      }

      const statusLabels = { pending: '未処理', processing: '作成中', completed: '完了', rejected: '却下' };
      container.innerHTML = allEstimates.map(e => {
        const date = new Date(e.created_at);
        return `
        <div class="schedule-item">
          <div class="schedule-item-header">
            <span class="schedule-date">${date.toLocaleDateString('ja-JP')}</span>
            <span class="schedule-link">${statusLabels[e.status] || e.status}</span>
          </div>
          <div class="schedule-type">¥${(e.total_amount || e.total || 0).toLocaleString()}</div>
        </div>
      `;
      }).join('');
    }

    function loadReports() {
      const container = document.getElementById('reports-list');
      if (allReports.length === 0) {
        container.innerHTML = '<div class="empty-state">作業レポートがありません</div>';
        return;
      }

      container.innerHTML = allReports.slice(0, 10).map(r => {
        const date = new Date(r.created_at || r.work_date);
        return `
        <div class="schedule-item">
          <div class="schedule-item-header">
            <span class="schedule-date">${date.toLocaleDateString('ja-JP')}</span>
            <span class="schedule-link">完了</span>
          </div>
          <div class="schedule-type">${r.content || r.work_content || '作業完了'}</div>
        </div>
      `;
      }).join('');
    }

    // セクション開閉
    window.toggleSection = function (sectionId) {
      const body = document.getElementById('section-' + sectionId);
      const toggle = document.getElementById('toggle-' + sectionId);
      body.classList.toggle('collapsed');
      if (toggle) {
        toggle.style.transform = body.classList.contains('collapsed') ? 'rotate(0deg)' : 'rotate(180deg)';
      }
    };

    // カレンダーナビゲーション
    window.prevMonth = function () {
      currentMonth.setMonth(currentMonth.getMonth() - 1);
      renderCalendar();
    };

    window.nextMonth = function () {
      currentMonth.setMonth(currentMonth.getMonth() + 1);
      renderCalendar();
    };

    window.editStore = function () {
      // 編集モーダルを開く
      openEditModal();
    };

    function openEditModal() {
      const modal = document.getElementById('edit-modal');
      if (!modal) return;

      // フォームに現在のデータを入力
      document.getElementById('edit-name').value = storeData.name || '';
      document.getElementById('edit-name-kana').value = storeData.name_kana || '';
      document.getElementById('edit-contact').value = storeData.contact_person || '';
      document.getElementById('edit-phone').value = storeData.phone || '';
      document.getElementById('edit-email').value = storeData.email || storeData.report_email || '';
      document.getElementById('edit-postcode').value = storeData.postcode || '';
      document.getElementById('edit-pref').value = storeData.pref || '';
      document.getElementById('edit-city').value = storeData.city || '';
      document.getElementById('edit-address1').value = storeData.address1 || '';
      document.getElementById('edit-address2').value = storeData.address2 || storeData.building || '';
      document.getElementById('edit-business-hours').value = storeData.business_hours || '';
      document.getElementById('edit-holidays').value = storeData.holidays || '';
      document.getElementById('edit-cleaning-hours').value = storeData.cleaning_hours || '';
      document.getElementById('edit-category').value = storeData.category || storeData.business_type || '';
      document.getElementById('edit-notes').value = storeData.notes || '';
      document.getElementById('edit-status').value = storeData.status || 'active';

      modal.style.display = 'flex';
    }

    window.closeEditModal = function () {
      document.getElementById('edit-modal').style.display = 'none';
    };

    window.saveStore = async function () {
      const saveBtn = document.getElementById('save-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = '保存中...';

      try {
        const updatedData = {
          ...storeData,
          name: document.getElementById('edit-name').value,
          name_kana: document.getElementById('edit-name-kana').value,
          contact_person: document.getElementById('edit-contact').value,
          phone: document.getElementById('edit-phone').value,
          email: document.getElementById('edit-email').value,
          postcode: document.getElementById('edit-postcode').value,
          pref: document.getElementById('edit-pref').value,
          city: document.getElementById('edit-city').value,
          address1: document.getElementById('edit-address1').value,
          address2: document.getElementById('edit-address2').value,
          business_hours: document.getElementById('edit-business-hours').value,
          holidays: document.getElementById('edit-holidays').value,
          cleaning_hours: document.getElementById('edit-cleaning-hours').value,
          category: document.getElementById('edit-category').value,
          notes: document.getElementById('edit-notes').value,
          status: document.getElementById('edit-status').value,
          updated_at: new Date().toISOString()
        };

        const response = await fetch(`${API_BASE}/stores/${storeId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData)
        });

        if (!response.ok) throw new Error('保存に失敗しました');

        // データを更新して再描画
        storeData = updatedData;
        renderHeader();
        renderStoreInfo();
        closeEditModal();

        alert('保存しました');
      } catch (error) {
        console.error('Save error:', error);
        alert('保存に失敗しました: ' + error.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '保存';
      }
    };

    window.viewAllSchedules = function () {
      window.location.href = `/admin/schedules/?store=${storeId}`;
    };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Update Premium Karte Link
    const premiumKarteLink = document.getElementById('premium-karte-link');
    if (premiumKarteLink && typeof storeId !== 'undefined') {
      premiumKarteLink.href = `/admin/customers/karte.html?store_id=${encodeURIComponent(storeId)}`;
    }

    // Update Input Karte Link
    const inputKarteLink = document.getElementById('input-karte-link');
    if (inputKarteLink && typeof storeId !== 'undefined') {
      inputKarteLink.href = `/admin/customers/stores/${encodeURIComponent(storeId)}/chart.html`;
    }
  })();
</script>