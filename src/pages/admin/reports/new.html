@layout('layouts.base')
@json('data/meta/admin_reports_new_title.json', $title)
@json('data/meta/admin_reports_new_body_class.json', $body_class)

<main id="main" class="container admin-report-new">
  <div class="page-header">
    <a href="/admin/reports" class="back-btn">
      <i class="fas fa-chevron-left"></i>
      レポート一覧に戻る
    </a>
    <h1 class="page-title">レポート作成</h1>
  </div>

  <form id="report-form" class="report-form">
    <div class="report-container">
      <!-- ヘッダー部分（ピンク背景） -->
      <header class="report-header">
        <div class="report-header-content">
          <div class="form-group-inline">
            <label class="form-label-inline">店舗 <span class="required">*</span></label>
            <select name="store_id" id="store-id" class="form-select-inline" required>
          <option value="">店舗を選択</option>
          <option value="store-001">Darts Bar A's 神楽坂店</option>
          <option value="store-002">大塚店</option>
          <option value="store-003">高円寺店</option>
          <option value="store-004">日本橋茅場町店</option>
        </select>
        <input type="hidden" name="store_name" id="store-name">
      </div>
          <div class="form-group-inline">
            <label class="form-label-inline">清掃日 <span class="required">*</span></label>
            <input type="date" name="cleaning_date" id="cleaning-date" class="form-input-inline" required>
          </div>
          <div class="form-group-inline">
            <label class="form-label-inline">開始時刻</label>
            <input type="time" name="cleaning_start_time" id="cleaning-start-time" class="form-input-inline">
        </div>
          <div class="form-group-inline">
            <label class="form-label-inline">終了時刻</label>
            <input type="time" name="cleaning_end_time" id="cleaning-end-time" class="form-input-inline">
        </div>
        </div>
      </header>
      
      <!-- 実施清掃項目リスト -->
      <div class="items-list-bar">
        <div class="items-list">
          <span class="items-list-label">実施清掃項目</span>
          <div class="items-list-items" id="cleaning-items-list">
            <span class="items-list-empty">項目を追加してください</span>
      </div>
    </div>
        <button type="button" class="btn-add-item" id="add-work-item">
          <i class="fas fa-plus"></i>
          項目を追加
        </button>
      </div>
      
      <!-- 清掃項目の詳細 -->
      <div class="report-main" id="work-items-container">
        <!-- 清掃項目が動的に追加される -->
      </div>
    </div>

    <!-- 送信ボタン -->
    <div class="form-actions">
      <button type="button" class="btn btn-outline btn-block" onclick="window.location.href='/admin/reports'">キャンセル</button>
      <button type="submit" class="btn btn-primary btn-block">
        <i class="fas fa-check-circle"></i>
        レポートを作成
      </button>
    </div>
  </form>

  <style>
    body { background: #f4f7f6; }
    .admin-report-new {
      max-width: 900px;
      margin: 20px auto;
      padding-bottom: 100px;
    }
    .page-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #374151;
      text-decoration: none;
      font-size: 0.95rem;
      padding: 8px 12px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .back-btn:hover {
      background: #f3f4f6;
    }
    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    .report-container {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,.05);
      overflow: hidden;
      margin-bottom: 20px;
    }
    .report-header {
      background: #FF679C;
      color: #fff;
      padding: 16px 24px;
    }
    .report-header-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .form-group-inline {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .form-label-inline {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      min-width: 80px;
    }
    .form-select-inline,
    .form-input-inline {
      flex: 1;
      min-width: 150px;
      padding: 8px 12px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.9);
      color: #333;
      font-size: 0.95rem;
    }
    .form-select-inline:focus,
    .form-input-inline:focus {
      outline: none;
      border-color: #fff;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
    }
    .required {
      color: #fff;
      font-weight: 700;
    }
    .items-list-bar {
      background: #f9f9f9;
      padding: 12px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }
    .items-list {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      flex: 1;
    }
    .items-list-label {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }
    .items-list-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .items-list-item {
      font-size: 0.9rem;
      color: #333;
      padding: 6px 12px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
    }
    .items-list-empty {
      font-size: 0.9rem;
      color: #999;
      font-style: italic;
    }
    .btn-add-item {
      padding: 8px 16px;
      background: #FF679C;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }
    .btn-add-item:hover {
      background: #e55a8a;
    }
    .cleaning-section {
      padding: 24px;
      border-bottom: 1px solid #eee;
    }
    .cleaning-section:last-child {
      border-bottom: none;
    }
    .item-header {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .item-title-input {
      flex: 1;
      min-width: 200px;
      font-size: 1.6rem;
      font-weight: 600;
      color: #222;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #fff;
    }
    .item-title-input:focus {
      outline: none;
      border-color: #FF679C;
      box-shadow: 0 0 0 3px rgba(255, 103, 156, 0.1);
    }
    .item-details {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding-top: 5px;
    }
    .detail-tag-input {
      padding: 6px 12px;
      background: #f0f4f8;
      color: #555;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    .detail-tag-input:focus {
      outline: none;
      border-color: #FF679C;
      background: #fff;
    }
    .subsection {
      margin-top: 20px;
    }
    .subsection-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #333;
      padding-bottom: 5px;
      margin-top: 25px;
      margin-bottom: 15px;
    }
    .subsection textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
    }
    .subsection textarea:focus {
      outline: none;
      border-color: #FF679C;
      box-shadow: 0 0 0 3px rgba(255, 103, 156, 0.1);
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 20px;
    }
    .image-category {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .image-category-title {
      font-size: 1rem;
      font-weight: 600;
      color: #444;
      margin: 0;
      text-align: center;
      width: 100%;
    }
    .image-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      width: 100%;
      max-width: 100%;
    }
    .image-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ccc;
      background: #fafafa;
    }
    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-upload-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      cursor: pointer;
      transition: all 0.2s;
    }
    .image-upload-btn:hover {
      background: #ffffff;
      border-color: #FF679C;
    }
    .image-upload-btn input[type="file"] {
      display: none;
    }
    .image-upload-btn i {
      font-size: 2rem;
      color: #FF679C;
      margin-bottom: 8px;
    }
    .image-upload-btn span {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .image-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 32px;
      height: 32px;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .item-remove-btn {
      padding: 8px 16px;
      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .item-remove-btn:hover {
      background: #dc2626;
    }
    .form-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 16px;
      display: flex;
      gap: 12px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      z-index: 100;
    }
    .form-actions .btn {
      flex: 1;
    }
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background: #FF679C;
      color: #ffffff;
    }
    .btn-primary:hover {
      background: #e55a8a;
    }
    .btn-outline {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    .btn-outline:hover {
      background: #f9fafb;
    }
    .btn-block {
      width: 100%;
    }
    @media (max-width: 768px) {
      .admin-report-new {
        margin: 0;
        padding: 16px;
        padding-bottom: 100px;
      }
      .report-container {
        margin: 0;
        border-radius: 0;
        border-left: none;
        border-right: none;
      }
      .report-header-content {
        gap: 10px;
      }
      .form-group-inline {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
      }
      .form-label-inline {
        min-width: auto;
      }
      .form-select-inline,
      .form-input-inline {
        width: 100%;
      }
      .items-list-bar {
        flex-direction: column;
        align-items: flex-start;
        padding: 15px;
      }
      .cleaning-section {
        padding: 20px 15px;
      }
      .item-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      .item-title-input {
        width: 100%;
        font-size: 1.4rem;
      }
      .image-grid {
        grid-template-columns: 1fr;
      }
      .image-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>

  <script>
    // APIエンドポイント
    const API_BASE_URL = 'https://2z0ui5xfxb.execute-api.ap-northeast-1.amazonaws.com/prod';
    
    // Firebase認証からIDトークンを取得
    async function getFirebaseIdToken() {
      try {
        if (!window.FirebaseAuth) {
          console.warn('[Reports] Firebase Auth is not available, using mock token');
          return 'mock-token';
        }
        const currentUser = window.FirebaseAuth.currentUser;
        if (!currentUser) {
          console.warn('[Reports] No authenticated user, using mock token');
          return 'mock-token';
        }
        const idToken = await currentUser.getIdToken();
        return idToken;
      } catch (error) {
        console.error('[Reports] Error getting Firebase ID token:', error);
        return 'mock-token';
      }
    }

    // 利用可能な清掃項目
    const availableWorkItems = [
      { id: 'grease-trap', name: 'グリストラップ' },
      { id: 'range-hood', name: 'レンジフード清掃' },
      { id: 'floor', name: '床清掃' },
      { id: 'toilet', name: 'トイレ清掃' },
      { id: 'duct', name: 'ダクト清掃' },
      { id: 'aircon', name: 'エアコン分解洗浄' }
    ];

    let workItemCounter = 0;

    // 画像の最適化
    function optimizeImage(file, maxWidth = 800, quality = 0.8) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob(resolve, 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Base64に変換
    function blobToBase64(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    // 清掃項目リストを更新
    function updateCleaningItemsList() {
      const container = document.getElementById('cleaning-items-list');
      const items = document.querySelectorAll('.cleaning-section');
      
      if (items.length === 0) {
        container.innerHTML = '<span class="items-list-empty">項目を追加してください</span>';
        return;
      }
      
      const itemNames = Array.from(items).map(section => {
        const input = section.querySelector('.item-title-input');
        return input ? input.value || '未入力' : '未入力';
      }).filter(name => name !== '未入力');
      
      if (itemNames.length === 0) {
        container.innerHTML = '<span class="items-list-empty">項目を追加してください</span>';
        return;
      }
      
      container.innerHTML = itemNames.map(name => 
        `<span class="items-list-item">${name}</span>`
      ).join('');
    }

    // 清掃項目を追加
    function addWorkItem(itemId = null, itemName = null) {
      workItemCounter++;
      const container = document.getElementById('work-items-container');
      const itemIdValue = itemId || `work-item-${workItemCounter}`;
      const itemNameValue = itemName || '';
      
      const workItemSection = document.createElement('section');
      workItemSection.className = 'cleaning-section';
      workItemSection.dataset.itemId = itemIdValue;
      workItemSection.innerHTML = `
        <div class="item-header">
          <input type="text" class="item-title-input" placeholder="清掃項目名（例: グリストラップ）" value="${itemNameValue}" data-item-id="${itemIdValue}">
          <div class="item-details">
            <input type="text" class="detail-tag-input" placeholder="タイプ（例: 床置き型）" style="width: 150px;">
            <input type="text" class="detail-tag-input" placeholder="個数（例: 2個）" style="width: 100px;">
          </div>
          <button type="button" class="item-remove-btn" onclick="removeWorkItem('${itemIdValue}')">
            <i class="fas fa-trash"></i>
            削除
          </button>
        </div>
        <div class="subsection">
          <h4 class="subsection-title">作業内容</h4>
          <textarea class="work-item-content" placeholder="作業内容を入力してください"></textarea>
        </div>
        <div class="image-grid">
          <div class="image-category">
            <h4 class="image-category-title">作業前</h4>
            <div class="image-list" data-category="before" data-item-id="${itemIdValue}">
              <div class="image-item">
                <label class="image-upload-btn">
                  <input type="file" accept="image/*" multiple data-category="before" data-item-id="${itemIdValue}" />
                  <i class="fas fa-camera"></i>
                  <span>写真を追加</span>
                </label>
              </div>
            </div>
          </div>
          <div class="image-category">
            <h4 class="image-category-title">作業後</h4>
            <div class="image-list" data-category="after" data-item-id="${itemIdValue}">
              <div class="image-item">
                <label class="image-upload-btn">
                  <input type="file" accept="image/*" multiple data-category="after" data-item-id="${itemIdValue}" />
                  <i class="fas fa-camera"></i>
                  <span>写真を追加</span>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="subsection">
          <h4 class="subsection-title">作業メモ</h4>
          <textarea class="work-item-memo" placeholder="特記事項を入力してください"></textarea>
        </div>
      `;
      
      container.appendChild(workItemSection);
      
      // タイトル入力のイベントリスナー（リスト更新用）
      const titleInput = workItemSection.querySelector('.item-title-input');
      titleInput.addEventListener('input', updateCleaningItemsList);
      
      // 写真アップロードのイベントリスナー
      workItemSection.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', handlePhotoUpload);
      });
      
      updateCleaningItemsList();
    }

    // 清掃項目を削除
    function removeWorkItem(itemId) {
      const section = document.querySelector(`[data-item-id="${itemId}"]`);
      if (section && confirm('この清掃項目を削除しますか？')) {
        section.remove();
        updateCleaningItemsList();
      }
    }

    // 写真アップロード処理
    async function handlePhotoUpload(e) {
      const files = Array.from(e.target.files);
      if (files.length === 0) {
        return;
      }
      
      const photoGrid = e.target.closest('.image-list');
      const category = photoGrid.dataset.category;
      const itemId = photoGrid.dataset.itemId;
      
      for (const file of files) {
        if (!file.type.startsWith('image/')) {
          continue;
        }
        
        try {
          const optimizedBlob = await optimizeImage(file, 800, 0.8);
          const base64 = await blobToBase64(optimizedBlob);
          
          const photoItem = document.createElement('div');
          photoItem.className = 'image-item';
          photoItem.innerHTML = `
            <img src="${base64}" alt="Uploaded photo">
            <button type="button" class="image-remove" onclick="removePhoto(this)">
              <i class="fas fa-times"></i>
            </button>
          `;
          
          const uploadBtn = e.target.closest('.image-item');
          uploadBtn.parentNode.insertBefore(photoItem, uploadBtn);
          
          photoItem.dataset.base64 = base64;
        } catch (error) {
          console.error('Error uploading photo:', error);
          alert(`写真「${file.name}」のアップロードに失敗しました`);
        }
      }
      
      // ファイル入力をリセット（同じファイルを再度選択できるように）
      e.target.value = '';
    }

    // 写真を削除
    function removePhoto(button) {
      const photoItem = button.closest('.image-item');
      photoItem.remove();
    }

    // 店舗選択の変更
    document.getElementById('store-id')?.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      document.getElementById('store-name').value = selectedOption.text;
    });

    // 項目を追加ボタン
    document.getElementById('add-work-item')?.addEventListener('click', function() {
      addWorkItem();
    });

    // フォーム送信
    document.getElementById('report-form')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const formData = {
          store_id: document.getElementById('store-id').value,
          store_name: document.getElementById('store-name').value,
          cleaning_date: document.getElementById('cleaning-date').value,
          cleaning_start_time: document.getElementById('cleaning-start-time').value,
          cleaning_end_time: document.getElementById('cleaning-end-time').value,
          work_items: []
        };
        
        // 清掃項目を収集
        document.querySelectorAll('.cleaning-section').forEach(section => {
          const itemId = section.dataset.itemId;
          const titleInput = section.querySelector('.item-title-input');
          const itemName = titleInput.value.trim();
          
          if (!itemName) {
            return;
          }
          
          const detailInputs = section.querySelectorAll('.detail-tag-input');
          const type = detailInputs[0]?.value.trim() || '';
          const count = detailInputs[1]?.value.trim() || '';
          
          const workItem = {
            item_id: itemId,
            item_name: itemName,
            details: {
              type: type,
              count: count
            },
            work_content: section.querySelector('.work-item-content').value.trim(),
            work_memo: section.querySelector('.work-item-memo').value.trim(),
            photos: {
              before: [],
              after: []
            }
          };
          
          // 作業前の写真
          section.querySelectorAll('[data-category="before"] .image-item img').forEach(img => {
            const photoItem = img.closest('.image-item');
            if (photoItem.dataset.base64) {
              workItem.photos.before.push(photoItem.dataset.base64);
            }
          });
          
          // 作業後の写真
          section.querySelectorAll('[data-category="after"] .image-item img').forEach(img => {
            const photoItem = img.closest('.image-item');
            if (photoItem.dataset.base64) {
              workItem.photos.after.push(photoItem.dataset.base64);
            }
          });
          
          formData.work_items.push(workItem);
        });
        
        // バリデーション
        if (!formData.store_id) {
          alert('店舗を選択してください');
          return;
        }
        
        if (!formData.cleaning_date) {
          alert('清掃日を入力してください');
          return;
        }
        
        if (formData.work_items.length === 0) {
          alert('少なくとも1つの清掃項目を追加してください');
          return;
        }
        
        // APIに送信
        const idToken = await getFirebaseIdToken();
        const response = await fetch(`${API_BASE_URL}/staff/reports`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'レポートの作成に失敗しました');
        }
        
        const result = await response.json();
        alert('レポートを作成しました');
        if (result.report_id) {
          window.location.href = `/reports/${result.report_id}`;
        } else {
          window.location.href = '/admin/reports';
        }
      } catch (error) {
        console.error('Error submitting report:', error);
        alert(`エラー: ${error.message}`);
      }
    });
  </script>
</main>
