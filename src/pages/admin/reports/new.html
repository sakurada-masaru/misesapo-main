@layout('layouts.base')
@json('data/meta/admin_reports_new_title.json', $title)
@json('data/meta/admin_reports_new_body_class.json', $body_class)

<main id="main" class="container admin-report-new">
  <div class="page-header">
    <a href="/admin/reports/" class="back-btn">
      <i class="fas fa-chevron-left"></i>
    </a>
    <h1 class="page-title">レポート作成</h1>
  </div>

  <form id="report-form" class="report-form">
    <!-- 作業情報 -->
    <div class="form-section">
      <h2 class="section-title">作業情報</h2>
      <div class="form-group">
        <label class="form-label">店舗 <span class="required">*</span></label>
        <select name="store_id" id="store-id" class="form-select" required>
          <option value="">店舗を選択</option>
          <option value="store-001">Darts Bar A's 神楽坂店</option>
          <option value="store-002">大塚店</option>
          <option value="store-003">高円寺店</option>
          <option value="store-004">日本橋茅場町店</option>
        </select>
        <input type="hidden" name="store_name" id="store-name">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">清掃日 <span class="required">*</span></label>
          <input type="date" name="cleaning_date" id="cleaning-date" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">開始時刻</label>
          <input type="time" name="cleaning_start_time" id="cleaning-start-time" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">終了時刻</label>
          <input type="time" name="cleaning_end_time" id="cleaning-end-time" class="form-input">
        </div>
      </div>
    </div>

    <!-- 清掃項目 -->
    <div class="form-section">
      <div class="section-header">
        <h2 class="section-title">清掃項目</h2>
        <button type="button" class="btn btn-outline btn-sm" id="add-work-item">
          <i class="fas fa-plus"></i>
          項目を追加
        </button>
      </div>
      <div id="work-items-container">
        <!-- 清掃項目が動的に追加される -->
      </div>
    </div>

    <!-- 位置情報（オプション） -->
    <div class="form-section">
      <h2 class="section-title">位置情報（オプション）</h2>
      <div class="location-info">
        <button type="button" class="btn btn-outline btn-sm" id="get-location">
          <i class="fas fa-map-marker-alt"></i>
          現在位置を取得
        </button>
        <div id="location-display" class="location-display" style="display: none;">
          <span class="location-text">取得済み</span>
        </div>
        <input type="hidden" name="location" id="location-data">
      </div>
    </div>

    <!-- 送信ボタン -->
    <div class="form-actions">
      <button type="button" class="btn btn-outline btn-block" onclick="window.location.href='/admin/reports.html'">キャンセル</button>
      <button type="submit" class="btn btn-primary btn-block">
        <i class="fas fa-check-circle"></i>
        レポートを作成
      </button>
    </div>
  </form>

  <style>
    .admin-report-new {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 100px;
    }
    .page-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #374151;
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover {
      background: #f9fafb;
      border-color: var(--primary);
      color: var(--primary);
    }
    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    .report-form {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .form-section {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group:last-child {
      margin-bottom: 0;
    }
    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 16px;
    }
    .form-label {
      display: block;
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
      margin-bottom: 8px;
    }
    .required {
      color: #ef4444;
    }
    .form-select,
    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
    }
    .form-select:focus,
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 107, 166, 0.1);
    }
    .work-item-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .work-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .work-item-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }
    .work-item-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .work-item-detail {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .work-item-detail label {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .work-item-detail input,
    .work-item-detail textarea {
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .work-item-detail textarea {
      resize: vertical;
      min-height: 60px;
    }
    .photo-upload-section {
      margin-top: 16px;
    }
    .photo-category {
      margin-bottom: 16px;
    }
    .photo-category-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
    }
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .photo-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 32px;
      height: 32px;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .photo-upload-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .photo-upload-btn:hover {
      background: #ffffff;
      border-color: var(--primary);
    }
    .photo-upload-btn input[type="file"] {
      display: none;
    }
    .photo-upload-btn i {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 8px;
    }
    .photo-upload-btn span {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .location-info {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .location-display {
      padding: 12px;
      background: #d1fae5;
      border-radius: 8px;
      color: #065f46;
      font-size: 0.875rem;
    }
    .form-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 16px;
      display: flex;
      gap: 12px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      z-index: 100;
    }
    .form-actions .btn {
      flex: 1;
    }
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background: #FF6BA6;
      color: #ffffff;
    }
    .btn-primary:hover {
      background: #FF5A9A;
    }
    .btn-outline {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    .btn-outline:hover {
      background: #f9fafb;
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.875rem;
    }
    .btn-block {
      width: 100%;
    }
    @media (max-width: 768px) {
      .admin-report-new {
        padding: 12px;
        padding-bottom: 100px;
      }
      .form-section {
        padding: 16px;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
      .work-item-details {
        grid-template-columns: 1fr;
      }
      .photo-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>

  <script>
    // APIエンドポイント
    const API_BASE_URL = 'https://2z0ui5xfxb.execute-api.ap-northeast-1.amazonaws.com/prod';
    
    // Firebase認証からIDトークンを取得
    async function getFirebaseIdToken() {
      try {
        // Firebase Authが利用可能か確認
        if (!window.FirebaseAuth) {
          console.warn('[Reports] Firebase Auth is not available, using mock token');
          return 'mock-token';
        }
        
        // 現在のユーザーを取得
        const currentUser = window.FirebaseAuth.currentUser;
        if (!currentUser) {
          console.warn('[Reports] No authenticated user, using mock token');
          return 'mock-token';
        }
        
        // IDトークンを取得
        const idToken = await currentUser.getIdToken();
        return idToken;
      } catch (error) {
        console.error('[Reports] Error getting Firebase ID token:', error);
        // エラー時はモックトークンを返す（開発環境用）
        return 'mock-token';
      }
    }

    // 利用可能な清掃項目
    const availableWorkItems = [
      { id: 'grease-trap', name: 'グリストラップ' },
      { id: 'range-hood', name: 'レンジフード清掃' },
      { id: 'floor', name: '床清掃' },
      { id: 'toilet', name: 'トイレ清掃' },
      { id: 'duct', name: 'ダクト清掃' },
      { id: 'aircon', name: 'エアコン分解洗浄' }
    ];

    let workItemCounter = 0;

    // 画像の最適化
    function optimizeImage(file, maxWidth = 800, quality = 0.8) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            
            canvas.width = width;
            canvas.height = height;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            
            canvas.toBlob(resolve, 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Base64に変換
    function blobToBase64(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    // 清掃項目を追加
    function addWorkItem(itemId = null, itemName = null) {
      workItemCounter++;
      const container = document.getElementById('work-items-container');
      const itemIdValue = itemId || `work-item-${workItemCounter}`;
      const itemNameValue = itemName || '新しい清掃項目';
      
      const workItemCard = document.createElement('div');
      workItemCard.className = 'work-item-card';
      workItemCard.dataset.itemId = itemIdValue;
      workItemCard.innerHTML = `
        <div class="work-item-header">
          <div class="form-group" style="flex: 1; margin: 0;">
            <select class="form-select work-item-select" data-item-id="${itemIdValue}">
              <option value="">清掃項目を選択</option>
              ${availableWorkItems.map(item => `
                <option value="${item.id}" ${item.id === itemIdValue ? 'selected' : ''}>${item.name}</option>
              `).join('')}
            </select>
          </div>
          <button type="button" class="btn btn-outline btn-sm" onclick="removeWorkItem('${itemIdValue}')">
            <i class="fas fa-trash"></i>
            削除
          </button>
        </div>
        <div class="work-item-details">
          <div class="work-item-detail">
            <label>タイプ</label>
            <input type="text" class="work-item-type" placeholder="例: 床置き型">
          </div>
          <div class="work-item-detail">
            <label>個数</label>
            <input type="number" class="work-item-count" value="1" min="1">
          </div>
          <div class="work-item-detail">
            <label>メモ</label>
            <input type="text" class="work-item-notes" placeholder="例: 少し流れが悪い">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">作業内容</label>
          <textarea class="form-textarea work-item-content" rows="3" placeholder="作業内容を入力してください"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">作業メモ</label>
          <textarea class="form-textarea work-item-memo" rows="3" placeholder="特記事項を入力してください"></textarea>
        </div>
        <div class="photo-upload-section">
          <div class="photo-category">
            <h3 class="photo-category-title">作業前</h3>
            <div class="photo-grid" data-category="before" data-item-id="${itemIdValue}">
              <div class="photo-item">
                <label class="photo-upload-btn">
                  <input type="file" accept="image/*" capture="environment" data-category="before" data-item-id="${itemIdValue}" />
                  <i class="fas fa-camera"></i>
                  <span>写真を追加</span>
                </label>
              </div>
            </div>
          </div>
          <div class="photo-category">
            <h3 class="photo-category-title">作業後</h3>
            <div class="photo-grid" data-category="after" data-item-id="${itemIdValue}">
              <div class="photo-item">
                <label class="photo-upload-btn">
                  <input type="file" accept="image/*" capture="environment" data-category="after" data-item-id="${itemIdValue}" />
                  <i class="fas fa-camera"></i>
                  <span>写真を追加</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(workItemCard);
      
      // 清掃項目選択のイベントリスナー
      const select = workItemCard.querySelector('.work-item-select');
      select.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
          workItemCard.dataset.itemId = selectedOption.value;
          // 写真アップロードのdata-item-idも更新
          workItemCard.querySelectorAll('input[type="file"]').forEach(input => {
            input.dataset.itemId = selectedOption.value;
          });
        }
      });
      
      // 写真アップロードのイベントリスナー
      workItemCard.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', handlePhotoUpload);
      });
    }

    // 清掃項目を削除
    function removeWorkItem(itemId) {
      const card = document.querySelector(`[data-item-id="${itemId}"]`);
      if (card && confirm('この清掃項目を削除しますか？')) {
        card.remove();
      }
    }

    // 写真アップロード処理
    async function handlePhotoUpload(e) {
      const file = e.target.files[0];
      if (!file || !file.type.startsWith('image/')) {
        return;
      }
      
      try {
        // 画像を最適化
        const optimizedBlob = await optimizeImage(file, 800, 0.8);
        const base64 = await blobToBase64(optimizedBlob);
        
        // 写真グリッドを取得
        const photoGrid = e.target.closest('.photo-grid');
        const category = photoGrid.dataset.category;
        const itemId = photoGrid.dataset.itemId;
        
        // 新しい写真アイテムを作成
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        photoItem.innerHTML = `
          <img src="${base64}" alt="Uploaded photo">
          <button type="button" class="photo-remove" onclick="removePhoto(this)">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        // アップロードボタンの前に追加
        const uploadBtn = e.target.closest('.photo-item');
        uploadBtn.parentNode.insertBefore(photoItem, uploadBtn);
        
        // Base64データをdata属性に保存（送信時に使用）
        photoItem.dataset.base64 = base64;
      } catch (error) {
        console.error('Error uploading photo:', error);
        alert('写真のアップロードに失敗しました');
      }
    }

    // 写真を削除
    function removePhoto(button) {
      const photoItem = button.closest('.photo-item');
      photoItem.remove();
    }

    // 店舗選択の変更
    document.getElementById('store-id')?.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      document.getElementById('store-name').value = selectedOption.text;
    });

    // 位置情報を取得
    document.getElementById('get-location')?.addEventListener('click', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };
          document.getElementById('location-data').value = JSON.stringify(locationData);
          document.getElementById('location-display').style.display = 'block';
        });
      } else {
        alert('位置情報が取得できません');
      }
    });

    // 項目を追加ボタン
    document.getElementById('add-work-item')?.addEventListener('click', function() {
      addWorkItem();
    });

    // フォーム送信
    document.getElementById('report-form')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        // フォームデータを収集
        const formData = {
          store_id: document.getElementById('store-id').value,
          store_name: document.getElementById('store-name').value,
          cleaning_date: document.getElementById('cleaning-date').value,
          cleaning_start_time: document.getElementById('cleaning-start-time').value,
          cleaning_end_time: document.getElementById('cleaning-end-time').value,
          work_items: [],
          location: null
        };
        
        // 位置情報
        const locationData = document.getElementById('location-data').value;
        if (locationData) {
          formData.location = JSON.parse(locationData);
        }
        
        // 清掃項目を収集
        document.querySelectorAll('.work-item-card').forEach(card => {
          const itemId = card.dataset.itemId;
          const select = card.querySelector('.work-item-select');
          const selectedOption = select.options[select.selectedIndex];
          
          if (!selectedOption.value) {
            return; // 項目が選択されていない場合はスキップ
          }
          
          const workItem = {
            item_id: selectedOption.value,
            item_name: selectedOption.text,
            details: {
              type: card.querySelector('.work-item-type').value,
              count: parseInt(card.querySelector('.work-item-count').value) || 1,
              notes: card.querySelector('.work-item-notes').value
            },
            work_content: card.querySelector('.work-item-content').value,
            work_memo: card.querySelector('.work-item-memo').value,
            photos: {
              before: [],
              after: []
            }
          };
          
          // 作業前の写真
          card.querySelectorAll('[data-category="before"] .photo-item img').forEach(img => {
            const photoItem = img.closest('.photo-item');
            if (photoItem.dataset.base64) {
              workItem.photos.before.push(photoItem.dataset.base64);
            }
          });
          
          // 作業後の写真
          card.querySelectorAll('[data-category="after"] .photo-item img').forEach(img => {
            const photoItem = img.closest('.photo-item');
            if (photoItem.dataset.base64) {
              workItem.photos.after.push(photoItem.dataset.base64);
            }
          });
          
          formData.work_items.push(workItem);
        });
        
        // バリデーション
        if (!formData.store_id) {
          alert('店舗を選択してください');
          return;
        }
        
        if (!formData.cleaning_date) {
          alert('清掃日を入力してください');
          return;
        }
        
        if (formData.work_items.length === 0) {
          alert('少なくとも1つの清掃項目を追加してください');
          return;
        }
        
        // APIに送信
        const idToken = await getFirebaseIdToken();
        const response = await fetch(`${API_BASE_URL}/staff/reports`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'レポートの作成に失敗しました');
        }
        
        const result = await response.json();
        alert('レポートを作成しました');
        // 作成したレポートの詳細ページにリダイレクト
        if (result.report_id) {
          window.location.href = `/reports/${result.report_id}.html`;
        } else {
          // report_idが取得できない場合はレポート一覧にリダイレクト
          window.location.href = '/admin/reports.html';
        }
      } catch (error) {
        console.error('Error submitting report:', error);
        alert(`エラー: ${error.message}`);
      }
    });

    // 初期化: 1つの清掃項目を追加
    addWorkItem();
  </script>
</main>


