@layout('layouts.admin')
@json('data/meta/admin_reports_title.json', $title)
@json('data/meta/admin_reports_body_class.json', $body_class)

<main id="main" class="admin-reports-v2">
  @include('partials.admin-sidebar')
  <!-- メインコンテンツ -->
  <div class="main-content">
    <!-- トップバー -->
    <header class="topbar">
      <div class="topbar-left">
        <h1>レポート管理</h1>
      </div>
      <div class="topbar-right">
        <button type="button" class="btn btn-outline" id="btn-clear-test" style="margin-right: 12px; background: #fee2e2; color: #dc2626; border-color: #dc2626;">
          <i class="fas fa-trash-alt"></i> テストデータをクリア
        </button>
        <button type="button" class="btn btn-primary" id="btn-new-report">
          <i class="fas fa-plus"></i> 新規作成
        </button>
      </div>
    </header>

    <div class="content-wrapper">

    <!-- 統計カード -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-value" id="stat-total">-</div>
        <div class="stat-label">総レポート数</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-pending">-</div>
        <div class="stat-label">承認待ち</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-approved">-</div>
        <div class="stat-label">承認済み</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-thismonth">-</div>
        <div class="stat-label">今月</div>
      </div>
    </div>

    <!-- フィルター -->
    <div class="filters-section">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="search-input" placeholder="店舗名・担当者で検索...">
      </div>
      <select id="filter-status" class="filter-select">
        <option value="">すべてのステータス</option>
        <option value="pending">承認待ち</option>
        <option value="approved">承認済み</option>
        <option value="rejected">却下</option>
      </select>
      <select id="filter-store" class="filter-select">
        <option value="">すべての店舗</option>
      </select>
      <input type="date" id="filter-date-from" class="filter-input" title="開始日">
      <span class="date-separator">〜</span>
      <input type="date" id="filter-date-to" class="filter-input" title="終了日">
      <button type="button" class="btn btn-outline" id="btn-reset-filters">リセット</button>
    </div>

    <!-- レポート一覧 -->
    <div class="table-container">
      <table class="reports-table">
        <thead>
          <tr>
            <th>日付</th>
            <th>店舗</th>
            <th>担当者</th>
            <th>作業時間</th>
            <th>ステータス</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="reports-tbody">
          <tr><td colspan="6" class="loading-cell"><i class="fas fa-spinner fa-spin"></i> 読み込み中...</td></tr>
        </tbody>
      </table>
    </div>

    <!-- ページネーション -->
    <div class="pagination" id="pagination"></div>
    </div>
  </div>

  <!-- 詳細モーダル -->
  <dialog id="detail-dialog" class="modal-dialog modal-dialog-large">
    <div class="modal-content">
      <div class="modal-header">
        <h3>レポート詳細</h3>
        <button type="button" class="modal-close" onclick="document.getElementById('detail-dialog').close()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body modal-body-scrollable" id="detail-body">
        <!-- 動的に挿入 -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="document.getElementById('detail-dialog').close()">閉じる</button>
        <button type="button" class="btn btn-success" id="btn-approve">承認</button>
        <button type="button" class="btn btn-danger" id="btn-reject">却下</button>
      </div>
    </div>
  </dialog>

  <!-- 新規作成モーダル -->
  <dialog id="new-dialog" class="modal-dialog modal-dialog-large">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="form-title">新規レポート作成</h3>
        <button type="button" class="modal-close" onclick="document.getElementById('new-dialog').close()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <form id="report-form-modal">
        <div class="modal-body modal-body-scrollable">
          <input type="hidden" id="report-id" name="id">
          
          <div class="report-container-modal">
            <!-- ヘッダー部分（ピンク背景） -->
            <header class="report-header-modal">
              <div class="report-header-content-modal">
                <div class="form-group-inline-modal">
                  <label class="form-label-inline-modal">店舗 <span class="required">*</span></label>
                  <select id="report-store" name="store_id" class="form-select-inline-modal" required>
                    <option value="">店舗を選択</option>
              </select>
                  <input type="hidden" id="report-store-name" name="store_name">
            </div>
                <div class="form-group-inline-modal">
                  <label class="form-label-inline-modal">清掃日 <span class="required">*</span></label>
                  <input type="date" id="report-date" name="cleaning_date" class="form-input-inline-modal" required>
            </div>
                <div class="form-group-inline-modal">
                  <label class="form-label-inline-modal">開始時刻</label>
                  <input type="time" id="report-start" name="cleaning_start_time" class="form-input-inline-modal">
          </div>
                <div class="form-group-inline-modal">
                  <label class="form-label-inline-modal">終了時刻</label>
                  <input type="time" id="report-end" name="cleaning_end_time" class="form-input-inline-modal">
            </div>
              </div>
            </header>
            
            <!-- 実施清掃項目リスト -->
            <div class="items-list-bar-modal">
              <div class="items-list-modal">
                <span class="items-list-label-modal">実施清掃項目</span>
                <div class="items-list-items-modal" id="cleaning-items-list-modal">
                  <span class="items-list-empty-modal">項目を追加してください</span>
            </div>
          </div>
              <button type="button" class="btn-add-item-modal" id="add-work-item-modal">
                <i class="fas fa-plus"></i>
                項目を追加
              </button>
          </div>
            
            <!-- 清掃項目の詳細 -->
            <div class="report-main-modal" id="work-items-container-modal">
              <!-- 清掃項目が動的に追加される -->
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="document.getElementById('new-dialog').close()">キャンセル</button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check-circle"></i>
            レポートを作成
          </button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- メディア選択モーダル -->
  <dialog id="media-dialog" class="modal-dialog modal-dialog-large">
    <div class="modal-content">
      <div class="modal-header">
        <h3>メディアから画像を選択</h3>
        <button type="button" class="modal-close" onclick="document.getElementById('media-dialog').close()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body modal-body-scrollable" style="padding: 0; height: 60vh;">
        <iframe id="media-iframe" src="" style="width: 100%; height: 100%; border: none;"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="document.getElementById('media-dialog').close()">キャンセル</button>
      </div>
    </div>
  </dialog>

  <!-- URL発行モーダル -->
  <dialog id="share-dialog" class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h3>レポート共有URL発行</h3>
        <button type="button" class="modal-close" onclick="document.getElementById('share-dialog').close()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="share-info">
          <p>このURLを顧客に送信すると、レポートを閲覧できます。</p>
          <div class="url-display-container">
            <input type="text" id="share-url-input" class="url-input" readonly>
            <button type="button" class="btn btn-primary" id="btn-copy-url">
              <i class="fas fa-copy"></i> コピー
            </button>
          </div>
          <div class="copy-success-message" id="copy-success" style="display: none;">
            <i class="fas fa-check-circle"></i> URLをコピーしました
          </div>
          <div class="share-actions">
            <a id="share-preview-link" href="#" target="_blank" class="btn btn-outline">
              <i class="fas fa-external-link-alt"></i> プレビューで開く
            </a>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="document.getElementById('share-dialog').close()">閉じる</button>
      </div>
    </div>
  </dialog>

  <style>
    :root {
      --primary: #FF6BA6;
      --success: #22c55e;
      --warning: #f59e0b;
      --danger: #ef4444;
    }
    :root {
      --sidebar-width: 240px;
      --sidebar-width-collapsed: 64px;
      --topbar-height: 64px;
    }

    .admin-reports-v2 {
      display: flex;
      min-height: 100vh;
      background: #f9fafb;
    }

    .logo-link {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }
    .logo-img {
      width: 32px;
      height: 32px;
      object-fit: contain;
      flex-shrink: 0;
    }
    .logo-text {
      font-size: 1.25rem;
      font-weight: 700;
      color: #111827;
      white-space: nowrap;
      transition: opacity 0.3s ease;
    }
    
    .sidebar-role .role-badge {
      display: inline-block;
      padding: 3px 10px;
      background: #e0e7ff;
      color: #3730a3;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      white-space: nowrap;
    }
    .nav-label {
      transition: opacity 0.3s ease;
      white-space: nowrap;
      font-size: 0.8125rem;
    }
    .nav-divider {
      height: 1px;
      background: #e5e7eb;
      margin: 8px 12px;
    }
    
    .sidebar.collapsed 

    /* メインコンテンツ */
    .main-content {
      margin-left: var(--sidebar-width) !important;
      padding: 24px;
      background: #f9fafb;
      width: calc(100% - var(--sidebar-width)) !important;
      max-width: none !important;
      box-sizing: border-box;
      transition: margin-left 0.3s ease, width 0.3s ease;
    }
    .sidebar.collapsed ~ .main-content {
      margin-left: var(--sidebar-width-collapsed) !important;
      padding: 24px;
      background: #f9fafb;
      width: calc(100% - var(--sidebar-width-collapsed)) !important;
      max-width: none !important;
      box-sizing: border-box;
      transition: margin-left 0.3s ease, width 0.3s ease;
    }
    .content-wrapper {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* トップバー */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .topbar-left h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    .topbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    /* ヘッダー */
    .page-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
    }
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      color: #475569;
      text-decoration: none;
      font-size: 0.875rem;
    }
    .back-btn:hover { background: #f8fafc; }
    .page-title { flex: 1; font-size: 1.5rem; font-weight: 700; color: #1e293b; margin: 0; }
    .header-actions { display: flex; gap: 12px; }

    /* 統計 */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      width: 100%;
    }
    .stat-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-value { font-size: 2rem; font-weight: 700; color: var(--primary); }
    .stat-label { font-size: 0.875rem; color: #64748b; margin-top: 4px; }

    /* フィルター */
    .filters-section {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      padding: 16px;
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .search-box {
      position: relative;
      flex: 1;
      min-width: 200px;
    }
    .search-box i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #94a3b8;
    }
    .search-box input {
      width: 100%;
      padding: 10px 12px 10px 40px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.875rem;
    }
    .filter-select, .filter-input {
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.875rem;
      background: #fff;
    }
    .date-separator { color: #94a3b8; }

    /* テーブル */
    .table-container {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
    }
    .reports-table {
      width: 100%;
      border-collapse: collapse;
    }
    .reports-table th {
      background: #f8fafc;
      padding: 14px 16px;
      text-align: left;
      font-size: 0.8rem;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      border-bottom: 1px solid #e2e8f0;
    }
    .reports-table td {
      padding: 16px;
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.9rem;
      color: #334155;
    }
    .reports-table tbody tr:hover { background: #f8fafc; }
    .loading-cell { text-align: center; padding: 40px !important; color: #94a3b8; }

    /* ステータスバッジ */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-approved { background: #dcfce7; color: #166534; }
    .status-rejected { background: #fee2e2; color: #991b1b; }

    /* アクションボタン */
    .action-btns { display: flex; gap: 8px; }
    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      transition: all 0.2s;
    }
    .action-btn.view { background: #e0f2fe; color: #0284c7; }
    .action-btn.edit { background: #fef3c7; color: #d97706; }
    .action-btn.share { background: #dbeafe; color: #2563eb; }
    .action-btn.delete { background: #fee2e2; color: #dc2626; }
    .action-btn:hover { transform: scale(1.1); }
    
    /* URL発行モーダル */
    .share-info {
      padding: 20px 0;
    }
    .share-info p {
      margin-bottom: 20px;
      color: #64748b;
      font-size: 0.95rem;
    }
    .url-display-container {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    .url-input {
      flex: 1;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9rem;
      background: #f9fafb;
      color: #1e293b;
    }
    .url-input:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
    }
    .copy-success-message {
      padding: 12px;
      background: #d1fae5;
      color: #065f46;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .share-actions {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    .share-actions .btn {
      width: 100%;
      justify-content: center;
    }

    /* ボタン */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-primary:hover { background: #ff5a9a; }
    .btn-outline { background: #fff; color: #475569; border: 1px solid #e2e8f0; }
    .btn-outline:hover { background: #f8fafc; }
    .btn-success { background: var(--success); color: #fff; }
    .btn-success:hover { background: #16a34a; }
    .btn-danger { background: var(--danger); color: #fff; }
    .btn-danger:hover { background: #dc2626; }

    /* ページネーション */
    .pagination {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin: 0;
    }
    .page-btn {
      padding: 8px 14px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
      font-size: 0.875rem;
    }
    .page-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
    .page-btn:hover:not(.active) { background: #f8fafc; }

    /* モーダル */
    .modal-dialog {
      border: none;
      border-radius: 16px;
      padding: 0;
      max-width: 600px;
      width: 90vw;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }
    .modal-dialog:not([open]) {
      display: none;
    }
    .modal-dialog::backdrop { background: rgba(0,0,0,0.5); }
    .modal-content { padding: 0; }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 24px;
      border-bottom: 1px solid #e2e8f0;
    }
    .modal-header h3 { margin: 0; font-size: 1.25rem; color: #1e293b; }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.25rem;
      color: #94a3b8;
      cursor: pointer;
    }
    .modal-dialog-large {
      max-width: 95vw;
      width: 900px;
      max-height: 95vh;
    }
    .modal-body { padding: 0; }
    .modal-body-scrollable {
      max-height: calc(95vh - 140px);
      overflow-y: auto;
      padding: 0;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 24px;
      border-top: 1px solid #e2e8f0;
      background: #fff;
      position: sticky;
      bottom: 0;
    }

    /* フォーム */
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }
    .form-field { margin-bottom: 16px; }
    .form-field label { display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 6px; }
    .form-field input, .form-field select, .form-field textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    .form-field input:focus, .form-field select:focus, .form-field textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    .time-range { display: flex; align-items: center; gap: 8px; }
    .time-range input { flex: 1; }
    .required { color: var(--danger); }

    /* モーダル内レポートコンテナ */
    .report-container-modal {
      background: #fff;
      border-radius: 0;
      overflow: hidden;
    }
    .report-header-modal {
      background: #FF679C;
      color: #fff;
      padding: 16px 24px;
    }
    .report-header-content-modal {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .form-group-inline-modal {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .form-label-inline-modal {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      min-width: 80px;
    }
    .form-select-inline-modal,
    .form-input-inline-modal {
      flex: 1;
      min-width: 150px;
      padding: 8px 12px;
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.9);
      color: #333;
      font-size: 0.95rem;
    }
    .form-select-inline-modal:focus,
    .form-input-inline-modal:focus {
      outline: none;
      border-color: #fff;
      background: #fff;
      box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
    }
    .items-list-bar-modal {
      background: #f9f9f9;
      padding: 12px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }
    .items-list-modal {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      flex: 1;
    }
    .items-list-label-modal {
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
    }
    .items-list-items-modal {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .items-list-item-modal {
      font-size: 0.9rem;
      color: #333;
      padding: 6px 12px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
    }
    .items-list-empty-modal {
      font-size: 0.9rem;
      color: #999;
      font-style: italic;
    }
    .btn-add-item-modal {
      padding: 8px 16px;
      background: #FF679C;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.2s;
    }
    .btn-add-item-modal:hover {
      background: #e55a8a;
    }
    .cleaning-section-modal {
      padding: 24px;
      border-bottom: 1px solid #eee;
    }
    .cleaning-section-modal:last-child {
      border-bottom: none;
    }
    .item-header-modal {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }
    .item-title-input-modal,
    .item-title-select-modal {
      flex: 1;
      min-width: 200px;
      font-size: 1.2rem;
      font-weight: 600;
      color: #222;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      background: #fff;
      cursor: pointer;
    }
    .item-title-input-modal:focus,
    .item-title-select-modal:focus {
      outline: none;
      border-color: #FF679C;
      box-shadow: 0 0 0 3px rgba(255, 103, 156, 0.1);
    }
    .item-details-modal {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding-top: 5px;
    }
    .detail-tag-input-modal {
      padding: 6px 12px;
      background: #f0f4f8;
      color: #555;
      border: 1px solid #e5e7eb;
      border-radius: 20px;
      font-size: 0.85rem;
    }
    .detail-tag-input-modal:focus {
      outline: none;
      border-color: #FF679C;
      background: #fff;
    }
    .subsection-modal {
      margin-top: 20px;
    }
    .subsection-title-modal {
      font-size: 1.1rem;
      font-weight: 600;
      color: #333;
      border-bottom: 2px solid #333;
      padding-bottom: 5px;
      margin-top: 25px;
      margin-bottom: 15px;
    }
    .subsection-modal textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
    }
    .subsection-modal textarea:focus {
      outline: none;
      border-color: #FF679C;
      box-shadow: 0 0 0 3px rgba(255, 103, 156, 0.1);
    }
    .image-grid-modal {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 20px;
    }
    .image-category-modal {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      padding: 16px;
      border-radius: 12px;
    }
    /* 作業前のスタイル */
    .image-category-modal.before-category {
      background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
      border: 2px solid #f59e0b;
    }
    .image-category-modal.before-category .image-category-title-modal {
      color: #b45309;
    }
    .image-category-modal.before-category .image-category-title-modal i {
      color: #f59e0b;
    }
    /* 作業後のスタイル */
    .image-category-modal.after-category {
      background: linear-gradient(135deg, #d1fae5 0%, #ecfdf5 100%);
      border: 2px solid #10b981;
    }
    .image-category-modal.after-category .image-category-title-modal {
      color: #047857;
    }
    .image-category-modal.after-category .image-category-title-modal i {
      color: #10b981;
    }
    .image-category-title-modal {
      font-size: 1rem;
      font-weight: 700;
      color: #444;
      margin: 0;
      text-align: center;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .image-category-title-modal i {
      font-size: 1.1rem;
    }
    .image-list-modal {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      width: 100%;
      max-width: 100%;
    }
    .image-item-modal {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ccc;
      background: #fafafa;
    }
    .image-item-modal img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .image-upload-btn-modal {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      cursor: pointer;
      transition: all 0.2s;
    }
    .image-upload-btn-modal:hover {
      background: #ffffff;
      border-color: #FF679C;
    }
    .image-upload-btn-modal input[type="file"] {
      display: none;
    }
    .image-upload-btn-modal i {
      font-size: 2rem;
      color: #FF679C;
      margin-bottom: 8px;
    }
    .image-upload-btn-modal span {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .image-add-btns-modal {
      display: flex;
      flex-direction: column;
      gap: 4px;
      border: none;
      background: transparent;
    }
    .image-add-btns-modal .image-upload-btn-modal,
    .image-add-btns-modal .image-media-btn-modal {
      flex: 1;
      min-height: 50px;
      border-radius: 6px;
    }
    .image-media-btn-modal {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      background: #f0f9ff;
      border: 2px dashed #0ea5e9;
      cursor: pointer;
      transition: all 0.2s;
      padding: 8px;
    }
    .image-media-btn-modal:hover {
      background: #e0f2fe;
      border-color: #0284c7;
    }
    .image-media-btn-modal i {
      font-size: 1.5rem;
      color: #0ea5e9;
      margin-bottom: 4px;
    }
    .image-media-btn-modal span {
      font-size: 0.75rem;
      color: #0369a1;
    }
    .image-remove-modal {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 32px;
      height: 32px;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .item-remove-btn-modal {
      padding: 8px 16px;
      background: #ef4444;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .item-remove-btn-modal:hover {
      background: #dc2626;
    }

    /* 詳細表示 */
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .detail-item { margin-bottom: 16px; }
    .detail-label { font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
    .detail-value { font-size: 0.95rem; color: #1e293b; font-weight: 500; }

    /* レスポンシブ */
    @media (max-width: 1024px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .container { padding: 0 16px; }
      .page-header { flex-wrap: wrap; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .filters-section { flex-direction: column; }
      .search-box { width: 100%; }
      .form-row { grid-template-columns: 1fr; }
      .table-container { overflow-x: auto; }
    }
  </style>

  <script>
  (function() {
    const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
    const REPORT_API = 'https://2z0ui5xfxb.execute-api.ap-northeast-1.amazonaws.com/prod';
    let allReports = [];
    let allStores = [];
    let allWorkers = [];
    let allServiceItems = [];
    let filteredReports = [];
    let currentPage = 1;
    const perPage = 20;
    let currentReportId = null;

    // 初期化
    document.addEventListener('DOMContentLoaded', async () => {
      await Promise.all([loadReports(), loadStores(), loadWorkers(), loadServiceItems()]);
      setupEventListeners();
        
  });

    // サービス項目をロード
    async function loadServiceItems() {
      try {
        const res = await fetch('/data/service_items.json');
        if (res.ok) {
          allServiceItems = await res.json();
        }
      } catch (err) {
        console.warn('Failed to load service items:', err);
        allServiceItems = [];
      }
    }

    async function loadReports() {
      try {
        // 新レポートAPI（あなたが作ったシステム）からデータ取得
        const res = await fetch(`${REPORT_API}/staff/reports`, {
          headers: { 'Authorization': 'Bearer mock-token' }
        });
        const data = await res.json();
        allReports = data.items || [];
        
        // データ形式を統一
        allReports = allReports.map(r => ({
          ...r,
          id: r.report_id || r.id,
          store_id: r.store_id,
          worker_id: r.staff_id,
          work_date: r.cleaning_date,
          start_time: r.cleaning_start_time,
          end_time: r.cleaning_end_time,
          content: r.work_items?.map(w => w.name).join(', ') || '',
          notes: r.work_memo,
          status: r.status === 'published' ? 'approved' : r.status
        }));
        
        updateStats();
        filterAndRender();
      } catch (e) {
        console.error('Failed to load reports:', e);
        document.getElementById('reports-tbody').innerHTML = '<tr><td colspan="6" class="loading-cell">読み込みに失敗しました</td></tr>';
      }
    }

    async function loadStores() {
      try {
        const res = await fetch(`${API_BASE}/stores`);
        allStores = await res.json();
        populateStoreFilters();
      } catch (e) {
        console.error('Failed to load stores:', e);
      }
    }

    async function loadWorkers() {
      try {
        const res = await fetch(`${API_BASE}/workers`);
        allWorkers = await res.json();
        populateWorkerSelect();
      } catch (e) {
        console.error('Failed to load workers:', e);
      }
    }

    function populateStoreFilters() {
      const filterSelect = document.getElementById('filter-store');
      const formSelect = document.getElementById('report-store');
      const options = allStores.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
      filterSelect.innerHTML = '<option value="">すべての店舗</option>' + options;
      formSelect.innerHTML = '<option value="">選択してください</option>' + options;
    }

    function populateWorkerSelect() {
      const select = document.getElementById('report-worker');
      if (!select) return; // 新しいモーダルには存在しないので、nullチェック
      const staffWorkers = allWorkers.filter(w => w.role === 'staff');
      select.innerHTML = '<option value="">選択してください</option>' + 
        staffWorkers.map(w => `<option value="${w.id}">${escapeHtml(w.name)}</option>`).join('');
    }

    function updateStats() {
      document.getElementById('stat-total').textContent = allReports.length;
      document.getElementById('stat-pending').textContent = allReports.filter(r => !r.send_at && r.status !== 'approved').length;
      document.getElementById('stat-approved').textContent = allReports.filter(r => r.send_at || r.status === 'approved').length;
      
      const thisMonth = new Date().toISOString().slice(0, 7);
      document.getElementById('stat-thismonth').textContent = allReports.filter(r => 
        (r.work_date || r.created_at || '').startsWith(thisMonth)
      ).length;
    }

    function filterAndRender() {
      const search = document.getElementById('search-input').value.toLowerCase();
      const status = document.getElementById('filter-status').value;
      const storeId = document.getElementById('filter-store').value;
      const dateFrom = document.getElementById('filter-date-from').value;
      const dateTo = document.getElementById('filter-date-to').value;

      filteredReports = allReports.filter(r => {
        const store = allStores.find(s => s.id === r.store_id) || {};
        const worker = allWorkers.find(w => w.id === r.worker_id) || {};
        
        // 検索
        if (search) {
          const searchStr = `${store.name || ''} ${worker.name || ''}`.toLowerCase();
          if (!searchStr.includes(search)) return false;
        }
        
        // ステータス
        if (status) {
          const reportStatus = r.send_at || r.status === 'approved' ? 'approved' : (r.status === 'rejected' ? 'rejected' : 'pending');
          if (reportStatus !== status) return false;
        }
        
        // 店舗
        if (storeId && String(r.store_id) !== storeId) return false;
        
        // 日付範囲
        const workDate = r.work_date || r.created_at?.split('T')[0] || '';
        if (dateFrom && workDate < dateFrom) return false;
        if (dateTo && workDate > dateTo) return false;
        
        return true;
      });

      // 日付でソート（新しい順）
      filteredReports.sort((a, b) => {
        const dateA = a.work_date || a.created_at || '';
        const dateB = b.work_date || b.created_at || '';
        return dateB.localeCompare(dateA);
      });

      currentPage = 1;
      renderTable();
      renderPagination();
    }

    function renderTable() {
      const tbody = document.getElementById('reports-tbody');
      const start = (currentPage - 1) * perPage;
      const pageReports = filteredReports.slice(start, start + perPage);

      if (pageReports.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">レポートがありません</td></tr>';
        return;
      }

      tbody.innerHTML = pageReports.map(r => {
        // DataUtilsで正規化
        const normalized = DataUtils.normalizeReport(r);
        const store = DataUtils.findStore(allStores, r.store_id) || {};
        const worker = allWorkers.find(w => w.id === normalized.worker_id) || {};
        const status = normalized.status === 'approved' ? 'approved' : (normalized.status === 'rejected' ? 'rejected' : 'pending');
        const statusLabel = DataUtils.getStatusLabel(status);
        const displayStoreName = DataUtils.getStoreName(allStores, r.store_id, normalized.store_name);

        return `
          <tr>
            <td>${DataUtils.formatDate(normalized.date)}</td>
            <td>${DataUtils.escapeHtml(displayStoreName)}</td>
            <td>${DataUtils.escapeHtml(worker.name || normalized.worker_name || '-')}</td>
            <td>${normalized.start_time || '-'} 〜 ${normalized.end_time || '-'}</td>
            <td><span class="status-badge status-${status}">${statusLabel}</span></td>
            <td>
              <div class="action-btns">
                <button class="action-btn view" title="詳細" onclick="viewReport('${r.id}')"><i class="fas fa-eye"></i></button>
                <button class="action-btn edit" title="編集" onclick="editReport('${r.id}')"><i class="fas fa-edit"></i></button>
                <button class="action-btn share" title="URL発行" onclick="shareReport('${r.id}')"><i class="fas fa-share-alt"></i></button>
                <button class="action-btn delete" title="削除" onclick="deleteReport('${r.id}')"><i class="fas fa-trash"></i></button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredReports.length / perPage);
      const pagination = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let html = '';
      if (currentPage > 1) {
        html += `<button class="page-btn" onclick="goToPage(${currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
      }
      
      for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
          html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
          html += '<span style="padding:8px">...</span>';
        }
      }
      
      if (currentPage < totalPages) {
        html += `<button class="page-btn" onclick="goToPage(${currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
      }
      
      pagination.innerHTML = html;
    }

    window.goToPage = function(page) {
      currentPage = page;
      renderTable();
      renderPagination();
    };

    // 詳細表示
    window.viewReport = function(id) {
      const report = allReports.find(r => String(r.id) === String(id) || String(r.report_id) === String(id));
      if (!report) return;

      currentReportId = id;
      const store = allStores.find(s => s.id === report.store_id) || {};
      const worker = allWorkers.find(w => w.id === report.worker_id || w.id === report.staff_id) || {};
      const status = report.send_at || report.status === 'approved' ? 'approved' : (report.status === 'rejected' ? 'rejected' : 'pending');

      // 新しい形式のレポート（work_items配列）かどうかを判定
      const hasWorkItems = report.work_items && Array.isArray(report.work_items) && report.work_items.length > 0;

      let reportHtml = '';

      if (hasWorkItems) {
        // 新しい形式: レポート表示ページと同じレイアウト
        const dateStr = formatDate(report.cleaning_date || report.work_date || report.created_at?.split('T')[0]);
        const timeStr = (report.cleaning_start_time || report.start_time || '') && (report.cleaning_end_time || report.end_time || '')
          ? `${report.cleaning_start_time || report.start_time} - ${report.cleaning_end_time || report.end_time}`
          : '';

        // 実施清掃項目リスト
        const itemNames = report.work_items.map(item => item.item_name || item.name || item.item_id).filter(Boolean);
        const itemsListHtml = itemNames.length > 0
          ? itemNames.map(name => `<span class="items-list-item-modal">${escapeHtml(name)}</span>`).join('')
          : '<span class="items-list-empty-modal">項目なし</span>';

        // 清掃項目の詳細
        const workItemsHtml = report.work_items.map(item => {
          const details = item.details || {};
          const tags = [];
          if (details.type) tags.push(details.type);
          if (details.count) tags.push(`${details.count}個`);
          const tagsHtml = tags.map(tag => `<span class="detail-tag-input-modal" style="display:inline-block;margin-right:8px;">${escapeHtml(tag)}</span>`).join('');

          // 写真の表示
          const beforePhotos = item.photos?.before || [];
          const afterPhotos = item.photos?.after || [];

          const beforePhotosHtml = beforePhotos.length > 0
            ? `<div class="image-list-modal">
                 ${beforePhotos.map(url => `
                   <div class="image-item-modal">
                     <img src="${url}" alt="作業前" loading="lazy" />
                   </div>
                 `).join('')}
               </div>`
            : '<p style="color: #999; font-style: italic; padding: 20px; text-align: center;">写真なし</p>';

          const afterPhotosHtml = afterPhotos.length > 0
            ? `<div class="image-list-modal">
                 ${afterPhotos.map(url => `
                   <div class="image-item-modal">
                     <img src="${url}" alt="作業後" loading="lazy" />
                   </div>
                 `).join('')}
               </div>`
            : '<p style="color: #999; font-style: italic; padding: 20px; text-align: center;">写真なし</p>';

          return `
            <section class="cleaning-section-modal">
              <div class="item-header-modal">
                <h3 class="item-title-input-modal" style="border:none;background:transparent;padding:0;font-size:1.6rem;font-weight:600;color:#222;">${escapeHtml(item.item_name || item.name || item.item_id)}</h3>
                <div class="item-details-modal">${tagsHtml}</div>
              </div>
              ${item.work_content ? `
                <div class="subsection-modal">
                  <h4 class="subsection-title-modal">作業内容</h4>
                  <p style="white-space: pre-wrap;">${escapeHtml(item.work_content)}</p>
                </div>
              ` : ''}
              <div class="image-grid-modal">
                <div class="image-category-modal">
                  <h4 class="image-category-title-modal">作業前</h4>
                  ${beforePhotosHtml}
                </div>
                <div class="image-category-modal">
                  <h4 class="image-category-title-modal">作業後</h4>
                  ${afterPhotosHtml}
                </div>
              </div>
              ${item.work_memo ? `
                <div class="subsection-modal">
                  <h4 class="subsection-title-modal">作業メモ</h4>
                  <p style="white-space: pre-wrap;">${escapeHtml(item.work_memo)}</p>
                </div>
              ` : ''}
            </section>
          `;
        }).join('');

        reportHtml = `
          <div class="report-container-modal">
            <header class="report-header-modal">
              <div class="report-header-content-modal">
                <div class="form-group-inline-modal">
                  <span class="form-label-inline-modal">清掃日時</span>
                  <span style="color:#fff;font-size:1rem;">${dateStr} ${timeStr}</span>
                </div>
                <div class="form-group-inline-modal">
                  <span class="form-label-inline-modal">店舗</span>
                  <span style="color:#fff;font-size:1rem;">${escapeHtml(report.store_name || store.name || '不明')}</span>
                </div>
                <div class="form-group-inline-modal">
                  <span class="form-label-inline-modal">担当者</span>
                  <span style="color:#fff;font-size:1rem;">${escapeHtml(report.staff_name || worker.name || '-')}</span>
                </div>
              </div>
            </header>
            <div class="items-list-bar-modal">
              <div class="items-list-modal">
                <span class="items-list-label-modal">実施清掃項目</span>
                <div class="items-list-items-modal">${itemsListHtml}</div>
              </div>
            </div>
            <div class="report-main-modal">
              ${workItemsHtml}
            </div>
          </div>
        `;
      } else {
        // 古い形式: 従来の表示
      const photosHtml = report.photos ? `
        <div class="detail-item" style="grid-column: 1/-1;">
          <div class="detail-label">写真</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:8px;">
            <div>
              <div style="font-size:0.75rem;color:#6b7280;margin-bottom:4px;">作業前</div>
              <div style="display:flex;gap:4px;flex-wrap:wrap;">
                ${(report.photos.before || []).map(p => `<img src="${p}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;">`).join('') || '<span style="color:#9ca3af;font-size:0.8rem;">なし</span>'}
              </div>
            </div>
            <div>
              <div style="font-size:0.75rem;color:#6b7280;margin-bottom:4px;">作業後</div>
              <div style="display:flex;gap:4px;flex-wrap:wrap;">
                ${(report.photos.after || []).map(p => `<img src="${p}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;">`).join('') || '<span style="color:#9ca3af;font-size:0.8rem;">なし</span>'}
              </div>
            </div>
          </div>
        </div>
      ` : '';

        reportHtml = `
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">店舗</div>
            <div class="detail-value">${escapeHtml(report.store_name || store.name || '不明')}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">担当者</div>
            <div class="detail-value">${escapeHtml(report.staff_name || worker.name || '-')}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">作業日</div>
            <div class="detail-value">${formatDate(report.work_date || report.cleaning_date || report.created_at?.split('T')[0])}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">作業時間</div>
            <div class="detail-value">${report.start_time || report.cleaning_start_time || '-'} 〜 ${report.end_time || report.cleaning_end_time || '-'}</div>
          </div>
          ${photosHtml}
        </div>
        <div class="detail-item">
          <div class="detail-label">作業内容</div>
            <div class="detail-value">${escapeHtml(report.content || '-')}</div>
        </div>
        <div class="detail-item">
          <div class="detail-label">備考</div>
            <div class="detail-value">${escapeHtml(report.notes || '-')}</div>
        </div>
      `;
      }

      document.getElementById('detail-body').innerHTML = reportHtml;

      // 承認済みなら承認/却下ボタンを非表示
      document.getElementById('btn-approve').style.display = status === 'approved' ? 'none' : '';
      document.getElementById('btn-reject').style.display = status === 'approved' ? 'none' : '';

      document.getElementById('detail-dialog').showModal();
    };

    // 編集
    window.editReport = function(id) {
      const report = allReports.find(r => String(r.id) === String(id) || String(r.report_id) === String(id));
      if (!report) {
        alert('レポートが見つかりませんでした');
        return;
      }

      document.getElementById('form-title').textContent = 'レポート編集';
      document.getElementById('report-id').value = report.report_id || report.id;
      
      // 基本情報を設定
      const storeSelect = document.getElementById('report-store');
      if (storeSelect) {
        storeSelect.value = report.store_id || '';
        const selectedOption = storeSelect.options[storeSelect.selectedIndex];
        if (selectedOption) {
          document.getElementById('report-store-name').value = selectedOption.text;
        }
      }
      
      document.getElementById('report-date').value = report.cleaning_date || report.work_date || '';
      document.getElementById('report-start').value = report.cleaning_start_time || report.start_time || '';
      document.getElementById('report-end').value = report.cleaning_end_time || report.end_time || '';

      // 清掃項目をクリア
      const workItemsContainer = document.getElementById('work-items-container-modal');
      if (workItemsContainer) {
        workItemsContainer.innerHTML = '';
      }
      modalWorkItemCounter = 0;

      // 新しい形式（work_items配列）の場合
      if (report.work_items && Array.isArray(report.work_items) && report.work_items.length > 0) {
        // 各清掃項目を追加
        report.work_items.forEach(item => {
          addWorkItemModal(item);
        });
      } else {
        // 古い形式の場合、1つの項目として追加
        addWorkItemModal({
          item_id: `work-item-${Date.now()}`,
          item_name: report.content || '',
          work_content: report.content || '',
          work_memo: report.notes || '',
          details: {},
          photos: report.photos || { before: [], after: [] }
        });
      }

      document.getElementById('new-dialog').showModal();
    };

    // URL発行
    window.shareReport = function(id) {
      const report = allReports.find(r => String(r.id) === String(id) || String(r.report_id) === String(id));
      if (!report) {
        alert('レポートが見つかりませんでした');
        return;
      }

      // 共有URLを生成
      const reportId = report.report_id || report.id;
      const baseUrl = window.location.origin;
      const shareUrl = `${baseUrl}/reports/shared/${reportId}`;

      // URLを表示
      document.getElementById('share-url-input').value = shareUrl;
      
      // プレビューリンクを設定
      const previewLink = document.getElementById('share-preview-link');
      previewLink.href = shareUrl;
      
      // コピー成功メッセージを非表示
      document.getElementById('copy-success').style.display = 'none';
      
      // モーダルを表示
      document.getElementById('share-dialog').showModal();
    };

    // URLコピー機能
    document.addEventListener('DOMContentLoaded', function() {
      const copyBtn = document.getElementById('btn-copy-url');
      const urlInput = document.getElementById('share-url-input');
      const copySuccess = document.getElementById('copy-success');
      
      if (copyBtn && urlInput) {
        copyBtn.addEventListener('click', async function() {
          try {
            await navigator.clipboard.writeText(urlInput.value);
            copySuccess.style.display = 'flex';
            setTimeout(() => {
              copySuccess.style.display = 'none';
            }, 3000);
          } catch (err) {
            // フォールバック: テキストエリアを使用
            urlInput.select();
            document.execCommand('copy');
            copySuccess.style.display = 'flex';
            setTimeout(() => {
              copySuccess.style.display = 'none';
            }, 3000);
          }
        });
      }
    });

    // 削除
    window.deleteReport = async function(id) {
      if (!confirm('このレポートを削除しますか？')) return;
      
      try {
        // 新レポートAPIから削除を試みる
        try {
          const idToken = await getFirebaseIdToken();
          await fetch(`${REPORT_API}/staff/reports/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${idToken}` }
          });
        } catch (e) {
          // 旧APIから削除を試みる
        await fetch(`${API_BASE}/reports/${id}`, { method: 'DELETE' });
        }
        allReports = allReports.filter(r => String(r.id) !== String(id));
        updateStats();
        filterAndRender();
      } catch (e) {
        alert('削除に失敗しました');
      }
    };

    // テストデータを全削除
    async function clearAllTestReports() {
      if (!confirm('すべてのテストレポートを削除しますか？\nこの操作は取り消せません。')) return;
      
      try {
        const idToken = await getFirebaseIdToken();
        let deletedCount = 0;
        let failedCount = 0;
        
        // すべてのレポートを削除
        for (const report of allReports) {
          try {
            const reportId = report.id || report.report_id;
            await fetch(`${REPORT_API}/staff/reports/${reportId}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${idToken}` }
            });
            deletedCount++;
          } catch (e) {
            console.error(`Failed to delete report ${report.id}:`, e);
            failedCount++;
          }
        }
        
        if (deletedCount > 0) {
          alert(`${deletedCount}件のレポートを削除しました${failedCount > 0 ? `\n${failedCount}件の削除に失敗しました` : ''}`);
          await loadReports();
        } else {
          alert('削除できるレポートがありませんでした');
        }
      } catch (e) {
        console.error('Error clearing test reports:', e);
        alert('テストデータの削除に失敗しました');
      }
    }

    // Firebase認証からIDトークンを取得
    async function getFirebaseIdToken() {
      try {
        if (!window.FirebaseAuth) {
          return 'mock-token';
        }
        const currentUser = window.FirebaseAuth.currentUser;
        if (!currentUser) {
          return 'mock-token';
        }
        const idToken = await currentUser.getIdToken();
        return idToken;
      } catch (error) {
        console.error('Error getting Firebase ID token:', error);
        return 'mock-token';
      }
    }

    // 承認
    document.getElementById('btn-approve').addEventListener('click', async () => {
      if (!currentReportId) return;
      
      try {
        await fetch(`${API_BASE}/reports/${currentReportId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'approved', send_at: new Date().toISOString() })
        });
        
        const report = allReports.find(r => String(r.id) === String(currentReportId));
        if (report) {
          report.status = 'approved';
          report.send_at = new Date().toISOString();
        }
        
        document.getElementById('detail-dialog').close();
        updateStats();
        filterAndRender();
      } catch (e) {
        alert('承認に失敗しました');
      }
    });

    // 却下
    document.getElementById('btn-reject').addEventListener('click', async () => {
      if (!currentReportId) return;
      
      try {
        await fetch(`${API_BASE}/reports/${currentReportId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: 'rejected' })
        });
        
        const report = allReports.find(r => String(r.id) === String(currentReportId));
        if (report) report.status = 'rejected';
        
        document.getElementById('detail-dialog').close();
        updateStats();
        filterAndRender();
      } catch (e) {
        alert('却下に失敗しました');
      }
    });

    // イベントリスナー
    function setupEventListeners() {
      document.getElementById('search-input').addEventListener('input', debounce(filterAndRender, 300));
      document.getElementById('filter-status').addEventListener('change', filterAndRender);
      document.getElementById('filter-store').addEventListener('change', filterAndRender);
      document.getElementById('filter-date-from').addEventListener('change', filterAndRender);
      document.getElementById('filter-date-to').addEventListener('change', filterAndRender);
      document.getElementById('btn-reset-filters').addEventListener('click', () => {
        document.getElementById('search-input').value = '';
        document.getElementById('filter-status').value = '';
        document.getElementById('filter-store').value = '';
        document.getElementById('filter-date-from').value = '';
        document.getElementById('filter-date-to').value = '';
        filterAndRender();
      });

      // 新規作成
      document.getElementById('btn-new-report').addEventListener('click', () => {
        document.getElementById('form-title').textContent = '新規レポート作成';
        document.getElementById('report-form-modal').reset();
        document.getElementById('report-id').value = '';
        document.getElementById('report-date').value = new Date().toISOString().split('T')[0];
        // モーダル内のコンテナをクリア
        document.getElementById('work-items-container-modal').innerHTML = '';
        document.getElementById('cleaning-items-list-modal').innerHTML = '<span class="items-list-empty-modal">項目を追加してください</span>';
        // 初期項目を追加
        modalWorkItemCounter = 0;
        addWorkItemModal();
        document.getElementById('new-dialog').showModal();
      });

      // テストデータクリア
      document.getElementById('btn-clear-test').addEventListener('click', clearAllTestReports);

      // モーダル用の変数と関数
      let modalWorkItemCounter = 0;

      // モーダル用: 画像の最適化
      function optimizeImageModal(file, maxWidth = 800, quality = 0.8) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const canvas = document.createElement('canvas');
              let width = img.width;
              let height = img.height;
              
              if (width > maxWidth) {
                height = (height * maxWidth) / width;
                width = maxWidth;
              }
              
              canvas.width = width;
              canvas.height = height;
              
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);
              
              canvas.toBlob(resolve, 'image/jpeg', quality);
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      // モーダル用: Base64に変換
      function blobToBase64Modal(blob) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      }

      // モーダル用: 清掃項目リストを更新
      window.updateCleaningItemsListModal = function() {
        const container = document.getElementById('cleaning-items-list-modal');
        const items = document.querySelectorAll('.cleaning-section-modal');
        
        if (items.length === 0) {
          container.innerHTML = '<span class="items-list-empty-modal">項目を追加してください</span>';
          return;
        }
        
        const itemNames = Array.from(items).map(section => {
          const select = section.querySelector('.item-title-select-modal');
          const input = section.querySelector('.item-title-input-modal');
          if (select) {
            return select.value || '未入力';
          }
          return input ? input.value || '未入力' : '未入力';
        }).filter(name => name !== '未入力' && name !== '');
        
        if (itemNames.length === 0) {
          container.innerHTML = '<span class="items-list-empty-modal">項目を追加してください</span>';
          return;
        }
        
        container.innerHTML = itemNames.map(name => 
          `<span class="items-list-item-modal">${name}</span>`
        ).join('');
      };

      // モーダル用: 清掃項目を追加
      window.addWorkItemModal = function(itemData = null) {
        modalWorkItemCounter++;
        const container = document.getElementById('work-items-container-modal');
        const itemIdValue = itemData?.item_id || `work-item-modal-${modalWorkItemCounter}`;
        const itemNameValue = itemData?.item_name || '';
        const details = itemData?.details || {};
        const workContent = itemData?.work_content || '';
        const workMemo = itemData?.work_memo || '';
        const beforePhotos = itemData?.photos?.before || [];
        const afterPhotos = itemData?.photos?.after || [];
        
        const workItemSection = document.createElement('section');
        workItemSection.className = 'cleaning-section-modal';
        workItemSection.dataset.itemId = itemIdValue;
        
        // 作業前の写真HTML
        const beforePhotosHtml = beforePhotos.map((url, idx) => {
          const isBase64 = url.startsWith('data:');
          return `
            <div class="image-item-modal" data-base64="${isBase64 ? url : ''}" data-url="${!isBase64 ? url : ''}">
              <img src="${url}" alt="作業前" loading="lazy">
              <button type="button" class="image-remove-modal" onclick="removePhotoModal(this)">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
        }).join('');
        
        // 作業後の写真HTML
        const afterPhotosHtml = afterPhotos.map((url, idx) => {
          const isBase64 = url.startsWith('data:');
          return `
            <div class="image-item-modal" data-base64="${isBase64 ? url : ''}" data-url="${!isBase64 ? url : ''}">
              <img src="${url}" alt="作業後" loading="lazy">
              <button type="button" class="image-remove-modal" onclick="removePhotoModal(this)">
                <i class="fas fa-times"></i>
              </button>
            </div>
          `;
        }).join('');
        
        // サービス項目のドロップリストオプションを生成
        const serviceOptions = allServiceItems.map(item => {
          const selected = item.title === itemNameValue ? 'selected' : '';
          return `<option value="${escapeHtml(item.title)}" ${selected}>${escapeHtml(item.title)}</option>`;
        }).join('');
        
        workItemSection.innerHTML = `
          <div class="item-header-modal">
            <select class="item-title-select-modal" data-item-id="${itemIdValue}">
              <option value="">-- 清掃項目を選択 --</option>
              ${serviceOptions}
            </select>
            <div class="item-details-modal">
              <input type="text" class="detail-tag-input-modal" placeholder="タイプ（例: 床置き型）" style="width: 150px;" value="${escapeHtml(details.type || '')}">
              <input type="text" class="detail-tag-input-modal" placeholder="個数（例: 2個）" style="width: 100px;" value="${escapeHtml(details.count || '')}">
            </div>
            <button type="button" class="item-remove-btn-modal" onclick="removeWorkItemModal('${itemIdValue}')">
              <i class="fas fa-trash"></i>
              削除
            </button>
          </div>
          <div class="subsection-modal">
            <h4 class="subsection-title-modal">作業内容</h4>
            <textarea class="work-item-content-modal" placeholder="作業内容を入力してください">${escapeHtml(workContent)}</textarea>
          </div>
          <div class="image-grid-modal">
            <div class="image-category-modal before-category">
              <h4 class="image-category-title-modal"><i class="fas fa-clock"></i> 作業前（Before）</h4>
              <div class="image-list-modal" data-category="before" data-item-id="${itemIdValue}">
                ${beforePhotosHtml}
                <div class="image-item-modal image-add-btns-modal">
                  <label class="image-upload-btn-modal">
                    <input type="file" accept="image/*" multiple data-category="before" data-item-id="${itemIdValue}" />
                    <i class="fas fa-camera"></i>
                    <span>ファイルから</span>
                  </label>
                  <button type="button" class="image-media-btn-modal" data-category="before" data-item-id="${itemIdValue}">
                    <i class="fas fa-images"></i>
                    <span>メディアから</span>
                  </button>
                </div>
              </div>
            </div>
            <div class="image-category-modal after-category">
              <h4 class="image-category-title-modal"><i class="fas fa-check-circle"></i> 作業後（After）</h4>
              <div class="image-list-modal" data-category="after" data-item-id="${itemIdValue}">
                ${afterPhotosHtml}
                <div class="image-item-modal image-add-btns-modal">
                  <label class="image-upload-btn-modal">
                    <input type="file" accept="image/*" multiple data-category="after" data-item-id="${itemIdValue}" />
                    <i class="fas fa-camera"></i>
                    <span>ファイルから</span>
                  </label>
                  <button type="button" class="image-media-btn-modal" data-category="after" data-item-id="${itemIdValue}">
                    <i class="fas fa-images"></i>
                    <span>メディアから</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="subsection-modal">
            <h4 class="subsection-title-modal">作業メモ</h4>
            <textarea class="work-item-memo-modal" placeholder="特記事項を入力してください">${escapeHtml(workMemo)}</textarea>
          </div>
        `;
        
        container.appendChild(workItemSection);
        
        // タイトル選択のイベントリスナー（リスト更新用）
        const titleSelect = workItemSection.querySelector('.item-title-select-modal');
        if (titleSelect) {
          titleSelect.addEventListener('change', window.updateCleaningItemsListModal);
        }
        
        // 写真アップロードのイベントリスナー
        workItemSection.querySelectorAll('input[type="file"]').forEach(input => {
          console.log('[Modal] Adding event listener to file input', input);
          // changeイベントを直接設定
          input.addEventListener('change', function(e) {
            console.log('[Modal] File input change event fired', e.target.files);
            handlePhotoUploadModal(e);
          });
          // labelクリックでも確実に動作するように
          const label = input.closest('label');
          if (label) {
            label.addEventListener('click', function(e) {
              // label内のinput以外をクリックした場合は、inputをクリック
              if (e.target !== input && !input.contains(e.target)) {
                e.preventDefault();
                input.click();
              }
            });
          }
        });
        
        // メディア選択ボタンのイベントリスナー
        workItemSection.querySelectorAll('.image-media-btn-modal').forEach(btn => {
          btn.addEventListener('click', function() {
            const category = this.dataset.category;
            const itemId = this.dataset.itemId;
            openMediaSelector(category, itemId);
          });
        });
        
        window.updateCleaningItemsListModal();
      };

      // モーダル用: 清掃項目を削除
      window.removeWorkItemModal = function(itemId) {
        const section = document.querySelector(`[data-item-id="${itemId}"].cleaning-section-modal`);
        if (section && confirm('この清掃項目を削除しますか？')) {
          section.remove();
          window.updateCleaningItemsListModal();
        }
      };

      // モーダル用: 写真アップロード処理
      async function handlePhotoUploadModal(e) {
        console.log('[Modal] handlePhotoUploadModal called', e.target, e.target.files);
        const input = e.target;
        const files = Array.from(input.files || []);
        if (files.length === 0) {
          console.log('[Modal] No files selected');
          return;
        }
        
        const photoGrid = input.closest('.image-list-modal');
        if (!photoGrid) {
          console.error('[Modal] Could not find .image-list-modal');
          return;
        }
        const category = photoGrid.dataset.category;
        const itemId = photoGrid.dataset.itemId;
        console.log('[Modal] Category:', category, 'ItemId:', itemId);
        
        for (const file of files) {
          if (!file.type.startsWith('image/')) {
            console.warn('[Modal] Skipping non-image file:', file.name);
            continue;
          }
          
          try {
            console.log('[Modal] Processing file:', file.name);
            const optimizedBlob = await optimizeImageModal(file, 800, 0.8);
            const base64 = await blobToBase64Modal(optimizedBlob);
            
            const photoItem = document.createElement('div');
            photoItem.className = 'image-item-modal';
            photoItem.innerHTML = `
              <img src="${base64}" alt="Uploaded photo">
              <button type="button" class="image-remove-modal" onclick="removePhotoModal(this)">
                <i class="fas fa-times"></i>
              </button>
            `;
            
            const uploadBtn = input.closest('.image-item-modal');
            if (!uploadBtn) {
              console.error('[Modal] Could not find .image-item-modal');
              continue;
            }
            uploadBtn.parentNode.insertBefore(photoItem, uploadBtn);
            
            photoItem.dataset.base64 = base64;
            console.log('[Modal] Photo added successfully');
          } catch (error) {
            console.error('[Modal] Error uploading photo:', error);
            alert(`写真「${file.name}」のアップロードに失敗しました: ${error.message}`);
          }
        }
        
        // ファイル入力をリセット（同じファイルを再度選択できるように）
        input.value = '';
      }

      // モーダル用: 写真を削除
      window.removePhotoModal = function(button) {
        const photoItem = button.closest('.image-item-modal');
        photoItem.remove();
      };

      // メディア選択用の変数
      let currentMediaCategory = null;
      let currentMediaItemId = null;

      // メディア選択モーダルを開く
      function openMediaSelector(category, itemId) {
        currentMediaCategory = category;
        currentMediaItemId = itemId;
        
        const dialog = document.getElementById('media-dialog');
        const iframe = document.getElementById('media-iframe');
        iframe.src = '/admin/images?selectMode=true';
        dialog.showModal();
      }

      // メディアからの画像選択メッセージを受け取る
      window.addEventListener('message', function(e) {
        if (e.data && e.data.type === 'image-selected') {
          const path = e.data.path;
          addMediaImageToReport(path, currentMediaCategory, currentMediaItemId);
          document.getElementById('media-dialog').close();
        }
      });

      // メディアから選択した画像をレポートに追加
      function addMediaImageToReport(imagePath, category, itemId) {
        const photoGrid = document.querySelector(`.image-list-modal[data-category="${category}"][data-item-id="${itemId}"]`);
        if (!photoGrid) {
          console.error('Could not find photo grid for', category, itemId);
          return;
        }
        
        // 画像URLを解決
        const basePath = getBasePath();
        let resolvedPath = imagePath;
        if (!imagePath.startsWith('http://') && !imagePath.startsWith('https://') && !imagePath.startsWith('//')) {
          if (imagePath.startsWith('/')) {
            resolvedPath = basePath === '/' ? imagePath : basePath.slice(0, -1) + imagePath;
          } else {
            resolvedPath = basePath === '/' ? '/' + imagePath : basePath + imagePath;
          }
        }
        
        const photoItem = document.createElement('div');
        photoItem.className = 'image-item-modal';
        photoItem.dataset.url = resolvedPath;
        photoItem.innerHTML = `
          <img src="${resolvedPath}" alt="Selected from media">
          <button type="button" class="image-remove-modal" onclick="removePhotoModal(this)">
            <i class="fas fa-times"></i>
          </button>
        `;
        
        // アップロードボタンの前に挿入
        const addBtns = photoGrid.querySelector('.image-add-btns-modal');
        if (addBtns) {
          photoGrid.insertBefore(photoItem, addBtns);
        } else {
          photoGrid.appendChild(photoItem);
        }
        
        console.log('[Modal] Added media image:', resolvedPath);
      }

      // ベースパスを取得（GitHub Pages対応）
      function getBasePath() {
        const base = document.querySelector('base');
        if (base && base.href) {
          try {
            const url = new URL(base.href);
            return url.pathname;
          } catch (e) {
            return base.getAttribute('href') || '/';
          }
        }
        const hostname = window.location.hostname;
        if (hostname === 'misesapo.co.jp' || hostname === 'www.misesapo.co.jp') {
          return '/';
        }
        const path = window.location.pathname;
        if (path.includes('/misesapo/')) {
          return '/misesapo/';
        }
        return '/';
      }

      // モーダル用: 項目を追加ボタン
      document.getElementById('add-work-item-modal')?.addEventListener('click', function() {
        window.addWorkItemModal();
      });

      // モーダル用: 店舗選択の変更
      document.getElementById('report-store')?.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        document.getElementById('report-store-name').value = selectedOption.text;
      });

      // フォーム送信（モーダル用）
      document.getElementById('report-form-modal').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        try {
          const formData = {
            store_id: document.getElementById('report-store').value,
            store_name: document.getElementById('report-store-name').value,
            cleaning_date: document.getElementById('report-date').value,
            cleaning_start_time: document.getElementById('report-start').value,
            cleaning_end_time: document.getElementById('report-end').value,
            work_items: []
          };
          
          // 清掃項目を収集
          document.querySelectorAll('.cleaning-section-modal').forEach(section => {
            const itemId = section.dataset.itemId;
            const titleSelect = section.querySelector('.item-title-select-modal');
            const titleInput = section.querySelector('.item-title-input-modal');
            const itemName = titleSelect ? titleSelect.value.trim() : (titleInput ? titleInput.value.trim() : '');
            
            if (!itemName) {
              return;
            }
            
            const detailInputs = section.querySelectorAll('.detail-tag-input-modal');
            const type = detailInputs[0]?.value.trim() || '';
            const count = detailInputs[1]?.value.trim() || '';
            
            const workItem = {
              item_id: itemId,
              item_name: itemName,
              details: {
                type: type,
                count: count
              },
              work_content: section.querySelector('.work-item-content-modal').value.trim(),
              work_memo: section.querySelector('.work-item-memo-modal').value.trim(),
              photos: {
                before: [],
                after: []
              }
            };
            
            // 作業前の写真（Base64またはURL）- アップロードボタンを除外
            section.querySelectorAll('[data-category="before"] .image-item-modal:not(.image-add-btns-modal)').forEach(photoItem => {
              if (photoItem.dataset.base64) {
                workItem.photos.before.push(photoItem.dataset.base64);
              } else if (photoItem.dataset.url) {
                workItem.photos.before.push(photoItem.dataset.url);
              } else {
                // img srcから直接取得（フォールバック）
                const img = photoItem.querySelector('img');
                if (img && img.src) {
                  workItem.photos.before.push(img.src);
                }
              }
            });
            
            // 作業後の写真（Base64またはURL）- アップロードボタンを除外
            section.querySelectorAll('[data-category="after"] .image-item-modal:not(.image-add-btns-modal)').forEach(photoItem => {
              if (photoItem.dataset.base64) {
                workItem.photos.after.push(photoItem.dataset.base64);
              } else if (photoItem.dataset.url) {
                workItem.photos.after.push(photoItem.dataset.url);
              } else {
                // img srcから直接取得（フォールバック）
                const img = photoItem.querySelector('img');
                if (img && img.src) {
                  workItem.photos.after.push(img.src);
                }
              }
            });
            
            formData.work_items.push(workItem);
          });
          
          // バリデーション
          if (!formData.store_id) {
            alert('店舗を選択してください');
            return;
          }
          
          if (!formData.cleaning_date) {
            alert('清掃日を入力してください');
            return;
          }
          
          if (formData.work_items.length === 0) {
            alert('少なくとも1つの清掃項目を追加してください');
            return;
          }
          
          // 編集モードかどうかを判定
          const reportId = document.getElementById('report-id').value;
          const isEditMode = reportId && reportId.trim() !== '';
          
          // APIに送信
          const idToken = await getFirebaseIdToken();
          const url = isEditMode 
            ? `${REPORT_API}/staff/reports/${reportId}`
            : `${REPORT_API}/staff/reports`;
          const method = isEditMode ? 'PUT' : 'POST';
          
          const response = await fetch(url, {
            method: method,
            headers: {
              'Authorization': `Bearer ${idToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
            });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || (isEditMode ? 'レポートの更新に失敗しました' : 'レポートの作成に失敗しました'));
          }
          
          const result = await response.json();
          alert(isEditMode ? 'レポートを更新しました' : 'レポートを作成しました');
          document.getElementById('new-dialog').close();
          
          // フォームをリセット
          document.getElementById('report-form-modal').reset();
          document.getElementById('report-id').value = '';
          document.getElementById('work-items-container-modal').innerHTML = '';
          document.getElementById('cleaning-items-list-modal').innerHTML = '<span class="items-list-empty-modal">項目を追加してください</span>';
          modalWorkItemCounter = 0;
          document.getElementById('form-title').textContent = '新規レポート作成';
          
          await loadReports();
        } catch (error) {
          console.error('Error submitting report:', error);
          alert(`エラー: ${error.message}`);
        }
      });
    }

    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const d = new Date(dateStr);
      return d.toLocaleDateString('ja-JP', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function debounce(fn, delay) {
      let timer;
      return function(...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }
  })();
  </script>
</main>
