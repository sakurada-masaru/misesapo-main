@layout('layouts.admin')
@json('data/meta/admin_schedules_title.json', $title)
@json('data/meta/admin_schedules_body_class.json', $body_class)

<script src="/js/data_utils.js"></script>

<main id="main" class="admin-schedules-v2">
  <!-- サイドバー -->
  <aside class="sidebar" id="admin-sidebar">
    <div class="sidebar-header">
      <a href="/admin/dashboard.html" class="logo-link">
        <img src="/images/logo_144x144.png" alt="ミセサポ" class="logo-img" />
        <span class="logo-text">ミセサポ</span>
      </a>
      </div>
    
    <!-- ロール表示 -->
    <div class="sidebar-role">
      <span class="role-badge" id="sidebar-role-badge">管理者</span>
    </div>
    
    <nav class="sidebar-nav">
      <a href="/admin/dashboard.html" class="nav-item">
        <i class="fas fa-history"></i>
        <span class="nav-label">アクティビティ</span>
      </a>
      <a href="/admin/schedules/" class="nav-item active">
        <i class="fas fa-calendar-alt"></i>
        <span class="nav-label">スケジュール</span>
      </a>
      <a href="/admin/customers/" class="nav-item">
        <i class="fas fa-store"></i>
        <span class="nav-label">顧客管理</span>
      </a>
      <a href="/admin/reports/" class="nav-item">
        <i class="fas fa-file-alt"></i>
        <span class="nav-label">レポート</span>
      </a>
      <a href="/admin/estimates/" class="nav-item">
        <i class="fas fa-file-invoice-dollar"></i>
        <span class="nav-label">見積もり</span>
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i class="fas fa-shopping-cart"></i>
        <span class="nav-label">発注管理</span>
      </a>
      <a href="/admin/partners.html" class="nav-item">
        <i class="fas fa-handshake"></i>
        <span class="nav-label">パートナー企業</span>
      </a>
      <a href="/admin/users/" class="nav-item">
        <i class="fas fa-users"></i>
        <span class="nav-label">ユーザー</span>
      </a>
      <a href="/admin/services/" class="nav-item">
        <i class="fas fa-cog"></i>
        <span class="nav-label">サービス管理</span>
      </a>
      <a href="/admin/analytics/" class="nav-item">
        <i class="fas fa-chart-bar"></i>
        <span class="nav-label">分析</span>
      </a>
      <a href="/admin/images/" class="nav-item">
        <i class="fas fa-images"></i>
        <span class="nav-label">メディア</span>
      </a>
      <div class="nav-divider"></div>
      <a href="/wiki" class="nav-item">
        <i class="fas fa-book-open"></i>
        <span class="nav-label">WIKI</span>
      </a>
      <a href="/admin/settings/" class="nav-item">
        <i class="fas fa-sliders-h"></i>
        <span class="nav-label">設定</span>
      </a>
      <a href="/admin/sitemap.html" class="nav-item">
        <i class="fas fa-sitemap"></i>
        <span class="nav-label">サイトマップ</span>
      </a>
      <button class="nav-item nav-item-button" onclick="window.Auth && window.Auth.logout()">
        <i class="fas fa-sign-out-alt"></i>
        <span class="nav-label">ログアウト</span>
      </button>
    </nav>

    <!-- トグルボタン -->
    <button class="sidebar-toggle" id="sidebar-toggle" aria-label="サイドバーを開閉">
      <i class="fas fa-chevron-left"></i>
    </button>
  </aside>

  <!-- メインコンテンツ -->
  <div class="main-content">
    <!-- トップバー -->
    <header class="topbar">
      <div class="topbar-left">
        <h1>スケジュール管理</h1>
      </div>
      <div class="topbar-right">
        <button type="button" class="topbar-btn" id="view-toggle" title="カレンダー表示">
          <i class="fas fa-calendar"></i>
        </button>
        <button type="button" class="btn btn-primary" id="add-schedule-btn">
          <i class="fas fa-plus"></i> 新規作成
        </button>
      </div>
    </header>

    <div class="content-wrapper">

    <!-- 仮押さえアラート -->
    <div class="draft-alert hidden" id="draft-alert">
      <div class="draft-alert-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="draft-alert-content">
        <div class="draft-alert-title">仮押さえ申請があります</div>
        <div class="draft-alert-text" id="draft-alert-text">営業から<span id="draft-count">0</span>件の仮押さえ申請が届いています。清掃員をアサインして確定してください。</div>
      </div>
      <button class="draft-alert-btn" onclick="filterDraft()">
        <i class="fas fa-list"></i> 確認する
      </button>
    </div>

    <!-- フィルター -->
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-group">
          <label>店舗</label>
          <select id="store-filter">
            <option value="">全店舗</option>
          </select>
        </div>
        <div class="filter-group">
          <label>清掃員</label>
          <select id="worker-filter">
            <option value="">全員</option>
          </select>
        </div>
        <div class="filter-group">
          <label>ステータス</label>
          <select id="status-filter">
            <option value="">全て</option>
            <option value="draft">仮押さえ</option>
            <option value="scheduled">確定</option>
            <option value="in_progress">作業中</option>
            <option value="completed">完了</option>
            <option value="cancelled">キャンセル</option>
          </select>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" id="reset-filters">
          <i class="fas fa-undo"></i> リセット
        </button>
      </div>
    </div>

    <!-- リスト表示 -->
    <div class="schedule-list-view" id="list-view">
      <div class="schedule-table-wrapper">
        <table class="schedule-table">
          <thead>
            <tr>
              <th>日時</th>
              <th>店舗</th>
              <th>清掃員</th>
              <th>ステータス</th>
              <th>備考</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="schedule-tbody">
            <tr>
              <td colspan="6" class="loading-cell">
                <i class="fas fa-spinner fa-spin"></i> 読み込み中...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- カレンダー表示 -->
    <div class="schedule-calendar-view" id="calendar-view" style="display:none;">
      <div class="calendar-header">
        <button type="button" class="btn btn-icon" id="prev-month">
          <i class="fas fa-chevron-left"></i>
        </button>
        <h2 id="calendar-month">2025年11月</h2>
        <button type="button" class="btn btn-icon" id="next-month">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="calendar-weekdays">
        <div class="calendar-day-header sun">日</div>
        <div class="calendar-day-header">月</div>
        <div class="calendar-day-header">火</div>
        <div class="calendar-day-header">水</div>
        <div class="calendar-day-header">木</div>
        <div class="calendar-day-header">金</div>
        <div class="calendar-day-header sat">土</div>
      </div>
      <div class="calendar-grid" id="calendar-days"></div>
    </div>
    </div>
  </div>
</main>

<!-- 新規作成/編集ダイアログ -->
<dialog id="schedule-dialog" class="schedule-dialog">
  <div class="dialog-content">
    <button type="button" class="dialog-close" onclick="document.getElementById('schedule-dialog').close()">
      <i class="fas fa-times"></i>
    </button>
    <h3 id="dialog-title">新規スケジュール作成</h3>
    <form id="schedule-form">
      <input type="hidden" id="schedule-id" name="id">
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-store">店舗 <span class="required">*</span></label>
          <select id="schedule-store" name="store_id" required>
            <option value="">選択してください</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-date">日付 <span class="required">*</span></label>
          <input type="date" id="schedule-date" name="scheduled_date" required>
        </div>
        <div class="form-field half">
          <label for="schedule-time">時間 <span class="required">*</span></label>
          <input type="time" id="schedule-time" name="scheduled_time" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-duration">作業時間（分）</label>
          <input type="number" id="schedule-duration" name="duration_minutes" value="60" min="15" step="15">
        </div>
        <div class="form-field half">
          <label for="schedule-worker">担当清掃員</label>
          <select id="schedule-worker" name="worker_id">
            <option value="">未割当</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-status">ステータス</label>
          <select id="schedule-status" name="status">
            <option value="draft">仮押さえ</option>
            <option value="scheduled">確定</option>
            <option value="in_progress">作業中</option>
            <option value="completed">完了</option>
            <option value="cancelled">キャンセル</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-notes">備考</label>
          <textarea id="schedule-notes" name="notes" rows="3" placeholder="特記事項があれば入力"></textarea>
        </div>
      </div>
      
      <div class="form-status" id="form-status"></div>
      <div class="dialog-actions">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('schedule-dialog').close()">キャンセル</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</dialog>

<!-- 削除確認ダイアログ -->
<dialog id="delete-dialog" class="delete-dialog">
  <div class="dialog-content dialog-sm">
    <h3>削除確認</h3>
    <p id="delete-message">このスケジュールを削除しますか？</p>
    <div class="dialog-actions">
      <button type="button" class="btn btn-secondary" onclick="document.getElementById('delete-dialog').close()">キャンセル</button>
      <button type="button" class="btn btn-danger" id="confirm-delete">削除</button>
    </div>
  </div>
</dialog>

<style>
  :root {
    --sidebar-width: 240px;
    --sidebar-width-collapsed: 64px;
    --topbar-height: 64px;
  }

  .admin-schedules-v2 {
    display: flex;
    min-height: 100vh;
    background: #f9fafb;
  }

  /* サイドバー */
  .sidebar {
    width: var(--sidebar-width);
    background: #fff;
    border-right: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: 100;
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
    transition: width 0.3s ease;
    overflow: hidden;
  }
  .sidebar.collapsed {
    width: var(--sidebar-width-collapsed);
  }
  .sidebar.collapsed .nav-label,
  .sidebar.collapsed .logo-text,
  .sidebar.collapsed .sidebar-role {
    opacity: 0;
    width: 0;
    overflow: hidden;
  }
  .sidebar.collapsed .sidebar-toggle i {
    transform: rotate(180deg);
  }
  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
    min-height: 64px;
    display: flex;
    align-items: center;
  }
  .logo-link {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
    color: inherit;
  }
  .logo-img {
    width: 32px;
    height: 32px;
    object-fit: contain;
    flex-shrink: 0;
  }
  .logo-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
    white-space: nowrap;
    transition: opacity 0.3s ease;
  }
  .sidebar-role {
    padding: 8px 20px;
    border-bottom: 1px solid #e5e7eb;
    transition: opacity 0.3s ease;
  }
  .sidebar-role .role-badge {
    display: inline-block;
    padding: 4px 12px;
    background: #e0e7ff;
    color: #3730a3;
    border-radius: 4px;
    font-size: 0.875rem;
    font-weight: 500;
    white-space: nowrap;
  }
  .sidebar-nav {
    flex: 1;
    padding: 12px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    overflow-y: auto;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 12px;
    color: #6b7280;
    text-decoration: none;
    border-radius: 8px;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .nav-item-button {
    background: none;
    border: none;
    cursor: pointer;
    width: 100%;
    text-align: left;
  }
  .nav-item:hover {
    background: #f3f4f6;
    color: #111827;
  }
  .nav-item.active {
    background: var(--primary);
    color: #fff;
  }
  .nav-item i {
    width: 20px;
    text-align: center;
    flex-shrink: 0;
  }
  .nav-label {
    transition: opacity 0.3s ease;
    white-space: nowrap;
  }
  .nav-divider {
    height: 1px;
    background: #e5e7eb;
    margin: 8px 12px;
  }
  .sidebar-toggle {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 28px;
    height: 28px;
    border: 1px solid #e5e7eb;
    border-radius: 50%;
    background: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #6b7280;
    transition: all 0.2s;
    z-index: 200;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .sidebar.collapsed .sidebar-toggle {
    right: 18px;
  }
  .sidebar-toggle:hover {
    background: #f3f4f6;
    border-color: var(--primary);
    color: var(--primary);
  }
  .sidebar-toggle i {
    transition: transform 0.3s ease;
  }

  /* メインコンテンツ */
  .main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: 24px;
    background: #f9fafb;
    transition: margin-left 0.3s ease;
  }
  .sidebar.collapsed ~ .main-content {
    margin-left: var(--sidebar-width-collapsed);
  }

  /* トップバー */
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  .topbar-left h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }
  .topbar-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .topbar-btn {
    width: 44px;
    height: 44px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    color: #6b7280;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .topbar-btn:hover {
    background: #f3f4f6;
    border-color: var(--primary);
    color: var(--primary);
  }

  .content-wrapper {
    /* コンテンツラッパー */
  }
  
  /* フィルター */
  .filter-section {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .filter-group label {
    color: #6b7280;
  }
  .filter-group input,
  .filter-group select {
    background: #fff;
    border-color: #e5e7eb;
    color: #111827;
  }
  .filter-group input:focus,
  .filter-group select:focus {
    border-color: var(--primary);
    outline: none;
  }
  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: flex-end;
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .filter-group label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
  }
  .filter-group input,
  .filter-group select {
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 0.9rem;
  }
  .filter-group input[type="date"] {
    width: 150px;
  }
  .filter-group select {
    min-width: 150px;
  }
  
  /* テーブル */
  .schedule-table-wrapper {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .schedule-table {
    width: 100%;
    border-collapse: collapse;
  }
  .schedule-table th,
  .schedule-table td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid #f3f4f6;
    color: #111827;
  }
  .schedule-table th {
    background: #f9fafb;
    font-size: 0.8rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
  }
  .schedule-table tbody tr:hover {
    background: #fafafa;
  }
  .loading-cell {
    text-align: center;
    padding: 40px !important;
    color: #6b7280;
  }
  
  /* ステータスバッジ */
  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .status-draft { background: #fff3cd; color: #856404; }
  .status-scheduled { background: #dbeafe; color: #1d4ed8; }
  .status-in_progress { background: #fef3c7; color: #b45309; }
  .status-completed { background: #d1fae5; color: #047857; }
  .status-cancelled { background: #fee2e2; color: #b91c1c; }
  
  /* 仮押さえアラート */
  .draft-alert {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 1px solid #ffc107;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .draft-alert.hidden { display: none; }
  .draft-alert-icon {
    width: 48px;
    height: 48px;
    background: #ffc107;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1.25rem;
    flex-shrink: 0;
  }
  .draft-alert-content {
    flex: 1;
  }
  .draft-alert-title {
    font-weight: 600;
    color: #856404;
    margin-bottom: 4px;
  }
  .draft-alert-text {
    font-size: 0.85rem;
    color: #6d5a00;
  }
  .draft-alert-btn {
    padding: 10px 20px;
    background: #ffc107;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    color: #000;
    cursor: pointer;
    transition: all 0.2s;
  }
  .draft-alert-btn:hover {
    background: #e0a800;
  }
  
  /* 仮押さえ行ハイライト */
  .schedule-table tbody tr.draft-row {
    background: #fffde7;
  }
  .schedule-table tbody tr.draft-row:hover {
    background: #fff9c4;
  }
  
  /* 店舗・清掃員情報 */
  .store-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .store-name {
    font-weight: 600;
    color: #111827;
  }
  .store-address {
    font-size: 0.8rem;
    color: #6b7280;
  }
  .worker-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .worker-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: #6b7280;
  }
  .unassigned {
    color: #9ca3af;
    font-style: italic;
  }
  
  /* 操作ボタン */
  .action-btns {
    display: flex;
    gap: 8px;
  }
  .action-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .action-btn.edit { background: #dbeafe; color: #1d4ed8; }
  .action-btn.edit:hover { background: #bfdbfe; }
  .action-btn.delete { background: #fee2e2; color: #b91c1c; }
  .action-btn.delete:hover { background: #fecaca; }
  
  /* カレンダー */
  .calendar-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 24px;
    margin-bottom: 20px;
  }
  .calendar-header h2 {
    font-size: 1.25rem;
    margin: 0;
    min-width: 150px;
    text-align: center;
    color: #111827;
  }
  .btn-icon {
    width: 36px;
    height: 36px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #fff;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-icon:hover {
    background: #f3f4f6;
    border-color: var(--primary);
    color: var(--primary);
  }
  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #f9fafb;
    border-radius: 12px 12px 0 0;
    border: 1px solid #e5e7eb;
    border-bottom: none;
  }
  .calendar-day-header {
    padding: 12px;
    text-align: center;
    font-size: 0.8rem;
    font-weight: 600;
    color: #6b7280;
  }
  .calendar-day-header.sun { color: #ef4444; }
  .calendar-day-header.sat { color: #3b82f6; }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #fff;
    border-radius: 0 0 12px 12px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    border-top: none;
  }
  .calendar-day {
    min-height: 120px;
    padding: 8px;
    border-right: 1px solid #f3f4f6;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: background 0.15s;
    color: #111827;
  }
  .calendar-day:hover {
    background: #f9fafb;
  }
  .calendar-day:nth-child(7n) {
    border-right: none;
  }
  .calendar-day.empty {
    background: #fafafa;
    cursor: default;
  }
  .calendar-day.empty:hover {
    background: #fafafa;
  }
  .calendar-day.today {
    background: #fef3c7;
  }
  .calendar-day.today:hover {
    background: #fde68a;
  }
  .calendar-day.sun .day-number { color: #ef4444; }
  .calendar-day.sat .day-number { color: #3b82f6; }
  .day-number {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 4px;
    color: #111827;
  }
  .day-events {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }
  .day-event {
    font-size: 0.7rem;
    padding: 3px 6px;
    border-radius: 4px;
    background: var(--primary);
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .day-event:hover {
    opacity: 0.85;
  }
  .day-event.status-draft { background: #f59e0b; }
  .day-event.status-scheduled { background: #3b82f6; }
  .day-event.status-in_progress { background: #8b5cf6; }
  .day-event.status-completed { background: #10b981; }
  .day-event.status-cancelled { background: #6b7280; }
  .day-event-more {
    font-size: 0.65rem;
    color: #6b7280;
    text-align: center;
    padding: 2px;
  }
  
  /* ダイアログ */
  .schedule-dialog,
  .delete-dialog {
    border: none;
    border-radius: 16px;
    padding: 0;
    max-width: 560px;
    width: 90vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  }
  .schedule-dialog::backdrop,
  .delete-dialog::backdrop {
    background: rgba(0,0,0,0.5);
  }
  .dialog-content {
    padding: 32px;
    position: relative;
  }
  .dialog-content.dialog-sm {
    text-align: center;
  }
  .dialog-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    font-size: 1.25rem;
    color: #6b7280;
    cursor: pointer;
  }
  .dialog-content h3 {
    font-size: 1.25rem;
    margin: 0 0 24px;
    color: #111827;
  }
  .form-row {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
  }
  .form-field {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .form-field.half {
    flex: 0 0 calc(50% - 8px);
  }
  .form-field label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
  }
  .required {
    color: #ef4444;
  }
  .form-field input,
  .form-field select,
  .form-field textarea {
    padding: 10px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.95rem;
  }
  .form-field input:focus,
  .form-field select:focus,
  .form-field textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(255, 103, 156, 0.1);
  }
  .form-status {
    margin: 16px 0;
    font-size: 0.9rem;
  }
  .form-status.success { color: #047857; }
  .form-status.error { color: #b91c1c; }
  .dialog-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
  }
  
  /* ページネーション */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
  }
  .pagination button {
    padding: 8px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: #fff;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .pagination button.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }
  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  @media (max-width: 768px) {
    .filter-row {
      flex-direction: column;
    }
    .filter-group {
      width: 100%;
    }
    .filter-group input,
    .filter-group select {
      width: 100%;
    }
    .form-row {
      flex-direction: column;
    }
    .form-field.half {
      flex: 1;
    }
  }
</style>

<script>
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  
  let allSchedules = [];
  let allStores = [];
  let allWorkers = [];
  let filteredSchedules = [];
  let currentPage = 1;
  const perPage = 20;
  let currentView = 'list';
  let currentMonth = new Date();
  let deleteTargetId = null;

  // DOM要素
  const tbody = document.getElementById('schedule-tbody');
  const pagination = document.getElementById('pagination');
  const scheduleDialog = document.getElementById('schedule-dialog');
  const deleteDialog = document.getElementById('delete-dialog');
  const scheduleForm = document.getElementById('schedule-form');
  const formStatus = document.getElementById('form-status');

  // 初期化
  document.addEventListener('DOMContentLoaded', async () => {
    await Promise.all([loadStores(), loadWorkers(), loadSchedules()]);
    setupEventListeners();
  });

  // データ読み込み
  async function loadSchedules() {
    try {
      const response = await fetch(`${API_BASE}/schedules`);
      if (!response.ok) {
        throw new Error('Failed to load schedules');
      }
      const schedulesData = await response.json();
      // APIレスポンスが配列かオブジェクトかをチェック
      allSchedules = Array.isArray(schedulesData) ? schedulesData : (schedulesData.items || schedulesData.schedules || []);
      updateDraftAlert();
      filterAndRender();
    } catch (error) {
      console.error('Failed to load schedules:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">読み込みに失敗しました</td></tr>';
    }
  }

  // 仮押さえアラート更新
  function updateDraftAlert() {
    const draftCount = allSchedules.filter(s => s.status === 'draft').length;
    const alertEl = document.getElementById('draft-alert');
    const countEl = document.getElementById('draft-count');
    
    if (draftCount > 0) {
      alertEl.classList.remove('hidden');
      countEl.textContent = draftCount;
    } else {
      alertEl.classList.add('hidden');
    }
  }

  // 仮押さえフィルター
  function filterDraft() {
    document.getElementById('status-filter').value = 'draft';
    filterAndRender();
  }

  async function loadStores() {
    try {
      const response = await fetch(`${API_BASE}/stores`);
      allStores = await response.json();
      populateStoreSelects();
    } catch (error) {
      console.error('Failed to load stores:', error);
    }
  }

  async function loadWorkers() {
    try {
      const response = await fetch(`${API_BASE}/workers`);
      allWorkers = await response.json();
      populateWorkerSelects();
    } catch (error) {
      console.error('Failed to load workers:', error);
    }
  }

  function populateStoreSelects() {
    const options = allStores.map(s => `<option value="${s.id}">${escapeHtml(s.name || '')}</option>`).join('');
    document.getElementById('store-filter').innerHTML = '<option value="">全店舗</option>' + options;
    document.getElementById('schedule-store').innerHTML = '<option value="">選択してください</option>' + options;
  }

  function populateWorkerSelects() {
    // 清掃員のみを抽出（role が staff のユーザー）
    let cleaners = allWorkers.filter(w => (w.role || '').toLowerCase() === 'staff');

    // 万が一 role 情報が無い / staff が一人もいない場合は、従来どおり全件を使う
    if (cleaners.length === 0) {
      cleaners = allWorkers;
    }

    const options = cleaners.map(w => `<option value="${w.id}">${escapeHtml(w.name || '')}</option>`).join('');
    document.getElementById('worker-filter').innerHTML = '<option value="">全員</option>' + options;
    // 担当清掃員: 「全員（オープン）」を選ぶと特定の清掃員に割り当てずオープンな状態にできる
    document.getElementById('schedule-worker').innerHTML = '<option value="">全員（オープン）</option>' + options;
  }

  // フィルタリング
  function filterAndRender() {
    const storeId = document.getElementById('store-filter').value;
    const workerId = document.getElementById('worker-filter').value;
    const status = document.getElementById('status-filter').value;

    filteredSchedules = allSchedules.filter(s => {
      // store_id または client_id に対応
      const scheduleStoreId = s.store_id || s.client_id;
      const matchStore = !storeId || scheduleStoreId === storeId;
      // worker_id または assigned_to に対応
      const scheduleWorkerId = s.worker_id || s.assigned_to;
      const matchWorker = !workerId || scheduleWorkerId === workerId;
      const matchStatus = !status || s.status === status;
      return matchStore && matchWorker && matchStatus;
    });

    // 日付順ソート
    filteredSchedules.sort((a, b) => {
      const dateA = a.date || a.scheduled_date || '';
      const dateB = b.date || b.scheduled_date || '';
      const timeA = a.time_slot || a.scheduled_time || '00:00';
      const timeB = b.time_slot || b.scheduled_time || '00:00';
      return `${dateA} ${timeA}`.localeCompare(`${dateB} ${timeB}`);
    });

    currentPage = 1;
    renderTable();
    renderPagination();
  }

  // テーブル描画
  function renderTable() {
    const start = (currentPage - 1) * perPage;
    const pageSchedules = filteredSchedules.slice(start, start + perPage);

    if (pageSchedules.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">該当するスケジュールがありません</td></tr>';
      return;
    }

    tbody.innerHTML = pageSchedules.map(schedule => {
      // 正規化されたスケジュールデータを使用
      const normalized = DataUtils.normalizeSchedule(schedule);
      // store_id または client_id に対応（営業側は client_id を使用）
      const storeId = normalized.store_id || schedule.store_id || schedule.client_id;
      const store = DataUtils.findStore(allStores, storeId) || {};
      // worker_id または assigned_to に対応
      const workerId = normalized.worker_id || schedule.worker_id || schedule.assigned_to;
      const worker = allWorkers.find(w => w.id === workerId);
      const isDraft = schedule.status === 'draft';
      
      const displayStoreName = DataUtils.getStoreName(allStores, storeId, normalized.store_name || schedule.store_name || schedule.client_name);
      
      return `
        <tr data-id="${schedule.id}" class="${isDraft ? 'draft-row' : ''}">
          <td>
            <div><strong>${formatDate(normalized.date)}</strong></div>
            <div style="font-size:0.85rem;color:#6b7280">${normalized.time || '-'} (${normalized.duration}分)</div>
          </td>
          <td>
            <div class="store-info">
              <span class="store-name">${escapeHtml(displayStoreName)}</span>
              <span class="store-address">${escapeHtml(store.pref || '')}${escapeHtml(store.city || '')}</span>
            </div>
          </td>
          <td>
            ${worker ? `
              <div class="worker-info">
                <span class="worker-avatar">${(worker.name || '?')[0]}</span>
                <span>${escapeHtml(worker.name || '')}</span>
              </div>
            ` : '<span class="unassigned">未割当</span>'}
          </td>
          <td>
            <span class="status-badge status-${normalized.status}">${getStatusLabel(normalized.status)}</span>
          </td>
          <td>${escapeHtml(normalized.work_content)}</td>
          <td>
            <div class="action-btns">
              ${isDraft ? `
                <button class="action-btn assign" title="アサイン・確定" onclick="editSchedule('${schedule.id}')" style="background:#ffc107;color:#333">
                  <i class="fas fa-user-check"></i>
                </button>
              ` : `
                <button class="action-btn edit" title="編集" onclick="editSchedule('${schedule.id}')">
                  <i class="fas fa-edit"></i>
                </button>
              `}
              <button class="action-btn delete" title="削除" onclick="confirmDelete('${schedule.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  // ページネーション
  function renderPagination() {
    const totalPages = Math.ceil(filteredSchedules.length / perPage);
    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }

    let html = '';
    html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">前</button>`;
    
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
        html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      } else if (i === currentPage - 3 || i === currentPage + 3) {
        html += `<span style="padding:8px">...</span>`;
      }
    }
    
    html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">次</button>`;
    pagination.innerHTML = html;
  }

  window.goToPage = function(page) {
    currentPage = page;
    renderTable();
    renderPagination();
  };

  // イベントリスナー
  function setupEventListeners() {
    // フィルター
    document.getElementById('store-filter').addEventListener('change', filterAndRender);
    document.getElementById('worker-filter').addEventListener('change', filterAndRender);
    document.getElementById('status-filter').addEventListener('change', filterAndRender);
    
    document.getElementById('reset-filters').addEventListener('click', () => {
      document.getElementById('store-filter').value = '';
      document.getElementById('worker-filter').value = '';
      document.getElementById('status-filter').value = '';
      filterAndRender();
    });

    // 表示切替
    document.getElementById('view-toggle').addEventListener('click', () => {
      if (currentView === 'list') {
        currentView = 'calendar';
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('calendar-view').style.display = 'block';
        document.getElementById('view-toggle').innerHTML = '<i class="fas fa-list"></i>';
        document.getElementById('view-toggle').title = 'リスト表示';
        renderCalendar();
      } else {
        currentView = 'list';
        document.getElementById('list-view').style.display = 'block';
        document.getElementById('calendar-view').style.display = 'none';
        document.getElementById('view-toggle').innerHTML = '<i class="fas fa-calendar"></i>';
        document.getElementById('view-toggle').title = 'カレンダー表示';
      }
    });

    // カレンダー月ナビゲーション
    document.getElementById('prev-month').addEventListener('click', () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
      renderCalendar();
    });

    document.getElementById('next-month').addEventListener('click', () => {
      currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
      renderCalendar();
    });

    // 新規作成
    document.getElementById('add-schedule-btn').addEventListener('click', () => {
      document.getElementById('dialog-title').textContent = '新規スケジュール作成';
      scheduleForm.reset();
      document.getElementById('schedule-id').value = '';
      document.getElementById('schedule-date').value = new Date().toISOString().split('T')[0];
      formStatus.textContent = '';
      scheduleDialog.showModal();
    });

    // フォーム送信
    scheduleForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('schedule-id').value;
      const isNew = !id;
      const originalSchedule = isNew ? null : allSchedules.find(s => s.id === id);
      
      const data = {
        store_id: document.getElementById('schedule-store').value,
        scheduled_date: document.getElementById('schedule-date').value,
        scheduled_time: document.getElementById('schedule-time').value,
        duration_minutes: parseInt(document.getElementById('schedule-duration').value) || 60,
        worker_id: document.getElementById('schedule-worker').value || null,
        status: document.getElementById('schedule-status').value,
        notes: document.getElementById('schedule-notes').value
      };

      // 清掃員を割り当てた場合、仮押さえ（draft）から確定（scheduled）に自動更新
      if (!isNew && originalSchedule) {
        const wasDraft = originalSchedule.status === 'draft';
        const hadWorker = originalSchedule.worker_id && originalSchedule.worker_id !== '';
        const hasWorker = data.worker_id && data.worker_id !== '';
        const workerAssigned = !hadWorker && hasWorker; // 新しく清掃員が割り当てられた
        
        // 仮押さえ状態で清掃員を新しく割り当てた場合、自動的に確定に変更
        if (wasDraft && workerAssigned) {
          data.status = 'scheduled';
          document.getElementById('schedule-status').value = 'scheduled';
        }
      }

      if (isNew) {
        data.id = DataUtils.IdUtils.generateSchedule();
        data.created_at = new Date().toISOString();
      } else {
        data.id = id;
      }
      data.updated_at = new Date().toISOString();

      try {
        formStatus.textContent = '保存中...';
        
        const response = await fetch(`${API_BASE}/schedules${isNew ? '' : '/' + id}`, {
          method: isNew ? 'POST' : 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          formStatus.textContent = '保存しました';
          formStatus.className = 'form-status success';
          
          if (isNew) {
            allSchedules.unshift(data);
          } else {
            const idx = allSchedules.findIndex(s => s.id === id);
            if (idx >= 0) allSchedules[idx] = { ...allSchedules[idx], ...data };
          }
          filterAndRender();
          
          setTimeout(() => scheduleDialog.close(), 500);
        } else {
          throw new Error('Save failed');
        }
      } catch (error) {
        console.error('Error:', error);
        formStatus.textContent = '保存に失敗しました';
        formStatus.className = 'form-status error';
      }
    });

    // 削除確認
    document.getElementById('confirm-delete').addEventListener('click', async () => {
      if (!deleteTargetId) return;
      
      try {
        const response = await fetch(`${API_BASE}/schedules/${deleteTargetId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          allSchedules = allSchedules.filter(s => s.id !== deleteTargetId);
          filterAndRender();
          deleteDialog.close();
        }
      } catch (error) {
        console.error('Delete failed:', error);
        alert('削除に失敗しました');
      }
    });
  }

  // 編集
  window.editSchedule = function(id) {
    const schedule = allSchedules.find(s => s.id === id);
    if (!schedule) return;

    // 正規化されたスケジュールデータを使用
    const normalized = DataUtils.normalizeSchedule(schedule);
    const storeId = normalized.store_id || schedule.store_id || schedule.client_id;
    const date = normalized.date || schedule.date || schedule.scheduled_date || '';
    const time = normalized.time || schedule.time_slot || schedule.scheduled_time || '';
    const workerId = normalized.worker_id || schedule.worker_id || schedule.assigned_to || '';

    document.getElementById('dialog-title').textContent = 'スケジュール編集';
    document.getElementById('schedule-id').value = schedule.id;
    document.getElementById('schedule-store').value = storeId || '';
    document.getElementById('schedule-date').value = date;
    document.getElementById('schedule-time').value = time;
    document.getElementById('schedule-duration').value = schedule.duration_minutes || normalized.duration || 60;
    document.getElementById('schedule-worker').value = workerId;
    document.getElementById('schedule-status').value = schedule.status || 'scheduled';
    document.getElementById('schedule-notes').value = schedule.notes || normalized.notes || '';
    formStatus.textContent = '';
    scheduleDialog.showModal();
  };

  // 削除確認
  window.confirmDelete = function(id) {
    deleteTargetId = id;
    deleteDialog.showModal();
  };

  // ユーティリティ
  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const [y, m, d] = dateStr.split('-');
    const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
    const date = new Date(dateStr);
    return `${m}/${d}(${weekdays[date.getDay()]})`;
  }

  function getStatusLabel(status) {
    const labels = {
      'draft': '仮押さえ',
      'scheduled': '確定',
      'in_progress': '作業中',
      'completed': '完了',
      'cancelled': 'キャンセル'
    };
    return labels[status] || status || '予定';
  }

  // カレンダー描画
  function renderCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    document.getElementById('calendar-month').textContent = `${year}年${month + 1}月`;
    
    const calendarDays = document.getElementById('calendar-days');
    calendarDays.innerHTML = '';
    
    // 月の最初の日と最後の日
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDayOfWeek = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    
    // 今日の日付
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    // 前月の空白セル
    for (let i = 0; i < startDayOfWeek; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day empty';
      calendarDays.appendChild(emptyCell);
    }
    
    // 日付セル
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const dayOfWeek = new Date(year, month, day).getDay();
      
      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day';
      if (dateStr === todayStr) dayCell.classList.add('today');
      if (dayOfWeek === 0) dayCell.classList.add('sun');
      if (dayOfWeek === 6) dayCell.classList.add('sat');
      
      // 日付番号
      const dayNum = document.createElement('div');
      dayNum.className = 'day-number';
      dayNum.textContent = day;
      dayCell.appendChild(dayNum);
      
      // その日のスケジュール（date または scheduled_date フィールドに対応）
      const daySchedules = allSchedules.filter(s => {
        const scheduleDate = s.date || s.scheduled_date;
        return scheduleDate === dateStr;
      });
      if (daySchedules.length > 0) {
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'day-events';
        
        // 最大3件表示
        daySchedules.slice(0, 3).forEach(schedule => {
          const event = document.createElement('div');
          const normalized = DataUtils.normalizeSchedule(schedule);
          event.className = `day-event status-${normalized.status}`;
          const storeId = normalized.store_id || schedule.store_id || schedule.client_id;
          const displayName = DataUtils.getStoreName(allStores, storeId, normalized.store_name || schedule.store_name || schedule.client_name);
          event.textContent = displayName;
          event.title = `${normalized.time || ''} ${displayName}`;
          event.onclick = () => openEditDialog(schedule);
          eventsContainer.appendChild(event);
        });
        
        // 3件以上ある場合
        if (daySchedules.length > 3) {
          const more = document.createElement('div');
          more.className = 'day-event-more';
          more.textContent = `+${daySchedules.length - 3}件`;
          eventsContainer.appendChild(more);
        }
        
        dayCell.appendChild(eventsContainer);
      }
      
      // 日付クリックで新規作成
      dayCell.addEventListener('click', (e) => {
        if (e.target.classList.contains('day-event') || e.target.classList.contains('day-event-more')) return;
        openAddDialog();
        document.getElementById('schedule-date').value = dateStr;
      });
      
      calendarDays.appendChild(dayCell);
    }
    
    // 次月の空白セル（6行になるように）
    const totalCells = startDayOfWeek + daysInMonth;
    const remainingCells = (7 - (totalCells % 7)) % 7;
    for (let i = 0; i < remainingCells; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day empty';
      calendarDays.appendChild(emptyCell);
    }
  }

  // サイドバー開閉機能
  const sidebar = document.getElementById('admin-sidebar');
  const sidebarToggle = document.getElementById('sidebar-toggle');
  
  if (sidebar && sidebarToggle) {
    // ローカルストレージから状態を読み込み
    const isCollapsed = localStorage.getItem('sidebar-collapsed') === 'true';
    if (isCollapsed) {
      sidebar.classList.add('collapsed');
    }
    
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      const collapsed = sidebar.classList.contains('collapsed');
      localStorage.setItem('sidebar-collapsed', collapsed);
    });
  }

  // ロール表示の更新
  function updateRoleBadge() {
    const roleBadge = document.getElementById('sidebar-role-badge');
    if (!roleBadge) return;
    
    // ロール情報を取得
    if (window.Auth && window.Auth.getCurrentUser) {
      const user = window.Auth.getCurrentUser();
      if (user && user.role) {
        const roleConfig = window.RoleConfig?.ROLE_CONFIG;
        const roleInfo = roleConfig?.roles?.[user.role];
        if (roleInfo) {
          roleBadge.textContent = roleInfo.displayName || roleInfo.name || user.role;
          
          // ロールに応じたバッジの色を設定
          const badgeColors = {
            'guest': { bg: '#e5e7eb', color: '#6b7280' },
            'customer': { bg: '#dbeafe', color: '#1e40af' },
            'staff': { bg: '#dcfce7', color: '#166534' },
            'concierge': { bg: '#fef3c7', color: '#92400e' },
            'admin': { bg: '#e0e7ff', color: '#3730a3' },
            'developer': { bg: '#fce7f3', color: '#831843' },
            'master': { bg: '#fef2f2', color: '#991b1b' }
          };
          
          const colors = badgeColors[user.role] || badgeColors['admin'];
          roleBadge.style.background = colors.bg;
          roleBadge.style.color = colors.color;
        }
      }
    } else {
      // デフォルトで管理者として表示
      roleBadge.textContent = '管理者';
    }
  }
  
  // ページ読み込み時にロールを更新
  updateRoleBadge();
  
  // Authの状態が変わったときにロールを更新
  if (window.Auth && window.Auth.onAuthStateChanged) {
    window.Auth.onAuthStateChanged(() => {
      updateRoleBadge();
    });
  }
</script>

