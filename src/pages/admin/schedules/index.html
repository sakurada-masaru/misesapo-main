<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <base href="/" />
    <title></title>
    <link rel="icon" type="image/png" href="/images/logo_144x144.png" />
<link rel="shortcut icon" href="/images/logo_144x144.png" />
<link rel="apple-touch-icon" href="/images/logo_144x144.png" />
<link rel="stylesheet" href="/styles.css" />
<link rel="stylesheet" href="/css/header.css" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<!-- 
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  body { font-family: 'Noto Sans JP', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; }
  /* Brand theme variables (default + variants) */
  body { --primary: #FF679C; --primary-600: #E35687; }
  body.theme-pink { --primary: #FF679C; --primary-600: #E35687; }
  body.theme-blue { --primary: #2563eb; --primary-600: #1d4ed8; }
  body.theme-emerald { --primary: #10b981; --primary-600: #059669; }
  /* Note: :root also defines the same brand color; inline vars ensure early paint */
  </style>

    <link rel="stylesheet" href="/css/admin-sidebar.css" />
    <!-- DataUtils スクリプト（schedulesページで使用） -->
    <script src="/js/data_utils.js"></script>
  </head>
  <body class="theme-pink ">
    <a class="skip-link" href="#main">メインコンテンツへスキップ</a>
    



<link rel="stylesheet" href="/css/admin-schedules.css" />

<main id="main" class="admin-schedules-v2">
  <!-- モバイルメニューボタン -->
<button class="mobile-menu-button" id="mobile-menu-button" aria-label="メニューを開く">
  <i class="fas fa-bars"></i>
</button>

<!-- サイドバーオーバーレイ -->
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<!-- サイドバー -->
<aside class="sidebar" id="admin-sidebar">
  <div class="sidebar-header">
    <a href="/admin/dashboard" class="logo-link">
      <img src="/images/logo_144x144.png" alt="ミセサポ" class="logo-img" />
      <span class="logo-text">ミセサポ</span>
    </a>
  </div>

  <!-- ロール表示 -->
  <div class="sidebar-role">
    <span class="role-badge" id="sidebar-role-badge">管理者</span>
  </div>

  <nav class="sidebar-nav">
    <!-- マイページ（目立たせる） -->
    <a href="/staff/mypage" class="nav-item nav-item-mypage" data-page="mypage" id="sidebar-mypage-link">
      <i class="fas fa-user-circle"></i>
      <span class="nav-label">マイページ</span>
    </a>
    <div class="nav-divider"></div>
    <!-- 管理メニュー -->
    <a href="/admin/dashboard" class="nav-item" data-page="dashboard">
      <i class="fas fa-history"></i>
      <span class="nav-label">アクティビティ</span>
    </a>
    <a href="/admin/schedules/" class="nav-item" data-page="schedules">
      <i class="fas fa-calendar-alt"></i>
      <span class="nav-label">スケジュール</span>
    </a>
    <a href="/admin/customers/" class="nav-item" data-page="customers">
      <i class="fas fa-store"></i>
      <span class="nav-label">顧客管理</span>
    </a>
    <a href="/admin/reports/" class="nav-item" data-page="reports">
      <i class="fas fa-file-alt"></i>
      <span class="nav-label">レポート</span>
    </a>
    <a href="/admin/estimates/" class="nav-item" data-page="estimates">
      <i class="fas fa-file-invoice-dollar"></i>
      <span class="nav-label">見積もり</span>
    </a>
    <a href="/admin/orders" class="nav-item" data-page="orders">
      <i class="fas fa-shopping-cart"></i>
      <span class="nav-label">発注管理</span>
    </a>
    <a href="/admin/partners" class="nav-item" data-page="partners">
      <i class="fas fa-handshake"></i>
      <span class="nav-label">パートナー企業</span>
    </a>
    <a href="/admin/users/" class="nav-item" data-page="users">
      <i class="fas fa-users"></i>
      <span class="nav-label">ユーザー管理</span>
    </a>
    <a href="/admin/attendance/errors" class="nav-item" data-page="attendance-errors">
      <i class="fas fa-exclamation-triangle"></i>
      <span class="nav-label">勤怠管理</span>
    </a>
    <a href="/admin/services/" class="nav-item" data-page="services">
      <i class="fas fa-cog"></i>
      <span class="nav-label">サービス管理</span>
    </a>
    <a href="/admin/analytics/" class="nav-item" data-page="analytics">
      <i class="fas fa-chart-bar"></i>
      <span class="nav-label">分析</span>
    </a>
    <a href="/admin/images/" class="nav-item" data-page="images">
      <i class="fas fa-images"></i>
      <span class="nav-label">メディア</span>
    </a>
    <a href="/admin/zaiko" class="nav-item" data-page="zaiko">
      <i class="fas fa-boxes"></i>
      <span class="nav-label">在庫管理</span>
    </a>
    <a href="/admin/announcements" class="nav-item" data-page="announcements">
      <i class="fas fa-bullhorn"></i>
      <span class="nav-label">業務連絡</span>
    </a>
    <div class="nav-divider"></div>
    <a href="/wiki" class="nav-item" data-page="wiki">
      <i class="fas fa-book-open"></i>
      <span class="nav-label">WIKI</span>
    </a>
    <a href="/admin/sitemap" class="nav-item" data-page="sitemap">
      <i class="fas fa-sitemap"></i>
      <span class="nav-label">サイトマップ</span>
    </a>
    <button class="nav-item nav-item-button" onclick="staffLogout()">
      <i class="fas fa-sign-out-alt"></i>
      <span class="nav-label">ログアウト</span>
    </button>
  </nav>

  <!-- トグルボタン -->
  <button class="sidebar-toggle" id="sidebar-toggle" aria-label="サイドバーを開閉">
    <i class="fas fa-chevron-left"></i>
  </button>
</aside>

<script>
  // 従業員用ログアウト関数（グローバル）
  function staffLogout() {
    // Cognitoからログアウト
    if (window.CognitoAuth && typeof window.CognitoAuth.logout === 'function') {
      window.CognitoAuth.logout();
    }
    // ローカルストレージをクリア
    localStorage.removeItem('cognito_user');
    localStorage.removeItem('misesapo_auth');
    localStorage.removeItem('cognito_id_token');
    localStorage.removeItem('cognito_access_token');
    localStorage.removeItem('cognito_refresh_token');
    // 従業員ログイン画面にリダイレクト
    window.location.href = '/staff/signin.html';
  }
</script>


  <!-- メインコンテンツ -->
  <div class="main-content">
    <!-- トップバー -->
    <header class="topbar">
      <div class="topbar-left">
        <h1>スケジュール管理</h1>
      </div>
      <div class="topbar-right">
        <button type="button" class="topbar-btn" id="view-toggle" title="カレンダー表示">
          <i class="fas fa-calendar"></i>
        </button>
        <button type="button" class="btn btn-primary" id="add-schedule-btn">
          <i class="fas fa-plus"></i> 新規作成
        </button>
      </div>
    </header>

    <div class="content-wrapper">

    <!-- 新規案件アラート -->
    <div class="draft-alert hidden" id="draft-alert">
      <div class="draft-alert-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="draft-alert-content">
        <div class="draft-alert-title">新規案件があります</div>
        <div class="draft-alert-text" id="draft-alert-text">営業から<span id="draft-count">0</span>件の新規案件が届いています。清掃員をアサインして確定してください。</div>
      </div>
      <button class="draft-alert-btn" onclick="filterDraft()">
        <i class="fas fa-list"></i> 確認する
      </button>
    </div>

    <!-- フィルター -->
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-group">
          <label>店舗</label>
          <select id="store-filter">
            <option value="">全店舗</option>
          </select>
        </div>
        <div class="filter-group">
          <label>営業ID</label>
          <select id="sales-filter">
            <option value="">全営業</option>
          </select>
        </div>
        <div class="filter-group">
          <label>清掃員</label>
          <select id="worker-filter">
            <option value="">全員</option>
          </select>
        </div>
        <div class="filter-group">
          <label>ステータス</label>
          <select id="status-filter">
            <option value="">全て</option>
            <option value="draft">未確定</option>
            <option value="scheduled">確定</option>
            <option value="in_progress">作業中</option>
            <option value="completed">完了</option>
            <option value="cancelled">キャンセル</option>
          </select>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" id="reset-filters">
          <i class="fas fa-undo"></i> リセット
        </button>
      </div>
    </div>

    <!-- リスト表示 -->
    <div class="schedule-list-view" id="list-view">
      <!-- 狭い画面ではカード表示（JSで描画） -->
      <div class="schedule-cards" id="schedule-cards" style="display:none;"></div>
      <div class="schedule-table-wrapper">
        <table class="schedule-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>日時</th>
              <th><span class="th-client">法人名/</span><span class="th-brand">ブランド名</span></th>
              <th>店舗</th>
              <th>営業担当</th>
              <th>清掃員</th>
              <th>ステータス</th>
              <th>清掃内容</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="schedule-tbody">
            <tr>
              <td colspan="9" class="loading-cell">
                <i class="fas fa-spinner fa-spin"></i> 読み込み中...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- カレンダー表示 -->
    <div class="schedule-calendar-view" id="calendar-view" style="display:none;">
      <div class="calendar-header">
        <button type="button" class="btn btn-icon" id="prev-month">
          <i class="fas fa-chevron-left"></i>
        </button>
        <h2 id="calendar-month">2025年11月</h2>
        <button type="button" class="btn btn-icon" id="next-month">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="calendar-weekdays">
        <div class="calendar-day-header sun">日</div>
        <div class="calendar-day-header">月</div>
        <div class="calendar-day-header">火</div>
        <div class="calendar-day-header">水</div>
        <div class="calendar-day-header">木</div>
        <div class="calendar-day-header">金</div>
        <div class="calendar-day-header sat">土</div>
      </div>
      <div class="calendar-grid" id="calendar-days"></div>
    </div>
    </div>
  </div>
</main>

<!-- 新規作成/編集ダイアログ -->
<dialog id="schedule-dialog" class="schedule-dialog">
  <div class="dialog-content">
    <button type="button" class="dialog-close" onclick="document.getElementById('schedule-dialog').close()">
      <i class="fas fa-times"></i>
    </button>
    <h3 id="dialog-title">新規スケジュール作成</h3>
    <form id="schedule-form">
      <input type="hidden" id="schedule-id" name="id">
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-store-search">店舗・ブランド・法人名 <span class="required">*</span></label>
          <div class="store-search-wrapper">
            <div class="store-search-controls">
              <select id="store-category-filter" class="store-category-filter">
                <option value="">全て</option>
                <option value="store">店舗名</option>
                <option value="brand">ブランド名</option>
                <option value="client">法人名</option>
              </select>
            <input type="text" id="schedule-store-search" placeholder="店舗名、ブランド名、法人名で検索..." autocomplete="off" required>
            </div>
            <input type="hidden" id="schedule-store" name="store_id">
            <div class="store-search-results" id="schedule-store-results" style="display: none;"></div>
          </div>
          <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
            <a class="btn btn-secondary btn-sm" href="/admin/customers/" target="_blank" rel="noopener noreferrer" id="open-customers-page-btn">
              <i class="fas fa-external-link-alt"></i> 新規顧客（店舗）登録
            </a>
            <button type="button" class="btn btn-secondary btn-sm" id="reload-customers-data-btn">
              <i class="fas fa-sync-alt"></i> 顧客データ再読み込み
            </button>
          </div>
          <div id="schedule-store-summary" style="margin-top:8px;color:#6b7280;font-size:0.875rem;">
            <div><strong style="color:#111827;">選択中:</strong> <span id="schedule-store-summary-store">-</span></div>
            <div>法人: <span id="schedule-store-summary-client">-</span> / ブランド: <span id="schedule-store-summary-brand">-</span></div>
            <div>住所: <span id="schedule-store-summary-address">-</span></div>
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="schedule-address">住所（必要に応じて編集）</label>
          <textarea id="schedule-address" name="address" rows="2" placeholder="住所を入力（店舗選択で自動入力されます）"></textarea>
        </div>
      </div>

      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-phone">電話番号</label>
          <input type="tel" id="schedule-phone" name="phone" placeholder="店舗の電話番号（店舗選択で自動入力）">
        </div>
        <div class="form-field half">
          <label for="schedule-email">メール</label>
          <input type="email" id="schedule-email" name="email" placeholder="連絡先メール（店舗選択で自動入力）">
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="schedule-contact-person">相手先担当者名</label>
          <input type="text" id="schedule-contact-person" name="contact_person" placeholder="当日の相手先担当者（店舗選択で自動入力）">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-date">日付 <span class="required">*</span></label>
          <input type="date" id="schedule-date" name="scheduled_date" required>
        </div>
        <div class="form-field half">
          <label for="schedule-time">時間 <span class="required">*</span></label>
          <input type="time" id="schedule-time" name="scheduled_time" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-duration">作業時間（分）</label>
          <input type="number" id="schedule-duration" name="duration_minutes" value="60" min="15" step="15">
        </div>
        <div class="form-field half">
          <label for="schedule-sales">営業担当者</label>
          <select id="schedule-sales" name="sales_id">
            <option value="">未設定</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-worker">担当清掃員</label>
          <select id="schedule-worker" name="worker_id">
            <option value="">未割当</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="cleaning-items-search">清掃内容</label>
          <div class="cleaning-items-search-wrapper">
            <div class="store-search-controls">
              <select id="cleaning-category-filter" class="store-category-filter">
                <option value="">全て</option>
                <option value="service">サービス名</option>
              </select>
              <input type="text" id="cleaning-items-search" placeholder="清掃内容（サービス）を検索..." autocomplete="off">
            </div>
            <div class="cleaning-items-results" id="cleaning-items-results" style="display: none;"></div>
          </div>
          <div class="cleaning-items-selected" id="cleaning-items-selected">
            <!-- 選択された項目がここに追加される -->
          </div>
          <input type="hidden" id="selected-cleaning-items-json" name="cleaning_items">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-status">ステータス</label>
          <select id="schedule-status" name="status">
            <option value="draft">未確定</option>
            <option value="scheduled">確定</option>
            <option value="in_progress">作業中</option>
            <option value="completed">完了</option>
            <option value="cancelled">キャンセル</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-notes">備考</label>
          <textarea id="schedule-notes" name="notes" rows="3" placeholder="特記事項があれば入力"></textarea>
        </div>
      </div>
      
      <div class="form-status" id="form-status"></div>
      <div class="dialog-actions">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('schedule-dialog').close()">キャンセル</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</dialog>

<!-- 削除確認ダイアログ -->
<dialog id="delete-dialog" class="delete-dialog">
  <div class="dialog-content dialog-sm">
    <h3>削除確認</h3>
    <p id="delete-message">このスケジュールを削除しますか？</p>
    <div class="dialog-actions">
      <button type="button" class="btn btn-secondary" onclick="document.getElementById('delete-dialog').close()">キャンセル</button>
      <button type="button" class="btn btn-danger" id="confirm-delete">削除</button>
    </div>
  </div>
<script src="/js/admin-schedules.js"></script>

    <footer class="site-footer">
  <div class="container text-center muted small" style="padding: 16px 0;">
    <p>&copy; 2025 ミセサポ</p>
  </div>
</footer>


    <!-- AWS SDK and Cognito -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1000.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.0/dist/amazon-cognito-identity.min.js"></script>
    <script src="/js/cognito_config.js"></script>
    <script src="/js/cognito_auth.js"></script>
    <!-- Firebase SDK - 削除済み（Cognitoに移行） -->
    <script src="/js/role_config.js"></script>
    <script src="/js/users.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/modal_manager.js"></script>
    <script src="/app.js"></script>
    <script src="/js/admin-sidebar.js"></script>
    <!-- Page-specific scripts (injected by page content) -->
    <script>
      // 管理画面では共通ヘッダーを持たないため追加スクリプトは不要
    </script>
  </body>
</html>

