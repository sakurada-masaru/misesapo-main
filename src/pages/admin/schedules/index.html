@layout('layouts.base')
@json('data/meta/admin_schedules_title.json', $title)
@json('data/meta/admin_schedules_body_class.json', $body_class)

<script src="/js/data_utils.js"></script>

<main id="main" class="admin-schedules-v2">
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <span class="logo-icon">ğŸ§¹</span>
        <span class="logo-text">ãƒŸã‚»ã‚µãƒ</span>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <a href="/admin/dashboard.html" class="nav-item">
        <i class="fas fa-home"></i>
        <span>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</span>
      </a>
      <a href="/admin/schedules/" class="nav-item active">
        <i class="fas fa-calendar-alt"></i>
        <span>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</span>
      </a>
      <a href="/admin/customers/" class="nav-item">
        <i class="fas fa-store"></i>
        <span>é¡§å®¢ç®¡ç†</span>
      </a>
      <a href="/admin/reports/" class="nav-item">
        <i class="fas fa-file-alt"></i>
        <span>ãƒ¬ãƒãƒ¼ãƒˆ</span>
      </a>
      <a href="/admin/estimates/" class="nav-item">
        <i class="fas fa-file-invoice-dollar"></i>
        <span>è¦‹ç©ã‚‚ã‚Š</span>
      </a>
      <a href="/admin/orders.html" class="nav-item">
        <i class="fas fa-shopping-cart"></i>
        <span>ç™ºæ³¨ç®¡ç†</span>
      </a>
      <a href="/admin/partners.html" class="nav-item">
        <i class="fas fa-handshake"></i>
        <span>ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ä¼æ¥­</span>
      </a>
      <a href="/admin/users/" class="nav-item">
        <i class="fas fa-users"></i>
        <span>ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
      </a>
      <a href="/admin/analytics/" class="nav-item">
        <i class="fas fa-chart-bar"></i>
        <span>åˆ†æ</span>
      </a>
    </nav>

    <div class="sidebar-footer">
      <a href="/admin/cleaning-manual.html" class="nav-item">
        <i class="fas fa-book"></i>
        <span>ãƒãƒ‹ãƒ¥ã‚¢ãƒ«</span>
      </a>
      <a href="/admin/images/" class="nav-item">
        <i class="fas fa-images"></i>
        <span>ç”»åƒç®¡ç†</span>
      </a>
      <a href="/admin/services/" class="nav-item">
        <i class="fas fa-cog"></i>
        <span>è¨­å®š</span>
      </a>
    </div>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div class="main-content">
    <!-- ãƒˆãƒƒãƒ—ãƒãƒ¼ -->
    <header class="topbar">
      <div class="topbar-left">
        <h1>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†</h1>
      </div>
      <div class="topbar-right">
        <button type="button" class="topbar-btn" id="view-toggle" title="ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º">
          <i class="fas fa-calendar"></i>
        </button>
        <button type="button" class="btn btn-primary" id="add-schedule-btn">
          <i class="fas fa-plus"></i> æ–°è¦ä½œæˆ
        </button>
      </div>
    </header>

    <div class="content-wrapper">

    <!-- ä»®æŠ¼ã•ãˆã‚¢ãƒ©ãƒ¼ãƒˆ -->
    <div class="draft-alert hidden" id="draft-alert">
      <div class="draft-alert-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="draft-alert-content">
        <div class="draft-alert-title">ä»®æŠ¼ã•ãˆç”³è«‹ãŒã‚ã‚Šã¾ã™</div>
        <div class="draft-alert-text" id="draft-alert-text">å–¶æ¥­ã‹ã‚‰<span id="draft-count">0</span>ä»¶ã®ä»®æŠ¼ã•ãˆç”³è«‹ãŒå±Šã„ã¦ã„ã¾ã™ã€‚æ¸…æƒå“¡ã‚’ã‚¢ã‚µã‚¤ãƒ³ã—ã¦ç¢ºå®šã—ã¦ãã ã•ã„ã€‚</div>
      </div>
      <button class="draft-alert-btn" onclick="filterDraft()">
        <i class="fas fa-list"></i> ç¢ºèªã™ã‚‹
      </button>
    </div>

    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-group">
          <label>æœŸé–“</label>
          <input type="date" id="date-from" />
          <span>ã€œ</span>
          <input type="date" id="date-to" />
        </div>
        <div class="filter-group">
          <label>åº—èˆ—</label>
          <select id="store-filter">
            <option value="">å…¨åº—èˆ—</option>
          </select>
        </div>
        <div class="filter-group">
          <label>æ¸…æƒå“¡</label>
          <select id="worker-filter">
            <option value="">å…¨å“¡</option>
          </select>
        </div>
        <div class="filter-group">
          <label>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="status-filter">
            <option value="">å…¨ã¦</option>
            <option value="draft">ä»®æŠ¼ã•ãˆ</option>
            <option value="scheduled">ç¢ºå®š</option>
            <option value="in_progress">ä½œæ¥­ä¸­</option>
            <option value="completed">å®Œäº†</option>
            <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
          </select>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" id="reset-filters">
          <i class="fas fa-undo"></i> ãƒªã‚»ãƒƒãƒˆ
        </button>
      </div>
    </div>

    <!-- ãƒªã‚¹ãƒˆè¡¨ç¤º -->
    <div class="schedule-list-view" id="list-view">
      <div class="schedule-table-wrapper">
        <table class="schedule-table">
          <thead>
            <tr>
              <th>æ—¥æ™‚</th>
              <th>åº—èˆ—</th>
              <th>æ¸…æƒå“¡</th>
              <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              <th>å‚™è€ƒ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="schedule-tbody">
            <tr>
              <td colspan="6" class="loading-cell">
                <i class="fas fa-spinner fa-spin"></i> èª­ã¿è¾¼ã¿ä¸­...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º -->
    <div class="schedule-calendar-view" id="calendar-view" style="display:none;">
      <div class="calendar-header">
        <button type="button" class="btn btn-icon" id="prev-month">
          <i class="fas fa-chevron-left"></i>
        </button>
        <h2 id="calendar-month">2025å¹´11æœˆ</h2>
        <button type="button" class="btn btn-icon" id="next-month">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="calendar-weekdays">
        <div class="calendar-day-header sun">æ—¥</div>
        <div class="calendar-day-header">æœˆ</div>
        <div class="calendar-day-header">ç«</div>
        <div class="calendar-day-header">æ°´</div>
        <div class="calendar-day-header">æœ¨</div>
        <div class="calendar-day-header">é‡‘</div>
        <div class="calendar-day-header sat">åœŸ</div>
      </div>
      <div class="calendar-grid" id="calendar-days"></div>
    </div>
    </div>
  </div>
</main>

<!-- æ–°è¦ä½œæˆ/ç·¨é›†ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="schedule-dialog" class="schedule-dialog">
  <div class="dialog-content">
    <button type="button" class="dialog-close" onclick="document.getElementById('schedule-dialog').close()">
      <i class="fas fa-times"></i>
    </button>
    <h3 id="dialog-title">æ–°è¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ</h3>
    <form id="schedule-form">
      <input type="hidden" id="schedule-id" name="id">
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-store">åº—èˆ— <span class="required">*</span></label>
          <select id="schedule-store" name="store_id" required>
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-date">æ—¥ä»˜ <span class="required">*</span></label>
          <input type="date" id="schedule-date" name="scheduled_date" required>
        </div>
        <div class="form-field half">
          <label for="schedule-time">æ™‚é–“ <span class="required">*</span></label>
          <input type="time" id="schedule-time" name="scheduled_time" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-duration">ä½œæ¥­æ™‚é–“ï¼ˆåˆ†ï¼‰</label>
          <input type="number" id="schedule-duration" name="duration_minutes" value="60" min="15" step="15">
        </div>
        <div class="form-field half">
          <label for="schedule-worker">æ‹…å½“æ¸…æƒå“¡</label>
          <select id="schedule-worker" name="worker_id">
            <option value="">æœªå‰²å½“</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-status">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
          <select id="schedule-status" name="status">
            <option value="draft">ä»®æŠ¼ã•ãˆ</option>
            <option value="scheduled">ç¢ºå®š</option>
            <option value="in_progress">ä½œæ¥­ä¸­</option>
            <option value="completed">å®Œäº†</option>
            <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-notes">å‚™è€ƒ</label>
          <textarea id="schedule-notes" name="notes" rows="3" placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›"></textarea>
        </div>
      </div>
      
      <div class="form-status" id="form-status"></div>
      <div class="dialog-actions">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('schedule-dialog').close()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </form>
  </div>
</dialog>

<!-- å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<dialog id="delete-dialog" class="delete-dialog">
  <div class="dialog-content dialog-sm">
    <h3>å‰Šé™¤ç¢ºèª</h3>
    <p id="delete-message">ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
    <div class="dialog-actions">
      <button type="button" class="btn btn-secondary" onclick="document.getElementById('delete-dialog').close()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button type="button" class="btn btn-danger" id="confirm-delete">å‰Šé™¤</button>
    </div>
  </div>
</dialog>

<style>
  :root {
    --sidebar-width: 240px;
    --topbar-height: 64px;
  }

  .admin-schedules-v2 {
    display: flex;
    min-height: 100vh;
    background: #f9fafb;
  }

  /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
  .sidebar {
    width: var(--sidebar-width);
    background: #fff;
    border-right: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: 100;
    box-shadow: 2px 0 8px rgba(0,0,0,0.05);
  }
  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid #e5e7eb;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  .logo-icon {
    font-size: 1.5rem;
  }
  .logo-text {
    font-size: 1.25rem;
    font-weight: 700;
    color: #111827;
  }
  .sidebar-nav {
    flex: 1;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
  .nav-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: #6b7280;
    text-decoration: none;
    border-radius: 10px;
    transition: all 0.2s;
  }
  .nav-item:hover {
    background: #f3f4f6;
    color: #111827;
  }
  .nav-item.active {
    background: var(--primary);
    color: #fff;
  }
  .nav-item i {
    width: 20px;
    text-align: center;
  }
  .sidebar-footer {
    padding: 16px 12px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .main-content {
    flex: 1;
    margin-left: var(--sidebar-width);
    padding: 24px;
    background: #f9fafb;
  }

  /* ãƒˆãƒƒãƒ—ãƒãƒ¼ */
  .topbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
  }
  .topbar-left h1 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #111827;
    margin: 0;
  }
  .topbar-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .topbar-btn {
    width: 44px;
    height: 44px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    color: #6b7280;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.2s;
  }
  .topbar-btn:hover {
    background: #f3f4f6;
    border-color: var(--primary);
    color: var(--primary);
  }

  .content-wrapper {
    /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ©ãƒƒãƒ‘ãƒ¼ */
  }
  
  /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
  .filter-section {
    background: #fff;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .filter-group label {
    color: #6b7280;
  }
  .filter-group input,
  .filter-group select {
    background: #fff;
    border-color: #e5e7eb;
    color: #111827;
  }
  .filter-group input:focus,
  .filter-group select:focus {
    border-color: var(--primary);
    outline: none;
  }
  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: flex-end;
  }
  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .filter-group label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
  }
  .filter-group input,
  .filter-group select {
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    font-size: 0.9rem;
  }
  .filter-group input[type="date"] {
    width: 150px;
  }
  .filter-group select {
    min-width: 150px;
  }
  
  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .schedule-table-wrapper {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .schedule-table {
    width: 100%;
    border-collapse: collapse;
  }
  .schedule-table th,
  .schedule-table td {
    padding: 14px 16px;
    text-align: left;
    border-bottom: 1px solid #f3f4f6;
    color: #111827;
  }
  .schedule-table th {
    background: #f9fafb;
    font-size: 0.8rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
  }
  .schedule-table tbody tr:hover {
    background: #fafafa;
  }
  .loading-cell {
    text-align: center;
    padding: 40px !important;
    color: #6b7280;
  }
  
  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ */
  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .status-draft { background: #fff3cd; color: #856404; }
  .status-scheduled { background: #dbeafe; color: #1d4ed8; }
  .status-in_progress { background: #fef3c7; color: #b45309; }
  .status-completed { background: #d1fae5; color: #047857; }
  .status-cancelled { background: #fee2e2; color: #b91c1c; }
  
  /* ä»®æŠ¼ã•ãˆã‚¢ãƒ©ãƒ¼ãƒˆ */
  .draft-alert {
    background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
    border: 1px solid #ffc107;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .draft-alert.hidden { display: none; }
  .draft-alert-icon {
    width: 48px;
    height: 48px;
    background: #ffc107;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-size: 1.25rem;
    flex-shrink: 0;
  }
  .draft-alert-content {
    flex: 1;
  }
  .draft-alert-title {
    font-weight: 600;
    color: #856404;
    margin-bottom: 4px;
  }
  .draft-alert-text {
    font-size: 0.85rem;
    color: #6d5a00;
  }
  .draft-alert-btn {
    padding: 10px 20px;
    background: #ffc107;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    color: #000;
    cursor: pointer;
    transition: all 0.2s;
  }
  .draft-alert-btn:hover {
    background: #e0a800;
  }
  
  /* ä»®æŠ¼ã•ãˆè¡Œãƒã‚¤ãƒ©ã‚¤ãƒˆ */
  .schedule-table tbody tr.draft-row {
    background: #fffde7;
  }
  .schedule-table tbody tr.draft-row:hover {
    background: #fff9c4;
  }
  
  /* åº—èˆ—ãƒ»æ¸…æƒå“¡æƒ…å ± */
  .store-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }
  .store-name {
    font-weight: 600;
    color: #111827;
  }
  .store-address {
    font-size: 0.8rem;
    color: #6b7280;
  }
  .worker-info {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .worker-avatar {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    background: #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.7rem;
    color: #6b7280;
  }
  .unassigned {
    color: #9ca3af;
    font-style: italic;
  }
  
  /* æ“ä½œãƒœã‚¿ãƒ³ */
  .action-btns {
    display: flex;
    gap: 8px;
  }
  .action-btn {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }
  .action-btn.edit { background: #dbeafe; color: #1d4ed8; }
  .action-btn.edit:hover { background: #bfdbfe; }
  .action-btn.delete { background: #fee2e2; color: #b91c1c; }
  .action-btn.delete:hover { background: #fecaca; }
  
  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
  .calendar-header {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 24px;
    margin-bottom: 20px;
  }
  .calendar-header h2 {
    font-size: 1.25rem;
    margin: 0;
    min-width: 150px;
    text-align: center;
    color: #111827;
  }
  .btn-icon {
    width: 36px;
    height: 36px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    background: #fff;
    color: #6b7280;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-icon:hover {
    background: #f3f4f6;
    border-color: var(--primary);
    color: var(--primary);
  }
  .calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #f9fafb;
    border-radius: 12px 12px 0 0;
    border: 1px solid #e5e7eb;
    border-bottom: none;
  }
  .calendar-day-header {
    padding: 12px;
    text-align: center;
    font-size: 0.8rem;
    font-weight: 600;
    color: #6b7280;
  }
  .calendar-day-header.sun { color: #ef4444; }
  .calendar-day-header.sat { color: #3b82f6; }
  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    background: #fff;
    border-radius: 0 0 12px 12px;
    overflow: hidden;
    border: 1px solid #e5e7eb;
    border-top: none;
  }
  .calendar-day {
    min-height: 120px;
    padding: 8px;
    border-right: 1px solid #f3f4f6;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    transition: background 0.15s;
    color: #111827;
  }
  .calendar-day:hover {
    background: #f9fafb;
  }
  .calendar-day:nth-child(7n) {
    border-right: none;
  }
  .calendar-day.empty {
    background: #fafafa;
    cursor: default;
  }
  .calendar-day.empty:hover {
    background: #fafafa;
  }
  .calendar-day.today {
    background: #fef3c7;
  }
  .calendar-day.today:hover {
    background: #fde68a;
  }
  .calendar-day.sun .day-number { color: #ef4444; }
  .calendar-day.sat .day-number { color: #3b82f6; }
  .day-number {
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 4px;
    color: #111827;
  }
  .day-events {
    display: flex;
    flex-direction: column;
    gap: 3px;
  }
  .day-event {
    font-size: 0.7rem;
    padding: 3px 6px;
    border-radius: 4px;
    background: var(--primary);
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .day-event:hover {
    opacity: 0.85;
  }
  .day-event.status-draft { background: #f59e0b; }
  .day-event.status-scheduled { background: #3b82f6; }
  .day-event.status-in_progress { background: #8b5cf6; }
  .day-event.status-completed { background: #10b981; }
  .day-event.status-cancelled { background: #6b7280; }
  .day-event-more {
    font-size: 0.65rem;
    color: #6b7280;
    text-align: center;
    padding: 2px;
  }
  
  /* ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
  .schedule-dialog,
  .delete-dialog {
    border: none;
    border-radius: 16px;
    padding: 0;
    max-width: 560px;
    width: 90vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
  }
  .schedule-dialog::backdrop,
  .delete-dialog::backdrop {
    background: rgba(0,0,0,0.5);
  }
  .dialog-content {
    padding: 32px;
    position: relative;
  }
  .dialog-content.dialog-sm {
    text-align: center;
  }
  .dialog-close {
    position: absolute;
    top: 16px;
    right: 16px;
    background: none;
    border: none;
    font-size: 1.25rem;
    color: #6b7280;
    cursor: pointer;
  }
  .dialog-content h3 {
    font-size: 1.25rem;
    margin: 0 0 24px;
    color: #111827;
  }
  .form-row {
    display: flex;
    gap: 16px;
    margin-bottom: 16px;
  }
  .form-field {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .form-field.half {
    flex: 0 0 calc(50% - 8px);
  }
  .form-field label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
  }
  .required {
    color: #ef4444;
  }
  .form-field input,
  .form-field select,
  .form-field textarea {
    padding: 10px 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.95rem;
  }
  .form-field input:focus,
  .form-field select:focus,
  .form-field textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(255, 103, 156, 0.1);
  }
  .form-status {
    margin: 16px 0;
    font-size: 0.9rem;
  }
  .form-status.success { color: #047857; }
  .form-status.error { color: #b91c1c; }
  .dialog-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 24px;
  }
  
  /* ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ */
  .pagination {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 20px;
  }
  .pagination button {
    padding: 8px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 6px;
    background: #fff;
    cursor: pointer;
    font-size: 0.9rem;
  }
  .pagination button.active {
    background: var(--primary);
    color: #fff;
    border-color: var(--primary);
  }
  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  @media (max-width: 768px) {
    .filter-row {
      flex-direction: column;
    }
    .filter-group {
      width: 100%;
    }
    .filter-group input,
    .filter-group select {
      width: 100%;
    }
    .form-row {
      flex-direction: column;
    }
    .form-field.half {
      flex: 1;
    }
  }
</style>

<script>
  const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
  
  let allSchedules = [];
  let allStores = [];
  let allWorkers = [];
  let filteredSchedules = [];
  let currentPage = 1;
  const perPage = 20;
  let currentView = 'list';
  let currentMonth = new Date();
  let deleteTargetId = null;

  // DOMè¦ç´ 
  const tbody = document.getElementById('schedule-tbody');
  const pagination = document.getElementById('pagination');
  const scheduleDialog = document.getElementById('schedule-dialog');
  const deleteDialog = document.getElementById('delete-dialog');
  const scheduleForm = document.getElementById('schedule-form');
  const formStatus = document.getElementById('form-status');

  // åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', async () => {
    // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼ˆä»Šæ—¥ã‹ã‚‰1ãƒ¶æœˆï¼‰
    const today = new Date();
    const nextMonth = new Date(today);
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    document.getElementById('date-from').value = today.toISOString().split('T')[0];
    document.getElementById('date-to').value = nextMonth.toISOString().split('T')[0];
    
    await Promise.all([loadStores(), loadWorkers(), loadSchedules()]);
    setupEventListeners();
  });

  // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
  async function loadSchedules() {
    try {
      const response = await fetch(`${API_BASE}/schedules`);
      allSchedules = await response.json();
      updateDraftAlert();
      filterAndRender();
    } catch (error) {
      console.error('Failed to load schedules:', error);
      tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>';
    }
  }

  // ä»®æŠ¼ã•ãˆã‚¢ãƒ©ãƒ¼ãƒˆæ›´æ–°
  function updateDraftAlert() {
    const draftCount = allSchedules.filter(s => s.status === 'draft').length;
    const alertEl = document.getElementById('draft-alert');
    const countEl = document.getElementById('draft-count');
    
    if (draftCount > 0) {
      alertEl.classList.remove('hidden');
      countEl.textContent = draftCount;
    } else {
      alertEl.classList.add('hidden');
    }
  }

  // ä»®æŠ¼ã•ãˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
  function filterDraft() {
    document.getElementById('status-filter').value = 'draft';
    filterAndRender();
  }

  async function loadStores() {
    try {
      const response = await fetch(`${API_BASE}/stores`);
      allStores = await response.json();
      populateStoreSelects();
    } catch (error) {
      console.error('Failed to load stores:', error);
    }
  }

  async function loadWorkers() {
    try {
      const response = await fetch(`${API_BASE}/workers`);
      allWorkers = await response.json();
      populateWorkerSelects();
    } catch (error) {
      console.error('Failed to load workers:', error);
    }
  }

  function populateStoreSelects() {
    const options = allStores.map(s => `<option value="${s.id}">${escapeHtml(s.name || '')}</option>`).join('');
    document.getElementById('store-filter').innerHTML = '<option value="">å…¨åº—èˆ—</option>' + options;
    document.getElementById('schedule-store').innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>' + options;
  }

  function populateWorkerSelects() {
    const options = allWorkers.map(w => `<option value="${w.id}">${escapeHtml(w.name || '')}</option>`).join('');
    document.getElementById('worker-filter').innerHTML = '<option value="">å…¨å“¡</option>' + options;
    document.getElementById('schedule-worker').innerHTML = '<option value="">æœªå‰²å½“</option>' + options;
  }

  // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  function filterAndRender() {
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    const storeId = document.getElementById('store-filter').value;
    const workerId = document.getElementById('worker-filter').value;
    const status = document.getElementById('status-filter').value;

    filteredSchedules = allSchedules.filter(s => {
      const matchDate = (!dateFrom || s.scheduled_date >= dateFrom) && (!dateTo || s.scheduled_date <= dateTo);
      const matchStore = !storeId || s.store_id === storeId;
      const matchWorker = !workerId || s.worker_id === workerId;
      const matchStatus = !status || s.status === status;
      return matchDate && matchStore && matchWorker && matchStatus;
    });

    // æ—¥ä»˜é †ã‚½ãƒ¼ãƒˆ
    filteredSchedules.sort((a, b) => {
      const dateA = `${a.scheduled_date} ${a.scheduled_time || '00:00'}`;
      const dateB = `${b.scheduled_date} ${b.scheduled_time || '00:00'}`;
      return dateA.localeCompare(dateB);
    });

    currentPage = 1;
    renderTable();
    renderPagination();
  }

  // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
  function renderTable() {
    const start = (currentPage - 1) * perPage;
    const pageSchedules = filteredSchedules.slice(start, start + perPage);

    if (pageSchedules.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="loading-cell">è©²å½“ã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }

    tbody.innerHTML = pageSchedules.map(schedule => {
      const store = DataUtils.findStore(allStores, schedule.store_id) || {};
      const worker = allWorkers.find(w => w.id === schedule.worker_id);
      const isDraft = schedule.status === 'draft';
      
      // æ­£è¦åŒ–ã•ã‚ŒãŸã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
      const normalized = DataUtils.normalizeSchedule(schedule);
      const displayStoreName = DataUtils.getStoreName(allStores, schedule.store_id, schedule.store_name);
      
      return `
        <tr data-id="${schedule.id}" class="${isDraft ? 'draft-row' : ''}">
          <td>
            <div><strong>${formatDate(normalized.date)}</strong></div>
            <div style="font-size:0.85rem;color:#6b7280">${normalized.time || '-'} (${normalized.duration}åˆ†)</div>
          </td>
          <td>
            <div class="store-info">
              <span class="store-name">${escapeHtml(displayStoreName)}</span>
              <span class="store-address">${escapeHtml(store.pref || '')}${escapeHtml(store.city || '')}</span>
            </div>
          </td>
          <td>
            ${worker ? `
              <div class="worker-info">
                <span class="worker-avatar">${(worker.name || '?')[0]}</span>
                <span>${escapeHtml(worker.name || '')}</span>
              </div>
            ` : '<span class="unassigned">æœªå‰²å½“</span>'}
          </td>
          <td>
            <span class="status-badge status-${normalized.status}">${getStatusLabel(normalized.status)}</span>
          </td>
          <td>${escapeHtml(normalized.work_content)}</td>
          <td>
            <div class="action-btns">
              ${isDraft ? `
                <button class="action-btn assign" title="ã‚¢ã‚µã‚¤ãƒ³ãƒ»ç¢ºå®š" onclick="editSchedule('${schedule.id}')" style="background:#ffc107;color:#333">
                  <i class="fas fa-user-check"></i>
                </button>
              ` : `
                <button class="action-btn edit" title="ç·¨é›†" onclick="editSchedule('${schedule.id}')">
                  <i class="fas fa-edit"></i>
                </button>
              `}
              <button class="action-btn delete" title="å‰Šé™¤" onclick="confirmDelete('${schedule.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `;
    }).join('');
  }

  // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
  function renderPagination() {
    const totalPages = Math.ceil(filteredSchedules.length / perPage);
    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }

    let html = '';
    html += `<button ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">å‰</button>`;
    
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
        html += `<button class="${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      } else if (i === currentPage - 3 || i === currentPage + 3) {
        html += `<span style="padding:8px">...</span>`;
      }
    }
    
    html += `<button ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">æ¬¡</button>`;
    pagination.innerHTML = html;
  }

  window.goToPage = function(page) {
    currentPage = page;
    renderTable();
    renderPagination();
  };

  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  function setupEventListeners() {
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    document.getElementById('date-from').addEventListener('change', filterAndRender);
    document.getElementById('date-to').addEventListener('change', filterAndRender);
    document.getElementById('store-filter').addEventListener('change', filterAndRender);
    document.getElementById('worker-filter').addEventListener('change', filterAndRender);
    document.getElementById('status-filter').addEventListener('change', filterAndRender);
    
    document.getElementById('reset-filters').addEventListener('click', () => {
      const today = new Date();
      const nextMonth = new Date(today);
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      document.getElementById('date-from').value = today.toISOString().split('T')[0];
      document.getElementById('date-to').value = nextMonth.toISOString().split('T')[0];
      document.getElementById('store-filter').value = '';
      document.getElementById('worker-filter').value = '';
      document.getElementById('status-filter').value = '';
      filterAndRender();
    });

    // è¡¨ç¤ºåˆ‡æ›¿
    document.getElementById('view-toggle').addEventListener('click', () => {
      if (currentView === 'list') {
        currentView = 'calendar';
        document.getElementById('list-view').style.display = 'none';
        document.getElementById('calendar-view').style.display = 'block';
        document.getElementById('view-toggle').innerHTML = '<i class="fas fa-list"></i> ãƒªã‚¹ãƒˆè¡¨ç¤º';
        renderCalendar();
      } else {
        currentView = 'list';
        document.getElementById('list-view').style.display = 'block';
        document.getElementById('calendar-view').style.display = 'none';
        document.getElementById('view-toggle').innerHTML = '<i class="fas fa-calendar"></i> ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º';
      }
    });

    // æ–°è¦ä½œæˆ
    document.getElementById('add-schedule-btn').addEventListener('click', () => {
      document.getElementById('dialog-title').textContent = 'æ–°è¦ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ä½œæˆ';
      scheduleForm.reset();
      document.getElementById('schedule-id').value = '';
      document.getElementById('schedule-date').value = new Date().toISOString().split('T')[0];
      formStatus.textContent = '';
      scheduleDialog.showModal();
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    scheduleForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('schedule-id').value;
      const isNew = !id;
      const originalSchedule = isNew ? null : allSchedules.find(s => s.id === id);
      
      const data = {
        store_id: document.getElementById('schedule-store').value,
        scheduled_date: document.getElementById('schedule-date').value,
        scheduled_time: document.getElementById('schedule-time').value,
        duration_minutes: parseInt(document.getElementById('schedule-duration').value) || 60,
        worker_id: document.getElementById('schedule-worker').value || null,
        status: document.getElementById('schedule-status').value,
        notes: document.getElementById('schedule-notes').value
      };

      // æ¸…æƒå“¡ã‚’å‰²ã‚Šå½“ã¦ãŸå ´åˆã€ä»®æŠ¼ã•ãˆï¼ˆdraftï¼‰ã‹ã‚‰ç¢ºå®šï¼ˆscheduledï¼‰ã«è‡ªå‹•æ›´æ–°
      if (!isNew && originalSchedule) {
        const wasDraft = originalSchedule.status === 'draft';
        const hadWorker = originalSchedule.worker_id && originalSchedule.worker_id !== '';
        const hasWorker = data.worker_id && data.worker_id !== '';
        const workerAssigned = !hadWorker && hasWorker; // æ–°ã—ãæ¸…æƒå“¡ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚ŒãŸ
        
        // ä»®æŠ¼ã•ãˆçŠ¶æ…‹ã§æ¸…æƒå“¡ã‚’æ–°ã—ãå‰²ã‚Šå½“ã¦ãŸå ´åˆã€è‡ªå‹•çš„ã«ç¢ºå®šã«å¤‰æ›´
        if (wasDraft && workerAssigned) {
          data.status = 'scheduled';
          document.getElementById('schedule-status').value = 'scheduled';
        }
      }

      if (isNew) {
        data.id = DataUtils.IdUtils.generateSchedule();
        data.created_at = new Date().toISOString();
      } else {
        data.id = id;
      }
      data.updated_at = new Date().toISOString();

      try {
        formStatus.textContent = 'ä¿å­˜ä¸­...';
        
        const response = await fetch(`${API_BASE}/schedules${isNew ? '' : '/' + id}`, {
          method: isNew ? 'POST' : 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          formStatus.textContent = 'ä¿å­˜ã—ã¾ã—ãŸ';
          formStatus.className = 'form-status success';
          
          if (isNew) {
            allSchedules.unshift(data);
          } else {
            const idx = allSchedules.findIndex(s => s.id === id);
            if (idx >= 0) allSchedules[idx] = { ...allSchedules[idx], ...data };
          }
          filterAndRender();
          
          setTimeout(() => scheduleDialog.close(), 500);
        } else {
          throw new Error('Save failed');
        }
      } catch (error) {
        console.error('Error:', error);
        formStatus.textContent = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
        formStatus.className = 'form-status error';
      }
    });

    // å‰Šé™¤ç¢ºèª
    document.getElementById('confirm-delete').addEventListener('click', async () => {
      if (!deleteTargetId) return;
      
      try {
        const response = await fetch(`${API_BASE}/schedules/${deleteTargetId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          allSchedules = allSchedules.filter(s => s.id !== deleteTargetId);
          filterAndRender();
          deleteDialog.close();
        }
      } catch (error) {
        console.error('Delete failed:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });
  }

  // ç·¨é›†
  window.editSchedule = function(id) {
    const schedule = allSchedules.find(s => s.id === id);
    if (!schedule) return;

    document.getElementById('dialog-title').textContent = 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç·¨é›†';
    document.getElementById('schedule-id').value = schedule.id;
    document.getElementById('schedule-store').value = schedule.store_id || '';
    document.getElementById('schedule-date').value = schedule.scheduled_date || '';
    document.getElementById('schedule-time').value = schedule.scheduled_time || '';
    document.getElementById('schedule-duration').value = schedule.duration_minutes || 60;
    document.getElementById('schedule-worker').value = schedule.worker_id || '';
    document.getElementById('schedule-status').value = schedule.status || 'scheduled';
    document.getElementById('schedule-notes').value = schedule.notes || '';
    formStatus.textContent = '';
    scheduleDialog.showModal();
  };

  // å‰Šé™¤ç¢ºèª
  window.confirmDelete = function(id) {
    deleteTargetId = id;
    deleteDialog.showModal();
  };

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function formatDate(dateStr) {
    if (!dateStr) return '-';
    const [y, m, d] = dateStr.split('-');
    const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    const date = new Date(dateStr);
    return `${m}/${d}(${weekdays[date.getDay()]})`;
  }

  function getStatusLabel(status) {
    const labels = {
      'draft': 'ä»®æŠ¼ã•ãˆ',
      'scheduled': 'ç¢ºå®š',
      'in_progress': 'ä½œæ¥­ä¸­',
      'completed': 'å®Œäº†',
      'cancelled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
    };
    return labels[status] || status || 'äºˆå®š';
  }

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
  function renderCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    document.getElementById('calendar-month').textContent = `${year}å¹´${month + 1}æœˆ`;
    
    const calendarDays = document.getElementById('calendar-days');
    calendarDays.innerHTML = '';
    
    // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startDayOfWeek = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    
    // ä»Šæ—¥ã®æ—¥ä»˜
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    // å‰æœˆã®ç©ºç™½ã‚»ãƒ«
    for (let i = 0; i < startDayOfWeek; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day empty';
      calendarDays.appendChild(emptyCell);
    }
    
    // æ—¥ä»˜ã‚»ãƒ«
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
      const dayOfWeek = new Date(year, month, day).getDay();
      
      const dayCell = document.createElement('div');
      dayCell.className = 'calendar-day';
      if (dateStr === todayStr) dayCell.classList.add('today');
      if (dayOfWeek === 0) dayCell.classList.add('sun');
      if (dayOfWeek === 6) dayCell.classList.add('sat');
      
      // æ—¥ä»˜ç•ªå·
      const dayNum = document.createElement('div');
      dayNum.className = 'day-number';
      dayNum.textContent = day;
      dayCell.appendChild(dayNum);
      
      // ãã®æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      const daySchedules = allSchedules.filter(s => s.scheduled_date === dateStr);
      if (daySchedules.length > 0) {
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'day-events';
        
        // æœ€å¤§3ä»¶è¡¨ç¤º
        daySchedules.slice(0, 3).forEach(schedule => {
          const event = document.createElement('div');
          const normalized = DataUtils.normalizeSchedule(schedule);
          event.className = `day-event status-${normalized.status}`;
          const displayName = DataUtils.getStoreName(allStores, schedule.store_id, schedule.store_name);
          event.textContent = displayName;
          event.title = `${normalized.time || ''} ${displayName}`;
          event.onclick = () => openEditDialog(schedule);
          eventsContainer.appendChild(event);
        });
        
        // 3ä»¶ä»¥ä¸Šã‚ã‚‹å ´åˆ
        if (daySchedules.length > 3) {
          const more = document.createElement('div');
          more.className = 'day-event-more';
          more.textContent = `+${daySchedules.length - 3}ä»¶`;
          eventsContainer.appendChild(more);
        }
        
        dayCell.appendChild(eventsContainer);
      }
      
      // æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯ã§æ–°è¦ä½œæˆ
      dayCell.addEventListener('click', (e) => {
        if (e.target.classList.contains('day-event') || e.target.classList.contains('day-event-more')) return;
        openAddDialog();
        document.getElementById('schedule-date').value = dateStr;
      });
      
      calendarDays.appendChild(dayCell);
    }
    
    // æ¬¡æœˆã®ç©ºç™½ã‚»ãƒ«ï¼ˆ6è¡Œã«ãªã‚‹ã‚ˆã†ã«ï¼‰
    const totalCells = startDayOfWeek + daysInMonth;
    const remainingCells = (7 - (totalCells % 7)) % 7;
    for (let i = 0; i < remainingCells; i++) {
      const emptyCell = document.createElement('div');
      emptyCell.className = 'calendar-day empty';
      calendarDays.appendChild(emptyCell);
    }
  }
</script>

