@layout('layouts.admin')
@json('data/meta/admin_schedules_title.json', $title)
@json('data/meta/admin_schedules_body_class.json', $body_class)

<link rel="stylesheet" href="/css/admin-schedules.css" />

<main id="main" class="admin-schedules-v2">
  @include('partials.admin-sidebar')
  <!-- メインコンテンツ -->
  <div class="main-content">
    <!-- トップバー -->
    <header class="topbar">
      <div class="topbar-left">
        <h1>スケジュール管理</h1>
      </div>
      <div class="topbar-right">
        <button type="button" class="topbar-btn" id="view-toggle" title="カレンダー表示">
          <i class="fas fa-calendar"></i>
        </button>
        <button type="button" class="btn btn-primary" id="add-schedule-btn">
          <i class="fas fa-plus"></i> 新規作成
        </button>
      </div>
    </header>

    <div class="content-wrapper">

    <!-- 仮押さえアラート -->
    <div class="draft-alert hidden" id="draft-alert">
      <div class="draft-alert-icon">
        <i class="fas fa-clock"></i>
      </div>
      <div class="draft-alert-content">
        <div class="draft-alert-title">仮押さえ申請があります</div>
        <div class="draft-alert-text" id="draft-alert-text">営業から<span id="draft-count">0</span>件の仮押さえ申請が届いています。清掃員をアサインして確定してください。</div>
      </div>
      <button class="draft-alert-btn" onclick="filterDraft()">
        <i class="fas fa-list"></i> 確認する
      </button>
    </div>

    <!-- フィルター -->
    <div class="filter-section">
      <div class="filter-row">
        <div class="filter-group">
          <label>店舗</label>
          <select id="store-filter">
            <option value="">全店舗</option>
          </select>
        </div>
        <div class="filter-group">
          <label>清掃員</label>
          <select id="worker-filter">
            <option value="">全員</option>
          </select>
        </div>
        <div class="filter-group">
          <label>ステータス</label>
          <select id="status-filter">
            <option value="">全て</option>
            <option value="draft">仮押さえ</option>
            <option value="scheduled">確定</option>
            <option value="in_progress">作業中</option>
            <option value="completed">完了</option>
            <option value="cancelled">キャンセル</option>
          </select>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" id="reset-filters">
          <i class="fas fa-undo"></i> リセット
        </button>
      </div>
    </div>

    <!-- リスト表示 -->
    <div class="schedule-list-view" id="list-view">
      <div class="schedule-table-wrapper">
        <table class="schedule-table">
          <thead>
            <tr>
              <th>日時</th>
              <th>店舗</th>
              <th>清掃員</th>
              <th>ステータス</th>
              <th>備考</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="schedule-tbody">
            <tr>
              <td colspan="6" class="loading-cell">
                <i class="fas fa-spinner fa-spin"></i> 読み込み中...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- カレンダー表示 -->
    <div class="schedule-calendar-view" id="calendar-view" style="display:none;">
      <div class="calendar-header">
        <button type="button" class="btn btn-icon" id="prev-month">
          <i class="fas fa-chevron-left"></i>
        </button>
        <h2 id="calendar-month">2025年11月</h2>
        <button type="button" class="btn btn-icon" id="next-month">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
      <div class="calendar-weekdays">
        <div class="calendar-day-header sun">日</div>
        <div class="calendar-day-header">月</div>
        <div class="calendar-day-header">火</div>
        <div class="calendar-day-header">水</div>
        <div class="calendar-day-header">木</div>
        <div class="calendar-day-header">金</div>
        <div class="calendar-day-header sat">土</div>
      </div>
      <div class="calendar-grid" id="calendar-days"></div>
    </div>
    </div>
  </div>
</main>

<!-- 新規作成/編集ダイアログ -->
<dialog id="schedule-dialog" class="schedule-dialog">
  <div class="dialog-content">
    <button type="button" class="dialog-close" onclick="document.getElementById('schedule-dialog').close()">
      <i class="fas fa-times"></i>
    </button>
    <h3 id="dialog-title">新規スケジュール作成</h3>
    <form id="schedule-form">
      <input type="hidden" id="schedule-id" name="id">
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-store-search">店舗・ブランド・法人名 <span class="required">*</span></label>
          <div class="store-search-wrapper">
            <div class="store-search-controls">
              <select id="store-category-filter" class="store-category-filter">
                <option value="">全て</option>
                <option value="store">店舗名</option>
                <option value="brand">ブランド名</option>
                <option value="client">法人名</option>
              </select>
              <input type="text" id="schedule-store-search" placeholder="店舗名、ブランド名、法人名で検索..." autocomplete="off" required>
            </div>
            <input type="hidden" id="schedule-store" name="store_id">
            <div class="store-search-results" id="schedule-store-results" style="display: none;"></div>
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-date">日付 <span class="required">*</span></label>
          <input type="date" id="schedule-date" name="scheduled_date" required>
        </div>
        <div class="form-field half">
          <label for="schedule-time">時間 <span class="required">*</span></label>
          <input type="time" id="schedule-time" name="scheduled_time" required>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-duration">作業時間（分）</label>
          <input type="number" id="schedule-duration" name="duration_minutes" value="60" min="15" step="15">
        </div>
        <div class="form-field half">
          <label for="schedule-sales">営業担当者</label>
          <select id="schedule-sales" name="sales_id">
            <option value="">未設定</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field half">
          <label for="schedule-worker">担当清掃員</label>
          <select id="schedule-worker" name="worker_id">
            <option value="">未割当</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="cleaning-items-search">清掃内容</label>
          <div class="cleaning-items-search-wrapper">
            <div class="store-search-controls">
              <select id="cleaning-category-filter" class="store-category-filter">
                <option value="">全て</option>
                <option value="service">サービス名</option>
              </select>
              <input type="text" id="cleaning-items-search" placeholder="清掃内容（サービス）を検索..." autocomplete="off">
            </div>
            <div class="cleaning-items-results" id="cleaning-items-results" style="display: none;"></div>
          </div>
          <div class="cleaning-items-selected" id="cleaning-items-selected">
            <!-- 選択された項目がここに追加される -->
          </div>
          <input type="hidden" id="selected-cleaning-items-json" name="cleaning_items">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-status">ステータス</label>
          <select id="schedule-status" name="status">
            <option value="draft">仮押さえ</option>
            <option value="scheduled">確定</option>
            <option value="in_progress">作業中</option>
            <option value="completed">完了</option>
            <option value="cancelled">キャンセル</option>
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-field">
          <label for="schedule-notes">備考</label>
          <textarea id="schedule-notes" name="notes" rows="3" placeholder="特記事項があれば入力"></textarea>
        </div>
      </div>
      
      <div class="form-status" id="form-status"></div>
      <div class="dialog-actions">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('schedule-dialog').close()">キャンセル</button>
        <button type="submit" class="btn btn-primary">保存</button>
      </div>
    </form>
  </div>
</dialog>

<!-- 削除確認ダイアログ -->
<dialog id="delete-dialog" class="delete-dialog">
  <div class="dialog-content dialog-sm">
    <h3>削除確認</h3>
    <p id="delete-message">このスケジュールを削除しますか？</p>
    <div class="dialog-actions">
      <button type="button" class="btn btn-secondary" onclick="document.getElementById('delete-dialog').close()">キャンセル</button>
      <button type="button" class="btn btn-danger" id="confirm-delete">削除</button>
    </div>
  </div>
<script src="/js/admin-schedules.js"></script>
