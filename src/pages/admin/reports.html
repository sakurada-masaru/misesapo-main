@layout('layouts.base')
@json('data/meta/admin_reports_title.json', $title)
@json('data/meta/admin_reports_body_class.json', $body_class)

<main id="main" class="container admin-reports">
  <div class="page-header">
    <a href="/admin/dashboard.html" class="back-btn">
      <i class="fas fa-chevron-left"></i>
      ダッシュボード
    </a>
    <h1 class="page-title">レポート管理</h1>
    <a href="/admin/reports/new.html" class="btn btn-primary">
      <i class="fas fa-plus"></i>
      新規作成
    </a>
  </div>

  <!-- フィルター -->
  <div class="filters-section">
    <div class="filter-group">
      <label class="filter-label">店舗</label>
      <select id="store-filter" class="filter-select">
        <option value="">すべて</option>
        <option value="store-001">Darts Bar A's 神楽坂店</option>
        <option value="store-002">大塚店</option>
        <option value="store-003">高円寺店</option>
      </select>
    </div>
    <div class="filter-group">
      <label class="filter-label">日付範囲</label>
      <input type="date" id="date-from" class="filter-input">
      <span>〜</span>
      <input type="date" id="date-to" class="filter-input">
    </div>
    <div class="filter-group">
      <label class="filter-label">ステータス</label>
      <select id="status-filter" class="filter-select">
        <option value="">すべて</option>
        <option value="published">公開済み</option>
        <option value="draft">下書き</option>
      </select>
    </div>
    <button type="button" class="btn btn-outline" id="apply-filters">フィルター適用</button>
  </div>

  <!-- レポート一覧 -->
  <div class="reports-list" id="reports-list">
    <div class="loading" id="loading">読み込み中...</div>
  </div>

  <style>
    .admin-reports {
      max-width: 1200px;
      margin: 0 auto;
    }
    .page-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    .page-header h1 {
      flex: 1;
      margin: 0;
    }
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      color: #374151;
      text-decoration: none;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    .back-btn:hover {
      background: #f9fafb;
      border-color: var(--primary);
      color: var(--primary);
    }
    .back-btn i {
      font-size: 0.875rem;
    }
    .admin-reports {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }
    .page-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    .filters-section {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }
    .filter-select,
    .filter-input {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .reports-list {
      display: grid;
      gap: 16px;
    }
    .report-card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }
    .report-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      transform: translateY(-2px);
    }
    .report-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }
    .report-store {
      font-size: 1.125rem;
      font-weight: 700;
      color: #111827;
    }
    .report-date {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .report-meta {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
      font-size: 0.875rem;
      color: #6b7280;
    }
    .report-status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .report-status.published {
      background: #d1fae5;
      color: #065f46;
    }
    .report-status.draft {
      background: #fef3c7;
      color: #92400e;
    }
    .report-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .btn-primary {
      background: #FF6BA6;
      color: #ffffff;
    }
    .btn-primary:hover {
      background: #FF5A9A;
    }
    .btn-outline {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    .btn-outline:hover {
      background: #f9fafb;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 0.75rem;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    @media (max-width: 768px) {
      .admin-reports {
        padding: 16px;
      }
      .page-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }
      .filters-section {
        flex-direction: column;
      }
      .filter-group {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
      }
      .filter-select,
      .filter-input {
        width: 100%;
      }
    }
  </style>

  <script>
    // APIエンドポイント
    const API_BASE_URL = 'https://2z0ui5xfxb.execute-api.ap-northeast-1.amazonaws.com/prod';
    
    // Firebase認証からIDトークンを取得
    async function getFirebaseIdToken() {
      try {
        // Firebase Authが利用可能か確認
        if (!window.FirebaseAuth) {
          console.warn('[Reports] Firebase Auth is not available, using mock token');
          return 'mock-token';
        }
        
        // 現在のユーザーを取得
        const currentUser = window.FirebaseAuth.currentUser;
        if (!currentUser) {
          console.warn('[Reports] No authenticated user, using mock token');
          return 'mock-token';
        }
        
        // IDトークンを取得
        const idToken = await currentUser.getIdToken();
        return idToken;
      } catch (error) {
        console.error('[Reports] Error getting Firebase ID token:', error);
        // エラー時はモックトークンを返す（開発環境用）
        return 'mock-token';
      }
    }

    // レポート一覧を取得
    async function loadReports() {
      const loadingEl = document.getElementById('loading');
      const reportsListEl = document.getElementById('reports-list');
      
      try {
        loadingEl.style.display = 'block';
        
        const idToken = await getFirebaseIdToken();
        const response = await fetch(`${API_BASE_URL}/staff/reports`, {
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error('レポートの取得に失敗しました');
        }
        
        const data = await response.json();
        const reports = data.items || [];
        
        loadingEl.style.display = 'none';
        
        if (reports.length === 0) {
          reportsListEl.innerHTML = '<div class="loading">レポートがありません</div>';
          return;
        }
        
        reportsListEl.innerHTML = reports.map(report => `
          <div class="report-card">
            <div class="report-header">
              <div>
                <div class="report-store">${report.store_name || '店舗名不明'}</div>
                <div class="report-date">${formatDate(report.cleaning_date)} ${report.cleaning_start_time || ''} - ${report.cleaning_end_time || ''}</div>
              </div>
              <span class="report-status ${report.status || 'published'}">${getStatusLabel(report.status)}</span>
            </div>
            <div class="report-meta">
              <span>清掃項目: ${report.work_items?.length || 0}件</span>
              <span>作成日: ${formatDateTime(report.created_at)}</span>
            </div>
            <div class="report-actions">
              <a href="/reports/${report.report_id}.html" class="btn btn-outline btn-sm">詳細を見る</a>
              <a href="/admin/reports/${report.report_id}/edit.html" class="btn btn-outline btn-sm">編集</a>
              <button type="button" class="btn btn-outline btn-sm" onclick="deleteReport('${report.report_id}')">削除</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading reports:', error);
        loadingEl.style.display = 'none';
        reportsListEl.innerHTML = `<div class="loading" style="color: #ef4444;">エラー: ${error.message}</div>`;
      }
    }

    // レポートを削除
    async function deleteReport(reportId) {
      if (!confirm('このレポートを削除しますか？')) {
        return;
      }
      
      try {
        const idToken = await getFirebaseIdToken();
        const response = await fetch(`${API_BASE_URL}/staff/reports/${reportId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          throw new Error('レポートの削除に失敗しました');
        }
        
        alert('レポートを削除しました');
        loadReports();
      } catch (error) {
        console.error('Error deleting report:', error);
        alert(`エラー: ${error.message}`);
      }
    }

    // 日付フォーマット
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    function formatDateTime(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleString('ja-JP');
    }

    function getStatusLabel(status) {
      const labels = {
        'published': '公開済み',
        'draft': '下書き',
        'archived': 'アーカイブ'
      };
      return labels[status] || status;
    }

    // フィルター適用
    document.getElementById('apply-filters')?.addEventListener('click', function() {
      // TODO: フィルター機能を実装
      loadReports();
    });

    // 初期読み込み
    loadReports();
  </script>
</main>


