@layout('layouts.base')
@json('data/meta/staff_dashboard_title.json', $title)
@json('data/meta/staff_dashboard_body_class.json', $body_class)

<main id="main" class="container staff-dashboard">

  <!-- オフラインインジケーター -->
  <div class="offline-indicator" id="offline-indicator" style="display: none;">
    <div class="offline-content">
      <i class="fas fa-wifi" id="offline-icon"></i>
      <span id="offline-text">オフライン（同期待ち: <span id="pending-count">0</span>件）</span>
    </div>
  </div>

  <!-- Next Assignment Card (最優先表示) -->
  <section class="dashboard-section next-assignment-section">
    <div class="next-assignment-card">
      <div class="assignment-header">
        <span class="badge-next">次の作業</span>
        <span class="time-remaining" id="time-remaining">あと15分</span>
      </div>
      <div class="assignment-main">
        <div class="location-large">
          <i class="fas fa-map-marker-alt"></i>
          神楽坂店
        </div>
        <div class="task-detail">レンジフード洗浄、グリストラップ清掃</div>
        <div class="assignment-meta">
          <span class="meta-item">
            <i class="fas fa-clock"></i>
            10:30
          </span>
          <span class="meta-item">
            <i class="fas fa-route"></i>
            2.3km
          </span>
          <span class="meta-item">
            <i class="fas fa-hourglass-half"></i>
            予定: 2時間
          </span>
        </div>
      </div>
      <div class="assignment-actions">
        <a href="/staff/assignments/1.html" class="btn-start-assignment">
          <i class="fas fa-play-circle"></i>
          作業開始
        </a>
        <a href="#" class="link-map" onclick="window.open('https://maps.google.com/?q=神楽坂店', '_blank'); return false;">
          <i class="fas fa-map"></i>
          地図を開く
        </a>
      </div>
    </div>
  </section>

  <!-- Quick Actions (改善版) -->
  <section class="dashboard-section">
    <h2 class="section-title">クイックアクション</h2>
    <div class="quick-actions-compact">
      <a href="/staff/assignments.html" class="action-btn-large">
        <i class="fas fa-tasks"></i>
        <span>作業一覧</span>
      </a>
      <a href="/staff/reports/new.html" class="action-btn-large">
        <i class="fas fa-camera"></i>
        <span>レポート作成</span>
      </a>
      <a href="/staff/schedule.html" class="action-btn-large">
        <i class="fas fa-calendar"></i>
        <span>スケジュール</span>
      </a>
      <a href="/cleaning-manual.html" class="action-btn-large">
        <i class="fas fa-book"></i>
        <span>マニュアル</span>
      </a>
    </div>
  </section>

  <!-- Today's Schedule (タイムライン表示) -->
  <section class="dashboard-section">
    <h2 class="section-title">
      <i class="fas fa-calendar-day"></i>
      本日の予定
    </h2>
    <div class="schedule-timeline">
      <div class="timeline-item completed">
        <div class="timeline-marker completed">
          <i class="fas fa-check"></i>
        </div>
        <div class="timeline-content">
          <div class="timeline-time">09:00</div>
          <div class="timeline-details">
            <div class="location">新宿店</div>
            <div class="task">通常清掃</div>
            <span class="status-check">✓ 完了</span>
          </div>
        </div>
      </div>
      <div class="timeline-item current">
        <div class="timeline-marker current">
          <i class="fas fa-circle"></i>
        </div>
        <div class="timeline-content">
          <div class="timeline-time">10:30</div>
          <div class="timeline-details">
            <div class="location">神楽坂店</div>
            <div class="task">レンジフード洗浄、グリストラップ清掃</div>
            <span class="status-current">進行中</span>
          </div>
        </div>
      </div>
      <div class="timeline-item upcoming">
        <div class="timeline-marker upcoming">
          <i class="fas fa-circle"></i>
        </div>
        <div class="timeline-content">
          <div class="timeline-time">14:00</div>
          <div class="timeline-details">
            <div class="location">日本橋茅場町店</div>
            <div class="task">エアコン分解洗浄</div>
            <span class="status-upcoming">予定</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- This Week's Schedule -->
  <section class="dashboard-section">
    <h2 class="section-title">
      <i class="fas fa-calendar-week"></i>
      今週の予定
    </h2>
    <div class="week-summary">
      <div class="week-stat">
        <div class="stat-value">8</div>
        <div class="stat-label">件</div>
      </div>
      <div class="week-stat">
        <div class="stat-value">6</div>
        <div class="stat-label">店舗</div>
      </div>
    </div>
    <a href="/staff/schedule.html" class="btn btn-outline btn-block">スケジュール一覧を見る</a>
  </section>

  <!-- Pending Reports (改善版) -->
  <section class="dashboard-section">
    <h2 class="section-title">
      <i class="fas fa-clipboard-list"></i>
      作業完了待ち
    </h2>
    <div class="pending-list">
      <div class="pending-card urgent">
        <div class="pending-header">
          <span class="urgent-badge">緊急</span>
          <span class="countdown" data-deadline="2025-03-19T15:00:00">期限まで 2時間</span>
        </div>
        <div class="pending-content">
          <div class="pending-location">大塚店</div>
          <div class="pending-date">2025年3月19日 13:00</div>
        </div>
        <a href="/staff/reports/new.html?assignment=1" class="btn-report-now">
          <i class="fas fa-file-upload"></i>
          今すぐレポート作成
        </a>
      </div>
      <div class="pending-card normal">
        <div class="pending-header">
          <span class="normal-badge">通常</span>
          <span class="countdown" data-deadline="2025-03-20T10:00:00">期限まで 1日</span>
        </div>
        <div class="pending-content">
          <div class="pending-location">高円寺店</div>
          <div class="pending-date">2025年3月18日 10:00</div>
        </div>
        <a href="/staff/reports/new.html?assignment=2" class="btn-report-now">
          <i class="fas fa-file-upload"></i>
          レポート作成
        </a>
      </div>
    </div>
  </section>

  <!-- SP版：左下メニューボタン -->
  <div class="fixed-menu-button" id="fixed-menu-button">
    <div class="fixed-menu-button__circle">
      <div class="fixed-menu-button__text">メニュー</div>
    </div>
  </div>

  <!-- SP版：メニューパネルオーバーレイ -->
  <div class="sp-menu-panel-overlay" id="sp-menu-panel-overlay"></div>

  <!-- SP版：メニューパネル -->
  <div class="sp-menu-panel" id="sp-menu-panel">
    <ul class="sp-menu-list">
      <li class="sp-menu-item">
        <a href="/staff/dashboard.html" class="sp-menu-link">ダッシュボード</a>
      </li>
      <li class="sp-menu-item">
        <a href="/staff/assignments.html" class="sp-menu-link">作業一覧</a>
      </li>
      <li class="sp-menu-item">
        <a href="/staff/reports.html" class="sp-menu-link">レポート一覧</a>
      </li>
      <li class="sp-menu-item">
        <a href="/staff/schedule.html" class="sp-menu-link">スケジュール</a>
      </li>
      <li class="sp-menu-item">
        <a href="/staff/training.html" class="sp-menu-link">研修動画</a>
      </li>
      <li class="sp-menu-item">
        <a href="/cleaning-manual.html" class="sp-menu-link">清掃マニュアル</a>
      </li>
      <li class="sp-menu-item">
        <a href="/announcements.html" class="sp-menu-link">お知らせ</a>
      </li>
      <li class="sp-menu-item">
        <a href="javascript:void(0);" class="sp-menu-link" id="settings-menu-link">
          <span>設定</span>
          <span class="sp-menu-arrow">▶</span>
        </a>
      </li>
      <li class="sp-menu-item">
        <a href="/signin.html" class="sp-menu-link sp-menu-link-login">ログアウト</a>
      </li>
    </ul>
    <div class="sp-menu-panel-footer">
      <button class="sp-menu-close-btn" id="sp-menu-close-btn">閉じる</button>
    </div>
  </div>

  <!-- SP版：設定パネルオーバーレイ -->
  <div class="settings-panel-overlay" id="settings-panel-overlay"></div>

  <!-- SP版：設定パネル -->
  <div class="settings-panel" id="settings-panel">
    <div class="settings-panel-header">
      <h2 class="settings-panel-title">設定</h2>
    </div>
    <div class="settings-panel-content">
      <div class="settings-section">
        <h3 class="settings-section-title">メニューボタン配置切り替え</h3>
        <div class="settings-option">
          <label class="settings-radio-group">
            <input type="radio" name="menu-button-position" value="left" id="menu-position-left" checked>
            <span class="settings-radio-label">左下</span>
          </label>
          <label class="settings-radio-group">
            <input type="radio" name="menu-button-position" value="right" id="menu-position-right">
            <span class="settings-radio-label">右下</span>
          </label>
        </div>
      </div>
        <div class="settings-section">
          <h3 class="settings-section-title">レイアウト変更</h3>
          <div class="settings-option">
            <label class="settings-radio-group">
              <input type="radio" name="layout-mode" value="compact" id="layout-mode-compact">
              <span class="settings-radio-label">コンパクトモード</span>
            </label>
            <label class="settings-radio-group">
              <input type="radio" name="layout-mode" value="standard" id="layout-mode-standard" checked>
              <span class="settings-radio-label">標準モード</span>
            </label>
            <label class="settings-radio-group">
              <input type="radio" name="layout-mode" value="detailed" id="layout-mode-detailed">
              <span class="settings-radio-label">詳細モード</span>
            </label>
          </div>
        </div>
        <div class="settings-section">
          <h3 class="settings-section-title">通知の設定</h3>
          <div class="settings-option">
            <label class="settings-checkbox-group">
              <input type="checkbox" id="notification-sound" checked>
              <span class="settings-checkbox-label">音声通知</span>
            </label>
            <label class="settings-checkbox-group">
              <input type="checkbox" id="notification-vibration" checked>
              <span class="settings-checkbox-label">バイブレーション</span>
            </label>
            <label class="settings-checkbox-group">
              <input type="checkbox" id="notification-reminder">
              <span class="settings-checkbox-label">作業開始リマインダー（15分前）</span>
            </label>
          </div>
        </div>
      <div class="settings-section">
        <h3 class="settings-section-title">モード切り替え</h3>
        <div class="settings-option">
          <label class="settings-radio-group">
            <input type="radio" name="theme-mode" value="light" id="theme-mode-light" checked>
            <span class="settings-radio-label">ライトモード</span>
          </label>
          <label class="settings-radio-group">
            <input type="radio" name="theme-mode" value="dark" id="theme-mode-dark">
            <span class="settings-radio-label">ダークモード</span>
          </label>
        </div>
      </div>
      <div class="settings-section">
        <h3 class="settings-section-title">言語切り替え</h3>
        <div class="settings-option">
          <p class="settings-placeholder">準備中</p>
        </div>
      </div>
      <div class="settings-panel-footer">
        <button class="settings-panel-back" id="settings-panel-back">
          <span>閉じる</span>
        </button>
      </div>
    </div>
  </div>

  <style>
    .staff-dashboard {
      max-width: 100%;
      margin: 0;
      padding: 16px;
      background: #f9fafb;
    }

    /* レイアウトモード */
    .staff-dashboard.layout-compact .dashboard-section {
      padding: 12px;
      margin-bottom: 12px;
    }
    .staff-dashboard.layout-compact .section-title {
      font-size: 1rem;
      margin-bottom: 12px;
    }
    .staff-dashboard.layout-compact .next-assignment-card {
      padding: 16px;
    }
    .staff-dashboard.layout-compact .location-large {
      font-size: 1.25rem;
    }
    .staff-dashboard.layout-compact .task-detail {
      font-size: 0.875rem;
    }
    .staff-dashboard.layout-compact .action-btn-large {
      padding: 16px 8px;
      min-height: 80px;
    }
    .staff-dashboard.layout-compact .action-btn-large i {
      font-size: 1.5rem;
    }
    .staff-dashboard.layout-compact .action-btn-large span {
      font-size: 0.75rem;
    }

    .staff-dashboard.layout-detailed .dashboard-section {
      padding: 24px;
    }
    .staff-dashboard.layout-detailed .section-title {
      font-size: 1.25rem;
      margin-bottom: 20px;
    }
    .staff-dashboard.layout-detailed .next-assignment-card {
      padding: 24px;
    }
    .staff-dashboard.layout-detailed .location-large {
      font-size: 1.75rem;
    }
    .staff-dashboard.layout-detailed .task-detail {
      font-size: 1.125rem;
    }
    .staff-dashboard.layout-detailed .meta-item {
      font-size: 1rem;
    }

    /* SP版：メニューボタン（左下/右下切り替え対応） */
    .fixed-menu-button {
      display: block;
      position: fixed;
      bottom: 30px;
      left: 30px;
      width: 80px;
      height: 80px;
      z-index: 999998;
      cursor: pointer;
      transition: transform 0.3s ease, left 0.3s ease, right 0.3s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }

    .fixed-menu-button.position-right {
      left: auto;
      right: 30px;
    }

    .fixed-menu-button:hover {
      transform: scale(1.1);
    }

    .fixed-menu-button__circle {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: #FF008C;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      box-shadow: 0 4px 12px rgba(255, 0, 140, 0.4);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .fixed-menu-button * {
      -webkit-tap-highlight-color: transparent;
    }

    .fixed-menu-button__circle::before {
      content: '';
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      bottom: 8px;
      border: 3px solid #fff;
      border-radius: 50%;
      pointer-events: none;
    }

    .fixed-menu-button__text {
      color: #fff;
      font-size: 10px;
      font-weight: 600;
      text-align: center;
      line-height: 1.3;
    }

    /* SP版：メニューパネル */
    .sp-menu-panel {
      display: none;
      position: fixed;
      top: 0;
      right: 0;
      width: 85vw;
      max-width: 400px;
      height: 100vh;
      background: #FF6BA6;
      box-shadow: none;
      border-left: 4px solid rgba(255, 255, 255, 0.5);
      z-index: 999997;
      opacity: 0;
      transform: translateY(-100%);
      overflow-y: auto;
      padding: 80px 24px 0;
      padding-bottom: 100px; /* フッターの高さ分の余白 */
    }

    /* 左下ボタンの場合：右に展開 */
    .sp-menu-panel.panel-right {
      right: 0;
      left: auto;
      border-left: 4px solid rgba(255, 255, 255, 0.5);
      border-right: none;
    }

    /* 右下ボタンの場合：左に展開 */
    .sp-menu-panel.panel-left {
      left: 0;
      right: auto;
      border-right: 4px solid rgba(255, 255, 255, 0.5);
      border-left: none;
    }

    .sp-menu-panel.open {
      display: block;
      opacity: 1;
      transform: translateY(0);
      animation: panelSlideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .sp-menu-panel.closing {
      opacity: 0;
      transform: translateY(-100%);
      animation: panelSlideOut 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .sp-menu-panel-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255, 255, 255, 0.5);
      z-index: 999996;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sp-menu-panel-overlay.open {
      display: block;
      opacity: 1;
    }

    /* 白の円形拡大アニメーション */
    .menu-ripple-overlay {
      position: fixed;
      width: 100px;
      height: 100px;
      background: #ffffff;
      z-index: 999995;
      border-radius: 50%;
      transform: scale(0);
      pointer-events: none;
      opacity: 0;
      display: none;
    }

    .menu-ripple-overlay.animating {
      opacity: 0.9;
      display: block;
      animation: rippleExpand 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .menu-ripple-overlay.collapsing {
      opacity: 0.9;
      display: block;
      animation: rippleSlideUp 0.3s ease forwards;
    }

    @keyframes rippleExpand {
      0% {
        transform: scale(0);
        opacity: 0.9;
      }
      100% {
        transform: scale(25);
        opacity: 0.9;
      }
    }
    
    @keyframes rippleSlideUp {
      0% {
        transform: translateY(0) scale(25);
        opacity: 0.9;
      }
      100% {
        transform: translateY(-100vh) scale(25);
        opacity: 0;
      }
    }

    .sp-menu-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sp-menu-item {
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    .sp-menu-panel.open .sp-menu-item {
      opacity: 0;
      animation: menuItemFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }
    
    .sp-menu-panel.closing .sp-menu-item {
      animation: menuItemFadeOut 0.3s ease forwards;
    }
    
    @keyframes panelSlideIn {
      from {
        opacity: 0;
        transform: translateY(-100%);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes panelSlideOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-100%);
      }
    }
    
    @keyframes menuItemFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes menuItemFadeOut {
      from {
        opacity: 1;
        transform: translateY(0);
      }
      to {
        opacity: 0;
        transform: translateY(-10px);
      }
    }
    
    /* 各メニュー項目に時間差を設定（開く時：パネル展開完了後から上から順） */
    .sp-menu-panel.open .sp-menu-item:nth-child(1) { animation-delay: 0.5s; }
    .sp-menu-panel.open .sp-menu-item:nth-child(2) { animation-delay: 0.55s; }
    .sp-menu-panel.open .sp-menu-item:nth-child(3) { animation-delay: 0.6s; }
    .sp-menu-panel.open .sp-menu-item:nth-child(4) { animation-delay: 0.65s; }
    .sp-menu-panel.open .sp-menu-item:nth-child(5) { animation-delay: 0.7s; }
    .sp-menu-panel.open .sp-menu-item:nth-child(6) { animation-delay: 0.75s; }
    .sp-menu-panel.open .sp-menu-item:nth-child(7) { animation-delay: 0.8s; }
    .sp-menu-panel.open .sp-menu-item:nth-child(8) { animation-delay: 0.85s; }
    
    /* 各メニュー項目に時間差を設定（閉じる時：下から順、逆順） */
    .sp-menu-panel.closing .sp-menu-item:nth-last-child(1) { animation-delay: 0.05s; }
    .sp-menu-panel.closing .sp-menu-item:nth-last-child(2) { animation-delay: 0.1s; }
    .sp-menu-panel.closing .sp-menu-item:nth-last-child(3) { animation-delay: 0.15s; }
    .sp-menu-panel.closing .sp-menu-item:nth-last-child(4) { animation-delay: 0.2s; }
    .sp-menu-panel.closing .sp-menu-item:nth-last-child(5) { animation-delay: 0.25s; }
    .sp-menu-panel.closing .sp-menu-item:nth-last-child(6) { animation-delay: 0.3s; }
    .sp-menu-panel.closing .sp-menu-item:nth-last-child(7) { animation-delay: 0.35s; }
    .sp-menu-panel.closing .sp-menu-item:nth-last-child(8) { animation-delay: 0.4s; }

    .sp-menu-item:last-child {
      border-bottom: none;
    }

    .sp-menu-link {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      color: #ffffff;
      text-decoration: none;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
    }

    .sp-menu-link:hover {
      color: #ffffff;
      opacity: 0.8;
    }

    .sp-menu-link-login {
      background-color: #ffffff;
      color: #FF679C !important;
      padding: 14px 20px;
      border-radius: 8px;
      justify-content: center;
      text-align: center;
      margin: 8px 0;
      border: 2px solid #FF679C;
    }

    .sp-menu-arrow {
      font-size: 12px;
      transition: transform 0.3s ease;
    }

    /* SP版：メニューパネルフッター */
    .sp-menu-panel-footer {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 16px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(51, 51, 51, 0.95);
    }

    .sp-menu-close-btn {
      width: 100%;
      padding: 14px 20px;
      background-color: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .sp-menu-close-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* SP版：設定パネル */
    .settings-panel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100vw;
      height: 100vh;
      background: #ffffff;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
      z-index: 999999;
      opacity: 0;
      transform: translateX(100%);
      transition: transform 0.3s ease, opacity 0.3s ease;
      overflow-y: auto;
    }

    /* 左下ボタンの場合：右に展開 */
    .settings-panel.panel-right {
      left: 0;
      right: 0;
      width: 100vw;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
    }

    .settings-panel.panel-right.open {
      display: block;
      opacity: 1;
      transform: translateX(0);
      animation: settingsPanelSlideInRight 0.3s ease forwards;
    }

    .settings-panel.panel-right.closing {
      opacity: 0;
      transform: translateX(100%);
      animation: settingsPanelSlideOutRight 0.3s ease forwards;
    }

    /* 右下ボタンの場合：左に展開 */
    .settings-panel.panel-left {
      left: 0;
      right: 0;
      width: 100vw;
      box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
      transform: translateX(-100%);
    }

    .settings-panel.panel-left.open {
      display: block;
      opacity: 1;
      transform: translateX(0);
      animation: settingsPanelSlideInLeft 0.3s ease forwards;
    }

    .settings-panel.panel-left.closing {
      opacity: 0;
      transform: translateX(-100%);
      animation: settingsPanelSlideOutLeft 0.3s ease forwards;
    }

    .settings-panel.open {
      display: block;
      opacity: 1;
    }

    .settings-panel.closing {
      opacity: 0;
    }

    /* 設定パネルのアニメーション */
    @keyframes settingsPanelSlideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes settingsPanelSlideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(100%);
        opacity: 0;
      }
    }

    @keyframes settingsPanelSlideInLeft {
      from {
        transform: translateX(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes settingsPanelSlideOutLeft {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(-100%);
        opacity: 0;
      }
    }

    .settings-panel-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.3);
      z-index: 999998;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .settings-panel-overlay.open {
      display: block;
      opacity: 1;
    }

    .settings-panel-header {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px 24px;
      background: #FF6BA6;
      color: #ffffff;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .settings-panel-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0;
      color: #ffffff;
    }

    .settings-panel-content {
      padding: 24px;
      padding-bottom: 100px;
      min-height: calc(100vh - 60px);
      display: flex;
      flex-direction: column;
    }

    .settings-panel-footer {
      margin-top: auto;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }

    .settings-panel-back {
      width: 100%;
      background: #FF6BA6;
      border: none;
      color: #ffffff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      padding: 14px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s, background 0.2s;
    }

    .settings-panel-back:hover {
      opacity: 0.9;
      background: #FF5A9A;
    }

    .settings-section {
      margin-bottom: 32px;
    }

    .settings-section-title {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 16px 0;
    }

    .settings-option {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
    }

    .settings-radio-group {
      display: flex;
      align-items: center;
      padding: 12px 0;
      cursor: pointer;
    }

    .settings-radio-group:not(:last-child) {
      border-bottom: 1px solid #e5e7eb;
    }

    .settings-radio-group input[type="radio"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .settings-radio-label {
      font-size: 0.95rem;
      color: #374151;
      cursor: pointer;
    }

    .settings-checkbox-group {
      display: flex;
      align-items: center;
      padding: 12px 0;
      cursor: pointer;
    }

    .settings-checkbox-group:not(:last-child) {
      border-bottom: 1px solid #e5e7eb;
    }

    .settings-checkbox-group input[type="checkbox"] {
      margin-right: 12px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .settings-checkbox-label {
      font-size: 0.95rem;
      color: #374151;
      cursor: pointer;
    }

    .settings-placeholder {
      font-size: 0.875rem;
      color: #9ca3af;
      margin: 0;
      padding: 8px 0;
    }

    /* ダークモード */
    body.dark-mode {
      background: #111827;
      color: #f9fafb;
    }

    body.dark-mode .staff-dashboard {
      background: #111827;
    }

    body.dark-mode .dashboard-section {
      background: #1f2937;
      color: #f9fafb;
    }

    body.dark-mode .section-title {
      color: #f9fafb;
    }

    body.dark-mode .schedule-card {
      background: #374151;
    }

    body.dark-mode .schedule-time {
      color: #f9fafb;
    }

    body.dark-mode .schedule-location {
      color: #d1d5db;
    }

    body.dark-mode .schedule-task {
      color: #9ca3af;
    }

    body.dark-mode .week-summary {
      background: #374151;
    }

    body.dark-mode .stat-value {
      color: #FF6BA6;
    }

    body.dark-mode .stat-label {
      color: #9ca3af;
    }

    body.dark-mode .pending-card {
      background: #78350f;
    }

    body.dark-mode .pending-date {
      color: #fef3c7;
    }

    body.dark-mode .pending-location {
      color: #fde68a;
    }

    body.dark-mode .action-btn {
      background: #374151;
      border-color: #4b5563;
      color: #f9fafb;
    }

    body.dark-mode .action-btn:hover {
      background: #4b5563;
      border-color: #FF6BA6;
      color: #FF6BA6;
    }

    /* 次の作業カード - ダークモード */
    body.dark-mode .next-assignment-card {
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
    }

    /* クイックアクション - ダークモード */
    body.dark-mode .action-btn-large {
      background: #374151;
      border-color: #4b5563;
      color: #f9fafb;
    }

    body.dark-mode .action-btn-large:hover {
      background: #4b5563;
      border-color: var(--primary);
    }

    /* 作業完了待ち - ダークモード（改善版） */
    body.dark-mode .pending-card.urgent {
      background: #7f1d1d;
      border-left-color: #ef4444;
    }

    body.dark-mode .pending-card.normal {
      background: #78350f;
      border-left-color: #f59e0b;
    }

    body.dark-mode .pending-card.urgent .pending-location,
    body.dark-mode .pending-card.urgent .pending-date {
      color: #fee2e2;
    }

    body.dark-mode .pending-card.urgent .countdown {
      color: #fee2e2;
    }

    body.dark-mode .btn-report-now {
      background: #374151;
      color: #f59e0b;
      border-color: #f59e0b;
    }

    body.dark-mode .pending-card.urgent .btn-report-now {
      background: #ef4444;
      color: #ffffff;
      border-color: #ef4444;
    }

    /* タイムライン - ダークモード */
    body.dark-mode .schedule-timeline::before {
      background: #4b5563;
    }

    body.dark-mode .timeline-content {
      background: #374151;
      border-color: #4b5563;
    }

    body.dark-mode .timeline-item.current .timeline-content {
      background: #581c87;
      border-color: #a855f7;
    }

    body.dark-mode .timeline-item.completed .timeline-content {
      background: #064e3b;
      border-color: #10b981;
    }

    body.dark-mode .timeline-time {
      color: #f9fafb;
    }

    body.dark-mode .timeline-details .location {
      color: #f9fafb;
    }

    body.dark-mode .timeline-details .task {
      color: #d1d5db;
    }

    body.dark-mode .timeline-marker.upcoming {
      background: #4b5563;
      color: #9ca3af;
    }

    body.dark-mode .settings-panel {
      background: #1f2937;
    }

    body.dark-mode .settings-panel-header {
      background: #FF6BA6;
    }

    body.dark-mode .settings-section-title {
      color: #f9fafb;
    }

    body.dark-mode .settings-option {
      background: #374151;
    }

    body.dark-mode .settings-radio-label {
      color: #f9fafb;
    }

    body.dark-mode .settings-placeholder {
      color: #6b7280;
    }

    body.dark-mode .settings-panel-footer {
      border-top-color: #4b5563;
    }

    body.dark-mode .sp-menu-panel-overlay {
      background: rgba(0, 0, 0, 0.5);
    }

    body.dark-mode .sp-menu-panel-footer {
      background: rgba(45, 55, 72, 0.95);
      border-top-color: rgba(255, 255, 255, 0.1);
    }

    body.dark-mode .sp-menu-close-btn {
      background-color: rgba(255, 255, 255, 0.1);
      color: #e2e8f0;
      border-color: rgba(255, 255, 255, 0.2);
    }

    body.dark-mode .sp-menu-close-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
    }

    @media (min-width: 769px) {
      .fixed-menu-button {
        bottom: 50px;
        left: 50px;
        width: 150px;
        height: 150px;
      }

      .fixed-menu-button.position-right {
        left: auto;
        right: 50px;
      }

      .fixed-menu-button__text {
        font-size: 14px;
      }
    }
    .dashboard-section {
      margin-bottom: 24px;
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title i {
      color: var(--primary);
    }
    .schedule-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .schedule-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 4px solid var(--primary);
    }
    .schedule-time {
      min-width: 60px;
      font-size: 1rem;
      font-weight: 700;
      color: #111827;
      text-align: center;
    }
    .schedule-content {
      flex: 1;
      min-width: 0;
    }
    .schedule-location {
      font-weight: 600;
      color: #374151;
      font-size: 0.95rem;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .schedule-location i {
      color: var(--primary);
      font-size: 0.875rem;
    }
    .schedule-task {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .schedule-status {
      flex-shrink: 0;
    }
    .status-badge {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-upcoming {
      background: #dbeafe;
      color: #1e40af;
    }
    .status-completed {
      background: #d1fae5;
      color: #065f46;
    }
    .week-summary {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 8px;
    }
    .week-stat {
      flex: 1;
      text-align: center;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1.2;
    }
    .stat-label {
      font-size: 0.875rem;
      color: #6b7280;
      margin-top: 4px;
    }
    /* 作業完了待ち（改善版） */
    .pending-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .pending-card {
      padding: 16px;
      border-radius: 12px;
      border-left: 4px solid;
      transition: all 0.2s;
    }
    .pending-card.urgent {
      background: #fee2e2;
      border-left-color: #ef4444;
    }
    .pending-card.normal {
      background: #fef3c7;
      border-left-color: #f59e0b;
    }
    .pending-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .urgent-badge {
      background: #ef4444;
      color: #ffffff;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .normal-badge {
      background: #f59e0b;
      color: #ffffff;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 700;
    }
    .countdown {
      font-size: 0.875rem;
      font-weight: 600;
      color: #92400e;
    }
    .pending-card.urgent .countdown {
      color: #991b1b;
    }
    .pending-content {
      margin-bottom: 12px;
    }
    .pending-location {
      font-size: 1rem;
      font-weight: 700;
      color: #78350f;
      margin-bottom: 4px;
    }
    .pending-card.urgent .pending-location {
      color: #991b1b;
    }
    .pending-date {
      font-size: 0.875rem;
      color: #92400e;
    }
    .pending-card.urgent .pending-date {
      color: #991b1b;
    }
    .btn-report-now {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
      padding: 12px;
      background: #ffffff;
      color: #f59e0b;
      border: 2px solid #f59e0b;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.2s;
    }
    .pending-card.urgent .btn-report-now {
      background: #ef4444;
      color: #ffffff;
      border-color: #ef4444;
    }
    .btn-report-now:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    .btn-report-now i {
      font-size: 1rem;
    }

    /* タイムライン表示 */
    .schedule-timeline {
      position: relative;
      padding-left: 32px;
    }
    .schedule-timeline::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #e5e7eb;
    }
    .timeline-item {
      position: relative;
      margin-bottom: 24px;
    }
    .timeline-item:last-child {
      margin-bottom: 0;
    }
    .timeline-marker {
      position: absolute;
      left: -24px;
      top: 4px;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
      z-index: 1;
    }
    .timeline-marker.completed {
      background: #10b981;
      color: #ffffff;
    }
    .timeline-marker.current {
      background: #FF6BA6;
      color: #ffffff;
      animation: pulse 2s infinite;
    }
    .timeline-marker.upcoming {
      background: #e5e7eb;
      color: #6b7280;
    }
    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(255, 107, 166, 0.7);
      }
      50% {
        box-shadow: 0 0 0 8px rgba(255, 107, 166, 0);
      }
    }
    .timeline-content {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #e5e7eb;
    }
    .timeline-item.current .timeline-content {
      background: #fef3f2;
      border-color: #FF6BA6;
    }
    .timeline-item.completed .timeline-content {
      background: #f0fdf4;
      border-color: #10b981;
    }
    .timeline-time {
      font-size: 1.125rem;
      font-weight: 700;
      color: #374151;
      margin-bottom: 8px;
    }
    .timeline-details {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .timeline-details .location {
      font-size: 1rem;
      font-weight: 600;
      color: #111827;
    }
    .timeline-details .task {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .status-check {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 10px;
      background: #10b981;
      color: #ffffff;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-current {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 10px;
      background: #FF6BA6;
      color: #ffffff;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .status-upcoming {
      display: inline-block;
      margin-top: 8px;
      padding: 4px 10px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    /* オフラインインジケーター */
    .offline-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: #fef3c7;
      border-bottom: 2px solid #f59e0b;
      padding: 12px 16px;
      z-index: 1000000;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .offline-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      color: #92400e;
    }
    .offline-indicator.online {
      background: #d1fae5;
      border-bottom-color: #10b981;
    }
    .offline-indicator.online .offline-content {
      color: #065f46;
    }
    .offline-indicator i {
      font-size: 1rem;
    }

    /* 次の作業カード */
    .next-assignment-section {
      margin-top: 60px; /* オフラインインジケーターのスペース */
      margin-bottom: 24px;
    }
    @media (max-width: 768px) {
      .next-assignment-section {
        margin-top: 50px;
      }
    }
    .next-assignment-card {
      background: linear-gradient(135deg, #FF6BA6 0%, #FF8CC8 100%);
      border-radius: 16px;
      padding: 20px;
      color: #ffffff;
      box-shadow: 0 4px 12px rgba(255, 107, 166, 0.3);
    }
    .assignment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .badge-next {
      background: rgba(255, 255, 255, 0.25);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }
    .time-remaining {
      background: rgba(255, 255, 255, 0.25);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
      backdrop-filter: blur(10px);
    }
    .assignment-main {
      margin-bottom: 20px;
    }
    .location-large {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .location-large i {
      font-size: 1.25rem;
    }
    .task-detail {
      font-size: 1rem;
      margin-bottom: 12px;
      opacity: 0.95;
      line-height: 1.5;
    }
    .assignment-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .meta-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.875rem;
      opacity: 0.9;
    }
    .meta-item i {
      font-size: 0.75rem;
    }
    .assignment-actions {
      display: flex;
      gap: 12px;
      flex-direction: column;
    }
    .btn-start-assignment {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 16px 24px;
      background: #ffffff;
      color: #FF6BA6;
      border-radius: 12px;
      font-size: 1.125rem;
      font-weight: 700;
      text-decoration: none;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .btn-start-assignment:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .btn-start-assignment i {
      font-size: 1.5rem;
    }
    .link-map {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.2);
      color: #ffffff;
      border-radius: 8px;
      font-size: 0.875rem;
      text-decoration: none;
      transition: all 0.2s;
      backdrop-filter: blur(10px);
    }
    .link-map:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    /* クイックアクション（改善版） */
    .quick-actions-compact {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }
    .action-btn-large {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 20px 12px;
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      text-decoration: none;
      color: #374151;
      transition: all 0.2s;
      min-height: 100px;
    }
    .action-btn-large:hover {
      background: #ffffff;
      border-color: var(--primary);
      color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .action-btn-large i {
      font-size: 2rem;
      color: var(--primary);
    }
    .action-btn-large span {
      font-size: 0.875rem;
      font-weight: 600;
      text-align: center;
    }
    @media (max-width: 768px) {
      .staff-dashboard {
        padding: 12px;
      }
      .dashboard-section {
        padding: 12px;
      }
      .quick-actions-compact {
        grid-template-columns: repeat(2, 1fr);
      }
      .next-assignment-card {
        padding: 16px;
      }
      .location-large {
        font-size: 1.25rem;
      }
      .assignment-meta {
        gap: 12px;
      }
      .meta-item {
        font-size: 0.75rem;
      }
    }
  </style>

  <script>
    // SP版：メニューボタンとメニューパネルの制御
    (function() {
      const menuButton = document.getElementById('fixed-menu-button');
      const menuPanel = document.getElementById('sp-menu-panel');
      const menuOverlay = document.getElementById('sp-menu-panel-overlay');
      
      if (!menuButton || !menuPanel || !menuOverlay) return;
      
      // リップルオーバーレイを作成
      let rippleOverlay = document.querySelector('.menu-ripple-overlay');
      if (!rippleOverlay) {
        rippleOverlay = document.createElement('div');
        rippleOverlay.className = 'menu-ripple-overlay';
        document.body.appendChild(rippleOverlay);
      }

      // メニューパネルとリップルオーバーレイを完全にリセットする関数（グローバルスコープで使用可能にする）
      window.resetMenuPanel = function() {
        // メニューパネルの状態をリセット
        if (menuPanel) {
          menuPanel.classList.remove('open', 'closing');
        }
        if (menuOverlay) {
          menuOverlay.classList.remove('open');
        }
        // リップルオーバーレイをリセット
        if (rippleOverlay) {
          rippleOverlay.classList.remove('animating', 'collapsing');
          rippleOverlay.style.display = 'none';
          rippleOverlay.style.opacity = '0';
          rippleOverlay.style.transform = 'scale(0)';
          rippleOverlay.style.top = '';
          rippleOverlay.style.left = '';
          rippleOverlay.style.width = '';
          rippleOverlay.style.height = '';
        }
        document.body.style.overflow = '';
      };

      // 後方互換性のため、resetRippleOverlayも残す
      window.resetRippleOverlay = window.resetMenuPanel;
      
      // メニューの開閉
      function toggleMenu() {
        const isOpen = menuPanel.classList.contains('open');
        if (isOpen) {
          closeMenu();
        } else {
          openMenu();
        }
      }
      
      function openMenu() {
        // 既に開いている場合は何もしない
        if (menuPanel.classList.contains('open')) {
          return;
        }
        
        // 閉じている最中の場合は、まず完全にリセット
        if (menuPanel.classList.contains('closing')) {
          window.resetMenuPanel();
          // リセット後に少し待ってから開く
          setTimeout(() => {
            openMenu();
          }, 50);
          return;
        }
        
        // メニューパネルとリップルオーバーレイの状態をクリア
        menuPanel.classList.remove('closing');
        rippleOverlay.classList.remove('animating', 'collapsing');
        
        // ボタンの位置を取得
        const buttonRect = menuButton.getBoundingClientRect();
        const buttonCenterX = buttonRect.left + buttonRect.width / 2;
        const buttonCenterY = buttonRect.top + buttonRect.height / 2;
        
        // リップルオーバーレイの初期サイズ（ボタンと同じサイズ）
        const initialSize = 100;
        
        // リップルオーバーレイの位置をボタンの中心に設定
        rippleOverlay.style.width = initialSize + 'px';
        rippleOverlay.style.height = initialSize + 'px';
        rippleOverlay.style.left = (buttonCenterX - initialSize / 2) + 'px';
        rippleOverlay.style.top = (buttonCenterY - initialSize / 2) + 'px';
        rippleOverlay.style.transform = 'scale(0)';
        rippleOverlay.style.transformOrigin = 'center center';
        rippleOverlay.style.display = 'block';
        rippleOverlay.style.opacity = '0';
        
        // リップルアニメーション開始（次のフレームで開始）
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            rippleOverlay.classList.add('animating');
          });
        });
        
        // アニメーション完了後にパネルを表示
        setTimeout(() => {
          // 再度状態を確認（閉じられている場合は何もしない）
          if (!menuPanel.classList.contains('closing')) {
            menuPanel.classList.add('open');
            menuOverlay.classList.add('open');
            document.body.style.overflow = 'hidden';
          }
        }, 400); // リップルアニメーションの時間（0.4s）
      }
      
      function closeMenu() {
        // 閉じるアニメーション開始
        menuPanel.classList.remove('open');
        menuPanel.classList.add('closing');
        menuOverlay.classList.remove('open');
        
        // リップルオーバーレイを上にスライドアウト
        if (rippleOverlay.classList.contains('animating')) {
          rippleOverlay.classList.remove('animating');
          rippleOverlay.classList.add('collapsing');
        }
        
        // アニメーション完了後にリセット
        setTimeout(() => {
          window.resetMenuPanel();
          document.body.style.overflow = '';
        }, 300); // アニメーション時間（0.3s）
      }
      
      // メニューボタンのクリックイベント
      menuButton.addEventListener('click', toggleMenu);
      
      // オーバーレイのクリックイベント
      menuOverlay.addEventListener('click', closeMenu);
      
      // メニュー内のリンクをクリックしたらメニューを閉じる
      menuPanel.querySelectorAll('a[href^="/"]').forEach(link => {
        link.addEventListener('click', function() {
          if (this.getAttribute('href') !== 'javascript:void(0);') {
            closeMenu();
          }
        });
      });

      // メニューパネルの閉じるボタン
      const menuCloseBtn = document.getElementById('sp-menu-close-btn');
      if (menuCloseBtn) {
        menuCloseBtn.addEventListener('click', closeMenu);
      }
    })();

    // 設定パネルの制御
    (function() {
      const settingsPanel = document.getElementById('settings-panel');
      const settingsOverlay = document.getElementById('settings-panel-overlay');
      const settingsBack = document.getElementById('settings-panel-back');
      const settingsMenuLink = document.getElementById('settings-menu-link');
      
      if (!settingsPanel || !settingsOverlay || !settingsBack) return;

      // グローバルスコープで設定パネルを開く関数を定義
      window.openSettingsPanel = function() {
        // メニューパネルを完全に閉じてリセット
        if (window.resetMenuPanel) {
          window.resetMenuPanel();
        }
        
        // 現在のメニューボタンの位置を取得して、設定パネルの展開方向を設定
        const menuButton = document.getElementById('fixed-menu-button');
        const currentPosition = localStorage.getItem('staff-menu-button-position') || 'left';
        settingsPanel.classList.remove('panel-left', 'panel-right');
        if (currentPosition === 'right') {
          settingsPanel.classList.add('panel-right'); // 右下ボタン → 右に展開（メニューパネルと逆）
        } else {
          settingsPanel.classList.add('panel-left'); // 左下ボタン → 左に展開（メニューパネルと逆）
        }
        
        // 設定パネルを開く（少し待ってから開く）
        setTimeout(() => {
          settingsPanel.classList.remove('closing');
          settingsPanel.classList.add('open');
          settingsOverlay.classList.add('open');
          document.body.style.overflow = 'hidden';
        }, 100);
      };

      function closeSettingsPanel(resetMenu = false) {
        settingsPanel.classList.remove('open');
        settingsPanel.classList.add('closing');
        settingsOverlay.classList.remove('open');
        
        setTimeout(() => {
          settingsPanel.classList.remove('closing');
          // オーバーレイを完全にリセット
          settingsOverlay.style.display = 'none';
          settingsOverlay.style.opacity = '0';
          
          // 閉じるボタンが押された場合は、メニューパネルもリセット
          if (resetMenu && window.resetMenuPanel) {
            window.resetMenuPanel();
            document.body.style.overflow = '';
          }
        }, 300);
      }

      // 設定メニューリンクのクリックイベント
      if (settingsMenuLink) {
        settingsMenuLink.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          window.openSettingsPanel();
        });
      }

      // 閉じるボタンのクリックイベント（アニメーションをリセット）
      settingsBack.addEventListener('click', function() {
        closeSettingsPanel(true);
      });
      
      // オーバーレイのクリックイベント（メニューパネルは残す）
      settingsOverlay.addEventListener('click', function() {
        closeSettingsPanel(false);
      });

      // メニューパネルと設定パネルの展開方向を更新する関数
      function updatePanelPosition(position) {
        const menuPanel = document.getElementById('sp-menu-panel');
        if (menuPanel) {
          menuPanel.classList.remove('panel-left', 'panel-right');
          if (position === 'right') {
            menuPanel.classList.add('panel-left'); // 右下ボタン → 左に展開
          } else {
            menuPanel.classList.add('panel-right'); // 左下ボタン → 右に展開
          }
        }
        if (settingsPanel) {
          settingsPanel.classList.remove('panel-left', 'panel-right');
          if (position === 'right') {
            settingsPanel.classList.add('panel-right'); // 右下ボタン → 右に展開（メニューパネルと逆）
          } else {
            settingsPanel.classList.add('panel-left'); // 左下ボタン → 左に展開（メニューパネルと逆）
          }
        }
      }

      // メニューボタン配置切り替え
      const menuPositionLeft = document.getElementById('menu-position-left');
      const menuPositionRight = document.getElementById('menu-position-right');
      const menuButton = document.getElementById('fixed-menu-button');

      // 保存された設定を読み込む
      const savedPosition = localStorage.getItem('staff-menu-button-position') || 'left';
      if (savedPosition === 'right') {
        if (menuPositionRight) menuPositionRight.checked = true;
        if (menuButton) {
          menuButton.classList.add('position-right');
        }
      } else {
        if (menuPositionLeft) menuPositionLeft.checked = true;
        if (menuButton) {
          menuButton.classList.remove('position-right');
        }
      }
      // 初期状態でパネルの展開方向を設定
      updatePanelPosition(savedPosition);

      // ラジオボタンの変更イベント
      if (menuPositionLeft && menuPositionRight && menuButton) {
        menuPositionLeft.addEventListener('change', function() {
          if (this.checked) {
            menuButton.classList.remove('position-right');
            localStorage.setItem('staff-menu-button-position', 'left');
            updatePanelPosition('left');
          }
        });

        menuPositionRight.addEventListener('change', function() {
          if (this.checked) {
            menuButton.classList.add('position-right');
            localStorage.setItem('staff-menu-button-position', 'right');
            updatePanelPosition('right');
          }
        });
      }

      // ダークモード切り替え
      const themeModeLight = document.getElementById('theme-mode-light');
      const themeModeDark = document.getElementById('theme-mode-dark');

      // 保存されたテーマ設定を読み込む
      const savedTheme = localStorage.getItem('staff-theme-mode') || 'light';
      if (savedTheme === 'dark') {
        if (themeModeDark) themeModeDark.checked = true;
        document.body.classList.add('dark-mode');
      } else {
        if (themeModeLight) themeModeLight.checked = true;
        document.body.classList.remove('dark-mode');
      }

      // テーマ切り替えイベント
      if (themeModeLight && themeModeDark) {
        themeModeLight.addEventListener('change', function() {
          if (this.checked) {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('staff-theme-mode', 'light');
          }
        });

        themeModeDark.addEventListener('change', function() {
          if (this.checked) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('staff-theme-mode', 'dark');
          }
        });
      }
    })();

    // カウントダウンタイマー
    (function() {
      function updateCountdowns() {
        const countdowns = document.querySelectorAll('.countdown[data-deadline]');
        const now = new Date().getTime();

        countdowns.forEach(function(countdown) {
          const deadline = new Date(countdown.getAttribute('data-deadline')).getTime();
          const diff = deadline - now;

          if (diff <= 0) {
            countdown.textContent = '期限切れ';
            countdown.style.color = '#ef4444';
            return;
          }

          const hours = Math.floor(diff / (1000 * 60 * 60));
          const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
          const days = Math.floor(hours / 24);

          if (days > 0) {
            countdown.textContent = `期限まで ${days}日`;
          } else if (hours > 0) {
            countdown.textContent = `期限まで ${hours}時間${minutes > 0 ? minutes + '分' : ''}`;
          } else {
            countdown.textContent = `期限まで ${minutes}分`;
          }
        });
      }

      // 初回実行
      updateCountdowns();
      // 1分ごとに更新
      setInterval(updateCountdowns, 60000);
    })();

    // 残り時間の更新（次の作業カード用）
    (function() {
      function updateTimeRemaining() {
        const timeRemaining = document.getElementById('time-remaining');
        if (!timeRemaining) return;

        // 次の作業の開始時刻（10:30）を取得
        const now = new Date();
        const nextTime = new Date();
        nextTime.setHours(10, 30, 0, 0);

        // 今日の10:30が過ぎている場合は明日の10:30
        if (now > nextTime) {
          nextTime.setDate(nextTime.getDate() + 1);
        }

        const diff = nextTime - now;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

        if (hours > 0) {
          timeRemaining.textContent = `あと${hours}時間${minutes}分`;
        } else {
          timeRemaining.textContent = `あと${minutes}分`;
        }
      }

      updateTimeRemaining();
      setInterval(updateTimeRemaining, 60000);
    })();

    // オフライン対応の可視化
    (function() {
      const offlineIndicator = document.getElementById('offline-indicator');
      const offlineIcon = document.getElementById('offline-icon');
      const offlineText = document.getElementById('offline-text');
      const pendingCountEl = document.getElementById('pending-count');
      
      if (!offlineIndicator) return;

      function updateOnlineStatus() {
        const isOnline = navigator.onLine;
        const pendingCount = document.querySelectorAll('.pending-card').length;
        
        if (isOnline) {
          offlineIndicator.style.display = 'none';
        } else {
          offlineIndicator.style.display = 'block';
          offlineIndicator.classList.remove('online');
          offlineIcon.className = 'fas fa-wifi-slash';
          offlineText.textContent = `オフライン（同期待ち: ${pendingCount}件）`;
          if (pendingCountEl) {
            pendingCountEl.textContent = pendingCount;
          }
        }
      }

      // 初回チェック
      updateOnlineStatus();

      // オンライン/オフラインイベント
      window.addEventListener('online', function() {
        offlineIndicator.style.display = 'block';
        offlineIndicator.classList.add('online');
        offlineIcon.className = 'fas fa-wifi';
        offlineText.textContent = '● オンライン';
        setTimeout(function() {
          offlineIndicator.style.display = 'none';
        }, 3000);
      });

      window.addEventListener('offline', function() {
        updateOnlineStatus();
      });

      // 定期的にチェック（ネットワーク状態が正確でない場合があるため）
      setInterval(updateOnlineStatus, 5000);
    })();

    // 音声・バイブレーション通知
    (function() {
      // 通知設定の読み込み
      const soundEnabled = localStorage.getItem('staff-notification-sound') !== 'false';
      const vibrationEnabled = localStorage.getItem('staff-notification-vibration') !== 'false';
      const reminderEnabled = localStorage.getItem('staff-notification-reminder') === 'true';

      // 通知設定の保存
      const notificationSound = document.getElementById('notification-sound');
      const notificationVibration = document.getElementById('notification-vibration');
      const notificationReminder = document.getElementById('notification-reminder');

      if (notificationSound) {
        notificationSound.checked = soundEnabled;
        notificationSound.addEventListener('change', function() {
          localStorage.setItem('staff-notification-sound', this.checked);
        });
      }

      if (notificationVibration) {
        notificationVibration.checked = vibrationEnabled;
        notificationVibration.addEventListener('change', function() {
          localStorage.setItem('staff-notification-vibration', this.checked);
        });
      }

      if (notificationReminder) {
        notificationReminder.checked = reminderEnabled;
        notificationReminder.addEventListener('change', function() {
          localStorage.setItem('staff-notification-reminder', this.checked);
        });
      }

      // 通知を送信する関数
      window.sendNotification = function(message, type) {
        if (vibrationEnabled && 'vibrate' in navigator) {
          navigator.vibrate(200);
        }

        if (soundEnabled) {
          // 音声通知（Web Audio APIを使用）
          try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
          } catch (e) {
            console.log('音声通知エラー:', e);
          }
        }
      };

      // 作業開始リマインダー（15分前）
      if (reminderEnabled) {
        setInterval(function() {
          const timeRemaining = document.getElementById('time-remaining');
          if (!timeRemaining) return;

          const text = timeRemaining.textContent;
          // "あと15分" または "あと0時間15分" の場合に通知
          if (text.includes('15分') && !text.includes('16分') && !text.includes('14分')) {
            window.sendNotification('次の作業まで15分です', 'reminder');
          }
        }, 60000); // 1分ごとにチェック
      }
    })();

    // レイアウト切り替え
    (function() {
      const layoutCompact = document.getElementById('layout-mode-compact');
      const layoutStandard = document.getElementById('layout-mode-standard');
      const layoutDetailed = document.getElementById('layout-mode-detailed');
      const dashboard = document.querySelector('.staff-dashboard');

      // 保存されたレイアウト設定を読み込む
      const savedLayout = localStorage.getItem('staff-layout-mode') || 'standard';
      
      if (savedLayout === 'compact') {
        if (layoutCompact) layoutCompact.checked = true;
        if (dashboard) dashboard.classList.add('layout-compact');
      } else if (savedLayout === 'detailed') {
        if (layoutDetailed) layoutDetailed.checked = true;
        if (dashboard) dashboard.classList.add('layout-detailed');
      } else {
        if (layoutStandard) layoutStandard.checked = true;
      }

      // レイアウト切り替えイベント
      if (layoutCompact) {
        layoutCompact.addEventListener('change', function() {
          if (this.checked) {
            if (dashboard) {
              dashboard.classList.remove('layout-detailed');
              dashboard.classList.add('layout-compact');
            }
            localStorage.setItem('staff-layout-mode', 'compact');
          }
        });
      }

      if (layoutStandard) {
        layoutStandard.addEventListener('change', function() {
          if (this.checked) {
            if (dashboard) {
              dashboard.classList.remove('layout-compact', 'layout-detailed');
            }
            localStorage.setItem('staff-layout-mode', 'standard');
          }
        });
      }

      if (layoutDetailed) {
        layoutDetailed.addEventListener('change', function() {
          if (this.checked) {
            if (dashboard) {
              dashboard.classList.remove('layout-compact');
              dashboard.classList.add('layout-detailed');
            }
            localStorage.setItem('staff-layout-mode', 'detailed');
          }
        });
      }
    })();
  </script>
</main>

