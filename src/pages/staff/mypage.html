@layout('layouts.base')
@json('data/meta/staff_mypage_title.json', $title)
@json('data/meta/staff_mypage_body_class.json', $body_class)
<link rel="stylesheet" href="/css/admin-sidebar.css">
<!-- AWS SDKの読み込み -->
<script src="https://sdk.amazonaws.com/js/aws-sdk-2.1000.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.0/dist/amazon-cognito-identity.min.js"></script>
<script src="/js/cognito_config.js"></script>
<script src="/js/cognito_auth.js"></script>
<script src="/js/client_auth.js"></script>
<script src="/js/admin-sidebar.js"></script>

<!-- サイドバー -->
<aside class="sidebar" id="admin-sidebar">
  <div class="sidebar-header">
    <a href="/staff/mypage" class="logo-link">
      <img src="/images/logo_144x144.png" alt="ミセサポ" class="logo-img" />
      <span class="logo-text">ミセサポ</span>
    </a>
  </div>

  <!-- ロール表示 -->
  <div class="sidebar-role">
    <span class="role-badge" id="sidebar-role-badge">清掃員</span>
  </div>

  <nav class="sidebar-nav">
    <a href="/admin/dashboard" class="nav-item nav-item-admin" data-page="dashboard">
      <i class="fas fa-tachometer-alt"></i>
      <span class="nav-label">管理ダッシュボード</span>
    </a>
    <div class="nav-divider"></div>
    <a href="/staff/mypage" class="nav-item active" data-page="mypage">
      <i class="fas fa-user-circle"></i>
      <span class="nav-label">マイページ</span>
    </a>
    <a href="/staff/attendance-history" class="nav-item" data-page="attendance-history">
      <i class="fas fa-history"></i>
      <span class="nav-label">出勤履歴</span>
    </a>
    <a href="/staff/daily-reports" class="nav-item" data-page="daily-reports">
      <i class="fas fa-edit"></i>
      <span class="nav-label">日報</span>
    </a>
    <a href="/staff/schedule" class="nav-item" data-page="schedule">
      <i class="fas fa-calendar-alt"></i>
      <span class="nav-label">スケジュール</span>
    </a>
    <a href="/staff/assignments" class="nav-item" data-page="assignments">
      <i class="fas fa-tasks"></i>
      <span class="nav-label">作業一覧</span>
    </a>
    <a href="/wiki" class="nav-item" data-page="wiki">
      <i class="fas fa-book-open"></i>
      <span class="nav-label">WIKI</span>
    </a>
    <a href="/cleaning-manual" class="nav-item" data-page="cleaning-manual">
      <i class="fas fa-book"></i>
      <span class="nav-label">清掃マニュアル</span>
    </a>
    <a href="/announcements" class="nav-item" data-page="announcements">
      <i class="fas fa-bullhorn"></i>
      <span class="nav-label">お知らせ</span>
    </a>
    <div class="nav-divider"></div>
    <a href="/staff/mypage/settings" class="nav-item" data-page="settings">
      <i class="fas fa-cog"></i>
      <span class="nav-label">設定</span>
    </a>
    <button class="nav-item nav-item-button" onclick="staffLogout()">
      <i class="fas fa-sign-out-alt"></i>
      <span class="nav-label">ログアウト</span>
    </button>
  </nav>

  <!-- トグルボタン -->
  <button class="sidebar-toggle" id="sidebar-toggle" aria-label="サイドバーを開閉">
    <i class="fas fa-chevron-left"></i>
  </button>
</aside>

<main id="main" class="staff-mypage main-content">
  <div class="loading" id="loading">読み込み中...</div>
  <div id="error-message" class="error-message" style="display: none;"></div>
  
  <div id="mypage-content" style="display: none;">
    <!-- メインコンテンツ -->
    <div class="mypage-grid stack-on-sm">
      <!-- メインカラム -->
      <div class="mypage-main">
        <!-- 出退勤記録セクション -->
        <section class="section section-order-1">
          <h2 class="section-title">
            <i class="fas fa-clock"></i>
            出退勤記録
          </h2>
          <div class="card attendance-card">
            <!-- 今日の出退勤状況 -->
            <div class="attendance-today-grid">
              <div class="attendance-status-box" id="attendance-status">
                <div class="status-indicator" id="status-indicator"></div>
                <div class="status-info">
                  <span class="status-label" id="status-label">未出勤</span>
                  <span class="status-time" id="status-time">--:--</span>
                </div>
              </div>
              <div class="attendance-action-box">
                <button class="btn-attendance btn-clock-in" id="attendance-toggle-btn">
                  <i class="fas fa-sign-in-alt"></i>
                  <span id="toggle-btn-text">出勤</span>
              </button>
              </div>
            </div>
            
            <!-- 休憩セクション（出勤中のみ表示） -->
            <div id="break-section" class="break-section" style="display: none;">
              <div class="break-header">
                <span class="break-label"><i class="fas fa-coffee"></i> 休憩</span>
                <span id="break-time-display" class="break-time">0分</span>
                </div>
              <div id="breaks-list" class="breaks-list"></div>
              <div class="break-actions">
                <button class="btn btn-outline btn-sm" id="break-start-btn">
                  <i class="fas fa-pause"></i> 休憩開始
                </button>
                <button class="btn btn-warning btn-sm" id="break-end-btn" style="display: none;">
                  <i class="fas fa-play"></i> 休憩終了
                </button>
              </div>
            </div>
            
            <!-- 今月のサマリー -->
            <div class="attendance-summary">
              <div class="summary-item">
                <span class="summary-label">今月の出勤</span>
                <span class="summary-value" id="monthly-work-days">0日</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">今月の労働時間</span>
                <span class="summary-value" id="monthly-work-hours">0時間</span>
              </div>
            </div>
            
            <!-- アクション -->
            <div class="attendance-footer">
              <button class="btn btn-text btn-sm" id="request-correction-btn">
                <i class="fas fa-edit"></i> 打刻修正を申請
              </button>
            </div>
          </div>
        </section>

        <!-- TODOリスト -->
        <section class="section section-order-2">
          <h2 class="section-title">
            <i class="fas fa-tasks"></i>
            TODOリスト
            <span class="todo-count" id="todo-count">0</span>
          </h2>
          <div class="card todo-card">
            <div class="todo-input-wrapper">
              <input type="text" id="todo-input" class="todo-input" placeholder="新しいタスクを追加..." />
              <button class="btn btn-primary btn-sm" id="add-todo-btn">
                <i class="fas fa-plus"></i>
              </button>
            </div>
            <div id="todo-list" class="todo-list">
              <!-- TODOアイテムが動的に生成される -->
            </div>
            <div class="todo-filters" id="todo-filters">
              <button class="filter-btn active" data-filter="all">すべて</button>
              <button class="filter-btn" data-filter="active">未完了</button>
              <button class="filter-btn" data-filter="completed">完了</button>
            </div>
          </div>
        </section>

        <!-- 今週のスケジュール -->
        <section class="section section-order-3">
          <h2 class="section-title">
            <i class="fas fa-calendar-alt"></i>
            今週のスケジュール
          </h2>
          <div class="card">
            <div id="weekly-schedule">
              <div class="empty-state">予定はありません</div>
            </div>
          </div>
        </section>

      </div>

      <!-- サイドバーカラム -->
      <aside class="mypage-side">
        <!-- 基本情報 -->
        <section class="section">
          <h2 class="section-title">
            <i class="fas fa-user"></i>
            基本情報
          </h2>
          <div class="card">
            <div class="info-item">
              <span class="info-item-label">ユーザーID</span>
              <span class="info-item-value" id="info-user-id">-</span>
            </div>
            <div class="info-item">
              <span class="info-item-label">メールアドレス</span>
              <span class="info-item-value" id="info-email">-</span>
            </div>
            <div class="info-item">
              <span class="info-item-label">電話番号</span>
              <span class="info-item-value" id="info-phone">-</span>
            </div>
            <div class="info-item">
              <span class="info-item-label">部署</span>
              <span class="info-item-value" id="info-department">-</span>
            </div>
            <div class="info-item">
              <span class="info-item-label">登録日</span>
              <span class="info-item-value" id="info-created-at">-</span>
            </div>
          </div>
        </section>

        <!-- 今月のカレンダー -->
        <section class="section calendar-section hide-sm">
          <div class="calendar-head">
            <a class="calendar-nav" href="#" id="calendar-prev" aria-label="前へ">
              <i class="fa-solid fa-chevron-left"></i>
            </a>
            <h2 class="calendar-title" id="calendar-title">2025 06</h2>
            <a class="calendar-nav" href="#" id="calendar-next" aria-label="次へ">
              <i class="fa-solid fa-chevron-right"></i>
            </a>
          </div>
          <div class="card">
            <div class="calendar-grid" id="calendar-grid">
              <!-- カレンダーが動的に生成される -->
            </div>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <style>
    .staff-mypage {
      width: 100%;
      max-width: none;
      margin: 0;
      padding: 24px;
      background: #f9fafb;
      min-height: 100vh;
      box-sizing: border-box;
    }
    .loading {
      text-align: center;
      padding: 48px;
      color: #6b7280;
      font-size: 1rem;
    }
    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      text-align: center;
    }
    .mypage-grid {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
    }
    .mypage-main {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .mypage-side {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .section {
      background: #ffffff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
      margin: 0 0 16px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title i {
      color: var(--primary);
    }
    .card {
      background: #f9fafb;
      border-radius: 8px;
      padding: 16px;
    }
    .attendance-card {
      padding: 20px;
    }
    /* 出退勤セクション */
    .attendance-card {
      padding: 0;
    }
    .attendance-today-grid {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      background: linear-gradient(135deg, #fef3f2 0%, #fff1f2 100%);
      border-radius: 12px 12px 0 0;
      gap: 16px;
    }
    .attendance-status-box {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #9ca3af;
      flex-shrink: 0;
    }
    .status-indicator.working {
      background: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
      animation: pulse 2s infinite;
    }
    .status-indicator.break {
      background: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .status-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .status-label {
      font-size: 0.8rem;
      color: #6b7280;
      font-weight: 500;
    }
    .status-time {
      font-size: 1.25rem;
      font-weight: 700;
      color: #111827;
      font-family: 'SF Mono', 'Monaco', monospace;
    }
    .attendance-action-box {
      flex-shrink: 0;
    }
    .btn-attendance {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      border: none;
      border-radius: 50px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-clock-in {
      background: var(--primary);
      color: #fff;
    }
    .btn-clock-in:hover {
      background: #e11d48;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(244, 63, 94, 0.3);
    }
    .btn-clock-out {
      background: #6b7280;
      color: #fff;
    }
    .btn-clock-out:hover {
      background: #4b5563;
    }
    
    /* 休憩セクション */
    .break-section {
      padding: 16px 20px;
      background: #fefce8;
      border-top: 1px solid #fef08a;
    }
    .break-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .break-label {
      font-size: 0.875rem;
      font-weight: 600;
      color: #854d0e;
    }
    .break-label i {
      margin-right: 6px;
    }
    .break-time {
      font-size: 0.875rem;
      font-weight: 600;
      color: #a16207;
    }
    .breaks-list {
      font-size: 0.8rem;
      color: #a16207;
      margin-bottom: 12px;
    }
    .break-actions {
      display: flex;
      gap: 8px;
    }
    .break-actions .btn {
      flex: 1;
    }
    
    /* サマリー */
    .attendance-summary {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1px;
      background: #e5e7eb;
      border-top: 1px solid #e5e7eb;
    }
    .summary-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 16px 20px;
      background: #fff;
    }
    .summary-label {
      font-size: 0.75rem;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .summary-value {
      font-size: 1.25rem;
      font-weight: 700;
      color: #111827;
    }
    
    /* フッター */
    .attendance-footer {
      padding: 12px 20px;
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      border-radius: 0 0 12px 12px;
      text-align: center;
    }
    .btn-text {
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 0.875rem;
      cursor: pointer;
      padding: 8px 16px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .btn-text:hover {
      background: #e5e7eb;
      color: #374151;
    }
    .btn-warning {
      background: #f59e0b;
      color: #fff;
      border: none;
    }
    .btn-warning:hover {
      background: #d97706;
    }
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .info-item:last-child {
      border-bottom: none;
    }
    .info-item-label {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .info-item-value {
      font-size: 0.95rem;
      color: #111827;
      font-weight: 500;
    }
    .empty-state {
      text-align: center;
      padding: 32px;
      color: #9ca3af;
      font-size: 0.95rem;
    }
    .calendar-section {
      overflow: hidden;
    }
    .calendar-section .card {
      padding: 12px;
      overflow: hidden;
    }
    .calendar-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding: 0 4px;
    }
    .calendar-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }
    .calendar-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: #f3f4f6;
      color: #6b7280;
      text-decoration: none;
      transition: all 0.2s;
    }
    .calendar-nav:hover {
      background: var(--primary);
      color: #fff;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      width: 100%;
    }
    .calendar-cell {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      border-radius: 4px;
      min-width: 0;
    }
    .calendar-day-name {
      font-weight: 600;
      color: #6b7280;
      background: transparent;
    }
    .calendar-date {
      color: #374151;
      cursor: pointer;
      transition: all 0.2s;
    }
    .calendar-date:hover {
      background: #f3f4f6;
    }
    .calendar-date.disabled {
      color: #d1d5db;
      cursor: default;
    }
    .calendar-date.has-attendance {
      background: #d1fae5;
      color: #065f46;
      font-weight: 600;
    }
    .calendar-date.today {
      background: var(--primary);
      color: #fff;
      font-weight: 700;
    }
    /* TODOリスト */
    .todo-count {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      background: var(--primary);
      color: #fff;
      border-radius: 10px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 8px;
    }
    .todo-card {
      padding: 16px;
    }
    .todo-input-wrapper {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }
    .todo-input {
      flex: 1;
      padding: 10px 14px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.875rem;
      transition: all 0.2s;
    }
    .todo-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.1);
    }
    .todo-list {
      max-height: 300px;
      overflow-y: auto;
    }
    .todo-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    .todo-item:hover {
      background: #f3f4f6;
    }
    .todo-item.completed {
      opacity: 0.6;
    }
    .todo-item.completed .todo-text {
      text-decoration: line-through;
      color: #9ca3af;
    }
    .todo-checkbox {
      width: 20px;
      height: 20px;
      border: 2px solid #d1d5db;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .todo-checkbox:hover {
      border-color: var(--primary);
    }
    .todo-item.completed .todo-checkbox {
      background: #10b981;
      border-color: #10b981;
      color: #fff;
    }
    .todo-text {
      flex: 1;
      font-size: 0.875rem;
      color: #374151;
    }
    .todo-text-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 0.875rem;
      color: #374151;
      padding: 0;
    }
    .todo-text-input:focus {
      outline: none;
    }
    .todo-delete {
      width: 24px;
      height: 24px;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
      opacity: 0;
    }
    .todo-item:hover .todo-delete {
      opacity: 1;
    }
    .todo-delete:hover {
      background: #fee2e2;
      color: #ef4444;
    }
    .todo-filters {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e5e7eb;
    }
    .filter-btn {
      padding: 6px 12px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 0.75rem;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .filter-btn:hover {
      background: #f3f4f6;
    }
    .filter-btn.active {
      background: var(--primary);
      color: #fff;
    }
    .todo-empty {
      text-align: center;
      padding: 24px;
      color: #9ca3af;
      font-size: 0.875rem;
    }

    @media (max-width: 767.98px) {
      .staff-mypage.main-content {
        margin-left: 0 !important;
        width: 100% !important;
      }
      
      .staff-mypage {
        padding: 12px;
      }
      .mypage-grid {
        grid-template-columns: 1fr;
      }
      .attendance-today-grid {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
        text-align: center;
      }
      .attendance-status-box {
        justify-content: center;
      }
      .btn-attendance {
        width: 100%;
        justify-content: center;
      }
      .attendance-summary {
        grid-template-columns: 1fr;
      }
    }
  </style>

  <script>
    const API_BASE = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
    let currentUser = null;
    let attendanceRecords = {};
    let currentCalendarDate = new Date();

    // 従業員用ログアウト関数
    function staffLogout() {
      // Cognitoからログアウト
      if (window.CognitoAuth && typeof window.CognitoAuth.logout === 'function') {
        window.CognitoAuth.logout();
      }
      // ローカルストレージをクリア
      localStorage.removeItem('cognito_user');
      localStorage.removeItem('misesapo_auth');
      localStorage.removeItem('cognito_id_token');
      localStorage.removeItem('cognito_access_token');
      localStorage.removeItem('cognito_refresh_token');
      // 従業員ログイン画面にリダイレクト
      window.location.href = '/staff/signin.html';
    }

    // 現在のユーザー情報を取得
    async function loadCurrentUser() {
      const loadingEl = document.getElementById('loading');
      const contentEl = document.getElementById('mypage-content');
      const errorEl = document.getElementById('error-message');

      try {
        loadingEl.style.display = 'block';
        contentEl.style.display = 'none';
        errorEl.style.display = 'none';

        // ユーザーIDまたはメールアドレスを取得（優先順位: URLパラメータ > 認証情報）
        let userId = null;
        let userEmail = null;
        
        // URLパラメータからIDまたはメールアドレスを取得
        const urlParams = new URLSearchParams(window.location.search);
        const urlId = urlParams.get('id');
        const urlEmail = urlParams.get('email');
        
        if (urlId) {
          userId = urlId;
        } else if (urlEmail) {
          userEmail = urlEmail;
        }
        
        // URLパラメータがない場合、認証情報から個人のIDまたはメールアドレスを取得（Cognito認証を優先）
        if (!userId && !userEmail) {
          // まずローカルストレージのcognito_userを確認（最も信頼性が高い）
          try {
            const storedCognitoUser = localStorage.getItem('cognito_user');
            if (storedCognitoUser) {
              const parsedUser = JSON.parse(storedCognitoUser);
              if (parsedUser.email) {
                userEmail = parsedUser.email;
                console.log('[Mypage] Using email from stored cognito_user:', userEmail);
              } else if (parsedUser.id) {
                userId = parsedUser.id;
                console.log('[Mypage] Using ID from stored cognito_user:', userId);
              }
            }
          } catch (e) {
            console.warn('[Mypage] Error parsing stored cognito_user:', e);
          }
          
          // ローカルストレージになければCognito認証を確認
          if (!userId && !userEmail && window.CognitoAuth && window.CognitoAuth.isAuthenticated()) {
            const cognitoUser = await window.CognitoAuth.getCurrentUser();
            console.log('[Mypage] Cognito user:', cognitoUser);
            if (cognitoUser) {
              // メールアドレスを優先して使用（cognito_subでの検索がうまくいかない場合があるため）
              if (cognitoUser.email) {
                userEmail = cognitoUser.email;
                console.log('[Mypage] Using email from Cognito:', userEmail);
              } else if (cognitoUser.id) {
                userId = cognitoUser.id;  // DynamoDBのID
                console.log('[Mypage] Using ID from Cognito:', userId);
              }
            }
          }
          
          // misesapo_authも確認（フォールバック）
          if (!userId && !userEmail) {
            try {
              const storedAuth = localStorage.getItem('misesapo_auth');
              if (storedAuth) {
                const parsedAuth = JSON.parse(storedAuth);
                if (parsedAuth.email) {
                  userEmail = parsedAuth.email;
                  console.log('[Mypage] Using email from misesapo_auth:', userEmail);
                } else if (parsedAuth.user && parsedAuth.user.email) {
                  userEmail = parsedAuth.user.email;
                  console.log('[Mypage] Using email from misesapo_auth.user:', userEmail);
                }
              }
            } catch (e) {
              console.warn('[Mypage] Error parsing misesapo_auth:', e);
            }
          }
          
          // Firebase認証を確認（フォールバック）
          if (!userId && !userEmail) {
            const authData = window.Auth?.getAuthData?.();
            if (authData && authData.user) {
              if (authData.user.id) {
                userId = authData.user.id;
              } else if (authData.user.email || authData.email) {
                userEmail = authData.user.email || authData.email;
              }
            }
          }
        }
        
        if (!userId && !userEmail) {
          throw new Error('ログインしてください。');
        }
        
        // ユーザー情報を取得（ローカルJSONを優先、APIをフォールバック）
        try {
          // まずローカルのworkers.jsonから検索（最新データ）
          try {
            const localResponse = await fetch('/data/workers.json');
            if (localResponse.ok) {
              const localWorkers = await localResponse.json();
              if (Array.isArray(localWorkers) && localWorkers.length > 0) {
                // メールアドレスで検索
                if (userEmail) {
                  const matchingUser = localWorkers.find(u => u.email && u.email.toLowerCase() === userEmail.toLowerCase());
                  if (matchingUser) {
                    currentUser = matchingUser;
                    console.log('[Mypage] Found user from local data:', matchingUser.name);
                  }
                }
                // IDで検索
                if (!currentUser && userId) {
                  const matchingUser = localWorkers.find(u => u.id === userId);
                  if (matchingUser) {
                    currentUser = matchingUser;
                    console.log('[Mypage] Found user by ID from local data:', matchingUser.name);
                  }
                }
              }
            }
          } catch (localError) {
            console.log('[Mypage] Local workers.json not available, trying API');
          }
          
          // ローカルで見つからない場合、APIで検索
          if (!currentUser || !currentUser.id) {
          let response = null;
          
          if (userId) {
            // IDで取得を試みる
            response = await fetch(`${API_BASE}/workers/${userId}`);
            if (response.ok) {
              currentUser = await response.json();
            }
          }
          
            // IDで見つからない場合、メールアドレスで検索
          if (!currentUser || !currentUser.id) {
            if (userEmail) {
              response = await fetch(`${API_BASE}/workers?email=${encodeURIComponent(userEmail)}`);
              if (response && response.ok) {
                const users = await response.json();
                const items = users.items || users.workers || users;
                if (Array.isArray(items) && items.length > 0) {
                    const matchingUser = items.find(u => u.email && u.email.toLowerCase() === userEmail.toLowerCase());
                    if (matchingUser) {
                      currentUser = matchingUser;
                      console.log('[Mypage] Found user by email from API:', matchingUser.name);
                    }
                  }
                }
                }
              }
            }
            
            // まだ見つからない場合、Cognito SubまたはFirebase UIDで検索（フォールバック）
            if (!currentUser || !currentUser.id) {
              let fallbackResponse = null;
              
              // Cognito Subで検索
              if (window.CognitoAuth) {
                const cognitoUser = await window.CognitoAuth.getCurrentUser();
                if (cognitoUser && cognitoUser.cognito_sub) {
                  fallbackResponse = await fetch(`${API_BASE}/workers?cognito_sub=${encodeURIComponent(cognitoUser.cognito_sub)}`);
                }
              }
              
              // Firebase UIDで検索（フォールバック）
              if (!fallbackResponse || !fallbackResponse.ok) {
                const authData = window.Auth?.getAuthData?.();
                if (authData && authData.user && authData.user.firebase_uid) {
                  fallbackResponse = await fetch(`${API_BASE}/workers?firebase_uid=${encodeURIComponent(authData.user.firebase_uid)}`);
                }
              }
              
              if (fallbackResponse && fallbackResponse.ok) {
                const users = await fallbackResponse.json();
                const items = users.items || users.workers || users;
                if (Array.isArray(items) && items.length > 0) {
                  currentUser = items[0];
              }
            }
          }
        } catch (error) {
          console.error('Error fetching user info:', error);
        }

        if (!currentUser || !currentUser.id) {
          throw new Error('ユーザー情報を取得できませんでした。ログインしてください。');
        }

        console.log('User loaded:', currentUser);

        // ロールを変換
        if (currentUser.role_code !== undefined) {
          currentUser.role = getRoleFromCode(currentUser.role_code);
        }

        // 出退勤記録を読み込み（非同期）
        await loadAttendanceRecords();

        // ユーザー情報を表示
        renderUser(currentUser);

        // スケジュールを読み込み
        loadWeeklySchedule();

        // カレンダーを表示
        renderCalendar();
        
        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';
        
        console.log('Content displayed, checking button...');
        console.log('Button element:', document.getElementById('attendance-toggle-btn'));
        console.log('Content element display:', window.getComputedStyle(contentEl).display);
        
        // 出退勤ボタンのイベントリスナーを再設定（コンテンツ表示後）
        // 少し遅延を入れてDOMが完全にレンダリングされるのを待つ
        setTimeout(() => {
          console.log('Setting up button after delay...');
          setupAttendanceToggleButton();
          
          // ボタンが存在するか再確認
          const btn = document.getElementById('attendance-toggle-btn');
          if (btn) {
            console.log('Button found after setup:', btn);
            console.log('Button display style:', window.getComputedStyle(btn).display);
            console.log('Button visibility:', window.getComputedStyle(btn).visibility);
            console.log('Button parent display:', window.getComputedStyle(btn.parentElement).display);
          } else {
            console.error('Button still not found after setup!');
          }
        }, 100);
      } catch (error) {
        console.error('Error loading user:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = `エラー: ${error.message}`;
      }
    }

    function getRoleFromCode(code) {
      if (code === '99' || code === 99) return 'staff';
      if (code === '1' || code === 1) return 'admin';
      if (code === '2' || code === 2) return 'sales';
      return 'staff';
    }

    function getRoleLabel(role) {
      const labels = { staff: '清掃員', sales: '営業', admin: '管理者', other: 'その他' };
      return labels[role] || role;
    }

    function getRoleColor(role) {
      const colors = {
        staff: '#f59e0b',
        sales: '#10b981',
        admin: '#ec4899',
        other: '#64748b'
      };
      return colors[role] || '#64748b';
    }

    // ユーザー情報を表示
    function renderUser(user) {
      // 基本情報
      document.getElementById('info-user-id').textContent = user.id || '-';
      document.getElementById('info-email').textContent = user.email || '-';
      document.getElementById('info-phone').textContent = user.phone || '-';
      document.getElementById('info-department').textContent = user.department || '-';
      document.getElementById('info-created-at').textContent = formatDate(user.created_at);
      
      // サイドバーのロールバッジを更新
      const roleBadge = document.getElementById('sidebar-role-badge');
      if (roleBadge && user.department) {
        roleBadge.textContent = user.department;
      }
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric'
      });
    }

    function formatTime(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleTimeString('ja-JP', { 
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // 労働時間を計算（休憩時間を考慮）
    function calculateWorkHours(clockIn, clockOut, breaks) {
      if (!clockIn || !clockOut) return 0;
      
      const start = new Date(clockIn);
      const end = new Date(clockOut);
      const totalHours = (end - start) / (1000 * 60 * 60);
      
      const breakTime = calculateTotalBreakTime(breaks || []);
      const workHours = Math.max(0, totalHours - breakTime);
      
      return round(workHours, 2);
    }

    // 労働時間をフォーマット
    function formatWorkHours(hours) {
      if (!hours || hours === 0) return '0時間';
      const h = Math.floor(hours);
      const m = Math.round((hours - h) * 60);
      if (m === 0) {
        return `${h}時間`;
      }
      return `${h}時間${m}分`;
    }

    // 出退勤記録を読み込み
    async function loadAttendanceRecords() {
      if (!currentUser) {
        // ローカルストレージから読み込み（フォールバック）
        try {
          const stored = localStorage.getItem('attendanceRecords');
          if (stored) {
            attendanceRecords = JSON.parse(stored);
          }
        } catch (error) {
          console.error('Error loading attendance records from localStorage:', error);
          attendanceRecords = {};
        }
        renderAttendanceStatus();
        calculateMonthlyStats();
        return;
      }
      
      try {
        // APIから勤怠記録を取得（今日の記録）
        const today = new Date().toISOString().split('T')[0];
        const response = await fetch(`${API_BASE}/attendance?staff_id=${currentUser.id}&date=${today}`);
        
        if (response.ok) {
          const data = await response.json();
          // レスポンスが配列の場合とオブジェクトの場合に対応
          let record = null;
          if (data.items && Array.isArray(data.items) && data.items.length > 0) {
            record = data.items[0];
          } else if (data.date || data.clock_in) {
            record = data;
          }
          
          if (record) {
            // APIから取得したデータをattendanceRecordsに変換
            const date = record.date || today;
            if (!attendanceRecords[date]) {
              attendanceRecords[date] = {};
            }
            attendanceRecords[date][currentUser.id] = {
              clock_in: record.clock_in,
              clock_out: record.clock_out,
              staff_id: record.staff_id || currentUser.id,
              staff_name: record.staff_name || currentUser.name
            };
          }
        }
      } catch (error) {
        console.warn('APIからの勤怠記録取得に失敗しました。ローカルストレージから読み込みます:', error);
      }
      
      // ローカルストレージからも読み込み（フォールバック）
      try {
        const stored = localStorage.getItem('attendanceRecords');
        if (stored) {
          const localRecords = JSON.parse(stored);
          // ローカルストレージのデータとマージ
          for (const date in localRecords) {
            if (!attendanceRecords[date]) {
              attendanceRecords[date] = {};
            }
            Object.assign(attendanceRecords[date], localRecords[date]);
          }
        }
      } catch (error) {
        console.error('Error loading attendance records from localStorage:', error);
        if (Object.keys(attendanceRecords).length === 0) {
          attendanceRecords = {};
        }
      }
      
      renderAttendanceStatus();
      calculateMonthlyStats();
    }

    // 出退勤ステータスを表示
    function renderAttendanceStatus() {
      if (!currentUser) return;
      
      const today = new Date().toISOString().split('T')[0];
      const todayRecord = attendanceRecords[today]?.[currentUser.id];
      
      const statusIndicator = document.getElementById('status-indicator');
      const statusLabel = document.getElementById('status-label');
      const statusTime = document.getElementById('status-time');
      const toggleBtn = document.getElementById('attendance-toggle-btn');
      const toggleBtnText = document.getElementById('toggle-btn-text');
      const breakSection = document.getElementById('break-section');
      
      if (todayRecord && todayRecord.clock_in && !todayRecord.clock_out) {
        // 出勤中
        statusIndicator.className = 'status-indicator working';
        statusLabel.textContent = '出勤中';
        statusTime.textContent = formatTime(todayRecord.clock_in);
        toggleBtnText.textContent = '退勤';
        toggleBtn.classList.remove('btn-clock-in');
        toggleBtn.classList.add('btn-clock-out');
        toggleBtn.querySelector('i').className = 'fas fa-sign-out-alt';
        // 休憩セクションを表示
        if (breakSection) {
          breakSection.style.display = 'block';
        }
        renderBreakSection(todayRecord);
      } else if (todayRecord && todayRecord.clock_out) {
        // 退勤済み
        statusIndicator.className = 'status-indicator';
        statusLabel.textContent = '退勤済み';
        
        // 労働時間を表示
        const workHours = todayRecord.work_hours || calculateWorkHours(todayRecord.clock_in, todayRecord.clock_out, todayRecord.breaks || []);
        statusTime.textContent = workHours ? formatWorkHours(workHours) : '--:--';
        
        toggleBtnText.textContent = '出勤';
        toggleBtn.classList.remove('btn-clock-out');
        toggleBtn.classList.add('btn-clock-in');
        toggleBtn.querySelector('i').className = 'fas fa-sign-in-alt';
        // 休憩セクションを非表示
        if (breakSection) {
          breakSection.style.display = 'none';
        }
      } else {
        // 未出勤
        statusIndicator.className = 'status-indicator';
        statusLabel.textContent = '未出勤';
        statusTime.textContent = '--:--';
        toggleBtnText.textContent = '出勤';
        toggleBtn.classList.remove('btn-clock-out');
        toggleBtn.classList.add('btn-clock-in');
        toggleBtn.querySelector('i').className = 'fas fa-sign-in-alt';
        // 休憩セクションを非表示
        if (breakSection) {
          breakSection.style.display = 'none';
        }
      }
    }

    // 休憩セクションをレンダリング
    function renderBreakSection(record) {
      const breakSection = document.getElementById('break-section');
      const breakTimeDisplay = document.getElementById('break-time-display');
      const breaksList = document.getElementById('breaks-list');
      const breakStartBtn = document.getElementById('break-start-btn');
      const breakEndBtn = document.getElementById('break-end-btn');
      
      if (!breakSection) return;
      
      // 出勤中の場合のみ表示
      if (record && record.clock_in && !record.clock_out) {
        breakSection.style.display = 'block';
        
        // 休憩時間の表示
        const breaks = record.breaks || [];
        const totalBreakTime = record.break_time || calculateTotalBreakTime(breaks);
        
        if (totalBreakTime > 0) {
          const hours = Math.floor(totalBreakTime);
          const minutes = Math.round((totalBreakTime - hours) * 60);
          breakTimeDisplay.textContent = `${hours}時間${minutes}分`;
        } else {
          breakTimeDisplay.textContent = '0分';
        }
        
        // 休憩リストの表示
        if (breaks.length > 0) {
          breaksList.innerHTML = breaks.map((b, index) => {
            const start = b.break_start ? formatTime(b.break_start) : '-';
            const end = b.break_end ? formatTime(b.break_end) : '（休憩中）';
            const duration = b.break_duration ? formatWorkHours(b.break_duration) : '-';
            return `<div style="margin-bottom: 4px;">休憩${index + 1}: ${start} - ${end} (${duration})</div>`;
          }).join('');
        } else {
          breaksList.innerHTML = '<div style="color: #9ca3af;">休憩記録はありません</div>';
        }
        
        // 休憩中かどうかを判定（最後の休憩に終了時刻がない場合）
        const isOnBreak = breaks.length > 0 && breaks[breaks.length - 1] && !breaks[breaks.length - 1].break_end;
        
        if (isOnBreak) {
          // 休憩中
          if (breakStartBtn) breakStartBtn.style.display = 'none';
          if (breakEndBtn) breakEndBtn.style.display = 'block';
        } else {
          // 休憩中でない
          if (breakStartBtn) breakStartBtn.style.display = 'block';
          if (breakEndBtn) breakEndBtn.style.display = 'none';
        }
      } else {
        breakSection.style.display = 'none';
      }
    }

    // 総休憩時間を計算
    function calculateTotalBreakTime(breaks) {
      if (!breaks || !Array.isArray(breaks)) return 0;
      return breaks.reduce((total, b) => {
        if (b.break_duration) {
          return total + b.break_duration;
        } else if (b.break_start && b.break_end) {
          const start = new Date(b.break_start);
          const end = new Date(b.break_end);
          return total + (end - start) / (1000 * 60 * 60);
        }
        return total;
      }, 0);
    }

    // 月間統計を計算
    function calculateMonthlyStats() {
      if (!currentUser) return;
      
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth();
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      
      let workDays = 0;
      let totalHours = 0;
      
      for (let d = new Date(firstDay); d <= lastDay; d.setDate(d.getDate() + 1)) {
        const dateStr = d.toISOString().split('T')[0];
        const record = attendanceRecords[dateStr]?.[currentUser.id];
        
        if (record && record.clock_in && record.clock_out) {
          workDays++;
          // 実労働時間を計算（休憩時間を考慮）
          const hours = calculateWorkHours(record.clock_in, record.clock_out, record.breaks || []);
          totalHours += hours;
        }
      }
      
      document.getElementById('monthly-work-days').textContent = `${workDays}日`;
      document.getElementById('monthly-work-hours').textContent = formatWorkHours(totalHours);
    }

    // 確認ダイアログを表示する関数
    function showConfirmDialog(title, message, confirmText, cancelText) {
      return new Promise((resolve) => {
        // ダイアログのHTMLを作成
        const dialogHTML = `
          <div id="attendance-confirm-dialog" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
          ">
            <div style="
              background: white;
              border-radius: 8px;
              padding: 24px;
              max-width: 400px;
              width: 90%;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            ">
              <h3 style="
                margin: 0 0 16px 0;
                font-size: 1.25rem;
                font-weight: 600;
                color: #1f2937;
              ">${title}</h3>
              <div style="
                margin-bottom: 24px;
                color: #4b5563;
                line-height: 1.6;
                white-space: pre-line;
              ">${message}</div>
              <div style="
                display: flex;
                gap: 12px;
                justify-content: flex-end;
              ">
                <button id="dialog-cancel-btn" style="
                  padding: 8px 16px;
                  border: 1px solid #d1d5db;
                  border-radius: 4px;
                  background: white;
                  color: #374151;
                  cursor: pointer;
                  font-size: 0.875rem;
                ">${cancelText}</button>
                <button id="dialog-confirm-btn" style="
                  padding: 8px 16px;
                  border: none;
                  border-radius: 4px;
                  background: var(--primary, #3b82f6);
                  color: white;
                  cursor: pointer;
                  font-size: 0.875rem;
                  font-weight: 500;
                ">${confirmText}</button>
              </div>
            </div>
          </div>
        `;
        
        // ダイアログをDOMに追加
        document.body.insertAdjacentHTML('beforeend', dialogHTML);
        
        const dialog = document.getElementById('attendance-confirm-dialog');
        const confirmBtn = document.getElementById('dialog-confirm-btn');
        const cancelBtn = document.getElementById('dialog-cancel-btn');
        
        // 確認ボタン
        confirmBtn.addEventListener('click', () => {
          dialog.remove();
          resolve(true);
        });
        
        // キャンセルボタン
        cancelBtn.addEventListener('click', () => {
          dialog.remove();
          resolve(false);
        });
        
        // 背景クリックでキャンセル
        dialog.addEventListener('click', (e) => {
          if (e.target === dialog) {
            dialog.remove();
            resolve(false);
          }
        });
      });
    }

    // エラーメッセージを表示
    function showErrorMessage(message) {
      const errorEl = document.getElementById('error-message');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        errorEl.style.background = '#fee2e2';
        errorEl.style.color = '#991b1b';
        
        // 5秒後に自動的に非表示
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 5000);
      } else {
        alert(message);
      }
    }
    
    // 警告メッセージを表示
    function showWarningMessage(message) {
      const errorEl = document.getElementById('error-message');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        errorEl.style.background = '#fef3c7';
        errorEl.style.color = '#92400e';
        
        // 5秒後に自動的に非表示
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 5000);
      } else {
        alert(message);
      }
    }
    
    // 成功メッセージを表示
    function showSuccessMessage(message) {
      const errorEl = document.getElementById('error-message');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        errorEl.style.background = '#d1fae5';
        errorEl.style.color = '#065f46';
        
        // 3秒後に自動的に非表示
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 3000);
      }
    }

    // 時刻をフォーマット（確認ダイアログ用）
    function formatTimeForDialog(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
    }

    // 勤務時間を計算（旧バージョン - 互換性のため残す）
    function calculateWorkHoursOld(clockIn, clockOut) {
      if (!clockIn || !clockOut) return null;
      const start = new Date(clockIn);
      const end = new Date(clockOut);
      const diff = end - start;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      return { hours, minutes };
    }

    // 労働時間を計算（休憩時間を考慮）
    function calculateWorkHours(clockIn, clockOut, breaks) {
      if (!clockIn || !clockOut) return 0;
      
      const start = new Date(clockIn);
      const end = new Date(clockOut);
      const totalHours = (end - start) / (1000 * 60 * 60);
      
      const breakTime = calculateTotalBreakTime(breaks || []);
      const workHours = Math.max(0, totalHours - breakTime);
      
      return round(workHours, 2);
    }

    // 労働時間をフォーマット
    function formatWorkHours(hours) {
      if (!hours || hours === 0) return '0時間';
      const h = Math.floor(hours);
      const m = Math.round((hours - h) * 60);
      if (m === 0) {
        return `${h}時間`;
      }
      return `${h}時間${m}分`;
    }

    // 数値を丸める
    function round(value, decimals) {
      return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);
    }

    // 時刻の妥当性チェック
    function validateTime(timeString, type = 'clock_in') {
      if (!timeString) return { valid: true };
      
      const time = new Date(timeString);
      const now = new Date();
      
      // 未来時刻のチェック（5分の許容範囲を設ける）
      const futureLimit = new Date(now.getTime() + 5 * 60 * 1000); // 5分後
      if (time > futureLimit) {
        return {
          valid: false,
          message: `${type === 'clock_in' ? '出勤' : '退勤'}時刻が未来の時刻です`
        };
      }
      
      // 過去の時刻チェック（1日前より前はエラー）
      const oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
      if (time < oneDayAgo) {
        return {
          valid: false,
          message: `${type === 'clock_in' ? '出勤' : '退勤'}時刻が過去すぎます（24時間以内の時刻を指定してください）`
        };
      }
      
      return { valid: true };
    }
    
    // 出退勤時刻の整合性チェック
    function validateAttendanceTimes(clockIn, clockOut) {
      if (!clockIn || !clockOut) return { valid: true };
      
      const inTime = new Date(clockIn);
      const outTime = new Date(clockOut);
      
      // 退勤時刻が出勤時刻より前の場合はエラー
      if (outTime <= inTime) {
        return {
          valid: false,
          message: '退勤時刻が出勤時刻より前です'
        };
      }
      
      // 勤務時間が24時間を超える場合は警告
      const workHours = (outTime - inTime) / (1000 * 60 * 60);
      if (workHours > 24) {
        return {
          valid: false,
          message: '勤務時間が24時間を超えています。時刻を確認してください'
        };
      }
      
      return { valid: true };
    }

    // 出退勤トグルボタンのセットアップ
    function setupAttendanceToggleButton() {
      const toggleBtn = document.getElementById('attendance-toggle-btn');
      if (!toggleBtn) {
        console.error('Attendance toggle button not found!');
        console.error('Available elements:', {
          mypageContent: document.getElementById('mypage-content'),
          attendanceCard: document.querySelector('.attendance-card'),
          attendanceToday: document.querySelector('.attendance-today')
        });
        return;
      }
      
      console.log('Setting up attendance toggle button:', toggleBtn);
      
      // 既存のイベントリスナーを削除（重複防止）
      const newToggleBtn = toggleBtn.cloneNode(true);
      toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
      
      newToggleBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      
      const today = new Date().toISOString().split('T')[0];
      const now = new Date().toISOString();
      
      if (!attendanceRecords[today]) {
        attendanceRecords[today] = {};
      }
      
      const todayRecord = attendanceRecords[today][currentUser.id] || {};
      let attendanceData = {};
      let shouldProceed = false;
      
      if (!todayRecord.clock_in) {
        // 出勤
        // 1日1回制限チェックは既に!todayRecord.clock_inで確認済み
        
        // 時刻の妥当性チェック
        const timeValidation = validateTime(now, 'clock_in');
        if (!timeValidation.valid) {
          showErrorMessage(timeValidation.message);
          return;
        }
        
        // 確認ダイアログを表示
        const currentTime = formatTimeForDialog(now);
        const message = `現在時刻: ${currentTime}\n\n出勤を記録しますか？`;
        shouldProceed = await showConfirmDialog('出勤を記録しますか？', message, '出勤する', 'キャンセル');
        
        if (!shouldProceed) {
          return;
        }
        
        attendanceData = {
          staff_id: currentUser.id,
          staff_name: currentUser.name,
          date: today,
          clock_in: now
        };
        attendanceRecords[today][currentUser.id] = {
          ...todayRecord,
          clock_in: now,
          staff_id: currentUser.id,
          staff_name: currentUser.name
        };
        
        // 出勤記録後、作業開始ボタンを表示
        setTimeout(() => {
          renderAttendanceStatus();
        }, 100);
      } else if (!todayRecord.clock_out) {
        // 退勤
        // 1日1回制限チェックは既に!todayRecord.clock_outで確認済み
        
        // 時刻の妥当性チェック
        const timeValidation = validateTime(now, 'clock_out');
        if (!timeValidation.valid) {
          showErrorMessage(timeValidation.message);
          return;
        }
        
        // 出退勤時刻の整合性チェック
        const consistencyValidation = validateAttendanceTimes(todayRecord.clock_in, now);
        if (!consistencyValidation.valid) {
          showErrorMessage(consistencyValidation.message);
          return;
        }
        
        // 確認ダイアログを表示
        const clockInTime = formatTimeForDialog(todayRecord.clock_in);
        const currentTime = formatTimeForDialog(now);
        const breaks = todayRecord.breaks || [];
        const workHours = calculateWorkHours(todayRecord.clock_in, now, breaks);
        const workHoursText = formatWorkHours(workHours);
        
        const message = `出勤時刻: ${clockInTime}\n現在時刻: ${currentTime}\n実労働時間: ${workHoursText}\n\n退勤を記録しますか？`;
        shouldProceed = await showConfirmDialog('退勤を記録しますか？', message, '退勤する', 'キャンセル');
        
        if (!shouldProceed) {
          return;
        }
        
        attendanceData = {
          staff_id: currentUser.id,
          staff_name: currentUser.name,
          date: today,
          clock_in: todayRecord.clock_in,
          clock_out: now
        };
        attendanceRecords[today][currentUser.id] = {
          ...todayRecord,
          clock_out: now
        };
      } else {
        // 再出勤（1日1回制限の例外：退勤後の再出勤は別記録として扱う）
        // 時刻の妥当性チェック
        const timeValidation = validateTime(now, 'clock_in');
        if (!timeValidation.valid) {
          showErrorMessage(timeValidation.message);
          return;
        }
        
        // 確認ダイアログを表示
        const currentTime = formatTimeForDialog(now);
        const message = `現在時刻: ${currentTime}\n\n再出勤を記録しますか？\n（退勤後の再出勤は別記録として扱われます）`;
        shouldProceed = await showConfirmDialog('再出勤を記録しますか？', message, '再出勤する', 'キャンセル');
        
        if (!shouldProceed) {
          return;
        }
        
        attendanceData = {
          staff_id: currentUser.id,
          staff_name: currentUser.name,
          date: today,
          clock_in: now,
          breaks: []
        };
        attendanceRecords[today][currentUser.id] = {
          clock_in: now,
          staff_id: currentUser.id,
          staff_name: currentUser.name,
          breaks: []
        };
      }
      
      try {
        // APIに保存
        const response = await fetch(`${API_BASE}/attendance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(attendanceData)
        });
        
        if (response.ok) {
          const result = await response.json();
          // 成功メッセージを表示（オプション）
          showSuccessMessage('出退勤記録を保存しました');
          
          // ローカルストレージにも保存（オフライン対応）
          localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
          renderAttendanceStatus();
          calculateMonthlyStats();
          renderCalendar();
        } else {
          // エラーレスポンスを解析
          let errorMessage = '出退勤記録の保存に失敗しました';
          let errorCode = 'UNKNOWN_ERROR';
          
          try {
            const errorData = await response.json();
            errorMessage = errorData.error || errorMessage;
            errorCode = errorData.code || errorCode;
            
            // エラーコードに応じた処理
            if (errorCode === 'VALIDATION_ERROR') {
              // バリデーションエラーの場合
              showErrorMessage(`入力エラー: ${errorMessage}`);
              
              // ローカルストレージには保存しない（不正なデータのため）
              return;
            } else if (errorCode === 'DUPLICATE_RECORD') {
              // 重複記録エラーの場合
              showErrorMessage(`記録エラー: ${errorMessage}`);
              
              // 既存の記録を再読み込み
              await loadAttendanceRecords();
              renderAttendanceStatus();
              return;
            }
          } catch (parseError) {
            // JSON解析に失敗した場合
            errorMessage = `サーバーエラー (${response.status}): ${response.statusText}`;
          }
          
          // ネットワークエラー以外の場合は、ローカルストレージに保存を試みる
          if (response.status >= 500) {
            // サーバーエラーの場合はローカルストレージに保存
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            renderAttendanceStatus();
            calculateMonthlyStats();
            renderCalendar();
            showWarningMessage('APIへの保存に失敗しましたが、ローカルストレージに保存しました。後で同期してください。');
          } else {
            // クライアントエラー（400番台）の場合は保存しない
            showErrorMessage(errorMessage);
          }
        }
      } catch (error) {
        // ネットワークエラーなどの例外
        console.error('Error saving attendance:', error);
        
        // ネットワークエラーの場合はローカルストレージに保存
        try {
          localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
          renderAttendanceStatus();
          calculateMonthlyStats();
          renderCalendar();
          showWarningMessage('ネットワークエラーが発生しましたが、ローカルストレージに保存しました。接続が復旧したら自動的に同期されます。');
        } catch (localError) {
          console.error('Error saving to local storage:', localError);
          showErrorMessage('出退勤記録の保存に失敗しました。ページを再読み込みして再試行してください。');
        }
      }
      });
    }

    // 週間スケジュールを読み込み
    async function loadWeeklySchedule() {
      if (!currentUser) return;
      
      try {
        // TODO: APIからスケジュールを取得
        const scheduleEl = document.getElementById('weekly-schedule');
        scheduleEl.innerHTML = '<div class="empty-state">今週の予定はありません</div>';
      } catch (error) {
        console.error('Error loading schedule:', error);
      }
    }


    // カレンダーを表示
    function renderCalendar() {
      const year = currentCalendarDate.getFullYear();
      const month = currentCalendarDate.getMonth();
      
      document.getElementById('calendar-title').textContent = `${year} ${month + 1}`;
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - startDate.getDay());
      
      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      
      // 曜日ヘッダー
      const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
      dayNames.forEach(day => {
        const cell = document.createElement('div');
        cell.className = 'calendar-cell calendar-day-name';
        cell.textContent = day;
        grid.appendChild(cell);
      });
      
      // 日付セル
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      for (let i = 0; i < 42; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        
        const cell = document.createElement('div');
        cell.className = 'calendar-cell calendar-date';
        
        if (date.getMonth() !== month) {
          cell.classList.add('disabled');
        } else {
          if (date.getTime() === today.getTime()) {
            cell.classList.add('today');
          }
          
          // 出退勤記録があるかチェック
          if (currentUser && attendanceRecords[dateStr]?.[currentUser.id]) {
            cell.classList.add('has-attendance');
          }
        }
        
        cell.textContent = date.getDate();
        grid.appendChild(cell);
      }
    }

    // カレンダーナビゲーション
    document.getElementById('calendar-prev').addEventListener('click', (e) => {
      e.preventDefault();
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
      renderCalendar();
    });

    document.getElementById('calendar-next').addEventListener('click', (e) => {
      e.preventDefault();
      currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
      renderCalendar();
    });

    // 修正申請ボタンの設定
    function setupCorrectionRequestButton() {
      const btn = document.getElementById('request-correction-btn');
      if (btn) {
        btn.addEventListener('click', () => {
          openCorrectionRequestModal();
        });
      }
    }

    // 修正申請モーダルを開く
    function openCorrectionRequestModal() {
      if (!currentUser) return;
      
      const today = new Date().toISOString().split('T')[0];
      const todayRecord = attendanceRecords[today]?.[currentUser.id] || {};
      
      // モーダルHTMLを作成
      const modalHTML = `
        <div id="correction-request-modal" style="
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        ">
          <div style="
            background: white;
            border-radius: 8px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          ">
            <div style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 20px;
            ">
              <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600;">打刻修正を申請</h2>
              <button id="close-correction-modal" style="
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: #6b7280;
                padding: 0;
                width: 32px;
                height: 32px;
                display: flex;
                align-items: center;
                justify-content: center;
              ">×</button>
            </div>
            
            <form id="correction-request-form">
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">修正する日付</label>
                <input type="date" id="correction-date" value="${today}" required style="
                  width: 100%;
                  padding: 8px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 6px;
                  font-size: 0.875rem;
                ">
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">現在の出勤時刻</label>
                <input type="datetime-local" id="current-clock-in" value="${todayRecord.clock_in ? new Date(todayRecord.clock_in).toISOString().slice(0, 16) : ''}" style="
                  width: 100%;
                  padding: 8px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 6px;
                  font-size: 0.875rem;
                ">
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">修正後の出勤時刻</label>
                <input type="datetime-local" id="requested-clock-in" required style="
                  width: 100%;
                  padding: 8px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 6px;
                  font-size: 0.875rem;
                ">
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">現在の退勤時刻</label>
                <input type="datetime-local" id="current-clock-out" value="${todayRecord.clock_out ? new Date(todayRecord.clock_out).toISOString().slice(0, 16) : ''}" style="
                  width: 100%;
                  padding: 8px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 6px;
                  font-size: 0.875rem;
                ">
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">修正後の退勤時刻</label>
                <input type="datetime-local" id="requested-clock-out" style="
                  width: 100%;
                  padding: 8px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 6px;
                  font-size: 0.875rem;
                ">
              </div>
              
              <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500;">修正理由 <span style="color: #dc2626;">*</span></label>
                <textarea id="correction-reason" required placeholder="修正理由を入力してください" style="
                  width: 100%;
                  padding: 8px 12px;
                  border: 1px solid #d1d5db;
                  border-radius: 6px;
                  font-size: 0.875rem;
                  min-height: 100px;
                  resize: vertical;
                  font-family: inherit;
                "></textarea>
              </div>
              
              <div style="display: flex; gap: 12px; justify-content: flex-end;">
                <button type="button" id="cancel-correction-btn" style="
                  padding: 8px 16px;
                  border: 1px solid #d1d5db;
                  border-radius: 4px;
                  background: white;
                  color: #374151;
                  cursor: pointer;
                  font-size: 0.875rem;
                ">キャンセル</button>
                <button type="submit" style="
                  padding: 8px 16px;
                  border: none;
                  border-radius: 4px;
                  background: var(--primary, #3b82f6);
                  color: white;
                  cursor: pointer;
                  font-size: 0.875rem;
                  font-weight: 500;
                ">申請する</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.body.insertAdjacentHTML('beforeend', modalHTML);
      
      const modal = document.getElementById('correction-request-modal');
      const form = document.getElementById('correction-request-form');
      const closeBtn = document.getElementById('close-correction-modal');
      const cancelBtn = document.getElementById('cancel-correction-btn');
      
      // 閉じるボタン
      closeBtn.addEventListener('click', () => modal.remove());
      cancelBtn.addEventListener('click', () => modal.remove());
      
      // 背景クリックで閉じる
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      // フォーム送信
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        await submitCorrectionRequest();
      });
    }

    // 修正申請を送信
    async function submitCorrectionRequest() {
      if (!currentUser) return;
      
      const date = document.getElementById('correction-date').value;
      const currentClockIn = document.getElementById('current-clock-in').value;
      const requestedClockIn = document.getElementById('requested-clock-in').value;
      const currentClockOut = document.getElementById('current-clock-out').value;
      const requestedClockOut = document.getElementById('requested-clock-out').value;
      const reason = document.getElementById('correction-reason').value.trim();
      
      if (!reason) {
        alert('修正理由を入力してください');
        return;
      }
      
      // 日付からattendance_idを生成
      const attendance_id = `${date}_${currentUser.id}`;
      
      // 時刻をISO形式に変換
      const formatDateTime = (dateTimeStr) => {
        if (!dateTimeStr) return null;
        return new Date(dateTimeStr).toISOString();
      };
      
      const requestData = {
        staff_id: currentUser.id,
        staff_name: currentUser.name,
        attendance_id: attendance_id,
        date: date,
        reason: reason,
        current_clock_in: formatDateTime(currentClockIn),
        current_clock_out: formatDateTime(currentClockOut),
        requested_clock_in: formatDateTime(requestedClockIn),
        requested_clock_out: formatDateTime(requestedClockOut)
      };
      
      try {
        const response = await fetch(`${API_BASE}/attendance/requests`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
          const result = await response.json();
          showSuccessMessage('修正申請を送信しました');
          document.getElementById('correction-request-modal').remove();
        } else {
          const errorData = await response.json().catch(() => ({}));
          showErrorMessage(errorData.error || '修正申請の送信に失敗しました');
        }
      } catch (error) {
        console.error('Error submitting correction request:', error);
        showErrorMessage('修正申請の送信に失敗しました');
      }
    }

    // 休憩開始ボタンの設定
    function setupBreakButtons() {
      const breakStartBtn = document.getElementById('break-start-btn');
      const breakEndBtn = document.getElementById('break-end-btn');
      
      if (breakStartBtn) {
        breakStartBtn.addEventListener('click', async () => {
          await startBreak();
        });
      }
      
      if (breakEndBtn) {
        breakEndBtn.addEventListener('click', async () => {
          await endBreak();
        });
      }
    }

    // 休憩開始
    async function startBreak() {
      if (!currentUser) return;
      
      const today = new Date().toISOString().split('T')[0];
      const now = new Date().toISOString();
      
      if (!attendanceRecords[today]) {
        attendanceRecords[today] = {};
      }
      
      const todayRecord = attendanceRecords[today][currentUser.id] || {};
      
      if (!todayRecord.clock_in) {
        showErrorMessage('出勤記録がありません。先に出勤してください。');
        return;
      }
      
      if (todayRecord.clock_out) {
        showErrorMessage('既に退勤しています。');
        return;
      }
      
      // 確認ダイアログ
      const currentTime = formatTimeForDialog(now);
      const message = `現在時刻: ${currentTime}\n\n休憩を開始しますか？`;
      const shouldProceed = await showConfirmDialog('休憩を開始しますか？', message, '休憩開始', 'キャンセル');
      
      if (!shouldProceed) return;
      
      // 既存の休憩配列を取得
      const breaks = todayRecord.breaks || [];
      
      // 新しい休憩を追加（終了時刻は後で設定）
      const newBreak = {
        break_start: now,
        break_end: null,
        break_duration: 0
      };
      breaks.push(newBreak);
      
      // データを更新
      const attendanceData = {
        staff_id: currentUser.id,
        staff_name: currentUser.name,
        date: today,
        clock_in: todayRecord.clock_in,
        clock_out: todayRecord.clock_out,
        breaks: breaks
      };
      
      try {
        const response = await fetch(`${API_BASE}/attendance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(attendanceData)
        });
        
        if (response.ok) {
          showSuccessMessage('休憩を開始しました');
          // ローカルストレージを更新
          attendanceRecords[today][currentUser.id] = {
            ...todayRecord,
            breaks: breaks
          };
          localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
          renderAttendanceStatus();
        } else {
          const errorData = await response.json().catch(() => ({}));
          showErrorMessage(errorData.error || '休憩開始の記録に失敗しました');
        }
      } catch (error) {
        console.error('Error starting break:', error);
        showErrorMessage('休憩開始の記録に失敗しました');
      }
    }

    // 休憩終了
    async function endBreak() {
      if (!currentUser) return;
      
      const today = new Date().toISOString().split('T')[0];
      const now = new Date().toISOString();
      
      if (!attendanceRecords[today]) {
        attendanceRecords[today] = {};
      }
      
      const todayRecord = attendanceRecords[today][currentUser.id] || {};
      
      const breaks = todayRecord.breaks || [];
      if (breaks.length === 0) {
        showErrorMessage('休憩記録がありません。');
        return;
      }
      
      // 最後の休憩を取得
      const lastBreak = breaks[breaks.length - 1];
      if (!lastBreak.break_start) {
        showErrorMessage('休憩開始記録がありません。');
        return;
      }
      
      if (lastBreak.break_end) {
        showErrorMessage('既に休憩を終了しています。');
        return;
      }
      
      // 確認ダイアログ
      const breakStartTime = formatTimeForDialog(lastBreak.break_start);
      const currentTime = formatTimeForDialog(now);
      const breakDuration = calculateBreakDuration(lastBreak.break_start, now);
      const message = `休憩開始: ${breakStartTime}\n現在時刻: ${currentTime}\n休憩時間: ${breakDuration}\n\n休憩を終了しますか？`;
      const shouldProceed = await showConfirmDialog('休憩を終了しますか？', message, '休憩終了', 'キャンセル');
      
      if (!shouldProceed) return;
      
      // 休憩終了時刻を設定
      const breakStartDt = new Date(lastBreak.break_start);
      const breakEndDt = new Date(now);
      const breakDurationHours = (breakEndDt - breakStartDt) / (1000 * 60 * 60);
      
      breaks[breaks.length - 1] = {
        ...lastBreak,
        break_end: now,
        break_duration: round(breakDurationHours, 2)
      };
      
      // データを更新
      const attendanceData = {
        staff_id: currentUser.id,
        staff_name: currentUser.name,
        date: today,
        clock_in: todayRecord.clock_in,
        clock_out: todayRecord.clock_out,
        breaks: breaks
      };
      
      try {
        const response = await fetch(`${API_BASE}/attendance`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(attendanceData)
        });
        
        if (response.ok) {
          showSuccessMessage('休憩を終了しました');
          // ローカルストレージを更新
          attendanceRecords[today][currentUser.id] = {
            ...todayRecord,
            breaks: breaks
          };
          localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
          renderAttendanceStatus();
        } else {
          const errorData = await response.json().catch(() => ({}));
          showErrorMessage(errorData.error || '休憩終了の記録に失敗しました');
        }
      } catch (error) {
        console.error('Error ending break:', error);
        showErrorMessage('休憩終了の記録に失敗しました');
      }
    }

    // 休憩時間を計算（表示用）
    function calculateBreakDuration(startTime, endTime) {
      const start = new Date(startTime);
      const end = new Date(endTime);
      const diff = (end - start) / (1000 * 60); // 分
      const hours = Math.floor(diff / 60);
      const minutes = Math.round(diff % 60);
      return `${hours}時間${minutes}分`;
    }

    // 数値を丸める
    function round(value, decimals) {
      return Math.round(value * Math.pow(10, decimals)) / Math.pow(10, decimals);
    }

    // ==================== TODOリスト機能 ====================
    const TODO_STORAGE_KEY = 'staff_todos';
    let todos = [];
    let todoFilter = 'all';

    function loadTodos() {
      try {
        const userId = currentUser?.id || 'default';
        const stored = localStorage.getItem(`${TODO_STORAGE_KEY}_${userId}`);
        if (stored) {
          todos = JSON.parse(stored);
        } else {
          todos = [];
        }
      } catch (error) {
        console.error('Error loading todos:', error);
        todos = [];
      }
      renderTodos();
    }

    function saveTodos() {
      try {
        const userId = currentUser?.id || 'default';
        localStorage.setItem(`${TODO_STORAGE_KEY}_${userId}`, JSON.stringify(todos));
      } catch (error) {
        console.error('Error saving todos:', error);
      }
    }

    function addTodo(text) {
      if (!text.trim()) return;
      
      const todo = {
        id: `todo_${Date.now()}`,
        text: text.trim(),
        completed: false,
        created_at: new Date().toISOString()
      };
      
      todos.unshift(todo);
      saveTodos();
      renderTodos();
    }

    function toggleTodo(id) {
      const todo = todos.find(t => t.id === id);
      if (todo) {
        todo.completed = !todo.completed;
        saveTodos();
        renderTodos();
      }
    }

    function deleteTodo(id) {
      todos = todos.filter(t => t.id !== id);
      saveTodos();
      renderTodos();
    }

    function updateTodoText(id, newText) {
      const todo = todos.find(t => t.id === id);
      if (todo && newText.trim()) {
        todo.text = newText.trim();
        saveTodos();
      }
    }

    function renderTodos() {
      const listEl = document.getElementById('todo-list');
      const countEl = document.getElementById('todo-count');
      
      if (!listEl || !countEl) return;

      // フィルタリング
      let filteredTodos = todos;
      if (todoFilter === 'active') {
        filteredTodos = todos.filter(t => !t.completed);
      } else if (todoFilter === 'completed') {
        filteredTodos = todos.filter(t => t.completed);
      }

      // 未完了カウントを更新
      const activeCount = todos.filter(t => !t.completed).length;
      countEl.textContent = activeCount;

      if (filteredTodos.length === 0) {
        const message = todoFilter === 'all' ? 'タスクがありません' :
                        todoFilter === 'active' ? '未完了のタスクはありません' :
                        '完了したタスクはありません';
        listEl.innerHTML = `<div class="todo-empty"><i class="fas fa-check-circle"></i> ${message}</div>`;
        return;
      }

      let html = '';
      filteredTodos.forEach(todo => {
        html += `
          <div class="todo-item ${todo.completed ? 'completed' : ''}" data-id="${todo.id}">
            <div class="todo-checkbox" onclick="toggleTodo('${todo.id}')">
              ${todo.completed ? '<i class="fas fa-check"></i>' : ''}
            </div>
            <input type="text" class="todo-text-input" value="${escapeHtml(todo.text)}" 
                   onblur="updateTodoText('${todo.id}', this.value)"
                   onkeypress="if(event.key==='Enter') this.blur()">
            <button class="todo-delete" onclick="deleteTodo('${todo.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
      });

      listEl.innerHTML = html;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function setupTodoListeners() {
      const input = document.getElementById('todo-input');
      const addBtn = document.getElementById('add-todo-btn');
      const filters = document.getElementById('todo-filters');

      if (input && addBtn) {
        addBtn.addEventListener('click', () => {
          addTodo(input.value);
          input.value = '';
          input.focus();
        });

        input.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            addTodo(input.value);
            input.value = '';
          }
        });
      }

      if (filters) {
        filters.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            todoFilter = btn.dataset.filter;
            filters.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderTodos();
          });
        });
      }
    }

    // 初期化
    document.addEventListener('DOMContentLoaded', () => {
      loadCurrentUser();
      setupAttendanceToggleButton();
      setupCorrectionRequestButton();
      setupBreakButtons();
      setupTodoListeners();
      
      // ユーザー読み込み後にTODOを読み込む
      const originalLoadCurrentUser = loadCurrentUser;
      const checkAndLoadTodos = setInterval(() => {
        if (currentUser) {
          loadTodos();
          clearInterval(checkAndLoadTodos);
        }
      }, 500);
      
      // 5秒後にタイムアウト
      setTimeout(() => {
        clearInterval(checkAndLoadTodos);
        if (!currentUser) {
          loadTodos(); // ユーザーがなくてもデフォルトで読み込む
        }
      }, 5000);
    });
  </script>
</main>

