# サービスアカウントキー作成が無効な場合の対処方法

## 問題

Google Cloud Consoleでサービスアカウントのキーを作成しようとした際、「キーの作成無効状態」というエラーが表示される場合があります。

## 原因

組織ポリシー（Organization Policy）でサービスアカウントキーの作成が制限されている可能性があります。

## 解決方法

### 方法1: 既存のサービスアカウントを確認する

既に作成済みのサービスアカウントがある場合、そのキーを使用できます。

1. **Google Cloud Console**を開く
2. 「IAMと管理」→「サービスアカウント」を選択
3. 既存のサービスアカウント一覧を確認
4. 既存のサービスアカウントがある場合：
   - そのサービスアカウントをクリック
   - 「キー」タブを確認
   - 既存のキーがある場合は、そのキーをダウンロードして使用

### 方法2: 組織管理者に依頼する

組織ポリシーでキー作成が制限されている場合、組織管理者に以下の依頼を行ってください：

1. **組織ポリシーの確認**
   - 「IAMと管理」→「組織ポリシー」を開く
   - `constraints/iam.disableServiceAccountKeyCreation` を検索
   - このポリシーが有効になっている場合、特定のプロジェクトまたはサービスアカウントに対して例外を設定する必要があります

2. **例外の設定**
   - 組織管理者に、このプロジェクトまたはサービスアカウントに対してキー作成を許可するよう依頼

### 方法3: OAuth 2.0を使用する（代替案）

サービスアカウントが使用できない場合、OAuth 2.0を使用してユーザー認証でカレンダーにアクセスする方法があります。

**メリット:**
- 組織ポリシーの制限を受けない
- ユーザーの個人カレンダーに直接アクセス可能

**デメリット:**
- ユーザー認証が必要（初回のみ）
- トークンのリフレッシュが必要
- 実装がやや複雑

**実装方法:**
1. OAuth 2.0認証情報を作成
2. 認証フローを実装（Lambda関数または別のサービスで）
3. リフレッシュトークンを安全に保存（AWS Secrets Manager推奨）

### 方法4: 既存のサービスアカウントキーを共有してもらう

他のプロジェクトやチームメンバーが既にサービスアカウントキーを持っている場合、そのキーを共有してもらう方法もあります。

**注意**: セキュリティ上の理由から、キーの共有は慎重に行ってください。

---

## 推奨される手順

1. **まず既存のサービスアカウントを確認**
   - Google Cloud Consoleで既存のサービスアカウントとキーを確認

2. **既存のキーがない場合**
   - 組織管理者に連絡して、キー作成の許可を依頼
   - または、OAuth 2.0の実装を検討

3. **既存のキーがある場合**
   - そのキーを使用して、カレンダー共有設定を進める

---

## 次のステップ

キーが取得できたら、以下の手順を進めてください：

1. **カレンダーの共有設定**
   - Googleカレンダーを開く
   - カレンダー設定→「特定のユーザーと共有」
   - サービスアカウントのメールアドレス（JSONファイルの`client_email`）を追加
   - 権限: 「変更イベントの管理」

2. **Lambda関数への設定**
   - 方法A: 環境変数`GOOGLE_SERVICE_ACCOUNT_JSON`に設定（開発・テスト用）
   - 方法B: AWS Secrets Managerに保存して`GOOGLE_SERVICE_ACCOUNT_SECRET_NAME`に設定（本番環境推奨）

詳細は `docs/GOOGLE_CALENDAR_AUTH_SETUP.md` を参照してください。

