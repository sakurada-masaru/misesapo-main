# AWS Lambda + API Gateway セットアップ手順（画面付き）

このガイドでは、AWS Consoleの画面を見ながら、実際に操作する手順を詳しく説明します。

## 📋 事前準備

### 1. AWSアカウントにログイン

1. ブラウザで **https://console.aws.amazon.com/** を開く
2. AWSアカウントでログイン
3. 右上のリージョンが **「アジアパシフィック (東京) ap-northeast-1」** になっているか確認
   - 違う場合は、リージョンをクリックして変更

### 2. S3バケットの確認

1. 画面上部の検索バーに「**S3**」と入力
2. **「S3」** をクリック
3. バケット一覧に `misesapo-cleaning-manual-images` があるか確認
   - ない場合は、`docs/AWS_S3_SETUP_STEP_BY_STEP.md` を参照して作成

---

## 🚀 ステップ1: Lambda関数を作成

### 1-1. Lambda関数の作成画面を開く

1. 画面上部の検索バーに「**Lambda**」と入力
2. **「Lambda」** をクリック
3. 左側のメニューから **「関数」** をクリック（既に開いている場合はスキップ）
4. **「関数の作成」** ボタンをクリック（画面右上または中央）

### 1-2. 基本設定

1. **「一から作成」** を選択（デフォルトで選択されているはず）
2. **基本情報** セクション:
   - **関数名**: `misesapo-s3-upload` と入力
   - **ランタイム**: `Python 3.11` を選択（ドロップダウンから）
   - **アーキテクチャ**: `x86_64` を選択（デフォルト）
3. **「関数の作成」** ボタンをクリック（画面右下）

### 1-3. Lambda関数のコードを設定

1. 関数が作成されると、コードエディタが表示されます
2. デフォルトのコード（`lambda_function.py` の内容）をすべて削除
3. プロジェクトの `lambda_function.py` ファイルを開く
4. 内容をすべてコピー
5. Lambda関数のコードエディタに貼り付け
6. **「Deploy」** ボタンをクリック（画面右上）

### 1-4. 環境変数の設定

1. 関数の設定画面で、**「設定」** タブをクリック（画面上部）
2. 左側のメニューから **「環境変数」** をクリック
3. **「環境変数を編集」** ボタンをクリック
4. **「環境変数を追加」** をクリック
5. 以下の環境変数を追加（3つ追加）:

   **1つ目:**
   - **キー**: `S3_BUCKET_NAME`
   - **値**: `misesapo-cleaning-manual-images`
   - **「環境変数を追加」** をクリック

   **2つ目:**
   - **キー**: `S3_REGION`
   - **値**: `ap-northeast-1`
   - **「環境変数を追加」** をクリック

   **3つ目:**
   - **キー**: `ALLOWED_ORIGINS`
   - **値**: `*`
   - **「環境変数を追加」** をクリック

6. **「保存」** ボタンをクリック

### 1-5. IAMロールの権限設定

1. 関数の設定画面で、**「設定」** タブをクリック
2. 左側のメニューから **「アクセス権限」** をクリック
3. **「ロール名」** のリンクをクリック（例: `misesapo-s3-upload-role-xxxxx`）
   - 新しいタブでIAMコンソールが開きます
4. **「許可を追加」** → **「ポリシーをアタッチ」** をクリック
5. 検索バーに「**S3**」と入力
6. **「AmazonS3FullAccess」** を検索して、チェックボックスに☑を入れる
7. **「ポリシーをアタッチ」** ボタンをクリック（画面下部）

---

## 🚀 ステップ2: API GatewayでREST APIを作成

### 2-1. API Gatewayの画面を開く

1. 画面上部の検索バーに「**API Gateway**」と入力
2. **「API Gateway」** をクリック
3. **「API を作成」** ボタンをクリック（画面右上または中央）

### 2-2. REST APIの作成

1. **「REST API」** のカードをクリック
2. **「構築」** ボタンをクリック
3. **「新しいAPI」** を選択（デフォルト）
4. **API名**: `misesapo-s3-upload-api` と入力
5. **「API の作成」** ボタンをクリック

### 2-3. リソースの作成

1. 左側のメニューで **「/」** が選択されていることを確認
2. **「アクション」** ドロップダウンメニューをクリック（画面左上）
3. **「リソースの作成」** をクリック
4. **リソース名**: `upload` と入力
5. **「リソースの作成」** ボタンをクリック

### 2-4. POSTメソッドの作成

1. 左側のメニューで **「/upload」** が選択されていることを確認
2. **「アクション」** ドロップダウンメニューをクリック
3. **「メソッドの作成」** をクリック
4. メソッドのドロップダウンから **「POST」** を選択
5. チェックマーク（✓）をクリック
6. **統合タイプ**: `Lambda関数` を選択
7. **Lambda プロキシ統合を使用**: ☑チェックを**外す**（重要！）
8. **Lambda リージョン**: `ap-northeast-1` を選択
9. **Lambda関数**: `misesapo-s3-upload` と入力（自動補完される）
10. **「保存」** ボタンをクリック
11. **「Lambda関数に権限を追加」** のダイアログで **「OK」** をクリック

### 2-5. OPTIONSメソッドの作成（CORS用）

1. 左側のメニューで **「/upload」** が選択されていることを確認
2. **「アクション」** ドロップダウンメニューをクリック
3. **「メソッドの作成」** をクリック
4. メソッドのドロップダウンから **「OPTIONS」** を選択
5. チェックマーク（✓）をクリック
6. **統合タイプ**: `MOCK` を選択
7. **「保存」** ボタンをクリック

### 2-6. OPTIONSメソッドの統合レスポンスを設定

1. **「OPTIONS」** メソッドをクリック
2. **「統合レスポンス」** をクリック（画面中央）
3. **「200」** のステータスコードをクリック
4. **「ヘッダーのマッピング」** セクションで **「ヘッダーを追加」** をクリック
5. 以下の3つのヘッダーを追加:

   **1つ目:**
   - **名前**: `Access-Control-Allow-Origin`
   - **マッピング**: `'*'`（シングルクォートを含む）
   - **「ヘッダーを追加」** をクリック

   **2つ目:**
   - **名前**: `Access-Control-Allow-Headers`
   - **マッピング**: `'Content-Type'`
   - **「ヘッダーを追加」** をクリック

   **3つ目:**
   - **名前**: `Access-Control-Allow-Methods`
   - **マッピング**: `'POST, OPTIONS'`
   - **「ヘッダーを追加」** をクリック

6. **「保存」** ボタンをクリック

### 2-7. CORSの有効化

1. 左側のメニューで **「/upload」** が選択されていることを確認
2. **「アクション」** ドロップダウンメニューをクリック
3. **「CORS を有効にする」** をクリック
4. **「アクセス制御を許可するオリジン」**: `*` と入力
5. **「アクセス制御を許可するヘッダー」**: `Content-Type` と入力
6. **「アクセス制御を許可するメソッド」**: 
   - ☑ `POST` にチェック
   - ☑ `OPTIONS` にチェック
7. **「CORS を有効にして既存の CORS ヘッダーを置き換える」** ボタンをクリック
8. **「はい、既存の値を置き換えます」** をクリック

### 2-8. APIのデプロイ

1. 左側のメニューで **「/upload」** が選択されていることを確認
2. **「アクション」** ドロップダウンメニューをクリック
3. **「API のデプロイ」** をクリック
4. **デプロイされるステージ**: `[新しいステージ]` を選択
5. **ステージ名**: `prod` と入力
6. **「デプロイ」** ボタンをクリック
7. **「呼び出しURL」** をコピー（例: `https://xxxxxxxxxx.execute-api.ap-northeast-1.amazonaws.com/prod`）
   - このURLは後で使うので、メモ帳などに保存しておいてください

---

## 🚀 ステップ3: クライアント側のコードを更新

### 3-1. エンドポイントURLを設定

1. プロジェクトの `src/assets/js/aws-s3-upload.js` を開く
2. 17行目を編集:

```javascript
// 変更前:
let API_GATEWAY_ENDPOINT = null; // TODO: API GatewayのエンドポイントURLを設定してください

// 変更後（コピーしたURLに置き換え）:
let API_GATEWAY_ENDPOINT = 'https://xxxxxxxxxx.execute-api.ap-northeast-1.amazonaws.com/prod';
```

### 3-2. ビルドを実行

```bash
cd /Users/sakuradamasaru/Desktop/misesapo-main
python3 scripts/build.py
```

### 3-3. 変更をコミット・プッシュ

```bash
git add .
git commit -m "feat: AWS Lambda + API GatewayでS3アップロード機能を追加"
git push
```

---

## ✅ 動作確認

1. GitHub Pagesにデプロイされるまで待つ（数分）
2. ブラウザで清掃マニュアル管理画面を開く:
   ```
   https://sakurada-masaru.github.io/misesapo/cleaning-manual-admin.html
   ```
3. ログインする
4. 任意の項目を編集
5. **「画像をアップロード」** ボタンをクリック
6. 画像を選択または撮影
7. 正常にアップロードできれば完了！

---

## 🔧 トラブルシューティング

### エラー: "S3へのアップロードには開発サーバーまたはAPI Gatewayが必要です"

**原因**: `API_GATEWAY_ENDPOINT` が設定されていない、またはビルドが反映されていない

**解決策**:
1. `aws-s3-upload.js` の `API_GATEWAY_ENDPOINT` が正しく設定されているか確認
2. ビルドを再実行
3. ブラウザのキャッシュをクリア（Cmd+Shift+R）

### エラー: CORSエラー

**原因**: API GatewayのCORS設定が正しくない

**解決策**:
1. API Gatewayの `upload` リソースで **「CORS を有効にする」** を再度実行
2. Lambda関数のレスポンスヘッダーを確認（コード内の `headers` 変数）

### エラー: 500 Internal Server Error

**原因**: Lambda関数のエラー

**解決策**:
1. Lambda関数の画面で **「モニタリング」** タブをクリック
2. **「CloudWatch Logs を表示」** をクリック
3. 最新のログを確認してエラーメッセージを確認
4. 環境変数が正しく設定されているか確認
5. IAMロールにS3への書き込み権限があるか確認

---

## 📚 参考

- [AWS Lambda ドキュメント](https://docs.aws.amazon.com/lambda/)
- [Amazon API Gateway ドキュメント](https://docs.aws.amazon.com/apigateway/)
- [AWS S3 ドキュメント](https://docs.aws.amazon.com/s3/)

