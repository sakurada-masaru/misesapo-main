# AWS設定 クイックスタートガイド

## 🚀 最短で設定を完了する手順

このガイドでは、レポート機能を動作させるために必要なAWS設定を、最短で完了させる手順を説明します。

---

## ステップ1: DynamoDBテーブルの作成（約10-15分）

**注意**: GSIの作成は1つずつ順番に行う必要があります。各GSIの作成に1-2分かかるため、3つすべてを作成するには約3-6分かかります。

### 1-1. テーブルを作成

1. **AWSコンソールにログイン**
   - https://console.aws.amazon.com/dynamodb/ にアクセス

2. **テーブルを作成**
   - 「テーブルの作成」をクリック
   - 設定を入力：
     ```
     テーブル名: staff-reports
     パーティションキー: report_id (データ型: String = 文字列)
     ソートキー: created_at (データ型: String = 文字列)
     ```
   - **補足**: `String` は文字列型（テキスト）を意味します。AWSコンソールでは「文字列」と表示されます。
   - 「テーブルの作成」をクリック

### 1-2. GSI（グローバルセカンダリインデックス）を3つ作成

**⚠️ 重要**: DynamoDBでは、1つのテーブルに対して**同時に作成できるインデックスは1つだけ**です。1つ目のインデックスが**ACTIVE**（アクティブ）状態になるまで待ってから、次のインデックスを作成してください。

テーブル作成後、以下の3つのGSIを**順番に**追加します。

#### GSI 1: `staff_id-created_at-index`
1. テーブル `staff-reports` を選択
2. 「インデックス」タブ → 「インデックスの作成」
3. 設定：
   ```
   インデックス名: staff_id-created_at-index
   パーティションキー: staff_id (データ型: String = 文字列)
   ソートキー: created_at (データ型: String = 文字列)
   ```
4. 「インデックスの作成」をクリック
5. **⏳ 待機**: インデックスのステータスが「**ACTIVE**」になるまで待つ（通常1-2分）
   - 「インデックス」タブでステータスを確認
   - 「作成中」→「**ACTIVE**」になったら次へ

#### GSI 2: `store_id-created_at-index`
1. **GSI 1がACTIVE状態であることを確認**
2. 「インデックスの作成」をクリック
3. 設定：
   ```
   インデックス名: store_id-created_at-index
   パーティションキー: store_id (データ型: String = 文字列)
   ソートキー: created_at (データ型: String = 文字列)
   ```
4. 「インデックスの作成」をクリック
5. **⏳ 待機**: インデックスのステータスが「**ACTIVE**」になるまで待つ

#### GSI 3: `status-created_at-index`
1. **GSI 2がACTIVE状態であることを確認**
2. 「インデックスの作成」をクリック
3. 設定：
   ```
   インデックス名: status-created_at-index
   パーティションキー: status (データ型: String = 文字列)
   ソートキー: created_at (データ型: String = 文字列)
   ```
4. 「インデックスの作成」をクリック
5. **⏳ 待機**: インデックスのステータスが「**ACTIVE**」になるまで待つ

**💡 ヒント**: 各インデックスの作成には通常1-2分かかります。3つすべてを作成するには合計で約3-6分かかります。

**⏱ 所要時間**: 約5分

---

## ステップ2: Lambda関数の権限設定（約3分）

### 2-1. IAMロールを確認

1. **Lambda関数を開く**
   - https://console.aws.amazon.com/lambda/ にアクセス
   - 既存のLambda関数（お知らせ機能で使用しているもの）を選択

2. **実行ロールを確認**
   - 「設定」タブ → 「実行ロール」
   - ロール名をコピー（例: `CreateAnnouncement-role-xxxxx`）

### 2-2. DynamoDB権限を追加

1. **IAMコンソールを開く**
   - https://console.aws.amazon.com/iam/ にアクセス
   - 「ロール」を選択
   - 上記でコピーしたロール名を検索して選択

2. **ポリシーをアタッチ**
   - 「許可を追加」→「ポリシーをアタッチ」
   - `AmazonDynamoDBFullAccess` を検索して選択
   - 「許可を追加」をクリック

**⏱ 所要時間**: 約3分

---

## ステップ3: API Gatewayの設定（約10分）

### 3-1. 既存のAPIを確認

1. **API Gatewayコンソールを開く**
   - https://console.aws.amazon.com/apigateway/ にアクセス
   - 既存のAPI（`/announcements` リソースがあるAPI）を選択

2. **既存のリソースを確認**
   - 左メニューの「リソース」で `/announcements` リソースが存在することを確認
   - 同じAPIに `/staff/reports` リソースを追加します

3. **APIエンドポイントURLを確認**
   - 「ステージ」タブ → `prod` ステージを選択
   - 「呼び出しURL」をコピー（例: `https://xxxxx.execute-api.ap-northeast-1.amazonaws.com/prod`）
   - このURLは既存の `/announcements` と同じAPIのURLです

### 3-2. リソース `/staff/reports` を作成

1. **リソースを作成**
   - 左メニューで「リソース」を選択
   - 「アクション」→「リソースの作成」
   - **リソースパス**: `/staff`
   - 「リソースの作成」をクリック

2. **`/staff` の下に `/reports` を作成**
   - `/staff` を選択
   - 「アクション」→「リソースの作成」
   - **リソースパス**: `reports`
   - 「リソースの作成」をクリック

### 3-3. メソッドを追加

`/staff/reports` を選択して、以下のメソッドを追加：

#### GET メソッド
1. 「アクション」→「メソッドの作成」→「GET」
2. **統合タイプ**: Lambda関数
3. **Lambda関数**: 既存のLambda関数を選択
4. 「保存」→「OK」をクリック

#### POST メソッド
1. 「アクション」→「メソッドの作成」→「POST」
2. **統合タイプ**: Lambda関数
3. **Lambda関数**: 既存のLambda関数を選択
4. 「保存」→「OK」をクリック

#### PUT メソッド
1. 「アクション」→「メソッドの作成」→「PUT」
2. **統合タイプ**: Lambda関数
3. **Lambda関数**: 既存のLambda関数を選択
4. 「保存」→「OK」をクリック

#### OPTIONS メソッド（CORS用）
1. 「アクション」→「メソッドの作成」→「OPTIONS」
2. **統合タイプ**: Mock
3. 「保存」をクリック
4. 「統合レスポンス」を選択
5. 「マッピングテンプレート」→「レスポンス本文のパススルー」を「なし」に変更
6. 「200」ステータスコードを選択
7. 「ヘッダー」に以下を追加：
   ```
   Access-Control-Allow-Origin: '*'
   Access-Control-Allow-Headers: 'Content-Type,Authorization'
   Access-Control-Allow-Methods: 'GET,POST,PUT,DELETE,OPTIONS'
   ```

### 3-4. リソース `/staff/reports/{report_id}` を作成

1. **リソースを作成**
   - `/staff/reports` リソースを選択
   - 「アクション」→「リソースの作成」
   - **リソースパス**: `{report_id}`
   - **補足**: `{report_id}` はパスパラメータです。波括弧 `{}` を含めて入力してください
   - 「リソースの作成」をクリック
   
   **結果**: `/staff/reports/{report_id}` リソースが作成されます

2. **メソッドを追加**

   ##### GET メソッド
   - 「アクション」→「メソッドの作成」→「GET」
   - **統合タイプ**: Lambda関数
   - **Lambda関数**: 既存のLambda関数を選択
   - 「保存」→「OK」をクリック

   ##### DELETE メソッド
   - 「アクション」→「メソッドの作成」→「DELETE」
   - **統合タイプ**: Lambda関数
   - **Lambda関数**: 既存のLambda関数を選択
   - 「保存」→「OK」をクリック

   ##### OPTIONS メソッド（CORS用）
   - 上記と同様に設定

### 3-5. CORSを有効化

1. **`/staff/reports` を選択**
2. 「アクション」→「CORSを有効にする」
3. 設定を確認して「CORSを有効にして既存のCORSヘッダーを置き換える」をクリック

4. **`/staff/reports/{report_id}` を選択**
5. 同様にCORSを有効化

### 3-6. APIをデプロイ

1. 「アクション」→「APIのデプロイ」
2. **デプロイステージ**: `prod`（既存のステージを選択）
3. 「デプロイ」をクリック

**⏱ 所要時間**: 約10分

---

## ステップ4: Lambda関数のコードをデプロイ（約2分）

### 4-1. Lambda関数のコードを確認

1. **Lambda関数を開く**
   - https://console.aws.amazon.com/lambda/ にアクセス
   - 既存のLambda関数を選択

2. **コードを確認**
   - `lambda_function.py` にレポート機能が含まれているか確認
   - 含まれていない場合は、最新のコードをアップロード

### 4-2. 環境変数を確認

1. 「設定」タブ → 「環境変数」
2. 以下が設定されているか確認：
   ```
   S3_BUCKET_NAME: misesapo-cleaning-manual-images
   S3_REGION: ap-northeast-1
   ```

**⏱ 所要時間**: 約2分

---

## ステップ5: テスト（約5分）

### 5-1. APIエンドポイントのテスト

1. **API Gatewayコンソールでテスト**
   - `/staff/reports` → GETメソッドを選択
   - 「テスト」をクリック
   - 「テスト」をクリック
   - レスポンスを確認（空の配列が返ってくるはず）

2. **curlでテスト（オプション）**
   ```bash
   curl -X GET "https://YOUR_API_GATEWAY_URL.execute-api.ap-northeast-1.amazonaws.com/prod/staff/reports"
   ```

### 5-2. フロントエンドのAPIエンドポイントURLを更新

1. **`src/pages/admin/reports.html` を開く**
2. APIエンドポイントURLを更新：
   ```javascript
   const API_BASE_URL = 'https://YOUR_API_GATEWAY_URL.execute-api.ap-northeast-1.amazonaws.com/prod';
   ```

3. **`src/pages/admin/reports/new.html` を開く**
4. 同様にAPIエンドポイントURLを更新

5. **ビルド**
   ```bash
   python3 scripts/build.py
   ```

**⏱ 所要時間**: 約5分

---

## ✅ 完了チェックリスト

- [ ] DynamoDBテーブル `staff-reports` を作成
- [ ] GSI 3つを作成（`staff_id-created_at-index`, `store_id-created_at-index`, `status-created_at-index`）
- [ ] Lambda関数にDynamoDB権限を追加
- [ ] API Gatewayに `/staff/reports` リソースを作成
- [ ] API Gatewayに `/staff/reports/{report_id}` リソースを作成
- [ ] GET, POST, PUT, DELETE, OPTIONSメソッドを追加
- [ ] CORSを設定
- [ ] APIをデプロイ
- [ ] Lambda関数のコードを確認
- [ ] 環境変数を確認
- [ ] APIエンドポイントをテスト
- [ ] フロントエンドのAPIエンドポイントURLを更新

---

## 🎯 合計所要時間

**約30-35分**でAWS設定を完了できます。
- DynamoDBテーブル作成: 約10-15分（GSI作成に時間がかかります）
- Lambda関数の権限設定: 約3分
- API Gatewayの設定: 約10分
- Lambda関数のコードデプロイ: 約2分
- テスト: 約5分

---

## 📝 次のステップ

AWS設定が完了したら、以下を実装します：

1. レポート詳細ページ（ユーザー向け `/reports/{id}.html`）
2. レポート編集ページ（管理者向け `/admin/reports/{id}/edit.html`）
3. Firebase認証の統合（Lambda関数側）

---

## 🆘 トラブルシューティング

### エラー: `Table not found: staff-reports`
- DynamoDBコンソールでテーブルが作成されているか確認
- テーブル名が `staff-reports` であることを確認

### エラー: `Access Denied` (DynamoDB)
- Lambda関数のIAMロールに `AmazonDynamoDBFullAccess` がアタッチされているか確認

### エラー: `Method not found`
- API Gatewayでメソッドが正しく作成されているか確認
- APIがデプロイされているか確認

### エラー: `CORS error`
- CORSが正しく設定されているか確認
- OPTIONSメソッドが作成されているか確認

### ⚠️ GSI（インデックス）がいつまでも作成されない

GSIの作成に時間がかかる場合、以下の点を確認してください：

#### 1. テーブルの状態を確認
- DynamoDBコンソールでテーブル `staff-reports` を開く
- 「概要」タブでテーブルのステータスを確認
- テーブルが「**アクティブ**」状態であることを確認
- テーブルが「作成中」の場合は、アクティブになるまで待つ

#### 2. インデックスのステータスを確認
- 「インデックス」タブを開く
- 作成中のインデックスのステータスを確認：
  - **「作成中」**: 正常に作成中です。通常1-2分で完了しますが、テーブルにデータがある場合は時間がかかることがあります
  - **「アクティブ」**: 作成完了です。次のインデックスを作成できます
  - **「削除中」**: 削除処理中です。完了するまで待つ必要があります
  - **エラー表示**: エラーが発生しています。詳細を確認してください

#### 3. テーブルにデータがある場合
- テーブルに既にデータが存在する場合、インデックスの作成に時間がかかります
- データ量に応じて、数分から数十分かかることがあります
- テーブルが空の場合は通常1-2分で完了します

#### 4. インデックスの設定を確認
- インデックス名、パーティションキー、ソートキーが正しく設定されているか確認
- パーティションキーとソートキーのデータ型が「文字列」であることを確認

#### 5. エラーメッセージを確認
- インデックスの詳細を開いて、エラーメッセージがないか確認
- エラーがある場合は、エラーメッセージに従って修正してください

#### 6. 時間がかかりすぎる場合（10分以上）
- テーブルを削除して再作成することを検討
- または、AWSサポートに問い合わせる

#### 7. よくある原因
- **テーブルが空でない**: データがあるとインデックス作成に時間がかかります
- **テーブルの容量が大きい**: 大きなテーブルでは時間がかかります
- **リージョンの負荷**: リージョンによっては処理が遅い場合があります
- **ネットワークの問題**: 一時的なネットワークの問題の可能性があります

#### 8. 対処法
1. **待つ**: 通常は1-2分で完了しますが、データがある場合は10分以上かかることがあります
2. **ページをリロード**: ブラウザをリロードして最新のステータスを確認
3. **別のインデックスを試す**: 他のインデックスが作成できるか確認
4. **テーブルを再作成**: テーブルが空の場合は、削除して再作成することも検討

**💡 ヒント**: テーブルが空の場合は、インデックスの作成は通常1-2分で完了します。データがある場合は、データ量に応じて時間がかかります。

