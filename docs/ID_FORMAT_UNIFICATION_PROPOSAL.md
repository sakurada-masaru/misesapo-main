# ID形式統一提案

## 提案するID形式

### 統一ルール
- **桁数**: 5桁（ゼロパディング）
- **形式**: `[プレフィックス][5桁の数値]`
- **例**: `CL00001`, `BR00001`, `ST00001`, `W00001`, `CU00001`

### 各エンティティのID形式

| エンティティ | プレフィックス | 例 | 最大件数 |
|------------|--------------|-----|---------|
| **お客様（顧客）** | `CU` | `CU00001` | 99,999件 |
| **法人（取引先）** | `CL` | `CL00001` | 99,999件 |
| **ブランド** | `BR` | `BR00001` | 99,999件 |
| **店舗** | `ST` | `ST00001` | 99,999件 |
| **従業員（社員）** | `W` | `W00001` | 99,999件 |

## 現在のID形式との相違点

### 1. 桁数の違い

| 項目 | 現在 | 提案 | 相違 |
|------|------|------|------|
| **正規化時の桁数** | 4桁 (`padStart(4, '0')`) | 5桁 (`padStart(5, '0')`) | ✅ 変更必要 |
| **最大件数** | 9,999件 | 99,999件 | ✅ 拡張 |

### 2. ID生成方法の違い

| 項目 | 現在 | 提案 | 相違 |
|------|------|------|------|
| **新規作成時** | タイムスタンプ形式 (`CL1733026800000`) | 連番形式 (`CL00001`) | ⚠️ **重大な相違** |
| **生成ロジック** | `Date.now()` を使用 | 既存の最大ID+1 | ⚠️ **重大な相違** |

### 3. プレフィックスの違い

| エンティティ | 現在 | 提案 | 相違 |
|------------|------|------|------|
| **従業員** | `WK` (data_utils.js) / `W` (実際の使用) | `W` | ✅ 統一必要 |
| **お客様** | 未定義 | `CU` | ⚠️ **新規追加** |

### 4. 現在のID生成箇所

#### フロントエンド

1. **法人作成** (`src/pages/admin/customers/index.html:2330`)
   ```javascript
   id: 'CL' + Date.now()  // ❌ タイムスタンプ形式
   ```

2. **ブランド作成** (`src/pages/admin/customers/index.html:2351`)
   ```javascript
   id: 'BR' + Date.now()  // ❌ タイムスタンプ形式
   ```

3. **店舗作成** (`src/pages/admin/customers/index.html:2392`)
   ```javascript
   id: 'ST' + Date.now()  // ❌ タイムスタンプ形式
   ```

4. **従業員作成** (`src/pages/admin/users/index.html:1323`)
   ```javascript
   id: 'W' + Date.now()  // ❌ タイムスタンプ形式
   ```

#### バックエンド（Lambda）

1. **法人作成** (`lambda_function.py`)
   - 確認が必要（ID生成ロジックを確認）

2. **従業員作成** (`lambda_function.py`)
   - 確認が必要（ID生成ロジックを確認）

#### data_utils.js

1. **ID生成** (`src/assets/js/data_utils.js:159-161`)
   ```javascript
   generate(prefix) {
     return `${prefix}${Date.now()}`;  // ❌ タイムスタンプ形式
   }
   ```

2. **ID正規化** (`src/assets/js/data_utils.js:121-134`)
   ```javascript
   normalize(id, prefix) {
     // ...
     return `${prefix}${str.padStart(4, '0')}`;  // ❌ 4桁
   }
   ```

## この定義で問題が解決するか？

### ✅ 解決する問題

1. **ID形式の一貫性**
   - すべてのIDが同じ形式（プレフィックス+5桁）になる
   - 可読性が向上
   - 比較が簡単になる

2. **ID比較の問題**
   - 形式が統一されるため、直接比較（`===`）が可能
   - `EntityFinder`の複雑なロジックが不要になる可能性

3. **最大件数の拡張**
   - 4桁（9,999件）→ 5桁（99,999件）に拡張

### ⚠️ 注意が必要な点

1. **既存データの移行**
   - 既存のタイムスタンプ形式IDを5桁形式に移行する必要がある
   - 既存の数値ID（`"1"`, `"2"`など）を5桁形式に移行する必要がある

2. **ID生成ロジックの変更**
   - タイムスタンプ形式から連番形式への変更が必要
   - 既存の最大IDを取得して+1するロジックが必要
   - バックエンド（Lambda）での実装が必要

3. **お客様ID（CU）の追加**
   - 現在、お客様IDの定義がない
   - `clients`テーブルと`customers`テーブルの関係を明確にする必要がある
   - または、`clients`テーブルの`type`が`individual`の場合に`CU`プレフィックスを使用する？

4. **同時作成時の競合**
   - 連番形式の場合、同時に複数のリクエストが来た場合の競合対策が必要
   - DynamoDBの条件付き書き込みやトランザクションを使用する必要がある

## 実装方針

### フェーズ1: ID生成ロジックの変更

1. **バックエンド（Lambda）**
   - 各テーブルの最大IDを取得する関数を実装
   - 新規ID生成時に最大ID+1を返す関数を実装
   - 競合対策（条件付き書き込み）を実装

2. **フロントエンド**
   - `data_utils.js`の`generate()`関数を削除または非推奨化
   - 新規作成時はIDを生成せず、バックエンドに任せる

### フェーズ2: ID正規化の変更

1. **data_utils.js**
   - `normalize()`関数を5桁に変更
   - `padStart(4, '0')` → `padStart(5, '0')`

2. **ID_PREFIXの更新**
   - `WORKER: 'WK'` → `WORKER: 'W'`
   - `CUSTOMER: 'CU'` を追加

### フェーズ3: 既存データの移行（オプション）

1. **移行スクリプトの作成**
   - 既存のタイムスタンプ形式IDを5桁形式に移行
   - 既存の数値IDを5桁形式に移行

2. **移行の実行**
   - テスト環境で移行を実行
   - 本番環境で移行を実行

## 推奨される実装順序

1. ✅ **ID_PREFIXの更新**（`WK` → `W`、`CU`追加）
2. ✅ **ID正規化を5桁に変更**（`padStart(5, '0')`）
3. ⚠️ **バックエンドでのID生成ロジック実装**（最大ID+1）
4. ⚠️ **フロントエンドでのID生成を削除**（バックエンドに任せる）
5. ⚠️ **既存データの移行**（必要に応じて）

## 結論

**この定義で問題は解決します**が、以下の実装が必要です：

1. ✅ ID形式の統一（5桁、プレフィックス統一）
2. ⚠️ ID生成ロジックの変更（タイムスタンプ → 連番）
3. ⚠️ 既存データの移行（オプション）

最も重要なのは、**ID生成をバックエンド（Lambda）で一元管理**することです。これにより、ID形式の一貫性が保たれ、競合も防げます。

