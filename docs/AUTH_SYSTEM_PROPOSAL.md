# 権限ベースログインシステム提案

## 📋 概要

Webサイト全体に統一的なログインシステムを導入し、権限（ロール）によってアクセス可能なページを制御します。

---

## 🎯 ロール定義

### 1. **guest（ゲスト）**
- **説明**: 未認証ユーザー
- **アクセス可能**: パブリックページのみ
- **パスワード**: 不要

### 2. **customer（顧客）**
- **説明**: 個人・法人の顧客
- **アクセス可能**: 
  - パブリックページ
  - `/mypage/*`（マイページ関連）
  - `/service.html`（サービス一覧）
  - `/service/{id}.html`（サービス詳細）
  - `/cart.html`, `/checkout.html`（カート・決済）
- **パスワード**: `customer1234`（デフォルト）

### 3. **staff（清掃員）**
- **説明**: 清掃作業を行うスタッフ
- **アクセス可能**:
  - パブリックページ
  - `/staff/*`（清掃員向けページ）
  - `/schedule.html`（スケジュール）
  - `/report.html`, `/reports/*`（レポート）
- **パスワード**: `staff1234`（デフォルト）

### 4. **sales（営業マン）**
- **説明**: 営業担当者
- **アクセス可能**:
  - パブリックページ
  - `/sales/*`（営業向けページ）
  - `/schedule.html`（スケジュール）
- **パスワード**: `sales1234`（デフォルト）

### 5. **admin（管理者）**
- **説明**: システム管理者
- **アクセス可能**: すべてのページ
- **パスワード**: `admin1234`（デフォルト）

### 6. **developer（開発者）**
- **説明**: 技術者・開発者
- **アクセス可能**: 
  - すべてのページ
  - `/admin/services/review.html`（変更レビューページ）
- **パスワード**: `misesapo1234`（デフォルト）

---

## 🔐 実装方法

### オプション1: クライアントサイド認証（推奨・簡易版）

**メリット**:
- 実装が簡単
- バックエンド不要
- 静的サイトで動作

**デメリット**:
- セキュリティが低い（パスワードがクライアント側に保存）
- 本番環境には不向き

**実装内容**:
1. 統一ログインページ（`/signin.html`）を作成
2. ロール別のパスワードを設定
3. `sessionStorage`でセッション管理
4. 各ページで認証チェックを行う共通スクリプト（`auth.js`）を作成
5. ページごとに必要なロールを設定

**ファイル構成**:
```
src/assets/js/
  ├── auth.js          # 認証管理スクリプト（新規作成）
  └── role_config.js   # ロール・ページ設定（新規作成）

src/pages/
  └── signin.html      # ログインページ（既存を拡張）
```

---

### オプション2: 簡易バックエンド認証（dev_server.py拡張）

**メリット**:
- パスワードをサーバー側で管理
- セキュリティが向上
- ユーザー管理が可能

**デメリット**:
- バックエンド実装が必要
- GitHub Pagesでは動作しない（ローカル環境のみ）

**実装内容**:
1. `dev_server.py`に認証APIエンドポイントを追加
   - `POST /api/auth/login` - ログイン
   - `POST /api/auth/logout` - ログアウト
   - `GET /api/auth/me` - 現在のユーザー情報取得
2. ユーザー情報をJSONファイルで管理（`src/data/users.json`）
3. セッション管理（CookieまたはJWT）

---

### オプション3: ハイブリッド方式（推奨）

**ローカル環境**: オプション2（バックエンド認証）
**GitHub Pages**: オプション1（クライアントサイド認証）

**メリット**:
- ローカル開発時はセキュア
- GitHub Pagesでも動作

---

## 📁 ページ別アクセス制御設定

### パブリックページ（認証不要）
```
/index.html
/service.html
/service/{id}.html
/signin.html
/signup.html
/contact.html
/concierge.html
```

### 顧客向けページ（customer以上）
```
/mypage.html
/mypage/*
/cart.html
/checkout.html
/order/*
```

### 清掃員向けページ（staff以上）
```
/staff/*
/schedule.html
/report.html
/reports/*
```

### 営業マン向けページ（sales以上）
```
/sales/*
```

### 管理者向けページ（admin以上）
```
/admin/*
```

### 開発者向けページ（developer以上）
```
/admin/services/review.html
```

---

## 🎨 UI/UX設計

### ログインページ（`/signin.html`）

**レイアウト**:
- 中央配置のログインフォーム
- ロール選択（ドロップダウンまたはタブ）
- メールアドレス入力欄（オプション）
- パスワード入力欄
- ログインボタン
- 「パスワードを忘れた場合」リンク

**ロール選択UI**:
```
┌─────────────────────────┐
│ ログイン                │
├─────────────────────────┤
│ ロールを選択:           │
│ [顧客 ▼]                │
│                         │
│ メールアドレス:         │
│ [________________]      │
│                         │
│ パスワード:             │
│ [________________]      │
│                         │
│ [ログイン]              │
│                         │
│ パスワードを忘れた場合  │
└─────────────────────────┘
```

### 認証エラー時の動作

1. **未認証ユーザーが保護ページにアクセス**
   - `/signin.html`にリダイレクト
   - 元のページURLを`?redirect=/admin/services.html`として保存

2. **権限不足のユーザーがアクセス**
   - 403エラーページを表示
   - 「このページにアクセスする権限がありません」メッセージ

3. **セッション期限切れ**
   - 自動的にログアウト
   - `/signin.html`にリダイレクト

---

## 🔧 実装詳細（オプション1: クライアントサイド認証）

### 1. `src/assets/js/auth.js`（新規作成）

**機能**:
- ログイン処理
- ログアウト処理
- 認証チェック
- セッション管理
- ページアクセス制御

**主要関数**:
```javascript
// ログイン
async function login(role, password, email = null)

// ログアウト
function logout()

// 認証チェック
function checkAuth()

// 現在のロール取得
function getCurrentRole()

// ページアクセス権限チェック
function checkPageAccess(requiredRoles)

// 認証が必要なページかチェック
function isProtectedPage(path)
```

### 2. `src/assets/js/role_config.js`（新規作成）

**内容**:
```javascript
const ROLE_CONFIG = {
  // ロール定義
  roles: {
    guest: { name: 'ゲスト', password: null },
    customer: { name: '顧客', password: 'customer1234' },
    staff: { name: '清掃員', password: 'staff1234' },
    sales: { name: '営業マン', password: 'sales1234' },
    admin: { name: '管理者', password: 'admin1234' },
    developer: { name: '開発者', password: 'misesapo1234' }
  },
  
  // ページ別アクセス制御
  pageAccess: {
    '/index.html': ['guest', 'customer', 'staff', 'sales', 'admin', 'developer'],
    '/service.html': ['guest', 'customer', 'staff', 'sales', 'admin', 'developer'],
    '/mypage.html': ['customer', 'admin', 'developer'],
    '/mypage/*': ['customer', 'admin', 'developer'],
    '/staff/*': ['staff', 'admin', 'developer'],
    '/sales/*': ['sales', 'admin', 'developer'],
    '/admin/*': ['admin', 'developer'],
    '/admin/services/review.html': ['developer']
  }
};
```

### 3. `src/pages/signin.html`（既存を拡張）

**追加機能**:
- ロール選択UI
- 統一認証処理
- リダイレクト処理

---

## 📊 実装優先順位

### Phase 1: 基本認証システム（必須）
1. ✅ `auth.js`の作成
2. ✅ `role_config.js`の作成
3. ✅ `/signin.html`の拡張
4. ✅ 各ページへの認証チェック追加

### Phase 2: アクセス制御強化
5. 403エラーページの作成
6. セッション期限切れの処理
7. ログアウト機能の実装

### Phase 3: ユーザー体験向上
8. ログイン状態の表示（ヘッダー）
9. ロール別ダッシュボードへのリダイレクト
10. パスワード変更機能

---

## 🔒 セキュリティ考慮事項

### 現状（クライアントサイド認証）の制限
- パスワードがJavaScriptにハードコードされている
- セッション情報が`sessionStorage`に保存されている
- 本番環境には不向き

### 将来的な改善案
1. **バックエンド認証の導入**
   - パスワードをサーバー側で管理
   - JWTトークンによる認証
   - セッション管理をサーバー側で行う

2. **パスワードハッシュ化**
   - パスワードをハッシュ化して保存
   - bcrypt等のライブラリを使用

3. **HTTPSの必須化**
   - 通信の暗号化
   - セッション情報の保護

---

## 💡 推奨実装方式

**現時点では「オプション1: クライアントサイド認証」を推奨**

**理由**:
1. 実装が簡単で早く導入できる
2. 静的サイトで動作する
3. GitHub Pagesでも動作する
4. 現状の簡易パスワード保護を統一できる

**将来的には「オプション3: ハイブリッド方式」に移行**

**移行タイミング**:
- 本番環境への移行時
- より高度なセキュリティが必要になった時
- ユーザー管理機能が必要になった時

---

## ❓ 質問・確認事項

1. **パスワード管理方法**
   - デフォルトパスワードで開始するか？
   - ユーザーごとに異なるパスワードが必要か？

2. **ロールの追加**
   - 上記の6つのロールで十分か？
   - 追加のロールが必要か？

3. **セッション管理**
   - セッション期限はどのくらいが適切か？（現在は8時間）
   - 自動ログアウト機能は必要か？

4. **実装方式**
   - オプション1（クライアントサイド）で開始するか？
   - 最初からオプション2（バックエンド）を実装するか？

---

## 📝 次のステップ

この提案を承認いただければ、以下の順序で実装を開始します：

1. `auth.js`と`role_config.js`の作成
2. `/signin.html`の拡張
3. 既存の認証スクリプト（`client_auth.js`等）を統合
4. 各ページへの認証チェック追加
5. テスト・動作確認

