# ブラウザで最新情報を見られるタイミング

## 📋 最新情報が表示されるタイミング

### 1. **編集直後（自動更新）**

**タイミング**: 編集保存後、約0.8秒後

**流れ**:
```
1. ユーザーが「保存」ボタンをクリック
   ↓
2. APIにPUTリクエストを送信
   ↓
3. APIが成功レスポンスを返す（認可）
   ↓
4. 0.5秒待機（DynamoDBの反映を待つ）
   ↓
5. 0.3秒待機（追加の待機時間）
   ↓
6. APIから最新データを取得
   ↓
7. 画面を更新
```

**合計時間**: 約0.8秒（APIの応答時間 + 0.8秒）

---

### 2. **ページリロード時**

**タイミング**: ページをリロード（F5またはCmd+R）した瞬間

**流れ**:
```
1. ページをリロード
   ↓
2. ページが読み込まれる
   ↓
3. loadUser()関数が実行される
   ↓
4. APIから最新データを取得（キャッシュ無効化）
   ↓
5. 画面に表示
```

**注意**: リロードしても変わらない場合は、以下の原因が考えられます。

---

## ❌ リロードしても変わらない理由

### 原因1: 全ユーザー取得APIが古いデータを返している

**問題**:
- 個別取得API (`/workers/W999`) → 最新データ（`general_affairs`）
- 全ユーザー取得API (`/workers`) → 古いデータ（`admin`）

**理由**:
- DynamoDBのスキャン操作は、複数のパーティションにまたがる場合、強整合性読み取りでも完全に最新データが返されない可能性がある
- 特に、更新直後は最終的な整合性による遅延が発生する可能性がある

**解決策**:
1. ユーザー一覧画面でも、個別取得APIを使用する
2. または、編集後に個別取得APIで再取得する

---

### 原因2: ブラウザのキャッシュ

**問題**:
- ブラウザがAPIレスポンスをキャッシュしている

**確認方法**:
- ブラウザの開発者ツール（F12）を開く
- 「Network」タブを確認
- `/workers` のリクエストを確認
- 「Disable cache」にチェックを入れてリロード

**解決策**:
- コードでは既に `cache: 'no-store'` とタイムスタンプを追加している
- それでも問題が続く場合は、ハードリロード（Ctrl+Shift+R または Cmd+Shift+R）を試す

---

### 原因3: Lambda関数がデプロイされていない

**問題**:
- Lambda関数のコードが更新されていない
- 強整合性読み取りが有効になっていない

**確認方法**:
- AWS Lambdaコンソールでコードを確認
- `ConsistentRead=True` が設定されているか確認

**解決策**:
- Lambda関数を再デプロイする

---

### 原因4: ローカルJSONファイルが古い

**問題**:
- フォールバックとして使用される `workers.json` が古い

**確認方法**:
- `src/data/workers.json` を確認
- 最新のデータと比較

**解決策**:
- `scripts/sync_workers_json.py` を実行して同期する

---

## ✅ 推奨される対応

### 1. ユーザー一覧画面の改善

**現在の問題**:
- ユーザー一覧画面は全ユーザー取得API (`/workers`) を使用
- 更新直後は古いデータが返される可能性がある

**改善案**:
- 編集後に、個別取得APIで再取得する
- または、ユーザー一覧画面でも個別取得APIを使用する

### 2. 強制リロード機能の追加

**改善案**:
- 「最新情報を取得」ボタンを追加
- クリックすると、APIから最新データを取得して画面を更新

### 3. リアルタイム更新

**改善案**:
- WebSocketやServer-Sent Eventsを使用
- データが更新されたら、自動的に画面を更新

---

## 🔍 トラブルシューティング

### ステップ1: ブラウザの開発者ツールで確認

1. F12キーを押して開発者ツールを開く
2. 「Network」タブを開く
3. ページをリロード
4. `/workers` または `/workers/W999` のリクエストを確認
5. レスポンスの内容を確認

### ステップ2: APIを直接確認

```bash
# 個別取得API
curl "https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod/workers/W999"

# 全ユーザー取得API
curl "https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod/workers"
```

### ステップ3: Lambda関数のログを確認

1. AWS CloudWatch Logsを開く
2. Lambda関数のログを確認
3. エラーメッセージを確認

---

## 📝 まとめ

**最新情報が表示されるタイミング**:
1. **編集直後**: 約0.8秒後（自動更新）
2. **ページリロード時**: リロードした瞬間

**リロードしても変わらない理由**:
1. 全ユーザー取得APIが古いデータを返している
2. ブラウザのキャッシュ
3. Lambda関数がデプロイされていない
4. ローカルJSONファイルが古い

**推奨される対応**:
- 個別取得APIを使用する
- 強制リロード機能を追加する
- リアルタイム更新を実装する

