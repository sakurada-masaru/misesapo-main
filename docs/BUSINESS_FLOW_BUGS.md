# 業務フロー 不具合チェック結果

**作成日**: 2025年1月  
**チェック対象**: 実際の清掃業務フローに基づく不具合確認

---

## 🔴 発見された不具合・問題点

### 1. 店舗登録時のエラーハンドリング不足（営業マン）

**場所**: `src/pages/sales/dashboard.html` - `submitClient()` 関数

**問題点**:
- 法人作成が失敗しても、ブランド作成処理が続行される
- ブランド作成が失敗しても、店舗作成処理が続行される
- 部分的にデータが作成される可能性がある（データ整合性の問題）

**該当コード**:
```javascript
// 法人作成
if (clientRes.ok) {
  clientId = newClientId;
} // エラー時も続行される

// ブランド作成
if (brandRes.ok) {
  brandId = newBrandId;
} // エラー時も続行される

// 店舗作成（clientId/brandIdがnullの可能性がある）
```

**影響**: 
- 法人やブランドが作成されずに店舗だけが作成される可能性
- データ整合性の問題

**推奨修正**:
- 各ステップでエラーチェックを追加
- エラー時は処理を中断し、ロールバック処理を実装

---

### 2. スケジュールアサイン時のステータス更新が不明確（管理者）

**場所**: `src/pages/admin/schedules/index.html` - `editSchedule()` 関数

**問題点**:
- 仮押さえ（`draft`）から確定（`scheduled`）へのステータス更新が自動化されていない
- 管理者が手動でステータスを変更する必要がある
- 清掃員を割り当てただけでは、ステータスが `draft` のままの可能性

**該当コード**:
```javascript
// 清掃員を割り当てても、ステータスは手動で変更する必要がある
document.getElementById('schedule-status').value = schedule.status || 'scheduled';
```

**影響**:
- 清掃員に割り当てても、スケジュールが「仮押さえ」のままになる可能性
- 清掃員がスケジュールを確認できない可能性

**推奨修正**:
- 清掃員を割り当てた際に、自動的にステータスを `draft` → `scheduled` に更新
- または、清掃員割り当て時にステータス更新を促すUIを追加

---

### 3. レポート送信時のスケジュール更新エラーハンドリング不足（清掃員）

**場所**: `src/pages/staff/reports/new.html` - `handleSubmit()` 関数

**問題点**:
- レポート送信は成功しても、スケジュール更新が失敗する可能性がある
- スケジュール更新が失敗しても、エラーが表示されない
- レポートは送信済みだが、スケジュールが「作業中」のままになる可能性

**該当コード**:
```javascript
// レポート送信
const response = await fetch(...);
if (!response.ok) throw new Error('送信に失敗しました');

// スケジュール更新（エラーハンドリングなし）
await fetch(`${API_BASE}/schedules/${selectedSchedule.id}`, {
  method: 'PUT',
  body: JSON.stringify({ status: 'completed' })
});
// エラーが発生しても処理が続行される
```

**影響**:
- レポートは送信済みだが、スケジュールが完了にならない
- データ整合性の問題

**推奨修正**:
- スケジュール更新のエラーハンドリングを追加
- 更新失敗時はエラーメッセージを表示

---

### 4. 本見積もり作成機能の不足（管理者）

**場所**: `src/pages/admin/estimates/index.html`

**問題点**:
- ステータスを `pending` → `processing` → `completed` に更新する機能はある
- しかし、実際の「本見積もり作成画面」への遷移がない
- 本見積もりを作成する具体的な機能が実装されていない

**該当コード**:
```javascript
// ステータス更新のみ
async function updateStatus(id, newStatus) {
  // status を更新するだけ
  body: JSON.stringify({ status: newStatus })
}
```

**影響**:
- 管理者が本見積もりを作成する方法がない
- ステータスは更新されるが、実際の本見積もりデータが作成されない

**推奨修正**:
- 本見積もり作成画面を実装
- または、仮見積もり詳細から本見積もり作成への遷移を追加

---

### 5. 見積もり送信機能の不足（管理者）

**場所**: `src/pages/admin/estimates/index.html`

**問題点**:
- 見積もりを「完了」にしても、顧客への送信機能がない
- 見積もりをPDF化する機能がない
- 見積もりをメール送信する機能がない

**影響**:
- 本見積もりを作成しても、顧客に送信できない
- 手動で送信する必要がある

**推奨修正**:
- 見積もり送信機能を実装
- PDF生成機能を実装
- メール送信機能を実装（将来的に）

---

### 6. レポート送信機能の不足（管理者）

**場所**: `src/pages/admin/reports/index.html`

**問題点**:
- レポートを承認しても、顧客への自動送信機能がない
- レポートをPDF化する機能がない
- レポートをメール送信する機能がない

**影響**:
- レポートを承認しても、顧客に送信できない
- 手動で送信する必要がある

**推奨修正**:
- レポート送信機能を実装
- PDF生成機能を実装
- メール送信機能を実装（将来的に）

---

### 7. 清掃員の案件受託機能の不足（清掃員）

**場所**: `src/pages/staff/schedule.html`

**問題点**:
- 清掃員がスケジュールを「受託」する機能がない
- スケジュールのステータスを `assigned` → `in_progress` に更新する機能がない
- 作業開始ボタンがない

**影響**:
- 清掃員がスケジュールを受託できない
- 管理者が割り当てても、清掃員が「受託」したことが記録されない

**推奨修正**:
- 案件受託ボタンを追加
- 作業開始ボタンを追加
- ステータス更新機能を実装

---

## ⚠️ 潜在的な問題点

### 1. データ整合性の問題

- 店舗登録時に、法人やブランドが作成されずに店舗だけが作成される可能性
- レポート送信時に、スケジュール更新が失敗する可能性

### 2. エラーハンドリングの不足

- 一部のAPI呼び出しでエラーハンドリングが不十分
- エラーが発生しても、ユーザーに適切なフィードバックがない

### 3. 機能の不足

- 本見積もり作成機能
- 見積もり送信機能
- レポート送信機能
- 案件受託機能

---

## 📊 不具合の優先度

| 優先度 | 不具合 | 影響度 | 緊急度 |
|--------|--------|--------|--------|
| 🔴 高 | 店舗登録時のエラーハンドリング不足 | 高 | 高 |
| 🔴 高 | スケジュールアサイン時のステータス更新が不明確 | 高 | 高 |
| 🟡 中 | レポート送信時のスケジュール更新エラーハンドリング不足 | 中 | 中 |
| 🟡 中 | 清掃員の案件受託機能の不足 | 中 | 中 |
| 🟢 低 | 本見積もり作成機能の不足 | 低 | 低 |
| 🟢 低 | 見積もり送信機能の不足 | 低 | 低 |
| 🟢 低 | レポート送信機能の不足 | 低 | 低 |

---

## 🎯 推奨される修正

### 優先度: 高

1. **店舗登録時のエラーハンドリング改善**
   - 各ステップでエラーチェックを追加
   - エラー時は処理を中断

2. **スケジュールアサイン時の自動ステータス更新**
   - 清掃員を割り当てた際に、自動的にステータスを `draft` → `scheduled` に更新

### 優先度: 中

3. **レポート送信時のスケジュール更新エラーハンドリング**
   - スケジュール更新のエラーハンドリングを追加

4. **清掃員の案件受託機能の実装**
   - 案件受託ボタンを追加
   - 作業開始ボタンを追加

### 優先度: 低

5. **本見積もり作成機能の実装**
6. **見積もり送信機能の実装**
7. **レポート送信機能の実装**

---

## 📝 備考

- 現在の実装では、基本的な業務フローは動作するが、一部の機能が不足している
- エラーハンドリングの改善により、データ整合性の問題を解決できる
- 機能の不足は、将来的に実装予定の機能として位置づけることも可能

