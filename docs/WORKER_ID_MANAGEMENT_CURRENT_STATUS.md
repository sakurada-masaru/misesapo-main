# 従業員ID管理の現状

## 📊 現状のID形式（混在状態）

### 1. プレフィックス付きID（新形式）
- **形式**: `W` + 数値
- **例**: `W017`, `W015`, `W002`, `W007`, `W014`, `W013`, `W006`, `W003`, `W001`, `W008`, `W016`, `W012`, `W005`, `W009`, `W011`, `W010`, `W004`
- **特徴**: 
  - 3桁の数値が付与されている
  - 例: `W017` = Worker 017
  - 比較的新しいデータに使用されている

### 2. 数値ID（旧形式）
- **形式**: 数値の文字列
- **例**: `"1"`, `"2"`, `"3"`, `"4"`
- **特徴**:
  - 古いデータに使用されている
  - `user_id`フィールドと`id`フィールドが異なる場合がある
  - 例: `id: "2"`, `user_id: "4"`

### 3. タイムスタンプID（最新形式）
- **形式**: `W` + タイムスタンプ（ミリ秒）
- **例**: `W1764549250789`
- **特徴**:
  - 新規作成時に自動生成される
  - フロントエンド: `'W' + Date.now()`
  - バックエンド: `'W' + str(int(datetime.utcnow().timestamp() * 1000))`

## 🔍 データソース

### APIレスポンス（`/workers`）
- **データ件数**: 約20件
- **ID形式**: 上記3種類が混在
- **データ構造**: 
  ```json
  {
    "id": "W017" または "1" または "W1764549250789",
    "name": "名前",
    "email": "メールアドレス",
    "role": "staff" | "sales" | "admin" | "other",
    "department": "部署名",
    "status": "active" | "inactive",
    "created_at": "作成日時",
    "updated_at": "更新日時"
  }
  ```

### DynamoDBテーブル（`workers`）
- **テーブル名**: `workers`
- **パーティションキー**: `id` (String型)
- **現状**: スキャン結果が空（データが別のソースから来ている可能性）

## 📝 ID生成ロジック

### 新規作成時

**フロントエンド** (`src/pages/admin/users/index.html`):
```javascript
if (isNew) {
  data.id = 'W' + Date.now();  // 例: W1733026800000
  data.created_at = new Date().toISOString();
}
```

**バックエンド** (`lambda_function.py`):
```python
if 'id' not in body_json:
    body_json['id'] = 'W' + str(int(datetime.utcnow().timestamp() * 1000))
```

### ID取得時

**フロントエンド** (`src/pages/admin/users/index.html`):
```javascript
const workerId = String(w.id || w.user_id || `user_${Date.now()}_${Math.random()}`);
```

優先順位:
1. `w.id` - 主要なIDフィールド
2. `w.user_id` - 代替IDフィールド（古いデータで使用）
3. フォールバック - 一時的なID生成

## ⚠️ 問題点

### 1. ID形式の混在
- 3種類のID形式が混在している
- 削除時にIDが見つからない問題が発生

### 2. データソースの不明確さ
- APIレスポンスにはデータが存在する
- DynamoDBのスキャン結果が空
- データが別のソース（S3、別テーブル、静的ファイル）から来ている可能性

### 3. IDの一意性
- 数値ID（`"1"`, `"2"`, `"3"`, `"4"`）は重複の可能性がある
- `user_id`と`id`が異なる場合がある

## 🔧 現在の対応

### 削除処理
- 文字列IDと数値IDの両方に対応
- 削除前に存在確認
- デバッグログで利用可能なID一覧を表示

### ID正規化
- すべてのIDを文字列として扱う
- `String()`で変換して一貫性を保つ

## 📋 推奨される改善策

### 1. ID形式の統一
- **推奨**: タイムスタンプ形式（`W` + タイムスタンプ）に統一
- **理由**: 
  - 一意性が保証される
  - 時系列でソート可能
  - 重複のリスクが低い

### 2. データマイグレーション
- 既存の数値IDをタイムスタンプ形式に移行
- プレフィックス付きID（`W017`など）もタイムスタンプ形式に移行

### 3. データソースの明確化
- データがどこから来ているのかを確認
- DynamoDBテーブルに正しく保存されているか確認

## 🔍 確認が必要な項目

1. **データソース**: APIレスポンスのデータはどこから来ているか？
2. **DynamoDB**: テーブルにデータが正しく保存されているか？
3. **IDの一意性**: 同じIDが複数存在しないか？
4. **マイグレーション**: 既存データを新しいID形式に移行する必要があるか？

