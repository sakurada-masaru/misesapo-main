# AWS vs Azure Dataverse 比較分析

**作成日**: 2025/11/26  
**目的**: AWSプロトタイプとAzure Dataverse本番環境のデータ構造比較

---

## 1. テーブル/エンティティ対応表

| AWS (DynamoDB) | Azure (Dataverse) | 一致度 | 備考 |
|----------------|-------------------|--------|------|
| **clients** | **取引先** (cr365_f857...) | ⭐⭐⭐⭐⭐ | 完全対応 |
| **brands** | **ブランド管理** (cr365_50c48...) | ⭐⭐⭐⭐⭐ | 完全対応 |
| **stores** | **店舗情報** (cr365_0e592...) | ⭐⭐⭐⭐ | フィールド差異あり |
| **schedules** | **スケジュール** (cr365_17497...) | ⭐⭐⭐⭐ | Azure側がより詳細 |
| **workers** | **メンバー** (cr365_17547...) | ⭐⭐⭐⭐ | ユニット紐づけ差異 |
| **reports** | **現場報告** (cr365_17572...) | ⭐⭐⭐ | AWS側がより詳細 |
| **services** | **サービス** + **提供サービス** | ⭐⭐⭐ | Azure側は2テーブル分離 |
| **tasks** | **作業** + **作業記録** | ⭐⭐⭐ | Azure側は2テーブル分離 |
| **users** | systemuser (標準) | ⭐⭐⭐ | Azure標準テーブル使用 |
| - | **ユニット** | ➖ | AWS未実装（チーム管理） |
| - | **店舗担当者** | ➖ | AWS未実装 |
| - | **店舗チェッカー** | ➖ | AWS未実装 |
| - | **店舗メモ** | ➖ | AWS未実装 |
| - | **資産管理** | ➖ | AWS未実装 |
| - | **注意事項** | ➖ | AWS未実装 |
| - | **取引記録** | ➖ | AWS未実装 |
| - | **問合管理** | ➖ | AWS未実装 |
| - | **活動** | ➖ | AWS未実装 |
| - | **提供内容** | ➖ | AWS未実装 |
| - | **取引先担当者** | ➖ | AWS未実装 |

---

## 2. データ階層構造

### 共通の3階層構造（実装済み）

```
取引先（企業/個人）
  └─ ブランド（店舗名/屋号）
       └─ 店舗（実店舗/支店）
```

**例: 法人チェーン**
```
株式会社ABC（取引先）
  └─ カフェXYZ（ブランド）
       ├─ 渋谷店（店舗）
       └─ 新宿店（店舗）
```

**例: 個人店**
```
佐藤一郎（取引先 = 個人）
  └─ ラーメン佐藤（ブランド = 屋号）
       └─ 本店（店舗）
```

---

## 3. フィールド比較

### 3.1 店舗情報

| AWS `stores` | Azure `店舗情報` | 型 | 備考 |
|--------------|------------------|-----|------|
| `id` | `cr365_...id` | String / GUID | ID形式が異なる |
| `name` | `cr365_1` (名称) | String | ✅ 一致 |
| `postcode` | `cr365_2` (郵便番号) | String | ✅ 一致 |
| `pref` | - | String | AWS分割 |
| `city` | - | String | AWS分割 |
| `address1` | `cr365_4` (住所) | String | Azure統合 |
| `address2` | - | String | AWS追加 |
| `phone` | `cr365_5` (電話番号) | String | ✅ 一致 |
| `status` | `cr365_6` (利用状況) | String / Picklist | ✅ 一致 |
| `brand_id` | `cr365_50c48...` (ブランド管理) | String / Lookup | ✅ 一致 |
| `notes` | `cr365_10` (注意事項) | String / Memo | ✅ 一致 |
| `sales_notes` | `cr365_11` (営業情報) | String / Memo | ✅ 一致 |
| - | `cr365_12` (GoogleMAP) | String | AWS未実装 |
| - | `cr365_13` (担当者情報) | Memo | AWS未実装 |
| - | `cr365_7` (利用開始日) | DateTime | AWS未実装 |
| - | `cr365_8` (保管フォルダ/ディレクトリ) | String | AWS未実装 |
| - | `cr365_9` (保管フォルダ/共有) | String | AWS未実装 |
| `created_at` | `createdon` | DateTime | ✅ 一致 |
| `updated_at` | `modifiedon` | DateTime | ✅ 一致 |

### 3.2 現場報告（レポート）

| AWS `reports` | Azure `現場報告` | 型 | 備考 |
|---------------|------------------|-----|------|
| `id` | `cr365_...id` | String / GUID | ID形式が異なる |
| `store_id` | - | String | Azure側関連なし？ |
| `worker_id` | `ownerid` (所有者) | String / Owner | ✅ 一致 |
| `schedule_id` | - | String | Azure側関連なし？ |
| `content` | `cr365_3` (コメント) | String / Memo | ✅ 一致 |
| `work_type` | `cr365_2` (作業区分) | String / Picklist | ✅ 一致 |
| `photos[]` | `cr365_4` (ファイル名) | Array / String | **差異あり** |
| - | `cr365_5` (URL) | String | Azure単一ファイル |
| `status` | `statuscode` | String / Status | ✅ 一致 |
| `created_at` | `createdon` | DateTime | ✅ 一致 |

---

## 4. 主な相違点

| 項目 | AWS (DynamoDB) | Azure (Dataverse) |
|------|----------------|-------------------|
| **ID形式** | 自動採番 / カスタム文字列 | GUID (36文字) |
| **リレーション** | 文字列参照 (`store_id`) | Lookup型（厳密な外部キー） |
| **写真管理** | S3 + 配列で複数対応 | 1レコード1ファイル |
| **住所** | 分割（pref/city/address1/address2） | 統合（1フィールド） |
| **テーブル粒度** | シンプル（統合型） | 細分化（正規化型） |
| **システムフィールド** | 最小限（created_at, updated_at） | 豊富（作成者、修正者、代理、所有者等） |
| **選択肢フィールド** | 文字列 | Picklist（定義済み選択肢） |

---

## 5. APIエンドポイント対応

### AWS API Gateway

| エンドポイント | メソッド | 説明 |
|---------------|----------|------|
| `/clients` | GET, POST | 取引先（企業/個人） |
| `/brands` | GET, POST | ブランド |
| `/stores` | GET, POST, PUT, DELETE | 店舗情報 |
| `/schedules` | GET, POST, PUT, DELETE | スケジュール |
| `/workers` | GET, POST | メンバー/清掃員 |
| `/reports` | GET, POST, PUT, DELETE | 現場報告 |
| `/tasks` | GET, POST | タスク |
| `/users` | GET, POST | ユーザー |
| `/services` | GET, POST | サービス |

### Azure Dataverse REST API

- エンドポイント: `https://org301211e2.crm7.dynamics.com/api/data/v9.2/`
- 認証: Azure AD OAuth 2.0
- テーブル名: `cr365_` プレフィックス付きの論理名

---

## 6. 移行時の考慮事項

### 6.1 ID変換
- AWS側の連番/カスタムIDをAzure GUIDにマッピング
- マッピングテーブルの作成が必要

### 6.2 リレーション変換
- 文字列参照 → Lookup型への変換
- 参照先レコードのGUID取得が必要

### 6.3 写真管理
- AWS: S3 URL配列
- Azure: 単一ファイル or 別テーブル（添付ファイル）
- **要確認**: Azure側の複数写真対応方針

### 6.4 住所フィールド
- AWS: 分割（pref, city, address1, address2）
- Azure: 統合（address）
- **要確認**: どちらに統一するか

---

## 7. 結論

| 観点 | 評価 |
|------|------|
| **基本構造** | 85%一致 |
| **コアテーブル** | 完全対応（clients/brands/stores/schedules/workers/reports） |
| **追加テーブル** | Azure側に10テーブル追加あり |
| **移行難易度** | 低〜中（ID変換とLookup対応が必要） |

---

## 8. 推奨アクション

1. **エンジニア確認事項**
   - 「ユニット」「店舗担当者」等の追加テーブルの必要性
   - 写真管理の方針（Azure側を複数対応にするか、別テーブルにするか）
   - 住所フィールドの統合/分割方針

2. **AWS側追加実装候補**
   - GoogleMAPフィールド
   - 利用開始日フィールド
   - 保管フォルダフィールド

3. **データ移行準備**
   - IDマッピングテーブル設計
   - Lookup変換スクリプト作成
   - 写真データ移行方針決定

---

## 9. ロール別情報開示レベル

### 9.1 ロール定義

| ロール | 説明 | 主な用途 |
|--------|------|---------|
| **master** | マスター | システム全体管理 |
| **developer** | 開発者 | 開発・デバッグ |
| **admin** | 管理者 | 日常運用管理 |
| **concierge** | コンシェルジュ/営業 | 顧客対応・営業活動 |
| **staff** | 清掃員 | 現場作業 |
| **customer** | 顧客 | サービス利用 |
| **guest** | ゲスト | 未ログイン |

### 9.2 情報開示マトリクス

| 情報項目 | 管理者 | 営業 | 清掃員 | 顧客 |
|---------|--------|------|--------|------|
| 企業基本情報 | ✅ | ✅ | ❌ | 自社のみ |
| 担当者情報 | ✅ | ✅ | ❌ | 自社のみ |
| 契約情報（金額） | ✅ | ❌ | ❌ | 自社のみ |
| 営業メモ | ✅ | ✅ | ❌ | ❌ |
| 店舗基本情報 | ✅ | ✅ | 担当のみ | 自社のみ |
| 提出資料 | ✅ | ❌ | ❌ | 自社のみ |
| 鍵情報 | ✅ | ❌ | 担当のみ | 自社のみ |
| 見積もり履歴 | ✅ | ✅ | ❌ | 自社のみ |
| スケジュール | ✅ | ✅ | 担当のみ | 自社のみ |
| レポート | ✅ | ✅ | 自分のみ | 自社のみ |
| 編集権限 | ✅ | ❌ | ❌ | 自社のみ |
| 削除権限 | ✅ | ❌ | ❌ | ❌ |
| 承認権限 | ✅ | ❌ | ❌ | ❌ |

### 9.3 実装ファイル

- `/assets/js/role_permissions.js` - ロール別権限定義
- `/assets/js/role_config.js` - ロール設定とページアクセス制御
- `/assets/js/auth.js` - 認証システム

---

## 10. 3層構造の顧客管理

### 10.1 階層構造

```
取引先（企業/個人）- 第1層
  └─ ブランド（店舗名/屋号）- 第2層
       └─ 店舗（実店舗/支店）- 第3層
```

### 10.2 データリンクルール

| データ種別 | リンク先 | フォールバック |
|-----------|---------|---------------|
| **契約** | 第1層（企業） | - |
| **見積もり** | 第3層（店舗） | 第2層 → 第1層 |
| **スケジュール** | 第3層（店舗） | 第2層 → 第1層 |
| **レポート** | 第3層（店舗） | 第2層 → 第1層 |

### 10.3 詳細画面URL

| 画面 | URL | 内容 |
|------|-----|------|
| 企業詳細 | `/admin/clients/detail.html?id=xxx` | 法人情報、ブランド一覧、契約情報 |
| ブランド詳細 | `/admin/brands/detail.html?id=xxx` | ブランド情報、店舗一覧 |
| 店舗詳細 | `/admin/stores/detail.html?id=xxx` | 店舗情報、見積もり、スケジュール、レポート |

---

## 付録: Azure Dataverse接続情報

| 項目 | 値 |
|------|-----|
| Dataverse URL | `https://org301211e2.crm7.dynamics.com` |
| テナントID | `5b6708dd-63da-4845-b3e5-21a2bc0ba41a` |
| クライアントID | `e870c96d-7645-4ef9-a6e1-ffb5b59c6456` |
| Schema Viewer | `https://sou.works/dataverse-schema/public/` |

