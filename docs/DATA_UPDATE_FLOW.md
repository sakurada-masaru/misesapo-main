# データ更新の流れ

## 📋 ユーザー情報変更の流れ

### ブラウザでユーザー情報を変更した場合

```
1. ユーザーがフォームで情報を変更
   ↓
2. 「保存」ボタンをクリック
   ↓
3. ブラウザ → APIに申告（PUTリクエスト）
   ↓
4. API（受付）が処理を確認
   ↓
5. API → データベース（貯蔵庫）に保存
   ↓
6. API → ブラウザに認可（成功レスポンス）を返す
   ↓
7. ブラウザが認可を受け取る
   ↓
8. ブラウザがAPIから最新データを取得
   ↓
9. ブラウザの画面を更新
```

---

## ⚠️ 重要なポイント

### 認可が降りるまでブラウザ情報は変更されない

**現在の実装**:
- APIが成功レスポンス（`response.ok`）を返すまで、ブラウザの表示は**変更されません**
- フォームの入力内容はそのまま表示されますが、データベースには保存されていません
- APIからの認可（成功レスポンス）が降りたら、APIから最新データを取得して画面を更新します

**理由**:
- データの整合性を保つため
- エラーが発生した場合、元の状態に戻せるため
- ユーザーに「保存中...」などの状態を表示できるため

---

## 🔍 実装の詳細

### ユーザー詳細画面での編集

```javascript
// 1. フォーム送信
const response = await fetch(`${API_BASE}/workers/${currentUser.id}`, {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(data)  // 変更内容をAPIに送信
});

// 2. APIからの認可を待つ
if (response.ok) {
  // 3. 認可が降りたら、最新データを取得して画面を更新
  setTimeout(async () => {
    currentUser = null;  // キャッシュをクリア
    await loadUser();    // APIから最新データを取得
    closeEditModal();    // 編集モーダルを閉じる
  }, 500);
}
```

### ユーザー一覧画面での編集

```javascript
// 1. フォーム送信
const response = await fetch(`${API_BASE}/workers/${data.id}`, {
  method: 'PUT',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(data)
});

// 2. APIからの認可を待つ
if (response.ok) {
  // 3. 認可が降りたら、リストを更新
  setTimeout(async () => {
    await loadUsers();  // APIから最新データを取得してリストを更新
  }, 500);
}
```

---

## 📊 タイムライン

```
時刻    動作
─────────────────────────────────────
T0      ユーザーがフォームで情報を変更
T1      「保存」ボタンをクリック
T2      ブラウザ → APIにリクエスト送信
T3      APIが処理中（データベースに保存中）
T4      API → ブラウザに成功レスポンス（認可）
T5      ブラウザが最新データを取得
T6      ブラウザの画面を更新
```

**T2〜T4の間**: ブラウザの表示は変更されない（「保存中...」と表示される場合がある）

**T4以降**: APIからの認可が降りたので、最新データを取得して画面を更新

---

## ✅ まとめ

1. **データの変更は必ずAPIを通る**
   - ブラウザ → API（受付）→ データベース（貯蔵庫）

2. **認可が降りるまでブラウザ情報は変更されない**
   - APIが成功レスポンスを返すまで、画面は更新されない
   - これにより、データの整合性が保たれる

3. **認可が降りたら最新データを取得**
   - APIから最新データを取得して画面を更新
   - これにより、常に正確なデータが表示される

