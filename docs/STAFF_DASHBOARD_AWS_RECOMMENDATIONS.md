# 清掃員ダッシュボード機能のAWS活用提案

## 概要

実装した清掃員ダッシュボード機能について、AWSサービスを活用した本番運用のための提案と質問事項をまとめます。

## 実装済み機能の整理

### 1. オフライン対応の可視化
- **現状**: クライアント側で`navigator.onLine`を監視
- **課題**: オフライン時のデータ保存はlocalStorageのみ

### 2. 音声・バイブレーション通知
- **現状**: クライアント側のWeb APIを使用
- **課題**: サーバー側からの通知が必要な場合の対応

### 3. レイアウト切り替えオプション
- **現状**: localStorageに保存
- **課題**: デバイス間での設定同期

### 4. 作業レポート作成（オフライン対応含む）
- **現状**: localStorageに保存、オフライン時は送信待ち
- **課題**: バックエンドAPIとの連携、写真アップロード

---

## AWS活用提案

### 🔴 優先度：高（必須）

#### 1. **作業レポートの保存・送信（DynamoDB + Lambda + API Gateway）**

**現状の問題点:**
- localStorageのみではデータが失われるリスク
- オフライン時のデータがデバイスに依存
- 写真のアップロードが未実装

**提案するAWS構成:**
```
[クライアント] 
  ↓ (オフライン時)
[localStorage] → [Service Worker] → [IndexedDB]
  ↓ (オンライン時)
[Lambda + API Gateway] → [DynamoDB] (レポートデータ)
                      → [S3] (写真)
```

**必要な情報:**
- [ ] レポートデータの構造（どのフィールドが必要か）
- [ ] 写真の最大サイズ・枚数制限
- [ ] レポートの保存期間・アーカイブポリシー
- [ ] ユーザー認証方法（既存の認証システムは？）

**実装すべき機能:**
- [ ] Lambda関数: `POST /staff/reports` - レポート作成
- [ ] Lambda関数: `GET /staff/reports` - レポート一覧取得
- [ ] Lambda関数: `GET /staff/reports/{id}` - レポート詳細取得
- [ ] S3バケット: レポート写真の保存
- [ ] DynamoDBテーブル: レポートメタデータの保存

**質問事項:**
1. ✅ **回答済み**: レポートの閲覧権限は、ユーザー・清掃員・管理者
2. レポートの検索・フィルタリング要件は？
3. ✅ **回答済み**: 写真サイズはスマホ画面で水平方向に2枚配置できる程度（約800px幅推奨）
4. ✅ **回答済み**: 認証システムはGoogle Firebaseでロール認証

**実装計画**: 詳細は `STAFF_REPORTS_IMPLEMENTATION_PLAN.md` を参照

---

#### 2. **オフライン同期機能（Service Worker + Background Sync API）**

**現状の問題点:**
- オフライン時のデータが手動で同期される必要がある
- ネットワーク復帰時の自動送信がない

**提案するAWS構成:**
```
[Service Worker]
  ↓ (Background Sync)
[Lambda + API Gateway] → [DynamoDB]
```

**必要な情報:**
- [ ] オフライン時のデータ保持期間
- [ ] 同期の優先順位（レポート > 設定 > その他）
- [ ] 同期失敗時のリトライポリシー

**実装すべき機能:**
- [ ] Service Workerの実装
- [ ] Background Sync APIの活用
- [ ] 同期状態の可視化（ダッシュボードに表示）

**質問事項:**
1. オフライン時のデータはどのくらい保持するか？（7日？30日？）
2. 同期失敗時の通知方法は？（プッシュ通知？メール？）

---

### 🟡 優先度：中（推奨）

#### 3. **プッシュ通知（AWS SNS + Service Worker）**

**現状の問題点:**
- ブラウザを閉じていると通知が届かない
- サーバー側からの通知ができない

**提案するAWS構成:**
```
[管理者/システム]
  ↓
[AWS SNS] → [FCM/APNS] → [Service Worker] → [ブラウザ通知]
```

**必要な情報:**
- [ ] 通知の種類（作業開始リマインダー、緊急連絡、レポート承認など）
- [ ] 通知の優先度（緊急、通常、低）
- [ ] 通知の配信先（個人？グループ？）

**実装すべき機能:**
- [ ] Service Workerでのプッシュ通知受信
- [ ] Lambda関数: 通知送信API
- [ ] SNSトピックの設定
- [ ] FCM/APNSの設定（モバイルアプリ化する場合）

**質問事項:**
1. プッシュ通知は必須機能か？それとも将来的な拡張か？
2. モバイルアプリ（iOS/Android）の開発予定はあるか？

---

#### 4. **設定のクラウド同期（DynamoDB）**

**現状の問題点:**
- 設定がデバイスごとに独立
- デバイスを変えると設定が引き継がれない

**提案するAWS構成:**
```
[クライアント] → [Lambda + API Gateway] → [DynamoDB]
```

**必要な情報:**
- [ ] 同期する設定項目（レイアウト、通知設定、メニューボタン位置など）
- [ ] 設定の優先順位（クラウド > ローカル？）

**実装すべき機能:**
- [ ] Lambda関数: `GET /staff/settings` - 設定取得
- [ ] Lambda関数: `PUT /staff/settings` - 設定保存
- [ ] 設定の自動同期（ログイン時、変更時）

**質問事項:**
1. 設定の同期は必須機能か？
2. 複数デバイスでの同時利用は想定しているか？

---

#### 5. **作業スケジュールのリアルタイム更新（DynamoDB Streams + WebSocket）**

**現状の問題点:**
- スケジュールの変更がリアルタイムで反映されない
- ページをリロードしないと最新情報が取得できない

**提案するAWS構成:**
```
[管理者]
  ↓
[DynamoDB] → [DynamoDB Streams] → [Lambda] → [API Gateway WebSocket] → [クライアント]
```

**必要な情報:**
- [ ] スケジュール変更の頻度
- [ ] リアルタイム更新の必要性

**実装すべき機能:**
- [ ] API Gateway WebSocket API
- [ ] DynamoDB Streamsの設定
- [ ] クライアント側のWebSocket接続

**質問事項:**
1. スケジュールのリアルタイム更新は必須か？
2. ポーリング（定期的な取得）で代替可能か？

---

### 🟢 優先度：低（将来的な拡張）

#### 6. **分析・レポート機能（AWS QuickSight + Athena）**

**提案:**
- 作業レポートの集計・分析
- 作業効率の可視化
- トレンド分析

**必要な情報:**
- [ ] 分析したい指標（作業時間、完了率、品質評価など）
- [ ] レポートの出力形式（ダッシュボード、PDF、Excelなど）

---

#### 7. **位置情報の記録・分析（Amazon Location Service）**

**提案:**
- 作業現場への到着・退場時刻の自動記録
- 作業ルートの最適化
- 地理的範囲の分析

**必要な情報:**
- [ ] 位置情報の記録頻度
- [ ] プライバシー要件

---

## 質問事項まとめ

### 必須回答項目

1. **認証・認可**
   - [ ] 現在の認証システムは何を使用しているか？（Cognito？独自？）
   - [ ] 清掃員の識別方法は？（ユーザーID？メールアドレス？）

2. **データ構造**
   - [ ] 作業レポートに必要な全フィールドは？
   - [ ] 写真の最大サイズ・枚数は？
   - [ ] レポートの保存期間は？

3. **機能要件**
   - [ ] オフライン対応はどの程度重要か？（必須？推奨？）
   - [ ] プッシュ通知は必要か？
   - [ ] リアルタイム更新は必要か？

4. **運用要件**
   - [ ] 想定ユーザー数は？
   - [ ] 1日のレポート作成数は？
   - [ ] データのバックアップ要件は？

5. **コスト要件**
   - [ ] 月間のAWS利用予算は？
   - [ ] コスト最適化の優先度は？

---

## 推奨実装順序

### Phase 1: 基本機能（1-2週間）
1. 作業レポートの保存・送信（DynamoDB + Lambda + API Gateway）
2. 写真アップロード（S3）
3. オフライン同期の基本実装（Service Worker）

### Phase 2: 通知機能（1週間）
1. プッシュ通知の実装（SNS + Service Worker）
2. 通知設定の保存（DynamoDB）

### Phase 3: 高度な機能（2-3週間）
1. 設定のクラウド同期
2. リアルタイム更新（WebSocket）
3. 分析・レポート機能

---

## コスト見積もり（月額）

### 最小構成（100ユーザー、1日10レポート/ユーザー）
- **DynamoDB**: 約$5-10（オンデマンド課金）
- **S3**: 約$1-5（写真保存、10GB想定）
- **Lambda**: 約$1-3（100万リクエスト/月）
- **API Gateway**: 約$3-5（100万リクエスト/月）
- **合計**: 約$10-23/月

### 標準構成（500ユーザー、1日20レポート/ユーザー）
- **DynamoDB**: 約$20-40
- **S3**: 約$10-20（50GB想定）
- **Lambda**: 約$5-10
- **API Gateway**: 約$10-20
- **SNS**: 約$1-5（通知送信）
- **合計**: 約$46-95/月

---

## 次のステップ

1. **質問事項への回答をいただく**
2. **要件定義書の作成**
3. **AWS構成図の作成**
4. **実装計画の詳細化**
5. **プロトタイプの開発**

---

## 参考資料

- [AWS Lambda + API Gateway セットアップ](AWS_LAMBDA_API_GATEWAY_SETUP.md)
- [DynamoDB ベストプラクティス](https://docs.aws.amazon.com/ja_jp/amazondynamodb/latest/developerguide/best-practices.html)
- [Service Worker API](https://developer.mozilla.org/ja/docs/Web/API/Service_Worker_API)

