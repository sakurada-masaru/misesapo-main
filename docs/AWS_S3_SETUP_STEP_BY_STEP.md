# AWS S3 設定ガイド（ステップバイステップ）

このガイドでは、AWS S3を使って画像をアップロードできるようにするための設定を、画面のスクリーンショット付きで詳しく説明します。

## 前提条件

- AWSアカウントを持っていること
- ブラウザでAWS Consoleにアクセスできること

---

## ステップ1: AWS Consoleにログイン

1. **ブラウザで以下のURLを開く**
   ```
   https://console.aws.amazon.com/
   ```

2. **AWSアカウントでログイン**
   - メールアドレスとパスワードを入力
   - 2要素認証が設定されている場合は、コードを入力

3. **ログイン後、右上のリージョンを確認**
   - 例: `アジアパシフィック (東京) ap-northeast-1`
   - もし違うリージョンが選択されている場合は、クリックして `アジアパシフィック (東京) ap-northeast-1` を選択

---

## ステップ2: S3バケットを作成

### 2-1. S3サービスを開く

1. 画面上部の検索バーに「**S3**」と入力
2. 検索結果から「**S3**」をクリック

### 2-2. バケットを作成

1. **「バケットを作成」** ボタンをクリック（画面右上または中央）

2. **「一般設定」** セクション:
   - **バケット名**: `misesapo-cleaning-manual-images` と入力
     - ⚠️ 注意: バケット名は世界中で一意である必要があります
     - もしエラーが出たら、末尾に数字を追加してください（例: `misesapo-cleaning-manual-images-2024`）

3. **「AWS リージョン」**:
   - `アジアパシフィック (東京) ap-northeast-1` を選択

4. **「オブジェクト所有者」**:
   - デフォルトのままでOK（「ACL は無効」が選択されているはず）

5. **「このバケットのパブリックアクセス設定をブロック」** セクション:
   - ⚠️ **重要**: 以下の4つのチェックボックスを**すべて外す**必要があります
     - ☐ 「新しいパブリックバケットポリシーをブロックする」
     - ☐ 「パブリックアクセスを許可するバケットポリシーを通じて付与されたパブリックおよびクロスアカウントアクセスをブロックする」
     - ☐ 「新しいパブリック ACL と、パブリックオブジェクトのアップロードをブロックする」
     - ☐ 「パブリック ACL を通じて付与されたパブリックおよびクロスアカウントアクセスをブロックする」
   - 警告メッセージが表示されますが、「**了解しました**」にチェックを入れて進みます

6. **「バケットのバージョニング」**:
   - 「バージョニングを有効にする」は**オフ**のままでOK

7. **「デフォルトの暗号化」**:
   - デフォルトのままでOK

8. **「高度な設定」**:
   - デフォルトのままでOK

9. **「バケットを作成」** ボタンをクリック

10. **「このバケットを作成しました」** というメッセージが表示されたら成功です
    - 「バケットを表示」をクリックして、作成したバケットを確認

---

## ステップ3: CORS設定を適用

### 3-1. バケットを選択

1. S3のバケット一覧から、作成した `misesapo-cleaning-manual-images` をクリック

### 3-2. CORS設定を編集

1. 画面上部のタブから **「アクセス許可」** タブをクリック

2. 下にスクロールして **「クロスオリジンリソース共有 (CORS)」** セクションを見つける

3. **「編集」** ボタンをクリック

4. エディタに以下のJSONをコピー&ペースト:

```json
[
    {
        "AllowedHeaders": [
            "*"
        ],
        "AllowedMethods": [
            "GET",
            "PUT",
            "POST",
            "DELETE",
            "HEAD"
        ],
        "AllowedOrigins": [
            "*"
        ],
        "ExposeHeaders": [
            "ETag"
        ],
        "MaxAgeSeconds": 3000
    }
]
```

5. **「変更を保存」** ボタンをクリック

---

## ステップ4: バケットポリシーを設定（読み取りを許可）

### 4-1. バケットポリシーを編集

1. 同じ **「アクセス許可」** タブで、**「バケットポリシー」** セクションを見つける

2. **「編集」** ボタンをクリック

3. エディタに以下のJSONをコピー&ペースト（`YOUR_BUCKET_NAME`を実際のバケット名に置き換える）:

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PublicReadGetObject",
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::misesapo-cleaning-manual-images/*"
        }
    ]
}
```

**注意**: `misesapo-cleaning-manual-images` の部分を、実際に作成したバケット名に置き換えてください。

4. **「変更を保存」** ボタンをクリック

---

## ステップ5: IAMユーザーを作成（APIキー取得）

### 5-1. IAMサービスを開く

1. 画面上部の検索バーに「**IAM**」と入力
2. 検索結果から「**IAM**」をクリック

### 5-2. ユーザーを作成

1. 左メニューから **「ユーザー」** をクリック

2. **「ユーザーを追加」** ボタンをクリック（画面右上）

3. **「ユーザー名」** を入力:
   - 例: `misesapo-s3-uploader`

4. **「AWS 認証情報タイプの選択」** セクション:
   - ☑ **「プログラムによるアクセス」** にチェックを入れる
   - 「AWS Management Console へのアクセス」はチェックを**外す**

5. **「次のステップ: アクセス権限」** をクリック

### 5-3. アクセス権限を設定

1. **「既存のポリシーを直接アタッチ」** を選択

2. 検索バーに「**S3**」と入力

3. **「AmazonS3FullAccess」** を検索して、チェックボックスに☑を入れる
   - ⚠️ 注意: より細かい権限設定も可能ですが、まずはこれで動作確認してください

4. **「次のステップ: タグ」** をクリック

5. **「次のステップ: 確認」** をクリック

6. 設定を確認して、**「ユーザーの作成」** をクリック

### 5-4. アクセスキーを保存

1. **重要**: 次の画面で以下の情報が表示されます：
   - **アクセスキー ID**
   - **シークレットアクセスキー**

2. **「.csv のダウンロード」** をクリックして、CSVファイルを保存
   - または、**「表示」** をクリックして、両方のキーをコピーして安全な場所に保存

3. ⚠️ **警告**: この画面を閉じると、シークレットアクセスキーは二度と表示されません
   - 必ず保存してください！

4. **「完了」** をクリック

---

## ステップ6: 環境変数を設定

### 6-1. .envファイルを作成

1. プロジェクトルート（`/Users/sakuradamasaru/Desktop/misesapo-main/`）に `.env` ファイルを作成

2. 以下の内容を記入（実際の値に置き換える）:

```bash
# AWS S3設定
AWS_ACCESS_KEY_ID=ここにアクセスキーIDを貼り付け
AWS_SECRET_ACCESS_KEY=ここにシークレットアクセスキーを貼り付け
AWS_S3_BUCKET_NAME=misesapo-cleaning-manual-images
AWS_S3_REGION=ap-northeast-1
```

**例**:
```bash
# AWS S3設定
AWS_ACCESS_KEY_ID=AKIAIOSFODNN7EXAMPLE
AWS_SECRET_ACCESS_KEY=wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
AWS_S3_BUCKET_NAME=misesapo-cleaning-manual-images
AWS_S3_REGION=ap-northeast-1
```

3. ファイルを保存

### 6-2. .gitignoreに追加（重要）

`.env` ファイルには機密情報が含まれているため、Gitにコミットしないようにします。

1. プロジェクトルートの `.gitignore` ファイルを開く（なければ作成）

2. 以下の行を追加:

```
.env
```

---

## ステップ7: Pythonライブラリをインストール

ターミナルで以下のコマンドを実行:

```bash
pip3 install boto3 python-dotenv
```

---

## ステップ8: 動作確認

### 8-1. 開発サーバーを起動

```bash
cd /Users/sakuradamasaru/Desktop/misesapo-main
python3 scripts/dev_server.py
```

### 8-2. ログを確認

サーバー起動時に、以下のようなメッセージが表示されれば成功です:

```
[DevServer] AWS S3 configured: bucket=misesapo-cleaning-manual-images, region=ap-northeast-1
```

もし以下のメッセージが表示された場合:
- `[DevServer] AWS S3 not configured. Using local storage.` → `.env` ファイルの設定を確認
- `[DevServer] boto3 not installed.` → `pip3 install boto3 python-dotenv` を実行

### 8-3. 画像アップロードをテスト

1. ブラウザで `http://localhost:5173/cleaning-manual-admin.html` にアクセス
2. ログイン
3. 項目を編集して画像をアップロード
4. アップロードが成功すれば、S3のURLが表示されます

---

## トラブルシューティング

### エラー: "Access Denied"

- IAMユーザーの権限を確認
- バケットポリシーが正しく設定されているか確認

### エラー: "Bucket does not exist"

- バケット名が正しいか確認（`.env` ファイルの `AWS_S3_BUCKET_NAME`）

### エラー: "InvalidAccessKeyId"

- `.env` ファイルの `AWS_ACCESS_KEY_ID` が正しいか確認

### エラー: "SignatureDoesNotMatch"

- `.env` ファイルの `AWS_SECRET_ACCESS_KEY` が正しいか確認

### CORSエラー

- S3バケットのCORS設定を確認
- ブラウザのキャッシュをクリア（`Cmd+Shift+R`）

---

## 次のステップ

設定が完了したら、画像アップロード機能が正常に動作するはずです。問題があれば、エラーメッセージを確認して、上記のトラブルシューティングを参照してください。

