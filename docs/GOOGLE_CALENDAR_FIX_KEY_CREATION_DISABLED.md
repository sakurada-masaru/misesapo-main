# サービスアカウントキー作成が無効な場合の修正方法

## 問題の原因

画像から確認できるように、以下の状況です：

1. **マネージド版のポリシー**（`iam.managed.disableServiceAccountKeyCreation`）は「未適用」
2. **しかし、古い版のポリシー**（`iam.disableServiceAccountKeyCreation`）が有効になっている
3. 両方の制約が同時に評価されるため、古い版がキー作成をブロックしている

## 解決方法

### 方法1: 古いポリシーで例外を設定（推奨）

1. **古いポリシーを開く**
   - 検索バーに `iam.disableServiceAccountKeyCreation` と入力（`managed` を**含めない**）
   - `constraints/iam.disableServiceAccountKeyCreation` をクリック

2. **ポリシーを管理**
   - 「ポリシーを管理」ボタンをクリック

3. **プロジェクトに対して例外を設定**
   - 「カスタマイズ」を選択
   - 「ポリシーを強制」を選択
   - 「例外を追加」をクリック
   - **プロジェクトID**: `teikisesiou-tesuto` を入力
   - 「保存」をクリック

### 方法2: 古いポリシーを無効化（組織全体）

**注意**: セキュリティ上の理由から、組織全体で無効化するのは推奨されません。方法1を推奨します。

1. **古いポリシーを開く**
   - 検索バーに `iam.disableServiceAccountKeyCreation` と入力
   - `constraints/iam.disableServiceAccountKeyCreation` をクリック

2. **ポリシーを管理**
   - 「ポリシーを管理」ボタンをクリック

3. **ポリシーを無効化**
   - 「ポリシーを無効にする」を選択
   - 「保存」をクリック

### 方法3: マネージド版に移行して例外を設定

1. **マネージド版のポリシーを開く**
   - 検索バーに `iam.managed.disableServiceAccountKeyCreation` と入力
   - `constraints/iam.managed.disableServiceAccountKeyCreation` をクリック

2. **ポリシーを管理**
   - 「ポリシーを管理」ボタンをクリック

3. **プロジェクトに対して例外を設定**
   - 「カスタマイズ」を選択
   - 「ポリシーを強制」を選択
   - 「例外を追加」をクリック
   - **プロジェクトID**: `teikisesiou-tesuto` を入力
   - 「保存」をクリック

4. **古いポリシーも確認**
   - 方法1または方法2で古いポリシーも設定する必要があります

## 推奨される手順

**方法1（古いポリシーで例外を設定）を推奨します。**

理由：
- セキュリティを維持しながら、特定のプロジェクトでのみキー作成を許可できる
- 組織全体のセキュリティポリシーに影響を与えない

## 設定後の確認

1. **ブラウザをリフレッシュ**
   - ポリシーの変更が反映されるまで数分かかる場合があります

2. **サービスアカウントキーの作成を試す**
   - 「IAMと管理」→「サービスアカウント」を選択
   - サービスアカウントを選択（なければ作成）
   - 「キー」タブ→「キーを追加」→「新しいキーを作成」
   - JSON形式を選択→「作成」

3. **エラーが表示されないことを確認**
   - キーが正常に作成され、JSONファイルがダウンロードされることを確認

## トラブルシューティング

### まだ「キーの作成無効状態」と表示される場合

1. **ブラウザをリフレッシュ**
   - ポリシーの変更が反映されるまで数分待つ

2. **両方のポリシーを確認**
   - 古い版（`iam.disableServiceAccountKeyCreation`）
   - マネージド版（`iam.managed.disableServiceAccountKeyCreation`）
   - 両方で例外が設定されているか確認

3. **プロジェクトIDが正しいか確認**
   - 例外に設定したプロジェクトIDが `teikisesiou-tesuto` であることを確認

4. **シークレットモードで試す**
   - ブラウザのキャッシュが原因の可能性があるため、シークレットモードで試す

