# 公開リポジトリのセキュリティリスク評価

**作成日**: 2025年12月10日  
**目的**: 公開リポジトリのセキュリティリスクを評価し、対策を提案

---

## 🚨 発見されたセキュリティリスク

### 1. ハードコードされたパスワード（高リスク）

**場所**: `src/pages/admin/services/review.html`

```javascript
const DEV_PASSWORD = 'misesapo1234'; // 開発用パスワード
```

**リスク**:
- ⚠️ **高リスク**: パスワードがコードに含まれている
- ⚠️ 誰でもこのパスワードを知ることができる
- ⚠️ 開発者専用レビューページへの不正アクセスの可能性

**影響範囲**:
- `/admin/services/review.html` へのアクセス
- Git操作（コミット、プッシュ）の実行

**対策**:
- ✅ 環境変数または設定ファイルから取得（`.env`を使用）
- ✅ 本番環境では別のパスワードを使用
- ✅ パスワードをハッシュ化して保存

---

### 2. APIエンドポイントURLの公開（中リスク）

**場所**: `src/assets/js/cognito_auth.js`

```javascript
const apiBaseUrl = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';
```

**リスク**:
- ⚠️ **中リスク**: APIエンドポイントが公開されている
- ⚠️ エンドポイントへの直接アクセスが可能
- ⚠️ DDoS攻撃の標的になる可能性

**影響範囲**:
- API Gatewayへのアクセス
- レート制限や認証が適切に設定されているか確認が必要

**対策**:
- ✅ API Gatewayでレート制限を設定
- ✅ 認証・認可を適切に実装
- ✅ WAF（Web Application Firewall）の導入を検討
- ✅ 環境変数から取得するように変更（推奨）

---

### 3. 開発用パスワードの平文保存（中リスク）

**場所**: `scripts/dev_server.py`

```python
# パスワードチェック（現在は平文、後でハッシュ化）
if user.get('password') != password:
```

**リスク**:
- ⚠️ **中リスク**: パスワードが平文で保存されている
- ⚠️ データベースが漏洩した場合、パスワードがそのまま見える

**影響範囲**:
- 開発サーバーのユーザー認証
- ローカルデータベース（JSONファイル）

**対策**:
- ✅ パスワードをハッシュ化（bcrypt推奨）
- ✅ 本番環境では適切な認証システムを使用（既に実装済み：Firebase/Cognito）

---

## ✅ 適切に保護されている情報

### 1. 機密情報の除外

**`.gitignore`で除外されている**:
- ✅ `.env` ファイル（環境変数）
- ✅ `firebase-service-account.json`（Firebase認証情報）
- ✅ `*.zip`（デプロイファイル）

### 2. 認証システム

**適切に実装されている**:
- ✅ Firebase Authentication（お客様用）
- ✅ AWS Cognito（従業員用）
- ✅ 認証情報は環境変数またはAWS Secrets Managerから取得

### 3. API認証

**適切に実装されている**:
- ✅ Lambda関数で認証トークンを検証
- ✅ 認証情報はAWS Secrets Managerから取得（Google Calendar APIなど）

---

## 🎯 セキュリティリスクの総合評価

### リスクレベル

| リスク | レベル | 緊急度 | 対策の優先度 |
|--------|--------|--------|--------------|
| ハードコードされたパスワード | 🔴 高 | 高 | 最優先 |
| APIエンドポイントURLの公開 | 🟡 中 | 中 | 中 |
| 開発用パスワードの平文保存 | 🟡 中 | 低 | 低 |

### 総合評価

**現状**: 🟡 **中リスク**

- ✅ 機密情報（APIキー、認証情報）は適切に保護されている
- ⚠️ 開発用パスワードがコードに含まれている
- ⚠️ APIエンドポイントが公開されている（認証・認可で保護されているが、対策が必要）

---

## 🛡️ 推奨される対策

### 即座に対応すべき対策（最優先）

#### 1. ハードコードされたパスワードの削除

**対策**:
```javascript
// 修正前
const DEV_PASSWORD = 'misesapo1234';

// 修正後
const DEV_PASSWORD = process.env.REVIEW_PASSWORD || '';
// または
const DEV_PASSWORD = window.REVIEW_PASSWORD || '';
```

**実装方法**:
1. 環境変数から取得するように変更
2. 本番環境では別のパスワードを使用
3. パスワードをハッシュ化して保存

#### 2. APIエンドポイントURLの環境変数化

**対策**:
```javascript
// 修正前
const apiBaseUrl = 'https://51bhoxkbxd.execute-api.ap-northeast-1.amazonaws.com/prod';

// 修正後
const apiBaseUrl = process.env.API_BASE_URL || window.API_BASE_URL || '';
```

**実装方法**:
1. 環境変数から取得するように変更
2. ビルド時に環境変数を注入
3. 本番環境と開発環境で異なるURLを使用

---

### 中期対策

#### 1. パスワードのハッシュ化

**対策**:
- 開発サーバーのパスワードをbcryptでハッシュ化
- 認証時にハッシュを比較

#### 2. API Gatewayのセキュリティ強化

**対策**:
- レート制限の設定
- WAF（Web Application Firewall）の導入
- IP制限の検討

#### 3. セキュリティ監査の実施

**対策**:
- 定期的なセキュリティ監査
- 依存関係の脆弱性チェック
- コードレビューでのセキュリティチェック

---

### 長期対策

#### 1. セキュリティポリシーの策定

**対策**:
- セキュリティガイドラインの作成
- 開発者向けセキュリティ教育
- 定期的なセキュリティトレーニング

#### 2. 自動セキュリティチェック

**対策**:
- GitHub Actionsでの自動セキュリティスキャン
- Dependabotの有効化
- セキュリティアラートの設定

---

## 📋 チェックリスト

### 公開リポジトリにする前に確認すべき項目

- [ ] 機密情報（APIキー、パスワード、トークン）が含まれていない
- [ ] `.env` ファイルが `.gitignore` に含まれている
- [ ] 認証情報が環境変数またはSecrets Managerから取得されている
- [ ] ハードコードされたパスワードがない
- [ ] APIエンドポイントが適切に保護されている
- [ ] データベース接続情報が含まれていない
- [ ] 個人情報（顧客データなど）が含まれていない

### 現在の状態

- [x] `.env` ファイルが `.gitignore` に含まれている
- [x] `firebase-service-account.json` が `.gitignore` に含まれている
- [x] 認証情報は環境変数またはSecrets Managerから取得されている
- [ ] **ハードコードされたパスワードがある**（要修正）
- [ ] **APIエンドポイントURLが公開されている**（要対策）
- [x] データベース接続情報が含まれていない
- [x] 個人情報（顧客データなど）が含まれていない

---

## 🎯 MDCSの論理に基づくセキュリティ対策

### システムの流れ：う→あ→お→え→い

1. **『う』（存在）**: システムの存在そのもの
   - **セキュリティ**: システム全体のセキュリティポリシー
   - **対策**: セキュリティガイドラインの策定

2. **『あ』（主観）**: 開発者（伝え手）
   - **セキュリティ**: 開発者のセキュリティ意識
   - **対策**: セキュリティ教育、コードレビュー

3. **『お』（経験知識）**: セキュリティベストプラクティス
   - **セキュリティ**: 知識の蓄積と共有
   - **対策**: セキュリティドキュメントの整備

4. **『え』（選択）**: セキュリティ対策の選択
   - **セキュリティ**: 適切な対策の選択
   - **対策**: リスク評価に基づく対策の優先順位付け

5. **『い』（実行）**: セキュリティ対策の実装
   - **セキュリティ**: 対策の実装と監視
   - **対策**: 自動セキュリティチェック、監視

---

## 📝 まとめ

### 現状の評価

**総合評価**: 🟡 **中リスク**

- ✅ 機密情報（APIキー、認証情報）は適切に保護されている
- ⚠️ 開発用パスワードがコードに含まれている（要修正）
- ⚠️ APIエンドポイントが公開されている（認証・認可で保護されているが、対策が必要）

### 推奨される対応

1. **即座に対応**: ハードコードされたパスワードの削除
2. **中期対応**: APIエンドポイントURLの環境変数化
3. **長期対応**: セキュリティポリシーの策定、自動セキュリティチェック

### 公開リポジトリの維持について

**結論**: 公開リポジトリを維持することは可能ですが、以下の対策が必要です：

1. ✅ ハードコードされたパスワードの削除
2. ✅ APIエンドポイントの適切な保護
3. ✅ 定期的なセキュリティ監査

これらの対策を実施すれば、公開リポジトリとして運用可能です。

