<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <base href="/" />
    <title>ユーザーID管理 | ミセサポ</title>
    <link rel="icon" type="image/png" href="/images/logo_144x144.png" />
<link rel="shortcut icon" href="/images/logo_144x144.png" />
<link rel="apple-touch-icon" href="/images/logo_144x144.png" />
<link rel="stylesheet" href="/styles.css" />
<link rel="stylesheet" href="/css/header.css" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<!-- 
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  body { font-family: 'Noto Sans JP', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; }
  /* Brand theme variables (default + variants) */
  body { --primary: #FF679C; --primary-600: #E35687; }
  body.theme-pink { --primary: #FF679C; --primary-600: #E35687; }
  body.theme-blue { --primary: #2563eb; --primary-600: #1d4ed8; }
  body.theme-emerald { --primary: #10b981; --primary-600: #059669; }
  /* Note: :root also defines the same brand color; inline vars ensure early paint */
  </style>

    <link rel="stylesheet" href="/css/admin-sidebar.css" />
    <!-- DataUtils スクリプト（schedulesページで使用） -->
    <script src="/js/data_utils.js"></script>
  </head>
  <body class="theme-pink page-admin-users">
    <a class="skip-link" href="#main">メインコンテンツへスキップ</a>
    



<link rel="stylesheet" href="/css/admin-users.css" />

<main id="main" class="admin-users-v2">
  <!-- モバイルメニューボタン -->
<button class="mobile-menu-button" id="mobile-menu-button" aria-label="メニューを開く">
  <i class="fas fa-bars"></i>
</button>

<!-- サイドバーオーバーレイ -->
<div class="sidebar-overlay" id="sidebar-overlay"></div>

<!-- サイドバー -->
<aside class="sidebar" id="admin-sidebar">
  <div class="sidebar-header">
    <a href="/admin/dashboard" class="logo-link">
      <img src="/images/logo_144x144.png" alt="ミセサポ" class="logo-img" />
      <span class="logo-text">ミセサポ</span>
    </a>
  </div>

  <!-- ロール表示 -->
  <div class="sidebar-role">
    <span class="role-badge" id="sidebar-role-badge">管理者</span>
  </div>

  <nav class="sidebar-nav">
    <!-- マイページ（目立たせる） -->
    <a href="/staff/mypage" class="nav-item nav-item-mypage" data-page="mypage" id="sidebar-mypage-link">
      <i class="fas fa-user-circle"></i>
      <span class="nav-label">マイページ</span>
    </a>
    <div class="nav-divider"></div>
    <!-- 管理メニュー -->
    <a href="/admin/dashboard" class="nav-item" data-page="dashboard">
      <i class="fas fa-history"></i>
      <span class="nav-label">アクティビティ</span>
    </a>
    <a href="/admin/schedules/" class="nav-item" data-page="schedules">
      <i class="fas fa-calendar-alt"></i>
      <span class="nav-label">スケジュール</span>
    </a>
    <a href="/admin/customers/" class="nav-item" data-page="customers">
      <i class="fas fa-store"></i>
      <span class="nav-label">顧客管理</span>
    </a>
    <a href="/admin/reports/" class="nav-item" data-page="reports">
      <i class="fas fa-file-alt"></i>
      <span class="nav-label">レポート</span>
    </a>
    <a href="/admin/estimates/" class="nav-item" data-page="estimates">
      <i class="fas fa-file-invoice-dollar"></i>
      <span class="nav-label">見積もり</span>
    </a>
    <a href="/admin/orders" class="nav-item" data-page="orders">
      <i class="fas fa-shopping-cart"></i>
      <span class="nav-label">発注管理</span>
    </a>
    <a href="/admin/partners" class="nav-item" data-page="partners">
      <i class="fas fa-handshake"></i>
      <span class="nav-label">パートナー企業</span>
    </a>
    <a href="/admin/users/" class="nav-item" data-page="users">
      <i class="fas fa-users"></i>
      <span class="nav-label">ユーザー管理</span>
    </a>
    <a href="/admin/attendance/errors" class="nav-item" data-page="attendance-errors">
      <i class="fas fa-exclamation-triangle"></i>
      <span class="nav-label">勤怠管理</span>
    </a>
    <a href="/admin/services/" class="nav-item" data-page="services">
      <i class="fas fa-cog"></i>
      <span class="nav-label">サービス管理</span>
    </a>
    <a href="/admin/analytics/" class="nav-item" data-page="analytics">
      <i class="fas fa-chart-bar"></i>
      <span class="nav-label">分析</span>
    </a>
    <a href="/admin/images/" class="nav-item" data-page="images">
      <i class="fas fa-images"></i>
      <span class="nav-label">メディア</span>
    </a>
    <a href="/admin/zaiko" class="nav-item" data-page="zaiko">
      <i class="fas fa-boxes"></i>
      <span class="nav-label">在庫管理</span>
    </a>
    <a href="/admin/announcements" class="nav-item" data-page="announcements">
      <i class="fas fa-bullhorn"></i>
      <span class="nav-label">業務連絡</span>
    </a>
    <div class="nav-divider"></div>
    <a href="/wiki" class="nav-item" data-page="wiki">
      <i class="fas fa-book-open"></i>
      <span class="nav-label">WIKI</span>
    </a>
    <a href="/admin/sitemap" class="nav-item" data-page="sitemap">
      <i class="fas fa-sitemap"></i>
      <span class="nav-label">サイトマップ</span>
    </a>
    <button class="nav-item nav-item-button" onclick="staffLogout()">
      <i class="fas fa-sign-out-alt"></i>
      <span class="nav-label">ログアウト</span>
    </button>
  </nav>

  <!-- トグルボタン -->
  <button class="sidebar-toggle" id="sidebar-toggle" aria-label="サイドバーを開閉">
    <i class="fas fa-chevron-left"></i>
  </button>
</aside>

<script>
  // 従業員用ログアウト関数（グローバル）
  function staffLogout() {
    // Cognitoからログアウト
    if (window.CognitoAuth && typeof window.CognitoAuth.logout === 'function') {
      window.CognitoAuth.logout();
    }
    // ローカルストレージをクリア
    localStorage.removeItem('cognito_user');
    localStorage.removeItem('misesapo_auth');
    localStorage.removeItem('cognito_id_token');
    localStorage.removeItem('cognito_access_token');
    localStorage.removeItem('cognito_refresh_token');
    // 従業員ログイン画面にリダイレクト
    window.location.href = '/staff/signin.html';
  }
</script>


  <!-- メインコンテンツ -->
  <div class="main-content">
    <!-- トップバー -->
    <header class="topbar">
      <div class="topbar-left">
        <h1>ユーザー管理</h1>
      </div>
      <div class="topbar-right">
        <div class="view-toggle-group">
          <button class="btn btn-icon view-toggle-btn active" id="view-toggle-card" title="カード表示" data-view="card">
            <i class="fas fa-th"></i>
          </button>
          <button class="btn btn-icon view-toggle-btn" id="view-toggle-list" title="リスト表示" data-view="list">
            <i class="fas fa-list"></i>
          </button>
        </div>
        <button class="btn btn-primary" id="add-user-btn">
          <i class="fas fa-plus"></i> 新規ユーザー登録
        </button>
      </div>
    </header>

  <!-- 統計カード -->
  <div class="stats-row">
    <div class="stat-mini">
      <div class="stat-mini-icon blue"><i class="fas fa-users"></i></div>
      <div class="stat-mini-body">
        <div class="stat-mini-value" id="stat-total">-</div>
        <div class="stat-mini-label">総ユーザー</div>
      </div>
    </div>
    <div class="stat-mini">
      <div class="stat-mini-icon purple"><i class="fas fa-user-shield"></i></div>
      <div class="stat-mini-body">
        <div class="stat-mini-value" id="stat-admin">-</div>
        <div class="stat-mini-label">管理者</div>
      </div>
    </div>
    <div class="stat-mini">
      <div class="stat-mini-icon gray"><i class="fas fa-user"></i></div>
      <div class="stat-mini-body">
        <div class="stat-mini-value" id="stat-staff">-</div>
        <div class="stat-mini-label">一般</div>
      </div>
    </div>
    <div class="stat-mini">
      <div class="stat-mini-icon green"><i class="fas fa-building"></i></div>
      <div class="stat-mini-body">
        <div class="stat-mini-value" id="stat-departments">-</div>
        <div class="stat-mini-label">部署数</div>
      </div>
    </div>
  </div>

  <!-- フィルター -->
  <div class="filter-bar">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" id="search-input" placeholder="名前、メールで検索..." class="search-input" />
    </div>
    <div class="filter-options">
      <select class="filter-select" id="role-filter">
        <option value="">すべてのロール</option>
        <option value="admin">管理者</option>
        <option value="staff">一般</option>
      </select>
      <select class="filter-select" id="department-filter">
        <option value="">すべての部署</option>
        <!-- 部署フィルターはJavaScriptで動的に生成されます -->
      </select>
      <select class="filter-select" id="status-filter">
        <option value="">すべてのステータス</option>
        <option value="active">有効</option>
        <option value="inactive">無効</option>
      </select>
      <button class="btn btn-secondary btn-sm" id="reset-filters">
        <i class="fas fa-undo"></i>
      </button>
    </div>
  </div>

  <!-- 組織構造レイアウト（部署ベース） -->
  <div class="organization-layout" id="organization-layout">
    <div class="loading-cell" id="loading-users">
      <i class="fas fa-spinner fa-spin"></i> 読み込み中...
  </div>

    <!-- 部署ごとのコンテナ（動的に生成されます） -->
    <div class="departments-container" id="departments-container">
      <!-- 部署が動的に追加されます -->
    </div>
  </div>

  <!-- 新規/編集モーダル -->
  <dialog id="user-dialog" class="user-dialog">
    <div class="dialog-content">
      <button type="button" class="dialog-close" onclick="document.getElementById('user-dialog').close()">
        <i class="fas fa-times"></i>
      </button>
      <h3 id="dialog-title">新規ユーザー登録</h3>
      <form id="user-form" method="dialog">
        <input type="hidden" id="user-id" name="id">
        <div class="form-row">
          <div class="form-field">
            <label for="user-name">名前 <span class="required">*</span></label>
            <input type="text" id="user-name" name="name" required placeholder="例: 山田太郎">
          </div>
        </div>
        <div class="form-row">
          <div class="form-field half">
            <label for="user-email">メールアドレス <span class="required">*</span></label>
            <input type="email" id="user-email" name="email" required placeholder="yamada.taro@example.com">
            <small class="form-hint">現状は個人メールアドレスも使用可能です（将来的には企業用メールアドレスへの移行を推奨）</small>
          </div>
          <div class="form-field half">
            <label for="user-phone">電話番号</label>
            <input type="tel" id="user-phone" name="phone" placeholder="090-1234-5678">
          </div>
        </div>
        <div class="form-row">
          <div class="form-field half">
            <label for="user-role">ロール <span class="required">*</span></label>
            <select id="user-role" name="role" required>
              <option value="">選択してください</option>
              <option value="admin">管理者</option>
              <option value="staff">なし</option>
            </select>
            <small class="form-hint">管理ダッシュボードへのアクセス権限を表します</small>
          </div>
          <div class="form-field half">
            <label for="user-department">部署</label>
            <select id="user-department" name="department">
              <option value="">選択してください</option>
              <option value="OS課">OS課</option>
              <option value="事務">事務</option>
              <option value="取締役会">取締役会</option>
              <option value="営業">営業</option>
              <option value="運営">運営</option>
              <option value="開発">開発</option>
            </select>
            <small class="form-hint">ユーザー管理ページでカテゴリ分けするために使用します</small>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field full">
            <label for="user-job">担当業務</label>
            <input type="text" id="user-job" name="job" placeholder="例: FS営業・清掃、システム開発・プログラミング">
            <small class="form-hint">ユーザーカードに表示されるバッジ（ステータス）です。複数の業務は「・」で区切ってください</small>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label for="user-status">ステータス</label>
            <select id="user-status" name="status">
              <option value="active">有効</option>
              <option value="inactive">無効</option>
            </select>
          </div>
        </div>
        <div class="form-row" id="password-row">
          <div class="form-field">
            <label for="user-password">パスワード <span class="required" id="password-required">*</span></label>
            <input type="password" id="user-password" name="password" placeholder="8文字以上">
            <p class="form-hint">編集時は空欄で変更なし</p>
          </div>
        </div>
        <div class="form-status" id="form-status"></div>
        <div class="dialog-actions">
          <button type="button" class="btn btn-secondary" onclick="document.getElementById('user-dialog').close()">キャンセル</button>
          <button type="submit" class="btn btn-primary" id="submit-btn">保存</button>
        </div>
      </form>
    </div>
  </dialog>

  <!-- 削除確認 -->
  <dialog id="delete-dialog" class="delete-dialog">
    <div class="dialog-content dialog-sm">
      <h3>削除確認</h3>
      <p>このユーザーを削除しますか？<br>この操作は取り消せません。</p>
      <div class="dialog-actions">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('delete-dialog').close()">キャンセル</button>
        <button type="button" class="btn btn-danger" id="confirm-delete">削除</button>
      </div>
    </div>
  </dialog>

  <!-- 一括ロール割り当て確認 -->
  <dialog id="bulk-role-dialog" class="delete-dialog">
    <div class="dialog-content dialog-sm">
      <h3>一括ロール割り当て</h3>
      <p id="bulk-role-message">選択したユーザーを<span id="bulk-role-name"></span>に設定しますか？</p>
      <div id="bulk-role-users-list" style="max-height: 200px; overflow-y: auto; margin: 16px 0; padding: 12px; background: #f9fafb; border-radius: 8px;">
        <!-- ユーザーリストがここに表示されます -->
      </div>
      <div class="dialog-actions">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('bulk-role-dialog').close()">キャンセル</button>
        <button type="button" class="btn btn-primary" id="confirm-bulk-role">設定する</button>
      </div>
    </div>
  </dialog>
  </div>
</main>

<script src="/js/admin-users.js"></script>

    <footer class="site-footer">
  <div class="container text-center muted small" style="padding: 16px 0;">
    <p>&copy; 2025 ミセサポ</p>
  </div>
</footer>


    <!-- AWS SDK and Cognito -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1000.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.0/dist/amazon-cognito-identity.min.js"></script>
    <script src="/js/cognito_config.js"></script>
    <script src="/js/cognito_auth.js"></script>
    <!-- Firebase SDK - 削除済み（Cognitoに移行） -->
    <script src="/js/role_config.js"></script>
    <script src="/js/users.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/modal_manager.js"></script>
    <script src="/app.js"></script>
    <script src="/js/admin-sidebar.js"></script>
    <!-- Page-specific scripts (injected by page content) -->
    <script>
      // 管理画面では共通ヘッダーを持たないため追加スクリプトは不要
    </script>
  </body>
</html>

