<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <base href="/" />
    <title></title>
    
    <link rel="icon" type="image/png" href="/images/logo_144x144.png" />
<link rel="shortcut icon" href="/images/logo_144x144.png" />
<link rel="apple-touch-icon" href="/images/logo_144x144.png" />
<link rel="stylesheet" href="/styles.css" />
<link rel="stylesheet" href="/css/header.css" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<!-- 
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  body { font-family: 'Noto Sans JP', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; }
  /* Brand theme variables (default + variants) */
  body { --primary: #FF679C; --primary-600: #E35687; }
  body.theme-pink { --primary: #FF679C; --primary-600: #E35687; }
  body.theme-blue { --primary: #2563eb; --primary-600: #1d4ed8; }
  body.theme-emerald { --primary: #10b981; --primary-600: #059669; }
  /* Note: :root also defines the same brand color; inline vars ensure early paint */
  </style>

    <style>
      /* Staff signin page: hide all headers */
      body.page-staff-signin #default-header-wrapper,
      body.page-staff-signin #normal-header-wrapper {
        display: none !important;
      }
      
      /* Staff pages: hide global header and footer */
      body[class*="page-staff-"] #default-header-wrapper,
      body[class*="page-staff-"] #normal-header-wrapper,
      body[class*="page-staff-"] footer {
        display: none !important;
      }
      
      /* Staff pages: ensure full height layout */
      body[class*="page-staff-"] {
        margin: 0;
        padding: 0;
      }
      
      body[class*="page-staff-"] #main {
        margin: 0;
        padding: 0;
      }
      
      /* Admin pages: hide global header while keeping auth buttons */
      body[class*="page-admin-"] #default-header-wrapper {
        height: 0;
        overflow: visible;
      }
      body[class*="page-admin-"] #default-header-wrapper .site-header {
        background: transparent;
        box-shadow: none;
        padding: 0;
        min-height: 0;
      }
      body[class*="page-admin-"] #default-header-wrapper .inner {
        justify-content: flex-end;
        padding: 0;
      }
      body[class*="page-admin-"] #default-header-wrapper .nav-left,
      body[class*="page-admin-"] #default-header-wrapper .hamburger-btn,
      body[class*="page-admin-"] #default-header-wrapper .mobile-nav,
      body[class*="page-admin-"] #default-header-wrapper .spacer,
      body[class*="page-admin-"] #default-header-wrapper .role-badge {
        display: none !important;
      }
      body[class*="page-admin-"] #default-header-wrapper .nav-right {
        position: fixed;
        top: 16px;
        right: 24px;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        background: #fff;
        border-radius: 999px;
        padding: 6px 18px;
        box-shadow: 0 12px 30px rgba(15,23,42,0.18);
        z-index: 300;
      }
      body[class*="page-admin-"] #default-header-wrapper .nav-right .nav-link {
        font-weight: 600;
      }
      body[class*="page-admin-"] #default-header-wrapper .nav-right .icon-btn {
        width: 36px;
        height: 36px;
        border-radius: 999px;
        border: 1px solid #e5e7eb;
      }
      
      /* Admin store chart page: completely hide header */
      body[class*="admin-store-chart"] #default-header-wrapper,
      body[class*="admin-store-chart"] #normal-header-wrapper {
        display: none !important;
      }
      
      /* Sales pages: hide global header and footer */
      body[class*="sales-"] #default-header-wrapper,
      body[class*="sales-"] #normal-header-wrapper,
      body[class*="sales-"] footer {
        display: none !important;
      }
      
      /* Sales pages: ensure full height layout */
      body[class*="sales-"] {
        margin: 0;
        padding: 0;
      }
      
      body[class*="sales-"] #main {
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body class="theme-pink ">
    <div id="default-header-wrapper">
    <a class="skip-link" href="#main">メインコンテンツへスキップ</a>
<header id="header-guest" class="site-header" data-role="guest">
  <div class="inner wide">
    <div class="nav-left">
      <a class="brand brand-logo" href="/" aria-label="ミセサポ ホーム">
        <img src="/images/logo_144x144.png" alt="ミセサポ" />
      </a>
      <nav id="nav-guest" class="nav-left hide-sm" aria-label="Primary">
        <!-- ナビゲーション項目はJavaScriptで動的に生成されます -->
      </nav>
    </div>
    <div class="spacer"></div>
    <nav class="nav-right hide-sm" aria-label="User">
      <span class="role-badge" style="padding: 4px 12px; background: #e5e7eb; color: #6b7280; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">ゲスト</span>
      <a class="nav-link" href="/signin">ログイン</a>
      <a class="nav-link primary" href="/signup">新規登録</a>
      <button class="icon-btn" aria-label="通知">
        <i class="fas fa-bell"></i>
      </button>
      <button class="icon-btn" aria-label="ログアウト" onclick="window.Auth && window.Auth.logout()" style="display: none;">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </nav>
    <button class="hamburger-btn show-sm" aria-label="メニュー" aria-expanded="false" id="hamburger-btn">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </div>
  <!-- スマホ版ナビゲーションメニュー -->
  <nav class="mobile-nav show-sm" id="mobile-nav" aria-label="モバイルナビゲーション">
    <div class="mobile-nav-content">
      <nav class="mobile-nav-primary" id="mobile-nav-primary" aria-label="Primary">
        <!-- ナビゲーション項目はJavaScriptで動的に生成されます -->
      </nav>
      <nav class="mobile-nav-user" aria-label="User">
        <span class="role-badge" style="padding: 4px 12px; background: #e5e7eb; color: #6b7280; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">ゲスト</span>
        <a class="mobile-nav-link" href="/signin">ログイン</a>
        <a class="mobile-nav-link primary" href="/signup">新規登録</a>
      </nav>
    </div>
  </nav>
</header>

    </div>
    <!-- 通常ヘッダー（ログイン画面用） -->
    <div id="normal-header-wrapper" style="display: none;">
    <!-- 通常ヘッダー -->
<header class="normal-header">
    <div class="normal-header-inner">
        <div class="normal-header-logo">
            <a href="/">
                <img id="normal-header-logo-img" src="/images-material/logo_144x144.png" alt="ロゴ" onerror="this.style.display='none'">
            </a>
                </div>
        <nav class="normal-header-nav">
            <a href="/">TOP</a>
            <a href="/service">対応可能サービス</a>
            <a href="/lp#voice">お客様の声</a>
            <a href="/customers-support-desk">カスタマーズサポート</a>
            <a href="/announcements">お知らせ</a>
            <a href="/privacy-policy">規約＆ポリシー</a>
        </nav>
        <div class="normal-header-actions">
            <a href="/signin" class="normal-header-login">ログイン</a>
        </div>
            </div>
</header>


    </div>
    <main id="main">
      



<main id="main" class="container admin-report-edit">
  <div class="page-header">
    <a href="/admin/reports/" class="back-btn">
      <i class="fas fa-chevron-left"></i>
    </a>
    <h1 class="page-title">レポート編集</h1>
    <a href="#" id="view-detail-link" class="btn btn-outline btn-sm" style="display: none;">
      <i class="fas fa-eye"></i>
      詳細を見る
    </a>
  </div>

  <div class="loading" id="loading">読み込み中...</div>
  <div id="error-message" class="error-message" style="display: none;"></div>

  <form id="report-form" class="report-form" style="display: none;">
    <input type="hidden" id="report-id" name="report_id">
    
    <!-- 作業情報 -->
    <div class="form-section">
      <h2 class="section-title">作業情報</h2>
      <div class="form-group">
        <label class="form-label">店舗 <span class="required">*</span></label>
        <select name="store_id" id="store-id" class="form-select" required>
          <option value="">店舗を選択</option>
          <option value="store-001">Darts Bar A's 神楽坂店</option>
          <option value="store-002">大塚店</option>
          <option value="store-003">高円寺店</option>
          <option value="store-004">日本橋茅場町店</option>
        </select>
        <input type="hidden" name="store_name" id="store-name">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">清掃日 <span class="required">*</span></label>
          <input type="date" name="cleaning_date" id="cleaning-date" class="form-input" required>
        </div>
        <div class="form-group">
          <label class="form-label">開始時刻</label>
          <input type="time" name="cleaning_start_time" id="cleaning-start-time" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">終了時刻</label>
          <input type="time" name="cleaning_end_time" id="cleaning-end-time" class="form-input">
        </div>
      </div>
    </div>

    <!-- 清掃項目 -->
    <div class="form-section">
      <div class="section-header">
        <h2 class="section-title">清掃項目</h2>
        <button type="button" class="btn btn-outline btn-sm" id="add-work-item">
          <i class="fas fa-plus"></i>
          項目を追加
        </button>
      </div>
      <div id="work-items-container">
        <!-- 清掃項目が動的に追加される -->
      </div>
    </div>

    <!-- 位置情報（オプション） -->
    <div class="form-section">
      <h2 class="section-title">位置情報（オプション）</h2>
      <div class="location-info">
        <button type="button" class="btn btn-outline btn-sm" id="get-location">
          <i class="fas fa-map-marker-alt"></i>
          現在位置を取得
        </button>
        <div id="location-display" class="location-display" style="display: none;">
          <span class="location-text">取得済み</span>
        </div>
        <input type="hidden" name="location" id="location-data">
      </div>
    </div>

    <!-- 送信ボタン -->
    <div class="form-actions">
      <button type="button" class="btn btn-outline btn-block" onclick="window.location.href='/admin/reports'">キャンセル</button>
      <button type="submit" class="btn btn-primary btn-block">
        <i class="fas fa-check-circle"></i>
        レポートを更新
      </button>
    </div>
  </form>

  <!-- スタイルは new.html と同じ -->
  <style>
    .admin-report-edit {
      max-width: 1000px;
      margin: 0 auto;
      padding: 16px;
      padding-bottom: 100px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .error-message {
      padding: 24px;
      background: #fee2e2;
      color: #991b1b;
      text-align: center;
      border-radius: 8px;
      margin: 20px;
    }
    .page-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    .back-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      color: #374151;
      text-decoration: none;
      transition: all 0.2s;
    }
    .back-btn:hover {
      background: #f9fafb;
      border-color: var(--primary);
      color: var(--primary);
    }
    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin: 0;
    }
    .report-form {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .form-section {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .section-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
      margin: 0;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group:last-child {
      margin-bottom: 0;
    }
    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 16px;
    }
    .form-label {
      display: block;
      font-weight: 600;
      color: #374151;
      font-size: 0.875rem;
      margin-bottom: 8px;
    }
    .required {
      color: #ef4444;
    }
    .form-select,
    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
    }
    .form-select:focus,
    .form-input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(255, 107, 166, 0.1);
    }
    .work-item-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .work-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .work-item-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    .work-item-detail {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .work-item-detail label {
      font-size: 0.75rem;
      color: #6b7280;
    }
    .work-item-detail input,
    .work-item-detail textarea {
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    .work-item-detail textarea {
      resize: vertical;
      min-height: 60px;
    }
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
    }
    .photo-upload-section {
      margin-top: 16px;
    }
    .photo-category {
      margin-bottom: 16px;
    }
    .photo-category-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
    }
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }
    .photo-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
    }
    .photo-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .photo-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 32px;
      height: 32px;
      background: #ef4444;
      color: #ffffff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .photo-upload-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      background: #f9fafb;
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .photo-upload-btn:hover {
      background: #ffffff;
      border-color: var(--primary);
    }
    .photo-upload-btn input[type="file"] {
      display: none;
    }
    .photo-upload-btn i {
      font-size: 2rem;
      color: var(--primary);
      margin-bottom: 8px;
    }
    .photo-upload-btn span {
      font-size: 0.875rem;
      color: #6b7280;
    }
    .location-info {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .location-display {
      padding: 12px;
      background: #d1fae5;
      border-radius: 8px;
      color: #065f46;
      font-size: 0.875rem;
    }
    .form-actions {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ffffff;
      border-top: 1px solid #e5e7eb;
      padding: 16px;
      display: flex;
      gap: 12px;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      z-index: 100;
    }
    .form-actions .btn {
      flex: 1;
    }
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.95rem;
      font-weight: 600;
      text-decoration: none;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background: #FF6BA6;
      color: #ffffff;
    }
    .btn-primary:hover {
      background: #FF5A9A;
    }
    .btn-outline {
      background: #ffffff;
      color: #374151;
      border: 1px solid #d1d5db;
    }
    .btn-outline:hover {
      background: #f9fafb;
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.875rem;
    }
    .btn-block {
      width: 100%;
    }
    @media (max-width: 768px) {
      .admin-report-edit {
        padding: 12px;
        padding-bottom: 100px;
      }
      .form-section {
        padding: 16px;
      }
      .form-row {
        grid-template-columns: 1fr;
      }
      .work-item-details {
        grid-template-columns: 1fr;
      }
      .photo-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>

  <script>
    // APIエンドポイント
    const API_BASE_URL = 'https://2z0ui5xfxb.execute-api.ap-northeast-1.amazonaws.com/prod';
    
    // IDトークンを取得（Cognito/localStorageから取得）
    async function getFirebaseIdToken() {
      try {
        // 1. Cognito ID Token（最優先）
        const cognitoIdToken = localStorage.getItem('cognito_id_token');
        if (cognitoIdToken) {
          return cognitoIdToken;
        }
        
        // 2. Cognito認証のユーザーオブジェクトからトークンを取得
        const cognitoUser = localStorage.getItem('cognito_user');
        if (cognitoUser) {
          try {
            const parsed = JSON.parse(cognitoUser);
            if (parsed.tokens && parsed.tokens.idToken) {
              return parsed.tokens.idToken;
            }
            if (parsed.idToken) {
              return parsed.idToken;
            }
          } catch (e) {
            console.warn('Error parsing cognito user:', e);
          }
        }
        
        // 3. CognitoAuthから取得
        if (window.CognitoAuth && window.CognitoAuth.isAuthenticated && window.CognitoAuth.isAuthenticated()) {
          try {
            const cognitoUser = await window.CognitoAuth.getCurrentUser();
            if (cognitoUser && cognitoUser.tokens && cognitoUser.tokens.idToken) {
              return cognitoUser.tokens.idToken;
            }
          } catch (e) {
            console.warn('Error getting token from CognitoAuth:', e);
          }
        }
        
        // 4. misesapo_auth から取得（フォールバック）
        const authData = localStorage.getItem('misesapo_auth');
        if (authData) {
          try {
            const parsed = JSON.parse(authData);
            if (parsed.token) {
              return parsed.token;
        }
          } catch (e) {
            console.warn('Error parsing auth data:', e);
          }
        }
        
        console.warn('[Reports] No authentication token found, using mock token');
        return 'mock-token';
      } catch (error) {
        console.error('[Reports] Error getting ID token:', error);
        return 'mock-token';
      }
    }

    // URLからレポートIDを取得
    function getReportIdFromUrl() {
      const path = window.location.pathname;
      const match = path.match(/\/admin\/reports\/([^\/]+)\/edit\.html/);
      return match ? match[1] : null;
    }

    // 利用可能な清掃項目
    const availableWorkItems = [
      { id: 'grease-trap', name: 'グリストラップ' },
      { id: 'range-hood', name: 'レンジフード清掃' },
      { id: 'floor', name: '床清掃' },
      { id: 'toilet', name: 'トイレ清掃' },
      { id: 'duct', name: 'ダクト清掃' },
      { id: 'aircon', name: 'エアコン分解洗浄' }
    ];

    let workItemCounter = 0;

    // 画像の最適化
    function optimizeImage(file, maxWidth = 800, quality = 0.8) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            let width = img.width;
            let height = img.height;
            if (width > maxWidth) {
              height = (height * maxWidth) / width;
              width = maxWidth;
            }
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            canvas.toBlob(resolve, 'image/jpeg', quality);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    // Base64に変換
    function blobToBase64(blob) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    // 清掃項目を追加（既存データ対応）
    function addWorkItem(itemData = null) {
      workItemCounter++;
      const container = document.getElementById('work-items-container');
      const itemIdValue = itemData?.item_id || `work-item-${workItemCounter}`;
      const itemNameValue = itemData?.item_name || '';
      
      const workItemCard = document.createElement('div');
      workItemCard.className = 'work-item-card';
      workItemCard.dataset.itemId = itemIdValue;
      
      const details = itemData?.details || {};
      const beforePhotos = itemData?.photos?.before || [];
      const afterPhotos = itemData?.photos?.after || [];
      
      workItemCard.innerHTML = `
        <div class="work-item-header">
          <div class="form-group" style="flex: 1; margin: 0;">
            <select class="form-select work-item-select" data-item-id="${itemIdValue}">
              <option value="">清掃項目を選択</option>
              ${availableWorkItems.map(item => `
                <option value="${item.id}" ${item.id === itemIdValue ? 'selected' : ''}>${item.name}</option>
              `).join('')}
            </select>
          </div>
          <button type="button" class="btn btn-outline btn-sm" onclick="removeWorkItem('${itemIdValue}')">
            <i class="fas fa-trash"></i>
            削除
          </button>
        </div>
        <div class="work-item-details">
          <div class="work-item-detail">
            <label>タイプ</label>
            <input type="text" class="work-item-type" placeholder="例: 床置き型" value="${details.type || ''}">
          </div>
          <div class="work-item-detail">
            <label>個数</label>
            <input type="number" class="work-item-count" value="${details.count || 1}" min="1">
          </div>
          <div class="work-item-detail">
            <label>メモ</label>
            <input type="text" class="work-item-notes" placeholder="例: 少し流れが悪い" value="${details.notes || ''}">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">作業内容</label>
          <textarea class="form-textarea work-item-content" rows="3" placeholder="作業内容を入力してください">${itemData?.work_content || ''}</textarea>
        </div>
        <div class="form-group">
          <label class="form-label">作業メモ</label>
          <textarea class="form-textarea work-item-memo" rows="3" placeholder="特記事項を入力してください">${itemData?.work_memo || ''}</textarea>
        </div>
        <div class="photo-upload-section">
          <div class="photo-category">
            <h3 class="photo-category-title">作業前</h3>
            <div class="photo-grid" data-category="before" data-item-id="${itemIdValue}">
              ${beforePhotos.map(url => `
                <div class="photo-item" data-photo-url="${url}">
                  <img src="${url}" alt="作業前">
                  <button type="button" class="photo-remove" onclick="removePhoto(this)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              `).join('')}
              <div class="photo-item">
                <label class="photo-upload-btn">
                  <input type="file" accept="image/*" capture="environment" data-category="before" data-item-id="${itemIdValue}" />
                  <i class="fas fa-camera"></i>
                  <span>写真を追加</span>
                </label>
              </div>
            </div>
          </div>
          <div class="photo-category">
            <h3 class="photo-category-title">作業後</h3>
            <div class="photo-grid" data-category="after" data-item-id="${itemIdValue}">
              ${afterPhotos.map(url => `
                <div class="photo-item" data-photo-url="${url}">
                  <img src="${url}" alt="作業後">
                  <button type="button" class="photo-remove" onclick="removePhoto(this)">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
              `).join('')}
              <div class="photo-item">
                <label class="photo-upload-btn">
                  <input type="file" accept="image/*" capture="environment" data-category="after" data-item-id="${itemIdValue}" />
                  <i class="fas fa-camera"></i>
                  <span>写真を追加</span>
                </label>
              </div>
            </div>
          </div>
        </div>
      `;
      
      container.appendChild(workItemCard);
      
      const select = workItemCard.querySelector('.work-item-select');
      select.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
          workItemCard.dataset.itemId = selectedOption.value;
          workItemCard.querySelectorAll('input[type="file"]').forEach(input => {
            input.dataset.itemId = selectedOption.value;
          });
        }
      });
      
      workItemCard.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', handlePhotoUpload);
      });
    }

    function removeWorkItem(itemId) {
      const card = document.querySelector(`[data-item-id="${itemId}"]`);
      if (card && confirm('この清掃項目を削除しますか？')) {
        card.remove();
      }
    }

    async function handlePhotoUpload(e) {
      const file = e.target.files[0];
      if (!file || !file.type.startsWith('image/')) return;
      
      try {
        const optimizedBlob = await optimizeImage(file, 800, 0.8);
        const base64 = await blobToBase64(optimizedBlob);
        const photoGrid = e.target.closest('.photo-grid');
        
        const photoItem = document.createElement('div');
        photoItem.className = 'photo-item';
        photoItem.innerHTML = `
          <img src="${base64}" alt="Uploaded photo">
          <button type="button" class="photo-remove" onclick="removePhoto(this)">
            <i class="fas fa-times"></i>
          </button>
        `;
        photoItem.dataset.base64 = base64;
        
        const uploadBtn = e.target.closest('.photo-item');
        uploadBtn.parentNode.insertBefore(photoItem, uploadBtn);
      } catch (error) {
        console.error('Error uploading photo:', error);
        alert('写真のアップロードに失敗しました');
      }
    }

    function removePhoto(button) {
      const photoItem = button.closest('.photo-item');
      photoItem.remove();
    }

    // レポート詳細を取得してフォームに設定
    async function loadReportData() {
      const loadingEl = document.getElementById('loading');
      const formEl = document.getElementById('report-form');
      const errorEl = document.getElementById('error-message');
      
      const reportId = getReportIdFromUrl();
      if (!reportId) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = 'レポートIDが取得できませんでした';
        return;
      }
      
      // 詳細を見るリンクを設定
      const viewDetailLink = document.getElementById('view-detail-link');
      if (viewDetailLink && reportId) {
        viewDetailLink.href = `/reports/${reportId}.html`;
        viewDetailLink.style.display = 'inline-flex';
      }
      
      try {
        loadingEl.style.display = 'block';
        formEl.style.display = 'none';
        errorEl.style.display = 'none';
        
        const idToken = await getFirebaseIdToken();
        const response = await fetch(`${API_BASE_URL}/staff/reports/${reportId}`, {
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('レポートが見つかりませんでした');
          }
          throw new Error('レポートの取得に失敗しました');
        }
        
        const report = await response.json();
        
        // フォームにデータを設定
        document.getElementById('report-id').value = report.report_id;
        document.getElementById('store-id').value = report.store_id || '';
        document.getElementById('store-name').value = report.store_name || '';
        document.getElementById('cleaning-date').value = report.cleaning_date || '';
        document.getElementById('cleaning-start-time').value = report.cleaning_start_time || '';
        document.getElementById('cleaning-end-time').value = report.cleaning_end_time || '';
        
        if (report.location) {
          document.getElementById('location-data').value = JSON.stringify(report.location);
          document.getElementById('location-display').style.display = 'block';
        }
        
        // 清掃項目を追加
        const workItems = report.work_items || [];
        workItems.forEach(item => {
          addWorkItem(item);
        });
        
        if (workItems.length === 0) {
          addWorkItem(); // 空の場合は1つ追加
        }
        
        loadingEl.style.display = 'none';
        formEl.style.display = 'flex';
      } catch (error) {
        console.error('Error loading report:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = `エラー: ${error.message}`;
      }
    }

    document.getElementById('store-id')?.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      document.getElementById('store-name').value = selectedOption.text;
    });

    document.getElementById('get-location')?.addEventListener('click', function() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          const locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };
          document.getElementById('location-data').value = JSON.stringify(locationData);
          document.getElementById('location-display').style.display = 'block';
        });
      } else {
        alert('位置情報が取得できません');
      }
    });

    document.getElementById('add-work-item')?.addEventListener('click', function() {
      addWorkItem();
    });

    // フォーム送信
    document.getElementById('report-form')?.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      try {
        const reportId = document.getElementById('report-id').value;
        const formData = {
          report_id: reportId,
          store_id: document.getElementById('store-id').value,
          store_name: document.getElementById('store-name').value,
          cleaning_date: document.getElementById('cleaning-date').value,
          cleaning_start_time: document.getElementById('cleaning-start-time').value,
          cleaning_end_time: document.getElementById('cleaning-end-time').value,
          work_items: [],
          location: null
        };
        
        const locationData = document.getElementById('location-data').value;
        if (locationData) {
          formData.location = JSON.parse(locationData);
        }
        
        document.querySelectorAll('.work-item-card').forEach(card => {
          const itemId = card.dataset.itemId;
          const select = card.querySelector('.work-item-select');
          const selectedOption = select.options[select.selectedIndex];
          
          if (!selectedOption.value) return;
          
          const workItem = {
            item_id: selectedOption.value,
            item_name: selectedOption.text,
            details: {
              type: card.querySelector('.work-item-type').value,
              count: parseInt(card.querySelector('.work-item-count').value) || 1,
              notes: card.querySelector('.work-item-notes').value
            },
            work_content: card.querySelector('.work-item-content').value,
            work_memo: card.querySelector('.work-item-memo').value,
            photos: {
              before: [],
              after: []
            }
          };
          
          // 写真を収集（既存のURLと新しいBase64を区別）
          card.querySelectorAll('[data-category="before"] .photo-item').forEach(photoItem => {
            if (photoItem.dataset.photoUrl) {
              // 既存のURL
              workItem.photos.before.push(photoItem.dataset.photoUrl);
            } else if (photoItem.dataset.base64) {
              // 新しいBase64
              workItem.photos.before.push(photoItem.dataset.base64);
            }
          });
          
          card.querySelectorAll('[data-category="after"] .photo-item').forEach(photoItem => {
            if (photoItem.dataset.photoUrl) {
              workItem.photos.after.push(photoItem.dataset.photoUrl);
            } else if (photoItem.dataset.base64) {
              workItem.photos.after.push(photoItem.dataset.base64);
            }
          });
          
          formData.work_items.push(workItem);
        });
        
        if (!formData.store_id) {
          alert('店舗を選択してください');
          return;
        }
        
        if (!formData.cleaning_date) {
          alert('清掃日を入力してください');
          return;
        }
        
        if (formData.work_items.length === 0) {
          alert('少なくとも1つの清掃項目を追加してください');
          return;
        }
        
        const idToken = await getFirebaseIdToken();
        const response = await fetch(`${API_BASE_URL}/staff/reports`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || 'レポートの更新に失敗しました');
        }
        
        alert('レポートを更新しました');
        // 更新したレポートの詳細ページにリダイレクト
        const reportId = document.getElementById('report-id').value;
        if (reportId) {
          window.location.href = `/reports/${reportId}`;
        } else {
          // report_idが取得できない場合はレポート一覧にリダイレクト
          window.location.href = '/admin/reports';
        }
      } catch (error) {
        console.error('Error updating report:', error);
        alert(`エラー: ${error.message}`);
      }
    });

    // 初期化
    loadReportData();
  </script>
</main>


    </main>
    <footer class="site-footer">
  <div class="container text-center muted small" style="padding: 16px 0;">
    <p>&copy; 2025 ミセサポ</p>
  </div>
</footer>


    <!-- Firebase SDK - 削除済み（Cognitoに移行） -->
    <script src="/js/role_config.js"></script>
    <script src="/js/users.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/modal_manager.js"></script>
    <script src="/app.js"></script>
    <script>
      // ログイン画面では通常ヘッダーを表示
      (function() {
        const path = window.location.pathname || '';
        const isSigninPage = path.includes('/signin.html') || path.includes('/signin');
        
        // ログイン画面では通常ヘッダーを表示、デフォルトヘッダーを非表示
        if (isSigninPage) {
          const defaultHeaderWrapper = document.getElementById('default-header-wrapper');
          const normalHeaderWrapper = document.getElementById('normal-header-wrapper');
          if (defaultHeaderWrapper) {
            defaultHeaderWrapper.style.display = 'none';
          }
          if (normalHeaderWrapper) {
            normalHeaderWrapper.style.display = 'block';
            // ログイン画面では通常ヘッダーを常に表示
            const normalHeader = normalHeaderWrapper.querySelector('.normal-header');
            if (normalHeader) {
              normalHeader.classList.add('visible');
            }
          }
        }
      })();
    </script>
  </body>
  </html>


