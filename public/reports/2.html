<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <title></title>
    <link rel="icon" type="image/png" href="/images/logo_144x144.png" />
<link rel="shortcut icon" href="/images/logo_144x144.png" />
<link rel="apple-touch-icon" href="/images/logo_144x144.png" />
<link rel="stylesheet" href="/styles.css" />
<link rel="stylesheet" href="/css/header.css" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<!-- 
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet" />
-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  body { font-family: 'Noto Sans JP', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif; }
  /* Brand theme variables (default + variants) */
  body { --primary: #FF679C; --primary-600: #E35687; }
  body.theme-pink { --primary: #FF679C; --primary-600: #E35687; }
  body.theme-blue { --primary: #2563eb; --primary-600: #1d4ed8; }
  body.theme-emerald { --primary: #10b981; --primary-600: #059669; }
  /* Note: :root also defines the same brand color; inline vars ensure early paint */
  </style>

  </head>
  <body class="theme-pink ">
    <div id="default-header-wrapper">
    <a class="skip-link" href="#main">メインコンテンツへスキップ</a>
<header id="header-guest" class="site-header" data-role="guest">
  <div class="inner wide">
    <div class="nav-left">
      <a class="brand brand-logo" href="/index.html" aria-label="ミセサポ ホーム">
        <img src="/images/logo_144x144.png" alt="ミセサポ" />
      </a>
      <nav id="nav-guest" class="nav-left hide-sm" aria-label="Primary">
        <!-- ナビゲーション項目はJavaScriptで動的に生成されます -->
      </nav>
    </div>
    <div class="spacer"></div>
    <nav class="nav-right hide-sm" aria-label="User">
      <span class="role-badge" style="padding: 4px 12px; background: #e5e7eb; color: #6b7280; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">ゲスト</span>
      <a class="nav-link" href="/signin.html">ログイン</a>
      <a class="nav-link primary" href="/signup.html">新規登録</a>
      <button class="icon-btn" aria-label="通知">
        <i class="fas fa-bell"></i>
      </button>
      <button class="icon-btn" aria-label="ログアウト" onclick="window.Auth && window.Auth.logout()" style="display: none;">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </nav>
    <button class="hamburger-btn show-sm" aria-label="メニュー" aria-expanded="false" id="hamburger-btn">
      <span></span>
      <span></span>
      <span></span>
    </button>
  </div>
  <!-- スマホ版ナビゲーションメニュー -->
  <nav class="mobile-nav show-sm" id="mobile-nav" aria-label="モバイルナビゲーション">
    <div class="mobile-nav-content">
      <nav class="mobile-nav-primary" id="mobile-nav-primary" aria-label="Primary">
        <!-- ナビゲーション項目はJavaScriptで動的に生成されます -->
      </nav>
      <nav class="mobile-nav-user" aria-label="User">
        <span class="role-badge" style="padding: 4px 12px; background: #e5e7eb; color: #6b7280; border-radius: 4px; font-size: 0.875rem; font-weight: 500;">ゲスト</span>
        <a class="mobile-nav-link" href="/signin.html">ログイン</a>
        <a class="mobile-nav-link primary" href="/signup.html">新規登録</a>
      </nav>
    </div>
  </nav>
</header>

    </div>
    <!-- 通常ヘッダー（ログイン画面用） -->
    <div id="normal-header-wrapper" style="display: none;">
    <!-- 通常ヘッダー -->
<header class="normal-header">
    <div class="normal-header-inner">
        <div class="normal-header-logo">
            <a href="/">
                <img id="normal-header-logo-img" src="/images-material/logo_144x144.png" alt="ロゴ" onerror="this.style.display='none'">
            </a>
                </div>
        <nav class="normal-header-nav">
            <a href="/">TOP</a>
            <a href="/service.html">対応可能サービス</a>
            <a href="/lp.html#voice">お客様の声</a>
            <a href="/customers-support-desk.html">カスタマーズサポート</a>
            <a href="/announcements.html">お知らせ</a>
            <a href="/privacy-policy.html">規約＆ポリシー</a>
        </nav>
        <div class="normal-header-actions">
            <a href="/signin.html" class="normal-header-login">ログイン</a>
        </div>
            </div>
</header>


    </div>
    <!-- リリース前チェックボックス（清掃員関連ページでは非表示） -->
    <div id="release-check-section" class="release-check-section" data-hide-for-staff>
      <div class="release-check-container">
        <div class="release-check-label">リリース前チェック</div>
        <div class="release-check-boxes">
          <label class="release-check-item">
            <input type="checkbox" id="check-admin" class="release-checkbox" data-check-type="admin" />
            <span>管理者</span>
          </label>
          <label class="release-check-item">
            <input type="checkbox" id="check-developer" class="release-checkbox" data-check-type="developer" />
            <span>開発者</span>
          </label>
          <label class="release-check-item">
            <input type="checkbox" id="check-other" class="release-checkbox" data-check-type="other" />
            <span>その他</span>
          </label>
        </div>
      </div>
    </div>
    <main id="main">
      



<main id="main" class="container report-detail">
  <div class="report-container">
    <div class="loading" id="loading">読み込み中...</div>
    <div id="report-content" style="display: none;">
      <header class="report-header" id="report-header">
        <div class="report-header-content">
          <div class="report-date" id="report-date"></div>
          <div class="report-store" id="report-store"></div>
        </div>
      </header>
      
      <div class="items-list-bar">
        <div class="items-list">
          <span class="items-list-label">実施清掃項目</span>
          <div class="items-list-items" id="cleaning-items"></div>
        </div>
      </div>
      
      <div class="report-main" id="report-main">
        <!-- 清掃項目が動的に追加される -->
      </div>
      
      <!-- 満足度アンケートフォーム -->
      <div id="satisfaction-wrap" class="satisfaction-form">
        <div class="form-question">今回の作業の満足度はいかがでしたか？</div>
        <div class="rating-stars">
          <span class="rating-label">良い</span>
          <div class="stars" aria-label="5段階評価" role="radiogroup">
            <span class="star" data-value="1" role="radio" aria-label="1" aria-checked="false" tabindex="0">☆</span>
            <span class="star" data-value="2" role="radio" aria-label="2" aria-checked="false" tabindex="0">☆</span>
            <span class="star" data-value="3" role="radio" aria-label="3" aria-checked="false" tabindex="0">☆</span>
            <span class="star" data-value="4" role="radio" aria-label="4" aria-checked="false" tabindex="0">☆</span>
            <span class="star" data-value="5" role="radio" aria-label="5" aria-checked="false" tabindex="0">☆</span>
          </div>
          <span class="rating-label">悪い</span>
        </div>
        <div class="comment-section">
          <label for="storeComment" class="comment-label">店舗担当者コメント</label>
          <textarea id="storeComment" class="comment-textarea" placeholder="コメントを入力してください"></textarea>
        </div>
        <div class="submit-button-wrapper">
          <button id="satisfaction-submit" type="button" class="submit-button">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
            コメントを送る
          </button>
        </div>
      </div>
      <div id="satisfaction-thanks" class="satisfaction-thanks">コメントをお寄せいただきありがとうございました。</div>
    </div>
    <div id="error-message" class="error-message" style="display: none;"></div>
  </div>

  <style>
    body { background: #f4f7f6; }
    .report-container { 
      max-width: 900px; 
      margin: 20px auto; 
      background: #fff; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      box-shadow: 0 4px 12px rgba(0,0,0,.05); 
      overflow: hidden; 
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    .error-message {
      padding: 24px;
      background: #fee2e2;
      color: #991b1b;
      text-align: center;
      border-radius: 8px;
      margin: 20px;
    }
    .report-header { 
      background: var(--primary); 
      color: #fff; 
      padding: 16px 24px; 
    }
    .report-header-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .report-date {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .report-store {
      font-size: 1rem;
      opacity: 0.9;
    }
    .items-list-bar { 
      background: #f9f9f9; 
      padding: 12px 24px; 
      border-bottom: 1px solid #eee; 
      display: flex; 
      align-items: center; 
      flex-wrap: wrap; 
      gap: 15px; 
    }
    .items-list {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .items-list-label { 
      font-weight: 600; 
      color: #555; 
      font-size: .9rem; 
    }
    .items-list-items {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .items-list-item { 
      font-size: .9rem; 
      color: #333; 
      padding: 6px 12px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
    }
    .cleaning-section { 
      padding: 24px; 
      border-bottom: 1px solid #eee; 
    }
    .cleaning-section:last-child { 
      border-bottom: none; 
    }
    .item-header { 
      display: flex; 
      align-items: center; 
      flex-wrap: wrap; 
      gap: 15px; 
      margin-bottom: 20px; 
    }
    .item-title { 
      font-size: 1.6rem; 
      font-weight: 600; 
      color: #222; 
      margin: 0; 
    }
    .item-details { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      padding-top: 5px; 
    }
    .detail-tag { 
      background: #f0f4f8; 
      color: #555; 
      padding: 6px 12px; 
      border-radius: 20px; 
      font-size: .85rem; 
    }
    .subsection { 
      margin-top: 20px; 
    }
    .subsection-title { 
      font-size: 1.1rem; 
      font-weight: 600; 
      color: #333; 
      border-bottom: 2px solid #333; 
      padding-bottom: 5px; 
      margin-top: 25px; 
      margin-bottom: 15px; 
    }
    .subsection p { 
      margin: 0 0 15px 0; 
      color: #555; 
      white-space: pre-wrap;
    }
    .image-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 20px;
    }
    .image-category {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .image-category-title {
      font-size: 1rem;
      font-weight: 600;
      color: #444;
      margin: 0;
    }
    .image-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .image-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #ccc;
      background: #fafafa;
    }
    .image-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .satisfaction-form { 
      padding: 24px; 
      border-top: 1px solid #eee; 
    }
    .form-question { 
      font-weight: 700; 
      color: #333; 
      margin: 6px 0 12px; 
      text-align: center; 
    }
    .rating-stars { 
      display: flex; 
      align-items: center; 
      margin-bottom: 30px; 
      gap: 15px; 
      flex-wrap: wrap; 
      justify-content: center; 
    }
    .rating-label { 
      font-size: .95rem; 
      color: #555; 
      flex-shrink: 0; 
    }
    .stars { 
      display: flex; 
      gap: 5px; 
      justify-content: flex-start; 
    }
    .star { 
      font-size: 1.8rem; 
      color: #ccc; 
      cursor: pointer; 
      line-height: 1; 
      user-select: none; 
    }
    .star.filled { 
      color: var(--primary); 
    }
    .comment-section { 
      max-width: 720px; 
      margin: 0 auto; 
    }
    .comment-label { 
      display: block; 
      font-weight: 600; 
      margin: 0 0 6px; 
      color: #555; 
    }
    .comment-textarea { 
      width: 100%; 
      min-height: 96px; 
      border: 1px solid #e5e7eb; 
      border-radius: 8px; 
      padding: 10px 12px; 
      font: inherit; 
    }
    .submit-button-wrapper { 
      text-align: center; 
      margin-top: 16px; 
    }
    .submit-button { 
      display: inline-flex; 
      align-items: center; 
      gap: 8px; 
      height: 40px; 
      padding: 0 16px; 
      border-radius: 999px; 
      border: 1px solid transparent; 
      background: var(--primary); 
      color: #fff; 
      box-shadow: 0 1px 2px rgba(0,0,0,.06); 
      cursor: pointer;
    }
    .submit-button:hover { 
      background: var(--primary-600); 
    }
    .submit-button svg { 
      width: 18px; 
      height: 18px; 
      fill: currentColor; 
    }
    .satisfaction-thanks { 
      display: none; 
      text-align: center; 
      padding: 48px 24px; 
      font-weight: 700; 
      color: #1f2937; 
    }
    @media (max-width: 768px) {
      .report-container { 
        margin: 0; 
        border-radius: 0; 
        border-left: none; 
        border-right: none; 
      }
      .items-list-bar { 
        flex-direction: column; 
        align-items: flex-start; 
        padding: 15px; 
      }
      .cleaning-section { 
        padding: 20px 15px; 
      }
      .item-header { 
        flex-direction: column; 
        align-items: flex-start; 
        gap: 10px; 
      }
      .item-title { 
        font-size: 1.4rem; 
      }
      .image-grid {
        grid-template-columns: 1fr;
      }
      .image-list {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>

  <script>
    // APIエンドポイント
    const API_BASE_URL = 'https://2z0ui5xfxb.execute-api.ap-northeast-1.amazonaws.com/prod';
    
    // Firebase認証からIDトークンを取得
    async function getFirebaseIdToken() {
      // TODO: Firebase認証からIDトークンを取得
      // 現状はモック
      return 'mock-token';
    }

    // URLからレポートIDを取得
    function getReportIdFromUrl() {
      const path = window.location.pathname;
      const match = path.match(/\/reports\/([^\/]+)\.html/);
      return match ? match[1] : null;
    }

    // 日付フォーマット
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // レポート詳細を取得
    async function loadReportDetail() {
      const loadingEl = document.getElementById('loading');
      const contentEl = document.getElementById('report-content');
      const errorEl = document.getElementById('error-message');
      
      const reportId = getReportIdFromUrl();
      if (!reportId) {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = 'レポートIDが取得できませんでした';
        return;
      }
      
      try {
        loadingEl.style.display = 'block';
        contentEl.style.display = 'none';
        errorEl.style.display = 'none';
        
        const idToken = await getFirebaseIdToken();
        const response = await fetch(`${API_BASE_URL}/staff/reports/${reportId}`, {
          headers: {
            'Authorization': `Bearer ${idToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        if (!response.ok) {
          if (response.status === 404) {
            throw new Error('レポートが見つかりませんでした');
          }
          throw new Error('レポートの取得に失敗しました');
        }
        
        const report = await response.json();
        
        // レポート情報を表示
        renderReport(report);
        
        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';
      } catch (error) {
        console.error('Error loading report:', error);
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
        errorEl.textContent = `エラー: ${error.message}`;
      }
    }

    // レポートを表示
    function renderReport(report) {
      // ヘッダー
      const dateStr = formatDate(report.cleaning_date);
      const timeStr = report.cleaning_start_time && report.cleaning_end_time 
        ? `${report.cleaning_start_time} - ${report.cleaning_end_time}`
        : '';
      document.getElementById('report-date').textContent = `清掃日時: ${dateStr} ${timeStr}`;
      document.getElementById('report-store').textContent = report.store_name || '店舗名不明';
      
      // 清掃項目リスト
      const cleaningItemsEl = document.getElementById('cleaning-items');
      const items = report.work_items || [];
      const itemNames = items.map(item => item.item_name || item.item_id).filter(Boolean);
      cleaningItemsEl.innerHTML = itemNames.map(name => 
        `<span class="items-list-item">${name}</span>`
      ).join('');
      
      // 清掃項目の詳細
      const reportMainEl = document.getElementById('report-main');
      reportMainEl.innerHTML = items.map(item => {
        const details = item.details || {};
        const tags = [];
        if (details.type) tags.push(details.type);
        if (details.count) tags.push(`${details.count}個`);
        const tagsHtml = tags.map(tag => `<span class="detail-tag">${tag}</span>`).join('');
        
        // 写真の表示
        const beforePhotos = item.photos?.before || [];
        const afterPhotos = item.photos?.after || [];
        
        const beforePhotosHtml = beforePhotos.length > 0
          ? `<div class="image-list">
               ${beforePhotos.map(url => `
                 <div class="image-item">
                   <img src="${url}" alt="作業前" loading="lazy" />
                 </div>
               `).join('')}
             </div>`
          : '<p style="color: #999; font-style: italic;">写真なし</p>';
        
        const afterPhotosHtml = afterPhotos.length > 0
          ? `<div class="image-list">
               ${afterPhotos.map(url => `
                 <div class="image-item">
                   <img src="${url}" alt="作業後" loading="lazy" />
                 </div>
               `).join('')}
             </div>`
          : '<p style="color: #999; font-style: italic;">写真なし</p>';
        
        return `
          <section class="cleaning-section">
            <div class="item-header">
              <h3 class="item-title">${item.item_name || item.item_id}</h3>
              <div class="item-details">${tagsHtml}</div>
            </div>
            ${item.work_content ? `
              <div class="subsection">
                <h4 class="subsection-title">作業内容</h4>
                <p>${item.work_content}</p>
              </div>
            ` : ''}
            <div class="image-grid">
              <div class="image-category">
                <h4 class="image-category-title">作業前</h4>
                ${beforePhotosHtml}
              </div>
              <div class="image-category">
                <h4 class="image-category-title">作業後</h4>
                ${afterPhotosHtml}
              </div>
            </div>
            ${item.work_memo ? `
              <div class="subsection">
                <h4 class="subsection-title">作業メモ</h4>
                <p>${item.work_memo}</p>
              </div>
            ` : ''}
          </section>
        `;
      }).join('');
    }

    // 満足度評価の処理
    document.addEventListener('DOMContentLoaded', function() {
      loadReportDetail();
      
      // 満足度評価の星
      const wrap = document.getElementById('satisfaction-wrap');
      const thanks = document.getElementById('satisfaction-thanks');
      if (wrap) {
        const stars = Array.from(wrap.querySelectorAll('.star'));
        let rating = 0;
        function render() {
          stars.forEach((s, i) => {
            const filled = (i + 1) <= rating;
            s.classList.toggle('filled', filled);
            s.setAttribute('aria-checked', String(filled && (i + 1) === rating));
          });
        }
        stars.forEach((s) => {
          s.addEventListener('click', () => { rating = Number(s.dataset.value || '0'); render(); });
          s.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); rating = Number(s.dataset.value || '0'); render(); }
            if (e.key === 'ArrowRight') { e.preventDefault(); rating = Math.min(5, rating + 1) || 1; render(); }
            if (e.key === 'ArrowLeft') { e.preventDefault(); rating = Math.max(1, rating - 1) || 1; render(); }
          });
        });
        const btn = document.getElementById('satisfaction-submit');
        if (btn) btn.addEventListener('click', () => {
          wrap.style.display = 'none';
          if (thanks) thanks.style.display = 'block';
          // TODO: 満足度評価をAPIに送信
        });
      }
    });
  </script>
</main>

    </main>
    <footer class="site-footer">
  <div class="container text-center muted small" style="padding: 16px 0;">
    <p>&copy; 2025 ミセサポ</p>
  </div>
</footer>


    <!-- フィードバックボタン（清掃員関連ページでは非表示） -->
    <div data-hide-for-staff>
    <!-- フィードバックボタン（ドラッグ可能） -->
<div id="feedback-button" class="feedback-button" draggable="true">
  <i class="fas fa-arrow-down"></i>
</div>

<!-- フィードバックフォーム（ドラッグ可能・独立） -->
<div id="feedback-form" class="feedback-form" style="display: none;" draggable="true">
  <div class="feedback-form-header">
    <span class="feedback-form-title">フィードバック</span>
    <button class="feedback-form-close" id="feedback-close-btn">
      <i class="fas fa-times"></i>
    </button>
  </div>
  <div class="feedback-form-body">
    <textarea 
      id="feedback-text" 
      class="feedback-text-input" 
      placeholder="修正箇所やコメントを入力してください..."
      rows="4"
    ></textarea>
    <div class="feedback-form-actions">
      <button class="feedback-screenshot-btn" id="feedback-screenshot-btn">
        <i class="fas fa-camera"></i>
        スクリーンショット
      </button>
      <button class="feedback-send-btn" id="feedback-send-btn" disabled>
        <i class="fas fa-paper-plane"></i>
        送信
      </button>
    </div>
    <div id="feedback-screenshot-preview" class="feedback-screenshot-preview" style="display: none;">
      <img id="feedback-screenshot-img" alt="スクリーンショット" />
      <button class="feedback-screenshot-remove" id="feedback-screenshot-remove">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
</div>

<style>
  .feedback-button {
    position: fixed;
    top: 100px;
    right: 20px;
    width: 50px;
    height: 50px;
    background: #dc2626;
    color: #ffffff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: move;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    transition: all 0.2s;
    user-select: none;
  }

  .feedback-button:hover {
    background: #b91c1c;
    transform: scale(1.1);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
  }

  .feedback-button:active {
    transform: scale(0.95);
  }

  .feedback-button i {
    font-size: 24px;
  }

  .feedback-button.dragging {
    opacity: 0.7;
    cursor: grabbing;
  }

  .feedback-form {
    position: fixed;
    top: 160px;
    right: 20px;
    width: 350px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    z-index: 10001;
    overflow: hidden;
    cursor: move;
  }

  .feedback-form.dragging {
    opacity: 0.8;
    cursor: grabbing;
  }

  .feedback-form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: #dc2626;
    color: #ffffff;
    cursor: move;
    user-select: none;
  }

  .feedback-form-title {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .feedback-form-close {
    background: none;
    border: none;
    color: #ffffff;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    transition: background 0.2s;
  }

  .feedback-form-close:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .feedback-form-body {
    padding: 16px;
  }

  .feedback-text-input {
    width: 100%;
    min-height: 100px;
    padding: 12px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.875rem;
    font-family: inherit;
    resize: vertical;
    box-sizing: border-box;
  }

  .feedback-text-input:focus {
    outline: none;
    border-color: #dc2626;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
  }

  .feedback-form-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
  }

  .feedback-screenshot-btn,
  .feedback-send-btn {
    flex: 1;
    padding: 10px 16px;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
  }

  .feedback-screenshot-btn {
    background: #f3f4f6;
    color: #374151;
  }

  .feedback-screenshot-btn:hover {
    background: #e5e7eb;
  }

  .feedback-send-btn {
    background: #dc2626;
    color: #ffffff;
  }

  .feedback-send-btn:hover:not(:disabled) {
    background: #b91c1c;
  }

  .feedback-send-btn:disabled {
    background: #d1d5db;
    color: #9ca3af;
    cursor: not-allowed;
  }

  .feedback-screenshot-preview {
    margin-top: 12px;
    position: relative;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    overflow: hidden;
  }

  .feedback-screenshot-preview img {
    width: 100%;
    height: auto;
    display: block;
  }

  .feedback-screenshot-remove {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 32px;
    height: 32px;
    background: rgba(0, 0, 0, 0.7);
    color: #ffffff;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
  }

  .feedback-screenshot-remove:hover {
    background: rgba(0, 0, 0, 0.9);
  }

  @media (max-width: 768px) {
    .feedback-form {
      width: calc(100vw - 40px);
      max-width: 350px;
    }
  }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  (function() {
    let screenshotData = null;
    let isDraggingButton = false;
    let isDraggingForm = false;
    let buttonDragOffset = { x: 0, y: 0 };
    let formDragOffset = { x: 0, y: 0 };

    function init() {
      const feedbackButton = document.getElementById('feedback-button');
      const feedbackForm = document.getElementById('feedback-form');
      const feedbackFormHeader = feedbackForm ? feedbackForm.querySelector('.feedback-form-header') : null;
      const feedbackText = document.getElementById('feedback-text');
      const feedbackCloseBtn = document.getElementById('feedback-close-btn');
      const feedbackScreenshotBtn = document.getElementById('feedback-screenshot-btn');
      const feedbackSendBtn = document.getElementById('feedback-send-btn');
      const feedbackScreenshotPreview = document.getElementById('feedback-screenshot-preview');
      const feedbackScreenshotImg = document.getElementById('feedback-screenshot-img');
      const feedbackScreenshotRemove = document.getElementById('feedback-screenshot-remove');

      if (!feedbackButton || !feedbackForm) return;

      // 矢印ボタンのドラッグ機能
      feedbackButton.addEventListener('mousedown', function(e) {
        if (e.target === feedbackButton || e.target.closest('.feedback-button')) {
          isDraggingButton = true;
          feedbackButton.classList.add('dragging');
          const rect = feedbackButton.getBoundingClientRect();
          buttonDragOffset.x = e.clientX - rect.left;
          buttonDragOffset.y = e.clientY - rect.top;
          e.preventDefault();
        }
      });

      // フォームのドラッグ機能（ヘッダー部分をドラッグ）
      if (feedbackFormHeader) {
        feedbackFormHeader.addEventListener('mousedown', function(e) {
          if (e.target !== feedbackCloseBtn && !e.target.closest('.feedback-form-close')) {
            isDraggingForm = true;
            feedbackForm.classList.add('dragging');
            const rect = feedbackForm.getBoundingClientRect();
            formDragOffset.x = e.clientX - rect.left;
            formDragOffset.y = e.clientY - rect.top;
            e.preventDefault();
          }
        });
      }

      document.addEventListener('mousemove', function(e) {
        // 矢印ボタンのドラッグ
        if (isDraggingButton && feedbackButton) {
          const x = e.clientX - buttonDragOffset.x;
          const y = e.clientY - buttonDragOffset.y;
          feedbackButton.style.left = x + 'px';
          feedbackButton.style.top = y + 'px';
          feedbackButton.style.right = 'auto';
          feedbackButton.style.bottom = 'auto';
        }
        
        // フォームのドラッグ
        if (isDraggingForm && feedbackForm) {
          const x = e.clientX - formDragOffset.x;
          const y = e.clientY - formDragOffset.y;
          feedbackForm.style.left = x + 'px';
          feedbackForm.style.top = y + 'px';
          feedbackForm.style.right = 'auto';
        }
      });

      document.addEventListener('mouseup', function() {
        if (isDraggingButton) {
          isDraggingButton = false;
          if (feedbackButton) {
            feedbackButton.classList.remove('dragging');
          }
        }
        if (isDraggingForm) {
          isDraggingForm = false;
          if (feedbackForm) {
            feedbackForm.classList.remove('dragging');
          }
        }
      });

      // タッチデバイス対応 - 矢印ボタン
      feedbackButton.addEventListener('touchstart', function(e) {
        if (e.target === feedbackButton || e.target.closest('.feedback-button')) {
          isDraggingButton = true;
          feedbackButton.classList.add('dragging');
          const touch = e.touches[0];
          const rect = feedbackButton.getBoundingClientRect();
          buttonDragOffset.x = touch.clientX - rect.left;
          buttonDragOffset.y = touch.clientY - rect.top;
          e.preventDefault();
        }
      });

      // タッチデバイス対応 - フォーム
      if (feedbackFormHeader) {
        feedbackFormHeader.addEventListener('touchstart', function(e) {
          if (e.target !== feedbackCloseBtn && !e.target.closest('.feedback-form-close')) {
            isDraggingForm = true;
            feedbackForm.classList.add('dragging');
            const touch = e.touches[0];
            const rect = feedbackForm.getBoundingClientRect();
            formDragOffset.x = touch.clientX - rect.left;
            formDragOffset.y = touch.clientY - rect.top;
            e.preventDefault();
          }
        });
      }

      document.addEventListener('touchmove', function(e) {
        const touch = e.touches[0];
        
        // 矢印ボタンのドラッグ
        if (isDraggingButton && feedbackButton) {
          const x = touch.clientX - buttonDragOffset.x;
          const y = touch.clientY - buttonDragOffset.y;
          feedbackButton.style.left = x + 'px';
          feedbackButton.style.top = y + 'px';
          feedbackButton.style.right = 'auto';
          feedbackButton.style.bottom = 'auto';
          e.preventDefault();
        }
        
        // フォームのドラッグ
        if (isDraggingForm && feedbackForm) {
          const x = touch.clientX - formDragOffset.x;
          const y = touch.clientY - formDragOffset.y;
          feedbackForm.style.left = x + 'px';
          feedbackForm.style.top = y + 'px';
          feedbackForm.style.right = 'auto';
          e.preventDefault();
        }
      });

      document.addEventListener('touchend', function() {
        if (isDraggingButton) {
          isDraggingButton = false;
          if (feedbackButton) {
            feedbackButton.classList.remove('dragging');
          }
        }
        if (isDraggingForm) {
          isDraggingForm = false;
          if (feedbackForm) {
            feedbackForm.classList.remove('dragging');
          }
        }
      });

      // ボタンクリックでフォーム表示
      feedbackButton.addEventListener('click', function(e) {
        if (!isDraggingButton && !isDraggingForm) {
          e.stopPropagation();
          // フォームが非表示の場合は表示、既に表示されている場合は非表示
          if (feedbackForm.style.display === 'none') {
            const buttonRect = feedbackButton.getBoundingClientRect();
            feedbackForm.style.display = 'block';
            feedbackForm.style.top = (buttonRect.bottom + 10) + 'px';
            feedbackForm.style.left = (buttonRect.left - 330) + 'px';
            feedbackForm.style.right = 'auto';
            if (feedbackText) feedbackText.focus();
          } else {
            feedbackForm.style.display = 'none';
          }
        }
      });

      // フォームを閉じる
      if (feedbackCloseBtn) {
        feedbackCloseBtn.addEventListener('click', function() {
          feedbackForm.style.display = 'none';
          screenshotData = null;
          if (feedbackScreenshotPreview) feedbackScreenshotPreview.style.display = 'none';
          if (feedbackText) feedbackText.value = '';
          if (feedbackSendBtn) feedbackSendBtn.disabled = true;
        });
      }

      // テキスト入力で送信ボタンを有効化
      if (feedbackText && feedbackSendBtn) {
        feedbackText.addEventListener('input', function() {
          feedbackSendBtn.disabled = !feedbackText.value.trim() && !screenshotData;
        });
      }

      // スクリーンショット機能
      if (feedbackScreenshotBtn) {
        feedbackScreenshotBtn.addEventListener('click', function() {
          if (typeof html2canvas === 'undefined') {
            alert('スクリーンショット機能が利用できません。');
            return;
          }

          feedbackScreenshotBtn.disabled = true;
          feedbackScreenshotBtn.innerHTML = '<i class="fas fa-camera"></i> 撮影中...';

          html2canvas(document.body, {
            useCORS: true,
            logging: false,
            scale: 1
          }).then(function(canvas) {
            screenshotData = canvas.toDataURL('image/png');
            if (feedbackScreenshotImg) feedbackScreenshotImg.src = screenshotData;
            if (feedbackScreenshotPreview) feedbackScreenshotPreview.style.display = 'block';
            feedbackScreenshotBtn.disabled = false;
            feedbackScreenshotBtn.innerHTML = '<i class="fas fa-camera"></i> スクリーンショット';
            if (feedbackSendBtn) {
              feedbackSendBtn.disabled = !feedbackText.value.trim() && !screenshotData;
            }
          }).catch(function(error) {
            console.error('スクリーンショットエラー:', error);
            alert('スクリーンショットの取得に失敗しました。');
            feedbackScreenshotBtn.disabled = false;
            feedbackScreenshotBtn.innerHTML = '<i class="fas fa-camera"></i> スクリーンショット';
          });
        });
      }

      // スクリーンショット削除
      if (feedbackScreenshotRemove && feedbackSendBtn && feedbackText) {
        feedbackScreenshotRemove.addEventListener('click', function() {
          screenshotData = null;
          if (feedbackScreenshotPreview) feedbackScreenshotPreview.style.display = 'none';
          feedbackSendBtn.disabled = !feedbackText.value.trim();
        });
      }

      // メール送信機能（EmailJS使用）
      if (feedbackSendBtn) {
        feedbackSendBtn.addEventListener('click', function() {
          const text = feedbackText ? feedbackText.value.trim() : '';
          if (!text && !screenshotData) {
            alert('テキストまたはスクリーンショットを入力してください。');
            return;
          }

          const pageUrl = window.location.href;
          const pageTitle = document.title;
          const timestamp = new Date().toLocaleString('ja-JP');

          // EmailJSの設定
          const EMAILJS_SERVICE_ID = 'service_hx88k5s';
          const EMAILJS_TEMPLATE_ID = 'template_alkj896';
          const EMAILJS_PUBLIC_KEY = 'pLD_aLYcX2lhiCSRl';

          // EmailJSが利用可能かチェック
          if (typeof emailjs === 'undefined') {
            // EmailJSが利用できない場合は、従来のmailto方式にフォールバック
            const emailTo = 'misesapofeedback@gmail.com';
            const emailSubject = encodeURIComponent(`フィードバック: ${pageTitle}`);
            let emailBody = `フィードバック\n\n`;
            emailBody += `ページ: ${pageTitle}\n`;
            emailBody += `URL: ${pageUrl}\n`;
            emailBody += `日時: ${timestamp}\n\n`;
            emailBody += `コメント:\n${text}\n`;
            const emailBodyEncoded = encodeURIComponent(emailBody);

            if (screenshotData) {
              const link = document.createElement('a');
              link.download = `screenshot-${Date.now()}.png`;
              link.href = screenshotData;
              link.click();
              alert('スクリーンショットをダウンロードしました。\nメール作成画面で手動で添付してください。');
            }
            window.location.href = `mailto:${emailTo}?subject=${emailSubject}&body=${emailBodyEncoded}`;
            return;
          }

          // EmailJSでメール送信
          feedbackSendBtn.disabled = true;
          feedbackSendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 送信中...';

          // テンプレートパラメータを準備
          const templateParams = {
            to_email: 'misesapofeedback@gmail.com',
            page_title: pageTitle,
            page_url: pageUrl,
            timestamp: timestamp,
            comment: text,
            has_screenshot: screenshotData ? 'あり' : 'なし'
          };

          // スクリーンショットがある場合は、HTML画像として埋め込む
          if (screenshotData) {
            // base64画像をHTMLのimgタグとして埋め込む
            // EmailJSのテンプレートでHTMLメールとして表示される
            templateParams.screenshot_image = `<img src="${screenshotData}" alt="スクリーンショット" style="max-width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; margin: 10px 0;" />`;
            templateParams.screenshot_base64 = screenshotData; // テンプレートで直接使用する場合
          }

          // EmailJSで送信
          emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams)
            .then(function(response) {
              console.log('送信成功:', response.status, response.text);

              alert('フィードバックを送信しました！');
              
              // フォームをリセット
              feedbackForm.style.display = 'none';
              screenshotData = null;
              if (feedbackScreenshotPreview) feedbackScreenshotPreview.style.display = 'none';
              if (feedbackText) feedbackText.value = '';
              feedbackSendBtn.disabled = true;
              feedbackSendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 送信';
            }, function(error) {
              console.error('送信エラー:', error);
              alert('送信に失敗しました。\nエラー: ' + (error.text || error.message || '不明なエラー'));
              feedbackSendBtn.disabled = false;
              feedbackSendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 送信';
            });
        });
      }
    }

    // EmailJSの初期化（公開キーを設定）
    const EMAILJS_PUBLIC_KEY = 'pLD_aLYcX2lhiCSRl';
    if (typeof emailjs !== 'undefined') {
      emailjs.init(EMAILJS_PUBLIC_KEY);
    }

    // 初期化
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  })();
</script>


    </div>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="/js/firebase-config.js"></script>
    <script src="/js/role_config.js"></script>
    <script src="/js/users.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/navigation.js"></script>
    <script src="/modal_manager.js"></script>
    <script src="/app.js"></script>
    <script>
      // 清掃員関連ページとログイン画面ではリリース前チェックとフィードバックボタンを非表示
      // ログイン画面では通常ヘッダーを表示
      (function() {
        const bodyClass = document.body.className || '';
        const path = window.location.pathname || '';
        const isStaffPage = bodyClass.includes('staff') || path.includes('/staff/');
        const isSigninPage = path.includes('/signin.html') || path.includes('/signin');
        
        // ログイン画面では通常ヘッダーを表示、デフォルトヘッダーを非表示
        if (isSigninPage) {
          const defaultHeaderWrapper = document.getElementById('default-header-wrapper');
          const normalHeaderWrapper = document.getElementById('normal-header-wrapper');
          if (defaultHeaderWrapper) {
            defaultHeaderWrapper.style.display = 'none';
          }
          if (normalHeaderWrapper) {
            normalHeaderWrapper.style.display = 'block';
            // ログイン画面では通常ヘッダーを常に表示
            const normalHeader = normalHeaderWrapper.querySelector('.normal-header');
            if (normalHeader) {
              normalHeader.classList.add('visible');
            }
          }
        }
        
        if (isStaffPage || isSigninPage) {
          // リリース前チェックセクションを非表示
          const releaseCheckSection = document.getElementById('release-check-section');
          if (releaseCheckSection) {
            releaseCheckSection.style.display = 'none';
          }
          
          // フィードバックボタンを非表示
          const feedbackButton = document.getElementById('feedback-button');
          if (feedbackButton) {
            feedbackButton.style.display = 'none';
          }
          
          // data-hide-for-staff属性を持つ要素を非表示
          document.querySelectorAll('[data-hide-for-staff]').forEach(el => {
            el.style.display = 'none';
          });
        }
      })();
    </script>
  </body>
  </html>


